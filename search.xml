<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>M1 安装 Homebrew 和 php 开发环境</title>
      <link href="posts/b12a8007.html"/>
      <url>posts/b12a8007.html</url>
      
        <content type="html"><![CDATA[<p>先安装 homebrew 方便下载软件。</p><blockquote><p>如果使用官网推荐的方式下载时提示以下错误信息时，则表示网络超时，建议直接使用源码包的形式安装</p></blockquote><p>错误信息如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">curl: <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> Failed to connect to raw.githubusercontent.com port <span class="token number">443</span>: Connection refused<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="直接使用包安装"><a href="#直接使用包安装" class="headerlink" title="直接使用包安装"></a>直接使用包安装</h2><ol><li>进入 <a href="https://github.com/Homebrew/brew/tags">Homebrew 的 GitHub 仓库 tag 地址</a> 下载最新的 tag</li><li>根据系统选择下载：mac、windows 可以下载 zip 文件， linux 可以下载 tar.gz 的文件。</li><li>下载后解压。</li><li>在 <code>/usr/local</code> 文件夹下创建 <code>Homebrew</code> 文件夹，然后将解压后的内容全部复制到 <code>Homebrew</code> 文件夹下</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 我这里下载的是 brew-3.3.3 版本</span><span class="token comment"># 下载地址为：https://github.com/Homebrew/brew/archive/refs/tags/3.3.3.zip</span><span class="token function">wget</span> <span class="token builtin class-name">cd</span> /usr/local <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> Homebrew<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>建立软连接</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/Homebrew/bin/brew /usr/local/bin/brew<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="4"><li>进入本地 <code>Homebrew</code> 的存放路径，如果找不到的话，可以直接在 <code>terminal</code> 下输入以下命令</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进入  usr/local 目录</span><span class="token builtin class-name">cd</span> /usr/local<span class="token comment"># 使用访达(finder) 打开当前目录</span><span class="token function">open</span> <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>查看 <code>/usr/local</code> 目录下是否有 <code>Homebrew</code> 文件夹（注意大小写），如果你发现没有 <code>Homebrew</code> 文件夹，则执行以下命令创建 <code>Homebrew</code> 文件夹</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/Homebrew<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="6"><li><p>将第三步中解压后的内容全部复制到 <code>/usr/local/Homebrew</code> 目录</p></li><li><p>重启命令行窗口，输入 <code>brew</code> 命令，出现 brew 相关的 help 页面，即表示已经安装成功</p></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># /usr/local/bin/brew -&gt; /usr/local/Homebrew/bin/brew</span><span class="token builtin class-name">cd</span> /usr/local/Homebrew <span class="token operator">&amp;&amp;</span> brew<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>敲击 <code>brew</code> 命令时，出现以下内容时，表示已经安装 Homebrew 成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Example usage:  brew search <span class="token punctuation">[</span>TEXT<span class="token operator">|</span>/REGEX/<span class="token punctuation">]</span>  brew info <span class="token punctuation">[</span>FORMULA<span class="token punctuation">..</span>.<span class="token punctuation">]</span>  brew <span class="token function">install</span> FORMULA<span class="token punctuation">..</span>.  brew update  brew upgrade <span class="token punctuation">[</span>FORMULA<span class="token punctuation">..</span>.<span class="token punctuation">]</span>  brew uninstall FORMULA<span class="token punctuation">..</span>.  brew list <span class="token punctuation">[</span>FORMULA<span class="token punctuation">..</span>.<span class="token punctuation">]</span>Troubleshooting:  brew config  brew doctor  brew <span class="token function">install</span> <span class="token parameter variable">--verbose</span> <span class="token parameter variable">--debug</span> FORMULAContributing:  brew create <span class="token punctuation">[</span>URL <span class="token punctuation">[</span>--no-fetch<span class="token punctuation">]</span><span class="token punctuation">]</span>  brew edit <span class="token punctuation">[</span>FORMULA<span class="token punctuation">..</span>.<span class="token punctuation">]</span>Further help:  brew commands  brew <span class="token builtin class-name">help</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span>  <span class="token function">man</span> brew  https://docs.brew.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="8"><li>安装完成后，一定要下载一个软件测试下，比如下载 <code>wget</code></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> <span class="token function">wget</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="9"><li>更换 brew 的下载源</li></ol><ul><li><p><a href="http://mirrors.ustc.edu.cn/help/brew.git.html">Homebrew 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 替换 USTC 镜像</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span><span class="token function">git</span> remote set-url origin https://mirrors.ustc.edu.cn/brew.git<span class="token comment"># 重置为官方地址</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span><span class="token function">git</span> remote set-url origin https://github.com/Homebrew/brew.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="http://mirrors.ustc.edu.cn/help/homebrew-bottles.html">Homebrew Bottles 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 请在运行 brew 前设置环境变量 HOMEBREW_BOTTLE_DOMAIN ，值为 https://mirrors.ustc.edu.cn/homebrew-bottles</span><span class="token comment"># 对于 bash 用户</span><span class="token builtin class-name">echo</span> <span class="token string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles'</span> <span class="token operator">&gt;&gt;</span> ~/.bash_profile<span class="token builtin class-name">source</span> ~/.bash_profile<span class="token comment"># 对于 zsh 用户</span><span class="token builtin class-name">echo</span> <span class="token string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles'</span> <span class="token operator">&gt;&gt;</span> ~/.zshrc<span class="token builtin class-name">source</span> ~/.zshrc<span class="token comment"># 如果想恢复成官方 Homebrew Bottles 源，则直接注释掉 HOMEBREW_BOTTLE_DOMAIN 变量即可</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="http://mirrors.ustc.edu.cn/help/homebrew-core.git.html">Homebrew Core 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 替换 USTC 镜像</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>/Library/Taps/homebrew/homebrew-core"</span><span class="token function">git</span> remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git<span class="token comment"># 重置为官方地址</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>/Library/Taps/homebrew/homebrew-core"</span><span class="token function">git</span> remote set-url origin https://github.com/Homebrew/homebrew-core<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="http://mirrors.ustc.edu.cn/help/homebrew-cask.git.html">Homebrew Cask 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 替换为 USTC 镜像</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span>/Library/Taps/homebrew/homebrew-cask<span class="token function">git</span> remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask.git<span class="token comment"># 重置为官方地址</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span>/Library/Taps/homebrew/homebrew-cask<span class="token function">git</span> remote set-url origin https://github.com/Homebrew/homebrew-cask<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="http://mirrors.ustc.edu.cn/help/homebrew-cask-versions.git.html">Homebrew Cask Versions 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 替换为 USTC 镜像</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span>/Library/Taps/homebrew/homebrew-cask-versions<span class="token function">git</span> remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask-versions.git<span class="token comment"># 重置为官方地址</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span>/Library/Taps/homebrew/homebrew-cask-versions<span class="token function">git</span> remote set-url origin https://github.com/Homebrew/homebrew-cask-versions.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="下载-php"><a href="#下载-php" class="headerlink" title="下载 php"></a>下载 php</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用 homebrew 搜索 php</span>brew search php<span class="token comment"># 使用 homebrew 安装 php7.4</span>brew <span class="token function">install</span> php@7.4<span class="token comment"># 安装之后的 php7.4 在 /opt/homebrew/etc/php/7.4/ 目录下</span><span class="token comment"># 因为 mac 下默认已经安装了 php7.3 ，如果你想首先使用 php7.4 版本时，需要执行</span><span class="token builtin class-name">echo</span> <span class="token string">'export PATH="/opt/homebrew/opt/php@7.4/bin:$PATH"'</span> <span class="token operator">&gt;&gt;</span> ~/.zshrc<span class="token builtin class-name">echo</span> <span class="token string">'export PATH="/opt/homebrew/opt/php@7.4/sbin:$PATH"'</span> <span class="token operator">&gt;&gt;</span> ~/.zshrc  <span class="token comment"># 如果想要让编译器找到 php7.4 那么还需要设置</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">LDFLAGS</span><span class="token operator">=</span><span class="token string">"-L/opt/homebrew/opt/php@7.4/lib"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CPPFLAGS</span><span class="token operator">=</span><span class="token string">"-I/opt/homebrew/opt/php@7.4/include"</span><span class="token comment"># 写入 .zshrc 文件之后，需要执行 source 命令，重新加载配置信息</span><span class="token builtin class-name">source</span> ~/.zshrc<span class="token comment"># 可以使用 homebrew 来管理 php7.4 的服务状态，比如重启</span>brew services restart php@7.4<span class="token comment"># 如果不需要守护进程运行 php7.4 时，可以执行</span>/opt/homebrew/opt/php@7.4/sbin/php-fpm <span class="token parameter variable">--nodaemonize</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="切换多个-php-版本"><a href="#切换多个-php-版本" class="headerlink" title="切换多个 php 版本"></a>切换多个 php 版本</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接切换到 php7.4</span>brew <span class="token function">link</span> <span class="token parameter variable">--overwrite</span> php@7.4<span class="token comment"># 或者先取消链接</span>brew unlink php<span class="token comment"># 然后再链接</span>brew <span class="token function">link</span> php@7.4 <span class="token parameter variable">--force</span>php <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装-composer"><a href="#安装-composer" class="headerlink" title="安装 composer"></a>安装 composer</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> <span class="token function">composer</span><span class="token comment"># 查看 composer 是否安装成功</span><span class="token function">composer</span> <span class="token parameter variable">-V</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>brew update</td><td>更新 Homebrew 自身</td></tr><tr><td>brew outdated</td><td>查看哪些安装包需要更新</td></tr><tr><td>brew upgrade</td><td>更新所有的包</td></tr><tr><td>brew upgrade $FORMULA</td><td>更新指定的包</td></tr><tr><td>brew cleanup</td><td>清理所有包的旧版本</td></tr><tr><td>brew cleanup $FORMULA</td><td>清理指定包的旧版本</td></tr><tr><td>brew cleanup -n</td><td>查看可清理的旧版本包，不执行实际操作</td></tr><tr><td>brew pin $FORMULA</td><td>锁定某个包</td></tr><tr><td>brew unpin $FORMULA</td><td>取消锁定</td></tr><tr><td>brew info $FORMULA</td><td>显示某个包的信息</td></tr><tr><td>brew info</td><td>显示安装了包数量，文件数量，和总占用空间</td></tr><tr><td>brew deps –installed –tree</td><td>查看已安装的包的依赖，树形显示</td></tr><tr><td>brew list</td><td>列出已安装的包</td></tr><tr><td>brew rm $FORMULA</td><td>删除某个包</td></tr><tr><td>brew install {package-name}</td><td>下载某个包</td></tr><tr><td>brew uninstall –force $FORMULA</td><td>删除所有版本</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Homebrew </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>不花一分钱也可以用上 JetBrains 正版全家桶</title>
      <link href="posts/b3af447c.html"/>
      <url>posts/b3af447c.html</url>
      
        <content type="html"><![CDATA[<p>昨天，发现正在使用的 idea 要到期了，于是自己得马上去续约，免得影响自己的工作。</p><p>其实，我体验过不少的编辑器，Notepad++、Sublime Text、Apache NetBeans、Vim、Neovim、再就是大名鼎鼎的 Visual Studio Code 和巨强大的 JetBrains IDE。最终体验下来，在工作中的主要编辑器还是使用了 IDE。除了确实比较占用内存以外，没有其他可挑剔的。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-dcae6b5c4b3eafc8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="价格不菲"></p><p><img src="/medias/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/db879ed091daa570863771c473f61c70.png"></p><p>但是，要是直接去购买正版授权的话，价格确实不便宜，光一个 IDE 每月也要 24.9 美元，折合人民币小两百来块了，更别说全家桶了，要 77.9 美元。对于个人用户而言，估计一般都会出门右转去某宝上花个 9.9 买账号了。用确实可以用，但是就是不太稳定。</p><p>那么，有没有办法既想使用正版授权，又不想掏钱呢？还真有，<strong>开源开发许可证——JetBrains 通过为核心项目贡献者免费提供一套一流的开发者工具来支持非商业开源项目。</strong></p><p>别看他写的条件那么多，其实总结下来也就几点：</p><ol><li>你得有一个开源项目，且近期三个月有一定的活跃度，也就是在近三个月有定期提交代码就行。</li><li>在你的项目根目录下得有一个开源许可证，  项目为公开代码。</li><li>并且此仓库还不能是博客和一些示例代码。（这一点好像是今年加上的吧，去年我续约的时候，貌似都还没有这一点）</li></ol><p>具体满足条件可通过访问 <a href="https://www.jetbrains.com/zh-cn/community/opensource/#support">https://www.jetbrains.com/zh-cn/community/opensource/#support</a> 地址进行查看。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-eff4930bcc518842.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="满足条件"></p><p>接下来讲如何申请这个免费的许可证。</p><h2 id="注册账号"><a href="#注册账号" class="headerlink" title="注册账号"></a>注册账号</h2><p>先访问 <a href="https://account.jetbrains.com/licenses">https://account.jetbrains.com/licenses</a> 地址，在 JetBrains 官网上注册一个账号。</p><h2 id="申请"><a href="#申请" class="headerlink" title="申请"></a>申请</h2><p>直接访问官方的申请地址 <a href="https://www.jetbrains.com/shop/eform/opensource">https://www.jetbrains.com/shop/eform/opensource</a></p><p>这个页面有三个模块，我们大致讲解一下。</p><ol><li>Do we know you?</li></ol><p><strong>No</strong>：之前从来没有申请过的，就选这个。<strong>Yes</strong>：之前弄过开源许可的，就直接选这个，然后填上自己的 License ID 即可。</p><ol start="2"><li>Tell us about your project</li></ol><p>这里就根据你项目的实际情况填写就行了，没有太多的滑头。</p><ol start="3"><li>Tell us about yourself</li></ol><ul><li>Email address: 比较重要的是这一项，这个邮箱要和你 GitHub 主页上的邮箱地址一致。</li><li>A link to your profile on GitHub,etc: 这个填你 GitHub 的主页地址即可。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ebea11272aecf962.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-fb0937c35ce4e7aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="22.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7330fa398a713aa3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="33.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-4bf839e7eda63932.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="44.png"></p><p>好了，填写完毕之后，直接提交就可以等着了。一般需要等两周左右，其实很快，基本上在一周内就会有邮件通知你具体的申请结果。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7b6bb5cd1b97bf7c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="55.png"></p><h2 id="通过申请后"><a href="#通过申请后" class="headerlink" title="通过申请后"></a>通过申请后</h2><p>申请之后，你要留心你的邮箱里面标题为 <strong>License Certificate for JetBrains</strong> 开头的邮件。然后你需要点击 <strong>Take me to my license(s)</strong> 这个许可证可以直接和你的 JetBrains 账号直接绑定，使用 IDE 的时候直接通过你的账号登录即可。你也可以直接下载离线激活码，通过激活码的形式去激活 IDE。这个就看自己的喜好了。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p><strong>在你的 GitHub 首页，需要把你的邮箱显示出来，</strong> 这里主要是为了方便审查人员判断这是否为你自己的账号。人家都免费给你使用了，肯定也是希望你不要太鬼呀。</p><p>另外这个许可证是可以反复申请的，每一次的有效期是一年。也就是说，第一次申请成功之后，如果第二年你的仓库还满足申请条件，那么你还可以继续申请。</p><p>感叹开源的伟大！感叹 JetBrains 的伟大！</p>]]></content>
      
      
      <categories>
          
          <category> 科普 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JetBrains </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何找到 Redis 的 Big key？</title>
      <link href="posts/fe9e07a8.html"/>
      <url>posts/fe9e07a8.html</url>
      
        <content type="html"><![CDATA[<h1 id="如何找到-Redis-的-Big-key？"><a href="#如何找到-Redis-的-Big-key？" class="headerlink" title="如何找到 Redis 的 Big key？"></a>如何找到 Redis 的 Big key？</h1><h2 id="1-什么是-Redis-的-Big-key？"><a href="#1-什么是-Redis-的-Big-key？" class="headerlink" title="1. 什么是 Redis 的 Big key？"></a>1. 什么是 Redis 的 Big key？</h2><p>Redis 的 Big key 是指占用内存较大的 key，通常是大 List、大 Set、大 Hash、大 String 等等。</p><p>比如说：</p><ul><li>字符串类型。如：超过 1 MB 的 key，就是一个 Big key。</li><li>非字符串类型。如：一个包含 100 万个元素的 List，占用内存 100 MB，那么这个 List 就是一个 Big key。</li></ul><p><strong>具体的规定根据每个公司的实际情况而定。</strong></p><h2 id="2-为什么要找到-Redis-的-Big-key？"><a href="#2-为什么要找到-Redis-的-Big-key？" class="headerlink" title="2. 为什么要找到 Redis 的 Big key？"></a>2. 为什么要找到 Redis 的 Big key？</h2><ul><li>内存空间不均匀：如果 Redis 的 Big key 占用了大量的内存，那么就会导致内存空间不均匀，从而导致 Redis 的内存不足。</li><li>查询时阻塞：因为 Redis 单线程特性，如果操作某个 Big key，耗时比较久，则后面的请求会被阻塞。</li><li>过期时阻塞：如果 Big key 设置了过期时间，当过期后，这个 key 会被删除，假如没有使用过期异步删除，就会存在阻塞 Redis 的可能性，并且慢查询中查不到（因为这个删除是内部循环事件）</li></ul><h2 id="3-如何找到-Redis-的-Big-key？"><a href="#3-如何找到-Redis-的-Big-key？" class="headerlink" title="3. 如何找到 Redis 的 Big key？"></a>3. 如何找到 Redis 的 Big key？</h2><h3 id="直接使用-redis-cli-命令，分析大致的情况"><a href="#直接使用-redis-cli-命令，分析大致的情况" class="headerlink" title="直接使用 redis-cli 命令，分析大致的情况"></a>直接使用 <code>redis-cli</code> 命令，分析大致的情况</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 我这里在第二个数据库上做的测试，因此需要指定数据库 `-n 2`</span>$ redis-cli <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-n</span> <span class="token number">2</span> <span class="token parameter variable">--bigkeys</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>大致的结果如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Scanning the entire keyspace to find biggest keys as well as</span><span class="token comment"># average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec</span><span class="token comment"># per 100 SCAN commands (not usually needed).</span><span class="token punctuation">[</span>00.00%<span class="token punctuation">]</span> Biggest <span class="token builtin class-name">set</span>    found so far <span class="token string">'"large_set_key"'</span> with <span class="token number">201</span> members<span class="token punctuation">[</span>00.00%<span class="token punctuation">]</span> Biggest list   found so far <span class="token string">'"large_list_key"'</span> with <span class="token number">201</span> items<span class="token punctuation">[</span>00.00%<span class="token punctuation">]</span> Biggest string found so far <span class="token string">'"large_string_key"'</span> with <span class="token number">5242880</span> bytes<span class="token punctuation">[</span>00.00%<span class="token punctuation">]</span> Biggest <span class="token builtin class-name">hash</span>   found so far <span class="token string">'"large_hash_key"'</span> with <span class="token number">201</span> fields<span class="token punctuation">[</span>00.00%<span class="token punctuation">]</span> Biggest zset   found so far <span class="token string">'"large_zset_key"'</span> with <span class="token number">201</span> members-------- summary -------<span class="token comment"># 一共扫描了 5 个 key</span>Sampled <span class="token number">5</span> keys <span class="token keyword">in</span> the keyspace<span class="token operator">!</span><span class="token comment"># 所有 key 的总长度是 71 字节，平均长度为 14.20 字节</span>Total key length <span class="token keyword">in</span> bytes is <span class="token number">71</span> <span class="token punctuation">(</span>avg len <span class="token number">14.20</span><span class="token punctuation">)</span>Biggest   list found <span class="token string">'"large_list_key"'</span> has <span class="token number">201</span> itemsBiggest   <span class="token builtin class-name">hash</span> found <span class="token string">'"large_hash_key"'</span> has <span class="token number">201</span> fieldsBiggest string found <span class="token string">'"large_string_key"'</span> has <span class="token number">5242880</span> bytesBiggest    <span class="token builtin class-name">set</span> found <span class="token string">'"large_set_key"'</span> has <span class="token number">201</span> membersBiggest   zset found <span class="token string">'"large_zset_key"'</span> has <span class="token number">201</span> members<span class="token comment"># 每一种 key 情况的总览，某种类型的 key 占用内存的百分比，平均大小</span><span class="token number">1</span> lists with <span class="token number">201</span> items <span class="token punctuation">(</span><span class="token number">20.00</span>% of keys, avg size <span class="token number">201.00</span><span class="token punctuation">)</span><span class="token number">1</span> hashs with <span class="token number">201</span> fields <span class="token punctuation">(</span><span class="token number">20.00</span>% of keys, avg size <span class="token number">201.00</span><span class="token punctuation">)</span><span class="token number">1</span> strings with <span class="token number">5242880</span> bytes <span class="token punctuation">(</span><span class="token number">20.00</span>% of keys, avg size <span class="token number">5242880.00</span><span class="token punctuation">)</span><span class="token number">0</span> streams with <span class="token number">0</span> entries <span class="token punctuation">(</span>00.00% of keys, avg size <span class="token number">0.00</span><span class="token punctuation">)</span><span class="token number">1</span> sets with <span class="token number">201</span> members <span class="token punctuation">(</span><span class="token number">20.00</span>% of keys, avg size <span class="token number">201.00</span><span class="token punctuation">)</span><span class="token number">1</span> zsets with <span class="token number">201</span> members <span class="token punctuation">(</span><span class="token number">20.00</span>% of keys, avg size <span class="token number">201.00</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a06d75c4c7c12cef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="redis-cli 扫描 big key"></p><p>然后可以使用 <code>memory usage</code> 命令查看具体的内存占用情况：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">localhost:<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>MEMORY USAGE large_string_key<span class="token string">"6291520"</span>localhost:<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>MEMORY USAGE large_list_key<span class="token string">"2240"</span>localhost:<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>MEMORY USAGE large_set_key<span class="token string">"11264"</span>localhost:<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>MEMORY USAGE large_hash_key<span class="token string">"4269"</span>localhost:<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>MEMORY USAGE large_zset_key<span class="token string">"18968"</span>localhost:<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-fd87710c7404b132.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><h3 id="通过代码脚本找到具体的-Big-key"><a href="#通过代码脚本找到具体的-Big-key" class="headerlink" title="通过代码脚本找到具体的 Big key"></a>通过代码脚本找到具体的 Big key</h3><p>详见代码。<a href="https://github.com/pudongping/golang-tutorial/blob/main/project/redis_big_key/big_key.go">源码地址</a></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> redis_big_key<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"io/ioutil"</span><span class="token string">"log"</span><span class="token string">"math/rand"</span><span class="token string">"strings"</span><span class="token string">"sync"</span><span class="token string">"time"</span><span class="token string">"github.com/go-redis/redis"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">NewRedisClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client <span class="token punctuation">{</span>client <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span>     <span class="token string">"localhost:6379"</span><span class="token punctuation">,</span>Password<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>DB<span class="token punctuation">:</span>       <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">return</span> client<span class="token punctuation">}</span><span class="token comment">// GenerateRandomString 生成指定大小的随机字符串</span><span class="token keyword">func</span> <span class="token function">GenerateRandomString</span><span class="token punctuation">(</span>size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> size <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">}</span>rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>chars <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span><span class="token punctuation">)</span>result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> chars<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// WriteBigKey 写入大 key</span><span class="token keyword">func</span> <span class="token function">WriteBigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>client <span class="token operator">:=</span> <span class="token function">NewRedisClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 使用完毕后，关闭连接</span><span class="token keyword">defer</span> client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">var</span> err <span class="token builtin">error</span><span class="token comment">// 写入字符串类型的键，大小为 5M</span>largeStringValue <span class="token operator">:=</span> <span class="token function">GenerateRandomString</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"large_string_key"</span><span class="token punctuation">,</span> largeStringValue<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"写入字符串类型的键失败，错误信息为：%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 写入哈希类型的键，元素个数大于 200</span>hashData <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">var</span> hashLock sync<span class="token punctuation">.</span>RWMutex<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>field <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"field_%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>value <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"value_%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>hashLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>hashData<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">=</span> valuehashLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> err <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">HMSet</span><span class="token punctuation">(</span><span class="token string">"large_hash_key"</span><span class="token punctuation">,</span> hashData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"写入哈希类型的键失败，错误信息为：%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 写入列表类型的键，元素个数大于 200</span>listData <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>listData <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>listData<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"value_%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> err <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">LPush</span><span class="token punctuation">(</span><span class="token string">"large_list_key"</span><span class="token punctuation">,</span> listData<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"写入列表类型的键失败，错误信息为：%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 写入集合类型的键，元素个数大于 200</span>setData <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>setData <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>setData<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> err <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">SAdd</span><span class="token punctuation">(</span><span class="token string">"large_set_key2"</span><span class="token punctuation">,</span> setData<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"写入集合类型的键失败，错误信息为：%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 写入有序集合类型的键，元素个数大于 200</span>zsetData <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>redis<span class="token punctuation">.</span>Z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>zsetData <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>zsetData<span class="token punctuation">,</span> redis<span class="token punctuation">.</span>Z<span class="token punctuation">{</span>Score<span class="token punctuation">:</span>  <span class="token function">float64</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>Member<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"value_%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> err <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">ZAdd</span><span class="token punctuation">(</span><span class="token string">"large_zset_key"</span><span class="token punctuation">,</span> zsetData<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"写入有序集合类型的键失败，错误信息为：%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"写入大 key 总耗时：%s"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// ScanBigKey 扫描大 key</span><span class="token comment">// maxMemory 单位为 b</span><span class="token keyword">func</span> <span class="token function">ScanBigKey</span><span class="token punctuation">(</span>maxMemory <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token keyword">if</span> maxMemory <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">var</span> cursor <span class="token builtin">uint64</span><span class="token keyword">var</span> keys <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>client <span class="token operator">:=</span> <span class="token function">NewRedisClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>maxKeys <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token punctuation">{</span><span class="token keyword">var</span> err <span class="token builtin">error</span>keys<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span> err <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"扫描大 key 失败，错误信息为：%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 检查每个键的内存占用情况</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> keys <span class="token punctuation">{</span><span class="token comment">// memory 单位为 byte</span>memory<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">MemoryUsage</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"获取键 %s 的内存占用失败，错误信息为：%s"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 如果内存占用超过指定最大内存时，则打印出来</span><span class="token keyword">if</span> memory <span class="token operator">&gt;</span> maxMemory <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"键 %s 的内存占用为 %f MB"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">float64</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>maxKeys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>maxKeys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// 如果 cursor 为 0，说明已经遍历完成，退出循环</span><span class="token keyword">if</span> cursor <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span><span class="token keyword">break</span><span class="token punctuation">}</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"扫描大 key 总耗时：%s"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> maxKeys<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">ClearKeys</span><span class="token punctuation">(</span>keys <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>client <span class="token operator">:=</span> <span class="token function">NewRedisClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>pipe <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>pipe<span class="token punctuation">.</span><span class="token function">Unlink</span><span class="token punctuation">(</span>keys<span class="token operator">...</span><span class="token punctuation">)</span><span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> pipe<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"删除 key 失败，错误信息为：%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"删除 key 总耗时：%s"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">WriteKeysToFile</span><span class="token punctuation">(</span>keys <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span>content <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token string">"./bigKey.txt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token keyword">return</span> err<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-如何优化-Redis-的-Big-key？"><a href="#4-如何优化-Redis-的-Big-key？" class="headerlink" title="4. 如何优化 Redis 的 Big key？"></a>4. 如何优化 Redis 的 Big key？</h2><h3 id="数据结构优化"><a href="#数据结构优化" class="headerlink" title="数据结构优化"></a>数据结构优化</h3><ul><li>拆分数据：将大 key 拆分为更小的键，这可以通过拆分数据结构或者对数据进行分片来实现。</li><li>选择合适的数据结构：使用更适合你数据和使用场景的数据结构，比如将列表（list）转换为集合（set）、哈希（hash）或有序集合（sorted set）等。</li></ul><h3 id="数据清理"><a href="#数据清理" class="headerlink" title="数据清理"></a>数据清理</h3><ul><li>定期清理过期数据：确保过期数据及时清理，避免无用数据占用空间。</li><li>删除不必要的数据：定期清理不再需要的数据，确保 Redis 中保留的数据时真正有用的。但是要注意的是：如果直接 del，可能会导致阻塞 Redis 服务。大致有以下处理方式：<ul><li>使用异步删除：使用 <code>unlink</code> 异步删除，可以避免阻塞 Redis 服务，但是会导致内存占用变大。</li><li>使用分批删除：将大量的删除操作分批进行，每次删除一部分，直到删除完毕。</li></ul></li></ul><h3 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h3><ul><li>内存淘汰策略：调整 Redis 的内存淘汰策略，比如设置 LRU（最近最少使用）策略来淘汰不常用的键。</li><li>内存优化配置：调整 Redis 的内存配置参数，比如适当调整 <code>maxmemory</code> 参数，避免内存超限问题。</li></ul><blockquote><p><a href="pudongping.github.io">原文地址</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 使用虚拟环境</title>
      <link href="posts/ddef4649.html"/>
      <url>posts/ddef4649.html</url>
      
        <content type="html"><![CDATA[<h1 id="Python-使用虚拟环境"><a href="#Python-使用虚拟环境" class="headerlink" title="Python 使用虚拟环境"></a>Python 使用虚拟环境</h1><p>Python 需要使用虚拟环境的主要原因包括：</p><ol><li>隔离项目依赖：虚拟环境允许您在不同的项目之间隔离依赖关系。这意味着您可以为每个项目创建一个独立的虚拟环境，以确保项目的依赖不会相互干扰。这对于开发多个项目或维护项目的不同版本非常重要，因为它可以防止依赖冲突。</li><li>版本管理：虚拟环境允许您在不同的项目中使用不同的 Python 版本。这对于需要支持不同 Python 版本的项目非常有用，因为您可以在不同的虚拟环境中安装和使用特定版本的 Python。</li><li>防止全局依赖污染：如果您在全局 Python 环境中安装依赖项，可能会导致全局依赖项的混乱，甚至可能破坏系统依赖项。虚拟环境将项目的依赖项隔离到项目本身的目录中，从而避免了这种情况。</li><li>管理依赖项：虚拟环境允许您在项目级别管理依赖项。您可以使用 pip 来安装、升级和卸载依赖项，而不会影响全局 Python 环境。</li><li>简化部署：使用虚拟环境，您可以轻松地将项目及其依赖项打包并部署到其他环境中，而不必担心依赖冲突或版本问题。</li></ol><h2 id="Pipenv"><a href="#Pipenv" class="headerlink" title="Pipenv"></a><a href="https://github.com/pypa/pipenv">Pipenv</a></h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 全局安装，如果只想在当前用户模式下安装，可添加参数 `--user`</span>pip3 <span class="token function">install</span> pipenv<span class="token comment"># 更新 pipenv</span>pip3 <span class="token function">install</span> <span class="token parameter variable">--user</span> <span class="token parameter variable">--upgrade</span> pipenv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 python3 版本</span>python3 <span class="token parameter variable">--version</span><span class="token comment"># 假设是 Python 3.11.4</span><span class="token comment"># 指定使用 python 3.11.4 创建虚拟环境</span>pipenv <span class="token parameter variable">--python</span> <span class="token number">3.11</span>.4<span class="token comment"># 激活虚拟环境</span>pipenv shell<span class="token comment"># 退出当前虚拟环境</span><span class="token builtin class-name">exit</span><span class="token comment"># 删除当前虚拟环境</span>pipenv <span class="token parameter variable">--rm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="下载依赖包"><a href="#下载依赖包" class="headerlink" title="下载依赖包"></a>下载依赖包</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载 Pipfile 文件中的所有包</span>pipenv <span class="token function">install</span><span class="token comment"># 安装 requests 插件包并加入到 Pipfile</span>pipenv <span class="token function">install</span> requests<span class="token comment"># 安装固定版本的 requests</span>pipenv <span class="token function">install</span> <span class="token assign-left variable">requests</span><span class="token operator">==</span><span class="token number">2.22</span>.0<span class="token comment"># 只安装开发环境才会使用到的包</span>pipenv <span class="token function">install</span> <span class="token punctuation">{</span>package-name<span class="token punctuation">}</span> <span class="token parameter variable">--dev</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="更新依赖包"><a href="#更新依赖包" class="headerlink" title="更新依赖包"></a>更新依赖包</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看所有需要更新的依赖</span>pipenv update <span class="token parameter variable">--outdated</span><span class="token comment"># 更新所有包的依赖项</span>pipenv update<span class="token comment"># 更新指定包的依赖项</span>pipenv update <span class="token punctuation">{</span>package-name<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="卸载依赖包"><a href="#卸载依赖包" class="headerlink" title="卸载依赖包"></a>卸载依赖包</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 卸载指定模块</span>pipenv uninstall <span class="token punctuation">{</span>package-name<span class="token punctuation">}</span><span class="token comment"># 卸载全部包</span>pipenv uninstall <span class="token parameter variable">--all</span><span class="token comment"># 卸载全部开发环境所需要依赖的包</span>pipenv uninstall --all-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="其他常用命令"><a href="#其他常用命令" class="headerlink" title="其他常用命令"></a>其他常用命令</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 显示目录信息</span>pipenv <span class="token parameter variable">--where</span><span class="token comment"># 显示虚拟环境信息</span>pipenv <span class="token parameter variable">--venv</span><span class="token comment"># 显示 python 解释器信息</span>pipenv <span class="token parameter variable">--py</span><span class="token comment"># 查看当前安装的库及其依赖</span>pipenv graph<span class="token comment"># 检查安全漏洞</span>pipenv check<span class="token comment"># 生成 Pipfile.lock 文件</span>pipenv lock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="requirements-txt"><a href="#requirements-txt" class="headerlink" title="requirements.txt"></a>requirements.txt</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将 Pipfile 和 Pipfile.lock 文件里面的包导出为 requirements.txt 文件</span>pipenv run pip freeze <span class="token operator">&gt;</span> requirements.txt<span class="token comment"># 或者</span>pipenv requirements <span class="token operator">&gt;</span> requirements.txt<span class="token comment"># 只使用 `pipenv install` 时会自动检测当前目录下的 requirements.txt 并生成 Pipfile 文件</span><span class="token comment"># 通过 requirements.txt 安装包</span>pipenv <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements.txt<span class="token comment"># 只安装开发环境所需要的包</span>pipenv <span class="token function">install</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">--dev</span> requirements.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python3 </tag>
            
            <tag> Pip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>认识下 JWT</title>
      <link href="posts/22722346.html"/>
      <url>posts/22722346.html</url>
      
        <content type="html"><![CDATA[<h1 id="认识下-JWT"><a href="#认识下-JWT" class="headerlink" title="认识下 JWT"></a>认识下 JWT</h1><p><a href="https://jwt.io/">JWT</a> 是 JSON Web Token 的缩写，是一个非常轻巧的规范，这个规范允许我们使用 JWT 在用户和服务器之间传递安全可靠的信息。<br>JWT 由头部（header）、载荷（payload）与签名（signature）组成，一个 JWT 类似下面这样：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">{</span>    <span class="token string">"typ"</span><span class="token builtin class-name">:</span><span class="token string">"JWT"</span>,    <span class="token string">"alg"</span><span class="token builtin class-name">:</span><span class="token string">"HS256"</span><span class="token punctuation">}</span><span class="token punctuation">{</span>    <span class="token string">"iss"</span><span class="token builtin class-name">:</span><span class="token string">"http://localhost"</span>,    <span class="token string">"iat"</span>:1587000625,    <span class="token string">"exp"</span>:1618536625,    <span class="token string">"nbf"</span>:1587000625,    <span class="token string">"jti"</span><span class="token builtin class-name">:</span><span class="token string">"iCxsfo97UVUijjjP"</span>,    <span class="token string">"sub"</span>:1,    <span class="token string">"prv"</span><span class="token builtin class-name">:</span><span class="token string">"13e8d028b391f3b7b63f21933dbad458ff21072e"</span><span class="token punctuation">}</span>signature<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>头部声明了加密算法；</li><li>载荷中有两个比较重要的数据，<code>exp</code> 是过期时间，<code>sub</code> 是 JWT 的主体，这里就是用户的 id；<ul><li>aud（Audience）：受众，也就是接受 JWT 的一方。</li><li>exp（ExpiresAt）：所签发的 JWT 过期时间，过期时间必须大于签发时间。</li><li>jti（JWT Id）：JWT 的唯一标识。</li><li>iat（IssuedAt）：签发时间</li><li>iss（Issuer）：JWT 的签发者。</li><li>nbf（Not Before）：JWT 的生效时间，如果未到这个时间则为不可用。</li><li>sub（Subject）：主题</li></ul></li><li>最后的 signature 是由服务器进行的签名，保证了 token 不被篡改。</li></ul><p>signature 签名的生成公式示例如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">HMACSHA256<span class="token punctuation">(</span>  base64UrlEncode<span class="token punctuation">(</span>header<span class="token punctuation">)</span> + <span class="token string">"."</span> +  base64UrlEncode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>,  secret<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>JWT 最后是通过 Base64 编码的，也就是说，它可以被翻译回原来的样子来的。所以不要在 JWT 中存放一些敏感信息。</p></blockquote><p>用户 id，过期时间等数据都保存在 Token 中了，所以并不需要将 Token 保存在服务器中，客户端请求的时候在 Header 中携带 Token，服务器获取 Token 后，进行 <code>base64_decode</code>  即可获取数据进行校验，由于已经有了签名，所以不用担心数据被篡改。</p><h3 id="Token-验证"><a href="#Token-验证" class="headerlink" title="Token 验证"></a>Token 验证</h3><p>有了 token 之后该如何验证 token 的有效性，并得到 token 对应的用户呢？其实原理很简单，Laravel 为我们准备好了 <code>auth</code> 这个中间件</p><ol><li>获取客户端提交的 token</li><li>检测 token 中的签名 signature 是否正确</li><li>判断 payload 数据中的 exp，是否已经过期</li><li>根据 payload 数据中的 sub，取数据库中验证用户是否存在</li><li>上述检测不正确，则抛出相应异常</li></ol><h3 id="安装-jwt-auth"><a href="#安装-jwt-auth" class="headerlink" title="安装 jwt-auth"></a>安装 jwt-auth</h3><p><a href="https://github.com/tymondesigns/jwt-auth">jwt-auth</a> 是 Laravel 和 lumen 的 JWT 组件，首先来安装一下。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> require tymon/jwt-auth<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>安装完成后，我们需要设置一下 JWT 的 secret，这个 secret 很重要，用于最后的签名，更换这个 secret 会导致之前生成的所有 token 无效。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan jwt:secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>可以看到在 .env 文件中，增加了一行 <code>JWT_SECRET</code>。<br>修改 config/auth.php，将 <code>api guard</code> 的 <code>driver</code> 改为 <code>jwt</code>。</p><p>config/auth.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'guards'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>    <span class="token string single-quoted-string">'web'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'driver'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'session'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'provider'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'users'</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'api'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'driver'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'jwt'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'provider'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'users'</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>user 模型需要继承 <code>Tymon\JWTAuth\Contracts\JWTSubject</code> 接口，并实现接口的两个方法 <code>getJWTIdentifier()</code> 和 <code>getJWTCustomClaims()</code>。</p><p>app\Models\User.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Models</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Auth</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Spatie<span class="token punctuation">\</span>Permission<span class="token punctuation">\</span>Traits<span class="token punctuation">\</span>HasRoles</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Tymon<span class="token punctuation">\</span>JWTAuth<span class="token punctuation">\</span>Contracts<span class="token punctuation">\</span>JWTSubject</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Notifications<span class="token punctuation">\</span>Notifiable</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Auth<span class="token punctuation">\</span>User</span> <span class="token keyword">as</span> Authenticatable<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Auth<span class="token punctuation">\</span>MustVerifyEmail</span> <span class="token keyword">as</span> MustVerifyEmailTrait<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Contracts<span class="token punctuation">\</span>Auth<span class="token punctuation">\</span>MustVerifyEmail</span> <span class="token keyword">as</span> MustVerifyEmailContract<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Authenticatable</span> <span class="token keyword">implements</span> <span class="token class-name">MustVerifyEmailContract</span><span class="token punctuation">,</span> JWTSubject    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getJWTIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getJWTCustomClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>getJWTIdentifier</code> 返回了 User 的 id，<code>getJWTCustomClaims</code> 是我们需要额外在 JWT 载荷中增加的自定义内容，这里返回空数组。打开 tinker，执行如下代码，尝试生成一个 token。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name static-context">Auth</span><span class="token operator">::</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>jwt-auth</code> 有两个重要的参数，可以在 .env 中进行设置</p><ul><li><code>JWT_TTL</code> 生成的 token 在多少分钟后过期，默认 60 分钟</li><li><code>JWT_REFRESH_TTL</code>   生成的 token，在多少分钟内，可以刷新获取一个新 token，默认 20160 分钟，14 天。</li></ul><p>这里需要理解一下 JWT 的过期和刷新机制，过期很好理解，超过了这个时间，token 就无效了。刷新时间一般比过期时间长，只要在这个刷新时间内，即使 token 过期了， 依然可以换取一个新的 token，以达到应用长期可用，不需要重新登录的目的。</p>]]></content>
      
      
      <categories>
          
          <category> 科普 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> JWT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>你愿意花半个小时时间得到一个终身受益的技能吗</title>
      <link href="posts/7c4e8ab6.html"/>
      <url>posts/7c4e8ab6.html</url>
      
        <content type="html"><![CDATA[<p>首先我们用 3 秒时间来闭目思考一下，半个小时我们可以做哪些事情？3 2 1 好，时间到。相信你已经有了你自己的答案，而今天我要给大家介绍的是可以用半个小时就能够快速掌握的一项技能：用双拼打字。</p><h2 id="什么是双拼？"><a href="#什么是双拼？" class="headerlink" title="什么是双拼？"></a>什么是双拼？</h2><blockquote><p>双拼是汉语拼音输入法的一种编码方案。相对于全拼而言，使用双拼输入汉字时只需输入一个代表声母的字母，一个代表韵母的字母，就可以打出任意一个中文字了。（摘抄自维基百科）</p></blockquote><p>听着还是有些懵？别慌，我举个例子就更好理解了。我们都知道汉字的拼音是由声母和韵母组合而成，比如说，「双拼」 这个词的完整拼音为「shuang pin」，假设我们不借助任何智能拼音输入法，我们用全拼将这个词打出来要按 6 + 3 = 9 次键盘。是不是还是有点费劲儿来着？好，此时我们就会想，既然我们都已经知道拼音是由声母和韵母组合而成，那么是不是就可以考虑用一些键位表示声母，一些键位表示韵母，打字的时候只需要将二者俩俩组合起来即可呢？事实上，真可以这么做，这就是双拼。以「shuang pin」 为例，假设键位 <code>u</code> 代表 <code>sh</code>、<code>l</code> 表示 <code>uang</code>、<code>p</code> 代表 <code>p</code>、<code>b</code> 代表 <code>in</code>，那么当我们想打「双拼」二字时，我们就只需要按「ulpb」这四个键位，按 4 次键盘即可，这相比原来按 9 次键盘还是高效了不少。</p><h2 id="给我一个使用双拼的理由？"><a href="#给我一个使用双拼的理由？" class="headerlink" title="给我一个使用双拼的理由？"></a>给我一个使用双拼的理由？</h2><p>如果你是文字工作者，选择双拼可以让你不用像以前一样高强度的大量击键，打字时，节奏更加齐整。（使用双拼打字的节奏类似：咚咚哒，咚咚哒……，全拼的节奏类似：咚哒、咚咚哒、哒哒……）</p><p>如果你是一个热爱尝试新鲜事物的人，那么学会双拼会让你又增加一项新技能。就像学霸针对一道数学题有好几种解法一样。</p><p>双拼虽不是某项基础生存必备能力，你不学并不会损失什么，但是它确实是一项你不需要花费多大努力就可以轻松学会的技能。不妨试试，看一看学会双拼能给你和你的生活带来多少变化。</p><h2 id="双拼和全拼各自优缺点？"><a href="#双拼和全拼各自优缺点？" class="headerlink" title="双拼和全拼各自优缺点？"></a>双拼和全拼各自优缺点？</h2><p>说到这个问题，我们先回顾一下日常打字时的流程：</p><ol><li>认读</li><li>输入拼音</li><li>翻页</li><li>选字</li></ol><p>根据以上的流程可看出，影响打字速度快慢主要取决于第二点和第三点。打一个字时，使用全拼，这个字的拼音长度有多少，那么则需要敲击多少次键位，而双拼永远固定的只需要敲击两次键位，这让击键的节奏更加齐整。打字时，适当的节奏可以让输出更加流畅。但是在选字阶段时，因为拼音打字重码率本身就比较高，比如当我们打 「yi」时，候选项就会出现很多个，这是全拼和双拼都会存在的痛点。但是不管全拼还是双拼都属于拼音打字，因此只要你会拼音，那么学习成本就不会太高。</p><h2 id="如何使用双拼打字？"><a href="#如何使用双拼打字？" class="headerlink" title="如何使用双拼打字？"></a>如何使用双拼打字？</h2><p>我们先抓住双拼的核心：基于拼音，用两个键位对应声母和韵母。打字时，先将原来的全拼拆分成声母部分和韵母部分，双拼的第一个键用来输入声母，第二个键用来输入韵母，总共敲击 2 次键位即可成字。</p><p>第一个键 —— 声母</p><ul><li>单声母：如q、w、r、t、y等等，这些直接与键盘上的按键相对应。</li><li>双声母：zh、ch、sh，使用某个单韵母的键与之对应，比如 zh-v、ch-i、sh-u。因为双拼的原则是第一个键为声母，所以用户如果在第一个键上按了韵母，那么一定就是需要转换的非单声母了。</li><li>无声母：有一些拼音没有声母，比如，「安」（an），由于双拼的原则是一定要用两个键输入一个字，不能把声母的位置空出来，所以必须给这种类型的拼音单独考虑。一般有两种处理方法：第一种是微软双拼等采用的，固定设定一个韵母键做「零声母」键来补全声母；第二种是小鹤双拼等采用的分情况考虑：1、如果是单声母，如：哦（o），连输两遍韵母（oo）。2、如果是双声母，如：爱（ai），直接打拼音（ai）。3、如果是两位以上的韵母，如：昂（ang），用韵母部分的第一个字符键补全声母，第二个键按非单韵母转换（ah）。（这里韵母 <code>ang</code> 映射的键位为 <code>h</code>）。</li></ul><p>第二个键 —— 韵母</p><ul><li>单韵母：如a、o、e、i等等，与单声母的处理方式一样，直接与键盘上的按键相对应。</li><li>其它的韵母：均由单声母的键与之对应。某些键还可以与多个韵母对应，如：以小鹤双拼为例 x-ia/ua。为什么可以这么设计呢？因为这些韵母都是互斥的，能与 <code>ia</code> 组合的声母一定不能与 <code>ua</code> 组合，反之亦然。如：花（hua），但是 <code>hia</code> 打不出字；家（jia），但是 <code>jua</code> 打不出字。</li></ul><p>举个例子，如果我们想要打「爱双拼」这三个字时：</p><ul><li>爱 ai —— 没有声母，韵母为非单韵母。小鹤双拼采用<strong>分情况考虑</strong>，因为韵母为两位，所以直接打拼音（ai）；微软双拼采用<strong>单独设定零声母键</strong>，微软双拼设定的零键为 <code>o</code>、韵母 <code>ai</code> 映射的键位为 <code>l</code>，所以为（ol）。</li><li>双 shuang —— 声母为双声母，韵母为非单韵母，则均需转换。以小鹤双拼为例，声母 <code>sh</code> 映射为 <code>u</code>，韵母 <code>uang</code> 映射为 <code>l</code> 所以为 <code>ul</code>。</li><li>拼 pin —— 声母为单声母，不用转换，韵母为非单韵母，需要转换。以小鹤双拼为例，声母 <code>p</code> 映射为 <code>p</code>，韵母 <code>in</code> 映射为 <code>b</code> 所以为 <code>pb</code>。</li></ul><h2 id="双拼方案有哪些？"><a href="#双拼方案有哪些？" class="headerlink" title="双拼方案有哪些？"></a>双拼方案有哪些？</h2><ul><li>常见的双拼方案：微软、智能ABC、加加、小鹤、搜狗、紫光、自然码……</li><li>不太常见的双拼方案：国标（中华人民共和国国家标准）、雅歌、徐氏……</li><li>爱好者双拼方案：小浪、大牛、星空……</li></ul><h2 id="为什么会有这么多不同的方案呢？"><a href="#为什么会有这么多不同的方案呢？" class="headerlink" title="为什么会有这么多不同的方案呢？"></a>为什么会有这么多不同的方案呢？</h2><p>双拼的输入概念是：将全拼拆分成声母部分和韵母部分，然后用一套规则去规定各个声韵母与各个键的对应关系，这是每一套方案都遵循的核心原则。那么，在这个核心概念的约束下，具体的对应关系就仁者见仁，智者见智了，每一个人都可以给自己制定一套规则。所以，就会有各种各样的双拼方案了。</p><h2 id="那么多方案，如何选定一套适合自己的双拼方案？"><a href="#那么多方案，如何选定一套适合自己的双拼方案？" class="headerlink" title="那么多方案，如何选定一套适合自己的双拼方案？"></a>那么多方案，如何选定一套适合自己的双拼方案？</h2><p>关于双拼方案的选择，你需要先确定你所用的平台、你所用的输入法是否支持该方案，且该方案是否还保持维护。不然你学会了某方案之后没法输入就比较尴尬啦！（在 2018 年的时候，我就了解过双拼，但由于那时我手机默认输入法不支持双拼，因此后面就不了了之了。）</p><p>目前<strong>主流</strong>的输入法基本上都会自带这些双拼方案：自然码双拼、微软双拼、搜狗双拼、小鹤双拼、拼音加加双拼、智能ABC。<strong>不同的双拼方案有不同的风格，没有绝对的孰优孰劣之分</strong>。</p><p>在所有的主流方案中，我个人最推荐的是小鹤双拼和自然码双拼。如果你是 iOS/MacOS 用户，这个推荐范围再缩窄到小鹤双拼这一种。除去这两种都是系统输入法的原生支持之外，主要还有以下原因：</p><p><img src="/medias/loading.gif" data-original="https://cdn.sspai.com/editor/u_/c9akdr5b34ta61ljn9k0.png?imageView2/2/w/1120/q/90/interlace/1/ignore-error/1" alt="小鹤双拼方案"></p><p><img src="/medias/loading.gif" data-original="https://cdn.sspai.com/editor/u_/c9akdr5b34ta7netbujg.png?imageView2/2/w/1120/q/90/interlace/1/ignore-error/1" alt="自然码双拼方案"></p><ul><li>这两种方案都避开了采用 <code>;</code> 键安放韵母。（如微软双拼、搜狗双拼、紫光双拼都将 <code>;</code> 键映射成了韵母 <code>ing</code>）这样破坏了我们常规拼音记忆思维。（标点符号就应该是标点符号键位。）</li><li>这两种方案都没有采用固定零声母方案。所谓「零声母」指的是将键盘上一个特定的键指定为零声母，搭配韵母键以输入纯韵母组成的字，如微软双拼中输入「安」为<code>oj</code>。小鹤和自然码将零声母设定成韵母的首字母，这样一来，双字母组成的纯韵母字可以与全拼完全一致，如「安」为<code>an</code>，单字母的纯韵母字双击按键即可，如「哦」为<code>oo</code>，降低了适应难度。</li></ul><p>在设计上，小鹤双拼脱胎于较为古老的自然码双拼，调整了部分韵母的位置，但基本上把使用频率较高的韵母放在了比较易于发力的食指和中指上。</p><p>之前在讨论全拼和双拼的优缺点时，说到过拼音打字时的重码率高，不像五笔输入法一样，可以做到「四码唯一」，适合盲打。那有没有办法可以做到拼音输入法和五笔输入法相结合，且也可以减少重码率呢？还真可以，那就是「小鹤音形」。学好了小鹤双拼之后很容易上手小鹤音形，因此，在众多双拼方案中，我最推荐的就是<strong>小鹤双拼</strong>。当然，选择适合自己的，才是最好的！</p><h2 id="双拼方案的练习"><a href="#双拼方案的练习" class="headerlink" title="双拼方案的练习"></a>双拼方案的练习</h2><h3 id="如何快速记忆键位？"><a href="#如何快速记忆键位？" class="headerlink" title="如何快速记忆键位？"></a>如何快速记忆键位？</h3><p>记忆某些事物时，一般我会先考虑理解优先，其次再「连连看」和「找不同」，最后再是死记硬背。下面我分享一下我通过<strong>十分钟左右的时间记完小鹤双拼方案键位</strong>的方法。</p><h4 id="声母"><a href="#声母" class="headerlink" title="声母"></a>声母</h4><ul><li>单声母：直接与键盘上的键位相对应；</li><li>三个双声母 zh-v、ch-i、sh-u 可以直接死记硬背；</li><li>零声母（拼音中全部是韵母时）：<ul><li>单韵母、三韵母时：韵母首字母 + 韵母所在键。如：啊 a-aa、哦 o-oo、额 e-ee、昂 ang-ah、鞥 eng-eg</li><li>双韵母时：直接打拼音。如：爱 ai-ai、安 an-an、傲 ao-ao、诶 ei-ei、嗯 en-en、耳 er-er、偶 ou-ou</li></ul></li></ul><h4 id="韵母"><a href="#韵母" class="headerlink" title="韵母"></a>韵母</h4><ul><li>先一起记忆 en、eng、ang、an 这四个韵母。 我们发现这几个韵母还是有一点儿对称的，刚好我们在使用键盘时，正确的指法是将左手食指放在 <code>f</code> 键上，右手食指放在 <code>j</code> 键上，这样 f-en、g-eng、h-ang、j-an 并且在按键盘的过程中，我们也可以发现从外往内韵母更长，如左手食指从左往右时 f-en、g-eng，右手食指从右往左时 j-an、h-ang；</li><li>然后一并记忆 s-iong/ong、l-iang、uang 同样你也可以发现，在正确的指法时，我们左手的无名指刚好就放在 <code>s</code> 键上，右手的无名指刚好放在 <code>l</code> 键上。且我们可以大致记忆以 <code>ong</code> 结尾的就是在 <code>s</code> 键上，以 <code>ang</code> 结尾的就是在 <code>l</code> 键上更进一步记忆。</li><li>其他的韵母，我是直接通过键位上的声母和韵母组成某些音来记忆的，因为声母键位在使用全拼时，我就会盲打，因此简单，现在就是要确定韵母键位，那就直接通过声母键位找韵母键位就可以更快上手了。接下来我一个一个讲解。<ul><li>q-iu ——我直接记忆「秋」的音，这样我就很快可以通过 <code>q</code> 找到 <code>iu</code></li><li>w-ei —— 同理「为」</li><li>r-uan —— 软</li><li>y-yun —— 晕</li><li>p-ie —— 撇</li><li>d-ai —— 呆</li><li>z-ou —— 走</li><li>c-ao —— 草</li><li>b-in —— 斌</li><li>n-iao —— 鸟</li><li>m-ian —— 面</li><li>t-ue/ve —— 这个无法直接组成拼音，可通过 ue 和 ve「长得像」来将二者记在一起</li><li>o-o/uo —— 这个我是直接通过「o」的读音「哦」来记忆的</li><li>k-ing/uai —— 这个我是通过英文单词 king 和 kuai（快）来记忆</li><li>x-ia/ua —— 这个我是通过 xia（虾），然后 ia 和 ua「长得像」来记忆</li><li>v-ui/v —— 这个我是直接通过「微」的读音来记忆的</li></ul></li></ul><p>以上是我的记忆方式，供各位参考。总之适合自己的方式才是最好的方式，只要能够记住就行。</p><h3 id="如何快速练习？"><a href="#如何快速练习？" class="headerlink" title="如何快速练习？"></a>如何快速练习？</h3><h4 id="可以通过一些练习站点来学习"><a href="#可以通过一些练习站点来学习" class="headerlink" title="可以通过一些练习站点来学习"></a>可以通过一些练习站点来学习</h4><p>这里推荐使用 <a href="https://api.ihint.me/shuang/">https://api.ihint.me/shuang/</a> 这个在线网站来学习，支持 17 种双拼方案，并且还有微信小程序版（可以搜索小程序「双拼学习」来使用）</p><p><img src="/medias/loading.gif" data-original="https://cdn.nlark.com/yuque/0/2023/png/26208023/1698650234532-d5f0ee18-85f1-4132-894b-7a212039c336.png?x-oss-process=image/resize,w_1500,limit_0"></p><h4 id="强化韵母练习"><a href="#强化韵母练习" class="headerlink" title="强化韵母练习"></a>强化韵母练习</h4><p>这个就像我们上学的时候暴力记单词一样，只要你一个动作重复的多了，你就自然而然的会记住，那么什么样的文字内容韵母重复率会比较高呢？那肯定就是得押韵嘛，比如如下</p><p>tm qk se dg yj yu （tian qing se deng yan yu）<br>er wo zd dg ni （er wo zai deng ni）<br>iv yj nn nn ug qi （chui yan niao niao sheng qi）<br>ge jl qm wj li （ge jiang qian wan li）<br>zd pk di uu hj li （zai ping di shu han li）<br>fh qm ic de pn yi （fang qian chao de piao yi）<br>jq dh wo ww yu jm ni fu bi （jiu dang wo wei yu jian ni fu bi）</p><p>因此通过打歌词或者押韵比较多的诗歌都是一个不错的选择。</p><h4 id="多练习"><a href="#多练习" class="headerlink" title="多练习"></a>多练习</h4><p>学以致用才有用，平时无论是聊天还是工作，都尽可能使用双拼。刚开始使用时肯定不是那么顺畅，这很正常，这篇文章我就是使用双拼写的，当然打字速度并没有我使用全拼快。但是，只要不断的用，那么肯定会熟能生巧。聊天时，如果记不太清键位，还可以将键位图设定为聊天背景。因为我使用的是「小鹤双拼」这里我提供一张小鹤双拼方案的壁纸供各位参考。</p><p><img src="/medias/loading.gif" data-original="https://cdn.nlark.com/yuque/0/2023/jpeg/26208023/1698653500731-34b243ec-7659-4dfa-bd90-339494be30e4.jpeg" alt="小鹤双拼1284×2778壁纸"></p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>学习肯定是痛苦的，但受益也是终身的。既然你都能够看到这里，那么我建议你还是坚持将双拼学会吧。之所以没有推荐学习五笔，那是因为学习五笔确实学习曲线比较陡峭，而双拼算是一个打字较快、学习曲线较平缓的一个折中方案了。希望没有浪费你的时间，也希望这篇文章能够给你带来帮助。</p><h2 id="关联阅读"><a href="#关联阅读" class="headerlink" title="关联阅读"></a>关联阅读</h2><ul><li><a href="https://zh.wikipedia.org/zh-hans/%E5%8F%8C%E6%8B%BC">双拼-维基百科</a></li><li><a href="https://sspai.com/post/72622">二〇二二年，来试试双拼输入法吧</a></li><li><a href="https://sspai.com/post/42667">让双拼不再是只属于少数人的输入方式</a></li><li><a href="https://sspai.com/post/56134">双拼输入法的进阶：小鹤音形</a></li></ul><p>我是 Alex，三观比五官更正，思想比套路更深的编程爱好者。</p>]]></content>
      
      
      <categories>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生活 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wise-locksmith PHP 互斥锁库</title>
      <link href="posts/1e08f87d.html"/>
      <url>posts/1e08f87d.html</url>
      
        <content type="html"><![CDATA[<h1 id="PHP-互斥锁库"><a href="#PHP-互斥锁库" class="headerlink" title="PHP 互斥锁库"></a>PHP 互斥锁库</h1><p><a href="https://github.com/pudongping/wise-locksmith">wise-locksmith</a> 是一个不局限于框架的互斥锁库，用于在高并发场景下提供 PHP 代码的互斥执行。<br>如果你是使用 <a href="https://hyperf.wiki/">hyperf</a> 框架，那么你可以直接使用 <a href="https://github.com/pudongping/hyperf-wise-locksmith">hyperf-wise-locksmith</a> 适配库。</p><h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><ul><li>PHP &gt;= 7.1 或以上版本</li><li>Redis &gt;= 2.6.12 或以上版本（如果需要使用到分布式锁或者红锁的情况下）</li><li>Swoole &gt;= 4.5 或以上版本 （如果需要使用协程级别的互斥锁的情况下）</li></ul><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> require pudongping/wise-locksmith<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">require</span> <span class="token string single-quoted-string">'vendor/autoload.php'</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Pudongping<span class="token punctuation">\</span>WiseLocksmith<span class="token punctuation">\</span>Locker</span><span class="token punctuation">;</span><span class="token variable">$redisHosts</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'host'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'port'</span> <span class="token operator">=&gt;</span> <span class="token number">6379</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'host'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'port'</span> <span class="token operator">=&gt;</span> <span class="token number">6380</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'host'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'port'</span> <span class="token operator">=&gt;</span> <span class="token number">6381</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'host'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'port'</span> <span class="token operator">=&gt;</span> <span class="token number">6382</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'host'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'port'</span> <span class="token operator">=&gt;</span> <span class="token number">6383</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 如果需要使用到分布式锁或者红锁时，则需要初始化 redis 实例，否则可跳过这一步</span><span class="token variable">$redisInstances</span> <span class="token operator">=</span> <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$redis</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$redis</span><span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$redis</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$redisHosts</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建一个锁实例</span><span class="token variable">$locker</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Locker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="flock-文件锁"><a href="#flock-文件锁" class="headerlink" title="flock - 文件锁"></a>flock - 文件锁</h3><p>文件锁没有任何依赖。可通过可选的第 3 个参数参数设置锁的超时时间，单位：秒。（支持浮点型，比如 1.5 表示 1500ms 也就是最多会等待 1500ms，如果没有抢占到锁，那么则主动放弃抢锁，同时会抛出 <code>Pudongping\WiseLocksmith\Exception\TimeoutException</code> 异常）<br>设置成 <code>Pudongping\WiseLocksmith\Lock\File\Flock::INFINITE_TIMEOUT</code> 时，表示永不过期，则当前一直会阻塞式抢占锁，直到抢占到锁为止。默认值为：<code>Pudongping\WiseLocksmith\Lock\File\Flock::INFINITE_TIMEOUT</code>。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$path</span> <span class="token operator">=</span> <span class="token function">tempnam</span><span class="token punctuation">(</span><span class="token function">sys_get_temp_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wise-locksmith-flock-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$fileHandler</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$locker</span><span class="token operator">-&gt;</span><span class="token function">flock</span><span class="token punctuation">(</span><span class="token variable">$fileHandler</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 这里写你想保护的代码</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="redisLock-分布式锁"><a href="#redisLock-分布式锁" class="headerlink" title="redisLock - 分布式锁"></a>redisLock - 分布式锁</h3><p>需要依赖 <code>redis</code> 扩展。可通过可选的第 3 个参数设置锁的超时时间，单位：秒。（支持浮点型，比如 1.5 表示 1500ms 也就是最多会等待 1500ms，如果没有抢占到锁，那么则主动放弃抢锁，同时会抛出 <code>Pudongping\WiseLocksmith\Exception\TimeoutException</code> 异常）<br>默认值为：<code>5</code>。第 4 个参数为当前锁的具有唯一性的值，除非有特殊情况下需要设置，一般不需要设置。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$locker</span><span class="token operator">-&gt;</span><span class="token function">redisLock</span><span class="token punctuation">(</span><span class="token variable">$redisInstances</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'redisLock'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 这里写你想保护的代码</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="redLock-红锁（redis-集群环境时，分布式锁的实现）"><a href="#redLock-红锁（redis-集群环境时，分布式锁的实现）" class="headerlink" title="redLock - 红锁（redis 集群环境时，分布式锁的实现）"></a>redLock - 红锁（redis 集群环境时，分布式锁的实现）</h3><p>redLock 锁所需要设置的参数和 redisLock 锁除了第一个参数有区别以外，其他几个参数完全一致。redLock 锁是 redisLock 锁的集群实现。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$locker</span><span class="token operator">-&gt;</span><span class="token function">redLock</span><span class="token punctuation">(</span><span class="token variable">$redisInstances</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'redLock'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 这里写你想保护的代码</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="channelLock-协程级别的互斥锁"><a href="#channelLock-协程级别的互斥锁" class="headerlink" title="channelLock - 协程级别的互斥锁"></a>channelLock - 协程级别的互斥锁</h3><p>使用此锁时，需要安装 <code>swoole</code> 扩展。且版本必须大于等于 <code>4.5</code>。可通过可选的第 3 个参数设置锁的超时时间，单位：秒。（支持浮点型，比如 1.5 表示 1500ms 也就是最多会等待 1500ms，如果没有抢占到锁，那么则主动放弃抢锁，同时直接返回 <code>false</code> 表示没有抢占到锁）<br>设置成 <code>-1</code> 时，表示永不过期，则当前一直会阻塞式抢占锁，直到抢占到锁为止。默认值为：<code>-1</code>。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$locker</span><span class="token operator">-&gt;</span><span class="token function">channelLock</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'channelLock'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 这里写你想保护的代码</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 锁 </tag>
            
            <tag> Mutex </tag>
            
            <tag> Lock </tag>
            
            <tag> 互斥锁 </tag>
            
            <tag> 红锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 GRPC</title>
      <link href="posts/8a377bf8.html"/>
      <url>posts/8a377bf8.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用-GRPC"><a href="#使用-GRPC" class="headerlink" title="使用 GRPC"></a>使用 GRPC</h1><h2 id="安装-protobuf"><a href="#安装-protobuf" class="headerlink" title="安装 protobuf"></a>安装 <a href="https://github.com/protocolbuffers/protobuf">protobuf</a></h2><blockquote><p><a href="https://grpc.io/docs/protoc-installation/">官方安装地址</a></p></blockquote><ul><li>第一种方式：Mac 下使用 Homebrew 安装</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> protobuf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>第二种方式：指定版本号安装</li></ul><blockquote><p>这里指定安装 <code>3.17.0</code> 版本</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">PROTOC_ZIP</span><span class="token operator">=</span>protoc-3.17.0-osx-x86_64.zip<span class="token function">curl</span> <span class="token parameter variable">-OL</span> https://github.com/protocolbuffers/protobuf/releases/download/v3.17.0/<span class="token variable">$PROTOC_ZIP</span><span class="token function">sudo</span> <span class="token function">unzip</span> <span class="token parameter variable">-o</span> <span class="token variable">$PROTOC_ZIP</span> <span class="token parameter variable">-d</span> /usr/local bin/protoc<span class="token function">sudo</span> <span class="token function">unzip</span> <span class="token parameter variable">-o</span> <span class="token variable">$PROTOC_ZIP</span> <span class="token parameter variable">-d</span> /usr/local <span class="token string">'include/*'</span><span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable">$PROTOC_ZIP</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>或者使用如下方式安装</p><blockquote><p>这里示范的是安装 Linux 环境下的 protobuf</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载编译好的二进制包</span><span class="token function">wget</span> https://github.com/protocolbuffers/protobuf/releases/download/v3.17.0-rc1/protoc-3.17.0-rc-1-linux-x86_64.zip<span class="token comment"># 创建文件夹并解压缩到指定文件夹中</span><span class="token function">mkdir</span> protoc <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> protoc-3.17.0-rc-1-linux-x86_64.zip <span class="token parameter variable">-C</span> protoc<span class="token comment"># 将解压后的文件移动到 /usr/local 文件夹下</span><span class="token function">sudo</span> <span class="token function">mv</span> protoc /usr/local/protoc<span class="token comment"># 创建软连接，方便在任意目录下使用 protoc 命令</span><span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/protoc/bin/protoc /usr/local/bin/protoc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>第三种方式：编译安装</li></ul><blockquote><p>这里安装的是 <code>3.19.1</code> 版本</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载安装包</span><span class="token function">wget</span> https://github.com/protocolbuffers/protobuf/releases/download/v3.19.1/protobuf-all-3.19.1.zip<span class="token comment"># 解压缩</span><span class="token function">unzip</span> protobuf-all-3.19.1.zip <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> protobuf-3.19.1./configure<span class="token function">make</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>第四种方式：直接使用二进制文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 根据你自己的系统下载对应的源码包 （比如我这里使用的是 mac book，我就要下载 osx 压缩包）</span><span class="token builtin class-name">cd</span> ~/go-tools <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> https://github.com/protocolbuffers/protobuf/releases/download/v3.19.1/protoc-3.19.1-osx-x86_64.zip<span class="token comment"># 解压缩</span><span class="token function">unzip</span> protoc-3.19.1-osx-x86_64.zip<span class="token comment"># 编辑配置文件</span><span class="token function">vim</span> ~/.zshrc<span class="token comment"># 写入以下配置信息</span><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"/Users/pudongping/go-tools/protoc-3.19.1-osx-x86_64/bin:<span class="token environment constant">$PATH</span>"</span><span class="token builtin class-name">source</span> ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通过查看版本号，检查是否安装成功</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># protoc 是 Protobuf 的编译器，其主要功能是用于编译 .proto 文件</span>protoc <span class="token parameter variable">--version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>如果出现 <code>protoc: error while loading shared libraries: libprotobuf.so.15: cannot open shared object file: No such file or directory</code> 那么则需要在命令行中执行 <code>ldconfig</code> 命令后，再次运行即可成功。</p></blockquote><h2 id="安装-protoc-插件"><a href="#安装-protoc-插件" class="headerlink" title="安装 protoc 插件"></a>安装 protoc 插件</h2><blockquote><p>仅安装 protoc 编译器是不够的，针对不同的语言，还需要安装运行时的 protoc 插件，而对应 Go 语言的是 protoc-gen-go 插件。</p></blockquote><p>可以执行以下命令进行安装，但是<strong>不推荐</strong>，因为 protoc-gen-go 是需要与 proto 软件包版本相匹配的，必须要锁定版本号</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装的二进制文件在 `$GOPATH/bin` 目录下</span><span class="token comment"># 安装 protobuf 3.17.0 版本之后直接执行 go get -u github.com/golang/protobuf/protoc-gen-go 命令后，</span><span class="token comment"># 貌似安装的 protoc-gen-go 版本是 v1.27.1，但是指定 protoc-gen-go@v1.27.1 貌似又找不到 v1.27.1 的版本，不知为何，暂且记录下。</span><span class="token comment"># 在项目根目录下执行</span>go get <span class="token parameter variable">-u</span> github.com/golang/protobuf/protoc-gen-go@v1.3.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>推荐的安装方式如下：</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">GIT_TAG</span><span class="token operator">=</span><span class="token string">"v1.3.3"</span>go get <span class="token parameter variable">-d</span> <span class="token parameter variable">-u</span> github.com/golang/protobuf/protoc-gen-go<span class="token function">git</span> <span class="token parameter variable">-C</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>go <span class="token function">env</span> GOPATH<span class="token variable">)</span></span>"</span>/src/github.com/golang/protobuf checkout <span class="token variable">$GIT_TAG</span>go <span class="token function">install</span> github.com/golang/protobuf/protoc-gen-go<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后还可以将其移动到 bin 目录下</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mv</span> <span class="token variable">$GOPATH</span>/bin/protoc-gen-go /usr/local/go/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="安装-grpc-go-库"><a href="#安装-grpc-go-库" class="headerlink" title="安装 grpc-go 库"></a>安装 grpc-go 库</h2><p>grpc-go 包含了 Go 的 grpc 库，我们可以使用如下方式安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get <span class="token parameter variable">-u</span> google.golang.org/grpc@v1.29.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果使用以上方式安装，发现无法安装（可能会被墙掉了），我们可以使用如下方式手动安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/grpc/grpc-go.git <span class="token variable">$GOPATH</span>/src/google.golang.org/grpc<span class="token function">git</span> clone https://github.com/golang/net.git <span class="token variable">$GOPATH</span>/src/golang.org/x/net<span class="token function">git</span> clone https://github.com/golang/text.git <span class="token variable">$GOPATH</span>/src/golang.org/x/text<span class="token function">git</span> clone https://github.com/google/go-genproto.git <span class="token variable">$GOPATH</span>/src/google.golang.org/genproto<span class="token builtin class-name">cd</span> <span class="token variable">$GOPATH</span>/src/go <span class="token function">install</span> google.golang.org/grpc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="生成-proto-文件（生成接口库）"><a href="#生成-proto-文件（生成接口库）" class="headerlink" title="生成 proto 文件（生成接口库）"></a>生成 proto 文件（生成接口库）</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 加载 protoc-gen-go 插件 生成 grpc 的 go 服务端/客户端</span><span class="token comment"># 注意：必须要先安装好 protoc-gen-go 插件</span><span class="token comment"># 这里将 .proto 文件写到 proto 目录，执行此命令后将会把对应的 .pb.go 文件也会生成到 proto 目录</span>protoc <span class="token parameter variable">--go_out</span><span class="token operator">=</span>plugins<span class="token operator">=</span>grpc:. ./proto/*.proto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>-I</code> 参数：格式为 <code>-IPATH</code> 作用是指定 import 搜索的目录（也就是 Proto 文件中的 import 命令），可指定多个，编译时按照顺序查找，如果不指定则默认当前工作目录，比如：<code>-I.</code> 、<code>-I/usr/local</code> 、<code>-I$GOPATH/src</code></li><li><code>M</code> 参数：指定导入的 <code>.proto</code> 文件路径编译后对应的 golang 包名（不指定默认以 .proto 文件中 import 语句路径），格式为：Mfoo/bar.proto=quux/shme，则在生成、编译 Proto 时将所指定的包名替换为所要求的名字（如：foo/bar.proto 编译后为包名为 quux/shme）</li><li><code>--go_out</code>：设置所生成的 Go 代码输出的目录。该指令会加载 protoc-gen-go 插件，以达到生成 Go 代码的目的。生成的文件以 .pb.go 为文件后缀，这里的 <code>:</code> （冒号）有分隔符的作用，后跟命令所需要的参数集，这意味着把生成的 Go 代码输出到指向的 protoc 编译的当前目录。</li><li><code>plugins=plugin1+plugin2</code>：指定要加载的子插件列表。我们定义的 proto 文件是涉及了 RPC 服务的，而默认是不会生成 RPC 代码的，因此需要在 go_out 中给出 plugins 参数，将其传递给 protoc-gen-go 插件，即告诉编译器，请支持 RPC。</li></ul>]]></content>
      
      
      <categories>
          
          <category> RPC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RPC </tag>
            
            <tag> GRPC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 合并多个 commit</title>
      <link href="posts/d05f7a67.html"/>
      <url>posts/d05f7a67.html</url>
      
        <content type="html"><![CDATA[<h1 id="Git-合并多个-commit"><a href="#Git-合并多个-commit" class="headerlink" title="Git 合并多个 commit"></a>Git 合并多个 commit</h1><h2 id="查看提交历史-git-log"><a href="#查看提交历史-git-log" class="headerlink" title="查看提交历史 git log"></a>查看提交历史 <code>git log</code></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 最近的第 1 条</span>commit ddc9e34424e8764357d086ad103219fa2c87e2dd<span class="token comment"># 最近的第 2 条</span>commit 3cccd5d8696b91163b47a8be045e8bbf9c443ddd<span class="token comment"># 最近的第 3 条</span>commit d70ae2c4c1c6d2edd16c6b11a8e334663a3dade5<span class="token comment"># 最近的第 4 条</span>commit fed4fe30dbc89ccc7ae72b917b2a600ecf249d4e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="git-rebase"><a href="#git-rebase" class="headerlink" title="git rebase"></a>git rebase</h2><p>如果想要合并最近的 1 到最近的第 3 条，有两个方法：</p><ol><li>从 <code>HEAD</code> 版本开始往过去数 3 个版本，比如：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> rebase <span class="token parameter variable">-i</span> HEAD~3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>指定要合并的版本之前的一个版本号，比如：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 比如我想要将最近的 1 条 commit 和最近的第 3 条 commit 进行合并，那么</span><span class="token comment"># 我这里是需要写最近第 4 条 commit 的 commit_id `fed4fe30db` </span><span class="token comment"># fed4fe30db 不参与合并</span><span class="token function">git</span> rebase <span class="token parameter variable">-i</span> fed4fe30db<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="选取要合并的提交"><a href="#选取要合并的提交" class="headerlink" title="选取要合并的提交"></a>选取要合并的提交</h2><ol><li>执行了 <code>git rebase</code> 命令之后，会弹出一个窗口，比如大致如下：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pick 3cccd5d 对词库加上读写锁pick ddc9e34 debug<span class="token comment"># Rebase d70ae2c..ddc9e34 onto d70ae2c (2 commands)</span><span class="token comment">#</span><span class="token comment"># Commands:</span><span class="token comment"># p, pick &lt;commit&gt; = use commit</span><span class="token comment"># r, reword &lt;commit&gt; = use commit, but edit the commit message</span><span class="token comment"># e, edit &lt;commit&gt; = use commit, but stop for amending</span><span class="token comment"># s, squash &lt;commit&gt; = use commit, but meld into previous commit</span><span class="token comment"># f, fixup &lt;commit&gt; = like "squash", but discard this commit's log message</span><span class="token comment"># x, exec &lt;command&gt; = run command (the rest of the line) using shell</span><span class="token comment"># b, break = stop here (continue rebase later with 'git rebase --continue')</span><span class="token comment"># d, drop &lt;commit&gt; = remove commit</span><span class="token comment"># l, label &lt;label&gt; = label current HEAD with a name</span><span class="token comment"># t, reset &lt;label&gt; = reset HEAD to a label</span><span class="token comment"># m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]</span><span class="token comment"># .       create a merge commit using the original merge commit's</span><span class="token comment"># .       message (or the oneline, if no original merge commit was</span><span class="token comment"># .       specified). Use -c &lt;commit&gt; to reword the commit message.</span><span class="token comment">#</span><span class="token comment"># These lines can be re-ordered; they are executed from top to bottom.</span><span class="token comment">#</span><span class="token comment"># If you remove a line here THAT COMMIT WILL BE LOST.</span><span class="token comment">#</span><span class="token comment"># However, if you remove everything, the rebase will be aborted.</span><span class="token comment">#</span><span class="token comment"># Note that empty commits are commented out</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>pick：正常选中</li><li>reword：选中，并且修改提交信息</li><li>edit：选中，rebase 时会暂停，允许你修改这个 commit</li><li>squash：选中，会将当前 commit 与上一个 commit 合并</li><li>fixup：与 squash 相同，但不会保存当前 commit 的提交信息</li><li>exec：执行其他 shell 命令</li></ul><ol start="2"><li>需要将 commit_id 前面的 <code>pick</code> 改为 <code>s</code> 或者 <code>squash</code> 之后保存并关闭文本编辑窗口，改完之后的内容如下：（这里仅仅展示了内容变动情况）</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pick 3cccd5d 对词库加上读写锁s ddc9e34 debug <span class="token comment"># 这一行做了改动</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>然后保存并退出，git 就会压缩提交历史，如果有冲突，则需要解决冲突，解决冲突的时候需要注意，保留最新的历史，不然我们的修改就丢弃了，修改之后要记得敲下面的命令</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span><span class="token comment"># 确认 rebase</span><span class="token function">git</span> rebase <span class="token parameter variable">--continue</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你想放弃这次压缩的话，那么可以执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 取消 rebase</span><span class="token function">git</span> rebase <span class="token parameter variable">--abort</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="4"><li>如果没有冲突，或者冲突已经解决，则会出现如下编辑窗口，比如：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pick 3cccd5d 对词库加上读写锁<span class="token comment"># This is a combination of 2 commits.</span><span class="token comment"># This is the 1st commit message:</span>对词库加上读写锁<span class="token comment"># This is the commit message #2:</span>debug<span class="token comment"># Please enter the commit message for your changes. Lines starting</span><span class="token comment"># with '#' will be ignored, and an empty message aborts the commit.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>输入 <code>:wq</code> 保存并退出，然后查看 <code>git log --oneline</code> 查看 <code>commit</code> 历史信息，你就会发现 commit 已经被合并了</li><li>强制推送到远程服务器 <code>git push -f</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 下解压缩文件</title>
      <link href="posts/1ee32f49.html"/>
      <url>posts/1ee32f49.html</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-下解压缩文件"><a href="#Linux-下解压缩文件" class="headerlink" title="Linux 下解压缩文件"></a>Linux 下解压缩文件</h1><p><strong>建议不要添加成 rar 的压缩文件，不然在服务器上面解压缩的时候很麻烦，可以直接添加成 zip 的压缩文件</strong></p><h2 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h2><p>优点：各系统平台都可以用，缺点：压缩率不是很高</p><p>zip 命令常用选项及含义</p><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>-r</td><td>递归压缩目录，及将制定目录下的所有文件以及子目录全部压缩。</td></tr><tr><td>-m</td><td>将文件压缩之后，删除原始文件，相当于把文件移到压缩文件中。</td></tr><tr><td>-v</td><td>显示详细的压缩过程信息。</td></tr><tr><td>-q</td><td>在压缩的时候不显示命令的执行过程。</td></tr><tr><td>-压缩级别</td><td>压缩级别是从 1~9 的数字，-1 代表压缩速度更快，-9 代表压缩效果更好。</td></tr><tr><td>-u</td><td>更新压缩文件，即往压缩文件中添加新文件。</td></tr></tbody></table><p>unzip 命令常用选项及含义</p><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>-d 目录名</td><td>将压缩文件解压到指定目录下。</td></tr><tr><td>-n</td><td>解压时并不覆盖已经存在的文件。</td></tr><tr><td>-o</td><td>解压时覆盖已经存在的文件，并且无需用户确认。</td></tr><tr><td>-v</td><td>查看压缩文件的详细信息，包括压缩文件中包含的文件大小、文件名以及压缩比等，但并不做解压操作。</td></tr><tr><td>-t</td><td>测试压缩文件有无损坏，但并不解压。</td></tr><tr><td>-x 文件列表</td><td>解压文件，但不包含文件列表中指定的文件。</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 压缩 tt 目录为 zip 格式</span><span class="token function">zip</span> <span class="token parameter variable">-r</span> tt.zip tt<span class="token comment"># 解压缩</span><span class="token function">unzip</span> tt.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h2><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-c</td><td>创建压缩文件</td></tr><tr><td>-x</td><td>解开压缩文件</td></tr><tr><td>-t</td><td>查看压缩包内有哪些文件</td></tr><tr><td>-z</td><td>用Gzip压缩或解压</td></tr><tr><td>-j</td><td>用bzip2压缩或解压</td></tr><tr><td>-v</td><td>显示压缩或解压的过程</td></tr><tr><td>-f</td><td>目标文件名</td></tr><tr><td>-p</td><td>保留原始的权限与属性</td></tr><tr><td>-P</td><td>使用绝对路径来压缩</td></tr><tr><td>-C</td><td>指定解压到的目录</td></tr></tbody></table><p>优点：CPU 消耗少，缺点：仅仅是打包工具，不负责压缩</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 压缩 tt 目录为 tar 格式</span><span class="token function">tar</span> <span class="token parameter variable">-cvf</span> tt.tar tt<span class="token comment"># 解压缩</span><span class="token function">tar</span> <span class="token parameter variable">-xvf</span> tt.tar <span class="token parameter variable">-C</span> /home/alex/tt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="tar-gz"><a href="#tar-gz" class="headerlink" title="tar.gz"></a>tar.gz</h2><p>优点：CPU 占用少，压缩率很理想</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 压缩 tt 目录为 tar.gz 格式</span><span class="token function">tar</span> <span class="token parameter variable">-czvf</span> tt.tar.gz tt<span class="token comment"># 解压缩</span><span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> tt.tar.gz<span class="token comment"># 解压缩到指定目录 /home/alex 目录下</span><span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> tt.tar.gz <span class="token parameter variable">-C</span> /home/alex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="tar-bz2"><a href="#tar-bz2" class="headerlink" title="tar.bz2"></a>tar.bz2</h2><p>优点：所有方式中压缩率最好，缺点：更加占用 CPU 和时间</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 压缩 tt 目录为 tar.bz2 格式</span><span class="token function">tar</span> <span class="token parameter variable">-cjvf</span> tt.tar.bz2 tt<span class="token comment"># 解压缩</span><span class="token function">tar</span> <span class="token parameter variable">-xjvf</span> tt.tar.bz2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> tar </tag>
            
            <tag> zip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 systemd 管理服务</title>
      <link href="posts/9a5708c9.html"/>
      <url>posts/9a5708c9.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用-systemd-管理服务"><a href="#使用-systemd-管理服务" class="headerlink" title="使用 systemd 管理服务"></a>使用 systemd 管理服务</h1><h2 id="编写-Service-脚本"><a href="#编写-Service-脚本" class="headerlink" title="编写 Service 脚本"></a>编写 Service 脚本</h2><p>Systemd 的 Service 配置在 <code>/etc/systemd/system/</code> 目录中，可以创建一个 <code>echo.service</code> 文件，实际项目应当改为对应的名称。编辑此文件，添加下列内容：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span><span class="token assign-left variable">Description</span><span class="token operator">=</span>Echo Http Server<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target<span class="token assign-left variable">After</span><span class="token operator">=</span>syslog.target<span class="token punctuation">[</span>Service<span class="token punctuation">]</span><span class="token assign-left variable">Type</span><span class="token operator">=</span>simple<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/php /opt/servers/echo/server.php<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-USR1</span> <span class="token variable">$MAINPID</span><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always<span class="token punctuation">[</span>Install<span class="token punctuation">]</span><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target graphical.target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>After 指令约定了启动的顺序，必须在 network 和 syslog 启动后才启动 echo 服务</li><li>Service 中填写了应用程序的路径信息，请修改为实际项目对应的路径</li><li>Restart=always 表示如果进程挂掉会自动拉起</li><li>WantedBy 约定了在哪些环境下启动，multi-user.target graphical.target 表示在图形界面和命令行环境都会启动</li></ul><p>编写完成后需要 reload 守护进程使其生效</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token parameter variable">--system</span> daemon-reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="管理服务"><a href="#管理服务" class="headerlink" title="管理服务"></a>管理服务</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动服务</span><span class="token function">sudo</span> systemctl start echo.service<span class="token comment"># reload 服务</span><span class="token function">sudo</span> systemctl reload echo.service<span class="token comment"># 关闭服务</span><span class="token function">sudo</span> systemctl stop echo.service<span class="token comment"># 查看服务状态</span><span class="token function">sudo</span> systemctl status echo.service<span class="token comment"># 查看所有的启动项</span><span class="token function">sudo</span> systemctl list-unit-files<span class="token comment"># 禁用开机启动</span><span class="token function">sudo</span> systemctl disable echo.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> systemd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何基于 PHP 搭建 GRPC 服务</title>
      <link href="posts/e4a23e35.html"/>
      <url>posts/e4a23e35.html</url>
      
        <content type="html"><![CDATA[<h1 id="PHP7-4-搭建-GRPC-客户端服务"><a href="#PHP7-4-搭建-GRPC-客户端服务" class="headerlink" title="PHP7.4 搭建 GRPC 客户端服务"></a>PHP7.4 搭建 GRPC 客户端服务</h1><blockquote><p>本地系统：MacBook M1 arm64<br>为了下载软件方便，统一采用 Homebrew 安装软件<br><strong>php 目前只能搭建 gRPC 客户端</strong>，详见 <a href="https://grpc.io/docs/languages/php/quickstart/">gRPC官方文档</a>，<br>不过你要是想使用 php 搭建 grpc 客户端和服务端，你可以使用 php 基于 swoole 的 <a href="https://hyperf.io/">hyperf框架</a><br>如果你想使用 hyperf 搭建 grpc 客户端和服务端，你可以参考我的另一个 demo 项目 <a href="https://github.com/pudongping/hyperf-grpc-demo">hyperf-grpc-demo</a><br>本文示例代码 <a href="https://github.com/pudongping/php-grpc-demo">php-grpc-demo</a></p></blockquote><h2 id="M1-下安装-php7-4-开发环境"><a href="#M1-下安装-php7-4-开发环境" class="headerlink" title="M1 下安装 php7.4 开发环境"></a>M1 下安装 php7.4 开发环境</h2><h3 id="下载-php"><a href="#下载-php" class="headerlink" title="下载 php"></a>下载 php</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用 homebrew 搜索 php</span>brew search php<span class="token comment"># 使用 homebrew 安装 php7.4</span>brew <span class="token function">install</span> php@7.4<span class="token comment"># 安装之后的 php7.4 在 /opt/homebrew/etc/php/7.4/ 目录下</span><span class="token comment"># 因为 mac 下默认已经安装了 php7.3 ，如果你想首先使用 php7.4 版本时，需要执行</span><span class="token builtin class-name">echo</span> <span class="token string">'export PATH="/opt/homebrew/opt/php@7.4/bin:$PATH"'</span> <span class="token operator">&gt;&gt;</span> ~/.zshrc<span class="token builtin class-name">echo</span> <span class="token string">'export PATH="/opt/homebrew/opt/php@7.4/sbin:$PATH"'</span> <span class="token operator">&gt;&gt;</span> ~/.zshrc  <span class="token comment"># 如果想要让编译器找到 php7.4 那么还需要设置</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">LDFLAGS</span><span class="token operator">=</span><span class="token string">"-L/opt/homebrew/opt/php@7.4/lib"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CPPFLAGS</span><span class="token operator">=</span><span class="token string">"-I/opt/homebrew/opt/php@7.4/include"</span><span class="token comment"># 写入 .zshrc 文件之后，需要执行 source 命令，重新加载配置信息</span><span class="token builtin class-name">source</span> ~/.zshrc<span class="token comment"># 可以使用 homebrew 来管理 php7.4 的服务状态，比如重启</span>brew services restart php@7.4<span class="token comment"># 如果不需要守护进程运行 php7.4 时，可以执行</span>/opt/homebrew/opt/php@7.4/sbin/php-fpm <span class="token parameter variable">--nodaemonize</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装-composer"><a href="#安装-composer" class="headerlink" title="安装 composer"></a>安装 composer</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> <span class="token function">composer</span><span class="token comment"># 查看 composer 是否安装成功</span><span class="token function">composer</span> <span class="token parameter variable">-V</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装-GRPC-扩展"><a href="#安装-GRPC-扩展" class="headerlink" title="安装 GRPC 扩展"></a>安装 GRPC 扩展</h2><ul><li>安装 grpc 扩展</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pecl <span class="token function">install</span> grpc<span class="token comment"># 查看 grpc 扩展是否安装成功</span>php <span class="token parameter variable">-m</span> <span class="token operator">|</span> <span class="token function">grep</span> grpc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装 protobuf 扩展</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pecl <span class="token function">install</span> protobuf<span class="token comment"># 查看 protobuf 扩展是否安装成功</span>php <span class="token parameter variable">-m</span> <span class="token operator">|</span> <span class="token function">grep</span> protobuf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果提示报错，报错信息如下所示</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/opt/homebrew/Cellar/php@7.4/7.4.25/include/php/ext/pcre/php_pcre.h:25:10: fatal error: <span class="token string">'pcre2.h'</span> <span class="token function">file</span> not found<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以参考这条 <a href="https://github.com/swoole/swoole-src/issues/3926">issue</a> 去解决</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 我这里使用的是 php7.4 版本</span><span class="token comment"># pcre2 版本是 10.39</span><span class="token comment"># 因此我这里需要执行如下命令即可，需要注意我这里使用的是 m1 ，intel 芯片的 Mac homebrew 安装 php 的路径和 m1 芯片的路径不一致，需要按照你自己的实际路径去建立软连接</span><span class="token function">ln</span> <span class="token parameter variable">-s</span> /opt/homebrew/Cellar/pcre2/10.39/include/pcre2.h /opt/homebrew/Cellar/php@7.4/7.4.25/include/php/ext/pcre/pcre2.h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="生成-php-plugins-插件"><a href="#生成-php-plugins-插件" class="headerlink" title="生成 php-plugins 插件"></a>生成 php-plugins 插件</h2><blockquote><p>这里因为 grpc/grpc 这个包非常大，有可能下载会不成功，因此我已经将编译好的 <code>grpc_php_plugin</code> 二进制文件以及 <code>protoc</code> 二进制文件上传到了 <code>tools</code> 目录下<br>方便各位同学可以直接使用</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone <span class="token parameter variable">-b</span> v1.27.x https://github.com/grpc/grpc.git<span class="token comment"># 如果速度慢的话，可以考虑 gitee 提供的镜像</span><span class="token function">git</span> clone <span class="token parameter variable">-b</span> v1.27.x https://gitee.com/mirrors/grpc.git<span class="token comment"># 安装 grpc 在 github 上的其他依赖</span><span class="token function">git</span> submodule update <span class="token parameter variable">--init</span><span class="token comment"># 编译生成 grpc php 插件，生成 proto 文件时需要用到</span><span class="token comment"># 执行成功之后会提示</span><span class="token comment"># 比如我的生成之后提示了：[HOSTLD]  Linking /Users/pudongping/php-tools/grpc/bins/opt/grpc_php_plugin</span><span class="token comment"># 这里我们只编译了 php 的插件，如果你需要编译所有的插件，你需要执行 `make &amp;&amp; make install`</span><span class="token function">make</span> grpc_php_plugin<span class="token comment"># 生成的 grpc_php_plugin 插件在 `bins/opt/` 目录下</span><span class="token comment"># 并且还会自动生成 protoc 文件，在 `bins/opt/protobuf` 目录下</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行 <code>make grpc_php_plugin</code> 时， 如果提示错误如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>AUTOGEN<span class="token punctuation">]</span> Preparing protobufCan't <span class="token builtin class-name">exec</span> <span class="token string">"aclocal"</span><span class="token builtin class-name">:</span> No such <span class="token function">file</span> or directory at /opt/homebrew/Cellar/autoconf/2.71/share/autoconf/Autom4te/FileUtils.pm line <span class="token number">274</span>.autoreconf: error: aclocal failed with <span class="token builtin class-name">exit</span> status: <span class="token number">2</span>make: *** <span class="token punctuation">[</span>third_party/protobuf/configure<span class="token punctuation">]</span> Error <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>那么需要安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> automake<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h2><ul><li>项目初始化</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 先使用 composer 初始化项目</span><span class="token function">composer</span> init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>安装 grpc composer 扩展包</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> require grpc/grpc<span class="token function">composer</span> require google/protobuf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>使用 proto 文件生成 php 代码</li></ul><blockquote><p>以下命令在项目根目录下执行</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 当然你也可以将 protoc 二进制文件和 grpc_php_plugin 二进制文件移动到 `/usr/local/bin` 目录下，这样就不需要像我这样写绝对路径了</span><span class="token comment"># 不会有 client stub 类</span>/Users/pudongping/php-tools/grpc/bins/opt/protobuf/protoc <span class="token parameter variable">--php_out</span><span class="token operator">=</span>plugins<span class="token operator">=</span>grpc:./grpc ./proto/meet.proto<span class="token comment"># 会有 client stub 类，我这里需要生成 client stub 类</span>/Users/pudongping/php-tools/grpc/bins/opt/protobuf/protoc <span class="token parameter variable">--php_out</span><span class="token operator">=</span>./grpc <span class="token parameter variable">--grpc_out</span><span class="token operator">=</span>./grpc <span class="token parameter variable">--plugin</span><span class="token operator">=</span>protoc-gen-grpc<span class="token operator">=</span>/Users/pudongping/php-tools/grpc/bins/opt/grpc_php_plugin ./proto/meet.proto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>如果你想运行我的这个 demo ，你需要先下载 composer 依赖</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在项目根目录下执行</span><span class="token function">composer</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>你需要先启动服务端</p><blockquote><p><a href="https://github.com/pudongping/go-micro-demo">服务端代码</a></p></blockquote><p>然后再启动 php 客户端</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php index.php<span class="token comment"># string(14) " 你好，Alex"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> RPC </tag>
            
            <tag> GRPC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在 redis 中通过 redis-cli 调试 lua 脚本</title>
      <link href="posts/81563347.html"/>
      <url>posts/81563347.html</url>
      
        <content type="html"><![CDATA[<h1 id="在-redis-中通过-redis-cli-调试-lua-脚本"><a href="#在-redis-中通过-redis-cli-调试-lua-脚本" class="headerlink" title="在 redis 中通过 redis-cli 调试 lua 脚本"></a>在 redis 中通过 redis-cli 调试 lua 脚本</h1><h2 id="假设我有如下一段-lua-脚本"><a href="#假设我有如下一段-lua-脚本" class="headerlink" title="假设我有如下一段 lua 脚本"></a>假设我有如下一段 lua 脚本</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$redis</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$redis</span><span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.10.194'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$lua</span> <span class="token operator">=</span> <span class="token string heredoc-string"><span class="token delimiter symbol"><span class="token punctuation">&lt;&lt;&lt;</span>EOF</span>local k1 = KEYS[1]local k2 = KEYS[2]local v1 = redis.call('get', k1)local v2 = redis.call('get', k2)if v1 and v2 then    local v1ttl = redis.call('ttl', k1)    local v2ttl = redis.call('ttl', k2)    return {true, k1, v1, k2, v2, v1ttl, v2ttl, v1..v2}else    local now = tonumber(ARGV[1])    redis.call('hsetnx', 'hash_table', k1, now)    redis.call('hsetnx', 'hash_table', k2, now)    local hash_all = redis.call('hgetall', 'hash_table')    return {false, hash_all}end<span class="token delimiter symbol">EOF<span class="token punctuation">;</span></span></span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$redis</span><span class="token operator">-&gt;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$lua</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'age'</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="第一种调试方式：使用-–eval-选项直接调试"><a href="#第一种调试方式：使用-–eval-选项直接调试" class="headerlink" title="第一种调试方式：使用 –eval 选项直接调试"></a>第一种调试方式：使用 –eval 选项直接调试</h2><p>先创建一个 <code>.lua</code> 脚本</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@a72e6809fb18:/tmp<span class="token comment"># cat &gt; test.lua &lt;&lt;EOF</span> <span class="token builtin class-name">local</span> k1 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token builtin class-name">local</span> k2 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token builtin class-name">local</span> v1 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k1<span class="token punctuation">)</span> <span class="token builtin class-name">local</span> v2 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k2<span class="token punctuation">)</span> <span class="token keyword">if</span> v1 and v2 <span class="token keyword">then</span>     <span class="token builtin class-name">local</span> v1ttl <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'ttl'</span>, k1<span class="token punctuation">)</span>     <span class="token builtin class-name">local</span> v2ttl <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'ttl'</span>, k2<span class="token punctuation">)</span>     <span class="token builtin class-name">return</span> <span class="token punctuation">{</span>true, k1, v1, k2, v2, v1ttl, v2ttl, v1<span class="token punctuation">..</span>v2<span class="token punctuation">}</span> <span class="token keyword">else</span>     <span class="token builtin class-name">local</span> now <span class="token operator">=</span> tonumber<span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     redis.call<span class="token punctuation">(</span><span class="token string">'hsetnx'</span>, <span class="token string">'hash_table'</span>, k1, now<span class="token punctuation">)</span>     redis.call<span class="token punctuation">(</span><span class="token string">'hsetnx'</span>, <span class="token string">'hash_table'</span>, k2, now<span class="token punctuation">)</span>     <span class="token builtin class-name">local</span> hash_all <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'hgetall'</span>, <span class="token string">'hash_table'</span><span class="token punctuation">)</span>     <span class="token builtin class-name">return</span> <span class="token punctuation">{</span>false, hash_all<span class="token punctuation">}</span> end EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果 k1 和 k2 有值时</p><p><strong>注意：参数和值之间有一个英文逗号，并且英文逗号左右均有一个空格！</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@a72e6809fb18:/tmp<span class="token comment"># redis-cli --eval test.lua name age , 12345</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"name"</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"alex"</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"age"</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"18"</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token parameter variable">-1</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">70535</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"alex18"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果 k1 和 k2 不存在时</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@a72e6809fb18:/tmp<span class="token comment"># redis-cli --eval test.lua name1 age1 , 12345</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"name1"</span>   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"1682404163"</span>   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"age1"</span>   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"1682404163"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="通过增加-ldb-选项启用-Lua-调试器来调试"><a href="#通过增加-ldb-选项启用-Lua-调试器来调试" class="headerlink" title="通过增加 --ldb 选项启用 Lua 调试器来调试"></a>通过增加 <code>--ldb</code> 选项启用 Lua 调试器来调试</h3><blockquote><p>注意：使用 <code>--ldb</code> 选项后，执行到最后一步，数据会自动回滚，也就是不会被持久化到 redis 中。你可以观察到，执行到命令最后会有一行 <code>(Lua debugging session ended -- dataset changes rolled back)</code> 提示信息。</p></blockquote><p>使用 Redis 内置的 Lua 调试器来调试 Lua 脚本，可以查看变量和命令的结果输出。通过 <code>--ldb</code> 选项来启动一个调试会话，可以使用以下命令来控制调试过程：</p><ul><li>step: 执行当前行，并停在下一行。</li><li>continue: 继续执行直到遇到下一个断点或者脚本结束。</li><li>list: 显示当前行周围的源代码。</li><li>break: 设置或删除一个断点。你可以指定一个行号或者不指定任何参数来删除所有断点。</li><li>watch: 查看一个变量的值。你可以指定一个变量名或者不指定任何参数来查看所有变量。</li><li>trace: 查看脚本执行过程中调用的 Redis 命令。</li><li>quit: 退出调试会话。</li></ul><p>执行效果如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@a72e6809fb18:/tmp<span class="token comment"># redis-cli --ldb --eval test.lua name1 age1 , 12345</span>Lua debugging session started, please use:quit    -- End the session.restart -- Restart the script <span class="token keyword">in</span> debug mode again.<span class="token builtin class-name">help</span>    -- Show Lua script debugging commands.* Stopped at <span class="token number">1</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">1</span>   <span class="token builtin class-name">local</span> k1 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">2</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">2</span>   <span class="token builtin class-name">local</span> k2 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">4</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">4</span>   <span class="token builtin class-name">local</span> v1 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> restartLua debugging session started, please use:quit    -- End the session.restart -- Restart the script <span class="token keyword">in</span> debug mode again.<span class="token builtin class-name">help</span>    -- Show Lua script debugging commands.* Stopped at <span class="token number">1</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">1</span>   <span class="token builtin class-name">local</span> k1 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">2</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">2</span>   <span class="token builtin class-name">local</span> k2 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">4</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">4</span>   <span class="token builtin class-name">local</span> v1 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> get name1<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> NULL* Stopped at <span class="token number">5</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">5</span>   <span class="token builtin class-name">local</span> v2 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k2<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> get age1<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> NULL* Stopped at <span class="token number">7</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">7</span>   <span class="token keyword">if</span> v1 and v2 <span class="token keyword">then</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">12</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">12</span>      <span class="token builtin class-name">local</span> now <span class="token operator">=</span> tonumber<span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> <span class="token builtin class-name">continue</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"name1"</span>   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"1682404163"</span>   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"age1"</span>   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"1682404163"</span><span class="token punctuation">(</span>Lua debugging session ended -- dataset changes rolled back<span class="token punctuation">)</span><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="再进一步，通过使用-redis-debug-函数打印调试信息"><a href="#再进一步，通过使用-redis-debug-函数打印调试信息" class="headerlink" title="再进一步，通过使用 redis.debug() 函数打印调试信息"></a>再进一步，通过使用 <code>redis.debug()</code> 函数打印调试信息</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@a72e6809fb18:/tmp<span class="token comment"># cat &gt; redis_debug.lua &lt;&lt;EOF</span> <span class="token builtin class-name">local</span> k1 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> redis.debug<span class="token punctuation">(</span><span class="token string">'k1 =&gt; '</span>, k1<span class="token punctuation">)</span> <span class="token builtin class-name">local</span> k2 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> redis.debug<span class="token punctuation">(</span><span class="token string">'k2 =&gt; '</span>, k1<span class="token punctuation">)</span> <span class="token builtin class-name">local</span> v1 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k1<span class="token punctuation">)</span> redis.debug<span class="token punctuation">(</span><span class="token string">'v1 =&gt; '</span>, type<span class="token punctuation">(</span>v1<span class="token punctuation">))</span> <span class="token builtin class-name">local</span> v2 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k2<span class="token punctuation">)</span> redis.debug<span class="token punctuation">(</span><span class="token string">'v2 =&gt; '</span>, type<span class="token punctuation">(</span>v2<span class="token punctuation">))</span> <span class="token keyword">if</span> v1 and v2 <span class="token keyword">then</span>      <span class="token builtin class-name">local</span> v1_ttl <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'ttl'</span>, k1<span class="token punctuation">)</span>     <span class="token builtin class-name">local</span> v2_ttl <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'ttl'</span>, k2<span class="token punctuation">)</span>     redis.debug<span class="token punctuation">(</span><span class="token string">'k1 =&gt; '</span>, v1, type<span class="token punctuation">(</span>v1_ttl<span class="token punctuation">))</span>     redis.debug<span class="token punctuation">(</span><span class="token string">'k2 =&gt; '</span>, v2, type<span class="token punctuation">(</span>v2_ttl<span class="token punctuation">))</span>     <span class="token builtin class-name">return</span> <span class="token punctuation">{</span>true, k1, v1, k2, v2, v1_ttl, v2_ttl, v1<span class="token punctuation">..</span>v2<span class="token punctuation">}</span> <span class="token keyword">else</span>     redis.debug<span class="token punctuation">(</span><span class="token string">'both v1 and v2 of not exists'</span>, v1, v2<span class="token punctuation">)</span>     <span class="token builtin class-name">local</span> now <span class="token operator">=</span> tonumber<span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     redis.call<span class="token punctuation">(</span><span class="token string">'hsetnx'</span>, <span class="token string">'hash_table'</span>, k1, now<span class="token punctuation">)</span>     redis.call<span class="token punctuation">(</span><span class="token string">'hsetnx'</span>, <span class="token string">'hash_table'</span>, k2, now<span class="token punctuation">)</span>     <span class="token builtin class-name">local</span> hash_all <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'hgetall'</span>, <span class="token string">'hash_table'</span><span class="token punctuation">)</span>     redis.debug<span class="token punctuation">(</span><span class="token string">'reset the value is ==&gt; '</span>, hash_all, <span class="token string">'hasl_all type is ==&gt; '</span>, type<span class="token punctuation">(</span>hash_all<span class="token punctuation">))</span>     <span class="token builtin class-name">return</span> <span class="token punctuation">{</span>false, hash_all<span class="token punctuation">}</span> end EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调试</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@a72e6809fb18:/tmp<span class="token comment"># redis-cli --ldb --eval redis_debug.lua name age , 12345</span>Lua debugging session started, please use:quit    -- End the session.restart -- Restart the script <span class="token keyword">in</span> debug mode again.<span class="token builtin class-name">help</span>    -- Show Lua script debugging commands.* Stopped at <span class="token number">1</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">1</span>   <span class="token builtin class-name">local</span> k1 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">2</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">2</span>   redis.debug<span class="token punctuation">(</span><span class="token string">'k1 =&gt; '</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">2</span>: <span class="token string">"k1 =&gt; "</span>, <span class="token string">"name"</span>* Stopped at <span class="token number">4</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">4</span>   <span class="token builtin class-name">local</span> k2 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">5</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">5</span>   redis.debug<span class="token punctuation">(</span><span class="token string">'k2 =&gt; '</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">5</span>: <span class="token string">"k2 =&gt; "</span>, <span class="token string">"name"</span>* Stopped at <span class="token number">7</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">7</span>   <span class="token builtin class-name">local</span> v1 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> get name<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> <span class="token string">"alex"</span>* Stopped at <span class="token number">8</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">8</span>   redis.debug<span class="token punctuation">(</span><span class="token string">'v1 =&gt; '</span>, type<span class="token punctuation">(</span>v1<span class="token punctuation">))</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">8</span>: <span class="token string">"v1 =&gt; "</span>, <span class="token string">"string"</span>* Stopped at <span class="token number">10</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">10</span>  <span class="token builtin class-name">local</span> v2 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k2<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> get age<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> <span class="token string">"18"</span>* Stopped at <span class="token number">11</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">11</span>  redis.debug<span class="token punctuation">(</span><span class="token string">'v2 =&gt; '</span>, type<span class="token punctuation">(</span>v2<span class="token punctuation">))</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">11</span>: <span class="token string">"v2 =&gt; "</span>, <span class="token string">"string"</span>* Stopped at <span class="token number">13</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">13</span>  <span class="token keyword">if</span> v1 and v2 <span class="token keyword">then</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">14</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">14</span>      <span class="token builtin class-name">local</span> v1_ttl <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'ttl'</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> ttl name<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> <span class="token parameter variable">-1</span>* Stopped at <span class="token number">15</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">15</span>      <span class="token builtin class-name">local</span> v2_ttl <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'ttl'</span>, k2<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> ttl age<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> <span class="token number">68213</span>* Stopped at <span class="token number">16</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">16</span>      redis.debug<span class="token punctuation">(</span><span class="token string">'k1 =&gt; '</span>, v1, type<span class="token punctuation">(</span>v1_ttl<span class="token punctuation">))</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">16</span>: <span class="token string">"k1 =&gt; "</span>, <span class="token string">"alex"</span>, <span class="token string">"number"</span>* Stopped at <span class="token number">17</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">17</span>      redis.debug<span class="token punctuation">(</span><span class="token string">'k2 =&gt; '</span>, v2, type<span class="token punctuation">(</span>v2_ttl<span class="token punctuation">))</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">17</span>: <span class="token string">"k2 =&gt; "</span>, <span class="token string">"18"</span>, <span class="token string">"number"</span>* Stopped at <span class="token number">18</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">18</span>      <span class="token builtin class-name">return</span> <span class="token punctuation">{</span>true, k1, v1, k2, v2, v1_ttl, v2_ttl, v1<span class="token punctuation">..</span>v2<span class="token punctuation">}</span>lua debugger<span class="token operator">&gt;</span> step<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"name"</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"alex"</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"age"</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"18"</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token parameter variable">-1</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">68213</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"alex18"</span><span class="token punctuation">(</span>Lua debugging session ended -- dataset changes rolled back<span class="token punctuation">)</span><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@a72e6809fb18:/tmp<span class="token comment"># redis-cli --ldb --eval redis_debug.lua name2 age2 , 55333</span>Lua debugging session started, please use:quit    -- End the session.restart -- Restart the script <span class="token keyword">in</span> debug mode again.<span class="token builtin class-name">help</span>    -- Show Lua script debugging commands.* Stopped at <span class="token number">1</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">1</span>   <span class="token builtin class-name">local</span> k1 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">2</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">2</span>   redis.debug<span class="token punctuation">(</span><span class="token string">'k1 =&gt; '</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">2</span>: <span class="token string">"k1 =&gt; "</span>, <span class="token string">"name2"</span>* Stopped at <span class="token number">4</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">4</span>   <span class="token builtin class-name">local</span> k2 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">5</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">5</span>   redis.debug<span class="token punctuation">(</span><span class="token string">'k2 =&gt; '</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">5</span>: <span class="token string">"k2 =&gt; "</span>, <span class="token string">"name2"</span>* Stopped at <span class="token number">7</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">7</span>   <span class="token builtin class-name">local</span> v1 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k1<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> get name2<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> NULL* Stopped at <span class="token number">8</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">8</span>   redis.debug<span class="token punctuation">(</span><span class="token string">'v1 =&gt; '</span>, type<span class="token punctuation">(</span>v1<span class="token punctuation">))</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">8</span>: <span class="token string">"v1 =&gt; "</span>, <span class="token string">"boolean"</span>* Stopped at <span class="token number">10</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">10</span>  <span class="token builtin class-name">local</span> v2 <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'get'</span>, k2<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> get age2<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> NULL* Stopped at <span class="token number">11</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">11</span>  redis.debug<span class="token punctuation">(</span><span class="token string">'v2 =&gt; '</span>, type<span class="token punctuation">(</span>v2<span class="token punctuation">))</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">11</span>: <span class="token string">"v2 =&gt; "</span>, <span class="token string">"boolean"</span>* Stopped at <span class="token number">13</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">13</span>  <span class="token keyword">if</span> v1 and v2 <span class="token keyword">then</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">20</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">20</span>      redis.debug<span class="token punctuation">(</span><span class="token string">'both v1 and v2 of not exists'</span>, v1, v2<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">20</span>: <span class="token string">"both v1 and v2 of not exists"</span>, false, <span class="token boolean">false</span>* Stopped at <span class="token number">21</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">21</span>      <span class="token builtin class-name">local</span> now <span class="token operator">=</span> tonumber<span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step* Stopped at <span class="token number">22</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">22</span>      redis.call<span class="token punctuation">(</span><span class="token string">'hsetnx'</span>, <span class="token string">'hash_table'</span>, k1, now<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> hsetnx hash_table name2 <span class="token number">55333</span><span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> <span class="token number">1</span>* Stopped at <span class="token number">23</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">23</span>      redis.call<span class="token punctuation">(</span><span class="token string">'hsetnx'</span>, <span class="token string">'hash_table'</span>, k2, now<span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> hsetnx hash_table age2 <span class="token number">55333</span><span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> <span class="token number">1</span>* Stopped at <span class="token number">24</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">24</span>      <span class="token builtin class-name">local</span> hash_all <span class="token operator">=</span> redis.call<span class="token punctuation">(</span><span class="token string">'hgetall'</span>, <span class="token string">'hash_table'</span><span class="token punctuation">)</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>redis<span class="token operator">&gt;</span> hgetall hash_table<span class="token operator">&lt;</span>reply<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">"name1"</span>,<span class="token string">"1682404163"</span>,<span class="token string">"age1"</span>,<span class="token string">"1682404163"</span>,<span class="token string">"name2"</span>,<span class="token string">"55333"</span>,<span class="token string">"age2"</span>,<span class="token string">"55333"</span><span class="token punctuation">]</span>* Stopped at <span class="token number">25</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">25</span>      redis.debug<span class="token punctuation">(</span><span class="token string">'reset the value is ==&gt; '</span>, hash_all, <span class="token string">'hasl_all type is ==&gt; '</span>, type<span class="token punctuation">(</span>hash_all<span class="token punctuation">))</span>lua debugger<span class="token operator">&gt;</span> step<span class="token operator">&lt;</span>debug<span class="token operator">&gt;</span> line <span class="token number">25</span>: <span class="token string">"reset the value is ==&gt; "</span>, <span class="token punctuation">{</span><span class="token string">"name1"</span><span class="token punctuation">;</span> <span class="token string">"1682404163"</span><span class="token punctuation">;</span> <span class="token string">"age1"</span><span class="token punctuation">;</span> <span class="token string">"1682404163"</span><span class="token punctuation">;</span> <span class="token string">"name2"</span><span class="token punctuation">;</span> <span class="token string">"55333"</span><span class="token punctuation">;</span> <span class="token string">"age2"</span><span class="token punctuation">;</span> <span class="token string">"55333"</span><span class="token punctuation">}</span>, <span class="token string">"hasl_all type is ==&gt; "</span>, <span class="token string">"table"</span>* Stopped at <span class="token number">26</span>, stop reason <span class="token operator">=</span> step over-<span class="token operator">&gt;</span> <span class="token number">26</span>      <span class="token builtin class-name">return</span> <span class="token punctuation">{</span>false, hash_all<span class="token punctuation">}</span>lua debugger<span class="token operator">&gt;</span> step<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"name1"</span>   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"1682404163"</span>   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"age1"</span>   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"1682404163"</span>   <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"name2"</span>   <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"55333"</span>   <span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"age2"</span>   <span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"55333"</span><span class="token punctuation">(</span>Lua debugging session ended -- dataset changes rolled back<span class="token punctuation">)</span><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="第二种调试方式：使用-eval-redis-命令进行调试"><a href="#第二种调试方式：使用-eval-redis-命令进行调试" class="headerlink" title="第二种调试方式：使用 eval redis 命令进行调试"></a>第二种调试方式：使用 eval redis 命令进行调试</h2><blockquote><p>使用这种方式数据会被持久化，但是如果 lua 脚本比较复杂，那么命令行写起来就比较麻烦，不太直观。</p></blockquote><p>先进入 redis cli 中</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>执行命令</p><pre class="line-numbers language-none"><code class="language-none">eval "local k1 = KEYS[1] \local k2 = KEYS[2] \local v1 = redis.call('get', k1) \local v2 = redis.call('get', k2) \if v1 and v2 then \    local v1ttl = redis.call('ttl', k1) \    local v2ttl = redis.call('ttl', k2) \    return {true, k1, v1, k2, v2, v1ttl, v2ttl, v1..v2} \else \    local now = tonumber(ARGV[1]) \    redis.call('hsetnx', 'hash_table', k1, now) \    redis.call('hsetnx', 'hash_table', k2, now) \    local hash_all = redis.call('hgetall', 'hash_table') \    return {false, hash_all} \end" 2 name age 78675<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>执行效果</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">eval</span> <span class="token string">"local k1 = KEYS[1] \local k2 = KEYS[2] \local v1 = redis.call('get', k1) \local v2 = redis.call('get', k2) \if v1 and v2 then \    local v1ttl = redis.call('ttl', k1) \    local v2ttl = redis.call('ttl', k2) \    return {true, k1, v1, k2, v2, v1ttl, v2ttl, v1..v2} <span class="token entity" title="\e">\e</span>lse \    local now = tonumber(ARGV[1]) \    redis.call('hsetnx', 'hash_table', k1, now) \    redis.call('hsetnx', 'hash_table', k2, now) \    local hash_all = redis.call('hgetall', 'hash_table') \    return {false, hash_all} <span class="token entity" title="\e">\e</span>nd"</span> <span class="token number">2</span> name age <span class="token number">78675</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"name"</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"alex"</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"age"</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"18"</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token parameter variable">-1</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">65267</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"alex18"</span><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">eval</span> <span class="token string">"local k1 = KEYS[1] \local k2 = KEYS[2] \local v1 = redis.call('get', k1) \local v2 = redis.call('get', k2) \if v1 and v2 then \    local v1ttl = redis.call('ttl', k1) \    local v2ttl = redis.call('ttl', k2) \    return {true, k1, v1, k2, v2, v1ttl, v2ttl, v1..v2} <span class="token entity" title="\e">\e</span>lse \    local now = tonumber(ARGV[1]) \    redis.call('hsetnx', 'hash_table', k1, now) \    redis.call('hsetnx', 'hash_table', k2, now) \    local hash_all = redis.call('hgetall', 'hash_table') \    return {false, hash_all} <span class="token entity" title="\e">\e</span>nd"</span> <span class="token number">2</span> name4 age4 <span class="token number">78675</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"name2"</span>    <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"55333"</span>    <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"age2"</span>    <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"55333"</span>    <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"name3"</span>    <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"1682408424"</span>    <span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"age3"</span>    <span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"1682408424"</span>    <span class="token number">9</span><span class="token punctuation">)</span> <span class="token string">"name4"</span>   <span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">"78675"</span>   <span class="token number">11</span><span class="token punctuation">)</span> <span class="token string">"age4"</span>   <span class="token number">12</span><span class="token punctuation">)</span> <span class="token string">"78675"</span><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="lua-脚本自身错误，如何处理？"><a href="#lua-脚本自身错误，如何处理？" class="headerlink" title="lua 脚本自身错误，如何处理？"></a>lua 脚本自身错误，如何处理？</h2><p>那，假设我写的 lua 脚本自身就是有问题的呢？那应该如何排查？</p><blockquote><p>因为不管是 lua 脚本自身语法有错误，还是因为 lua 脚本根本就没有返回值时，均会返回 <code>false</code> 所以有时候你根本搞不清楚 lua 脚本到底有没有执行成功，当然你完全可以通过返回一个固定值来进行判断，也是可行的。</p></blockquote><p>比如我将代码调整成以下：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$redis</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$redis</span><span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.10.194'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$lua</span> <span class="token operator">=</span> <span class="token string heredoc-string"><span class="token delimiter symbol"><span class="token punctuation">&lt;&lt;&lt;</span>EOF</span>local k1 = KEYS[1]local k2 = KEYS[2]-- 故意将 get 命令写成 get1 以便引发一个 lua 脚本错误local v1 = redis.call('get1', k1)local v2 = redis.call('get', k2)if v1 and v2 then    local v1_ttl = redis.call('ttl', k1)    local v2_ttl = redis.call('ttl', k2)    return {true, k1, v1, k2, v2, v1_ttl, v2_ttl, v1..v2}else    local now = tonumber(ARGV[1])    redis.call('hsetnx', 'hash_table', k1, now)    redis.call('hsetnx', 'hash_table', k2, now)    local hash_all = redis.call('hgetall', 'hash_table')    return {false, hash_all}end<span class="token delimiter symbol">EOF<span class="token punctuation">;</span></span></span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$redis</span><span class="token operator">-&gt;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$lua</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'age'</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行情况</p><blockquote><p>其实这里返回 <code>false</code> 是因为 lua 脚本执行失败，并不是因为 lua 脚本执行成功，但是没有返回值导致。</p></blockquote><pre class="line-numbers language-none"><code class="language-none">bash-5.0# php demo.php bool(false)bash-5.0# <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="使用-lua-脚本中的-pcall-函数处理错误与异常"><a href="#使用-lua-脚本中的-pcall-函数处理错误与异常" class="headerlink" title="使用 lua 脚本中的 pcall 函数处理错误与异常"></a>使用 lua 脚本中的 <code>pcall</code> 函数处理错误与异常</h3><blockquote><p><a href="https://www.lua.org/pil/8.4.html">lua 错误处理和异常</a></p></blockquote><p>代码更改为如下：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$redis</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$redis</span><span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.10.194'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$lua</span> <span class="token operator">=</span> <span class="token string heredoc-string"><span class="token delimiter symbol"><span class="token punctuation">&lt;&lt;&lt;</span>EOF</span>local ok, res = pcall(function()local k1 = KEYS[1]local k2 = KEYS[2]-- 故意将 get 命令写成 get1 以便引发一个 lua 脚本错误local v1 = redis.call('get1', k1)local v2 = redis.call('get', k2)if v1 and v2 then    local v1_ttl = redis.call('ttl', k1)    local v2_ttl = redis.call('ttl', k2)    return {true, k1, v1, k2, v2, v1_ttl, v2_ttl, v1..v2}else    local now = tonumber(ARGV[1])    redis.call('hsetnx', 'hash_table', k1, now)    redis.call('hsetnx', 'hash_table', k2, now)    local hash_all = redis.call('hgetall', 'hash_table')    return {false, hash_all}endend)return {ok, res}<span class="token delimiter symbol">EOF<span class="token punctuation">;</span></span></span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$redis</span><span class="token operator">-&gt;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$lua</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'age'</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>返回结果</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 可以通过返回值中的第一个值来进行判断 lua 脚本是否执行成功，如果为 false ，第二个值即为错误提示信息</span>bash-5.0<span class="token comment"># php demo.php </span>array<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  bool<span class="token punctuation">(</span>false<span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  string<span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">)</span> <span class="token string">"@user_script: 6: Unknown Redis command called from Lua script"</span><span class="token punctuation">}</span>bash-5.0<span class="token comment"># </span><span class="token comment"># lua 脚本无异常时，第一个值为 1，第二个值即为匿名函数中返回的值</span>bash-5.0<span class="token comment"># php demo.php </span>array<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  int<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>  array<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>    int<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>    string<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"name"</span>    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>    string<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"alex"</span>    <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>    string<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"age"</span>    <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>    string<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"18"</span>    <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>    int<span class="token punctuation">(</span>-1<span class="token punctuation">)</span>    <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>    int<span class="token punctuation">(</span><span class="token number">62010</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&gt;</span>    string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"alex18"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
            <tag> 缓存 </tag>
            
            <tag> Lua </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis 数据备份与恢复</title>
      <link href="posts/c14e496.html"/>
      <url>posts/c14e496.html</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-数据备份与恢复"><a href="#Redis-数据备份与恢复" class="headerlink" title="Redis 数据备份与恢复"></a>Redis 数据备份与恢复</h1><h2 id="1-命令行执行-save-手动开启-RDB-持久化"><a href="#1-命令行执行-save-手动开启-RDB-持久化" class="headerlink" title="1. 命令行执行 save 手动开启 RDB 持久化"></a>1. 命令行执行 save 手动开启 RDB 持久化</h2><p>使用 RDB 文件做迁移时，需要注意需要先关闭掉目标 redis 的 aof 功能，因为如果二者同时存在的话，会优先于 aof 的方式进行数据恢复。</p><pre class="line-numbers language-none"><code class="language-none">redis-cli -h {target-host} -a {target-password} config set appendonly no<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 会阻塞主进程</span><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> saveOK<span class="token comment"># 通过 fork 一个专门 save 的子进程，从而不会阻塞主进程</span><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> bgsaveBackground saving started<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3><pre class="line-numbers language-none"><code class="language-none"># 查看 redis 默认存放备份文件的目录路径127.0.0.1:6379&gt; config get dir# 查看备份 RDB 文件的名称，默认为 `dump.rdb`127.0.0.1:6379&gt; config get dbfilename<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将备份之后的 <code>dump.rdb</code> 文件放到 <code>config get dir</code> 命令得出的目录路径下，然后重启 redis 即可恢复。（建议备份的时候，可以将 redis 暂时关闭）</p><h2 id="2-通过命令行手动开启-AOF-持久化"><a href="#2-通过命令行手动开启-AOF-持久化" class="headerlink" title="2. 通过命令行手动开启 AOF 持久化"></a>2. 通过命令行手动开启 AOF 持久化</h2><h3 id="备份-1"><a href="#备份-1" class="headerlink" title="备份"></a>备份</h3><pre class="line-numbers language-none"><code class="language-none"># 先清空目标 redis 中全部数据redis-cli -h {target-host} -a {target-password} flushall# 然后在源 redis 中生成 aof 备份文件redis-cli -h {source-host} -a {source-password} config set appendonly yes# 查看生成后的 appendonly.aof 文件所在目录127.0.0.1:6379&gt; config get dir# 查看备份的 aof 文件的名称，默认为 `appendonly.aof`127.0.0.1:6379&gt; config get appendfilename<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="恢复-1"><a href="#恢复-1" class="headerlink" title="恢复"></a>恢复</h3><pre class="line-numbers language-none"><code class="language-none"># 将 `appendonly.aof` 文件放在当前路径下redis-cli -h {target-host} -a {target-password} --pipe &lt; appendonly.aof# 源 redis 关闭 aof 功能redis-cli -h {source-host} -a {source-password} config set appendonly no<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>将备份之后的 <code>appendonly.aof</code> 文件放到 <code>config get dir</code> 命令得出的目录路径下，然后重启 redis 也应该可恢复（具体我没有实操，看资料所说如此）。</p><h2 id="3-使用-redis-dump"><a href="#3-使用-redis-dump" class="headerlink" title="3. 使用 redis-dump"></a>3. 使用 <a href="https://github.com/delano/redis-dump">redis-dump</a></h2><p>redis-dump 是一个用于 redis 数据导入导出的工具（可以以新增的形式导入），是基于 Ruby 实现的，因此需要先安装 Ruby 环境，建议安装 2.6.1 版本以上的 Ruby。</p><h3 id="MAC-上使用-Homebrew-安装-Ruby"><a href="#MAC-上使用-Homebrew-安装-Ruby" class="headerlink" title="MAC 上使用 Homebrew 安装 Ruby"></a>MAC 上使用 Homebrew 安装 Ruby</h3><pre class="line-numbers language-none"><code class="language-none">brew install ruby<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="使用-rvm-（ruby-版本管理器）安装-ruby"><a href="#使用-rvm-（ruby-版本管理器）安装-ruby" class="headerlink" title="使用 rvm （ruby 版本管理器）安装 ruby"></a>使用 <a href="https://rvm.io/">rvm</a> （ruby 版本管理器）安装 ruby</h3><h4 id="centos-7-上安装-rvm"><a href="#centos-7-上安装-rvm" class="headerlink" title="centos 7 上安装 rvm"></a>centos 7 上安装 rvm</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-sSL</span> https://rvm.io/mpapis.asc <span class="token operator">|</span> gpg2 <span class="token parameter variable">--import</span> -<span class="token function">curl</span> <span class="token parameter variable">-sSL</span> https://rvm.io/pkuczynski.asc <span class="token operator">|</span> gpg2 <span class="token parameter variable">--import</span> -<span class="token comment"># 安装成功之后退出终端，然后可以通过 `rvm help` 进行查看</span><span class="token punctuation">\</span>curl <span class="token parameter variable">-sSL</span> https://get.rvm.io <span class="token operator">|</span> <span class="token function">bash</span> <span class="token parameter variable">-s</span> stable<span class="token comment"># 如果不想退出终端，可以直接重载配置文件</span><span class="token builtin class-name">source</span> /etc/profile.d/rvm.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="rvm-常用命令"><a href="#rvm-常用命令" class="headerlink" title="rvm 常用命令"></a>rvm 常用命令</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出已知的 ruby 版本</span>rvm list known<span class="token comment"># 安装指定版本的 ruby</span>rvm <span class="token function">install</span> <span class="token number">2.3</span>.0<span class="token comment"># 更新 rvm</span>rvm get stable<span class="token comment"># 切换到指定 ruby 版本</span>rvm use <span class="token number">2.2</span>.1<span class="token comment"># 设置指定 ruby 版本为默认版本</span>rvm use <span class="token number">2.2</span>.2 <span class="token parameter variable">--default</span><span class="token comment"># 查询已经安装的 ruby 版本</span>rvm list<span class="token comment"># 卸载指定的 ruby 版本</span>rvm remove <span class="token number">1.9</span>.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装-redis-dump"><a href="#安装-redis-dump" class="headerlink" title="安装 redis-dump"></a>安装 redis-dump</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 ruby 2.6.1</span>rvm <span class="token function">install</span> <span class="token number">2.6</span>.1<span class="token comment"># 使用 2.6.1</span>rvm use <span class="token number">2.6</span>.1rvm use <span class="token number">2.6</span>.1 <span class="token parameter variable">--default</span><span class="token comment"># 查看 ruby 版本</span>ruby <span class="token parameter variable">--version</span><span class="token comment"># 替换 gem 镜像地址</span>gem sources <span class="token parameter variable">--add</span> https://gems.ruby-china.org/ <span class="token parameter variable">--remove</span> https://rubygems.org/<span class="token comment"># 查看镜像地址是否更换成功</span>gem sources <span class="token parameter variable">-l</span><span class="token comment"># 安装 redis-dump</span>gem <span class="token function">install</span> redis-dump <span class="token parameter variable">-V</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="redis-dump-备份与恢复"><a href="#redis-dump-备份与恢复" class="headerlink" title="redis-dump 备份与恢复"></a>redis-dump 备份与恢复</h3><blockquote><p>以增量的形式恢复</p></blockquote><h4 id="备份-2"><a href="#备份-2" class="headerlink" title="备份"></a>备份</h4><pre class="line-numbers language-none"><code class="language-none"># 数据导出redis-dump -u 127.0.0.1:6379 &gt; data.json# 导出指定数据库中的数据，比如说 8 号数据库redis-dump -u 127.0.0.1:6379 -d 8 &gt; data8.json# 如果 redis 设置了有密码redis-dump -u {host} -a {password} &gt; data.jsonredis-dump -u :{password}@127.0.0.1:6379 &gt; data.json# 如果需要导出的 redis 是一个 URL 连接地址时，貌似可以这样（没有实操过，具体不清楚）redis-dump -u :{password}@{domain}:{port}# eg: redis-dump -u :123456@www.alex.com:9055<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="恢复-2"><a href="#恢复-2" class="headerlink" title="恢复"></a>恢复</h4><pre class="line-numbers language-none"><code class="language-none"># 导入命令cat data.json | redis-load# 或者&lt; data.json redis-load# 导入数据到 8 号数据库cat data8.json | redis-load -u 127.0.0.1:6379 -a 123456 -d 8# 或者&lt; data8.json redis-load -u 127.0.0.1:6379 -a 123456 -d 8# 如果以上命令是因为 utf-8 格式报错时，可以加上 `-n` 参数cat data8.json | redis-load -n -u 127.0.0.1:6379 -a 123456 -d 8# 如果 redis 设置了有密码cat data.json | redis-load -u :password@127.0.0.1:6379<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-通过脚本实现迁移"><a href="#4-通过脚本实现迁移" class="headerlink" title="4. 通过脚本实现迁移"></a>4. 通过脚本实现迁移</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#!/bin/bash</span><span class="token comment"># 通过这个脚本执行备份有两个缺点，一是使用了 `keys *` ，二是那就是会将 source_host 中所有的 key</span><span class="token comment"># 同步到 target_host 时，会自动改成永不过期</span><span class="token comment"># 详见 `restore` 命令</span><span class="token comment"># 后期有时间了，再考虑优化的事情吧</span><span class="token comment"># document link: https://www.redis.com.cn/commands/restore.html</span><span class="token assign-left variable">source_host</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1<span class="token assign-left variable">source_port</span><span class="token operator">=</span><span class="token number">6379</span><span class="token assign-left variable">source_password</span><span class="token operator">=</span><span class="token string">''</span><span class="token assign-left variable">source_db</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">target_host</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1<span class="token assign-left variable">target_port</span><span class="token operator">=</span><span class="token number">6379</span><span class="token assign-left variable">target_password</span><span class="token operator">=</span><span class="token string">''</span><span class="token assign-left variable">target_db</span><span class="token operator">=</span><span class="token number">2</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">$source_password</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">$target_password</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token keyword">then</span>  redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${source_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${source_port}</span> <span class="token parameter variable">-n</span> <span class="token variable">${source_db}</span> keys <span class="token string">'*'</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> key  <span class="token keyword">do</span>      redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${source_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${source_port}</span> <span class="token parameter variable">-n</span> <span class="token variable">${source_db}</span> <span class="token parameter variable">--raw</span> dump <span class="token variable">$key</span> <span class="token operator">|</span> perl <span class="token parameter variable">-pe</span> <span class="token string">'chomp if eof'</span> <span class="token operator">|</span> redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${target_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${target_port}</span> <span class="token parameter variable">-n</span> <span class="token variable">${target_db}</span> <span class="token parameter variable">-x</span> restore <span class="token variable">$key</span> <span class="token number">0</span>      <span class="token builtin class-name">echo</span> <span class="token string">"migrate key <span class="token variable">$key</span>"</span>  <span class="token keyword">done</span><span class="token keyword">elif</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">$source_password</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token variable">$target_password</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token keyword">then</span>  redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${source_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${source_port}</span> <span class="token parameter variable">-n</span> <span class="token variable">${source_db}</span> keys <span class="token string">'*'</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> key  <span class="token keyword">do</span>      redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${source_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${source_port}</span> <span class="token parameter variable">-n</span> <span class="token variable">${source_db}</span> <span class="token parameter variable">--raw</span> dump <span class="token variable">$key</span> <span class="token operator">|</span> perl <span class="token parameter variable">-pe</span> <span class="token string">'chomp if eof'</span> <span class="token operator">|</span> redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${target_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${target_port}</span> <span class="token parameter variable">-a</span> <span class="token variable">${target_password}</span> <span class="token parameter variable">-n</span> <span class="token variable">${target_db}</span> <span class="token parameter variable">-x</span> restore <span class="token variable">$key</span> <span class="token number">0</span>      <span class="token builtin class-name">echo</span> <span class="token string">"migrate key <span class="token variable">$key</span>"</span>  <span class="token keyword">done</span><span class="token keyword">elif</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token variable">$source_password</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">$target_password</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token keyword">then</span>  redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${source_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${source_port}</span> <span class="token parameter variable">-a</span> <span class="token variable">${source_password}</span> <span class="token parameter variable">-n</span> <span class="token variable">${source_db}</span> keys <span class="token string">'*'</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> key  <span class="token keyword">do</span>      redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${source_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${source_port}</span> <span class="token parameter variable">-a</span> <span class="token variable">${source_password}</span> <span class="token parameter variable">-n</span> <span class="token variable">${source_db}</span> <span class="token parameter variable">--raw</span> dump <span class="token variable">$key</span> <span class="token operator">|</span> perl <span class="token parameter variable">-pe</span> <span class="token string">'chomp if eof'</span> <span class="token operator">|</span> redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${target_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${target_port}</span> <span class="token parameter variable">-n</span> <span class="token variable">${target_db}</span> <span class="token parameter variable">-x</span> restore <span class="token variable">$key</span> <span class="token number">0</span>      <span class="token builtin class-name">echo</span> <span class="token string">"migrate key <span class="token variable">$key</span>"</span>  <span class="token keyword">done</span><span class="token keyword">else</span>  redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${source_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${source_port}</span> <span class="token parameter variable">-a</span> <span class="token variable">${source_password}</span> <span class="token parameter variable">-n</span> <span class="token variable">${source_db}</span> keys <span class="token string">'*'</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> key  <span class="token keyword">do</span>      redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${source_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${source_port}</span> <span class="token parameter variable">-a</span> <span class="token variable">${source_password}</span> <span class="token parameter variable">-n</span> <span class="token variable">${source_db}</span> <span class="token parameter variable">--raw</span> dump <span class="token variable">$key</span> <span class="token operator">|</span> perl <span class="token parameter variable">-pe</span> <span class="token string">'chomp if eof'</span> <span class="token operator">|</span> redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${target_host}</span> <span class="token parameter variable">-p</span> <span class="token variable">${target_port}</span> <span class="token parameter variable">-a</span> <span class="token variable">${target_password}</span> <span class="token parameter variable">-n</span> <span class="token variable">${target_db}</span> <span class="token parameter variable">-x</span> restore <span class="token variable">$key</span> <span class="token number">0</span>      <span class="token builtin class-name">echo</span> <span class="token string">"migrate key <span class="token variable">$key</span>"</span>  <span class="token keyword">done</span><span class="token keyword">fi</span><span class="token comment"># 其实就是利用了 redis 的 dump 和 restore 命令</span><span class="token comment"># eg：</span><span class="token comment"># 127.0.0.1:6379[1]&gt; set hello "hello, dumping world!"</span><span class="token comment"># OK</span><span class="token comment"># 127.0.0.1:6379[1]&gt; dump hello</span><span class="token comment"># "\x00\x15hello, dumping world!\t\x00\x03\xbfc\xcey\xa1\x9e\xfc"</span><span class="token comment"># 127.0.0.1:6379[1]&gt; restore hello1 0 "\x00\x15hello, dumping world!\t\x00\x03\xbfc\xcey\xa1\x9e\xfc"</span><span class="token comment"># OK</span><span class="token comment"># 127.0.0.1:6379[1]&gt; get hello1</span><span class="token comment"># "hello, dumping world!"</span><span class="token comment"># 127.0.0.1:6379[1]&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-redis-使用-migrate-命令迁移数据脚本"><a href="#5-redis-使用-migrate-命令迁移数据脚本" class="headerlink" title="5. redis 使用 migrate 命令迁移数据脚本"></a>5. redis 使用 migrate 命令迁移数据脚本</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#!/bin/bash</span><span class="token assign-left variable">src_redis</span><span class="token operator">=</span><span class="token string">"10.8.163.1"</span><span class="token assign-left variable">src_port</span><span class="token operator">=</span><span class="token string">"6379"</span><span class="token assign-left variable">dest_redis</span><span class="token operator">=</span><span class="token string">"10.8.132.13"</span><span class="token assign-left variable">dest_port</span><span class="token operator">=</span><span class="token string">"6379"</span><span class="token keyword">for</span> <span class="token for-or-select variable">y</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span>redis-cli <span class="token parameter variable">-h</span> $<span class="token punctuation">{</span>src_redis<span class="token punctuation">}</span> <span class="token parameter variable">-p</span> $<span class="token punctuation">{</span>src_port<span class="token punctuation">}</span> keys <span class="token string">"*"</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>   redis-cli <span class="token parameter variable">-h</span> <span class="token variable">${src_redis}</span> <span class="token parameter variable">-p</span> <span class="token variable">${src_port}</span> migrate <span class="token variable">${dest_redis}</span> <span class="token variable">${dest_port}</span> <span class="token variable">${y}</span> <span class="token number">0</span> <span class="token number">1000</span> copy replace   <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token punctuation">\</span> %T<span class="token variable">)</span></span> Copy key <span class="token variable">${y}</span> to new redis...."</span><span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
            <tag> 缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go 打包和部署</title>
      <link href="posts/5c09a73d.html"/>
      <url>posts/5c09a73d.html</url>
      
        <content type="html"><![CDATA[<h1 id="Go-打包和部署"><a href="#Go-打包和部署" class="headerlink" title="Go 打包和部署"></a>Go 打包和部署</h1><h2 id="打包相关命令"><a href="#打包相关命令" class="headerlink" title="打包相关命令"></a>打包相关命令</h2><table><thead><tr><th>命令</th><th>含义</th></tr></thead><tbody><tr><td>go run</td><td>编译并马上运行 go 程序（只接收 main 包下的文件作为参数）</td></tr><tr><td>go build</td><td>编译指定的源文件、软件包及其依赖项，但它不会运行编译后的二进制文件。(如果想要指定所生成的二进制文件为其他名称，则可以通过 <code>-o</code> 参数进行调整)</td></tr><tr><td>go install</td><td>编译并安装源文件、软件包到 <code>$GOBIN</code> 目录下。 可以执行 <code>go install -x</code> 查看它的编译过程。文件名称为 Go modules 的项目名，而不是目录名</td></tr></tbody></table><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>-x</td><td>打印编译过程中的所有执行命令，执行生成的二进制文件，比如：<code>go run -x main.go</code> 和 <code>go build -x</code></td></tr><tr><td>-n</td><td>打印编译过程中的所有执行命令，不执行生成的二进制文件</td></tr><tr><td>-a</td><td>强制重新编译所有涉及的依赖，简单来说，就是不利用缓存或已编译好的部分文件，直接所有包都是最新的代码重新编译和关联</td></tr><tr><td>-o</td><td>指定生成的二进制文件名称</td></tr><tr><td>-p</td><td>指定编译过程中可以并发运行程序的数量，默认值为可用的 CPU 数量（Go 语言默认是支持并发编译的）</td></tr><tr><td>-work</td><td>打印临时工作目录的完整路径，在退出时不删除该目录</td></tr><tr><td>-race</td><td>启用数据竞争检测，目前仅支持 Linux/amd64、FreeBSD/amd64、Darwin/amd64 和 Windows/amd64 平台</td></tr><tr><td>-installsuffix</td><td>在软件包安装的目录中增加后缀标识，以保持输出与默认版本分开</td></tr></tbody></table><h2 id="跨平台交叉编译"><a href="#跨平台交叉编译" class="headerlink" title="跨平台交叉编译"></a>跨平台交叉编译</h2><p>Go 语言支持跨平台交叉编译，也就是说我们可以在 Windows 或 Mac 平台下编写代码，最后将代码编译成能够在 Linux amd64 服务器上运行的程序。</p><p>根目录使用以下指令可以静态编译 <code>Linux</code> 平台 <code>amd64</code> 架构的可执行文件：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">CGO_ENABLED</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GOOS</span><span class="token operator">=</span>linux <span class="token assign-left variable">GOARCH</span><span class="token operator">=</span>amd64 go build <span class="token parameter variable">-o</span> <span class="token operator">&lt;</span>application-name<span class="token operator">&gt;</span><span class="token comment"># 比如</span><span class="token assign-left variable">CGO_ENABLED</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GOOS</span><span class="token operator">=</span>linux go build <span class="token parameter variable">-a</span> <span class="token parameter variable">-installsuffix</span> cgo <span class="token parameter variable">-o</span> <span class="token operator">&lt;</span>application-name<span class="token operator">&gt;</span> <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Windows 依次执行以下四个命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SET <span class="token assign-left variable">CGO_ENABLED</span><span class="token operator">=</span><span class="token number">0</span>SET <span class="token assign-left variable">GOOS</span><span class="token operator">=</span>linuxSET <span class="token assign-left variable">GOARCH</span><span class="token operator">=</span>amd64go build <span class="token parameter variable">-o</span> <span class="token operator">&lt;</span>application-name<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数名</th><th>含义</th></tr></thead><tbody><tr><td>CGO_ENABLED</td><td>设置是否在 Go 代码中调用 C 代码。0 为关闭，采用纯静态编译。可通过执行 go env 进行查看</td></tr><tr><td>GOOS</td><td>目标操作系统，如 Linux 、Darwin、Windows</td></tr><tr><td>GOARCH</td><td>目标操作系统的架构，若不设置，则默认值为程序运行环境的目标计算架构一致</td></tr><tr><td>GOHOSTOS</td><td>用于标识程序运行环境的目标操作系统</td></tr><tr><td>GOHOSTARCH</td><td>用于标识程序运行环境的目标计算架构</td></tr></tbody></table><p><strong>可以通过如下命令查看 Go 支持 OS 和平台列表</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go tool dist list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th>系统</th><th>GOOS</th><th>GOARCH</th></tr></thead><tbody><tr><td>Windows 32位</td><td>windows</td><td>386</td></tr><tr><td>Windows 64位</td><td>windows</td><td>amd64</td></tr><tr><td>OS X 32位</td><td>darwin</td><td>386</td></tr><tr><td>OS X 64位</td><td>darwin</td><td>amd64</td></tr><tr><td>Linux 32位</td><td>linux</td><td>386</td></tr><tr><td>Linux 64位</td><td>linux</td><td>amd64</td></tr></tbody></table><h2 id="第三方打包工具"><a href="#第三方打包工具" class="headerlink" title="第三方打包工具"></a>第三方打包工具</h2><p>以下几个第三方打包工具可以将静态文件（JS、CSS、图片）或者模版文件等非 <code>.go</code> 文件打包到一个二进制文件中， <a href="https://pkg.go.dev/embed">Embed</a> 标准库也可以，但是得使用 go 1.16 版本以后的版本才行。</p><ul><li><a href="https://github.com/go-bindata/go-bindata">go-bindata/go-bindata</a>：推荐使用这个</li><li><a href="https://github.com/gobuffalo/packr">gobuffalo/packr</a></li><li><a href="https://github.com/markbates/pkger">markbates/pkger</a></li><li><a href="https://github.com/rakyll/statik">rakyll/statik</a></li><li><a href="https://github.com/knadh/stuffbin">knadh/stuffbin</a></li><li><a href="https://github.com/go-bindata/go-bindata">github.com/go-bindata/go-bindata</a></li><li><a href="https://github.com/elazarl/go-bindata-assetfs">elazarl/go-bindata-assetfs</a></li><li><a href="https://github.com/GeertJohan/go.rice">GeertJohan/go.rice</a></li></ul><h3 id="将数据文件转换成-go-代码"><a href="#将数据文件转换成-go-代码" class="headerlink" title="将数据文件转换成 go 代码"></a>将数据文件转换成 go 代码</h3><blockquote><p><a href="https://github.com/go-bindata/go-bindata">go-bindata</a> 库可以将数据文件转换为 Go 代码。例如：常见的配置文件、资源文件（如 swagger ui）<br>因此读取配置信息也可以通过 <a href="https://github.com/go-bindata/go-bindata/">go-bindata/go-bindata</a> 包提供的方式来读取。使用方式如下：</p></blockquote><ol><li>安装 <code>go-bindata/go-bindata</code> 包</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get <span class="token parameter variable">-u</span> github.com/go-bindata/go-bindata/<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>将配置文件生成 go 代码</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 执行这条命令后，会将 `configs/config.yaml` 文件打包，并通过 `-o` 参数选择指定的路径输出到 `configs/config.go` 文件中</span><span class="token comment"># 再通过 `-pkg` 选项指定生成的包名为 `configs`</span>go-bindata <span class="token parameter variable">-o</span> configs/config.go -pkg-configs configs/config.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>读取文件中的配置信息</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go">data<span class="token punctuation">,</span> err <span class="token operator">:=</span> configs<span class="token punctuation">.</span><span class="token function">Asset</span><span class="token punctuation">(</span><span class="token string">"configs/config.yaml"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="编译缓存"><a href="#编译缓存" class="headerlink" title="编译缓存"></a>编译缓存</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看编译缓存所在的目录</span>go <span class="token function">env</span> GOCACHE<span class="token comment"># 清理编译缓存</span>go clean <span class="token parameter variable">-cache</span><span class="token comment"># 查看程序编译的时间</span><span class="token function">time</span> go build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="压缩编译后的二进制文件"><a href="#压缩编译后的二进制文件" class="headerlink" title="压缩编译后的二进制文件"></a>压缩编译后的二进制文件</h2><blockquote><p><strong>如非必要情况，不建议压缩</strong></p></blockquote><ul><li>方式一：去掉 DWARF 调试信息和符号表信息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go build <span class="token parameter variable">-ldflags</span><span class="token operator">=</span><span class="token string">"-w -s"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th>参数名</th><th>含义</th><th>副作用</th></tr></thead><tbody><tr><td>-w</td><td>去除 DWARF 调试信息</td><td>会导致异常 panic 抛出时，调用堆栈信息没有文件名、行号信息</td></tr><tr><td>-s</td><td>去除符号表信息</td><td>无法使用 gdb 调试</td></tr></tbody></table><ul><li>方式二：使用 <a href="https://github.com/upx/upx">upx</a>、 <a href="https://niconiconi.fun/2019/01/10/upx-tutorial/">upx 教程</a> 工具对可执行文件进行压缩</li></ul><h2 id="编译信息写入（使用-ldflags-设置编译信息）"><a href="#编译信息写入（使用-ldflags-设置编译信息）" class="headerlink" title="编译信息写入（使用 ldflags 设置编译信息）"></a>编译信息写入（使用 ldflags 设置编译信息）</h2><blockquote><p><a href="https://ms2008.github.io/2018/10/08/golang-build-version/">go version 信息注入</a></p></blockquote><ul><li>先在 <code>main.go</code> 文件中写入代码</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>buildTime    <span class="token builtin">string</span> <span class="token comment">// 二进制文件编译时间</span>buildVersion <span class="token builtin">string</span> <span class="token comment">// 二进制文件编译版本</span>goVersion    <span class="token builtin">string</span> <span class="token comment">// 打包二进制文件时的 go 版本信息</span>gitCommitID  <span class="token builtin">string</span> <span class="token comment">// 二进制文件编译时的 git 提交版本号</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>args <span class="token operator">:=</span> os<span class="token punctuation">.</span>Args<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"--version"</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"-v"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Build Time: %s \n"</span><span class="token punctuation">,</span> buildTime<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Build Version: %s \n"</span><span class="token punctuation">,</span> buildVersion<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Build Go Version: %s \n"</span><span class="token punctuation">,</span> goVersion<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Build Git Commit Hash ID: %s \n"</span><span class="token punctuation">,</span> gitCommitID<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编译代码时执行如下命令</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go build <span class="token parameter variable">-o</span> app-service <span class="token parameter variable">-ldflags</span> <span class="token punctuation">\</span><span class="token string">"-X main.buildTime=<span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y-%m-%d,%H:%M:%S<span class="token variable">`</span></span> -X main.buildVersion=1.0.0 -X 'main.goVersion=<span class="token variable"><span class="token variable">$(</span>go version<span class="token variable">)</span></span>' -X main.gitCommitID=<span class="token variable"><span class="token variable">`</span><span class="token function">git</span> rev-parse HEAD<span class="token variable">`</span></span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>在上述命令中，通过 <code>-ldflags</code> 命令的 <code>-X</code> 参数可以在链接时将信息写入变量中，其格式为：<code>package_name.variable_name=value</code></p></blockquote><ul><li>查看编译后的二进制文件和版本信息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./app-service <span class="token parameter variable">-version</span><span class="token comment"># output is:</span><span class="token comment"># Build Time: 2022-03-27,13:50:26</span><span class="token comment"># Build Version: 1.0.0</span><span class="token comment"># Build Go Version: go version go1.16.3 darwin/amd64</span><span class="token comment"># Build Git Commit Hash ID: b3473e9cc98148f5c94b53c1cada7de133143462</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="关于守护进程"><a href="#关于守护进程" class="headerlink" title="关于守护进程"></a>关于守护进程</h3><ul><li><code>nohup</code> —— linux 系统内置，直接使用 <code>nohup ./&lt;executable-file&gt; &amp;</code> 即可</li><li><code>systemctl</code> —— linux 系统内置，需要配置 systemctl 管理配置文件</li><li><code>supervisor</code></li><li><a href="https://github.com/ochinchina/supervisord">go-supervisor</a> —— Go 语言实现但 supervisor，好处是不需要安装 Python 环境</li></ul><h4 id="1-使用-supervisor-部署："><a href="#1-使用-supervisor-部署：" class="headerlink" title="1. 使用 supervisor 部署："></a>1. 使用 supervisor 部署：</h4><pre class="line-numbers language-none"><code class="language-none"># 假设关闭一个监听端口为 3000 的服务kill -9 $(lsof -ti:3000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>创建 supervisor 相关配置信息</p><p>vim /etc/supervisor/conf.d/alex-blog.conf</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 程序名称，stop start 等管理时使用</span><span class="token punctuation">[</span>program:alex-blog<span class="token punctuation">]</span><span class="token comment"># 进入该目录运行命令，确保了和项目相关的一些配置文件可以得到加载，比如 .env 文件</span><span class="token assign-left variable">directory</span><span class="token operator">=</span>/data/www/blog<span class="token comment"># 以绝对路径的方式执行 alex-blog 二进制文件</span><span class="token assign-left variable">command</span><span class="token operator">=</span>/data/www/blog/alex-blog<span class="token comment"># 重启时发送的信号，确保端口正常关闭</span><span class="token assign-left variable">stopsignal</span><span class="token operator">=</span><span class="token environment constant">TERM</span><span class="token comment"># 是否自启动</span><span class="token assign-left variable">autostart</span><span class="token operator">=</span>true<span class="token comment"># 是否自动重启</span><span class="token assign-left variable">autorestart</span><span class="token operator">=</span>true<span class="token comment"># 执行程序的用户</span><span class="token assign-left variable">user</span><span class="token operator">=</span>www-data<span class="token comment"># 输出日志位置</span><span class="token assign-left variable">stdout_logfile</span><span class="token operator">=</span>/data/log/supervisor/blog/stdout.log<span class="token comment"># 错误输出日志</span><span class="token assign-left variable">stderr_logfile</span><span class="token operator">=</span>/data/log/supervisor/blog/stderr.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重载 Supervisor 配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 重载 supervisor 配置文件</span>supervisorctl reload<span class="token comment"># 查看程序名称为 alex-blog 的程序状态</span><span class="token comment"># 如果直接执行 `supervisorctl status` 命令的话，则是查看所有任务的状态</span>supervisorctl status alex-blog<span class="token comment"># 关闭所有任务</span>supervisorctl <span class="token function">shutdown</span><span class="token comment"># 启动任务</span>supervisorctl start <span class="token operator">&lt;</span>程序名<span class="token operator">&gt;</span><span class="token comment"># 关闭任务</span>supervisorctl stop <span class="token operator">&lt;</span>程序名<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-使用-docker-部署："><a href="#2-使用-docker-部署：" class="headerlink" title="2. 使用 docker 部署："></a>2. 使用 docker 部署：</h4><h5 id="编译后的二进制文件放在-docker-中运行"><a href="#编译后的二进制文件放在-docker-中运行" class="headerlink" title="编译后的二进制文件放在 docker 中运行"></a>编译后的二进制文件放在 docker 中运行</h5><p>先要在宿主机中项目根目录下进行编译</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 交叉编译生成 Linux 平台的可执行文件</span><span class="token assign-left variable">CGO_ENABLED</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GOOS</span><span class="token operator">=</span>linux go build <span class="token parameter variable">-a</span> <span class="token parameter variable">-installsuffix</span> cgo <span class="token parameter variable">-o</span> hello-world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>编写 Dockerfile 文件</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># 基础镜像</span><span class="token instruction"><span class="token keyword">FROM</span> alpine:3.12</span><span class="token comment"># 或者使用 Scratch 镜像</span><span class="token comment"># FROM scratch</span><span class="token comment"># 维护者</span><span class="token instruction"><span class="token keyword">MAINTAINER</span> alex</span><span class="token comment"># docker build 时执行命令</span><span class="token instruction"><span class="token keyword">RUN</span> mkdir -p /go-project/demo <span class="token operator">\</span>&amp;&amp; ln -sf /dev/stdout /go-project/demo/storage/service.log</span><span class="token comment"># 工作目录</span><span class="token instruction"><span class="token keyword">WORKDIR</span> /go-project/demo</span><span class="token comment"># 拷贝</span><span class="token instruction"><span class="token keyword">COPY</span> hello-world /go-project/demo/hello-world</span><span class="token comment"># 或者直接将当前目录下所有的文件拷贝到容器中</span><span class="token comment"># COPY . /go-project/demo</span><span class="token comment"># 这里暴露端口与否都行</span><span class="token comment"># EXPOSE 8501</span><span class="token comment"># docker run 时执行的命令</span><span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"./hello-world"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构建镜像</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> go-project:v1.0.0 <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>运行容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 宿主机的 9501 端口映射到了容器的 8501 端口</span><span class="token comment"># -d 用于该程序在后台运行</span><span class="token comment"># -p 用于映射端口</span><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">9501</span>:8501 go-project:v1.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="nginx-配置信息"><a href="#nginx-配置信息" class="headerlink" title="nginx 配置信息"></a>nginx 配置信息</h4><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">upstream</span> go-project</span> <span class="token punctuation">{</span>    <span class="token comment"># go-project HTTP Server 的 IP 及 端口</span>    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:9501</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">server_name</span> goblog.com</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">access_log</span>   /data/log/nginx/goblog/access.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">error_log</span>    /data/log/nginx/goblog/error.log</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">location</span> /static/</span> <span class="token punctuation">{</span>      <span class="token directive"><span class="token keyword">alias</span> /www/wwwroot/gitlab/go-project/public/uploads/</span><span class="token punctuation">;</span> <span class="token comment">#静态资源路径</span>    <span class="token punctuation">}</span>        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        <span class="token comment"># 将客户端的 Host 和 IP 信息一并转发到对应节点</span>        <span class="token directive"><span class="token keyword">proxy_redirect</span>             <span class="token boolean">off</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span>           Host             <span class="token variable">$http_host</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span>           X-Real-IP        <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">proxy_set_header</span>           X-Forwarded-For  <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>                <span class="token comment"># 转发Cookie，设置 SameSite</span>        <span class="token directive"><span class="token keyword">proxy_cookie_path</span> / <span class="token string">"/; secure; HttpOnly; SameSite=strict"</span></span><span class="token punctuation">;</span>                <span class="token comment"># 执行代理访问真实服务器</span>        <span class="token directive"><span class="token keyword">proxy_pass</span>                 http://go-project</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何在 Go 项目中可靠的获取项目根目录</title>
      <link href="posts/7c9ed3a3.html"/>
      <url>posts/7c9ed3a3.html</url>
      
        <content type="html"><![CDATA[<h1 id="如何在-Go-项目中可靠的获取项目根目录"><a href="#如何在-Go-项目中可靠的获取项目根目录" class="headerlink" title="如何在 Go 项目中可靠的获取项目根目录"></a>如何在 Go 项目中可靠的获取项目根目录</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"os"</span><span class="token string">"path"</span><span class="token string">"path/filepath"</span><span class="token string">"runtime"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token comment">// getRootPath 获取项目根目录</span><span class="token keyword">func</span> <span class="token function">getRootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token comment">// 第一种方式：获取当前执行程序所在的绝对路径</span><span class="token comment">// 这种仅在 `go build` 时，才可以获取正确的路径</span><span class="token comment">// 获取当前执行的二进制文件的全路径，包括二进制文件名</span><span class="token comment">// eg: exePath = "/var/folders/hr/2rqppbcx4kv8_3qc_ky1qcy80000gn/T/go-build265586886/b001/exe/main"</span>exePath<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Executable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// eg: rootPathByExecutable = "/private/var/folders/hr/2rqppbcx4kv8_3qc_ky1qcy80000gn/T/go-build265586886/b001/exe"</span>rootPathByExecutable<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">EvalSymlinks</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span>exePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 第二种方式：获取当前执行文件绝对路径</span><span class="token comment">// 这种方式在 `go run` 和 `go build` 时，都可以获取到正确的路径</span><span class="token comment">// 但是交叉编译后，执行的结果是错误的结果</span><span class="token keyword">var</span> rootPathByCaller <span class="token builtin">string</span><span class="token comment">// eg: filename = "/Users/pudongping/glory/codes/golang/gin-biz-web-api/main.go"</span><span class="token boolean">_</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Caller</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">// eg: rootPathByCaller = "/Users/pudongping/glory/codes/golang/gin-biz-web-api"</span><span class="token keyword">if</span> ok <span class="token punctuation">{</span>rootPathByCaller <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 可以通过 `echo $TMPDIR` 查看当前系统临时目录</span><span class="token comment">// eg: tmpDir = "/private/var/folders/hr/2rqppbcx4kv8_3qc_ky1qcy80000gn/T"</span>tmpDir<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">EvalSymlinks</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">TempDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 对比通过 `os.Executable()` 获取到的路径是否与 `TMPDIR` 环境变量设置的路径相同</span><span class="token comment">// 相同，则说明是通过 `go run` 命令启动的</span><span class="token comment">// 不同，则是通过 `go build` 命令启动的</span><span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>rootPathByExecutable<span class="token punctuation">,</span> tmpDir<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> rootPathByCaller<span class="token punctuation">}</span><span class="token keyword">return</span> rootPathByExecutable<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 当然还有其他的方式，比如可以自己先在系统里设置诸如 `PROJECT_ROOT_DIR` 之类的环境变量，将</span><span class="token comment">// 根目录放到环境变量中，然后再在程序中通过 `os.Getenv("PROJECT_ROOT_DIR")` 也行</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">getRootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://github.com/pudongping/golang-tutorial/blob/main/project/get_root_path/main.go">代码地址</a></li><li><a href="https://mp.weixin.qq.com/s/ws0fcHi-DzCN5PrJNDNKog">三种获取Go项目根目录的方式，让你做架构，选哪种？</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go Modules 模式</title>
      <link href="posts/2f3aad3a.html"/>
      <url>posts/2f3aad3a.html</url>
      
        <content type="html"><![CDATA[<h1 id="Go-Modules-模式"><a href="#Go-Modules-模式" class="headerlink" title="Go Modules 模式"></a>Go Modules 模式</h1><h2 id="GOPATH-目录"><a href="#GOPATH-目录" class="headerlink" title="GOPATH 目录"></a>GOPATH 目录</h2><p>GOPATH 目录下一共包含三个子目录：</p><ul><li>bin：存储所编译生成的二进制文件。</li><li>pkg：存储预编译的目标文件，以加快程序的后续编译速度。</li><li>src：存储所有 <code>.go</code> 文件或源代码。在编写 Go 应用程序，程序包和库时，一般会以 <code>$GOPATH/src/github.com/foo/bar</code> 的路径进行存放。</li></ul><blockquote><p>使用 <code>go get</code> 来拉取外部依赖时，会自动下载并安装到 <code>$GOPATH</code> 目录下。</p></blockquote><h2 id="go-mod-命令"><a href="#go-mod-命令" class="headerlink" title="go mod 命令"></a>go mod 命令</h2><p>查看 go mod 都有哪些命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Go 的所有工具都可以使用 `go help` 来查看使用方法</span>go <span class="token builtin class-name">help</span> mod<span class="token comment"># 查看 go mod download 有哪些参数</span>go <span class="token builtin class-name">help</span> mod download<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th align="left">命令</th><th align="center">作用</th></tr></thead><tbody><tr><td align="left">go mod help</td><td align="center">查看帮助信息</td></tr><tr><td align="left">go mod init</td><td align="center">初始化当前文件夹，生成 go.mod 文件</td></tr><tr><td align="left">go mod download</td><td align="center">下载 go.mod 文件中指明的所有依赖到本地（默认为 <code>$GOPATH/pkg/mod</code> 目录）增加 <code>-x</code> 参数 <code>go mod download -x</code> 会打印下载信息；<code>go mod download -json</code> 用来查看模块下载的 zip 存放位置，以及解压后的位置；</td></tr><tr><td align="left">go mod tidy</td><td align="center">整理现有的依赖，执行时会把未使用的 module 移除掉，同时也会增加缺少的包</td></tr><tr><td align="left">go mod graph</td><td align="center">查看现有的依赖结构图</td></tr><tr><td align="left">go mod edit</td><td align="center">编辑 go.mod 文件，比如修改项目中使用的 go 版本 <code>go mod edit -go=1.17</code></td></tr><tr><td align="left">go mod vendor</td><td align="center">导出项目所有的依赖到 vendor 目录（需要执行 go build -mod=vendor 才可以使用 vendor 作为依赖来编译，但是在 v1.14 及以后的版本中，如果 golang 项目根目录下存在 vendor 目录，go build 命令会默认优先基于 vendor 目录缓存的三方依赖包构建 golang 程序，除非我们在 go build 命令后面加上 -mod=mod 参数）</td></tr><tr><td align="left">go mod verify</td><td align="center">校验一个模块是否被篡改过，校验从 GOPROXY 服务器上下载的 zip 文件与 GOSUMDB 服务器下载下来的哈希值，是否匹配。</td></tr><tr><td align="left">go mod why</td><td align="center">查看为什么需要依赖某模块，比如 <code>go mod why gopkg.in/yaml.v2 gopkg.in/yaml.v3</code></td></tr><tr><td align="left">go clean -modcache</td><td align="center">可以清空本地下载的 Go Modules 缓存 （会清空 <code>$GOPATH/pkg/mod</code> 目录）</td></tr></tbody></table><h2 id="go-mod-环境变量"><a href="#go-mod-环境变量" class="headerlink" title="go mod 环境变量"></a>go mod 环境变量</h2><p>和 <code>go mod</code> 比较关联的几个环境变量</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> envGO111MODULE<span class="token operator">=</span><span class="token string">"auto"</span>GOPROXY<span class="token operator">=</span><span class="token string">"https://goproxy.cn,direct"</span>GOSUMDB<span class="token operator">=</span><span class="token string">"sum.golang.org"</span>GONOPROXY<span class="token operator">=</span><span class="token string">""</span>GONOSUMDB<span class="token operator">=</span><span class="token string">""</span>GOPRIVATE<span class="token operator">=</span><span class="token string">""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="GO111MODULE"><a href="#GO111MODULE" class="headerlink" title="GO111MODULE"></a>GO111MODULE</h3><p>Go 语言提供了 GO111MODULE 这个环境变量来作为 Go modules 的开关，其允许设置以下参数：</p><ul><li>auto：只要项目包含了 go.mod 文件的话启用 Go modules，目前在 Go1.11 至 Go 1.14 中仍然是默认值</li><li>on：启用 Go modules，推荐设置，将会是未来版本中的默认值</li><li>off：禁用 Go modules，不推荐设置</li></ul><h4 id="设置方式"><a href="#设置方式" class="headerlink" title="设置方式"></a>设置方式</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token function">env</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span>on<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>也可以直接在 shell 环境变量中设置，比如我这里使用的是 Mac，且使用的 zsh，则在 <code>vim ~/.zshrc</code> 然后添加以下内容，如果是其它 Linux 系列系统，则需要在 <code>~/.bash_profile</code> 文件中进行设置。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span>on<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后要记得 <code>source ~/.zshrc</code></p><h3 id="GOPROXY"><a href="#GOPROXY" class="headerlink" title="GOPROXY"></a>GOPROXY</h3><p>这个环境变量主要是用于设置 Go 模块代理（Go module proxy），其作用是用于使 Go 在后续拉取模块版本时直接通过镜像站点来快速拉取</p><p>GOPROXY 的默认值是：<code>https://proxy.golang.org,direct</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 七牛 CDN</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span>  <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn,direct<span class="token comment"># 2. 阿里云</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://mirrors.aliyun.com/goproxy/,direct<span class="token comment"># 3. 官方</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span>  <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.io,direct<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>direct</code> 是一个特殊指示符，用于指示 Go 在获取源码包时，先尝试在设置 GOPROXY 的地址下抓取，如果遇到 404 或 410 等错误时，再回溯到模块版本的源地址去抓取 （比如 GitHub 等）。</p><h3 id="GOSUMDB"><a href="#GOSUMDB" class="headerlink" title="GOSUMDB"></a>GOSUMDB</h3><p>它的值是一个 Go checksum database，用于在拉取模块版本时（无论是从源站拉取还是通过 Go module proxy 拉取）保证拉取到的模块版本数据未经过篡改，若发现不一致，也就是可能存在篡改，将会立即终止。</p><p>GOSUMDB 的默认值为：<code>sum.golang.org</code>，在国内也是无法访问的，但是 GOSUMDB 可以被 Go 模块代理所代理，因此我们可以通过设置 <code>GOPROXY</code> 来解决，而先前我们所设置的模块代理 <code>goproxy.cn</code> （七牛云的 CDN）就能支持代理 <code>sum.golang.org</code>，所以这一个问题在设置 GOPROXY 后，可以不需要过度关心。</p><p>也可以将其设置为 <code>off</code> ，也就是禁止 Go 在后续操作中校验模块版本。但是不建议关闭校验。</p><h3 id="GONOPROXY-GONOSUMDB-GOPRIVATE"><a href="#GONOPROXY-GONOSUMDB-GOPRIVATE" class="headerlink" title="GONOPROXY/GONOSUMDB/GOPRIVATE"></a>GONOPROXY/GONOSUMDB/GOPRIVATE</h3><ul><li>GONOPROXY —— 设置不走 Go Proxy 的 URL 规则；</li><li>GONOSUMDB —— 设置不检查哈希的 URL 规则；</li><li>GOPRIVATE —— 设置私有模块的 URL 规则，会同时设置以上两个变量。</li></ul><p>这三个环境变量都是用在当前项目依赖了私有模块，例如自己公司部署的私有 git 仓库或者是 GitHub 中的私有仓库，都是需要进行设置的，否则会拉取失败。</p><p>设置 GOPRIVATE 之后，表示该地址为私有仓库，不会从 GOPROXY 所对应的地址上去下载。</p><p><strong>而一般建议直接设置 GOPRIVATE，它的值将作为 GONOPROXY 和 GONOSUMDB 的默认值，所以建议直接设置 GOPRIVATE 即可。</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以下表示 git.example.com 和 github.com/username/package 都是私有仓库，不会进行 GOPROXY 下载和校验</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">GOPRIVATE</span><span class="token operator">=</span><span class="token string">"git.example.com,github.com/username/package"</span><span class="token comment"># 设置后，前缀为 `git.example.com` 和 `github.com/username/package` 的模块都会被认为是私有模块</span><span class="token comment"># 表示所有模块路径为 example.com 的子域名都不进行 GOPROXY 下载和校验</span><span class="token comment"># 需要注意的是不包括 example.com 本身</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">GOPRIVATE</span><span class="token operator">=</span><span class="token string">"*.example.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用-Go-Modules-初始化项目"><a href="#使用-Go-Modules-初始化项目" class="headerlink" title="使用 Go Modules 初始化项目"></a>使用 Go Modules 初始化项目</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启 Go Modules 模块，保证 GO111MODULE=on</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span>on<span class="token comment"># 在任意文件夹下创建一个项目（不要求在 $GOPATH/src 目录下创建）</span><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/modules_test<span class="token builtin class-name">cd</span> <span class="token environment constant">$HOME</span>/modules_test<span class="token comment"># 创建 go.mod 文件，同时起当前项目的模块名称</span><span class="token comment"># 如果你是在 `$GOPATH/src` 目录下创建的文件夹可以直接执行 `go mod init` 命令初始化，不需要加模块名称</span>go mod init github.com/pudongping/moudles_test<span class="token comment"># 在该项目下编写源代码，并下载依赖库</span><span class="token comment"># 也可以不加 `-v` 参数</span>go get <span class="token parameter variable">-v</span> XXXXXXXXeg: go get <span class="token parameter variable">-v</span> github.com/pudongping/moudles_test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>下载的包其实被缓存在 <code>$GOPATH/pkg/mod</code> 目录和 <code>$GOPATH/pkg/sumdb</code> 目录下</p></blockquote><ul><li><strong><code>go.mod</code> 文件中：</strong></li></ul><ol><li>module：用于定义当前项目的模块路径。</li><li>go：用于标识当前模块的 Go 语言版本，值为初始化模块时的版本。</li><li>require：用于设置一个特定的模块版本。</li><li>exclude：用于从使用中排除一个特定的模块版本。</li><li>replace：用于将一个模块版本替换为另外一个模块版本。</li></ol><pre class="line-numbers language-none"><code class="language-none"># v0.0.0 表示版本信息# 20190718012654 表示所拉取版本的 commit 时间# fb15b899a751 表示所拉取版本的 commit 哈希值github.com/alecthomas/template v0.0.0-20190718012654-fb15b899a751<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong><code>go.sum</code> 文件中：</strong></li></ul><p>go.sum 文件的作用是：罗列当前项目直接或间接依赖的所有模块版本，保证今后项目依赖的版本不会被篡改。间接依赖的包的哈希值也会被保存。</p><p>go.sum 文件中有两种 hash 的形式：</p><ol><li><code>h1:&lt;hash&gt;</code> 将目标模块版本的 zip 文件开包后，针对所有包内文件依次进行 hash，然后再把它们的 hash 结果按照固定格式和算法组成总的 hash 值，如果不存在，表示可能依赖的库用不上</li><li><code>xxx/go.mod h1.&lt;hash&gt;</code> 表示 go.mod 文件做的 hash</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将目标模块版本的 zip 文件开包后，针对包内所有文件依次进行 hash，然后再将 它们的 hash 结果汇总组成 hash</span>github.com/gorilla/mux v1.7.4 h1:VuZ8uybHlWmqV03+zRzdwKL4tUnIp1MAQtp1mIFE1bc<span class="token operator">=</span><span class="token comment"># 针对 go.mod 文件的 hash 值</span>github.com/gorilla/mux v1.7.4/go.mod h1:DVbg23sWSpFRCP0SfiEN6jmj59UnW/n46BH5rLB71So<span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="go-get-拉取命令"><a href="#go-get-拉取命令" class="headerlink" title="go get 拉取命令"></a>go get 拉取命令</h2><blockquote><p>下载的模块会被放置于 <code>$GOPATH/pkg/mod</code> 目录中</p></blockquote><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>go get</td><td>拉取依赖，会进行指定性拉取（更新），并不会更新所依赖的其它模块。（如果本地已存在要下载的包，将会直接使用本地已存在的包）</td></tr><tr><td>go get -u</td><td>更新现有的依赖，会强制更新它所依赖的其它全部模块，不包括自身。</td></tr><tr><td>go get -u -t ./…</td><td>更新所有直接依赖和间接依赖的模块版本，包括单元测试中用到的。</td></tr><tr><td>go get golang.org/x/text@latest</td><td>拉取最新的版本，若存在 tag，则优先使用。</td></tr><tr><td>go get golang.org/x/text@master</td><td>拉取 master 分支的最新 commit。</td></tr><tr><td>go get golang.org/x/<a href="mailto:text@v0.3.2">text@v0.3.2</a></td><td>拉取 tag 为 v0.3.2 的 commit。</td></tr><tr><td>go get golang.org/x/text@342b2e</td><td>拉取 hash 为 342b231 的 commit，最终会被转换为 v0.3.2。</td></tr></tbody></table><h3 id="go-get-子参数说明"><a href="#go-get-子参数说明" class="headerlink" title="go get 子参数说明"></a>go get 子参数说明</h3><table><thead><tr><th>子命令</th><th>描述</th></tr></thead><tbody><tr><td>-d</td><td>仅下载，不安装</td></tr><tr><td>-f</td><td>和 -u 配合，强制更新，不检查是否过期</td></tr><tr><td>-t</td><td>下载测试代码所需的依赖包</td></tr><tr><td>-u</td><td>更新包，包括他们的依赖项</td></tr><tr><td>-v</td><td>输出详细信息</td></tr><tr><td>insecure</td><td>使用 http 等非安全协议</td></tr></tbody></table><h2 id="修改项目模块的版本依赖关系"><a href="#修改项目模块的版本依赖关系" class="headerlink" title="修改项目模块的版本依赖关系"></a>修改项目模块的版本依赖关系</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go mod edit <span class="token parameter variable">-replace</span><span class="token operator">=</span><span class="token operator">&lt;</span>老版本<span class="token operator">&gt;=</span><span class="token operator">&lt;</span>需要替换的版本<span class="token operator">&gt;</span><span class="token comment"># 比如</span>go mod edit <span class="token parameter variable">-replace</span><span class="token operator">=</span>demo-package@v1.0.0<span class="token operator">=</span>demo-package@v2.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="go-list-命令以及参数"><a href="#go-list-命令以及参数" class="headerlink" title="go list 命令以及参数"></a>go list 命令以及参数</h2><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-f</td><td>用于查看对应依赖结构体中的指定的字段，其默认值就是 <code>{{.ImportPath}}</code>，也就是导入路径，因此我们一般不需要进行调整</td></tr><tr><td>-json</td><td>显示的格式，若不指定该选项，则会一行行输出。</td></tr><tr><td>-u</td><td>显示能够升级的模块信息</td></tr><tr><td>-m</td><td>显示当前项目所依赖的全部模块</td></tr></tbody></table><p>比如查看 <code>gin</code> 框架的版本</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go list <span class="token parameter variable">-m</span> <span class="token parameter variable">-versions</span> <span class="token parameter variable">-json</span> github.com/gin-gonic/gin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>输出如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">{</span><span class="token string">"Path"</span><span class="token builtin class-name">:</span> <span class="token string">"github.com/gin-gonic/gin"</span>,<span class="token string">"Version"</span><span class="token builtin class-name">:</span> <span class="token string">"v1.7.7"</span>,<span class="token string">"Versions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"v1.1.1"</span>,<span class="token string">"v1.1.2"</span>,<span class="token string">"v1.1.3"</span>,<span class="token string">"v1.1.4"</span>,<span class="token string">"v1.3.0"</span>,<span class="token string">"v1.4.0"</span>,<span class="token string">"v1.5.0"</span>,<span class="token string">"v1.6.0"</span>,<span class="token string">"v1.6.1"</span>,<span class="token string">"v1.6.2"</span>,<span class="token string">"v1.6.3"</span>,<span class="token string">"v1.7.0"</span>,<span class="token string">"v1.7.1"</span>,<span class="token string">"v1.7.2"</span>,<span class="token string">"v1.7.3"</span>,<span class="token string">"v1.7.4"</span>,<span class="token string">"v1.7.6"</span>,<span class="token string">"v1.7.7"</span><span class="token punctuation">]</span>,<span class="token string">"Time"</span><span class="token builtin class-name">:</span> <span class="token string">"2021-11-24T13:54:13Z"</span>,<span class="token string">"Dir"</span><span class="token builtin class-name">:</span> <span class="token string">"/Users/pudongping/go/pkg/mod/github.com/gin-gonic/gin@v1.7.7"</span>,<span class="token string">"GoMod"</span><span class="token builtin class-name">:</span> <span class="token string">"/Users/pudongping/go/pkg/mod/cache/download/github.com/gin-gonic/gin/@v/v1.7.7.mod"</span>,<span class="token string">"GoVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"1.13"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="私有库使用-Go-Modules-时"><a href="#私有库使用-Go-Modules-时" class="headerlink" title="私有库使用 Go Modules 时"></a>私有库使用 Go Modules 时</h2><ul><li>需要将 <code>GOPRIVATE</code> 环境变量设置成你私有库的域名</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># GO111MODULE 设置成 on 或者 auto 都行</span><span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span><span class="token string">"auto"</span><span class="token comment"># GOPROXY 最好设置成国内镜像地址</span><span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span><span class="token string">"https://goproxy.cn,direct"</span><span class="token comment"># GOPRIVATE 一定要设置成你的私有库域名，比如</span><span class="token assign-left variable">GOPRIVATE</span><span class="token operator">=</span><span class="token string">"gitlab.xxx.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>然后执行以下命令即可。<strong>注意：前提是你能够通过 ssh 公钥拉取代码</strong></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以下假设我私有 git 仓库地址为 gitlab.xxx.com:2222</span><span class="token comment"># 那么则需要调整为</span><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;&gt;</span> ~/.gitconfig</span>[url "ssh://git@gitlab.xxx.com:2222"]        insteadOf = https://gitlab.xxx.comEOF</span><span class="token comment"># 或者执行（效果都是一样的）</span><span class="token function">git</span> config <span class="token parameter variable">--global</span> url.<span class="token string">"ssh://git@gitlab.xxx.com:2222"</span>.insteadof <span class="token string">"https://gitlab.xxx.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试一下下载一个包</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 仅仅作为示范，此地址根本就不存在</span>go get <span class="token parameter variable">-v</span> gitlab.xxx.com/utils/arrayx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://segmentfault.com/a/1190000021854441">Go Modules 终极入门</a></li><li><a href="https://mp.weixin.qq.com/s/sWlTylbW2f1llbz232P2Fw">Go Modules 私有不合规库怎么解决引用问题</a></li><li><a href="https://studygolang.com/articles/35234">go modules 使用本地库、合规库、私有库</a></li><li><a href="https://studygolang.com/articles/35235">私有化仓库的 GO 模块使用实践</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hyperf 框架中将数据导出到 csv 文件中</title>
      <link href="posts/d0c857b0.html"/>
      <url>posts/d0c857b0.html</url>
      
        <content type="html"><![CDATA[<h1 id="Hyperf-框架中将数据导出到-csv-文件中"><a href="#Hyperf-框架中将数据导出到-csv-文件中" class="headerlink" title="Hyperf 框架中将数据导出到 csv 文件中"></a>Hyperf 框架中将数据导出到 csv 文件中</h1><p>直接看代码吧……</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>HttpServer<span class="token punctuation">\</span>Annotation<span class="token punctuation">\</span>AutoController</span><span class="token punctuation">;</span><span class="token comment">/** * @AutoController * Class TestController * @package App\Controller */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">TestController</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractController</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 请求测试：     * curl 'http://127.0.0.1:9511/test/csvExport' &gt;&gt; test.csv     *     * @return \Psr\Http\Message\ResponseInterface     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">csvExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$fileName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'test.csv'</span><span class="token punctuation">;</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token punctuation">[</span><span class="token string single-quoted-string">'阿猫'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'11'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token punctuation">[</span><span class="token string single-quoted-string">'阿狗'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'22'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token punctuation">[</span><span class="token string single-quoted-string">'阿猪'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'33'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token keyword">as</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$str</span> <span class="token operator">.=</span> <span class="token function">mb_convert_encoding</span><span class="token punctuation">(</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'GBK'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Hyperf<span class="token punctuation">\</span>HttpServer<span class="token punctuation">\</span>Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token operator">-&gt;</span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'content-type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'text/csv'</span><span class="token punctuation">)</span>            <span class="token operator">-&gt;</span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'content-disposition'</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"attachment; filename=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$fileName</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>            <span class="token operator">-&gt;</span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'content-transfer-encoding'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'binary'</span><span class="token punctuation">)</span>            <span class="token operator">-&gt;</span><span class="token function">withBody</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Hyperf<span class="token punctuation">\</span>HttpMessage<span class="token punctuation">\</span>Stream<span class="token punctuation">\</span>SwooleStream</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>    </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>第一种：<br>直接使用浏览器访问 <code>http://127.0.0.1:9511/test/csvExport</code></p><p>第二种：<br>直接通过 <code>curl</code> 命令行访问 <code>curl 'http://127.0.0.1:9511/test/csvExport' &gt;&gt; test.csv</code></p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hyperf </tag>
            
            <tag> Swoole </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang 开发环境搭建</title>
      <link href="posts/2417f014.html"/>
      <url>posts/2417f014.html</url>
      
        <content type="html"><![CDATA[<h1 id="Golang-开发环境搭建"><a href="#Golang-开发环境搭建" class="headerlink" title="Golang 开发环境搭建"></a>Golang 开发环境搭建</h1><h2 id="第一种方式：安装包安装"><a href="#第一种方式：安装包安装" class="headerlink" title="第一种方式：安装包安装"></a>第一种方式：安装包安装</h2><p>根据不同的操作系统安装对应的安装包：<a href="https://golang.google.cn/doc/install">https://golang.google.cn/doc/install</a>，如果是 mac 系统，还可以直接使用 Homebrew 安装</p><blockquote><p>直接通过 pkg 包安装的 go 卸载方式为： <code>sudo rm -rf /usr/local/go</code> 然后  <code>sudo rm -rf /etc/paths.d/go</code> 即可。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> go<span class="token comment"># 查看 go 版本号，以确定是否安装成功</span>go version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看环境变量</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token function">env</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>配置 go path</li></ul><p>需要为 Go 创建工作目录，在 $GOPATH 中创建 <code>bin、src、pkg</code> 三个文件夹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$GOPATH</span>/<span class="token punctuation">{</span>bin,src,pkg<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>设置代理</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 七牛 CDN</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span>  <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn,direct<span class="token comment"># 2. 阿里云</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://mirrors.aliyun.com/goproxy/,direct<span class="token comment"># 3. 官方</span>go <span class="token function">env</span> <span class="token parameter variable">-w</span>  <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.io,direct<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="第二种方式：源码包下载安装"><a href="#第二种方式：源码包下载安装" class="headerlink" title="第二种方式：源码包下载安装"></a>第二种方式：源码包下载安装</h2><ul><li><a href="https://golang.org/dl">国外官方镜像</a></li><li><a href="https://golang.google.cn/dl/">中国镜像</a></li><li><a href="https://studygolang.com/dl">golang 中文网</a></li></ul><h3 id="源码包安装"><a href="#源码包安装" class="headerlink" title="源码包安装"></a>源码包安装</h3><ul><li>下载 Linux 源码包</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://golang.google.cn/dl/go1.17.2.linux-amd64.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>解压源码包</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> go1.17.2.linux-amd64.tar.gz <span class="token parameter variable">-C</span> /usr/local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>添加配置变量 <code>vim ~/.bashrc</code></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置 GO 语言的路径</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOROOT</span><span class="token operator">=</span>/usr/local/go  <span class="token comment"># 表示源码包所在路径</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOPATH</span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/go  <span class="token comment"># 写 go 项目的工作路径，这里可以自定义</span><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$GOROOT</span>/bin:<span class="token variable">$GOPATH</span>/bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>写完之后保存，然后重新导入配置 <code>source ~/.bashrc</code></p><ul><li>如果使用的是 zsh 并且在 Mac 上使用 Homebrew 安装的 golang，那么</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置 GO 语言的路径</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOROOT</span><span class="token operator">=</span>/usr/local/Cellar/go/1.16.3/libexec<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOPATH</span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/glory/codes/golang  <span class="token comment"># 写 go 项目的工作路径，这里可以自定义</span><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$GOROOT</span>/bin:<span class="token variable">$GOPATH</span>/bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>写完之后保存，然后重新导入配置 <code>source ~/.zshrc</code></p><ul><li>检测开发环境</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 go 版本</span>go versiongo <span class="token parameter variable">--help</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h2><p>本地直接访问 go 文档</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">godoc <span class="token parameter variable">-http</span><span class="token operator">=</span>:6060<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果提示 <code>godoc</code> 命令不存在，则使用以下命令安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装方式一：</span>go get golang.org/x/tools<span class="token comment"># 安装方式二：</span><span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span>on  go <span class="token function">install</span> golang.org/x/tools/cmd/godoc@latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang http client 请求封装</title>
      <link href="posts/ce804739.html"/>
      <url>posts/ce804739.html</url>
      
        <content type="html"><![CDATA[<h1 id="Golang-http-client-请求封装"><a href="#Golang-http-client-请求封装" class="headerlink" title="Golang http client 请求封装"></a>Golang http client 请求封装</h1><p>使用原生 http 包简单的封装了一下 <code>get</code> 和 <code>post</code> 请求 <a href="https://github.com/pudongping/golang-tutorial/blob/main/project/http_client/httputil.go">源代码详见 Github</a></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> http_client<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"encoding/json"</span><span class="token string">"io/ioutil"</span><span class="token string">"net/http"</span><span class="token string">"net/url"</span><span class="token string">"strings"</span><span class="token string">"time"</span><span class="token string">"golang.org/x/net/context/ctxhttp"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">Get</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> res <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> headers <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>reqBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token function">AnyRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>reqBody<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">PostJSON</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> res <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> headers <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>reqBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Type"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"application/json"</span><span class="token keyword">return</span> <span class="token function">AnyRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>reqBody<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">PostForm</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> req url<span class="token punctuation">.</span>Values<span class="token punctuation">,</span> res <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> headers <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Type"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token keyword">return</span> <span class="token function">AnyRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">AnyRequest</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> req <span class="token builtin">string</span><span class="token punctuation">,</span> res <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> headers <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>responseObj <span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> responseBody <span class="token builtin">string</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>payload <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>request<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> headers <span class="token punctuation">{</span>request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 请求超时时间为 5 秒钟</span>client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span>Timeout<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token comment">// response, err := client.Do(request)</span>response<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctxhttp<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> client<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token keyword">defer</span> response<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>resBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token keyword">if</span> err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>resBody<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token keyword">return</span> response<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>resBody<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="调用示例"><a href="#调用示例" class="headerlink" title="调用示例"></a>调用示例</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> http_client<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token string">"net/url"</span><span class="token string">"testing"</span><span class="token string">"time"</span><span class="token string">"github.com/davecgh/go-spew/spew"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>Args    <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token string">`json:"args"`</span>Data    <span class="token builtin">string</span>            <span class="token string">`json:"data"`</span>Files   <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token string">`json:"files"`</span>Form    <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token string">`json:"form"`</span>Headers <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"headers"`</span>Json    <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token string">`json:"json"`</span>Method  <span class="token builtin">string</span>            <span class="token string">`json:"method"`</span>Origin  <span class="token builtin">string</span>            <span class="token string">`json:"origin"`</span>Url     <span class="token builtin">string</span>            <span class="token string">`json:"url"`</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">TestGet</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>reqUrl <span class="token operator">:=</span> <span class="token string">"https://httpbin.org/anything?name=alex&amp;age=18"</span>req <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"param1"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"param2"</span><span class="token punctuation">:</span> <span class="token string">"hello world"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token comment">// var res map[string]interface{}</span><span class="token keyword">var</span> res Result<span class="token boolean">_</span><span class="token punctuation">,</span> body<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Get</span><span class="token punctuation">(</span>reqUrl<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"有错误 %v \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// {</span><span class="token comment">//  "args": {</span><span class="token comment">//    "age": "18",</span><span class="token comment">//    "name": "alex"</span><span class="token comment">//  },</span><span class="token comment">//  "data": "{\"param1\":[1,2,3],\"param2\":\"hello world\",\"param3\":{\"param31\":\"value31\",\"param32\":12345,\"param33\":[11,33,44]}}",</span><span class="token comment">//  "files": {},</span><span class="token comment">//  "form": {},</span><span class="token comment">//  "headers": {</span><span class="token comment">//    "Accept-Encoding": "gzip",</span><span class="token comment">//    "Content-Length": "109",</span><span class="token comment">//    "Content-Type": "application/json",</span><span class="token comment">//    "Host": "httpbin.org",</span><span class="token comment">//    "Token": "123456",</span><span class="token comment">//    "User-Agent": "App/",</span><span class="token comment">//    "X-Amzn-Trace-Id": "Root=1-6358a5b4-5f9ceebc28bd7db245d4accc"</span><span class="token comment">//  },</span><span class="token comment">//  "json": {</span><span class="token comment">//    "param1": [</span><span class="token comment">//      1,</span><span class="token comment">//      2,</span><span class="token comment">//      3</span><span class="token comment">//    ],</span><span class="token comment">//    "param2": "hello world",</span><span class="token comment">//    "param3": {</span><span class="token comment">//      "param31": "value31",</span><span class="token comment">//      "param32": 12345,</span><span class="token comment">//      "param33": [</span><span class="token comment">//        11,</span><span class="token comment">//        33,</span><span class="token comment">//        44</span><span class="token comment">//      ]</span><span class="token comment">//    }</span><span class="token comment">//  },</span><span class="token comment">//  "method": "POST",</span><span class="token comment">//  "origin": "112.65.11.169",</span><span class="token comment">//  "url": "https://httpbin.org/anything?name=alex&amp;age=18"</span><span class="token comment">// }</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"=====&gt;"</span><span class="token punctuation">)</span>spew<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">TestPostJSON</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>reqUrl <span class="token operator">:=</span> <span class="token string">"https://httpbin.org/anything?name=alex&amp;age=18"</span>req <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"param1"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"param2"</span><span class="token punctuation">:</span> <span class="token string">"hello world"</span><span class="token punctuation">,</span><span class="token string">"param3"</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"param31"</span><span class="token punctuation">:</span> <span class="token string">"value31"</span><span class="token punctuation">,</span><span class="token string">"param32"</span><span class="token punctuation">:</span> <span class="token number">12345</span><span class="token punctuation">,</span><span class="token string">"param33"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token keyword">var</span> res <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>headers <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"App/"</span><span class="token punctuation">,</span><span class="token string">"Token"</span><span class="token punctuation">:</span>      <span class="token string">"123456"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token boolean">_</span><span class="token punctuation">,</span> body<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">PostJSON</span><span class="token punctuation">(</span>reqUrl<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"有错误 %v \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"=====&gt;"</span><span class="token punctuation">)</span>spew<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">TestPostForm</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>reqUrl <span class="token operator">:=</span> <span class="token string">"https://httpbin.org/anything?name=alex&amp;age=18"</span>req <span class="token operator">:=</span> url<span class="token punctuation">.</span>Values<span class="token punctuation">{</span><span class="token string">"param1"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"value11"</span><span class="token punctuation">,</span> <span class="token string">"value12"</span><span class="token punctuation">,</span> <span class="token string">"value13"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"param2"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"value21"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token keyword">var</span> res <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>headers <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"App/"</span><span class="token punctuation">,</span><span class="token string">"Token"</span><span class="token punctuation">:</span>      <span class="token string">"123456"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token boolean">_</span><span class="token punctuation">,</span> body<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">PostForm</span><span class="token punctuation">(</span>reqUrl<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"有错误 %v \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// {</span><span class="token comment">//  "args": {</span><span class="token comment">//    "age": "18",</span><span class="token comment">//    "name": "alex"</span><span class="token comment">//  },</span><span class="token comment">//  "data": "",</span><span class="token comment">//  "files": {},</span><span class="token comment">//  "form": {</span><span class="token comment">//    "param1": [</span><span class="token comment">//      "value11",</span><span class="token comment">//      "value12",</span><span class="token comment">//      "value13"</span><span class="token comment">//    ],</span><span class="token comment">//    "param2": "value21"</span><span class="token comment">//  },</span><span class="token comment">//  "headers": {</span><span class="token comment">//    "Accept-Encoding": "gzip",</span><span class="token comment">//    "Content-Length": "59",</span><span class="token comment">//    "Content-Type": "application/x-www-form-urlencoded",</span><span class="token comment">//    "Host": "httpbin.org",</span><span class="token comment">//    "Token": "123456",</span><span class="token comment">//    "User-Agent": "App/",</span><span class="token comment">//    "X-Amzn-Trace-Id": "Root=1-6358a4da-33ec2e5104331c413171db1b"</span><span class="token comment">//  },</span><span class="token comment">//  "json": null,</span><span class="token comment">//  "method": "POST",</span><span class="token comment">//  "origin": "112.65.11.169",</span><span class="token comment">//  "url": "https://httpbin.org/anything?name=alex&amp;age=18"</span><span class="token comment">// }</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"=====&gt;"</span><span class="token punctuation">)</span>spew<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">TestAnyRequest</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果将时间设置稍微短一点，比如说 2 秒，那么可能 delete 请求会成功，但是 put 请求可能会因为上下文超时而中断掉</span>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>reqUrl <span class="token operator">:=</span> <span class="token string">"https://httpbin.org/anything/123"</span><span class="token keyword">var</span> err <span class="token builtin">error</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"DELETE start"</span><span class="token punctuation">)</span><span class="token keyword">var</span> deleteRes <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token boolean">_</span><span class="token punctuation">,</span> deleteBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">AnyRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">,</span> reqUrl<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>deleteRes<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"DELETE 有错误 %v \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// {</span><span class="token comment">//  "args": {},</span><span class="token comment">//  "data": "",</span><span class="token comment">//  "files": {},</span><span class="token comment">//  "form": {},</span><span class="token comment">//  "headers": {</span><span class="token comment">//    "Accept-Encoding": "gzip",</span><span class="token comment">//    "Host": "httpbin.org",</span><span class="token comment">//    "User-Agent": "Go-http-client/2.0",</span><span class="token comment">//    "X-Amzn-Trace-Id": "Root=1-6358db58-76062ef533376565790e1d8a"</span><span class="token comment">//  },</span><span class="token comment">//  "json": null,</span><span class="token comment">//  "method": "DELETE",</span><span class="token comment">//  "origin": "112.65.11.169",</span><span class="token comment">//  "url": "https://httpbin.org/anything/123"</span><span class="token comment">// }</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>deleteBody<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"DELETE =====&gt;"</span><span class="token punctuation">)</span>spew<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span>deleteRes<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"DELETE end"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"============================&gt;"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"PUT start"</span><span class="token punctuation">)</span><span class="token keyword">var</span> putRes <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>putReq <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"param1"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"param2"</span><span class="token punctuation">:</span> <span class="token string">"value2"</span><span class="token punctuation">,</span><span class="token string">"param3"</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span><span class="token punctuation">}</span>putPayload<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>putReq<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"PUT 有错误 %v \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">}</span>putHeaders <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span><span class="token string">"Token"</span><span class="token punctuation">:</span>        <span class="token string">"1234"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token boolean">_</span><span class="token punctuation">,</span> putBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">AnyRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span> reqUrl<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>putPayload<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>putRes<span class="token punctuation">,</span> putHeaders<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"PUT 有错误 %v \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// {</span><span class="token comment">//  "args": {},</span><span class="token comment">//  "data": "{\"param1\":[11,22,33],\"param2\":\"value2\",\"param3\":123}",</span><span class="token comment">//  "files": {},</span><span class="token comment">//  "form": {},</span><span class="token comment">//  "headers": {</span><span class="token comment">//    "Accept-Encoding": "gzip",</span><span class="token comment">//    "Content-Length": "52",</span><span class="token comment">//    "Content-Type": "application/json",</span><span class="token comment">//    "Host": "httpbin.org",</span><span class="token comment">//    "Token": "1234",</span><span class="token comment">//    "User-Agent": "Go-http-client/2.0",</span><span class="token comment">//    "X-Amzn-Trace-Id": "Root=1-6358de6f-44d849be16f5a4c477b07616"</span><span class="token comment">//  },</span><span class="token comment">//  "json": {</span><span class="token comment">//    "param1": [</span><span class="token comment">//      11,</span><span class="token comment">//      22,</span><span class="token comment">//      33</span><span class="token comment">//    ],</span><span class="token comment">//    "param2": "value2",</span><span class="token comment">//    "param3": 123</span><span class="token comment">//  },</span><span class="token comment">//  "method": "PUT",</span><span class="token comment">//  "origin": "112.65.11.169",</span><span class="token comment">//  "url": "https://httpbin.org/anything/123"</span><span class="token comment">// }</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>putBody<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"PUT =====&gt;"</span><span class="token punctuation">)</span>spew<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span>putRes<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"PUT end"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
            <tag> Http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang 时间操作大全</title>
      <link href="posts/d0937fdd.html"/>
      <url>posts/d0937fdd.html</url>
      
        <content type="html"><![CDATA[<h1 id="Golang-时间操作大全"><a href="#Golang-时间操作大全" class="headerlink" title="Golang 时间操作大全"></a>Golang 时间操作大全</h1><p><a href="https://github.com/pudongping/golang-tutorial/blob/main/project/time_helper/time_explore.go">源代码详见 GitHub</a></p><h2 id="获取时间"><a href="#获取时间" class="headerlink" title="获取时间"></a>获取时间</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 获取当前时间</span>now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 ====&gt; 2022-10-24 23:36:33.47472 +0800 CST m=+0.000077400 typeof ===&gt; time.Time</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> now<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token comment">// 获取当前时间的年、月、日、时、分、秒、纳秒、微妙、毫秒</span>year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间年月日 ====&gt; [2022][October][24] typeof ===&gt; [int][time.Month][int]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间年月日 ====&gt; [%v][%v][%v] typeof ===&gt; [%T][%T][%T] \n"</span><span class="token punctuation">,</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">,</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">)</span>nowYear <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Year</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间年 ====&gt; 2022 typeof ===&gt; int</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间年 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowYear<span class="token punctuation">,</span> nowYear<span class="token punctuation">)</span>nowMonth <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Month</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间月 ====&gt; October typeof ===&gt; time.Month</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间月 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowMonth<span class="token punctuation">,</span> nowMonth<span class="token punctuation">)</span>nowDay <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间日 ====&gt; 24 typeof ===&gt; int</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间日 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowDay<span class="token punctuation">,</span> nowDay<span class="token punctuation">)</span>hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间时分秒 ====&gt; [23][36][33] typeof ===&gt; [int][int][int]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间时分秒 ====&gt; [%v][%v][%v] typeof ===&gt; [%T][%T][%T] \n"</span><span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">)</span>nowHour <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间时 ====&gt; 23 typeof ===&gt; int</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间时 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowHour<span class="token punctuation">,</span> nowHour<span class="token punctuation">)</span>nowMinute <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间分 ====&gt; 36 typeof ===&gt; int</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间分 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowMinute<span class="token punctuation">,</span> nowMinute<span class="token punctuation">)</span>nowSecond <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间秒 ====&gt; 33 typeof ===&gt; int</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间秒 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowSecond<span class="token punctuation">,</span> nowSecond<span class="token punctuation">)</span><span class="token comment">// 1秒(s) ＝1000毫秒(ms)</span><span class="token comment">// 1毫秒(ms)＝1000微秒 (us) ==&gt; Milliseconds ==&gt; 毫秒</span><span class="token comment">// 1微秒(us)＝1000纳秒 (ns)  ==&gt; Microseconds  ==&gt; 微秒</span><span class="token comment">// 1纳秒(ns)＝1000皮秒 (ps)  ==&gt; Nanoseconds  ==&gt; 纳秒</span>nowNanosecond <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Nanosecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间纳秒 ====&gt; 474905000 typeof ===&gt; int</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间纳秒 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowNanosecond<span class="token punctuation">,</span> nowNanosecond<span class="token punctuation">)</span><span class="token comment">// 获取当前时间戳</span>nowUnix <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间时间戳（秒级别） ====&gt; 1666625793 typeof ===&gt; int64</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间时间戳（秒级别） ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowUnix<span class="token punctuation">,</span> nowUnix<span class="token punctuation">)</span>nowUnixNano <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前时间时间戳（纳秒级别） ====&gt; 1666625793474909000 typeof ===&gt; int64</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间时间戳（纳秒级别） ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> nowUnixNano<span class="token punctuation">,</span> nowUnixNano<span class="token punctuation">)</span>weekDay <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Weekday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前星期几 ====&gt; Monday typeof ===&gt; time.Weekday</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前星期几 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> weekDay<span class="token punctuation">,</span> weekDay<span class="token punctuation">)</span>yearDay <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">YearDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前是一年中对应的第几天 ====&gt; 297 typeof ===&gt; int</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前是一年中对应的第几天 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> yearDay<span class="token punctuation">,</span> yearDay<span class="token punctuation">)</span>location <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Location</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 当前用的时区为 ====&gt; Local typeof ===&gt; *time.Location</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前用的时区为 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> location<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="时间转化"><a href="#时间转化" class="headerlink" title="时间转化"></a>时间转化</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 格式化时间</span>ymdhis <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 ====&gt; 2022-10-24 23:40:31 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> ymdhis<span class="token punctuation">,</span> ymdhis<span class="token punctuation">)</span>ymdhis1 <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 ====&gt; 2022-10-24 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> ymdhis1<span class="token punctuation">,</span> ymdhis1<span class="token punctuation">)</span>ymdhis2 <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"20060102"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 ====&gt; 20221024 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> ymdhis2<span class="token punctuation">,</span> ymdhis2<span class="token punctuation">)</span>ymdhis3 <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 ====&gt; 23:40:31 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> ymdhis3<span class="token punctuation">,</span> ymdhis3<span class="token punctuation">)</span>ymdhis4 <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"150405"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 ====&gt; 234031 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> ymdhis4<span class="token punctuation">,</span> ymdhis4<span class="token punctuation">)</span>y <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间年 ====&gt; 2022 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间年 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> y<span class="token punctuation">)</span>m <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"01"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间月 ====&gt; 10 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间月 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> m<span class="token punctuation">)</span>d <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"02"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间日 ====&gt; 24 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间日 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> d<span class="token punctuation">)</span>h <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"15"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间时 ====&gt; 23 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间时 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> h<span class="token punctuation">)</span>i <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"04"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间分 ====&gt; 40 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间分 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> i<span class="token punctuation">)</span>s <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间秒 ====&gt; 31 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间秒 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token comment">// 时间戳转时间格式</span><span class="token keyword">var</span> timeUnix <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">1666599090</span>goTimeUnix <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>timeUnix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">// 已知时间戳转 go 格式时间 ====&gt; 2022-10-24 16:11:30 +0800 CST typeof ===&gt; time.Time</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"已知时间戳转 go 格式时间 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> goTimeUnix<span class="token punctuation">,</span> goTimeUnix<span class="token punctuation">)</span>goTimeUnixFormat <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>timeUnix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 已知时间戳转 ymdhis 格式时间 ====&gt; 2022-10-24 16:11:30 typeof ===&gt; string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"已知时间戳转 ymdhis 格式时间 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> goTimeUnixFormat<span class="token punctuation">,</span> goTimeUnixFormat<span class="token punctuation">)</span><span class="token comment">// 获取指定时间的时间戳</span>dateUnix <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Local<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 2022-10-24 16:11:30 的时间戳为 ====&gt; 1666599090 typeof ===&gt; int64</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"2022-10-24 16:11:30 的时间戳为 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> dateUnix<span class="token punctuation">,</span> dateUnix<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="时间计算"><a href="#时间计算" class="headerlink" title="时间计算"></a>时间计算</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 获取当天 0 时 0 分 0 秒的时间戳</span>currentTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">.</span><span class="token function">Year</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentTime<span class="token punctuation">.</span><span class="token function">Month</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentTime<span class="token punctuation">.</span><span class="token function">Day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> currentTime<span class="token punctuation">.</span><span class="token function">Location</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 当天 0 时 0 分 0 秒的时间戳 ====&gt; 2022-10-24 00:00:00 +0800 CST typeof ===&gt; time.Time</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当天 0 时 0 分 0 秒的时间戳 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token comment">// 当天 0 时 0 分 0 秒的时间 ====&gt; 2022-10-24 00:00:00</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当天 0 时 0 分 0 秒的时间 ====&gt; %v \n"</span><span class="token punctuation">,</span> startTime<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 获取当天 23 时 59 分 59 秒的时间戳</span>endTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">.</span><span class="token function">Year</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentTime<span class="token punctuation">.</span><span class="token function">Month</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentTime<span class="token punctuation">.</span><span class="token function">Day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> currentTime<span class="token punctuation">.</span><span class="token function">Location</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 当天 23 时 59 分 59 秒的时间戳 ====&gt; 2022-10-24 23:59:59 +0800 CST typeof ===&gt; time.Time</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当天 23 时 59 分 59 秒的时间戳 ====&gt; %v typeof ===&gt; %T \n"</span><span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token comment">// 当天 23 时 59 分 59 秒的时间 ====&gt; 2022-10-24 23:59:59</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当天 23 时 59 分 59 秒的时间 ====&gt; %v \n"</span><span class="token punctuation">,</span> endTime<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 不超过 24 小时的时间计算</span>currentYmdHis <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 获取 1 秒钟前的时间</span>t1<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"-1s"</span><span class="token punctuation">)</span>r1 <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 2022-10-24 23:44:12 ===&gt; 1 秒钟前的时间 ===&gt; 2022-10-24 23:44:11</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 %v ===&gt; 1 秒钟前的时间 ===&gt; %v \n"</span><span class="token punctuation">,</span> currentYmdHis<span class="token punctuation">,</span> r1<span class="token punctuation">)</span>t2<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"2h"</span><span class="token punctuation">)</span>r2 <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 2022-10-24 23:44:12 ===&gt; 2 小时后的时间 ===&gt; 2022-10-25 01:44:12</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 %v ===&gt; 2 小时后的时间 ===&gt; %v \n"</span><span class="token punctuation">,</span> currentYmdHis<span class="token punctuation">,</span> r2<span class="token punctuation">)</span>t3<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"1h2m30s"</span><span class="token punctuation">)</span>r3 <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 2022-10-24 23:44:12 ===&gt; 1 小时 2 分 30 秒后的时间 ===&gt; 2022-10-25 00:46:42</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 %v ===&gt; 1 小时 2 分 30 秒后的时间 ===&gt; %v \n"</span><span class="token punctuation">,</span> currentYmdHis<span class="token punctuation">,</span> r3<span class="token punctuation">)</span><span class="token comment">// 计算两个时间相差多少</span>t4<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"1h"</span><span class="token punctuation">)</span>r4 <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>t4 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 注意：这里是 2 小时后的时间</span>t5<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"-1h30m"</span><span class="token punctuation">)</span>r5 <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>t5<span class="token punctuation">)</span><span class="token comment">// 相差 12600 秒</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"相差 %v 秒 \n"</span><span class="token punctuation">,</span> r4<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>r5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 相差 210 分钟</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"相差 %v 分钟 \n"</span><span class="token punctuation">,</span> r4<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>r5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Minutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 相差 3.5 小时</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"相差 %v 小时 \n"</span><span class="token punctuation">,</span> r4<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>r5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 相差 0.14583333333333334 天</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"相差 %v 天 \n"</span><span class="token punctuation">,</span> r4<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>r5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token comment">// 超过 24 小时之外的时间计算</span>t6 <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">AddDate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>r6 <span class="token operator">:=</span> t6<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 2022-10-24 23:44:12 ===&gt; 2 个月 1 天后的时间 ===&gt; 2022-12-25 23:44:12</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 %v ===&gt; 2 个月 1 天后的时间 ===&gt; %v \n"</span><span class="token punctuation">,</span> currentYmdHis<span class="token punctuation">,</span> r6<span class="token punctuation">)</span>t7 <span class="token operator">:=</span> currentTime<span class="token punctuation">.</span><span class="token function">AddDate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>r7 <span class="token operator">:=</span> t7<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间 2022-10-24 23:44:12 ===&gt; 5 天前的时间 ===&gt; 2022-10-19 23:44:12</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间 %v ===&gt; 5 天前的时间 ===&gt; %v \n"</span><span class="token punctuation">,</span> currentYmdHis<span class="token punctuation">,</span> r7<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="时间判断比较"><a href="#时间判断比较" class="headerlink" title="时间判断比较"></a>时间判断比较</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go">now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>s <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">)</span><span class="token comment">// 当前时间为 2022-11-12 19:45:36</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"当前时间为 %s \n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token comment">// 时间比较</span><span class="token comment">// 尽可能的使用 time.ParseInLocation() 方法，因为可以手动指定时区</span><span class="token comment">// 而少用 time.Parse() 方法，因为默认的时区为 UTC（零时区）</span>startTime<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">,</span> <span class="token string">"2022-10-24 18:18:00"</span><span class="token punctuation">)</span>isBefore <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>isAfter <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>isEqual <span class="token operator">:=</span> startTime<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token comment">// 2022-10-24 18:18:00 是否在 2022-11-12 19:45:36 之前？ true</span><span class="token comment">// 是否在 2022-11-12 19:45:36 之后？ false</span><span class="token comment">// 还是相等？ false</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"2022-10-24 18:18:00 是否在 %s 之前？ %v \n 是否在 %s 之后？ %v \n还是相等？ %v\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> isBefore<span class="token punctuation">,</span> s<span class="token punctuation">,</span> isAfter<span class="token punctuation">,</span> isEqual<span class="token punctuation">)</span>sTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">// time.Since(t Time) Duration 【当前时间与时间 t 的时间差（也就是当前时间减去 t 的差）】</span><span class="token comment">// time.Until(t Time) Duration 【时间 t 与当前时间的差（也就是时间 t 减去当前时间）】</span><span class="token comment">// 程序开始执行时间为：1666626449 结束执行时间为：1666626452 执行了多长时间：3.003903595s 秒钟</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"程序开始执行时间为：%v 结束执行时间为：%v 执行了多长时间：%v 秒钟 \n"</span><span class="token punctuation">,</span> sTime<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>sTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 程序在 -3.004024213s 秒钟前执行</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"程序在 %v 秒钟前执行 \n"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>sTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="调整时区"><a href="#调整时区" class="headerlink" title="调整时区"></a>调整时区</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 转换时间时，指定时区</span><span class="token keyword">var</span> timeParseInTimeZone <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> timezone <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>chinaTimezone<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">LoadLocation</span><span class="token punctuation">(</span>timezone<span class="token punctuation">)</span> <span class="token comment">// 指定时区</span><span class="token comment">// 尽可能的使用 time.ParseInLocation() 方法，因为可以手动指定时区</span><span class="token comment">// 而少用 time.Parse() 方法，因为默认的时区为 UTC（零时区）</span>t<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseInLocation</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> chinaTimezone<span class="token punctuation">)</span><span class="token keyword">return</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">In</span><span class="token punctuation">(</span>chinaTimezone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>layout<span class="token punctuation">)</span><span class="token punctuation">}</span>layout <span class="token operator">:=</span> <span class="token string">"2006-01-02 15:04:05"</span>inputTime <span class="token operator">:=</span> <span class="token string">"2022-10-24 21:56:59"</span><span class="token comment">// 你本机系统得有你设置的时区才行，不然也会走的你系统默认设定的时区</span>t1 <span class="token operator">:=</span> <span class="token function">timeParseInTimeZone</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> <span class="token string">"Asia/Shanghai"</span><span class="token punctuation">)</span>t2 <span class="token operator">:=</span> <span class="token function">timeParseInTimeZone</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> <span class="token string">"Asia/Chongqing"</span><span class="token punctuation">)</span>t3 <span class="token operator">:=</span> <span class="token function">timeParseInTimeZone</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> <span class="token string">"PRC"</span><span class="token punctuation">)</span>              <span class="token comment">// 中华人民共和国</span>t4 <span class="token operator">:=</span> <span class="token function">timeParseInTimeZone</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> <span class="token string">"Asia/Singapore"</span><span class="token punctuation">)</span>   <span class="token comment">// 新加坡(UTC+08:00)</span>t5 <span class="token operator">:=</span> <span class="token function">timeParseInTimeZone</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> <span class="token string">"Asia/Tokyo"</span><span class="token punctuation">)</span>       <span class="token comment">// 东京(UTC+09:00)</span>t6 <span class="token operator">:=</span> <span class="token function">timeParseInTimeZone</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> <span class="token string">"Etc/GMT"</span><span class="token punctuation">)</span>          <span class="token comment">// 协调世界时(UTC+00:00)</span>t7 <span class="token operator">:=</span> <span class="token function">timeParseInTimeZone</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">,</span> <span class="token string">"Pacific/Honolulu"</span><span class="token punctuation">)</span> <span class="token comment">// 夏威夷(UTC-10:00)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Asia/Shanghai ====&gt; %s \n"</span><span class="token punctuation">,</span> t1<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Asia/Chongqing ====&gt; %s \n"</span><span class="token punctuation">,</span> t2<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"PRC ====&gt; %s \n"</span><span class="token punctuation">,</span> t3<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Asia/Singapore ====&gt; %s \n"</span><span class="token punctuation">,</span> t4<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Asia/Tokyo ====&gt; %s \n"</span><span class="token punctuation">,</span> t5<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Etc/GMT ====&gt; %s \n"</span><span class="token punctuation">,</span> t6<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Pacific/Honolulu ====&gt; %s \n"</span><span class="token punctuation">,</span> t7<span class="token punctuation">)</span><span class="token comment">// 不设置时区时，默认走的 UTC （零时区）</span>tt<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>layout<span class="token punctuation">,</span> inputTime<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>layout<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang 使用 olivere/elastic 客户端操作 ElasticSearch</title>
      <link href="posts/a443aa.html"/>
      <url>posts/a443aa.html</url>
      
        <content type="html"><![CDATA[<h1 id="Golang-使用-olivere-elastic-客户端操作-ElasticSearch"><a href="#Golang-使用-olivere-elastic-客户端操作-ElasticSearch" class="headerlink" title="Golang 使用 olivere/elastic 客户端操作 ElasticSearch"></a>Golang 使用 olivere/elastic 客户端操作 ElasticSearch</h1><p><code>olivere/elastic</code> 插件包，算是 go 语言中比较通用的操作 ElasticSearch 的客户端了，这里使用的是 <code>v7</code> 版本。</p><h2 id="下载-olivere-elastic-包"><a href="#下载-olivere-elastic-包" class="headerlink" title="下载 olivere/elastic 包"></a>下载 <code>olivere/elastic</code> 包</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get github.com/olivere/elastic/v7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>这里直接以代码 demo 的形式呈现，具体含义，请见注释。若有错误，还望指正，感谢！</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">/**GitHub： https://github.com/olivere/elastic官方文档示例： https://olivere.github.io/elastic/下载：go get github.com/olivere/elastic/v7*/</span><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"encoding/json"</span><span class="token string">"errors"</span><span class="token string">"fmt"</span><span class="token string">"sync"</span><span class="token string">"time"</span><span class="token string">"github.com/olivere/elastic/v7"</span><span class="token punctuation">)</span><span class="token keyword">var</span> <span class="token punctuation">(</span>ESClient <span class="token operator">*</span>elastic<span class="token punctuation">.</span>Clientonce     sync<span class="token punctuation">.</span>Once<span class="token punctuation">)</span><span class="token keyword">type</span> RcpGoodsImgChecksES <span class="token keyword">struct</span> <span class="token punctuation">{</span>AppName     <span class="token builtin">int</span>    <span class="token string">`json:"app_name"`</span>GoodsId     <span class="token builtin">string</span> <span class="token string">`json:"goods_id"`</span>SiteId      <span class="token builtin">int</span>    <span class="token string">`json:"site_id"`</span>CheckStatus <span class="token builtin">int</span>    <span class="token string">`json:"check_status"`</span>CreatedAt   <span class="token builtin">int</span>    <span class="token string">`json:"created_at"`</span>UpdatedAt   <span class="token builtin">int</span>    <span class="token string">`json:"updated_at"`</span><span class="token punctuation">}</span><span class="token keyword">const</span> RcpGoodsImgChecksESIndex <span class="token operator">=</span> <span class="token string">"rcp_goods_img_checks"</span><span class="token keyword">const</span> RcpGoodsImgChecksESMapping <span class="token operator">=</span> <span class="token string">`{"mappings":{"properties":{"app_name":{"type": "integer"},"goods_id":{"type": "keyword"},"site_id":{"type": "keyword"},"check_status":{"type": "integer"},"created_at":{"type": "date"},"updated_at":{"type": "date"}}}}`</span><span class="token keyword">const</span> esUrl <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:9200"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">var</span> err <span class="token builtin">error</span><span class="token comment">// 创建 es 连接</span><span class="token function">ConnectES</span><span class="token punctuation">(</span><span class="token comment">// 如果 es 是通过 docker 安装，如果不设置 `elastic.SetSniff(false)` 那么则会报错</span>elastic<span class="token punctuation">.</span><span class="token function">SetSniff</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">// 允许指定弹性是否应该定期检查集群，默认为 true, 会把请求 http://ip:port/_nodes/http，并将其返回的 publish_address 作为请求路径</span>elastic<span class="token punctuation">.</span><span class="token function">SetURL</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>esUrl<span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 服务地址</span>elastic<span class="token punctuation">.</span><span class="token function">SetBasicAuth</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>       <span class="token comment">// 设置认证账号和密码</span><span class="token comment">// elastic.SetHealthcheckInterval(time.Second*5), // 心跳检查，间隔时间</span><span class="token comment">// elastic.SetGzip(true),                         // 启用 gzip 压缩</span><span class="token punctuation">)</span><span class="token comment">// Ping the Elasticsearch server to get e.g. the version number</span>info<span class="token punctuation">,</span> code<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Ping</span><span class="token punctuation">(</span>esUrl<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token comment">// Handle error</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// Elasticsearch returned with code 200 and version 7.9.3</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Elasticsearch returned with code %d and version %s\n"</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> info<span class="token punctuation">.</span>Version<span class="token punctuation">.</span>Number<span class="token punctuation">)</span><span class="token comment">// 直接打印出 es 版本号</span>esVersion<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">ElasticsearchVersion</span><span class="token punctuation">(</span>esUrl<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// Elasticsearch version 7.9.3</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Elasticsearch version %s\n"</span><span class="token punctuation">,</span> esVersion<span class="token punctuation">)</span><span class="token comment">// 删除索引</span><span class="token comment">// testDeleteIndex()</span><span class="token comment">// 判断索引是否存在，如果不存在时，则创建</span>err <span class="token operator">=</span> <span class="token function">CreateIndexIfNotExists</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">,</span> RcpGoodsImgChecksESMapping<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="简单封装的一些常见方法"><a href="#简单封装的一些常见方法" class="headerlink" title="简单封装的一些常见方法"></a>简单封装的一些常见方法</h2><h3 id="创建-es-连接"><a href="#创建-es-连接" class="headerlink" title="创建 es 连接"></a>创建 es 连接</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ConnectES 创建 es 连接</span><span class="token keyword">func</span> <span class="token function">ConnectES</span><span class="token punctuation">(</span>options <span class="token operator">...</span>elastic<span class="token punctuation">.</span>ClientOptionFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// client, err := elastic.NewClient(elastic.SetSniff(false), elastic.SetURL("http://127.0.0.1:9200"))</span><span class="token keyword">var</span> err <span class="token builtin">error</span>ESClient<span class="token punctuation">,</span> err <span class="token operator">=</span> elastic<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>options<span class="token operator">...</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Ping</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>PingResult<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> ESClient<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="索引不存在时，创建索引"><a href="#索引不存在时，创建索引" class="headerlink" title="索引不存在时，创建索引"></a>索引不存在时，创建索引</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// CreateIndexIfNotExists 索引不存在时，创建索引</span><span class="token comment">// index 索引名称</span><span class="token comment">// mapping 数据类型</span><span class="token keyword">func</span> <span class="token function">CreateIndexIfNotExists</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> mapping <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>exists<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">IndexExists</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> err<span class="token punctuation">}</span><span class="token keyword">if</span> exists <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span>info<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">CreateIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BodyString</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token comment">// info, err := ESClient.CreateIndex(index).Do(ctx)  // 如果只是想创建索引时，那么就不需要 BodyString() 方法</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> err<span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token operator">!</span>info<span class="token punctuation">.</span>Acknowledged <span class="token punctuation">{</span><span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"ES 创建索引 [%s] 失败"</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// DeleteIndex 删除索引</span><span class="token comment">// index 索引名称</span><span class="token keyword">func</span> <span class="token function">DeleteIndex</span><span class="token punctuation">(</span>index <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>IndicesDeleteResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>info<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">DeleteIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token operator">!</span>info<span class="token punctuation">.</span>Acknowledged <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"ES 删除索引 [%s] 失败"</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> info<span class="token punctuation">,</span> err<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="单条添加"><a href="#单条添加" class="headerlink" title="单条添加"></a>单条添加</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// CreateDoc 单条添加</span><span class="token comment">// index 索引</span><span class="token comment">// id 文档 id（可以直接为空字符串，当实参为空字符串时，es 会主动随机生成）</span><span class="token comment">// body 需要添加的内容</span><span class="token keyword">func</span> <span class="token function">CreateDoc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">,</span> body <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>IndexResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>client <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token string">""</span> <span class="token operator">!=</span> id <span class="token punctuation">{</span>client <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">BodyJson</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="单条更新"><a href="#单条更新" class="headerlink" title="单条更新"></a>单条更新</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// UpdateDoc 单条更新</span><span class="token comment">// index 索引</span><span class="token comment">// id 记录 id</span><span class="token comment">// body 需要更新的内容 （建议只使用 map[string]interface{} 进行更新指定字段且需要注意 map 中的 key 需要和 es 中的 key 完全匹配，否则 es 会认为新增字段，不要使用 struct 否则会将某些值初始化零值）</span><span class="token keyword">func</span> <span class="token function">UpdateDoc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">,</span> body <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>UpdateResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> ESClient<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Doc</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// DeleteDoc 删除文档</span><span class="token comment">// index 索引</span><span class="token comment">// id 需要删除的文档记录 id</span><span class="token keyword">func</span> <span class="token function">DeleteDoc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>DeleteResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> ESClient<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="批量添加"><a href="#批量添加" class="headerlink" title="批量添加"></a>批量添加</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// CreateBulkDoc 批量添加</span><span class="token comment">// index 索引</span><span class="token comment">// ids 需要新建的 id 数组（可以为空的字符串切片）</span><span class="token comment">// body 需要添加的内容</span><span class="token comment">// 需要注意：ids 和 body 的顺序要一一对应</span><span class="token keyword">func</span> <span class="token function">CreateBulkDoc</span><span class="token punctuation">(</span>index <span class="token builtin">string</span><span class="token punctuation">,</span> ids <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> body <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>BulkResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>bulkRequest <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Bulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> body <span class="token punctuation">{</span>tmp <span class="token operator">:=</span> vdoc <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewBulkIndexRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Doc</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>doc <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">Id</span><span class="token punctuation">(</span>ids<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>bulkRequest <span class="token operator">=</span> bulkRequest<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> bulkRequest<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// UpdateBulkDoc 批量更新</span><span class="token comment">// index 索引</span><span class="token comment">// ids 需要更新的 id 数组</span><span class="token comment">// body 需要更新的 id 对应的数据 （建议只使用 []map[string]interface{} 进行更新指定字段且需要注意 map 中的 key 需要和 es 中的 key 完全匹配，否则 es 会认为新增字段，不要使用 struct 否则会将某些值初始化零值）</span><span class="token comment">// 需要注意：ids 和 body 的顺序要一一对应</span><span class="token keyword">func</span> <span class="token function">UpdateBulkDoc</span><span class="token punctuation">(</span>index <span class="token builtin">string</span><span class="token punctuation">,</span> ids <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> body <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>BulkResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>bulkRequest <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Bulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> body <span class="token punctuation">{</span>tmp <span class="token operator">:=</span> vdoc <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewBulkUpdateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Id</span><span class="token punctuation">(</span>ids<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Doc</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DocAsUpsert</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>bulkRequest <span class="token operator">=</span> bulkRequest<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> bulkRequest<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// DeleteBulkDoc 批量删除</span><span class="token comment">// index 索引</span><span class="token comment">// ids 需要删除的 id 数组</span><span class="token keyword">func</span> <span class="token function">DeleteBulkDoc</span><span class="token punctuation">(</span>index <span class="token builtin">string</span><span class="token punctuation">,</span> ids <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>BulkResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>bulkRequest <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Bulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ids <span class="token punctuation">{</span>tmp <span class="token operator">:=</span> vreq <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewBulkDeleteRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Id</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>bulkRequest <span class="token operator">=</span> bulkRequest<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> bulkRequest<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="通过文档-id-取出数据"><a href="#通过文档-id-取出数据" class="headerlink" title="通过文档 id 取出数据"></a>通过文档 id 取出数据</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// FirstDoc 通过 id 取出数据</span><span class="token comment">// index 索引</span><span class="token comment">// id 需要取的文档记录 id</span><span class="token keyword">func</span> <span class="token function">FirstDoc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>elastic<span class="token punctuation">.</span>GetResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> ESClient<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="打印出查询条件"><a href="#打印出查询条件" class="headerlink" title="打印出查询条件"></a>打印出查询条件</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">PrintQuery</span><span class="token punctuation">(</span>src <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"开始打印参数 ====&gt;"</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">MarshalIndent</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"  "</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"打印参数结束 ====&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查询出数据"><a href="#查询出数据" class="headerlink" title="查询出数据"></a>查询出数据</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">querySearch</span><span class="token punctuation">(</span>query elastic<span class="token punctuation">.</span>Query<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> querySrc<span class="token punctuation">,</span> err <span class="token operator">:=</span> query<span class="token punctuation">.</span><span class="token function">Source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">PrintQuery</span><span class="token punctuation">(</span>querySrc<span class="token punctuation">)</span><span class="token punctuation">}</span>queryRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"查询到的结果总数为 %v \n"</span><span class="token punctuation">,</span> queryRet<span class="token punctuation">.</span><span class="token function">TotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> queryRet<span class="token punctuation">.</span>Hits<span class="token punctuation">.</span>Hits <span class="token punctuation">{</span><span class="token keyword">var</span> tmp RcpGoodsImgChecksESjson<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"已经命中查询的数据为 ==&gt; %+v \n %+v \n\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试方法"><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h3><h4 id="删除索引-1"><a href="#删除索引-1" class="headerlink" title="删除索引"></a>删除索引</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testDeleteIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 删除索引</span>deleteIndexRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">DeleteIndex</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// deleteIndexRet  ==&gt; &amp;{Acknowledged:true}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"deleteIndexRet  ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> deleteIndexRet<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testCreateDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 创建文档</span>now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>createDocRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateDoc</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">,</span> <span class="token string">"2_18_alex111"</span><span class="token punctuation">,</span> RcpGoodsImgChecksES<span class="token punctuation">{</span>AppName<span class="token punctuation">:</span>     <span class="token number">2</span><span class="token punctuation">,</span>GoodsId<span class="token punctuation">:</span>     <span class="token string">"alex111"</span><span class="token punctuation">,</span>SiteId<span class="token punctuation">:</span>      <span class="token number">18</span><span class="token punctuation">,</span>CheckStatus<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>CreatedAt<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span>UpdatedAt<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// CreateDoc ==&gt; &amp;{Index:rcp_goods_img_checks Type:_doc Id:2_18_alex111 Version:1 Result:created Shards:0xc00020c2c0 SeqNo:0 PrimaryTerm:1 Status:0 ForcedRefresh:false}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"CreateDoc ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> createDocRet<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="通过文档-id-的形式更新文档"><a href="#通过文档-id-的形式更新文档" class="headerlink" title="通过文档 id 的形式更新文档"></a>通过文档 id 的形式更新文档</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testUpdateDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 通过文档 id 的形式更新文档</span>updateDocRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">UpdateDoc</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">,</span> <span class="token string">"2_18_alex111"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"check_status"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"updated_at"</span><span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// UpdateDoc ==&gt; &amp;{Index:rcp_goods_img_checks Type:_doc Id:2_18_alex111 Version:2 Result:updated Shards:0xc0002bc280 SeqNo:1 PrimaryTerm:1 Status:0 ForcedRefresh:false GetResult:&lt;nil&gt;}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"UpdateDoc ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> updateDocRet<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="通过-Script-方式更新文档（单字段更新，借助文档-id-更新）"><a href="#通过-Script-方式更新文档（单字段更新，借助文档-id-更新）" class="headerlink" title="通过 Script 方式更新文档（单字段更新，借助文档 id 更新）"></a>通过 Script 方式更新文档（单字段更新，借助文档 id 更新）</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testUpdateDocScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 通过 Script 方式更新文档（单字段更新，借助文档 id 更新）</span>updateDocScript<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Id</span><span class="token punctuation">(</span><span class="token string">"2_18_alex111"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Script</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token string">"ctx._source.site_id=11"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// updateDocScript  ==&gt; &amp;{Index:rcp_goods_img_checks Type:_doc Id:2_18_alex111 Version:3 Result:updated Shards:0xc000098280 SeqNo:2 PrimaryTerm:1 Status:0 ForcedRefresh:false GetResult:&lt;nil&gt;}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"updateDocScript  ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> updateDocScript<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="通过条件-Script-方式更新文档（单字段更新，根据查询条件批量更新字段）"><a href="#通过条件-Script-方式更新文档（单字段更新，根据查询条件批量更新字段）" class="headerlink" title="通过条件 Script 方式更新文档（单字段更新，根据查询条件批量更新字段）"></a>通过条件 Script 方式更新文档（单字段更新，根据查询条件批量更新字段）</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testUpdateDocScriptQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 通过条件 Script 方式更新文档（单字段更新，根据查询条件批量更新字段）</span>updateDocScriptQuery<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">UpdateByQuery</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">NewTermQuery</span><span class="token punctuation">(</span><span class="token string">"goods_id"</span><span class="token punctuation">,</span> <span class="token string">"alex111"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Script</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">NewScript</span><span class="token punctuation">(</span><span class="token string">"ctx._source.check_status=23"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ProceedOnVersionConflict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// updateDocScriptQuery  ==&gt; &amp;{Header:map[] Took:47 SliceId:&lt;nil&gt; TimedOut:false Total:2 Updated:2 Created:0 Deleted:0 Batches:1 VersionConflicts:0 Noops:0 Retries:{Bulk:0 Search:0} Throttled: ThrottledMillis:0 RequestsPerSecond:-1 Canceled: ThrottledUntil: ThrottledUntilMillis:0 Failures:[]}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"updateDocScriptQuery  ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> updateDocScriptQuery<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="通过文档-id-查找文档"><a href="#通过文档-id-查找文档" class="headerlink" title="通过文档 id 查找文档"></a>通过文档 id 查找文档</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testFirstDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 通过文档 id 查找文档</span>firstDocRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">FirstDoc</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">,</span> <span class="token string">"2_18_alex111"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> firstDocRet<span class="token punctuation">.</span>Found <span class="token punctuation">{</span> <span class="token comment">// 表示找到了数据</span><span class="token comment">// FirstDoc ==&gt;  &amp;{Index:rcp_goods_img_checks Type:_doc Id:2_18_alex111 Uid: Routing: Parent: Version:0xc000282a10 SeqNo:0xc000282a18 PrimaryTerm:0xc000282a20 Source:[123 34 97 112 112 95 110 97 109 101 34 58 50 44 34 117 112 100 97 116 101 100 95 97 116 34 58 49 54 54 48 53 55 57 52 56 54 44 34 115 105 116 101 95 105 100 34 58 49 56 44 34 103 111 111 100 115 95 105 100 34 58 34 97 108 101 120 49 49 49 34 44 34 99 114 101 97 116 101 100 95 97 116 34 58 49 54 54 48 53 55 57 52 56 54 44 34 99 104 101 99 107 95 115 116 97 116 117 115 34 58 50 51 125] Found:true Fields:map[] Error:&lt;nil&gt;} Source: {"app_name":2,"updated_at":1660579486,"site_id":18,"goods_id":"alex111","created_at":1660579486,"check_status":23}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"FirstDoc ==&gt;  %+v Source: %+v \n\n"</span><span class="token punctuation">,</span> firstDocRet<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>firstDocRet<span class="token punctuation">.</span>Source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="通过文档-id-删除文档"><a href="#通过文档-id-删除文档" class="headerlink" title="通过文档 id 删除文档"></a>通过文档 id 删除文档</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testDeleteDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 通过文档 id 删除文档</span>deleteDocRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">DeleteDoc</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">,</span> <span class="token string">"2_18_alex111"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// DeleteDoc  ==&gt; &amp;{Index:rcp_goods_img_checks Type:_doc Id:2_18_alex111 Version:6 Result:deleted Shards:0xc00007e2c0 SeqNo:7 PrimaryTerm:1 Status:0 ForcedRefresh:false}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"DeleteDoc  ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> deleteDocRet<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="批量创建"><a href="#批量创建" class="headerlink" title="批量创建"></a>批量创建</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testCreateBulkDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 批量创建</span>createBulkDocRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CreateBulkDoc</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"h1"</span><span class="token punctuation">,</span> <span class="token string">"h2"</span><span class="token punctuation">,</span> <span class="token string">"h3"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>RcpGoodsImgChecksES<span class="token punctuation">{</span>AppName<span class="token punctuation">:</span>     <span class="token number">2</span><span class="token punctuation">,</span>GoodsId<span class="token punctuation">:</span>     <span class="token string">"h1_goods_id"</span><span class="token punctuation">,</span>SiteId<span class="token punctuation">:</span>      <span class="token number">17</span><span class="token punctuation">,</span>CheckStatus<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>CreatedAt<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span>UpdatedAt<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span>RcpGoodsImgChecksES<span class="token punctuation">{</span>AppName<span class="token punctuation">:</span>     <span class="token number">1</span><span class="token punctuation">,</span>GoodsId<span class="token punctuation">:</span>     <span class="token string">"h2_goods_id"</span><span class="token punctuation">,</span>SiteId<span class="token punctuation">:</span>      <span class="token number">19</span><span class="token punctuation">,</span>CheckStatus<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>CreatedAt<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span>UpdatedAt<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span>RcpGoodsImgChecksES<span class="token punctuation">{</span>AppName<span class="token punctuation">:</span>     <span class="token number">3</span><span class="token punctuation">,</span>GoodsId<span class="token punctuation">:</span>     <span class="token string">"h3_goods_id"</span><span class="token punctuation">,</span>SiteId<span class="token punctuation">:</span>      <span class="token number">19</span><span class="token punctuation">,</span>CheckStatus<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>CreatedAt<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span>UpdatedAt<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// CreateBulkDoc ==&gt; &amp;{Took:5 Errors:false Items:[map[index:0xc00019c200] map[index:0xc00019c280] map[index:0xc00019c300]]}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"CreateBulkDoc ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> createBulkDocRet<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="批量更新-1"><a href="#批量更新-1" class="headerlink" title="批量更新"></a>批量更新</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testUpdateBulkDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 批量更新</span>updateBulkDocRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">UpdateBulkDoc</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"h1"</span><span class="token punctuation">,</span> <span class="token string">"h3"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"check_status"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"updated_at"</span><span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"site_id"</span><span class="token punctuation">:</span>    <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token function">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// UpdateBulkDoc ==&gt; &amp;{Took:6 Errors:false Items:[map[update:0xc0001e2080] map[update:0xc0001e2100]]}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"UpdateBulkDoc ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> updateBulkDocRet<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="通过文档-id-批量删除"><a href="#通过文档-id-批量删除" class="headerlink" title="通过文档 id 批量删除"></a>通过文档 id 批量删除</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testDeleteBulkDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 通过文档 id 批量删除</span>deleteBulkDocRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">DeleteBulkDoc</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"h2"</span><span class="token punctuation">,</span> <span class="token string">"h3_goods_id"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"DeleteBulkDoc ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> deleteBulkDocRet<span class="token punctuation">)</span><span class="token comment">// DeleteBulkDoc ==&gt; &amp;{Took:36 Errors:false Items:[map[delete:0xc0000ea080] map[delete:0xc0000ea100]]}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="按照条件删除"><a href="#按照条件删除" class="headerlink" title="按照条件删除"></a>按照条件删除</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testDeleteByQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 按照条件删除</span>deleteDocByQuery<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">DeleteByQuery</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">NewRangeQuery</span><span class="token punctuation">(</span><span class="token string">"updated_at"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lte</span><span class="token punctuation">(</span><span class="token number">1660579923</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"deleteDocByQuery ==&gt; %+v \n\n"</span><span class="token punctuation">,</span> deleteDocByQuery<span class="token punctuation">)</span><span class="token comment">// deleteDocByQuery ==&gt; &amp;{Header:map[] Took:36 SliceId:&lt;nil&gt; TimedOut:false Total:3 Updated:0 Created:0 Deleted:3 Batches:1 VersionConflicts:0 Noops:0 Retries:{Bulk:0 Search:0} Throttled: ThrottledMillis:0 RequestsPerSecond:-1 Canceled: ThrottledUntil: ThrottledUntilMillis:0 Failures:[]}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="term"><a href="#term" class="headerlink" title="term"></a>term</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testTermQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// term</span>query1 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewTermQuery</span><span class="token punctuation">(</span><span class="token string">"goods_id"</span><span class="token punctuation">,</span> <span class="token string">"h2_goods_id"</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>query1<span class="token punctuation">)</span><span class="token comment">// 开始打印参数 ====&gt;</span><span class="token comment">// {</span><span class="token comment">//  "term": {</span><span class="token comment">//    "goods_id": "h2_goods_id"</span><span class="token comment">//  }</span><span class="token comment">// }</span><span class="token comment">// 打印参数结束 ====&gt;</span><span class="token comment">// 查询到的结果总数为 1</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:19 CheckStatus:4 CreatedAt:1660579860 UpdatedAt:1660579860}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="terms"><a href="#terms" class="headerlink" title="terms"></a>terms</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testTermsQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// terms [where goods_id in ('h3_goods_id', 'h2_goods_id')]</span>query2 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewTermsQuery</span><span class="token punctuation">(</span><span class="token string">"goods_id"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"h3_goods_id"</span><span class="token punctuation">,</span> <span class="token string">"h2_goods_id"</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>query2<span class="token punctuation">)</span><span class="token comment">// 开始打印参数 ====&gt;</span><span class="token comment">// {</span><span class="token comment">//  "terms": {</span><span class="token comment">//    "goods_id": [</span><span class="token comment">//      "h3_goods_id",</span><span class="token comment">//      "h2_goods_id"</span><span class="token comment">//    ]</span><span class="token comment">//  }</span><span class="token comment">// }</span><span class="token comment">// 打印参数结束 ====&gt;</span><span class="token comment">// 查询到的结果总数为 2</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:19 CheckStatus:4 CreatedAt:1660579860 UpdatedAt:1660579860}</span><span class="token comment">//</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h3</span><span class="token comment">// {AppName:3 GoodsId:h3_goods_id SiteId:20 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="range-范围查找"><a href="#range-范围查找" class="headerlink" title="range 范围查找"></a>range 范围查找</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testRangeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 范围查找 [where updated_at &gt;= 0 and updated_at &lt;= 1659695758]</span><span class="token comment">// Gt（大于）、Lt（小于）、Gte（大于等于）、Lte（小于等于）</span>query3 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewRangeQuery</span><span class="token punctuation">(</span><span class="token string">"updated_at"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lte</span><span class="token punctuation">(</span><span class="token number">1659695758</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>query3<span class="token punctuation">)</span><span class="token comment">// 开始打印参数 ====&gt;</span><span class="token comment">// {</span><span class="token comment">//  "range": {</span><span class="token comment">//    "updated_at": {</span><span class="token comment">//      "from": 0,</span><span class="token comment">//      "include_lower": true,</span><span class="token comment">//      "include_upper": true,</span><span class="token comment">//      "to": 1659695758</span><span class="token comment">//    }</span><span class="token comment">//  }</span><span class="token comment">// }</span><span class="token comment">// 打印参数结束 ====&gt;</span><span class="token comment">// 查询到的结果总数为 0</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="match-all"><a href="#match-all" class="headerlink" title="match_all"></a>match_all</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testMatchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// match_all</span>query4 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>query4<span class="token punctuation">)</span><span class="token comment">// 开始打印参数 ====&gt;</span><span class="token comment">// {</span><span class="token comment">//  "match_all": {}</span><span class="token comment">// }</span><span class="token comment">// 打印参数结束 ====&gt;</span><span class="token comment">// 查询到的结果总数为 4</span><span class="token comment">// 已经命中查询的数据为 ==&gt; 2_19_alex111</span><span class="token comment">// {AppName:2 GoodsId:alex111 SiteId:18 CheckStatus:23 CreatedAt:1660579517 UpdatedAt:1660579517}</span><span class="token comment">//</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:19 CheckStatus:4 CreatedAt:1660579860 UpdatedAt:1660579860}</span><span class="token comment">//</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h1</span><span class="token comment">// {AppName:2 GoodsId:h1_goods_id SiteId:17 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token comment">//</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h3</span><span class="token comment">// {AppName:3 GoodsId:h3_goods_id SiteId:20 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="match"><a href="#match" class="headerlink" title="match"></a>match</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testMatchQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// match</span>query5 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchQuery</span><span class="token punctuation">(</span><span class="token string">"goods_id"</span><span class="token punctuation">,</span> <span class="token string">"h2_goods_id"</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>query5<span class="token punctuation">)</span><span class="token comment">// 开始打印参数 ====&gt;</span><span class="token comment">// {</span><span class="token comment">//  "match": {</span><span class="token comment">//    "goods_id": {</span><span class="token comment">//      "query": "h2_goods_id"</span><span class="token comment">//    }</span><span class="token comment">//  }</span><span class="token comment">// }</span><span class="token comment">// 打印参数结束 ====&gt;</span><span class="token comment">// 查询到的结果总数为 1</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:19 CheckStatus:4 CreatedAt:1660579860 UpdatedAt:1660579860}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="match-phrase"><a href="#match-phrase" class="headerlink" title="match_phrase"></a>match_phrase</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testMatchPhraseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// match_phrase</span>query6 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchPhraseQuery</span><span class="token punctuation">(</span><span class="token string">"goods_id"</span><span class="token punctuation">,</span> <span class="token string">"h2_goods_id"</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>query6<span class="token punctuation">)</span><span class="token comment">// 开始打印参数 ====&gt;</span><span class="token comment">// {</span><span class="token comment">//  "match_phrase": {</span><span class="token comment">//    "goods_id": {</span><span class="token comment">//      "query": "h2_goods_id"</span><span class="token comment">//    }</span><span class="token comment">//  }</span><span class="token comment">// }</span><span class="token comment">// 打印参数结束 ====&gt;</span><span class="token comment">// 查询到的结果总数为 1</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:19 CheckStatus:4 CreatedAt:1660579860 UpdatedAt:1660579860}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="match-phrase-prefix"><a href="#match-phrase-prefix" class="headerlink" title="match_phrase_prefix"></a>match_phrase_prefix</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testMatchPhrasePrefixQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// match_phrase_prefix</span><span class="token comment">// 这里因为类型不支持前缀匹配，可能会直接报错</span>query7 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewMatchPhrasePrefixQuery</span><span class="token punctuation">(</span><span class="token string">"goods_id"</span><span class="token punctuation">,</span> <span class="token string">"h2_"</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>query7<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="regexp"><a href="#regexp" class="headerlink" title="regexp"></a>regexp</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testRegexpQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// regexp</span><span class="token comment">// 搜索 goods_id 字段对应的值以 `h` 开头的所有文档</span>query8 <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewRegexpQuery</span><span class="token punctuation">(</span><span class="token string">"goods_id"</span><span class="token punctuation">,</span> <span class="token string">"h.*"</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>query8<span class="token punctuation">)</span><span class="token comment">// 开始打印参数 ====&gt;</span><span class="token comment">// {</span><span class="token comment">//  "regexp": {</span><span class="token comment">//    "goods_id": {</span><span class="token comment">//      "value": "h.*"</span><span class="token comment">//    }</span><span class="token comment">//  }</span><span class="token comment">// }</span><span class="token comment">// 打印参数结束 ====&gt;</span><span class="token comment">// 查询到的结果总数为 3</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:19 CheckStatus:4 CreatedAt:1660579860 UpdatedAt:1660579860}</span><span class="token comment">//</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h1</span><span class="token comment">// {AppName:2 GoodsId:h1_goods_id SiteId:17 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token comment">//</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h3</span><span class="token comment">// {AppName:3 GoodsId:h3_goods_id SiteId:20 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="bool-组合查询"><a href="#bool-组合查询" class="headerlink" title="bool 组合查询"></a>bool 组合查询</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testBoolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 组合查询</span>boolQuery <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewBoolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// must</span>boolQuery<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">NewTermQuery</span><span class="token punctuation">(</span><span class="token string">"check_status"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// should</span>boolQuery<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">NewTermQuery</span><span class="token punctuation">(</span><span class="token string">"app_name"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// must_not</span>boolQuery<span class="token punctuation">.</span><span class="token function">MustNot</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">NewTermQuery</span><span class="token punctuation">(</span><span class="token string">"site_id"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// filter</span>boolQuery<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>elastic<span class="token punctuation">.</span><span class="token function">NewRangeQuery</span><span class="token punctuation">(</span><span class="token string">"updated_at"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lte</span><span class="token punctuation">(</span><span class="token number">1660579923</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">querySearch</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token comment">// 开始打印参数 ====&gt;</span><span class="token comment">// {</span><span class="token comment">//  "bool": {</span><span class="token comment">//    "filter": {</span><span class="token comment">//      "range": {</span><span class="token comment">//        "updated_at": {</span><span class="token comment">//          "from": 0,</span><span class="token comment">//          "include_lower": true,</span><span class="token comment">//          "include_upper": true,</span><span class="token comment">//          "to": 1660579923</span><span class="token comment">//        }</span><span class="token comment">//      }</span><span class="token comment">//    },</span><span class="token comment">//    "must": {</span><span class="token comment">//      "term": {</span><span class="token comment">//        "check_status": 2</span><span class="token comment">//      }</span><span class="token comment">//    },</span><span class="token comment">//    "must_not": {</span><span class="token comment">//      "term": {</span><span class="token comment">//        "site_id": 18</span><span class="token comment">//      }</span><span class="token comment">//    },</span><span class="token comment">//    "should": {</span><span class="token comment">//      "term": {</span><span class="token comment">//        "app_name": 20</span><span class="token comment">//      }</span><span class="token comment">//    }</span><span class="token comment">//  }</span><span class="token comment">// }</span><span class="token comment">// 打印参数结束 ====&gt;</span><span class="token comment">// 查询到的结果总数为 2</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h1</span><span class="token comment">// {AppName:2 GoodsId:h1_goods_id SiteId:17 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token comment">//</span><span class="token comment">// 已经命中查询的数据为 ==&gt; h3</span><span class="token comment">// {AppName:3 GoodsId:h3_goods_id SiteId:20 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="分页查询，并排序"><a href="#分页查询，并排序" class="headerlink" title="分页查询，并排序"></a>分页查询，并排序</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testPageSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 分页查询，并排序</span><span class="token comment">// from 为起始偏移量（offset）默认为 0，size 为每页显示数（limit）默认为 10</span><span class="token comment">// from 等于当前页码数减去一的商然后乘以每页显示数</span><span class="token comment">// Sort() 第二个参数，true 为升序、false 为降序</span>pageRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token string">"updated_at"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> pageRet<span class="token punctuation">.</span>Hits<span class="token punctuation">.</span>Hits <span class="token punctuation">{</span><span class="token keyword">var</span> tmp RcpGoodsImgChecksESjson<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"分页查询，已经命中查询的数据为 ==&gt; %+v \n %+v \n\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 分页查询，已经命中查询的数据为 ==&gt; h1</span><span class="token comment">// {AppName:2 GoodsId:h1_goods_id SiteId:17 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token comment">//</span><span class="token comment">// 分页查询，已经命中查询的数据为 ==&gt; h3</span><span class="token comment">// {AppName:3 GoodsId:h3_goods_id SiteId:20 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token comment">//</span><span class="token comment">// 分页查询，已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:19 CheckStatus:4 CreatedAt:1660579860 UpdatedAt:1660579860}</span><span class="token comment">//</span><span class="token comment">// 分页查询，已经命中查询的数据为 ==&gt; 2_19_alex111</span><span class="token comment">// {AppName:2 GoodsId:alex111 SiteId:18 CheckStatus:23 CreatedAt:1660579517 UpdatedAt:1660579517}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="多字段排序"><a href="#多字段排序" class="headerlink" title="多字段排序"></a>多字段排序</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testMultiFieldSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 多字段排序</span>sortsBuilders <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>elastic<span class="token punctuation">.</span>Sorter<span class="token punctuation">{</span>elastic<span class="token punctuation">.</span><span class="token function">NewFieldSort</span><span class="token punctuation">(</span><span class="token string">"check_status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 升序</span>elastic<span class="token punctuation">.</span><span class="token function">NewFieldSort</span><span class="token punctuation">(</span><span class="token string">"created_at"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 降序</span><span class="token punctuation">}</span>sortRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SortBy</span><span class="token punctuation">(</span>sortsBuilders<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sortRet<span class="token punctuation">.</span>Hits<span class="token punctuation">.</span>Hits <span class="token punctuation">{</span><span class="token keyword">var</span> tmp RcpGoodsImgChecksESjson<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"多字段排序，已经命中查询的数据为 ==&gt; %+v \n %+v \n\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 多字段排序，已经命中查询的数据为 ==&gt; h1</span><span class="token comment">// {AppName:2 GoodsId:h1_goods_id SiteId:17 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token comment">//</span><span class="token comment">// 多字段排序，已经命中查询的数据为 ==&gt; h3</span><span class="token comment">// {AppName:3 GoodsId:h3_goods_id SiteId:20 CheckStatus:2 CreatedAt:1660579860 UpdatedAt:1660579923}</span><span class="token comment">//</span><span class="token comment">// 多字段排序，已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:19 CheckStatus:4 CreatedAt:1660579860 UpdatedAt:1660579860}</span><span class="token comment">//</span><span class="token comment">// 多字段排序，已经命中查询的数据为 ==&gt; 2_19_alex111</span><span class="token comment">// {AppName:2 GoodsId:alex111 SiteId:18 CheckStatus:23 CreatedAt:1660579517 UpdatedAt:1660579517}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="返回指定字段（只查询指定字段）"><a href="#返回指定字段（只查询指定字段）" class="headerlink" title="返回指定字段（只查询指定字段）"></a>返回指定字段（只查询指定字段）</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testFetchSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 返回指定字段</span>includeFields <span class="token operator">:=</span> elastic<span class="token punctuation">.</span><span class="token function">NewFetchSourceContext</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"app_name"</span><span class="token punctuation">,</span> <span class="token string">"goods_id"</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">)</span>includeRet<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FetchSourceContext</span><span class="token punctuation">(</span>includeFields<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> includeRet<span class="token punctuation">.</span>Hits<span class="token punctuation">.</span>Hits <span class="token punctuation">{</span><span class="token keyword">var</span> tmp RcpGoodsImgChecksESjson<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"返回指定字段，已经命中查询的数据为 ==&gt; %+v \n %+v \n\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 返回指定字段，已经命中查询的数据为 ==&gt; 2_19_alex111</span><span class="token comment">// {AppName:2 GoodsId:alex111 SiteId:0 CheckStatus:0 CreatedAt:0 UpdatedAt:0}</span><span class="token comment">//</span><span class="token comment">// 返回指定字段，已经命中查询的数据为 ==&gt; h2</span><span class="token comment">// {AppName:1 GoodsId:h2_goods_id SiteId:0 CheckStatus:0 CreatedAt:0 UpdatedAt:0}</span><span class="token comment">//</span><span class="token comment">// 返回指定字段，已经命中查询的数据为 ==&gt; h1</span><span class="token comment">// {AppName:2 GoodsId:h1_goods_id SiteId:0 CheckStatus:0 CreatedAt:0 UpdatedAt:0}</span><span class="token comment">//</span><span class="token comment">// 返回指定字段，已经命中查询的数据为 ==&gt; h3</span><span class="token comment">// {AppName:3 GoodsId:h3_goods_id SiteId:0 CheckStatus:0 CreatedAt:0 UpdatedAt:0}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="查询数据总数"><a href="#查询数据总数" class="headerlink" title="查询数据总数"></a>查询数据总数</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 查询总命中计数</span>total<span class="token punctuation">,</span> err <span class="token operator">:=</span> ESClient<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>RcpGoodsImgChecksESIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 查询总命中计数，已经命中查询的数据为 ==&gt; 2</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"查询总命中计数，已经命中查询的数据为 ==&gt; %+v \n"</span><span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker 安装 ElasticSearch 和 Kibana</title>
      <link href="posts/2e9eaf3a.html"/>
      <url>posts/2e9eaf3a.html</url>
      
        <content type="html"><![CDATA[<h1 id="Docker-安装-ElasticSearch-和-Kibana"><a href="#Docker-安装-ElasticSearch-和-Kibana" class="headerlink" title="Docker 安装 ElasticSearch 和 Kibana"></a>Docker 安装 ElasticSearch 和 Kibana</h1><blockquote><p>安装的时候，ElasticSearch 和 Kibana 的版本一定要一致。</p></blockquote><h2 id="创建一个网络"><a href="#创建一个网络" class="headerlink" title="创建一个网络"></a>创建一个网络</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建一个网络</span><span class="token function">docker</span> network create alex-network<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="安装-ElasticSearch"><a href="#安装-ElasticSearch" class="headerlink" title="安装 ElasticSearch"></a>安装 ElasticSearch</h2><ul><li>拉取镜像</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull elasticsearch:7.9.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>创建容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置为单节点（非集群模式）</span><span class="token comment"># -e "discovery.type=single-node"</span><span class="token comment"># 设置 es 的初始内存和最大内存，否则导致过大启动不了 es 或者 kibana 连接 es 时，导致 es 直接死机</span><span class="token comment"># -e ES_JAVA_OPTS="-Xms512m -Xmx512m"</span><span class="token comment"># 挂载逻辑卷，绑定 es 的数据目录</span><span class="token comment"># -v ~/es-data:/usr/share/elasticsearch/data</span><span class="token comment"># 挂载逻辑卷，绑定 es 的插件目录</span><span class="token comment"># -v ~/es-plugins:/usr/share/elasticsearch/plugins</span><span class="token comment"># 挂载逻辑卷，绑定 es 的配置目录</span><span class="token comment"># -v ~/es-config:/usr/share/elasticsearch/config</span><span class="token comment"># 授权逻辑卷访问权限</span><span class="token comment"># --privileged</span><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> alex-es <span class="token punctuation">\</span><span class="token parameter variable">--net</span> alex-network <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token string">"discovery.type=single-node"</span> <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Xms512m -Xmx512m"</span> <span class="token punctuation">\</span>elasticsearch:7.9.3<span class="token comment"># 如果要挂载目录时，可能会报错 `Exception in thread "main" java.nio.file.NoSuchFileException: /usr/share/elasticsearch/config/jvm.options`</span><span class="token comment"># 解决方案是：先随便创建一个容器，然后将随便创建的容器的配置文件先复制一份到宿机上，然后删除掉这个容器，重新再创建容器，比如，如下步骤</span><span class="token comment"># 1. 先随便创建一个容器</span><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> es_service_1 <span class="token punctuation">\</span><span class="token parameter variable">--net</span> alex-network <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token string">"discovery.type=single-node"</span> <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Xms512m -Xmx512m"</span> <span class="token punctuation">\</span>elasticsearch:7.9.3<span class="token comment"># 2. 然后复制该容器的配置文件到宿机上</span><span class="token function">docker</span> <span class="token function">cp</span> <span class="token punctuation">{</span>es_service_1_container_id<span class="token punctuation">}</span>:/usr/share/elasticsearch/config/ ~/es-config<span class="token comment"># 3. 然后再删除到这个临时容器</span><span class="token function">docker</span> <span class="token function">rm</span> es_service_1<span class="token comment"># 4. 最后再携带挂载参数创建新容器</span><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> es_service_1 <span class="token punctuation">\</span><span class="token parameter variable">--net</span> alex-network <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token string">"discovery.type=single-node"</span> <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Xms512m -Xmx512m"</span> <span class="token punctuation">\</span><span class="token parameter variable">-v</span> ~/es-data:/usr/share/elasticsearch/data <span class="token punctuation">\</span><span class="token parameter variable">-v</span> ~/es-plugins:/usr/share/elasticsearch/plugins <span class="token punctuation">\</span><span class="token parameter variable">-v</span> ~/es-config:/usr/share/elasticsearch/config <span class="token punctuation">\</span><span class="token parameter variable">--privileged</span> <span class="token parameter variable">-u</span> root <span class="token punctuation">\</span>elasticsearch:7.9.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>也可以直接通过修改配置文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编辑 es 的配置文件</span><span class="token function">vi</span> /usr/share/elasticsearch/config/elasticsearch.yml<span class="token comment"># 如果需要解决跨域问题，那么则在配置文件中追加写入以下内容</span>http.cors.enabled: <span class="token boolean">true</span>http.cors.allow-origin: <span class="token string">"*"</span><span class="token comment"># 编辑 jvm 相关配置</span><span class="token function">vi</span> /usr/share/elasticsearch/config/jvm.options<span class="token comment"># 如果 es 容器老是会宕机，那么可能需要调整以下参数</span><span class="token comment"># 修改以下参数（按照自己的实际需求进行调整）</span><span class="token parameter variable">-Xms512m</span><span class="token parameter variable">-Xmx512m</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试是否安装成功</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 出现版本号即表示成功</span><span class="token function">curl</span> <span class="token number">127.0</span>.0.1:9200<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="安装-ik-中文分词插件"><a href="#安装-ik-中文分词插件" class="headerlink" title="安装 ik 中文分词插件"></a>安装 ik 中文分词插件</h3><blockquote><p>注意 ik 分词插件的版本要和 es 的版本一致</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@63d697bd738f elasticsearch<span class="token punctuation">]</span><span class="token comment"># pwd</span>/usr/share/elasticsearch<span class="token punctuation">[</span>root@63d697bd738f elasticsearch<span class="token punctuation">]</span><span class="token comment"># ./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.3/elasticsearch-analysis-ik-7.9.3.zip</span>-<span class="token operator">&gt;</span> Installing https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.3/elasticsearch-analysis-ik-7.9.3.zip-<span class="token operator">&gt;</span> Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.3/elasticsearch-analysis-ik-7.9.3.zip<span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">]</span> <span class="token number">100</span>%??@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@     WARNING: plugin requires additional permissions     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@* java.net.SocketPermission * connect,resolveSee http://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html<span class="token keyword">for</span> descriptions of what these permissions allow and the associated risks.Continue with installation? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>y-<span class="token operator">&gt;</span> Installed analysis-ik<span class="token punctuation">[</span>root@63d697bd738f elasticsearch<span class="token punctuation">]</span><span class="token comment"># ./bin/elasticsearch-plugin list</span>analysis-ik<span class="token punctuation">[</span>root@63d697bd738f elasticsearch<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装-Kibana"><a href="#安装-Kibana" class="headerlink" title="安装 Kibana"></a>安装 Kibana</h2><ul><li>拉取镜像</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull kibana:7.9.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>创建容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 相关参数</span><span class="token comment"># 设置 es 请求地址</span><span class="token comment"># -e ELASTICSEARCH_HOSTS=http://localhost:9200</span><span class="token comment"># 设置汉化</span><span class="token comment"># -e I18N_LOCALE=zh-CN</span><span class="token comment"># 设置时区，否则查询时间需要加 8 个小时</span><span class="token comment"># -e TZ='Asia/Shanghai'</span><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> alex-kibana <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">5601</span>:5601 <span class="token punctuation">\</span><span class="token parameter variable">--net</span> alex-network <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">ELASTICSEARCH_HOSTS</span><span class="token operator">=</span>http://alex-es:9200 <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">I18N_LOCALE</span><span class="token operator">=</span>zh-CN <span class="token punctuation">\</span>kibana:7.9.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>也可以直接去编辑 kibana 的配置文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编辑配置文件</span><span class="token function">vi</span> /usr/share/kibana/config/kibana.yml<span class="token comment"># 适当修改以下配置，因为我们已经将 alex-es 容器和 alex-kibana 容器同时都加入到了 alex-network 网络中，因此这里，我们可以直接通过容器名称进行访问到容器对应的 IP 地址</span>elasticsearch.hosts: <span class="token punctuation">[</span> <span class="token string">"http://alex-es:9200"</span> <span class="token punctuation">]</span>i18n.locale: zh-CN<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试是否安装成功</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 浏览器请求</span><span class="token number">127.0</span>.0.1:5601<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> ElasticSearch </tag>
            
            <tag> Kibana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang 使用 CASE WHEN 进行批量更新</title>
      <link href="posts/84fd0244.html"/>
      <url>posts/84fd0244.html</url>
      
        <content type="html"><![CDATA[<h1 id="Golang-使用-CASE-WHEN-进行批量更新"><a href="#Golang-使用-CASE-WHEN-进行批量更新" class="headerlink" title="Golang 使用 CASE WHEN 进行批量更新"></a>Golang 使用 CASE WHEN 进行批量更新</h1><blockquote><p>这是使用 <code>Go</code> 语言写的 <code>CASE WHEN</code> 拼接语句，如果需要 <code>PHP</code> 版本的，可以参考我的这篇文章 <a href="https://pudongping.com/posts/eaf6377d.html">PHP 使用 CASE WHEN 进行批量更新 （当前基于 laravel 编写）</a></p></blockquote><h2 id="以下代码最终返回的-sql-语句为"><a href="#以下代码最终返回的-sql-语句为" class="headerlink" title="以下代码最终返回的 sql 语句为"></a>以下代码最终返回的 sql 语句为</h2><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">UPDATE articles SET view_count = CASEWHEN id = 180 AND user_id = 5  THEN 11 WHEN id = 181 AND user_id = 15 THEN 22 WHEN id = 182 AND user_id = 11 THEN 33 WHEN id = 183 AND user_id = 1  THEN 44 ELSE view_count END,updated_at = CASEWHEN id = 180 AND user_id = 5  THEN 1653147405 WHEN id = 181 AND user_id = 15 THEN 1653147406 WHEN id = 182 AND user_id = 11 THEN 1653147407 WHEN id = 183 AND user_id = 1  THEN 1653147408 ELSE updated_at END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="封装成方法为"><a href="#封装成方法为" class="headerlink" title="封装成方法为"></a>封装成方法为</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// BatchUpdate 使用 case when 进行批量更新</span><span class="token comment">// 最终执行的 sql 语句为：</span><span class="token comment">// UPDATE articles SET</span><span class="token comment">// view_count = CASE</span><span class="token comment">//WHEN id = 180 AND user_id = 5  THEN 11</span><span class="token comment">//WHEN id = 181 AND user_id = 15 THEN 22</span><span class="token comment">//WHEN id = 182 AND user_id = 11 THEN 33</span><span class="token comment">//WHEN id = 183 AND user_id = 1  THEN 44</span><span class="token comment">//ELSE view_count END,</span><span class="token comment">// updated_at = CASE</span><span class="token comment">//WHEN id = 180 AND user_id = 5  THEN 1653147405</span><span class="token comment">//WHEN id = 181 AND user_id = 15 THEN 1653147406</span><span class="token comment">//WHEN id = 182 AND user_id = 11 THEN 1653147407</span><span class="token comment">//WHEN id = 183 AND user_id = 1  THEN 1653147408</span><span class="token comment">//ELSE updated_at</span><span class="token comment">// END</span><span class="token comment">//</span><span class="token comment">//</span><span class="token comment">// tableName := "articles"</span><span class="token comment">// where := make(map[string][]int)</span><span class="token comment">// where["id"] = []int{180, 181, 182, 183}</span><span class="token comment">// where["user_id"] = []int{5, 15, 11, 1}</span><span class="token comment">// needUpdateFields := make(map[string][]int)</span><span class="token comment">// needUpdateFields["view_count"] = []int{11, 22, 33, 44}</span><span class="token comment">// needUpdateFields["updated_at"] = []int{1653147405, 1653147405, 1653147405, 1653147405}</span><span class="token keyword">func</span> <span class="token function">BatchUpdate</span><span class="token punctuation">(</span>tableName <span class="token builtin">string</span><span class="token punctuation">,</span> where<span class="token punctuation">,</span> needUpdateFields <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>needUpdateFields<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">}</span><span class="token comment">// 所有的条件字段数组</span><span class="token keyword">var</span> whereKeys <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token keyword">for</span> k <span class="token operator">:=</span> <span class="token keyword">range</span> where <span class="token punctuation">{</span>whereKeys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>whereKeys<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 第一个 where 条件所有的值</span>firstWhere <span class="token operator">:=</span> where<span class="token punctuation">[</span>whereKeys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token comment">// 所有需要更新的字段数组</span><span class="token keyword">var</span> needUpdateFieldsKeys <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token keyword">for</span> k <span class="token operator">:=</span> <span class="token keyword">range</span> needUpdateFields <span class="token punctuation">{</span>needUpdateFieldsKeys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>needUpdateFieldsKeys<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>firstWhere<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>needUpdateFields<span class="token punctuation">[</span>needUpdateFieldsKeys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 更新的条件与更新的字段值数量不相等</span><span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">}</span><span class="token keyword">var</span> s1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token keyword">for</span> k <span class="token operator">:=</span> <span class="token keyword">range</span> firstWhere <span class="token punctuation">{</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> vv <span class="token operator">:=</span> <span class="token keyword">range</span> whereKeys <span class="token punctuation">{</span>s1 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s = %v AND "</span><span class="token punctuation">,</span> vv<span class="token punctuation">,</span> where<span class="token punctuation">[</span>vv<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// 按照 where 条件字段数量做切割</span>whereSize <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>whereKeys<span class="token punctuation">)</span>batches <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token operator">+</span>whereSize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>whereSize<span class="token punctuation">)</span><span class="token keyword">for</span> whereSize <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span> <span class="token punctuation">{</span>s1<span class="token punctuation">,</span> batches <span class="token operator">=</span> s1<span class="token punctuation">[</span>whereSize<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>batches<span class="token punctuation">,</span> s1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>whereSize<span class="token punctuation">:</span>whereSize<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>batches <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>batches<span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token keyword">var</span> whereArr <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> batches <span class="token punctuation">{</span>whereArr <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>whereArr<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">TrimSuffix</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"AND "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 拼接 sql 语句</span>sqlStr <span class="token operator">:=</span> <span class="token string">""</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> needUpdateFieldsKeys <span class="token punctuation">{</span>str <span class="token operator">:=</span> <span class="token string">""</span><span class="token keyword">for</span> kk<span class="token punctuation">,</span> vv <span class="token operator">:=</span> <span class="token keyword">range</span> whereArr <span class="token punctuation">{</span>str <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">" WHEN %v THEN %v "</span><span class="token punctuation">,</span> vv<span class="token punctuation">,</span> needUpdateFields<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">[</span>kk<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>sqlStr <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s = CASE %s ELSE %s END, "</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> str<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 去除掉最后面的逗号及空格</span>sqlStr <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSuffix</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token string">", "</span><span class="token punctuation">)</span>caseWhenSql <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"UPDATE %s SET %s"</span><span class="token punctuation">,</span> tableName<span class="token punctuation">,</span> sqlStr<span class="token punctuation">)</span><span class="token keyword">return</span> caseWhenSql<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>tableName <span class="token operator">:=</span> <span class="token string">"articles"</span>where <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>where<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">181</span><span class="token punctuation">,</span> <span class="token number">182</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">}</span>where<span class="token punctuation">[</span><span class="token string">"user_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>needUpdateFields <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>needUpdateFields<span class="token punctuation">[</span><span class="token string">"view_count"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">}</span>needUpdateFields<span class="token punctuation">[</span><span class="token string">"updated_at"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1653147405</span><span class="token punctuation">,</span> <span class="token number">1653147406</span><span class="token punctuation">,</span> <span class="token number">1653147407</span><span class="token punctuation">,</span> <span class="token number">1653147408</span><span class="token punctuation">}</span>sql <span class="token operator">:=</span> <span class="token function">BatchUpdate</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> where<span class="token punctuation">,</span> needUpdateFields<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一般 orm 都会支持原生 sql 执行，在这里我只返回了拼接好的 sql 语句，最后只需要将 sql 语句拿去执行即可。当然，如果字段值类型需要调整的，则需要按需调整下。</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
            <tag> 批量更新 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gin 框架优雅的获取所有的请求参数</title>
      <link href="posts/ccb188ca.html"/>
      <url>posts/ccb188ca.html</url>
      
        <content type="html"><![CDATA[<h1 id="Gin-框架优雅的获取所有的请求参数"><a href="#Gin-框架优雅的获取所有的请求参数" class="headerlink" title="Gin 框架优雅的获取所有的请求参数"></a>Gin 框架优雅的获取所有的请求参数</h1><p>嗯，话不多说，直接看代码 ^_^</p><p>将以下代码写入某个 <code>.go</code> 文件中，比如，我这里写入 <code>gin_demo.go</code> 文件中，然后执行 <code>go run gin_demo.go</code></p><h2 id="主要代码"><a href="#主要代码" class="headerlink" title="主要代码"></a>主要代码</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"bytes"</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token string">"io/ioutil"</span><span class="token string">"net/http"</span><span class="token string">"sync"</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token string">"/foo"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>inputs<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">RequestInputs</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"msg"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>data <span class="token operator">:=</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"method"</span><span class="token punctuation">:</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method<span class="token punctuation">,</span><span class="token string">"params"</span><span class="token punctuation">:</span> inputs<span class="token punctuation">,</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"返回值为 ====&gt; %#v \n"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":9501"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// RequestInputs 获取所有参数</span><span class="token keyword">func</span> <span class="token function">RequestInputs</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">const</span> defaultMemory <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span>contentType <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">var</span> <span class="token punctuation">(</span>dataMap  <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>queryMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>postMap  <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// @see gin@v1.7.7/binding/query.go ==&gt; func (queryBinding) Bind(req *http.Request, obj interface{})</span><span class="token keyword">for</span> k <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>queryMap<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token string">"application/json"</span> <span class="token operator">==</span> contentType <span class="token punctuation">{</span><span class="token keyword">var</span> bodyBytes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token keyword">if</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>bodyBytes<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">}</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>bodyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// @see gin@v1.7.7/binding/json.go ==&gt; func (jsonBinding) Bind(req *http.Request, obj interface{})</span><span class="token keyword">if</span> c<span class="token punctuation">.</span>Request <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>postMap<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token punctuation">}</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>bodyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token string">"multipart/form-data"</span> <span class="token operator">==</span> contentType <span class="token punctuation">{</span><span class="token comment">// @see gin@v1.7.7/binding/form.go ==&gt; func (formMultipartBinding) Bind(req *http.Request, obj interface{})</span><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">ParseMultipartForm</span><span class="token punctuation">(</span>defaultMemory<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>PostForm <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>postMap<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>postMap<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">// ParseForm 解析 URL 中的查询字符串，并将解析结果更新到 r.Form 字段</span><span class="token comment">// 对于 POST 或 PUT 请求，ParseForm 还会将 body 当作表单解析，</span><span class="token comment">// 并将结果既更新到 r.PostForm 也更新到 r.Form。解析结果中，</span><span class="token comment">// POST 或 PUT 请求主体要优先于 URL 查询字符串（同名变量，主体的值在查询字符串的值前面）</span><span class="token comment">// @see gin@v1.7.7/binding/form.go ==&gt; func (formBinding) Bind(req *http.Request, obj interface{})</span><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">ParseForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">ParseMultipartForm</span><span class="token punctuation">(</span>defaultMemory<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token keyword">if</span> err <span class="token operator">!=</span> http<span class="token punctuation">.</span>ErrNotMultipart <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>PostForm <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>postMap<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>postMap<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>RWMutex<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> queryMap <span class="token punctuation">{</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>dataMap<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> vmu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> postMap <span class="token punctuation">{</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>dataMap<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> vmu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> dataMap<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>get 请求，只有 query 参数时</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--location</span> <span class="token parameter variable">--request</span> GET <span class="token string">'127.0.0.1:9501/foo?field1=value1&amp;field2=false&amp;field3=12&amp;field4=4.78'</span><span class="token comment"># 返回值为 ====&gt; gin.H{"method":"GET", "params":map[string]interface {}{"field1":"value1", "field2":"false", "field3":"12", "field4":"4.78"}}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>get 请求，有 query 参数，且有 <code>multipart/form-data</code> 参数时</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--location</span> <span class="token parameter variable">--request</span> GET <span class="token string">'127.0.0.1:9501/foo?field1=value1&amp;field2=false&amp;field3=12&amp;field4=4.78'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'f1="vv1"'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'f2="vv2"'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'f3="false"'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'f4="7.08"'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'f5="张三"'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'f6="88"'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'f7[]="hello"'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'f7[]="world"'</span> <span class="token punctuation">\</span><span class="token parameter variable">--form</span> <span class="token string">'field1="覆盖了 field1"'</span><span class="token comment"># 返回值为 ====&gt; gin.H{"method":"GET", "params":map[string]interface {}{"f1":"vv1", "f2":"vv2", "f3":"false", "f4":"7.08", "f5":"张三", "f6":"88", "f7[]":[]string{"hello", "world"}, "field1":"覆盖了 field1", "field2":"false", "field3":"12", "field4":"4.78"}}</span><span class="token comment">#{</span><span class="token comment">#   "method": "GET",</span><span class="token comment">#   "params": {</span><span class="token comment">#       "f1": "vv1",</span><span class="token comment">#       "f2": "vv2",</span><span class="token comment">#       "f3": "false",</span><span class="token comment">#       "f4": "7.08",</span><span class="token comment">#       "f5": "张三",</span><span class="token comment">#       "f6": "88",</span><span class="token comment">#       "f7[]": [</span><span class="token comment">#           "hello",</span><span class="token comment">#           "world"</span><span class="token comment">#       ],</span><span class="token comment">#       "field1": "覆盖了 field1",</span><span class="token comment">#       "field2": "false",</span><span class="token comment">#       "field3": "12",</span><span class="token comment">#       "field4": "4.78"</span><span class="token comment">#   }</span><span class="token comment">#}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>post 请求，既有 query 参数，也有 <code>application/x-www-form-urlencoded</code> 参数时</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--location</span> <span class="token parameter variable">--request</span> POST <span class="token string">'127.0.0.1:9501/foo?field1=value1&amp;field2=false&amp;field3=12&amp;field4=4.78'</span> <span class="token punctuation">\</span><span class="token parameter variable">--header</span> <span class="token string">'Content-Type: application/x-www-form-urlencoded'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'f1=vv1'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'f2=vv2'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'f3=false'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'f4=7.08'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'f5=张三'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'f6=88'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'f7[]=hello'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'f7[]=world'</span> <span class="token punctuation">\</span>--data-urlencode <span class="token string">'field1=覆盖了 field1'</span><span class="token comment"># 返回值为 ====&gt; gin.H{"method":"POST", "params":map[string]interface {}{"f1":"vv1", "f2":"vv2", "f3":"false", "f4":"7.08", "f5":"张三", "f6":"88", "f7[]":[]string{"hello", "world"}, "field1":"覆盖了 field1", "field2":"false", "field3":"12", "field4":"4.78"}}</span><span class="token comment">#{</span><span class="token comment">#   "method": "POST",</span><span class="token comment">#   "params": {</span><span class="token comment">#       "f1": "vv1",</span><span class="token comment">#       "f2": "vv2",</span><span class="token comment">#       "f3": "false",</span><span class="token comment">#       "f4": "7.08",</span><span class="token comment">#       "f5": "张三",</span><span class="token comment">#       "f6": "88",</span><span class="token comment">#       "f7[]": [</span><span class="token comment">#           "hello",</span><span class="token comment">#           "world"</span><span class="token comment">#       ],</span><span class="token comment">#       "field1": "覆盖了 field1",</span><span class="token comment">#       "field2": "false",</span><span class="token comment">#       "field3": "12",</span><span class="token comment">#       "field4": "4.78"</span><span class="token comment">#   }</span><span class="token comment">#}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>post 请求，既有 query 参数，也有 <code>application/json</code> 参数时</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--location</span> <span class="token parameter variable">--request</span> POST <span class="token string">'127.0.0.1:9501/foo?field1=value1&amp;field2=false&amp;field3=12&amp;field4=4.78'</span> <span class="token punctuation">\</span><span class="token parameter variable">--header</span> <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>--data-raw <span class="token string">'{    "name": "张t",    "account": "",    "introduction": null,    "avatar": "/avatar/2022/05/11/ruQvUHOF-6512bd43d9caa6e02c990b0a82652dca-20220511111053.jpg",    "favorite": [        "football",        "basketball",        "pingpong-ball"    ],    "num": [        1,        5,        8    ],    "books": {        "name": "bookA",        "price": 18.98    },    "students": [        {            "name": "张三",            "age": 18,            "height": 180.00        },        {            "name": "李四",            "age": 24.5,            "height": 165.55        }    ],    "field1": "覆盖了 field1"}'</span><span class="token comment"># 返回值为 ====&gt; gin.H{"method":"POST", "params":map[string]interface {}{"account":"", "avatar":"/avatar/2022/05/11/ruQvUHOF-6512bd43d9caa6e02c990b0a82652dca-20220511111053.jpg", "books":map[string]interface {}{"name":"bookA", "price":18.98}, "favorite":[]interface {ootball", "basketball", "pingpong-ball"}, "field1":"覆盖了 field1", "field2":"false", "field3":"12", "field4":"4.78", "introduction":interface {}(nil), "name":"张t", "num":[]interface {}{1, 5, 8}, "students":[]interface {}{map[string]interface {}{"age":18, "height", "name":"张三"}, map[string]interface {}{"age":24.5, "height":165.55, "name":"李四"}}}}</span><span class="token comment">#{</span><span class="token comment">#    "method": "POST",</span><span class="token comment">#    "params": {</span><span class="token comment">#        "account": "",</span><span class="token comment">#        "avatar": "/avatar/2022/05/11/ruQvUHOF-6512bd43d9caa6e02c990b0a82652dca-20220511111053.jpg",</span><span class="token comment">#        "books": {</span><span class="token comment">#            "name": "bookA",</span><span class="token comment">#            "price": 18.98</span><span class="token comment">#        },</span><span class="token comment">#        "favorite": [</span><span class="token comment">#            "football",</span><span class="token comment">#            "basketball",</span><span class="token comment">#            "pingpong-ball"</span><span class="token comment">#        ],</span><span class="token comment">#        "field1": "覆盖了 field1",</span><span class="token comment">#        "field2": "false",</span><span class="token comment">#        "field3": "12",</span><span class="token comment">#        "field4": "4.78",</span><span class="token comment">#        "introduction": null,</span><span class="token comment">#        "name": "张t",</span><span class="token comment">#        "num": [</span><span class="token comment">#            1,</span><span class="token comment">#            5,</span><span class="token comment">#            8</span><span class="token comment">#        ],</span><span class="token comment">#        "students": [</span><span class="token comment">#            {</span><span class="token comment">#                "age": 18,</span><span class="token comment">#                "height": 180,</span><span class="token comment">#                "name": "张三"</span><span class="token comment">#            },</span><span class="token comment">#            {</span><span class="token comment">#                "age": 24.5,</span><span class="token comment">#                "height": 165.55,</span><span class="token comment">#                "name": "李四"</span><span class="token comment">#            }</span><span class="token comment">#        ]</span><span class="token comment">#    }</span><span class="token comment">#}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上代码通过阅读 <code>gin</code> 框架 <code>ShouldBind</code> 方法绑定参数逻辑编写。经过粗略测试，均可以获取所有的参数，并将结果绑定到 <code>map[string]interface{}</code> 中。</p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Golang </tag>
            
            <tag> Gin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 和 Mac 下时间戳与时间互转</title>
      <link href="posts/fe92d324.html"/>
      <url>posts/fe92d324.html</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-和-Mac-下时间戳与时间互转"><a href="#Linux-和-Mac-下时间戳与时间互转" class="headerlink" title="Linux 和 Mac 下时间戳与时间互转"></a>Linux 和 Mac 下时间戳与时间互转</h1><h2 id="查看当前时间的时间戳"><a href="#查看当前时间的时间戳" class="headerlink" title="查看当前时间的时间戳"></a>查看当前时间的时间戳</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># linux 和 mac 下都是一样的命令</span><span class="token comment"># eg output：1650428766</span><span class="token function">date</span> +%s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="查看指定时间的时间戳"><a href="#查看指定时间的时间戳" class="headerlink" title="查看指定时间的时间戳"></a>查看指定时间的时间戳</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># eg output：1650427279</span><span class="token comment"># linux 下：</span><span class="token function">date</span> <span class="token parameter variable">-d</span> <span class="token string">"2022-04-20 12:01:19"</span> +%s<span class="token comment"># mac 下：</span><span class="token function">date</span> <span class="token parameter variable">-jf</span> <span class="token string">"%Y-%m-%d %H:%M:%S"</span> <span class="token string">"2022-04-20 12:01:19"</span> <span class="token string">"+%s"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="时间戳转时间格式"><a href="#时间戳转时间格式" class="headerlink" title="时间戳转时间格式"></a>时间戳转时间格式</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># eg output：2022-04-20 12:01:19</span><span class="token comment"># linux 下：</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span> -d@1650427279<span class="token comment"># mac 下：</span><span class="token function">date</span> <span class="token parameter variable">-r</span> <span class="token number">1650427279</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mac </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>支付宝花呗分期费用计算 PHP 示例代码</title>
      <link href="posts/c63afd43.html"/>
      <url>posts/c63afd43.html</url>
      
        <content type="html"><![CDATA[<h1 id="支付宝花呗分期费用计算-PHP-示例代码"><a href="#支付宝花呗分期费用计算-PHP-示例代码" class="headerlink" title="支付宝花呗分期费用计算 PHP 示例代码"></a>支付宝花呗分期费用计算 PHP 示例代码</h1><h2 id="支付宝-花呗分期-计费结果示例"><a href="#支付宝-花呗分期-计费结果示例" class="headerlink" title="支付宝-花呗分期-计费结果示例"></a>支付宝-花呗分期-计费结果示例</h2><blockquote><p>当天汇率为：汇率 1 日元 = 0.05548 人民币。</p></blockquote><p>商户承担手续费花呗分期费率</p><table><thead><tr><th>期数</th><th>费率</th></tr></thead><tbody><tr><td>3</td><td>1.80%</td></tr><tr><td>6</td><td>4.5%</td></tr><tr><td>12</td><td>7.5%</td></tr></tbody></table><p>用户承担手续费花呗分期费率</p><table><thead><tr><th>期数</th><th>费率</th></tr></thead><tbody><tr><td>3</td><td>2.30%</td></tr><tr><td>6</td><td>4.50%</td></tr><tr><td>12</td><td>7.50%</td></tr></tbody></table><p>计算结果示例如下：</p><blockquote><p>以下计算结果示例以用户承担手续费花呗分期费率计算得出。计算时间为：2022 年 1 月 6 日。</p></blockquote><table><thead><tr><th>期数</th><th>本金（人民币）</th><th>本金（日元）</th><th>每月应还款金额（人民币，单位：元）</th><th>总手续费（人民币，单位：元）</th><th>折算年化率（单利）约为</th></tr></thead><tbody><tr><td>3</td><td>5.45</td><td>98.00</td><td>1.85</td><td>0.13</td><td>13.7%</td></tr><tr><td>3</td><td>3.45</td><td>62.00</td><td>1.17</td><td>0.08</td><td>13.7%</td></tr><tr><td>6</td><td>3.45</td><td>62.00</td><td>0.59</td><td>0.16</td><td>15.3%</td></tr><tr><td>12</td><td>3.45</td><td>62.00</td><td>0.30</td><td>0.26</td><td>13.6%</td></tr><tr><td>3</td><td>1111.11</td><td>20027.00</td><td>378.89</td><td>25.56</td><td>13.7%</td></tr><tr><td>6</td><td>1111.11</td><td>20027.00</td><td>193.51</td><td>50.00</td><td>15.3%</td></tr><tr><td>12</td><td>1111.11</td><td>20027.00</td><td>99.53</td><td>83.33</td><td>13.6%</td></tr><tr><td>3</td><td>123.67</td><td>2229.00</td><td>42.16</td><td>2.84</td><td>13.7%</td></tr><tr><td>6</td><td>123.67</td><td>2229.00</td><td>21.53</td><td>5.57</td><td>15.3%</td></tr><tr><td>12</td><td>123.67</td><td>2229.00</td><td>11.07</td><td>9.28</td><td>13.6%</td></tr></tbody></table><h2 id="支付宝花呗分期费用计算-PHP-示例代码-1"><a href="#支付宝花呗分期费用计算-PHP-示例代码-1" class="headerlink" title="支付宝花呗分期费用计算 PHP 示例代码"></a>支付宝花呗分期费用计算 PHP 示例代码</h2><blockquote><p>以下代码摘抄自 <a href="https://github.com/pudongping/global-pay">pudongping/global-pay 跨境支付宝 PHP 支付插件包</a></p></blockquote><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * document link： https://opendocs.alipay.com/mini/introduce/antcreditpay-istallment * document link： https://opendocs.alipay.com/open/277/105952 * * Created by PhpStorm * User: Alex * Date: 2021-08-29 16:03 * E-mail: &lt;276558492@qq.com&gt; */</span><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HbFqCost</span><span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token constant">USER_ASSUME</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 用户承担手续费</span>    <span class="token keyword">const</span> <span class="token constant">SELLER_ASSUME</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>  <span class="token comment">// 商家承担手续费</span>    <span class="token keyword">const</span> <span class="token constant">VALIDATE_NPER</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 花呗分期合法的分期数</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token variable">$rate</span> <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">USER_ASSUME</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>            <span class="token number">3</span> <span class="token operator">=&gt;</span> <span class="token number">0.023</span><span class="token punctuation">,</span>            <span class="token number">6</span> <span class="token operator">=&gt;</span> <span class="token number">0.045</span><span class="token punctuation">,</span>            <span class="token number">12</span> <span class="token operator">=&gt;</span> <span class="token number">0.075</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">SELLER_ASSUME</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>            <span class="token number">3</span> <span class="token operator">=&gt;</span> <span class="token number">0.018</span><span class="token punctuation">,</span>            <span class="token number">6</span> <span class="token operator">=&gt;</span> <span class="token number">0.045</span><span class="token punctuation">,</span>            <span class="token number">12</span> <span class="token operator">=&gt;</span> <span class="token number">0.075</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 获取花呗分期计费情况     *     * @param float $totalAmount  本金     * @param bool $isShowAll  是否显示每一期的还款数     * @param bool $isSellerPercent  是否商家承担所有的手续费     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">fetchHbFqCost</span><span class="token punctuation">(</span><span class="token keyword type-hint">float</span> <span class="token variable">$totalAmount</span><span class="token punctuation">,</span> <span class="token keyword type-hint">bool</span> <span class="token variable">$isShowAll</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token keyword type-hint">bool</span> <span class="token variable">$isSellerPercent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>    <span class="token punctuation">{</span>        <span class="token variable">$assume</span> <span class="token operator">=</span> <span class="token variable">$isSellerPercent</span> <span class="token operator">?</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">SELLER_ASSUME</span> <span class="token punctuation">:</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">USER_ASSUME</span><span class="token punctuation">;</span>        <span class="token variable">$rates</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$rate</span><span class="token punctuation">[</span><span class="token variable">$assume</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$rates</span> <span class="token keyword">as</span> <span class="token variable">$nper</span> <span class="token operator">=&gt;</span> <span class="token variable">$rate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">calHbFqCost</span><span class="token punctuation">(</span><span class="token variable">$nper</span><span class="token punctuation">,</span> <span class="token variable">$rate</span><span class="token punctuation">,</span> <span class="token variable">$totalAmount</span><span class="token punctuation">,</span> <span class="token variable">$isShowAll</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 计算花呗分期手续费     *     * @param int $nper  期数     * @param float $rate  费率     * @param float $totalAmount  本金     * @param bool $showAll  是否显示每一期的还款数     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">calHbFqCost</span><span class="token punctuation">(</span><span class="token keyword type-hint">int</span> <span class="token variable">$nper</span><span class="token punctuation">,</span> <span class="token keyword type-hint">float</span> <span class="token variable">$rate</span><span class="token punctuation">,</span> <span class="token keyword type-hint">float</span> <span class="token variable">$totalAmount</span><span class="token punctuation">,</span> <span class="token keyword type-hint">bool</span> <span class="token variable">$showAll</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$totalAmountCent</span> <span class="token operator">=</span> <span class="token function">bcmul</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$totalAmount</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'100'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1. 把金额单位转化成分 cent</span>        <span class="token comment">// 用户每期本金</span>        <span class="token variable">$perAmount</span> <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcdiv</span><span class="token punctuation">(</span><span class="token variable">$totalAmountCent</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$nper</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2. 计算每期本金（用总金额/总期数，结果以分表示，向下取整）</span>        <span class="token comment">// 用户每期手续费</span>        <span class="token variable">$buyerTotalCost</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">float</span><span class="token punctuation">)</span><span class="token function">bcmul</span><span class="token punctuation">(</span><span class="token variable">$totalAmountCent</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$rate</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//  2. 用转化为分后的金额乘以买家费率，得到以分表示的买家总费用（总手续费）</span>        <span class="token variable">$roundTotalCost</span> <span class="token operator">=</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token variable">$buyerTotalCost</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">PHP_ROUND_HALF_EVEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3. 对费用进行取整（取整规则为 ROUND_HALF_EVEN ）</span>        <span class="token variable">$perCharge</span> <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcdiv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$roundTotalCost</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$nper</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 4. 计算每期费用（用总费用/总期数，结果以分表示，向下取整）</span>        <span class="token comment">// 用户每期总费用</span>        <span class="token variable">$perTotalAmount</span> <span class="token operator">=</span> <span class="token function">bcadd</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$perAmount</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$perCharge</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 金额以 [元] 为单位</span>        <span class="token variable">$perAmountYuan</span> <span class="token operator">=</span> <span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcdiv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$perAmount</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'100'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$perChargeYuan</span> <span class="token operator">=</span> <span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcdiv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$perCharge</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'100'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$perTotalAmountYuan</span> <span class="token operator">=</span> <span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcdiv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$perTotalAmount</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'100'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$buyerTotalCostYuan</span> <span class="token operator">=</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcdiv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$buyerTotalCost</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'100'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 花呗分期的总手续费实行“四舍五入”的原则进行计算</span>        <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'nper'</span> <span class="token operator">=&gt;</span> <span class="token variable">$nper</span><span class="token punctuation">,</span>  <span class="token comment">// 期数</span>            <span class="token string single-quoted-string">'total_amount'</span> <span class="token operator">=&gt;</span> <span class="token variable">$totalAmount</span><span class="token punctuation">,</span>  <span class="token comment">// 本金</span>            <span class="token string single-quoted-string">'total_charge'</span> <span class="token operator">=&gt;</span> <span class="token variable">$buyerTotalCostYuan</span><span class="token punctuation">,</span>  <span class="token comment">// 总手续费</span>            <span class="token string single-quoted-string">'rate'</span> <span class="token operator">=&gt;</span> <span class="token variable">$rate</span><span class="token punctuation">,</span>  <span class="token comment">// 利率</span>            <span class="token string single-quoted-string">'per_charge'</span> <span class="token operator">=&gt;</span> <span class="token variable">$perChargeYuan</span><span class="token punctuation">,</span>  <span class="token comment">// 每期手续费</span>            <span class="token string single-quoted-string">'per_amount'</span> <span class="token operator">=&gt;</span> <span class="token variable">$perAmountYuan</span><span class="token punctuation">,</span>  <span class="token comment">// 每期本金</span>            <span class="token string single-quoted-string">'per_total_amount'</span> <span class="token operator">=&gt;</span> <span class="token variable">$perTotalAmountYuan</span><span class="token punctuation">,</span>  <span class="token comment">// 每期总费用</span>            <span class="token string single-quoted-string">'refund_list'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 还款列表</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$showAll</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'refund_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRefundList</span><span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$ret</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取还款的列表     *     * @param array $params     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getRefundList</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$params</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$nper</span> <span class="token operator">=</span> <span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nper'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 期数</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token variable">$nper</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$item</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nper'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$i</span><span class="token punctuation">;</span>  <span class="token comment">// 第几期</span>            <span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'charge'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'per_charge'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 当前期数所需要支付的手续费</span>            <span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'amount'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'per_amount'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 当前期数所需要支付的本金数</span>            <span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'current_total_amount'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'per_total_amount'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 当前期数所需要支付的总费用</span>            <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$item</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$charges</span> <span class="token operator">=</span> <span class="token function">array_column</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'charge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 计算的所有手续费总和</span>        <span class="token variable">$chargesSum</span> <span class="token operator">=</span> <span class="token function">array_reduce</span><span class="token punctuation">(</span><span class="token variable">$charges</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$carry</span><span class="token punctuation">,</span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">bcadd</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$carry</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$item</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$amounts</span> <span class="token operator">=</span> <span class="token function">array_column</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'amount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 计算的所有本金总和</span>        <span class="token variable">$amountsSum</span> <span class="token operator">=</span> <span class="token function">array_reduce</span><span class="token punctuation">(</span><span class="token variable">$amounts</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$carry</span><span class="token punctuation">,</span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">bcadd</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$carry</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$item</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 如果所需支付的总手续费大于计算后的手续费总和，那么则需要将缺少的手续费补加到第一期</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'total_charge'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword type-casting">float</span><span class="token punctuation">)</span><span class="token variable">$chargesSum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'charge'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcadd</span><span class="token punctuation">(</span><span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'charge'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bcsub</span><span class="token punctuation">(</span><span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'total_charge'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$chargesSum</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 如果所需要支付的本金大于计算后的本金总和，那么则需要将缺少的本金补加到第一期</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'total_amount'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword type-casting">float</span><span class="token punctuation">)</span><span class="token variable">$amountsSum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'amount'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcadd</span><span class="token punctuation">(</span><span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'amount'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bcsub</span><span class="token punctuation">(</span><span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'total_amount'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$amountsSum</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 第一期所需要支付的总金额</span>        <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'current_total_amount'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">floatval</span><span class="token punctuation">(</span><span class="token function">bcadd</span><span class="token punctuation">(</span><span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'charge'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'amount'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$istallment</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HbFqCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$istallment</span><span class="token operator">-&gt;</span><span class="token function">fetchHbFqCost</span><span class="token punctuation">(</span><span class="token number">123.67</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Pay </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 支付宝花呗分期 </tag>
            
            <tag> 支付 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简单易用且优雅的跨境支付 PHP SDK 扩展包</title>
      <link href="posts/1c7fe35b.html"/>
      <url>posts/1c7fe35b.html</url>
      
        <content type="html"><![CDATA[<h1 align="center"><a href="https://github.com/pudongping/global-pay">GlobalPay</a></h1><p>支持国际版支付的 PHP SDK，目前<strong>只支持支付宝国际版</strong>。因目前支付宝跨境在线支付服务只支持 app、wap、web 和报关这四种，本 SDK 提供了 app、wap、web 这三种跨境支付，<a href="https://global.alipay.com/docs/ac/legacy/legacydoc">详见国际支付宝官方文档</a> 。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> require pudongping/global-pay <span class="token parameter variable">-vvv</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ul><li>命名规范</li><li>隐藏开发者不需要关注的细枝末节</li><li>符合 PSR 规范，可以方便的与各种 PHP 框架集成</li><li>有良好的文档，包含各种示例方法以及官方返回结果。<a href="https://pudongping.github.io/global-pay-doc">文档地址</a> ： <a href="https://pudongping.github.io/global-pay-doc">https://pudongping.github.io/global-pay-doc</a></li></ul><h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><ul><li>PHP &gt;= 7.1.3</li><li>Composer</li></ul><h2 id="支持的支付方法"><a href="#支持的支付方法" class="headerlink" title="支持的支付方法"></a>支持的支付方法</h2><h3 id="支付宝"><a href="#支付宝" class="headerlink" title="支付宝"></a>支付宝</h3><ul><li>电脑支付</li><li>手机网站支付</li><li>APP 支付</li></ul><table><thead><tr><th align="center">method</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">web</td><td align="center">电脑支付</td></tr><tr><td align="center">wap</td><td align="center">手机网站支付</td></tr><tr><td align="center">app</td><td align="center">APP 支付</td></tr></tbody></table><h2 id="支持的方法"><a href="#支持的方法" class="headerlink" title="支持的方法"></a>支持的方法</h2><blockquote><p>所有网关均支持以下方法</p></blockquote><ul><li><p>find(array|string $order)<br><strong>说明：</strong> 查找订单接口<br><strong>参数：</strong> <code>$order</code> 为 <code>string</code> 类型时，请传入系统订单号，对应跨境支付宝中的 <code>out_trade_no</code> 参数； <code>array</code> 类型时，参数请参考<a href="https://global.alipay.com/docs/ac/global/single_trade_query_cn">支付宝境外订单单笔查询文档</a> 。<br><strong>返回：</strong> 查询成功，返回 <code>Illuminate\Support\Collection</code> 实例，可以通过 <code>$collection-&gt;toArray()</code> 或者 <code>$collection-&gt;all()</code> 或者 <code>$collection-&gt;get('field')</code> 访问服务器返回的数据。</p></li><li><p>refund(array $order)<br><strong>说明：</strong> 退款接口<br><strong>参数：</strong>  <code>$order</code> 数组格式，退款参数请参考<a href="https://global.alipay.com/docs/ac/global/forex_refund_cn">支付宝境外退款接口文档</a> 。<br><strong>返回：</strong> 退款成功，返回 <code>Illuminate\Support\Collection</code> 实例，可以通过 <code>$collection-&gt;toArray()</code> 或者 <code>$collection-&gt;all()</code> 或者 <code>$collection-&gt;get('field')</code> 访问服务器返回的数据。</p></li><li><p>verify()<br><strong>说明：</strong> 验证服务器返回数据是否合法<br><strong>返回：</strong> 验证成功，返回 <code>Illuminate\Support\Collection</code> 实例，可以通过 <code>$collection-&gt;toArray()</code> 或者 <code>$collection-&gt;all()</code> 或者 <code>$collection-&gt;get('field')</code> 访问服务器返回的数据。</p></li></ul><h2 id="其他通用方法"><a href="#其他通用方法" class="headerlink" title="其他通用方法"></a>其他通用方法</h2><ul><li><p>getExchangeRate()<br><strong>说明：</strong> 获取汇率。详见<a href="https://global.alipay.com/docs/ac/global/forex_rate_file_cn">支付宝境外汇率查询接口</a> 。<br><strong>返回：</strong> 获取成功，返回 <code>Illuminate\Support\Collection</code> 实例，可以通过 <code>$collection-&gt;toArray()</code> 或者 <code>$collection-&gt;all()</code> 或者 <code>$collection-&gt;get('field')</code> 访问服务器返回的数据。<br><strong>注意：</strong> 1、货币间的汇率会在北京时间每日 9：00 到 11:00 间变动一次；  2、汇率每日获取上限为 100 次。 （可能需要考虑通过缓存保存汇率，防止接口出现异常，因为本 SDK 没有做缓存处理）</p></li><li><p>getHbFqCost(float $totalAmount, bool $isShowAll = false, bool $isSellerPercent = false)<br><strong>说明：</strong> 获取花呗分期计费情况<br><strong>参数：</strong> <code>$totalAmount</code> 为分期的本金，<code>$isShowAll</code> 为是否显示每一期的还款数，<code>$isSellerPercent</code> 为 <code>true</code> 表示商家承担全部手续费，为 <code>false</code> 表示用户承担全部手续费。<br><strong>返回：</strong> 获取成功，返回 <code>Illuminate\Support\Collection</code> 实例，可以通过 <code>$collection-&gt;toArray()</code> 或者 <code>$collection-&gt;all()</code> 或者 <code>$collection-&gt;get('field')</code> 访问服务器返回的数据。</p></li></ul><p>返回参数说明</p><table><thead><tr><th>参数</th><th align="center">含义</th></tr></thead><tbody><tr><td>nper</td><td align="center">期数</td></tr><tr><td>total_amount</td><td align="center">本金</td></tr><tr><td>total_charge</td><td align="center">总手续费</td></tr><tr><td>rate</td><td align="center">利率</td></tr><tr><td>per_charge</td><td align="center">每期手续费</td></tr><tr><td>per_amount</td><td align="center">每期本金</td></tr><tr><td>per_total_amount</td><td align="center">每期总费用</td></tr><tr><td>refund_list</td><td align="center">还款列表</td></tr><tr><td>refund_list.nper</td><td align="center">第几期</td></tr><tr><td>refund_list.charge</td><td align="center">当前期数所需要支付的手续费</td></tr><tr><td>refund_list.amount</td><td align="center">当前期数所需要支付的本金数</td></tr><tr><td>refund_list.current_total_amount</td><td align="center">当前期数所需要支付的总费用</td></tr></tbody></table><h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><h3 id="非花呗分期支付"><a href="#非花呗分期支付" class="headerlink" title="非花呗分期支付"></a>非花呗分期支付</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Pudongping<span class="token punctuation">\</span>GlobalPay<span class="token punctuation">\</span>GlobalPay</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Pudongping<span class="token punctuation">\</span>GlobalPay<span class="token punctuation">\</span>Log</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">PayController</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'partner'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'2088000000000000'</span><span class="token punctuation">,</span>  <span class="token comment">// 合作身份者 id，以 2088 开头的 16 位纯数字</span>        <span class="token string single-quoted-string">'notify_url'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'http://a90b-8-37-43-168.demo.io/index/notify_url'</span><span class="token punctuation">,</span>  <span class="token comment">// 异步回调地址</span>        <span class="token string single-quoted-string">'return_url'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'http://a90b-8-37-43-168.demo.io/index/return_url'</span><span class="token punctuation">,</span>  <span class="token comment">// 同步回调地址</span>        <span class="token string single-quoted-string">'refer_url'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'https://www.demo.net'</span><span class="token punctuation">,</span>  <span class="token comment">// 二级商户网站地址</span>        <span class="token string single-quoted-string">'seller_email'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'xxxx@gmail.com'</span><span class="token punctuation">,</span>  <span class="token comment">// 签约支付宝账号或卖家支付宝帐户</span>        <span class="token string single-quoted-string">'key'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'xxxx'</span><span class="token punctuation">,</span>  <span class="token comment">// 安全检验码，以数字和字母组成的 32 位字符</span>        <span class="token string single-quoted-string">'sign_type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'RSA'</span><span class="token punctuation">,</span>  <span class="token comment">// 不需要修改</span>        <span class="token string single-quoted-string">'input_charset'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'UTF-8'</span><span class="token punctuation">,</span>  <span class="token comment">// 商户网站使用的编码格式，建议不需要修改</span>        <span class="token string single-quoted-string">'transport'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'http'</span><span class="token punctuation">,</span>  <span class="token comment">// 访问模式,根据自己的服务器是否支持 ssl 访问，若支持请选择 https；若不支持请选择 http</span>        <span class="token string single-quoted-string">'split_fund'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'2088000000000000:0.10'</span><span class="token punctuation">,</span>  <span class="token comment">// 接受分账资金的支付宝账户 ID 和比例，用逗号分隔其他帐号信息。ID 是以 2088 开头的纯 16 位数字。</span>        <span class="token string single-quoted-string">'private_key'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'/Users/pudongping/glory/key/alipay_private_key.pem'</span><span class="token punctuation">,</span>  <span class="token comment">// 私钥路径</span>        <span class="token string single-quoted-string">'public_key'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'/Users/pudongping/glory/key/alipay_public_key.pem'</span><span class="token punctuation">,</span>  <span class="token comment">// 公钥路径</span>        <span class="token string single-quoted-string">'log'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> <span class="token comment">// optional</span>            <span class="token string single-quoted-string">'file'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'alipay.log'</span><span class="token punctuation">,</span>  <span class="token comment">// 当前目录下</span>            <span class="token string single-quoted-string">'level'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'debug'</span><span class="token punctuation">,</span> <span class="token comment">// 建议生产环境等级调整为 info，开发环境为 debug</span>            <span class="token string single-quoted-string">'type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'single'</span><span class="token punctuation">,</span> <span class="token comment">// optional, 可选 daily.</span>            <span class="token string single-quoted-string">'max_file'</span> <span class="token operator">=&gt;</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token comment">// optional, 当 type 为 daily 时有效，默认 30 天</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'http'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> <span class="token comment">// optional</span>            <span class="token string single-quoted-string">'timeout'</span> <span class="token operator">=&gt;</span> <span class="token number">5.0</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'connect_timeout'</span> <span class="token operator">=&gt;</span> <span class="token number">5.0</span><span class="token punctuation">,</span>            <span class="token comment">// 更多配置项请参考 [Guzzle](https://guzzle-cn.readthedocs.io/zh_CN/latest/request-options.html)</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'mode'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'dev'</span><span class="token punctuation">,</span> <span class="token comment">// optional,设置此参数，将进入沙箱模式</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/**     * document link: https://global.alipay.com/docs/ac/web_cn/about     *     * @return mixed     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">web</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'subject'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易 alex '</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'currency'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'JPY'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'rmb_fee'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'0.20'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'trade_information'</span> <span class="token operator">=&gt;</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                <span class="token string single-quoted-string">'business_type'</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'goods_info'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'変身ベ...^1'</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'total_quantity'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">// '_only_args' =&gt; true  // 只需要返回参数模式时增加</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">web</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 如果设置了 `_only_args` 为 true，则使用以下方法获取所有的参数</span>        <span class="token comment">// var_dump($globalPay-&gt;getContent());</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * document link:  https://global.alipay.com/docs/ac/wap_cn/start     *     * @return mixed     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">wap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'subject'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易 alex '</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'currency'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'JPY'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'rmb_fee'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'0.10'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'trade_information'</span> <span class="token operator">=&gt;</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                <span class="token string single-quoted-string">'business_type'</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'goods_info'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'変身ベ...^1'</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'total_quantity'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">// '_only_args' =&gt; true  // 只需要返回参数模式时增加</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">wap</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 如果设置了 `_only_args` 为 true，则使用以下方法获取所有的参数</span>        <span class="token comment">// var_dump($globalPay-&gt;getContent());</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * document link: https://global.alipay.com/docs/ac/app_cn/about     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'alex_'</span> <span class="token operator">.</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'subject'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易 5200'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'currency'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'JPY'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'rmb_fee'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'1.01'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'trade_information'</span> <span class="token operator">=&gt;</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                <span class="token string single-quoted-string">'business_type'</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'goods_info'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'大海にて^1'</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'total_quantity'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 单笔查询接口 document link: https://global.alipay.com/docs/ac/global/single_trade_query_cn     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// out_trade_no 和 trade_no 参数可以同时含有，也可以二选一</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'alex_1629950066'</span><span class="token punctuation">,</span>            <span class="token comment">// 'trade_no' =&gt; '2021082622001364941434754996',</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 退款接口 document link： https://global.alipay.com/docs/ac/global/forex_refund_cn     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">refund</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_return_no'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'alex_refund_'</span> <span class="token operator">.</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'alex_1629950066'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'return_rmb_amount'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'1.01'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'currency'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'JPY'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'reason'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'退款测试'</span><span class="token punctuation">,</span>            <span class="token comment">// 'is_sync' =&gt; 'N',  // 如果 is_sync =&gt; N 则开启异步通知，否则不开启异步通知，不开启异步通知 notify_url 参数将会失效（不需要开启时，则不需要设置）</span>            <span class="token comment">// 'notify_url' =&gt; 'http://api.demo.com:8016/v2/alipay/forexNotify',  // $order['notify_url'] 设置了，则使用 $order['notify_url'] 的值，否则使用配置文件中的 notify_url 参数</span>            <span class="token comment">// 'type' =&gt; 'pc',  // 如果是网站支付，则需要设置 type 参数为 pc，手机浏览器或支付宝钱包支付时，不需要设置</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">refund</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 同步验签     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 异步验签     *     * @return mixed     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 验签</span>            <span class="token comment">// 建议必须对以下几个参数进行业务逻辑验证</span>            <span class="token variable">$outTradeNo</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'out_trade_no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 商户需要验证该通知数据中的 out_trade_no 是否为商户系统中创建的订单号。</span>            <span class="token variable">$tradeStatus</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'trade_status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 在支付宝的业务通知中，只有交易通知状态为 TRADE_FINISHED 时，支付宝才会认定为买家付款成功。</span>            <span class="token variable">$totalFee</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'total_fee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 该笔订单的总金额。请求时对应的参数，原样通知回来。（外币金额）</span>            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GlobalPay Notify ===&gt; '</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$exception</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'异步通知异常 ===&gt; '</span> <span class="token operator">.</span> <span class="token variable">$exception</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 其他框架</span>            <span class="token comment">// return $globalPay-&gt;fail();  // Laravel 框架可以直接这样</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 其他框架</span>        <span class="token comment">// return $globalPay-&gt;success();  //  Laravel 框架可以直接这样</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取汇率     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getExchangeRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getExchangeRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="花呗分期支付"><a href="#花呗分期支付" class="headerlink" title="花呗分期支付"></a>花呗分期支付</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Pudongping<span class="token punctuation">\</span>GlobalPay<span class="token punctuation">\</span>GlobalPay</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Pudongping<span class="token punctuation">\</span>GlobalPay<span class="token punctuation">\</span>Log</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HbfqPayController</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">web</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'subject'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易 alex'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'currency'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'JPY'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'rmb_fee'</span> <span class="token operator">=&gt;</span> <span class="token number">5.45</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'trade_information'</span> <span class="token operator">=&gt;</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                <span class="token string single-quoted-string">'business_type'</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'goods_info'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易费用^1'</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'total_quantity'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'hb_fq_param'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>                <span class="token string single-quoted-string">'num'</span> <span class="token operator">=&gt;</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">// 花呗分期分期数，只支持 3、6、12 期</span>                <span class="token comment">// 只有 is_has_household 为 true， is_seller_percent 才能设置为 true</span>                <span class="token string single-quoted-string">'is_has_household'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否拥有出资户，只有拥有出资户，商家才能贴息，否则只能用户贴息</span>                <span class="token string single-quoted-string">'is_seller_percent'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否商家贴息</span>                <span class="token comment">// 花呗分期开启订单传参贴息活动（不支持 PC 支付，无论是国际还是国内的交易都不支持）</span>                <span class="token comment">// 因此相比 app 支付，不能传递 is_order_subsidy 参数</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment">// '_only_args' =&gt; true  // 只需要返回参数模式时增加</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">web</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 如果设置了 `_only_args` 为 true，则使用以下方法获取所有的参数</span>        <span class="token comment">// var_dump($globalPay-&gt;getContent());</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">wap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'subject'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易 alex'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'currency'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'JPY'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'rmb_fee'</span> <span class="token operator">=&gt;</span> <span class="token number">5.45</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'trade_information'</span> <span class="token operator">=&gt;</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                <span class="token string single-quoted-string">'business_type'</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'goods_info'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易费用^1'</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'total_quantity'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'hb_fq_param'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>                <span class="token string single-quoted-string">'num'</span> <span class="token operator">=&gt;</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">// 花呗分期分期数，只支持 3、6、12 期</span>                <span class="token comment">// 只有 is_has_household 为 true， is_seller_percent 才能设置为 true</span>                <span class="token string single-quoted-string">'is_has_household'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否拥有出资户，只有拥有出资户，商家才能贴息，否则只能用户贴息</span>                <span class="token string single-quoted-string">'is_seller_percent'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否商家贴息</span>                <span class="token comment">// 花呗分期开启订单传参贴息活动（不支持 PC 支付，无论是国际还是国内的交易都不支持）</span>                <span class="token comment">// 因此相比 app 支付，不能传递 is_order_subsidy 参数</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment">// '_only_args' =&gt; true  // 只需要返回参数模式时增加</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">wap</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 如果设置了 `_only_args` 为 true，则使用以下方法获取所有的参数</span>        <span class="token comment">// var_dump($globalPay-&gt;getContent());</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'subject'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易 alex'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'currency'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'JPY'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'rmb_fee'</span> <span class="token operator">=&gt;</span> <span class="token number">3.45</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'trade_information'</span> <span class="token operator">=&gt;</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                <span class="token string single-quoted-string">'business_type'</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'goods_info'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'交易费用^1'</span><span class="token punctuation">,</span>                <span class="token string single-quoted-string">'total_quantity'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'hb_fq_param'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>                <span class="token string single-quoted-string">'num'</span> <span class="token operator">=&gt;</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">// 花呗分期分期数，只支持 3、6、12 期</span>                <span class="token comment">// 只有 is_has_household 为 true， is_seller_percent 才能设置为 true，否则 is_seller_percent 只能设置为 false</span>                <span class="token string single-quoted-string">'is_has_household'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否拥有出资户，只有拥有出资户，商家才能贴息，否则只能用户贴息</span>                <span class="token string single-quoted-string">'is_seller_percent'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否商家贴息， true 为商家贴息， false 为用户贴息</span>                <span class="token string single-quoted-string">'is_order_subsidy'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 是否开启订单传参贴息活动</span>                <span class="token comment">// 出资户贴息和订单传参贴息只能允许一个为 true</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// out_trade_no 和 trade_no 参数可以同时含有，也可以二选一</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'alex_1629950066'</span><span class="token punctuation">,</span>            <span class="token comment">// 'trade_no' =&gt; '2021082622001364941434754996',</span>            <span class="token string single-quoted-string">'is_hbfq'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 该笔订单是否为花呗分期支付，订单查询出来的结果会含有 hb_fq_num 参数，不是花呗分期订单则没有这个参数</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">refund</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 花呗分期退款和非花呗分期退款操作流程一致</span>        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'out_return_no'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'alex_refund_'</span> <span class="token operator">.</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'alex_1629950066'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'return_rmb_amount'</span> <span class="token operator">=&gt;</span> <span class="token number">3.45</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'currency'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'JPY'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'reason'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'退款测试'</span><span class="token punctuation">,</span>            <span class="token comment">// 'is_sync' =&gt; 'N',  // 如果 is_sync =&gt; N 则开启异步通知，否则不开启异步通知，不开启异步通知 notify_url 参数将会失效（不需要开启时，则不需要设置）</span>            <span class="token comment">// 'notify_url' =&gt; 'http://api.demo.com:8016/v2/alipay/forexNotify',  // $order['notify_url'] 设置了，则使用 $order['notify_url'] 的值，否则使用配置文件中的 notify_url 参数</span>            <span class="token comment">// 'type' =&gt; 'pc',  // 如果是网站支付，则需要设置 type 参数为 pc，手机浏览器或支付宝钱包支付时，不需要设置</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">refund</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 验签</span>            <span class="token comment">// 建议必须对以下几个参数进行业务逻辑验证</span>            <span class="token variable">$outTradeNo</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'out_trade_no'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 商户需要验证该通知数据中的 out_trade_no 是否为商户系统中创建的订单号。</span>            <span class="token variable">$tradeStatus</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'trade_status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 在支付宝的业务通知中，只有交易通知状态为 TRADE_FINISHED 时，支付宝才会认定为买家付款成功。</span>            <span class="token variable">$totalFee</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'total_fee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 该笔订单的总金额。请求时对应的参数，原样通知回来。（外币金额）</span>            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GlobalPay Notify ===&gt; '</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$exception</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'异步通知异常 ===&gt; '</span> <span class="token operator">.</span> <span class="token variable">$exception</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 其他框架</span>            <span class="token comment">// return $globalPay-&gt;fail();  // Laravel 框架可以直接这样</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 其他框架</span>        <span class="token comment">// return $globalPay-&gt;success();  //  Laravel 框架可以直接这样</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取花呗分期计费情况     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getHbFqCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$totalAmount</span> <span class="token operator">=</span> <span class="token number">100.88</span><span class="token punctuation">;</span>        <span class="token comment">// 只需要获取 3 6 12 期相对应的还款数</span>        <span class="token comment">// $globalPay = GlobalPay::alipay($this-&gt;config)-&gt;getHbFqCost($totalAmount);</span>        <span class="token comment">// 获取 3 6 12 期相对应到还款数且显示出每一期的还款情况（用户承担所有的手续费）</span>        <span class="token comment">// $globalPay = GlobalPay::alipay($this-&gt;config)-&gt;getHbFqCost($totalAmount, true);</span>        <span class="token comment">// 获取 3 6 12 期相对应到还款数且显示出每一期的还款情况（商家承担所有的手续费）</span>        <span class="token variable">$globalPay</span> <span class="token operator">=</span> <span class="token class-name static-context">GlobalPay</span><span class="token operator">::</span><span class="token function">alipay</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getHbFqCost</span><span class="token punctuation">(</span><span class="token variable">$totalAmount</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$globalPay</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="LICENSE"><a href="#LICENSE" class="headerlink" title="LICENSE"></a>LICENSE</h2><p>MIT</p>]]></content>
      
      
      <categories>
          
          <category> Pay </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 支付 </tag>
            
            <tag> 跨境支付 </tag>
            
            <tag> SDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hyperf 启动服务脚本 start 、 status 、stop 、restart</title>
      <link href="posts/46a98e74.html"/>
      <url>posts/46a98e74.html</url>
      
        <content type="html"><![CDATA[<h1 id="Hyperf-启动服务脚本-start-、-status-、stop-、restart"><a href="#Hyperf-启动服务脚本-start-、-status-、stop-、restart" class="headerlink" title="Hyperf 启动服务脚本 start 、 status 、stop 、restart"></a>Hyperf 启动服务脚本 start 、 status 、stop 、restart</h1><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ol><li>在项目根目录，创建新的脚本文件 <code>server.sh</code> ，将以下内容复制进去</li><li>设置执行权限 <code>chmod u+x server.sh</code></li><li>执行命令 <code>./server.sh status</code> 即可</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 hyperf 服务状态</span>./server.sh status<span class="token comment"># 开启 hyperf 服务</span>./server.sh start<span class="token comment"># 关闭 hyperf 服务</span>./server.sh stop<span class="token comment"># 重启 hyperf 服务</span>./server.sh restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="脚本内容如下"><a href="#脚本内容如下" class="headerlink" title="脚本内容如下"></a>脚本内容如下</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#!/bin/bash</span><span class="token comment">#Author: Alex</span><span class="token comment">#server manager script based on hyperf 2.2.0</span><span class="token assign-left variable">base_path</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> `dirname $0`<span class="token punctuation">;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span><span class="token assign-left variable">server_file</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_path}</span>/bin/hyperf.php"</span><span class="token assign-left variable">pid_path</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_path}</span>/runtime/hyperf.pid"</span><span class="token assign-left variable">php_path</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">which</span> php<span class="token variable">)</span></span><span class="token assign-left variable">env_path</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_path}</span>/.env"</span><span class="token assign-left variable">runtime_container</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_path}</span>/runtime/container"</span><span class="token builtin class-name">cd</span> <span class="token variable">$base_path</span><span class="token keyword">function</span> <span class="token function-name function">console_blue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\033">\033</span>[36m[ <span class="token variable">$1</span> ]<span class="token entity" title="\033">\033</span>[0m"</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">console_green</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\033">\033</span>[32m[ <span class="token variable">$1</span> ]<span class="token entity" title="\033">\033</span>[0m"</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">console_orangered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\033">\033</span>[31m<span class="token entity" title="\033">\033</span>[01m[ <span class="token variable">$1</span> ]<span class="token entity" title="\033">\033</span>[0m"</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">console_yellow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\033">\033</span>[33m<span class="token entity" title="\033">\033</span>[01m[ <span class="token variable">$1</span> ]<span class="token entity" title="\033">\033</span>[0m"</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$env_path</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token keyword">then</span>    console_orangered <span class="token string">'You should copy the .env.example file and name it .env or create a new file and rename .env'</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token builtin class-name">source</span> <span class="token string">"<span class="token variable">$env_path</span>"</span><span class="token assign-left variable">project_name</span><span class="token operator">=</span><span class="token variable">${APP_NAME}</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$php_path</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>    console_orangered <span class="token string">'Please check if the PHP has been installed '</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token keyword">function</span> <span class="token function-name function">master_process_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">${pid_path}</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">then</span>        <span class="token assign-left variable">hyperf_pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $<span class="token punctuation">{</span>pid_path<span class="token punctuation">}</span><span class="token variable">`</span></span>        <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"<span class="token variable">${hyperf_pid}</span>"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">`</span></span>    <span class="token keyword">fi</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">master_process_name_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"<span class="token variable">${project_name}</span>.Master"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">`</span></span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">fetch_server_master_pid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"<span class="token variable">${project_name}</span>.Master"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token variable">`</span></span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">force_kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"<span class="token variable">${project_name}</span>"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token operator">&gt;&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">process_count</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>`master_process_count`<span class="token operator">+</span>`master_process_name_count`<span class="token variable">))</span></span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$process_count</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token keyword">then</span>        console_yellow <span class="token string">'The server has been stopped !'</span>        <span class="token builtin class-name">exit</span> <span class="token number">0</span>    <span class="token keyword">fi</span>    console_green <span class="token string">"The server is running ! Master pid is <span class="token variable"><span class="token variable">$(</span>fetch_server_master_pid<span class="token variable">)</span></span>"</span>    <span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">process_count</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>`master_process_count`<span class="token operator">+</span>`master_process_name_count`<span class="token variable">))</span></span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$process_count</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token keyword">then</span>        console_yellow <span class="token string">'The server has been stopped !'</span>        <span class="token builtin class-name">exit</span> <span class="token number">0</span>    <span class="token keyword">fi</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">${pid_path}</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token keyword">then</span>        <span class="token function">cat</span> <span class="token string">"<span class="token variable">${pid_path}</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token string">"<span class="token variable">${pid_path}</span>"</span>    <span class="token keyword">fi</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span>master_process_name_count<span class="token variable">)</span></span> <span class="token parameter variable">-gt</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token keyword">then</span>        force_kill    <span class="token keyword">fi</span>    console_green <span class="token string">'The server is stopped !'</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">process_count</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>`master_process_count`<span class="token operator">+</span>`master_process_name_count`<span class="token variable">))</span></span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$process_count</span> <span class="token parameter variable">-gt</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token keyword">then</span>        console_yellow <span class="token string">"The server has been started, Don't need start again ! "</span>        console_blue <span class="token string">"Master pid is : <span class="token variable"><span class="token variable">$(</span>fetch_server_master_pid<span class="token variable">)</span></span> "</span>        <span class="token builtin class-name">exit</span> <span class="token number">0</span>    <span class="token keyword">fi</span>    <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token string">"<span class="token variable">$runtime_container</span>"</span>    console_blue <span class="token string">'Starting now, please just a moment !'</span>    <span class="token comment"># change the parent process to init process</span>    setsid php <span class="token string">"<span class="token variable">${server_file}</span>"</span> start <span class="token operator">&gt;&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>    <span class="token function">sleep</span> <span class="token number">1</span>    console_green <span class="token string">"Started successful !"</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">${pid_path}</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token keyword">then</span>        console_blue <span class="token string">"Master pid is : <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $<span class="token punctuation">{</span>pid_path<span class="token punctuation">}</span><span class="token variable">`</span></span> "</span>    <span class="token keyword">fi</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-name function">help</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">cat</span> <span class="token operator">&lt;&lt;-</span> <span class="token string">EOF    Usage:        ./server.sh [options]    Options:        stop        Stop server        start       Start server        restart     Restart server        status      Check server status        help        Help documentEOF</span><span class="token punctuation">}</span><span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>  <span class="token string">'stop'</span><span class="token punctuation">)</span>    stop  <span class="token punctuation">;</span><span class="token punctuation">;</span>  <span class="token string">'start'</span><span class="token punctuation">)</span>    start  <span class="token punctuation">;</span><span class="token punctuation">;</span>  <span class="token string">'restart'</span><span class="token punctuation">)</span>    stop    start  <span class="token punctuation">;</span><span class="token punctuation">;</span>  <span class="token string">'status'</span><span class="token punctuation">)</span>    status  <span class="token punctuation">;</span><span class="token punctuation">;</span>  *<span class="token punctuation">)</span>    <span class="token builtin class-name">help</span>  <span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token keyword">esac</span><span class="token builtin class-name">exit</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hyperf </tag>
            
            <tag> Swoole </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hyperf 框架中开协程的几种方式</title>
      <link href="posts/b5fcf661.html"/>
      <url>posts/b5fcf661.html</url>
      
        <content type="html"><![CDATA[<h1 id="Hyperf-框架中开协程的几种方式"><a href="#Hyperf-框架中开协程的几种方式" class="headerlink" title="Hyperf 框架中开协程的几种方式"></a>Hyperf 框架中开协程的几种方式</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 开协程做请求 * * Created by PhpStorm * User: Alex * Date: 2021-09-21 19:22 * E-mail: &lt;276558492@qq.com&gt; */</span><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Utils<span class="token punctuation">\</span>Parallel</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Utils<span class="token punctuation">\</span>WaitGroup</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Swoole<span class="token punctuation">\</span>Coroutine<span class="token punctuation">\</span>Channel</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Guzzle<span class="token punctuation">\</span>ClientFactory</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>HttpServer<span class="token punctuation">\</span>Annotation<span class="token punctuation">\</span>AutoController</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>HttpServer<span class="token punctuation">\</span>Contract<span class="token punctuation">\</span>RequestInterface</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Di<span class="token punctuation">\</span>Annotation<span class="token punctuation">\</span>Inject</span><span class="token punctuation">;</span><span class="token comment">/** * @AutoController * Class CoController * @package App\Controller */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">CoController</span><span class="token punctuation">{</span>    <span class="token comment">/**     * @Inject     * @var ClientFactory     */</span>    <span class="token keyword">private</span> <span class="token variable">$clientFactory</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 方便测试超时操作     *     * @param RequestInterface $request     * @return mixed     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sleep</span><span class="token punctuation">(</span><span class="token class-name type-declaration">RequestInterface</span> <span class="token variable">$request</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$seconds</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'seconds'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$seconds</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sleep hello ====&gt; '</span> <span class="token operator">.</span> <span class="token variable">$seconds</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$seconds</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 使用 Channel 做协程请求     *     * @return array     * @throws \GuzzleHttp\Exception\GuzzleException     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$channel</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$channel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clientFactory</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1:9516/co/sleep?seconds=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$channel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clientFactory</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1:9516/co/sleep?seconds=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">321</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 第一个协程返回的结果</span>        <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 第二个协程返回的结果</span>        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>  <span class="token comment">// [123, 321]</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 使用 WaitGroup 做协程请求     *     * @return array     * @throws \GuzzleHttp\Exception\GuzzleException     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 通过子协程并行的发起多个请求实现并行请求</span>        <span class="token variable">$wg</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaitGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$wg</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 因为开了两个协程，因此就要添加 2</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$wg</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clientFactory</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1:9516/co/sleep?seconds=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>            <span class="token variable">$wg</span><span class="token operator">-&gt;</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$wg</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clientFactory</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1:9516/co/sleep?seconds=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">321</span><span class="token punctuation">;</span>            <span class="token variable">$wg</span><span class="token operator">-&gt;</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$wg</span><span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 等待 add 计数器变为 0</span>        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>  <span class="token comment">// [321, 123]</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 使用 Parallel 类，做协程请求     *     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$parallel</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$parallel</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clientFactory</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1:9516/co/sleep?seconds=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">123</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$parallel</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clientFactory</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1:9516/co/sleep?seconds=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">321</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$parallel</span><span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>  <span class="token comment">// {"foo":123,"bar":321}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 使用 parallel 助手函数，做协程请求     *     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">[</span>            <span class="token string single-quoted-string">'foo'</span> <span class="token operator">=&gt;</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clientFactory</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1:9516/co/sleep?seconds=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token number">123</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'bar'</span> <span class="token operator">=&gt;</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clientFactory</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1:9516/co/sleep?seconds=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token number">321</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>  <span class="token comment">// {"foo":123,"bar":321}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hyperf </tag>
            
            <tag> Swoole </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 频繁使用命令</title>
      <link href="posts/6f6880af.html"/>
      <url>posts/6f6880af.html</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-频繁使用命令"><a href="#Linux-频繁使用命令" class="headerlink" title="Linux 频繁使用命令"></a>Linux 频繁使用命令</h1><!-- TOC --><ul><li><a href="#date">date</a></li><li><a href="#timedatectl">timedatectl</a></li><li><a href="#reboot">reboot</a></li><li><a href="#poweroff">poweroff</a></li><li><a href="#wget">wget</a></li><li><a href="#ps">ps</a></li><li><a href="#pstree">pstree</a></li><li><a href="#nice">nice</a></li><li><a href="#pidof">pidof</a></li><li><a href="#kill">kill</a></li><li><a href="#killall">killall</a></li><li><a href="#uname">uname</a></li><li><a href="#uptime">uptime</a></li><li><a href="#free">free</a></li><li><a href="#who">who</a></li><li><a href="#last">last</a></li><li><a href="#ping">ping</a></li><li><a href="#tracepath">tracepath</a></li><li><a href="#netstat">netstat</a></li><li><a href="#history">history</a></li><li><a href="#sosreport">sosreport</a></li><li><a href="#find">find</a></li><li><a href="#locate">locate</a></li><li><a href="#whereis">whereis</a></li><li><a href="#which">which</a></li><li><a href="#cat">cat</a></li><li><a href="#more">more</a></li><li><a href="#less">less</a></li><li><a href="#head">head</a></li><li><a href="#tail">tail</a></li><li><a href="#tr">tr</a></li><li><a href="#wc">wc</a></li><li><a href="#stat">stat</a></li><li><a href="#grep">grep</a></li><li><a href="#cut">cut</a></li><li><a href="#diff">diff</a></li><li><a href="#uniq">uniq</a></li><li><a href="#sort">sort</a></li><li><a href="#touch">touch</a></li><li><a href="#cp">cp</a></li><li><a href="#rm">rm</a></li><li><a href="#dd">dd</a></li><li><a href="#file">file</a></li></ul><!-- /TOC --><h2 id="date"><a href="#date" class="headerlink" title="date"></a>date</h2><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>%S</td><td>秒（00～59）</td></tr><tr><td>%M</td><td>分钟（00～59）</td></tr><tr><td>%H</td><td>小时（00～23）</td></tr><tr><td>%I</td><td>小时（00～12）</td></tr><tr><td>%m</td><td>月份（1~12）</td></tr><tr><td>%p</td><td>显示出AM或PM</td></tr><tr><td>%a</td><td>缩写的工作日名称（例如：Sun）</td></tr><tr><td>%A</td><td>完整的工作日名称（例如：Sunday）</td></tr><tr><td>%b</td><td>缩写的月份名称（例如：Jan）</td></tr><tr><td>%B</td><td>完整的月份名称（例如：January）</td></tr><tr><td>%q</td><td>季度（1~4）</td></tr><tr><td>%y</td><td>简写年份（例如：20）</td></tr><tr><td>%Y</td><td>完整年份（例如：2020）</td></tr><tr><td>%d</td><td>本月中的第几天</td></tr><tr><td>%j</td><td>今年中的第几天</td></tr><tr><td>%n</td><td>换行符（相当于按下回车键）</td></tr><tr><td>%t</td><td>跳格（相当于按下Tab键）</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看当前系统时间</span><span class="token function">date</span><span class="token comment"># Sat Sep 5 09:13:45 CST 2020</span><span class="token comment"># 按照“年-月-日 小时:分钟:秒”的格式查看当前系统时间的 date</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token comment"># 2020-09-05 09:14:35</span><span class="token comment"># 将系统的当前时间设置为 2020 年 11 月 1 日 8 点 30 分</span><span class="token function">date</span> <span class="token parameter variable">-s</span> <span class="token string">"20201101 8:30:00"</span><span class="token comment"># Sun Nov 1 08:30:00 CST 2020</span><span class="token function">date</span><span class="token comment"># Sun Nov 1 08:30:08 CST 2020</span><span class="token comment"># date 命令中的参数 %j 可用来查看今天是当年中的第几天。这个参数能够很好地区分备份时间的早晚，即数字越大，越靠近当前时间。</span><span class="token function">date</span> <span class="token string">"+%j"</span><span class="token comment"># 305</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="timedatectl"><a href="#timedatectl" class="headerlink" title="timedatectl"></a><span id="timedatectl">timedatectl</span></h2><blockquote><p>time date control</p></blockquote><p>timedatectl 命令用于设置系统的时间，发现电脑时间跟实际时间不符？如果只差几分钟的话，我们可以直接调整。但是，如果差几个小时，那么除了调整当前的时间，还有必要检查一下时区了。</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>status</td><td>显示状态信息</td></tr><tr><td>list-timezones</td><td>列出已知时区</td></tr><tr><td>set-time</td><td>设置系统时间</td></tr><tr><td>set-timezone</td><td>设置生效时区</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改时区</span>timedatectl set-timezone Asia/Shanghai<span class="token comment"># 修改系统日期</span>timedatectl set-time <span class="token number">2021</span>-05-18<span class="token comment"># 修改系统时间</span>timedatectl set-time <span class="token number">9</span>:30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="reboot"><a href="#reboot" class="headerlink" title="reboot"></a>reboot</h2><p>重启系统</p><h2 id="poweroff"><a href="#poweroff" class="headerlink" title="poweroff"></a>poweroff</h2><p>关闭系统</p><h2 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h2><blockquote><p>web get</p></blockquote><p>wget 命令用于在终端命令行中下载网络文件</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-b</td><td>后台下载模式</td></tr><tr><td>-P</td><td>下载到指定目录</td></tr><tr><td>-t</td><td>最大尝试次数</td></tr><tr><td>-c</td><td>断点续传</td></tr><tr><td>-p</td><td>下载页面内所有资源，包括图片、视频等</td></tr><tr><td>-r</td><td>递归下载</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 递归下载 www.linuxprobe.com 网站内的所有页面数据以及文件，下载完后会自动保存到当前路径下一个名为 www.linuxprobe.com 的目录中</span><span class="token function">wget</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-p</span> https://www.linuxprobe.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h2><blockquote><p>processes</p></blockquote><p>用于查看系统中的进程状态</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-a</td><td>显示所有进程（包括其他用户的进程）</td></tr><tr><td>-u</td><td>用户以及其他详细信息</td></tr><tr><td>-x</td><td>显示没有控制终端的进程</td></tr></tbody></table><h2 id="pstree"><a href="#pstree" class="headerlink" title="pstree"></a>pstree</h2><blockquote><p>process tree</p></blockquote><p>用于以树状图的形式展示进程之间的关系</p><h2 id="nice"><a href="#nice" class="headerlink" title="nice"></a>nice</h2><p>用于调整进程的优先级，语法格式为“nice优先级数字 服务名称”</p><p>在 top 命令输出的结果中，PR 和 NI 值代表的是进程的优先级，数字越低（取值范围是-20～19），优先级越高。在日常的生产工作中，可以将一些不重要进程的优先级调低，让紧迫的服务更多地利用 CPU 和内存资源，以达到合理分配系统资源的目的。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将 bash 服务的优先级调整到最高</span><span class="token function">nice</span> <span class="token parameter variable">-n</span> <span class="token parameter variable">-20</span> <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="pidof"><a href="#pidof" class="headerlink" title="pidof"></a>pidof</h2><p>用于查询某个指定服务进程的 PID 号码值，语法格式为 “pidof [参数] 服务名称”</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 每个进程的进程号码值（PID）是唯一的，可以用于区分不同的进程。例如，执行如下命令来查询本机上 sshd 服务程序的 PID：</span>pidof sshd<span class="token comment"># 2156</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 有时系统会提示进程无法被终止，此时可以加参数 -9，表示最高级别地强制杀死进程</span><span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token number">2156</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="killall"><a href="#killall" class="headerlink" title="killall"></a>killall</h2><p>用于终止某个指定名称的服务所对应的全部进程，语法格式为 “killall [参数] 服务名称”</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pidof httpd<span class="token comment"># 13581 13580 13579 13578 13577 13576</span><span class="token function">killall</span> httpd<span class="token comment"># 再次查看</span>pidof httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="uname"><a href="#uname" class="headerlink" title="uname"></a>uname</h2><p>uname 命令用于查看系统内核版本与系统架构等信息，英文全称为 “unix name”，语法格式为 “uname [-a]” 。在使用 uname 命令时，一般要固定搭配上 -a 参数来完整地查看当前系统的内核名称、主机名、内核发行版本、节点名、压制时间、硬件名称、硬件平台、处理器类型以及操作系统名称等信息。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">uname</span> <span class="token parameter variable">-a</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果要查看当前系统版本的详细信息，则需要查看 redhat-release 文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/redhat-release<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="uptime"><a href="#uptime" class="headerlink" title="uptime"></a>uptime</h2><blockquote><p>建议负载值保持在 1 左右，在生产环境中不要超过 5 就好。</p></blockquote><p>uptime 命令用于查看系统的负载信息。它可以显示当前系统时间、系统已运行时间、启用终端数量以及平均负载值等信息。平均负载值指的是系统在最近 1分钟、5分钟、15分钟内的压力情况，负载值越低越好。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">uptime</span><span class="token comment">#  0:16  up 5 days, 14:47, 8 users, load averages: 1.41 1.44 1.56</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><p>free 命令用于显示当前系统中内存的使用量信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">free</span> <span class="token parameter variable">-h</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="who"><a href="#who" class="headerlink" title="who"></a>who</h2><p>who 命令用于查看当前登入主机的用户终端信息。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">who</span><span class="token comment"># 登录的用户名 终端设备 登录到系统的时间</span><span class="token comment"># pudongping console  Sep  6 09:29</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="last"><a href="#last" class="headerlink" title="last"></a>last</h2><p>last 命令用于调取主机的被访记录，Linux 系统会将每次的登录信息都记录到日志文件中，如果哪天想翻阅了，直接执行这条命令就行。</p><h2 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h2><p>ping 命令用于测试主机之间的网络连通性。</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-c</td><td>总共发送次数</td></tr><tr><td>-l</td><td>指定网卡名称</td></tr><tr><td>-i</td><td>每次间隔时间（秒）</td></tr><tr><td>-W</td><td>最长等待时间（秒）</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">4</span> www.baidu.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="tracepath"><a href="#tracepath" class="headerlink" title="tracepath"></a>tracepath</h2><p>tracepath 命令用于显示数据包到达目的主机时途中经过的所有路由信息。当两台主机之间无法正常 ping 通时，要考虑两台主机之间是否有错误的路由信息，导致数据被某一台设备错误地丢弃。这时便可以使用 tracepath 命令追踪数据包到达目的主机时途中的所有路由信息，以分析是哪台设备出了问题。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tracepath www.baidu.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h2><p>netstat 命令用于显示如网络连接、路由表、接口状态等的网络相关信息，英文全称为 “network status”</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-a</td><td>显示所有连接中的Socket</td></tr><tr><td>-p</td><td>显示正在使用的Socket信息</td></tr><tr><td>-t</td><td>显示TCP协议的连接状态</td></tr><tr><td>-u</td><td>显示UDP协议的连接状态</td></tr><tr><td>-n</td><td>使用IP地址，不使用域名</td></tr><tr><td>-l</td><td>仅列出正在监听的服务状态</td></tr><tr><td>-i</td><td>现在网卡列表信息</td></tr><tr><td>-r</td><td>显示路由表信息</td></tr></tbody></table><h2 id="history"><a href="#history" class="headerlink" title="history"></a>history</h2><p>默认会显示出用户在本地计算机中执行过的最近 1000 条命令记录，可以通过修改 <code>/etc/profile</code> 文件中的 <code>HISTSIZE</code> 变量值来改变默认数量。历史命令都会被记录到 <code>~/.bash_history</code> 文件中。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清空命令历史记录</span><span class="token function">history</span> <span class="token parameter variable">-c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="sosreport"><a href="#sosreport" class="headerlink" title="sosreport"></a>sosreport</h2><p>sosreport 命令用于收集系统配置及架构信息并输出诊断文档。</p><h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-name</td><td>匹配名称</td></tr><tr><td>-perm</td><td>匹配权限（mode为完全匹配，-mode为包含即可）</td></tr><tr><td>-user</td><td>匹配所有者</td></tr><tr><td>-group</td><td>匹配所有组</td></tr><tr><td>-mtime -n +n</td><td>匹配修改内容的时间（-n指n天以内，+n指n天以前）</td></tr><tr><td>-atime -n +n</td><td>匹配访问文件的时间（-n指n天以内，+n指n天以前）</td></tr><tr><td>-ctime -n +n</td><td>匹配修改文件权限的时间（-n指n天以内，+n指n天以前）</td></tr><tr><td>-nouser</td><td>匹配无所有者的文件</td></tr><tr><td>-nogroup</td><td>匹配无所有组的文件</td></tr><tr><td>-newer f1 !f2</td><td>匹配比文件f1新但比f2旧的文件</td></tr><tr><td>–type b/d/c/p/l/f</td><td>匹配文件类型（后面的字幕字母依次表示块设备、目录、字符设备、管道、链接文件、文本文件）</td></tr><tr><td>-size</td><td>匹配文件的大小（+50KB为查找超过50KB的文件，而-50KB为查找小于50KB的文件）</td></tr><tr><td>-prune</td><td>忽略某个目录</td></tr><tr><td>-exec …… {};</td><td>后面可跟用于进一步处理搜索结果的命令</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取 /etc 目录中所有以 host 开头的文件列表</span><span class="token function">find</span> /etc <span class="token parameter variable">-name</span> <span class="token string">"host*"</span> <span class="token parameter variable">-print</span><span class="token comment"># 搜索整个系统中包含 SUID 权限的所有文件</span><span class="token function">find</span> / <span class="token parameter variable">-perm</span> <span class="token parameter variable">-4000</span> <span class="token parameter variable">-print</span><span class="token comment"># 在整个系统中找出所有归属于 alex 用户的文件，并复制到 /home/alex/findresults 目录中</span><span class="token function">find</span> / <span class="token parameter variable">-user</span> alex <span class="token parameter variable">-exec</span> <span class="token function">cp</span> <span class="token parameter variable">-a</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> /home/alex/findresults/<span class="token punctuation">\</span><span class="token punctuation">;</span><span class="token comment"># 其中的 `{}` 表示 find 命令搜索出的每一个文件，并且命令的结尾必须是 `\;`</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="locate"><a href="#locate" class="headerlink" title="locate"></a>locate</h2><p>locate 命令用于按照名称快速搜索文件所对应的位置。使用 find 命令进行全盘搜索虽然更准确，但是效率有点低。如果仅仅是想找一些常见的且又知道大概名称的文件，可以使用 locate 命令。在使用 locate 命令时，先使用 updatedb 命令生成一个索引库文件，这个库文件的名字是 <code>/var/lib/mlocate/mlocate.db</code> ，后续在使用 locate 命令搜索文件时就是在该库中进行查找操作，速度会快很多。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">updatedb<span class="token function">ls</span> <span class="token parameter variable">-l</span> /var/lib/mlocate/mlocate.db<span class="token comment"># 使用 locate 命令搜索出所有包含 alex 名称的文件所在的位置</span><span class="token function">locate</span> alex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="whereis"><a href="#whereis" class="headerlink" title="whereis"></a>whereis</h2><p>whereis 命令用于按照名称快速搜索二进制程序（命令）、源代码以及帮助文件所对应的位置，语法格式为 “whereis 命令名称”。</p><p>简单来说，whereis 命令也是基于 updatedb 命令所生成的索引库文件进行搜索，它与 locate 命令的区别是不关心那些相同名称的文件，仅仅是快速找到对应的命令文件及其帮助文件所在的位置。</p><h2 id="which"><a href="#which" class="headerlink" title="which"></a>which</h2><p>which 命令用于按照指定名称快速搜索二进制程序（命令）所对应的位置，语法格式为 “which 命令名称”。</p><p>which 命令是在 PATH 变量所指定的路径中，按照指定条件搜索命令所在的路径。也就是说，如果我们既不关心同名文件（find 与 locate），也不关心命令所对应的源代码和帮助文件（whereis），仅仅是想找到命令本身所在的路径，那么这个 which 命令就太合适了。</p><h2 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h2><blockquote><p>cat 是 concatenate（连接、连续）的简写</p></blockquote><ul><li>连接合并文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">11</span> <span class="token operator">&gt;</span> a.txt<span class="token builtin class-name">echo</span> <span class="token number">22</span> <span class="token operator">&gt;</span> b.txt<span class="token comment"># 合并 a.txt 和 b.txt 文件中所有的内容到 c.txt 文件中</span><span class="token function">cat</span> a.txt b.txt <span class="token operator">&gt;</span> c.txt<span class="token comment"># 查看 c.txt 文件中的内容</span><span class="token function">cat</span> c.txt  <span class="token comment"># 11 22</span><span class="token comment"># -n 参数可以显示行号</span><span class="token function">cat</span> <span class="token parameter variable">-n</span> c.txt<span class="token comment"># 1 11</span><span class="token comment"># 2 22</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="more"><a href="#more" class="headerlink" title="more"></a>more</h2><h2 id="less"><a href="#less" class="headerlink" title="less"></a>less</h2><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>-N</td><td>显示每行的行号</td></tr><tr><td>-S</td><td>行过长时将超出部分舍弃</td></tr><tr><td>-m</td><td>显示类似 more 命令的百分比</td></tr></tbody></table><p>less 进入交互界面时的指令及功能</p><table><thead><tr><th>交互指令</th><th>功能</th></tr></thead><tbody><tr><td>/字符串</td><td>向下搜索“字符串”的功能</td></tr><tr><td>?字符串</td><td>向上搜索“字符串”的功能</td></tr><tr><td>n</td><td>重复*前一个搜索</td></tr><tr><td>N</td><td>反向重复前一个搜索</td></tr><tr><td>k</td><td>向上移动一行</td></tr><tr><td>j</td><td>向下移动一行</td></tr><tr><td>u</td><td>向上移动半页</td></tr><tr><td>d</td><td>向下移动半页</td></tr><tr><td>b</td><td>向上移动一页</td></tr><tr><td>空格键</td><td>向下移动一页</td></tr><tr><td>g</td><td>移动到第一行</td></tr><tr><td>G</td><td>移动至最后一行</td></tr><tr><td>h 或 H</td><td>显示帮助界面</td></tr><tr><td>q 或 Q 或 ZZ</td><td>退出 less 命令</td></tr><tr><td>v</td><td>使用配置的编辑器编辑当前文件</td></tr></tbody></table><h2 id="head"><a href="#head" class="headerlink" title="head"></a>head</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 只想查看文本中前 10 行的内容</span><span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">10</span> test.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="tail"><a href="#tail" class="headerlink" title="tail"></a>tail</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 只想查看文本内容的最后 10 行</span><span class="token function">tail</span> <span class="token parameter variable">-n</span> <span class="token number">10</span> test.log<span class="token comment"># 实时查看文本</span><span class="token function">tail</span> <span class="token parameter variable">-f</span> test.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="tr"><a href="#tr" class="headerlink" title="tr"></a>tr</h2><p>tr 命令用于替换文本内容中的字符，英文全称为 “translate”，语法格式为 “tr [原始字符] [目标字符]”</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 把文本内容中的英文全部替换成大写</span><span class="token function">cat</span> test.log <span class="token operator">|</span> <span class="token function">tr</span> <span class="token punctuation">[</span>a-z<span class="token punctuation">]</span> <span class="token punctuation">[</span>A-Z<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="wc"><a href="#wc" class="headerlink" title="wc"></a>wc</h2><p>wc 命令用于统计指定文本文件的行数、字数或字节数，英文全称为 “word counts”，语法格式为 “wc [参数] 文件名称”</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-l</td><td>只显示行数</td></tr><tr><td>-w</td><td>只显示单词数</td></tr><tr><td>-c</td><td>只显示字节数</td></tr></tbody></table><pre class="line-numbers language-none"><code class="language-none"># 统计当前系统中有多少个用户wc -l /etc/passwd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="stat"><a href="#stat" class="headerlink" title="stat"></a>stat</h2><p>stat 命令用于查看文件的具体存储细节和时间等信息，英文全称为 “status”，语法格式为 “stat 文件名称”。<br>除了修改时间之外，Linux 系统中的文件包含 3 种时间状态，分别是 Access Time（内容最后一次被访问的时间，简称为 <strong>Atime</strong>），Modify Time（内容最后一次被修改的时间，简称为 <strong>Mtime</strong>）以及Change Time（文件属性最后一次被修改的时间，简称为 <strong>Ctime</strong>）。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">stat</span> test.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h2><p>grep 命令用于按行提取文本内容，语法格式为 “grep [参数] 文件名称”</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-b</td><td>将可执行文件(binary)当作文本文件（text）来搜索</td></tr><tr><td>-c</td><td>仅显示找到的行数</td></tr><tr><td>-i</td><td>忽略大小写</td></tr><tr><td>-n</td><td>显示行号</td></tr><tr><td>-v</td><td>反向选择——仅列出没有“关键词”的行。</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 找出当前系统中不允许登录系统的所有用户信息</span><span class="token function">grep</span> /sbin/nologin /etc/passwd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="cut"><a href="#cut" class="headerlink" title="cut"></a>cut</h2><p>cut 命令用于按 <strong>“列”</strong> 提取文本内容，语法格式为 “cut [参数] 文件名称”，按“列”搜索，不仅要使用 <code>-f</code> 参数设置需要查看的列数，还需要使用 <code>-d</code> 参数来设置间隔符号。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 提取 /etc/passwd 文件中的用户名信息，即提取以冒号为间隔符号的第一列内容</span><span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token builtin class-name">:</span> <span class="token parameter variable">-f</span> <span class="token number">1</span> /etc/passwd<span class="token comment"># 或者（只提取前 5 个用户信息）</span><span class="token function">cat</span> /etc/passwd <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">'#'</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">5</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token builtin class-name">:</span> <span class="token parameter variable">-f</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h2><p>diff 命令用于比较多个文件之间内容的差异，英文全称为 “different”，语法格式为 “diff [参数] 文件名称A 文件名称B”。</p><p>在使用 diff 命令时，不仅可以使用 –brief 参数来确认两个文件是否相同，还可以使用 -c 参数来详细比较出多个文件的差异之处。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 判断两个文件是否相同</span><span class="token function">diff</span> <span class="token parameter variable">--brief</span> a.txt b.txt<span class="token comment"># 查看文件内容的具体不同</span><span class="token function">diff</span> <span class="token parameter variable">-c</span> a.txt b.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="uniq"><a href="#uniq" class="headerlink" title="uniq"></a>uniq</h2><p>uniq 命令用于去除文本中连续的重复行，英文全称为 “unique”，语法格式为“uniq [参数] 文件名称”。 <strong>中间不能夹杂其他文本行（非相邻的默认不会去重）</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">uniq</span> alex.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h2><p>sort 命令用于对文本内容进行再排序，语法格式为 “sort [参数] 文件名称”。</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-f</td><td>忽略大小写</td></tr><tr><td>-b</td><td>忽略缩进与空格</td></tr><tr><td>-n</td><td>以数值型排序</td></tr><tr><td>-r</td><td>反向排序</td></tr><tr><td>-u</td><td>去除重复行</td></tr><tr><td>-t</td><td>指定间隔符</td></tr><tr><td>-k</td><td>设置字段范围</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将文本中的内容按照字母顺序进行排序</span><span class="token function">sort</span> alex.txt<span class="token comment"># 将文本内容进行去重操作</span><span class="token function">sort</span> <span class="token parameter variable">-u</span> alex.txt<span class="token comment"># 以第 3 个字段中的数字作为排序依据，以冒号 : 指定分隔符，以数字规则进行排序</span><span class="token function">sort</span> <span class="token parameter variable">-t</span> <span class="token builtin class-name">:</span> <span class="token parameter variable">-k</span> <span class="token number">3</span> <span class="token parameter variable">-n</span> alex.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="touch"><a href="#touch" class="headerlink" title="touch"></a>touch</h2><p>touch 命令用于创建空白文件或设置文件的时间，语法格式为 “touch [参数] 文件名称”。</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-a</td><td>仅修改“读取时间”（atime）</td></tr><tr><td>-m</td><td>仅修改“修改时间”（mtime）</td></tr><tr><td>-d</td><td>同时修改 atime 与 mtime</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改文件的读取时间和修改时间</span><span class="token function">touch</span> <span class="token parameter variable">-d</span> <span class="token string">"2021-09-12 15:44"</span> alex.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h2><p>cp 命令用于复制文件或目录，英文全称为 “copy”，语法格式为 “cp [参数] 源文件名称 目标文件名称”。</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-p</td><td>保留原始文件的属性</td></tr><tr><td>-d</td><td>若对象为“链接文件”，则保留该“链接文件”的属性</td></tr><tr><td>-r</td><td>递归持续复制（用于目录）</td></tr><tr><td>-i</td><td>若目标文件存在则询问是否覆盖</td></tr><tr><td>-a</td><td>相当于 -pdr（p、d、r为上述参数）</td></tr></tbody></table><h2 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h2><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-f</td><td>强制执行</td></tr><tr><td>-i</td><td>删除前询问</td></tr><tr><td>-r</td><td>删除目录</td></tr><tr><td>-v</td><td>显示过程</td></tr></tbody></table><h2 id="dd"><a href="#dd" class="headerlink" title="dd"></a>dd</h2><p>dd 命令用于按照指定大小和个数的数据块来复制文件或转换文件，语法格式为 “dd if=参数值of=参数值count=参数值bs=参数值”。</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>if</td><td>输入的文件名称</td></tr><tr><td>of</td><td>输出的文件名称</td></tr><tr><td>bs</td><td>设置每个“块”的大小</td></tr><tr><td>count</td><td>设置要复制“块”的个数</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 从 /dev/zero 设备文件中取出 1 个大小为 560M 的数据块，保存成名为 560_file 的文件</span><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>560_file <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">bs</span><span class="token operator">=</span>560M<span class="token comment"># 将光驱设备中的光盘制作成 iso 格式的镜像文件</span><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/cdrom <span class="token assign-left variable">of</span><span class="token operator">=</span>RHEL.iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="file"><a href="#file" class="headerlink" title="file"></a>file</h2><p>file 命令用于查看文件的类型，语法格式为 “file 文件名称”。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>递归计算笛卡尔乘积</title>
      <link href="posts/1e1630f3.html"/>
      <url>posts/1e1630f3.html</url>
      
        <content type="html"><![CDATA[<h1 id="递归计算笛卡尔乘积"><a href="#递归计算笛卡尔乘积" class="headerlink" title="递归计算笛卡尔乘积"></a>递归计算笛卡尔乘积</h1><blockquote><p>如果使用 <code>laravel</code> 的话，直接使用 <code>collect</code> 的 <code>crossJoin</code> 方法也可以实现</p></blockquote><h2 id="代码如下"><a href="#代码如下" class="headerlink" title="代码如下"></a>代码如下</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 递归计算笛卡尔乘积 * * Created by PhpStorm. * User: Alex * Date: 2020/3/5 * Time: 20:35 */</span><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Handlers</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">CarteSianHandler</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 保存结果     *     * @var array     */</span>    <span class="token keyword">public</span> <span class="token variable">$products</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 计算笛卡尔乘积的结果     *     * @param array $params     * @param array $temporary     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">carteSian</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$temporary</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">array_shift</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$temporary</span><span class="token punctuation">,</span> <span class="token variable">$param</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$params</span> <span class="token operator">?</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">carteSian</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$temporary</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">array_push</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">products</span><span class="token punctuation">,</span> <span class="token variable">$temporary</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token variable">$temporary</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$params</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span><span class="token string single-quoted-string">'颜色_黑色'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'颜色_白色'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'颜色_咖啡色'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token string single-quoted-string">'尺寸_S'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'尺寸_M'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'尺寸_L'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token string single-quoted-string">'材质_羽绒'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'材质_鹅绒'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$cartSian</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CarteSian</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$cartSian</span><span class="token operator">-&gt;</span><span class="token function">carteSian</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$cartSian</span><span class="token operator">-&gt;</span><span class="token property">products</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">18</span> <span class="token punctuation">[</span>  <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_黑色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_S"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_黑色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_S"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span>  <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_黑色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_M"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">3</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_黑色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_M"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span>  <span class="token number">4</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_黑色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_L"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">5</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_黑色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_L"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span>  <span class="token number">6</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_白色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_S"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">7</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_白色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_S"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span>  <span class="token number">8</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_白色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_M"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">9</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_白色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_M"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span>  <span class="token number">10</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_白色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_L"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">11</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_白色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_L"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span>  <span class="token number">12</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_咖啡色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_S"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">13</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_咖啡色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_S"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span>  <span class="token number">14</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_咖啡色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_M"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">15</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_咖啡色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_M"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span>  <span class="token number">16</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_咖啡色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_L"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_羽绒"</span>  <span class="token punctuation">]</span>  <span class="token number">17</span> <span class="token operator">=&gt;</span> <span class="token keyword type-declaration">array</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token punctuation">[</span>    <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"颜色_咖啡色"</span>    <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"尺寸_L"</span>    <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"材质_鹅绒"</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>快速排序</title>
      <link href="posts/ff8068c0.html"/>
      <url>posts/ff8068c0.html</url>
      
        <content type="html"><![CDATA[<h1 id="常规方法，快速排序"><a href="#常规方法，快速排序" class="headerlink" title="常规方法，快速排序"></a>常规方法，快速排序</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 思路： * 1、找到当前数组中的任意一个元素（一般选择第一个元素，因为选择第一个元素较为简单，选择其他元素还需要多写一些不必要的代码，干嘛非要给自己找麻烦哩）作为比较的标准 * 2、新建两个空数组，用于存放比比较的元素大或者小的元素，当遍历整个数组元素时，如果遍历到的元素比当前元素要小，则将此元素放到左边的数组，比当前元素大，则放到右边的数组中 * 3、再以同样的方式去遍历左边的数组和右边的数组 * * 递归点：只要是需要比较的数组中的元素个数大于 1，那么就需要递归，只有当数组中的元素的个数等于 1 的时候，则停止递归，不需要比较 * * @param array $arr * @return array */</span><span class="token keyword">function</span> <span class="token function-definition function">quick_sort</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$arr</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">array</span><span class="token punctuation">{</span>    <span class="token comment">// 判断参数是否是一个数组</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 递归出口：数组长度为 1 ，则直接返回数组</span>    <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token variable">$arr</span><span class="token punctuation">;</span>    <span class="token comment">// 数组元素有多个，则定义两个空数组</span>    <span class="token variable">$left</span> <span class="token operator">=</span> <span class="token variable">$right</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 把第一个元素当作比较的对象</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$length</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 判断当前元素的大小</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$left</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$right</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 递归调用</span>    <span class="token variable">$left</span> <span class="token operator">=</span> <span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token variable">$left</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$right</span> <span class="token operator">=</span> <span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token variable">$right</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 合并所有的结果</span>    <span class="token keyword">return</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$left</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$right</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//$arr = [4, 7, 6, 5, 3, 2, 8, 1];</span><span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">435</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">523</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">654</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'-'</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="“挖坑法”-快速排序"><a href="#“挖坑法”-快速排序" class="headerlink" title="“挖坑法” 快速排序"></a>“挖坑法” 快速排序</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * "挖坑法" 快速排序 * * @param array $arr * @return array */</span><span class="token keyword">function</span> <span class="token function-definition function">quick_sort</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$arr</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">array</span><span class="token punctuation">{</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token number">0</span> <span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">1</span> <span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token variable">$arr</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">2</span> <span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$pivot</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$leftHead</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token variable">$rightHead</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token variable">$index</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 需要填充处</span>    <span class="token variable">$compare</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'right'</span><span class="token punctuation">;</span>  <span class="token comment">// 拿数组左侧的数据与数组右侧的数据进行比较</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$leftHead</span> <span class="token operator">==</span> <span class="token variable">$rightHead</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$left</span> <span class="token operator">=</span> <span class="token function">array_slice</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$leftHead</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$right</span> <span class="token operator">=</span> <span class="token function">array_slice</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">$leftHead</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$mid</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token variable">$pivot</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token variable">$left</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$mid</span><span class="token punctuation">,</span> <span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token variable">$right</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'right'</span> <span class="token operator">==</span> <span class="token variable">$compare</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 如果右指针的数小于基准数，那么将这个数填入基准数里面</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$rightHead</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token variable">$pivot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$index</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$rightHead</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token variable">$leftHead</span><span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token variable">$index</span> <span class="token operator">=</span> <span class="token variable">$rightHead</span><span class="token punctuation">;</span>                <span class="token variable">$compare</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'left'</span><span class="token punctuation">;</span>  <span class="token comment">// 拿左侧的数据开始进行排序</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token variable">$rightHead</span><span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token comment">// 如果比他大</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// $compare == 'left'</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$leftHead</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token variable">$pivot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 如果大于基准数，填充右边的 index</span>                <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$index</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$leftHead</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token variable">$index</span> <span class="token operator">=</span> <span class="token variable">$leftHead</span><span class="token punctuation">;</span>                <span class="token variable">$rightHead</span><span class="token operator">--</span><span class="token punctuation">;</span>                <span class="token variable">$compare</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'right'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token variable">$leftHead</span><span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">//$arr = [4, 7, 6, 5, 3, 2, 8, 1];</span><span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">435</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">523</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">654</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'-'</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用阶乘原理通过阶乘获取一个一维数组中全部的组合情况</title>
      <link href="posts/dfcf0c33.html"/>
      <url>posts/dfcf0c33.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用阶乘原理通过阶乘获取一个一维数组中全部的组合情况"><a href="#使用阶乘原理通过阶乘获取一个一维数组中全部的组合情况" class="headerlink" title="使用阶乘原理通过阶乘获取一个一维数组中全部的组合情况"></a>使用阶乘原理通过阶乘获取一个一维数组中全部的组合情况</h1><h2 id="代码如下"><a href="#代码如下" class="headerlink" title="代码如下"></a>代码如下</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 使用阶乘原理，通过阶乘获取一个一维数组中全部的组合情况 * * Created by PhpStorm. * User: Alex * Date: 2020/3/9 * Time: 13:08 */</span><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Handlers</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">FactorialHandler</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 使用阶乘原理获取一维数组中全部的组合情况     *     * @param array $arr     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getArrAllCombineByFactor</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$arr</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">array</span>    <span class="token punctuation">{</span>        <span class="token comment">// 大于等于1 =&gt; n! = 1*2*3*4*5…………*(n-1)*n</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$combineArr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// 除当前 key 以外的单元数组</span>                <span class="token variable">$temArr</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">arrRmoveValueByKey</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token variable">$k</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$sonCombineArr</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getArrAllCombineByFactor</span><span class="token punctuation">(</span><span class="token variable">$temArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$sonCombineArr</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token variable">$combineArr</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$v</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'|'</span> <span class="token operator">.</span> <span class="token variable">$value</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token variable">$combineArr</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token variable">$arr</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 通过数组的 key 移除掉当前 key 所在的单元，返回除 key 单元以外的单元数组     *     * @param array $arr  原始数组     * @param $k  需要移除数组单元的 key     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">arrRmoveValueByKey</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token variable">$k</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">array</span>    <span class="token punctuation">{</span>        <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">array_values</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$arr</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'1_1'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'2_3'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'4_6'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$factorialInstance</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FactorialHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$factorialInstance</span><span class="token operator">-&gt;</span><span class="token function">getArrAllCombineByFactor</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h3><pre class="line-numbers language-none"><code class="language-none">array:6 [  0 =&gt; "1_1|2_3|4_6"  1 =&gt; "1_1|4_6|2_3"  2 =&gt; "2_3|1_1|4_6"  3 =&gt; "2_3|4_6|1_1"  4 =&gt; "4_6|1_1|2_3"  5 =&gt; "4_6|2_3|1_1"]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="一维数组所有的组合情况（排列组合）"><a href="#一维数组所有的组合情况（排列组合）" class="headerlink" title="一维数组所有的组合情况（排列组合）"></a>一维数组所有的组合情况（排列组合）</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Alpha'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Beta'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Gamma'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Sigma'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">depth_picker</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token variable">$temp_string</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$collect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$temp_string</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span>         <span class="token variable">$collect</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token variable">$temp_string</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$arrcopy</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">;</span>        <span class="token variable">$elem</span> <span class="token operator">=</span> <span class="token function">array_splice</span><span class="token punctuation">(</span><span class="token variable">$arrcopy</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// removes and returns the i'th element</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token variable">$arrcopy</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">depth_picker</span><span class="token punctuation">(</span><span class="token variable">$arrcopy</span><span class="token punctuation">,</span> <span class="token variable">$temp_string</span> <span class="token operator">.</span><span class="token string double-quoted-string">" "</span> <span class="token operator">.</span> <span class="token variable">$elem</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$collect</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$collect</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token variable">$temp_string</span><span class="token operator">.</span> <span class="token string double-quoted-string">" "</span> <span class="token operator">.</span> <span class="token variable">$elem</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span class="token variable">$collect</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">depth_picker</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$collect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$collect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="返回的结果"><a href="#返回的结果" class="headerlink" title="返回的结果"></a>返回的结果</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">Array</span><span class="token punctuation">(</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Beta    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Beta Gamma    <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Beta Gamma Sigma    <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Beta Sigma    <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Beta Sigma Gamma    <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Gamma    <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Gamma Beta    <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Gamma Beta Sigma    <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Gamma Sigma    <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Gamma Sigma Beta    <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Sigma    <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Sigma Beta    <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Sigma Beta Gamma    <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Sigma Gamma    <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Alpha Sigma Gamma Beta    <span class="token operator">.</span>    <span class="token operator">.</span>    <span class="token operator">.</span>    <span class="token punctuation">[</span><span class="token number">59</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Sigma Gamma    <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Sigma Gamma Alpha    <span class="token punctuation">[</span><span class="token number">61</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Sigma Gamma Alpha Beta    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Sigma Gamma Beta    <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span>  Sigma Gamma Beta Alpha<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
            <tag> 阶乘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NVM 包管理器</title>
      <link href="posts/63668a37.html"/>
      <url>posts/63668a37.html</url>
      
        <content type="html"><![CDATA[<h1 id="nvm-包管理器"><a href="#nvm-包管理器" class="headerlink" title="nvm 包管理器"></a>nvm 包管理器</h1><ul><li><a href="https://github.com/nvm-sh/nvm">官网</a></li><li><a href="https://github.com/coreybutler/nvm-windows/releases">Windows 直接选择 nvm-setup.zip 安装</a></li><li><a href="https://nodejs.org/en/blog/">查看 nodejs 的版本号序列</a></li></ul><h2 id="npm-更改下载源为淘宝镜像"><a href="#npm-更改下载源为淘宝镜像" class="headerlink" title="npm 更改下载源为淘宝镜像"></a>npm 更改下载源为淘宝镜像</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 单次使用</span><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--registry</span><span class="token operator">=</span>https://registry.npm.taobao.org<span class="token comment"># 永久使用</span><span class="token function">npm</span> config <span class="token builtin class-name">set</span> <span class="token assign-left variable">registry</span><span class="token operator">=</span>https://registry.npm.taobao.org<span class="token comment"># 检测是否成功</span><span class="token function">npm</span> config get registry 或者 <span class="token function">npm</span> info express<span class="token comment"># 还原 npm 的仓库地址</span><span class="token function">npm</span> config <span class="token builtin class-name">set</span> registry https://registry.npmjs.org/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="mac-下安装-nvm"><a href="#mac-下安装-nvm" class="headerlink" title="mac 下安装 nvm"></a>mac 下安装 nvm</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~<span class="token function">curl</span> -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh <span class="token operator">|</span> <span class="token function">bash</span><span class="token comment"># 添加环境变量</span><span class="token function">vim</span> ~/.zshrc<span class="token comment"># 添加如下内容，如果是安装过 oh-my-zsh </span><span class="token builtin class-name">export</span> <span class="token assign-left variable">NVM_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">${XDG_CONFIG_HOME-}</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">printf</span> %s <span class="token string">"<span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.nvm"</span> <span class="token operator">||</span> <span class="token builtin class-name">printf</span> %s <span class="token string">"<span class="token variable">${XDG_CONFIG_HOME}</span>/nvm"</span><span class="token variable">)</span></span>"</span><span class="token punctuation">[</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$NVM_DIR</span>/nvm.sh"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>. <span class="token string">"<span class="token variable">$NVM_DIR</span>/nvm.sh"</span> <span class="token comment"># This loads nvm</span><span class="token comment"># 如果没有安装 oh-my-zsh 时，直接按照如下方式添加也可以，就算是已经安装了 oh-my-zsh 也可以这么操作，不冲突</span><span class="token function">vim</span> ~/.bashrc<span class="token builtin class-name">export</span> <span class="token assign-left variable">NVM_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$HOME</span>/.nvm"</span><span class="token punctuation">[</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$NVM_DIR</span>/nvm.sh"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>. <span class="token string">"<span class="token variable">$NVM_DIR</span>/nvm.sh"</span>  <span class="token comment"># This loads nvm</span><span class="token punctuation">[</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$NVM_DIR</span>/bash_completion"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>. <span class="token string">"<span class="token variable">$NVM_DIR</span>/bash_completion"</span>  <span class="token comment"># This loads nvm bash_completion</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="nvm-相关命令"><a href="#nvm-相关命令" class="headerlink" title="nvm 相关命令"></a>nvm 相关命令</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 nvm 版本号</span>nvm <span class="token parameter variable">-v</span><span class="token comment"># windows 下查看可安装的 node.js 版本</span>nvm list available<span class="token comment"># 安装指定版本的 node.js</span>nvm <span class="token function">install</span> <span class="token number">10.15</span>.0<span class="token comment"># 使用特定版本的 node.js</span>nvm use <span class="token number">10.15</span>.0<span class="token comment"># 版本切换</span>nvm <span class="token function">install</span> <span class="token number">8.11</span>.2  <span class="token comment"># 比如先安装 8.11.2 的版本，然后切换到 8.11.2</span>nvm use <span class="token number">8.11</span>.2<span class="token comment"># 查看当前已安装的 node.js</span>nvm list<span class="token comment"># 删除指定版本的 node.js</span>nvm uninstall <span class="token number">8.11</span>.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> NPM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NVM </tag>
            
            <tag> NPM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 更改 pip 源至国内镜像</title>
      <link href="posts/fbd0fa96.html"/>
      <url>posts/fbd0fa96.html</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-或-Linux-更改-pip-源至国内镜像"><a href="#Windows-或-Linux-更改-pip-源至国内镜像" class="headerlink" title="Windows 或 Linux 更改 pip 源至国内镜像"></a>Windows 或 Linux 更改 pip 源至国内镜像</h1><h2 id="Linux："><a href="#Linux：" class="headerlink" title="Linux："></a>Linux：</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> ~/.pip<span class="token function">cat</span> <span class="token operator">&gt;</span> ~/.pip/pip.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF[global]trusted-host=mirrors.aliyun.comindex-url=https://mirrors.aliyun.com/pypi/simple/EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>或者下载安装包的时候直接接源信息：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> <span class="token assign-left variable">aiohttp</span><span class="token operator">==</span><span class="token number">3.6</span>.2 <span class="token parameter variable">-i</span> https://pypi.douban.com/simple/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="Windows："><a href="#Windows：" class="headerlink" title="Windows："></a>Windows：</h2><p>首先在 window 的文件夹窗口输入 ： %APPDATA%<br>然后创建 pip 文件夹<br>最后创建 pip.ini 文件，写入如下内容</p><pre class="line-numbers language-none"><code class="language-none">[global]index-url = https://mirrors.aliyun.com/pypi/simple/[install]trusted-host=mirrors.aliyun.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>四舍六入五成双-银行家舍入算法</title>
      <link href="posts/277fd645.html"/>
      <url>posts/277fd645.html</url>
      
        <content type="html"><![CDATA[<h1 id="四舍六入五成双-银行家算法"><a href="#四舍六入五成双-银行家算法" class="headerlink" title="四舍六入五成双-银行家算法"></a>四舍六入五成双-银行家算法</h1><p>四舍六入五成双是一种比较精确比较科学的计数保留法，是由 <code>IEEE 754</code> 标准规定的浮点数取整算法, 是一种数字修约规则。</p><p>当舍去位的数值：</p><ul><li>小于等于 4 时：直接舍去该位</li><li>大于等于 6 时：向前位进 1</li><li>等于 5 时：<ul><li>5 后有数，向前位进 1</li><li>5 后全部为 0 时：<ul><li>5 前的数值为奇数时：则向前位进 1 （将前位凑成偶数）</li><li>5 前的数值为偶数时：则直接舍去该位</li></ul></li></ul></li></ul><p>口诀：</p><p>四舍六入五考虑，<br>五后非零就进一，<br>五后皆零看奇偶，<br>五前为偶应舍去，<br>五前为奇要进一。</p><h2 id="php-实现"><a href="#php-实现" class="headerlink" title="php 实现"></a>php 实现</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">formatFloat</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">,</span> <span class="token variable">$precision</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">,</span> <span class="token variable">$precision</span><span class="token punctuation">,</span> <span class="token constant">PHP_ROUND_HALF_EVEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">formatFloat</span><span class="token punctuation">(</span><span class="token number">9.8249</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">echo</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>  <span class="token comment">// output：9.82  四舍</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">formatFloat</span><span class="token punctuation">(</span><span class="token number">9.82671</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">echo</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>  <span class="token comment">// output：9.83  六入</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">formatFloat</span><span class="token punctuation">(</span><span class="token number">9.8351</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">echo</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>  <span class="token comment">// output：9.84  五后非零就进一</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">formatFloat</span><span class="token punctuation">(</span><span class="token number">9.82501</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">echo</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>  <span class="token comment">// output：9.83  五后非零就进一</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">formatFloat</span><span class="token punctuation">(</span><span class="token number">9.8250</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">echo</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>  <span class="token comment">// output：9.82  五后为零看奇偶，五前为偶应舍去（这里就违背了四舍五入）</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">formatFloat</span><span class="token punctuation">(</span><span class="token number">9.8350</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">echo</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>  <span class="token comment">// output：9.84  五后为零看奇偶，五前为奇要进一</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="js-实现"><a href="#js-实现" class="headerlink" title="js 实现"></a>js 实现</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fomatFloat</span><span class="token punctuation">(</span><span class="token parameter">num<span class="token punctuation">,</span> precision</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>num <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 搭建环境与安装 pip 扩展</title>
      <link href="posts/ee47ba79.html"/>
      <url>posts/ee47ba79.html</url>
      
        <content type="html"><![CDATA[<h1 id="Python-搭建环境与安装-pip-扩展"><a href="#Python-搭建环境与安装-pip-扩展" class="headerlink" title="Python 搭建环境与安装 pip 扩展"></a>Python 搭建环境与安装 pip 扩展</h1><blockquote><p><a href="http://www.pythontutor.com/live.html#mode=edit">python 在线运行网站</a></p></blockquote><h2 id="Mac-下安装"><a href="#Mac-下安装" class="headerlink" title="Mac 下安装"></a>Mac 下安装</h2><h3 id="mac-上安装-python"><a href="#mac-上安装-python" class="headerlink" title="mac 上安装 python"></a><a href="https://www.python.org/downloads/">mac 上安装 python</a></h3><p>可以直接通过下载官网的<a href="https://docs.python.org/zh-cn/3/using/mac.html">安装器</a>进行安装。</p><p>或者使用</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> python3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="mac-下使用-pip"><a href="#mac-下使用-pip" class="headerlink" title="mac 下使用 pip"></a><a href="https://pip.pypa.io/en/stable/quickstart/">mac 下使用 pip</a></h3><p>可以直接使用 <code>python3 -m pip ……</code> 命令</p><pre class="line-numbers language-none"><code class="language-none"># 查看 pip 版本python3 -m pip --version# 升级 pip 版本/Library/Frameworks/Python.framework/Versions/3.8/bin/python3 -m pip install --upgrade pip# 搜索插件包 querypython -m pip search "query"# 安装 SomePackage 包python3 -m pip install SomePackage            # latest versionpython3 -m pip install SomePackage==1.0.4     # specific versionpython3 -m pip install 'SomePackage&gt;=1.0.4'     # minimum version# 安装已经通过 [PyPI](https://pypi.org/) 下载好的包（这在没有网的情况下很有用）python3 -m pip install SomePackage-1.0-py2.py3-none-any.whl# 显示已安装包的详细信息python3 -m pip show --files SomePackage# 列出哪些包已经存在了新版本python3 -m pip list --outdated# 升级包版本python3 -m pip install --upgrade SomePackage# 卸载包python3 -m pip uninstall SomePackage<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果想直接使用 <code>pip</code> 命令时，则需要如下操作，<a href="https://pip.pypa.io/en/stable/installing/">官网安装 pip 步骤文档</a></p><pre class="line-numbers language-none"><code class="language-none"># 安装 get-pip.py 脚本curl https://bootstrap.pypa.io/get-pip.py | python3# 查看 pip 版本pip --version 或者 pip3 --version# 查看已经安装的包pip list 或者 pip3 list# 更新 pip 版本pip install --upgrade pip 或者 pip3 install --upgrade pip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="requirements-txt"><a href="#requirements-txt" class="headerlink" title="requirements.txt"></a>requirements.txt</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 生成 requirements 文件</span>pip freeze <span class="token operator">&gt;</span> requirements<span class="token punctuation">.</span>txt<span class="token comment"># 安装 requirements.txt 依赖命令</span>pip install <span class="token operator">-</span>r requirements<span class="token punctuation">.</span>txt<span class="token comment"># 卸载 requirements.txt 文件中的依赖</span>pip uninstall <span class="token operator">-</span>y <span class="token operator">-</span>r requirements<span class="token punctuation">.</span>txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Windows-下安装背景"><a href="#Windows-下安装背景" class="headerlink" title="Windows 下安装背景"></a>Windows 下安装背景</h2><p>系统 windows7 64位，安装的 python 版本为 3.6.7 ，此文档为过程总结。</p><h2 id="Python-与-pip-下载与安装"><a href="#Python-与-pip-下载与安装" class="headerlink" title="Python 与 pip 下载与安装"></a>Python 与 pip 下载与安装</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><ul><li>进入 <code>https://www.python.org/</code> 选择  <code>downloads</code></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0e913bc27da7cfc2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="官网首页"></p><ul><li>选择 3.6.7 版本</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-da7102d7d5108480.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="选择3.6.7版本"></p><ul><li>拉到屏幕底部，选择<ul><li>Windows x86-64 executable installer<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-4a7bf34585ea3e31.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="选择64位安装包"></li></ul></li></ul><h3 id="Windows-下安装"><a href="#Windows-下安装" class="headerlink" title="Windows 下安装"></a>Windows 下安装</h3><ul><li>直接对下载好的安装包双进运行 (Install Python 3.6.7(64-bit) )<ul><li>选择自定义安装（Customize installation）</li><li>勾选 add python3.6 to path（自动添加环境变量）</li><li>下一步</li></ul></li><li>勾选 (Optional Features)<ul><li>document</li><li>pip（必须选）</li><li>.. 其他的多装总比少装强</li><li>下一步</li></ul></li><li>选择安装路径 （Advanced Options）<ul><li>安装路径，c:\python\Python3.6（可自行定义 Browse）</li><li>安装 （Install）</li></ul></li><li>安装完成</li></ul><h3 id="检查安装效果"><a href="#检查安装效果" class="headerlink" title="检查安装效果"></a>检查安装效果</h3><ul><li>开始，运行，进入cmd命令行</li><li>敲命令 python<ul><li>windodws 用 ctrl+z 退出交互界面</li></ul></li><li>敲命令 pip<ul><li>命令存在</li></ul></li><li>如果提示命令不存在<ul><li>很可能是你的 环境变量未设置好</li></ul></li></ul><h2 id="安装-pipenv"><a href="#安装-pipenv" class="headerlink" title="安装 pipenv"></a>安装 pipenv</h2><p>它是一个项目虚拟环境管理工具。</p><h3 id="利用-pip-安装"><a href="#利用-pip-安装" class="headerlink" title="利用 pip 安装"></a>利用 pip 安装</h3><p><code>pip install pipenv</code></p><p>执行该命令自动进入下载安装过程。</p><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><ul><li>在电脑中创建文件夹，比如 I:\Python\test</li><li>在命令行切换到此<ul><li>cmd: cd  I:\Python\test</li></ul></li><li>执行 pipenv 的初始化命令<ul><li>pipenv –python 3.6</li></ul></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0742c148428484a3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="执行 pipenv 初始化命令之后的画面"></p><ul><li>进入 pipenv 的虚拟环境<ul><li>pipenv shell</li></ul></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b40a5bcc9c69f618.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="进入 pipenv 的虚拟环境"></p><ul><li>安装一个库试试<ul><li>pip install requests</li></ul></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d2ac78cb65d7f691.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="安装 requests 库界面"></p><ul><li>虚拟化环境存放路径<ul><li>默认 c:\users\administrator.vi*****</li></ul></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1cd80d6ed3238a66.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="本次安装虚拟化环境存放路径"></p><ul><li>OK End</li></ul><h2 id="下载使用-pycharm"><a href="#下载使用-pycharm" class="headerlink" title="下载使用 pycharm"></a>下载使用 pycharm</h2><p>直接去官网下载 windows 的 pro版本。</p><p>地址 <a href="http://www.jetbrains.com/pycharm/download/">http://www.jetbrains.com/pycharm/download/</a><br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-120aa374788beefc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="下载 Pro 版本"></p><h3 id="创建项目-1"><a href="#创建项目-1" class="headerlink" title="创建项目"></a>创建项目</h3><p>直接选择我们刚刚的项目路径 <code>I:\Python\test</code></p><h3 id="让项目使用pipenv的虚拟环境"><a href="#让项目使用pipenv的虚拟环境" class="headerlink" title="让项目使用pipenv的虚拟环境"></a>让项目使用pipenv的虚拟环境</h3><p><code>file -&gt; setting -&gt; project:test</code></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ac306de03f065e51.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="如图所示"></p><p>进一步选择 <code>interperter</code> 在下拉选单中选中我们刚刚的虚拟化环境目录即可。<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-175faf09036cc3a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="选择上文中创建的虚拟环境目录"></p><h3 id="interperter-中没有怎么办？"><a href="#interperter-中没有怎么办？" class="headerlink" title="interperter 中没有怎么办？"></a>interperter 中没有怎么办？</h3><p>下拉选单中，选择 <code>show all</code><br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6828f88cd9937443.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="第一步： interperter 中没有的话，点击下拉选单之后选择 show all"><br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6171dcff4886c3bc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="第二步：点击加号+"><br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e6d11f9351337be9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="第三步：选择已经存在的，不要选择新建的"></p><p>然后在 existing environment，在右侧<code>...</code>选中虚拟环境的 python.exe 即可。<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3b5e2bdbeb07032e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="第四步：选择已存在的之后点击最右边的 …"><br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-87dab8f9313b439e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="第五步：选择 python.exe 既可"><br>一般情况下，默认路径：</p><p><code>c:\users\administrator\.virtualenvs\项目名\Scripts\python.exe</code></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-61e21223cf87bdf2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="切记切记！！！"></p><p>然后一直点 ok 即可<br>效果如下<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-78490ce15425ed18.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="可以看到会出现两个虚拟环境的选项"><br>最终可以看到编辑器中包含了刚刚创建的虚拟环境<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8260285f4c846b36.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="看到这里证明编辑器配置成功了"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，整个项目环境配置完毕。</p><p>以后我们所有对项目的命令行操作都需要在项目根目录先进入 <code>pipenv shell</code> 然后再执行命令操作，这样就可以使得每一个项目安装独立的安装包。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx 开启 gzip 压缩</title>
      <link href="posts/63bed376.html"/>
      <url>posts/63bed376.html</url>
      
        <content type="html"><![CDATA[<h1 id="nginx-开启-gzip-压缩"><a href="#nginx-开启-gzip-压缩" class="headerlink" title="nginx 开启 gzip 压缩"></a>nginx 开启 gzip 压缩</h1><blockquote><p>在服务器 Nginx 开启 gzip 压缩是优化网站性能的方法之一，可以有效减少服务器带宽的消耗，缺点是会增大 CPU 的占用率，但是很多时候 CPU 往往是空闲最多的。</p></blockquote><p>在 nginx 中开启 gzip 压缩，需要编辑 nginx.conf 文件，添加如下</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">1k</span></span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">gzip_buffers</span> <span class="token number">16</span> <span class="token number">64k</span></span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">gzip_http_version</span> 1.1</span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">9</span></span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">gzip_types</span> text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml</span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">gzip_vary</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="gzip-参数介绍"><a href="#gzip-参数介绍" class="headerlink" title="gzip 参数介绍"></a>gzip 参数介绍</h2><h3 id="gizp-on-off"><a href="#gizp-on-off" class="headerlink" title="gizp on|off;"></a>gizp on|off;</h3><p>开启或者关闭 gzip 模块</p><h3 id="gzip-min-length-1k"><a href="#gzip-min-length-1k" class="headerlink" title="gzip_min_length 1k;"></a>gzip_min_length 1k;</h3><p>设置允许压缩的页面最小字节数，页面字节数从 header 头中的 Content-Length 中进行获取。默认值是 0，不管页面多大都压缩。建议设置成大于 1k 的字节数，小于 1k 可能会越压越大。 即: gzip_min_length 1024</p><h3 id="gzip-proxied-expired-no-cache-no-store-private-auth"><a href="#gzip-proxied-expired-no-cache-no-store-private-auth" class="headerlink" title="gzip_proxied expired no-cache no-store private auth;"></a>gzip_proxied expired no-cache no-store private auth;</h3><p>Nginx 作为反向代理的时候启用，开启或者关闭后端服务器返回的结果，匹配的前提是后端服务器必须要返回包含”Via” 的 header 头。</p><h3 id="gzip-types-text-plain-application-xml"><a href="#gzip-types-text-plain-application-xml" class="headerlink" title="gzip_types text/plain application/xml;"></a>gzip_types text/plain application/xml;</h3><p>匹配 MIME 类型进行压缩，（无论是否指定）”text/html” 类型总是会被压缩的。</p><h2 id="如何判断是否已经开启了-gzip-压缩？"><a href="#如何判断是否已经开启了-gzip-压缩？" class="headerlink" title="如何判断是否已经开启了 gzip 压缩？"></a>如何判断是否已经开启了 gzip 压缩？</h2><p>打开浏览器，按住 f12 查看 Content-Encoding 字段如果是 gzip，表示该网页的 body 数据是经过 gzip 压缩的。</p>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
            <tag> gzip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP RSA 加解密</title>
      <link href="posts/f7924170.html"/>
      <url>posts/f7924170.html</url>
      
        <content type="html"><![CDATA[<h1 id="PHP-RSA-加解密"><a href="#PHP-RSA-加解密" class="headerlink" title="PHP RSA 加解密"></a>PHP RSA 加解密</h1><p>最近在做支付宝的跨境支付，自己写了一个 composer 包，里面涉及到 RSA 加密，以及验签，故分享之。也方便以后自己随时拿过来用 😃</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * RSA 加解密 * * 可以线上生成一对公私钥的网站： http://www.metools.info/code/c80.html */</span><span class="token comment">/** * RSA 签名 * * @param string $data 待签名数据 * @param string $privateKeyPath 私钥文件路径 * @return string */</span><span class="token keyword">function</span> <span class="token function-definition function">rsaSign</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$privateKeyPath</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span><span class="token punctuation">{</span>    <span class="token variable">$priKey</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$privateKeyPath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">openssl_get_privatekey</span><span class="token punctuation">(</span><span class="token variable">$priKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">openssl_sign</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$sign</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">openssl_free_key</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$sign</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$sign</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$sign</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/** * RSA 验签 * * @param string $data 待签名数据 * @param string $aliPublicKeyPath 公钥文件路径 * @param string $sign 要校对的签名数据 * @return bool */</span><span class="token keyword">function</span> <span class="token function-definition function">rsaVerify</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$aliPublicKeyPath</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$sign</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">bool</span><span class="token punctuation">{</span>    <span class="token variable">$pubKey</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$aliPublicKeyPath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">openssl_get_publickey</span><span class="token punctuation">(</span><span class="token variable">$pubKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span><span class="token function">openssl_verify</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$sign</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">openssl_free_key</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/** * RSA 解密 * * @param string $content 需要解密的密文数据 * @param string $privateKeyPath  私钥文件路径 * @return string  解密后的明文内容 */</span><span class="token keyword">function</span> <span class="token function-definition function">rsaDecrypt</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$privateKeyPath</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span><span class="token punctuation">{</span>    <span class="token variable">$priKey</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$privateKeyPath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">openssl_get_privatekey</span><span class="token punctuation">(</span><span class="token variable">$priKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 用 base64 将内容还原成二进制</span>    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 把需要解密的内容，按 128 位拆开解密</span>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">openssl_private_decrypt</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$decrypt</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$result</span> <span class="token operator">.=</span> <span class="token variable">$decrypt</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">openssl_free_key</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 假设需要对如下这段字符串加解密</span><span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'aa=123&amp;bb=456&amp;cc=789&amp;dd=1212'</span><span class="token punctuation">;</span><span class="token comment">// osrx0siWqK0+5C6ANNk/2pqEYoWa74UzFsUPFfv5FnhrOU9abyup+h2AY/4LqlSnvH9ztBcx//EpdJI9yI/xnfB14LdiDrPH1bJUJ5oJMafAo4QxL47eAPKT8ZKbufKg+YTf8kx7xnJ5kSyxcHzzhZyVvth4pGstFTUeL/5RpGRxlOQj/viHLkocYM2h1hzunqvcHWKzQqTdmi8g9atxDLPrASdTdolsD0TYbFj4Bn1S/0ziomcesz3IFi0CO6UsSM2N1jBOdtmhrecxv6WcUAgy3y9B7o4vF3hGG7HuhD437bO0XVWMrJ2NcRHhiQolMi6zmeX50ZLUSI63ve7ucA==</span><span class="token variable">$mySign</span> <span class="token operator">=</span> <span class="token function">rsaSign</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'./private_key.pem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$is</span> <span class="token operator">=</span> <span class="token function">rsaVerify</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'./public_key.pem'</span><span class="token punctuation">,</span> <span class="token variable">$mySign</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$decryptStr</span> <span class="token operator">=</span> <span class="token function">rsaDecrypt</span><span class="token punctuation">(</span><span class="token variable">$mySign</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'./private_key.pem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$mySign</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$is</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$decryptStr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> RSA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 laradock 安装 elasticsearch</title>
      <link href="posts/deba288d.html"/>
      <url>posts/deba288d.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用-Laradock-安装-ElasticSearch"><a href="#使用-Laradock-安装-ElasticSearch" class="headerlink" title="使用 Laradock 安装 ElasticSearch"></a>使用 Laradock 安装 ElasticSearch</h1><ul><li><a href="https://github.com/ElasticHQ/elasticsearch-HQ">ElasticSearch 可视化工具 ElasticHQ</a> / <a href="http://www.elastichq.org/">官网地址</a></li></ul><h2 id="安装和使用"><a href="#安装和使用" class="headerlink" title="安装和使用"></a>安装和使用</h2><ol><li>使用 <code>docker-compose up</code> 命令运行 <code>ElasticSearch</code> 容器</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>打开浏览器并通过端口 <code>9200</code> 访问本地主机 <a href="http://localhost:9200/">http://localhost:9200</a></li></ol><blockquote><p>默认用户是 user ，默认密码是 changeme</p></blockquote><h2 id="如果是在-laradock-中使用时"><a href="#如果是在-laradock-中使用时" class="headerlink" title="如果是在 laradock 中使用时"></a>如果是在 laradock 中使用时</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://elasticsearch:9200<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="安装-ElasticSearch-插件"><a href="#安装-ElasticSearch-插件" class="headerlink" title="安装 ElasticSearch 插件"></a>安装 ElasticSearch 插件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装一个 ElasticSearch 插件</span><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> elasticsearch /usr/share/elasticsearch/bin/elasticsearch-plugin <span class="token function">install</span> <span class="token punctuation">{</span>plugin-name<span class="token punctuation">}</span><span class="token comment"># 重启容器</span><span class="token function">docker-compose</span> restart elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装-elasticsearch-analysis-ik-中文分词插件"><a href="#安装-elasticsearch-analysis-ik-中文分词插件" class="headerlink" title="安装 elasticsearch-analysis-ik 中文分词插件"></a>安装 <a href="https://github.com/medcl/elasticsearch-analysis-ik">elasticsearch-analysis-ik</a> 中文分词插件</h3><p>比如，此时需要安装 <a href="https://github.com/medcl/elasticsearch-analysis-ik">elasticsearch-analysis-ik</a> 中文分词插件，需要下载 ik 的 <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases">releases</a> 源码 zip 包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 方式1，你可以直接在 elasticsearch 容器外，执行以下命令</span><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> elasticsearch /usr/share/elasticsearch/bin/elasticsearch-plugin <span class="token function">install</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip<span class="token comment"># 方式2，你可以直接进入到 elasticsearch 容器内，然后执行以下命令</span>./bin/elasticsearch-plugin <span class="token function">install</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>需要注意的是：如果你的 elasticsearch 的版本是 7.9.1 那么，你安装的 ik 插件也必须是 7.9.1 的版本</strong>，elasticsearch 的版本号可以通过访问 <a href="http://localhost:9200/">http://localhost:9200/</a> 查看 <code>version.number</code> 字段查看，然后 <code>docker-compose restart elasticsearch</code> 重启 elasticsearch 容器即可</p><h4 id="安装-elasticsearch-analysis-ik-过程如下所示"><a href="#安装-elasticsearch-analysis-ik-过程如下所示" class="headerlink" title="安装 elasticsearch-analysis-ik 过程如下所示"></a>安装 elasticsearch-analysis-ik 过程如下所示</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@f1831cb3b4dd elasticsearch<span class="token punctuation">]</span><span class="token comment"># ./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip</span>-<span class="token operator">&gt;</span> Installing https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip-<span class="token operator">&gt;</span> Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip<span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">]</span> <span class="token number">100</span>%??@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@     WARNING: plugin requires additional permissions     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@* java.net.SocketPermission * connect,resolveSee http://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html<span class="token keyword">for</span> descriptions of what these permissions allow and the associated risks.Continue with installation? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>y-<span class="token operator">&gt;</span> Installed analysis-ik<span class="token punctuation">[</span>root@f1831cb3b4dd elasticsearch<span class="token punctuation">]</span><span class="token comment"># ./bin/elasticsearch-plugin list</span>analysis-ik<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看插件列表</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./bin/elasticsearch-plugin list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="ElasticSearch-和-mysql-数据库的概念对比"><a href="#ElasticSearch-和-mysql-数据库的概念对比" class="headerlink" title="ElasticSearch 和 mysql 数据库的概念对比"></a>ElasticSearch 和 mysql 数据库的概念对比</h2><table><thead><tr><th>MySQL</th><th>Elasticsearch</th></tr></thead><tbody><tr><td>表（Table）</td><td>索引（Index）</td></tr><tr><td>记录（Row）</td><td>文档（Document）</td></tr><tr><td>字段（Column）</td><td>字段（Fields）</td></tr></tbody></table><h2 id="ElasticSearch-的简单使用"><a href="#ElasticSearch-的简单使用" class="headerlink" title="ElasticSearch 的简单使用"></a>ElasticSearch 的简单使用</h2><h3 id="新建索引-index-（创建表）"><a href="#新建索引-index-（创建表）" class="headerlink" title="新建索引 index （创建表）"></a>新建索引 index （创建表）</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-XPUT</span> http://localhost:9200/test_index  <span class="token comment"># 在 Elasticsearch 的返回中如果包含了 "acknowledged" : true, 则代表请求成功。</span><span class="token punctuation">{</span><span class="token string">"acknowledged"</span>:true,<span class="token string">"shards_acknowledged"</span>:true,<span class="token string">"index"</span><span class="token builtin class-name">:</span><span class="token string">"test_index"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://localhost:9200/test_index<span class="token punctuation">{</span><span class="token string">"test_index"</span>:<span class="token punctuation">{</span><span class="token string">"aliases"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"mappings"</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">"settings"</span>:<span class="token punctuation">{</span><span class="token string">"index"</span>:<span class="token punctuation">{</span><span class="token string">"creation_date"</span><span class="token builtin class-name">:</span><span class="token string">"1617069458624"</span>,<span class="token string">"number_of_shards"</span><span class="token builtin class-name">:</span><span class="token string">"1"</span>,<span class="token string">"number_of_replicas"</span><span class="token builtin class-name">:</span><span class="token string">"1"</span>,<span class="token string">"uuid"</span><span class="token builtin class-name">:</span><span class="token string">"XKjqatZTSOu9I_PiwzaNOQ"</span>,<span class="token string">"version"</span>:<span class="token punctuation">{</span><span class="token string">"created"</span><span class="token builtin class-name">:</span><span class="token string">"7090199"</span><span class="token punctuation">}</span>,<span class="token string">"provided_name"</span><span class="token builtin class-name">:</span><span class="token string">"test_index"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment"># 可以加上 pretty 参数，返回比较人性化的结构</span><span class="token function">curl</span> http://localhost:9200/test_index<span class="token punctuation">\</span>?pretty                                                                           <span class="token punctuation">{</span>  <span class="token string">"test_index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token string">"aliases"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>,    <span class="token string">"mappings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>,    <span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>      <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>        <span class="token string">"creation_date"</span> <span class="token builtin class-name">:</span> <span class="token string">"1617069458624"</span>,        <span class="token string">"number_of_shards"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span>,        <span class="token string">"number_of_replicas"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span>,        <span class="token string">"uuid"</span> <span class="token builtin class-name">:</span> <span class="token string">"XKjqatZTSOu9I_PiwzaNOQ"</span>,        <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>          <span class="token string">"created"</span> <span class="token builtin class-name">:</span> <span class="token string">"7090199"</span>        <span class="token punctuation">}</span>,        <span class="token string">"provided_name"</span> <span class="token builtin class-name">:</span> <span class="token string">"test_index"</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建类型"><a href="#创建类型" class="headerlink" title="创建类型"></a>创建类型</h3><p>对应的接口地址是 /{index_name}/_mapping</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -H<span class="token string">'Content-Type: application/json'</span> <span class="token parameter variable">-XPUT</span> http://localhost:9200/test_index/_mapping?pretty -d<span class="token string">'{  "properties": {    "title": { "type": "text", "analyzer": "ik_smart" },     "description": { "type": "text", "analyzer": "ik_smart" },    "price": { "type": "scaled_float", "scaling_factor": 100 }  }}'</span><span class="token comment"># 会返回</span><span class="token punctuation">{</span>  <span class="token string">"acknowledged"</span> <span class="token builtin class-name">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token function">curl</span> -H<span class="token string">'Content-Type: application/json'</span> <span class="token parameter variable">-XPUT</span> http://localhost:9200/products/_mapping/?pretty -d<span class="token string">'{  "properties": {    "brand_id": { "type": "integer" },    "type": { "type": "integer" },    "title": { "type": "text", "analyzer": "ik_smart" },     "unit": { "type": "keyword" },    "sketch": { "type": "text", "analyzer": "ik_smart" },     "keywords": { "type": "text", "analyzer": "ik_smart" },    "tags": { "type": "keyword" },    "barcode": { "type": "keyword" },    "price": { "type": "scaled_float", "scaling_factor": 100 },    "market_price": { "type": "scaled_float", "scaling_factor": 100 },    "rating": { "type": "float" },    "sold_count": { "type": "integer" },    "review_count": { "type": "integer" },        "virtual_retail_num": { "type": "integer" },    "description": { "type": "text", "analyzer": "ik_smart" },    "stock": { "type": "integer" },        "warning_stock": { "type": "integer" },       "main_image": { "type": "keyword" },    "slider_image": { "type": "keyword" },    "status": { "type": "integer" },    "is_hot": { "type": "integer" },    "sort": { "type": "integer" },    "categories": {      "type": "nested",      "properties": {        "id": { "type": "integer", "copy_to": "categories_id" },        "pid": { "type": "integer" },        "name": { "type": "text", "analyzer": "ik_smart", "copy_to": "categories_name" },         "description": { "type": "text", "analyzer": "ik_smart", "copy_to": "categories_description" },        "status": { "type": "integer" },        "level": { "type": "integer" },        "img": { "type": "keyword" }      }    },        "brand": {      "type": "nested",      "properties": {        "id": { "type": "integer" },        "name": { "type": "text", "analyzer": "ik_smart", "copy_to": "brand_name" },         "description": { "type": "text", "analyzer": "ik_smart", "copy_to": "brand_description" },        "log_url": { "type": "keyword" },        "img": { "type": "keyword" }      }    },          "attrs": {      "type": "nested",      "properties": {        "id": { "type": "integer" },        "name": { "type": "keyword", "copy_to": "attrs_name" }      }    },      "skus": {      "type": "nested",      "properties": {        "id": { "type": "integer" },        "name": { "type": "text", "analyzer": "ik_smart"},         "main_url": { "type": "keyword" },        "price": { "type": "scaled_float", "scaling_factor": 100 },        "sold_count": { "type": "integer" }      }    }  }}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>提交数据中的 <code>properties</code> 代表这个索引中各个字段的定义，其中 key 为字段名称，value 是字段的类型定义</li><li><code>type</code> 定义了字段的数据类型，常用的有 <code>text</code> / <code>integer</code> / <code>date</code> / <code>boolean</code> ，还有<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html">更多类型</a><ul><li><code>keyword</code>，这是字符串类型的一种，这种类型是告诉 Elasticsearch 不需要对这个字段做分词，通常用于邮箱、标签、属性等字段。</li><li><code>scaled_float</code> 代表一个小数位固定的浮点型字段，与 Mysql 的 decimal 类型类似。</li><li><code>scaling_factor</code> 用来指定小数位精度，100 就代表精确到小数点后两位。</li><li><code>nested</code> 代表这个字段是一个复杂对象，由下一级的 properties 字段定义这个对象的字段。</li></ul></li><li><code>analyzer</code>是一个新的概念，这是告诉 Elasticsearch 应该用什么方式去给这个字段做分词，这里我们用了 <code>ik_smart</code>，是一个中文分词器。</li><li><code>copy_to</code>，Elasticsearch 的多字段匹配查询是不支持查询 Nested 对象的字段，但是我们又必须查询 <code>categories.name</code> 字段，因此我们可以使用 <code>copy_to</code> 参数，可以将  <code>categories.name</code> 字段复制到上层，我们就可以通过 <code>categories_name</code> 字段做多字段匹配查询</li></ul><h3 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h3><p>对应的接口地址是 /{index_name}/_doc/{id} 这里的 id 和 mysql 中的 id 不一样，不是自增的，需要我们手动指定。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建 id 为 1 的文档</span><span class="token function">curl</span> -H<span class="token string">'Content-Type: application/json'</span> <span class="token parameter variable">-XPUT</span> http://localhost:9200/test_index/_doc/1?pretty -d<span class="token string">'{    "title": "iPhone 7P",    "description": "iphone 第一批双摄像头",    "price": 6799}'</span><span class="token comment"># 会返回如下内容</span><span class="token punctuation">{</span>  <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"test_index"</span>,  <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span>,  <span class="token string">"_version"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"result"</span> <span class="token builtin class-name">:</span> <span class="token string">"created"</span>,  <span class="token string">"_shards"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token string">"total"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,    <span class="token string">"successful"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,    <span class="token string">"failed"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>  <span class="token punctuation">}</span>,  <span class="token string">"_seq_no"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,  <span class="token string">"_primary_term"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token comment"># 创建 id 为 2 的文档</span><span class="token function">curl</span> -H<span class="token string">'Content-Type: application/json'</span> <span class="token parameter variable">-XPUT</span> http://localhost:9200/test_index/_doc/2?pretty -d<span class="token string">'{    "title": "OPPO find x",    "description": "高清像素",    "price": 3499}'</span><span class="token comment"># 会返回如下内容</span><span class="token punctuation">{</span>  <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"test_index"</span>,  <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"2"</span>,  <span class="token string">"_version"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"result"</span> <span class="token builtin class-name">:</span> <span class="token string">"created"</span>,  <span class="token string">"_shards"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token string">"total"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,    <span class="token string">"successful"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,    <span class="token string">"failed"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>  <span class="token punctuation">}</span>,  <span class="token string">"_seq_no"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"_primary_term"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="读取文档数据"><a href="#读取文档数据" class="headerlink" title="读取文档数据"></a>读取文档数据</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://localhost:9200/test_index/_doc/1<span class="token punctuation">\</span>?pretty<span class="token comment"># 会返回如下内容</span><span class="token punctuation">{</span>  <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"test_index"</span>,  <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span>,  <span class="token string">"_version"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"_seq_no"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,  <span class="token string">"_primary_term"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,  <span class="token string">"found"</span> <span class="token builtin class-name">:</span> true,  <span class="token string">"_source"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token string">"title"</span> <span class="token builtin class-name">:</span> <span class="token string">"iPhone 7P"</span>,    <span class="token string">"description"</span> <span class="token builtin class-name">:</span> <span class="token string">"iphone 第一批双摄像头"</span>,    <span class="token string">"price"</span> <span class="token builtin class-name">:</span> <span class="token number">6799</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看-Elasticsearch-索引中有多少条数据"><a href="#查看-Elasticsearch-索引中有多少条数据" class="headerlink" title="查看 Elasticsearch 索引中有多少条数据"></a>查看 Elasticsearch 索引中有多少条数据</h3><p>对应的接口地址为 /{index_name}/_doc/_count</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://localhost:9200/test_index/_doc/_count<span class="token punctuation">\</span>?pretty<span class="token comment"># 会返回如下内容</span><span class="token punctuation">{</span>  <span class="token string">"count"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,  <span class="token string">"_shards"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token string">"total"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,    <span class="token string">"successful"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,    <span class="token string">"skipped"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,    <span class="token string">"failed"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="简单搜索"><a href="#简单搜索" class="headerlink" title="简单搜索"></a>简单搜索</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">'Content-Type:application/json'</span> http://localhost:9200/test_index/_doc/_search<span class="token punctuation">\</span>?pretty -d<span class="token string">'{    "query" : { "match" : { "description" : "iphone" }}}'</span><span class="token comment"># 会返回如下内容</span><span class="token punctuation">{</span>  <span class="token string">"took"</span> <span class="token builtin class-name">:</span> <span class="token number">16</span>,  <span class="token string">"timed_out"</span> <span class="token builtin class-name">:</span> false,  <span class="token string">"_shards"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token string">"total"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,    <span class="token string">"successful"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,    <span class="token string">"skipped"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,    <span class="token string">"failed"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>  <span class="token punctuation">}</span>,  <span class="token string">"hits"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>    <span class="token string">"total"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>      <span class="token string">"value"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,      <span class="token string">"relation"</span> <span class="token builtin class-name">:</span> <span class="token string">"eq"</span>    <span class="token punctuation">}</span>,    <span class="token string">"max_score"</span> <span class="token builtin class-name">:</span> <span class="token number">0.60996956</span>,    <span class="token string">"hits"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"test_index"</span>,        <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span>,        <span class="token string">"_score"</span> <span class="token builtin class-name">:</span> <span class="token number">0.60996956</span>,        <span class="token string">"_source"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>          <span class="token string">"title"</span> <span class="token builtin class-name">:</span> <span class="token string">"iPhone 7P"</span>,          <span class="token string">"description"</span> <span class="token builtin class-name">:</span> <span class="token string">"iphone 第一批双摄像头"</span>,          <span class="token string">"price"</span> <span class="token builtin class-name">:</span> <span class="token number">6799</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> ElasticSearch </tag>
            
            <tag> Laradock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Laravel 中的模型事件与 Observer</title>
      <link href="posts/c9de0987.html"/>
      <url>posts/c9de0987.html</url>
      
        <content type="html"><![CDATA[<h1 id="Laravel-中的模型事件与-Observer"><a href="#Laravel-中的模型事件与-Observer" class="headerlink" title="Laravel 中的模型事件与 Observer"></a>Laravel 中的模型事件与 Observer</h1><p>当模型已存在，不是新建的时候，依次触发的顺序是:</p><p>saving -&gt; updating -&gt; updated -&gt; saved</p><p>当模型不存在，需要新增的时候，依次触发的顺序则是</p><p>saving -&gt; creating -&gt; created -&gt; saved</p><p>那么 saving,saved 和 updating,updated 到底有什么区别呢？</p><p>updating 和 updated 会在数据库中的真值修改前后触发。</p><p>saving 和 saved 则会在 Eloquent 实例的 original 数组真值更改前后触发。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">UserObserver</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 监听数据即将创建的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">creating</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据创建后的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">created</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据即将更新的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">updating</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据更新后的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">updated</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据即将保存的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">saving</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据保存后的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">saved</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据即将删除的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">deleting</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据删除后的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">deleted</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据即将从软删除状态恢复的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">restoring</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 监听数据从软删除状态恢复后的事件。     *     * @param  User $user     * @return void     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">restored</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Laravel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>laravel 使用 ORM 写复杂 sql</title>
      <link href="posts/778c83e3.html"/>
      <url>posts/778c83e3.html</url>
      
        <content type="html"><![CDATA[<h1 id="laravel-使用-ORM-写复杂-sql"><a href="#laravel-使用-ORM-写复杂-sql" class="headerlink" title="laravel 使用 ORM 写复杂 sql"></a>laravel 使用 ORM 写复杂 sql</h1><h2 id="直接先贴出-sql-查询语句如下"><a href="#直接先贴出-sql-查询语句如下" class="headerlink" title="直接先贴出 sql 查询语句如下"></a>直接先贴出 sql 查询语句如下</h2><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT`assets_device`.* FROM((SELECT`id`,`sub_category_id`,`number`,`name`,`location`,`officeBuilding`,`area`,`department`,`rack`,`rack_pos` FROM`assets_device` WHERE`department` IN ( 6, 7, 17, 20 ) AND `assets_device`.`deleted_at` IS NULL ) UNION(SELECT`id`,`sub_category_id`,`number`,`name`,`location`,`officeBuilding`,`area`,`department`,`rack`,`rack_pos` FROM`assets_device` WHERE`area` IN ( 13, 14 ) AND `assets_device`.`deleted_at` IS NULL ) ) AS assets_device<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实现代码如下所示"><a href="#实现代码如下所示" class="headerlink" title="实现代码如下所示"></a>实现代码如下所示</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getChoiceAssetsByErOrDt</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$input</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 机房 id 数组</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'er'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'er'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token variable">$erIds</span> <span class="token operator">=</span> <span class="token variable">$input</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'er'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token variable">$erIds</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span><span class="token variable">$input</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'er'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token variable">$erIds</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 科室 id 数组</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token variable">$dtIds</span> <span class="token operator">=</span> <span class="token variable">$input</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dt'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token variable">$dtIds</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span><span class="token variable">$input</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token variable">$dtIds</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// id, 子分类id, 资产编号, 资产名称, 位置, 办公楼, 机房, 科室, 机柜, 机柜U数</span>        <span class="token variable">$field</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'sub_category_id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'number'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'location'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'officeBuilding'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'area'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'rack'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'rack_pos'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$erIds</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment">// 根据机房 id 查询资产</span>            <span class="token variable">$erModel</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">deviceModel</span><span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token variable">$field</span><span class="token punctuation">)</span>                <span class="token operator">-&gt;</span><span class="token function">whereIn</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'area'</span><span class="token punctuation">,</span><span class="token variable">$erIds</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$dtIds</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment">// 根据科室 id 查询资产</span>            <span class="token variable">$dtModel</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">deviceModel</span><span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token variable">$field</span><span class="token punctuation">)</span>                <span class="token operator">-&gt;</span><span class="token function">whereIn</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">,</span><span class="token variable">$dtIds</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$model</span> <span class="token operator">=</span> <span class="token variable">$dtModel</span><span class="token operator">-&gt;</span><span class="token function">union</span><span class="token punctuation">(</span><span class="token variable">$erModel</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 注意合并参数时 $subQuery 必须是 \Illuminate\Database\Query\Builder 类型</span><span class="token comment">// 如果是 \Illuminate\Database\Eloquent\Builder 类型的，用 getQuery() 方法</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">deviceModel</span><span class="token operator">-&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sub_category'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'zone'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'office_building'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'engineroom'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">)</span>                                    <span class="token operator">-&gt;</span><span class="token function">mergeBindings</span><span class="token punctuation">(</span><span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                    <span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"assets_device.*"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                                    <span class="token operator">-&gt;</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"(<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">toSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>) as assets_device"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                    <span class="token operator">-&gt;</span><span class="token function">withTrashed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                    <span class="token operator">-&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'assets_device.id'</span><span class="token punctuation">)</span>                                    <span class="token operator">-&gt;</span><span class="token function">paginate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                    <span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 以下代码如果使用 transformer 的话，就不需要写，直接可以在 transformer 里面转换</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token operator">&amp;</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'department_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>            <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sub_category_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sub_category'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sub_category'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>            <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'zone_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'zone'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'zone'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>            <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'office_building_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'office_building'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'office_building'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'engineroom'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token variable">$erdt</span> <span class="token operator">=</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'engineroom'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token variable">$erdt</span> <span class="token operator">=</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token variable">$erdt</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'erdt'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$erdt</span><span class="token punctuation">;</span>            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sub_category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'zone'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'office_building'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'engineroom'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'department'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Laravel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>laravel 性能优化</title>
      <link href="posts/183ed0df.html"/>
      <url>posts/183ed0df.html</url>
      
        <content type="html"><![CDATA[<h1 id="laravel-性能优化"><a href="#laravel-性能优化" class="headerlink" title="laravel 性能优化"></a>laravel 性能优化</h1><h2 id="composer-优化"><a href="#composer-优化" class="headerlink" title="composer 优化"></a>composer 优化</h2><p>此命令会把 <code>PSR-0</code> 和 <code>PSR-4</code> 转化为一个映射表，来提高类的加载速度</p><pre class="line-numbers language-none"><code class="language-none">composer dump-autoload --optimize<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="安装-Debugbar"><a href="#安装-Debugbar" class="headerlink" title="安装 Debugbar"></a>安装 Debugbar</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> require <span class="token string">"barryvdh/laravel-debugbar:~3.2"</span> <span class="token parameter variable">--dev</span><span class="token comment"># 生成配置文件</span>php artisan vendor:publish <span class="token parameter variable">--provider</span><span class="token operator">=</span><span class="token string">"Barryvdh\Debugbar\ServiceProvider"</span><span class="token comment"># 编辑 config/debugbar.php 将 enable 得值设置为</span><span class="token string">'enable'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> env<span class="token punctuation">(</span><span class="token string">'APP_DEBUG'</span>, <span class="token boolean">false</span><span class="token punctuation">)</span>,<span class="token comment"># 并在 .env 配置文件中开启</span><span class="token assign-left variable">APP_DEBUG</span><span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="laravel-配置缓存"><a href="#laravel-配置缓存" class="headerlink" title="laravel 配置缓存"></a>laravel 配置缓存</h2><blockquote><p>注意：如果你的配置信息里存在闭包，执行以上命令时将会报错：Your configuration files are not serializable 。解决办法是改写闭包函数为一般的函数，或者改写为类方法。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置配置缓存，会生成 bootstrap/cache/config.php 文件</span>php artisan config:cache<span class="token comment"># 清空配置缓存，也可以直接删除 bootstrap/cache/config.php 文件来清除</span>php artisan config:clear<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 手动创建 200 个配置信息</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token parameter variable">-f</span> <span class="token string">"app%03g.php"</span> <span class="token number">1</span> <span class="token number">200</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">cp</span> ./config/app.php ./config/<span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token comment"># 清除掉 bootstrap/cache/config.php 配置缓存文件</span>php artisan config:clear<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="laravel-路由缓存"><a href="#laravel-路由缓存" class="headerlink" title="laravel 路由缓存"></a>laravel 路由缓存</h2><blockquote><p>基于闭包的路由无法被缓存。要使用路由缓存。你需要将任何闭包路由转换成控制器路由。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置路由缓存</span>php artisan route:cache<span class="token comment"># 清除路由缓存</span>php artisan route:clear<span class="token comment"># 也可以直接删除 bootstrap/cache/routes.php 缓存文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>路由统计</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan route:list <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1 - 4}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>生成 500 个测试路由</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token parameter variable">-f</span> <span class="token string">"%03g"</span> <span class="token number">1</span> <span class="token number">500</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token string">"Route::get('test<span class="token variable">$i</span>/{id}/{query}','Auth\LoginController@testtest<span class="token variable">$i</span>')-&gt;name('test<span class="token variable">$i</span>')-&gt;middleware('auth');"</span> <span class="token operator">&gt;&gt;</span> routes/web.php<span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="类映射加载优化"><a href="#类映射加载优化" class="headerlink" title="类映射加载优化"></a>类映射加载优化</h2><p>在 <code>laravel 6.x</code> 中，会生成 <code>bootstrap/cache/config.php</code> 和 <code>bootstrap/cache/packages.php</code> 和 <code>bootstrap/cache/routes.php</code> 和 <code>bootstrap/cache/services.php</code> 这四个文件。</p><p>services.php 的作用，是把 laravel 在启动过程中需要加载的文件，命名空间和文件路径一个个列举在一个数组中，当 laravel 启动的时候，直接通过这个数组来读取文件。</p><p>packages.php 则是将 laravel 扩展包的 provider 和 facade 整理到一个文件里面，在 laravel 启动加载的时候，直接按照这里的数组进行加载。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan optimize<span class="token comment"># 清空类映射</span>php artisan optimize:clear<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="合理划分子视图"><a href="#合理划分子视图" class="headerlink" title="合理划分子视图"></a>合理划分子视图</h2><blockquote><p>建议不要子模版嵌套子模板，因为可能会出现 N + 1 的问题</p></blockquote><h2 id="会话驱动选择-redis，并且必须选择-phpredis-类库"><a href="#会话驱动选择-redis，并且必须选择-phpredis-类库" class="headerlink" title="会话驱动选择 redis，并且必须选择 phpredis 类库"></a>会话驱动选择 redis，并且必须选择 phpredis 类库</h2><h2 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h2><h3 id="如何在-laravel-中添加索引？"><a href="#如何在-laravel-中添加索引？" class="headerlink" title="如何在 laravel 中添加索引？"></a>如何在 laravel 中添加索引？</h3><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>$table-&gt;primary(‘id’);</td><td>添加主键</td></tr><tr><td>$table-&gt;primary([‘id’, ‘parent_id’]);</td><td>添加复合键</td></tr><tr><td>$table-&gt;unique(‘email’);</td><td>添加唯一索引</td></tr><tr><td>$table-&gt;index(‘state’);</td><td>添加普通索引</td></tr><tr><td>$table-&gt;spatialIndex(‘location’);</td><td>添加地理位置信息索引（不支持 SQLite）</td></tr></tbody></table><p>添加全文索引时，使用</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">statement</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ALTER TABLE posts ADD FULLTEXT full(name, content)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改索引名称</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">renameIndex</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'from'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'to'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="如何在-laravel-中删除索引？"><a href="#如何在-laravel-中删除索引？" class="headerlink" title="如何在 laravel 中删除索引？"></a>如何在 laravel 中删除索引？</h3><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>$table-&gt;dropPrimary(‘users_id_primary’);</td><td>从 users 表中删除主键</td></tr><tr><td>$table-&gt;dropUnique(‘users_email_unique’);</td><td>从 users 表中删除唯一索引</td></tr><tr><td>$table-&gt;dropIndex(‘geo_state_index’);</td><td>从 geo 表中删除基本索引</td></tr><tr><td>$table-&gt;dropSpatialIndex(‘geo_location_spatialindex’);</td><td>从 geo 表中删除空间索引（不支持 SQLite）</td></tr></tbody></table><h2 id="资源压缩（JS-CSS）"><a href="#资源压缩（JS-CSS）" class="headerlink" title="资源压缩（JS/CSS）"></a>资源压缩（JS/CSS）</h2><ul><li>开发环境时，执行</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> run dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>生产环境时，执行 （只有在生产环境中才会对内容进行压缩）</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> run prod<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="压缩-HTML"><a href="#压缩-HTML" class="headerlink" title="压缩 HTML"></a>压缩 HTML</h2><pre class="line-numbers language-none"><code class="language-none"># 安装 laravel-page-speed 扩展包，来去除 html 注释、回车换行符和多余的空格composer require renatomarinho/laravel-page-speed# 发布配置文件php artisan vendor:publish --provider="RenatoMarinho\LaravelPageSpeed\ServiceProvider"# 在 Kenel.php =&gt; $middlewareGroups =&gt; web 中添加中间件\RenatoMarinho\LaravelPageSpeed\Middleware\ElideAttributes::class, // 移除无用的 HTML 属性\RenatoMarinho\LaravelPageSpeed\Middleware\RemoveComments::class, // 移除注释\RenatoMarinho\LaravelPageSpeed\Middleware\TrimUrls::class,  // 移除不必要的 URL 前缀\RenatoMarinho\LaravelPageSpeed\Middleware\CollapseWhitespace::class, // 处理换行符和空格<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="swoole-加速"><a href="#swoole-加速" class="headerlink" title="swoole 加速"></a>swoole 加速</h2><pre class="line-numbers language-none"><code class="language-none"># 安装 laravlescomposer require hhxsv5/laravel-s# 发布配置php artisan laravels publish# 启动 laravelsphp bin/laravels start# 后台守护进程执行php bin/laravels start -d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>nginx 配置 laravels</p><pre class="line-numbers language-none"><code class="language-none">upstream swoole {    # 如果是使用 laradock ，请将 127.0.0.1 更改为 workspace    server 127.0.0.1:5200 weight=5 max_fails=3 fail_timeout=30s;    keepalive 16;}server {    listen 80;    listen 443 ssl http2;    server_name larablog.test;    root /var/www/larablog/public;    index index.html index.htm index.php;    charset utf-8;    location / {        try_files $uri @laravels;    }    location = /favicon.ico { access_log off; log_not_found off; }    location = /robots.txt  { access_log off; log_not_found off; }    error_log /var/log/nginx/larablog_error.log;    access_log /var/log/nginx/larablog_access.log;    sendfile off;    client_max_body_size 100m;    location @laravels {        # proxy_connect_timeout 60s;        # proxy_send_timeout 60s;        # proxy_read_timeout 120s;        proxy_http_version 1.1;        proxy_set_header Connection "";        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Real-PORT $remote_port;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_set_header Host $http_host;        proxy_set_header Scheme $scheme;        proxy_set_header Server-Protocol $server_protocol;        proxy_set_header Server-Name $server_name;        proxy_set_header Server-Addr $server_addr;        proxy_set_header Server-Port $server_port;        proxy_pass http://swoole;    }    location ~ /\.ht {        deny all;    }    ssl_certificate     /etc/nginx/ssl/larablog.test.crt;    ssl_certificate_key /etc/nginx/ssl/larablog.test.key;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果是使用 laradock 的话，还需要将 <code>.env</code> 添加监听地址为 <code>workspace</code></p><pre class="line-numbers language-none"><code class="language-none">LARAVELS_LISTEN_IP=workspace# 设置后台启动 laravelS 服务，如果需要查看则执行 ps -ef|grep laravels 命令LARAVELS_DAEMONIZE=true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Laravel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>全新服务器使用 lnmp 搭建 laravel 项目</title>
      <link href="posts/73f4393e.html"/>
      <url>posts/73f4393e.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用-lnmp-搭建-laravel-项目"><a href="#使用-lnmp-搭建-laravel-项目" class="headerlink" title="使用 lnmp 搭建 laravel 项目"></a>使用 lnmp 搭建 laravel 项目</h1><ul><li>打包源码</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 先在旧服务器上面打包源代码</span><span class="token function">tar</span> <span class="token parameter variable">-czvf</span> hello-world.tar.gz hello-world<span class="token comment"># 然后将源码直接复制到新的服务器上面</span><span class="token function">scp</span> hello-world.tar.gz root@192.168.1.1:/home/wwwroot/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装 screen</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">screen</span><span class="token function">screen</span> <span class="token parameter variable">-S</span> lnmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>下载安装 lnmp 环境</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> http://soft.vpser.net/lnmp/lnmp1.7-full.tar.gz<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> lnmp1.7-full.tar.gz<span class="token builtin class-name">cd</span> lnmp1.7-full/<span class="token comment"># 安装 lnmp</span>./install.sh lnmp<span class="token comment"># 选择了 php7.4 mysql5.7</span><span class="token comment"># 检查 lnmp 是否安装成功</span>lnmp status<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装 swoole 扩展</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 swoole 源码</span><span class="token function">wget</span> https://github.com/swoole/swoole-src/archive/v4.6.4.tar.gz<span class="token comment"># 解压缩源码</span><span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> v4.6.4.tar.gz<span class="token comment"># 生成 configure 文件</span>/usr/local/php/bin/phpize<span class="token comment"># 编译配置项</span>./configure --with-php-config<span class="token operator">=</span>/usr/local/php/bin/php-config --enable-openssl --enable-http2 --enable-sockets --enable-mysqlnd<span class="token comment"># 编译安装</span><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span class="token comment"># 查看 php.ini 配置文件</span>php <span class="token parameter variable">--ini</span><span class="token comment"># 开启 swoole 扩展</span><span class="token function">vim</span> /usr/local/php/etc/php.ini<span class="token comment"># 在 php.ini 配置文件中开启 swoole 扩展</span><span class="token assign-left variable">extension</span><span class="token operator">=</span>swoole.so<span class="token comment"># 或者写绝对路径</span><span class="token assign-left variable">extension</span><span class="token operator">=</span>/usr/local/php/lib/php/extensions/no-debug-non-zts-20190902/swoole.so<span class="token comment"># 重启 php</span>/etc/init.d/php-fpm restart<span class="token comment"># 查看扩展是否已经开启</span>php <span class="token parameter variable">-m</span>  php <span class="token parameter variable">--ri</span> swoole<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装 redis</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载最新稳定版 6.2.1 源码</span><span class="token function">wget</span> https://download.redis.io/releases/redis-6.2.1.tar.gz<span class="token comment"># 解压缩</span><span class="token function">tar</span> xzf redis-6.2.1.tar.gz<span class="token builtin class-name">cd</span> redis-6.2.1<span class="token comment"># 编译安装</span><span class="token function">make</span><span class="token comment"># 启动 redis 服务端</span>src/redis-server （开启后台任务 src/redis-server <span class="token operator">&amp;</span>）<span class="token comment"># 使用 redis 客户端作为测试</span>src/redis-cli 或者 <span class="token builtin class-name">cd</span> src <span class="token operator">&amp;&amp;</span> ./redis-cli<span class="token comment"># 将 redis-cli 加入到环境变量中</span><span class="token function">cp</span> ~/software/redis-6.2.1/src/redis-cli /usr/local/bin/redis-cli<span class="token comment"># 设置执行权限</span><span class="token function">chmod</span> u+x redis-cli<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装 php redis 扩展</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 redis 扩展</span><span class="token function">wget</span> https://github.com/phpredis/phpredis/archive/5.3.3.tar.gz<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> <span class="token number">5.3</span>.3.tar.gz<span class="token builtin class-name">cd</span> phpredis-5.3.3<span class="token comment"># 生成 configure 文件</span>/usr/local/php/bin/phpize<span class="token comment"># 设置配置项</span>./configure --with-php-config<span class="token operator">=</span>/usr/local/php/bin/php-config<span class="token comment"># 编译安装</span><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span class="token comment"># 重启 php</span>/etc/init.d/php-fpm restart<span class="token comment"># 查看扩展是否已经开启</span>php <span class="token parameter variable">-m</span>  php <span class="token parameter variable">--ri</span> redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装 npm</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">npm</span><span class="token function">npm</span> config <span class="token builtin class-name">set</span> <span class="token assign-left variable">registry</span><span class="token operator">=</span>https://registry.npm.taobao.org<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>配置项目</li></ul><p>vim /usr/local/nginx/conf/vhost/hello-world.com.conf</p><p>添加 nginx 配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">server    <span class="token punctuation">{</span>        listen <span class="token number">80</span><span class="token punctuation">;</span>        <span class="token comment">#listen [::]:80;</span>        server_name www.hello-world.com <span class="token punctuation">;</span>        index index.html index.htm index.php default.html default.htm default.php<span class="token punctuation">;</span>        root  /home/wwwroot/hello-world/public<span class="token punctuation">;</span>        include rewrite/none.conf<span class="token punctuation">;</span>        include enable-php.conf<span class="token punctuation">;</span>        location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$        <span class="token punctuation">{</span>            expires      30d<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span>?$        <span class="token punctuation">{</span>            expires      12h<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        location ~ /.well-known <span class="token punctuation">{</span>            allow all<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        location ~ /<span class="token punctuation">\</span>.        <span class="token punctuation">{</span>            deny all<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        location / <span class="token punctuation">{</span>          try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.php?<span class="token variable">$query_string</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        access_log  /home/wwwlogs/hello-world.com.access.log<span class="token punctuation">;</span>        error_log  /home/wwwlogs/hello-world.com.error.log<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    server <span class="token punctuation">{</span>  listen <span class="token number">80</span><span class="token punctuation">;</span>  server_name hello-world.com<span class="token punctuation">;</span>  rewrite ^/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span> http://www.hello-world.com/<span class="token variable">$1</span> permanent<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>删除防跨文件夹设置<br>vim /usr/local/nginx/conf/fastcgi.conf<br>注释掉<br><code>fastcgi_param PHP_ADMIN_VALUE "open_basedir=$document_root/:/tmp/:/proc/";</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">chattr <span class="token parameter variable">-i</span> /home/wwwroot/hello-world/public/.user.ini<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /home/wwwroot/hello-world/public/.user.ini<span class="token comment"># 重启 php-fpm</span>/etc/init.d/php-fpm restart<span class="token comment"># 重新加载 nginx</span>/etc/init.d/nginx reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>vim .env</p><p>更改 mysql 数据库、redis连接信息、以及配置域名</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan jwt:secretphp artisan key:generate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LNMP </tag>
            
            <tag> PHP </tag>
            
            <tag> Laravel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>php 抽奖算法（适合九宫格和大转盘）</title>
      <link href="posts/43b98a2e.html"/>
      <url>posts/43b98a2e.html</url>
      
        <content type="html"><![CDATA[<h1 id="php-抽奖算法（适合九宫格和大转盘）"><a href="#php-抽奖算法（适合九宫格和大转盘）" class="headerlink" title="php 抽奖算法（适合九宫格和大转盘）"></a>php 抽奖算法（适合九宫格和大转盘）</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/*  * 不同概率的抽奖原理就是把0到*（比重总数）的区间分块 * 分块的依据是物品占整个的比重，再根据随机数种子来产生0-* 中的某个数 * 判断这个数是落在哪个区间上，区间对应的就是抽到的那个物品。 * 随机数理论上是概率均等的，那么相应的区间所含数的多少就体现了抽奖物品概率的不同。 */</span>      <span class="token comment">/**     * 抽奖方法     * @return [array] [抽奖情况]     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">doDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 奖品数组</span>        <span class="token variable">$proArr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>            <span class="token comment">// id =&gt; 奖品等级， name =&gt; 奖品名称, v =&gt; 奖品权重</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'超级奖品'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'特等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'一等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'二等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'三等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'四等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'五等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'六等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'七等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'八等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'没中奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 奖品等级奖品权重数组</span>        <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$proArr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'v'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 中奖 id</span>        <span class="token variable">$rid</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">get_rand</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/**模拟抽奖测试**/</span><span class="token comment">/*        $i = 0;        while ( $i &lt; 10000) {          $rid = $this-&gt;get_rand($arr);          $res[] = $rid;          $i++;        }        // 统计奖品出现次数        $result = array_count_values($res);        asort($result);        foreach ($result as $id =&gt; $times) {            foreach ($proArr as $gifts) {                if($id == $gifts['id']){                    $response[$gifts['name']] = $times;                }            }        }        dump($response);        die;*/</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 中奖礼品</span>        <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'yes'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$proArr</span><span class="token punctuation">[</span><span class="token variable">$rid</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 从原奖品数组中剔除已经中奖礼品</span>        <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">[</span><span class="token variable">$rid</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 打乱数组排序</span>        <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'no'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$proArr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// foreach ($proArr as $k =&gt; $v) {</span>        <span class="token comment">//     // 没中奖礼品</span>        <span class="token comment">//     $result['no'][] = $v['name'];</span>        <span class="token comment">// }</span>        <span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 抽奖算法     * @param  array  $proArr 奖品等级奖品权重数组     * @return [int]         中奖奖品等级     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">get_rand</span><span class="token punctuation">(</span><span class="token variable">$proArr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">;</span>        <span class="token variable">$rid</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>        <span class="token comment">// 概率数组的总权重</span>        <span class="token variable">$proSum</span> <span class="token operator">=</span> <span class="token function">array_sum</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 概率数组循环</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$proArr</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token variable">$proCur</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 从 1 到概率总数中任意取值</span>            <span class="token variable">$randNum</span> <span class="token operator">=</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$proSum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 判断随机数是否在概率权重中</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$randNum</span> <span class="token operator">&lt;=</span> <span class="token variable">$proCur</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// 取出奖品 id</span>                <span class="token variable">$rid</span> <span class="token operator">=</span> <span class="token variable">$k</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment">// 如果随机数不在概率权限中，则不断缩小总权重，直到从奖品数组中取出一个奖品</span>                <span class="token variable">$proSum</span> <span class="token operator">-=</span> <span class="token variable">$proCur</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$rid</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试方法：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$proArr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'特等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'一等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'二等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'三等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'四等奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'没中奖'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">500</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$proArr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'v'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 概率数组的总权重</span>    <span class="token variable">$proSum</span> <span class="token operator">=</span> <span class="token function">array_sum</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 概率数组循环</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 从 1 到概率总数中任意取值</span>        <span class="token variable">$randNum</span> <span class="token operator">=</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$proSum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$aa</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$randNum</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'+'</span> <span class="token operator">.</span> <span class="token variable">$v</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'+'</span> <span class="token operator">.</span> <span class="token variable">$proSum</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$randNum</span> <span class="token operator">&lt;=</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$proArr</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">// 找到符合条件的值就跳出 foreach 循环</span>            <span class="token comment">// dump($result);</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$proSum</span> <span class="token operator">=</span> <span class="token variable">$proSum</span> <span class="token operator">-</span> <span class="token variable">$v</span><span class="token punctuation">;</span>            <span class="token variable">$bb</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$randNum</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'+'</span> <span class="token operator">.</span> <span class="token variable">$v</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'+'</span> <span class="token operator">.</span> <span class="token variable">$proSum</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$aa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$bb</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// // dump($result);</span>    <span class="token comment">// // dump(__DIR__);</span>    <span class="token comment">// $path = __DIR__ . DS . 'log';</span>    <span class="token comment">// if(!is_dir($path)){</span>    <span class="token comment">//     mkdir($path);</span>    <span class="token comment">// }</span>    <span class="token comment">// $fileName = $path . DS . 'log.txt';</span>    <span class="token comment">// 创建文件和打开文件的函数都是 fopen</span>    <span class="token comment">// $cFile = fopen($fileName,'a+');</span>    <span class="token comment">// $a = json_encode($aa) . "\r\n";</span>    <span class="token comment">// $b = json_encode($bb) . "\r\n";</span>    <span class="token comment">// fwrite($cFile,$a);</span>    <span class="token comment">// fwrite($cFile,$b);</span>    <span class="token comment">// fclose($cFile);</span>    <span class="token comment">// 读文件</span>    <span class="token comment">// $lines = file($fileName);</span>    <span class="token comment">// foreach ($lines as $key =&gt; $value) {</span>    <span class="token comment">//     dump($value.'555555555');</span>    <span class="token comment">// }</span>    <span class="token comment">// dump($lines);</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下代码也是意义程度上相同的代码，但是这种算法用的不多</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**我是d1-d2：0-1我是d1-d2：1-51我是d1-d2：51-56我是d1-d2：56-156我是d1-d2：156-166我是d1-d2：166-166我是d1-d2：166-666我是d1-d2：666-688我是d1-d2：688-700我是d1-d2：700-900**/</span><span class="token keyword">function</span> <span class="token function-definition function">get_rand</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$proArr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'v'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>      <span class="token variable">$proSum</span> <span class="token operator">=</span> <span class="token function">array_sum</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 计算总权重</span>    <span class="token variable">$randNum</span> <span class="token operator">=</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$proSum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$d1</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token variable">$d2</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$d2</span> <span class="token operator">+=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token variable">$d1</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span>        <span class="token punctuation">{</span>            <span class="token variable">$d1</span> <span class="token operator">+=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$randNum</span> <span class="token operator">&gt;=</span> <span class="token variable">$d1</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$randNum</span> <span class="token operator">&lt;=</span> <span class="token variable">$d2</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$proArr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">unset</span> <span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>开启百分百中奖模式</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token comment">/**    *  $prize_arr 参与抽奖人员数据    *  id: 一般是成员ID    *  name 姓名    *  v   得奖概率    ***/</span>    <span class="token variable">$prize_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>         <span class="token string single-quoted-string">'0'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小王'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'1'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小李'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'2'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小张'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'3'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小二'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'4'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小菜'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'6'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'7'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范01'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'8'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范02'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'9'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范03'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'10'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范04'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'11'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范05'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'12'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范06'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'13'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范07'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'14'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范08'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'15'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范09'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">'16'</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'小范10'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'v'</span><span class="token operator">=&gt;</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$prize_arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'v'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>         <span class="token variable">$total_num</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'8'</span><span class="token punctuation">;</span> <span class="token comment">//设定得中奖人数量</span>        <span class="token variable">$temp_rest</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token variable">$total_num</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$rid</span> <span class="token operator">=</span> <span class="token function">get_rand</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//根据概率获取人员ID</span>        <span class="token variable">$temp_rest</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token variable">$prize_arr</span><span class="token punctuation">[</span><span class="token variable">$rid</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//中奖项</span>        <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$prize_arr</span><span class="token punctuation">[</span><span class="token variable">$rid</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$rid</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$temp_rest</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得出结果</span>    <span class="token comment">/****    *   得出当前中奖人    *   $is_status是否开启概率为100必中: 默认不开启     ***/</span>    <span class="token keyword">function</span> <span class="token function-definition function">get_rand</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">,</span><span class="token variable">$is_status</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$is_status</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$rest</span> <span class="token operator">=</span> <span class="token function">get_100</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用获取100命中</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>             <span class="token variable">$rest</span> <span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$rest</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$rest</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment">//概率数组的总概率精度</span>            <span class="token variable">$proSum</span> <span class="token operator">=</span> <span class="token function">array_sum</span><span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//概率数组循环</span>            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$proArr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$proCur</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token variable">$randNum</span> <span class="token operator">=</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$proSum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$randNum</span> <span class="token operator">&lt;=</span> <span class="token variable">$proCur</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$key</span><span class="token punctuation">;</span>                     <span class="token keyword">break</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                     <span class="token variable">$proSum</span> <span class="token operator">-=</span> <span class="token variable">$proCur</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>               <span class="token punctuation">}</span>         <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$rest</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">unset</span> <span class="token punctuation">(</span><span class="token variable">$proArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function-definition function">get_100</span><span class="token punctuation">(</span><span class="token variable">$arr_mast</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>         <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr_mast</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$value_mast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$value_mast</span><span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$key</span><span class="token punctuation">;</span>                 <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>                  <span class="token punctuation">}</span>         <span class="token keyword">unset</span> <span class="token punctuation">(</span><span class="token variable">$arr_mast</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP 图片对称加解密</title>
      <link href="posts/8331d4d3.html"/>
      <url>posts/8331d4d3.html</url>
      
        <content type="html"><![CDATA[<h1 id="PHP-图片加解密"><a href="#PHP-图片加解密" class="headerlink" title="PHP 图片加解密"></a>PHP 图片加解密</h1><blockquote><p>可以将人员身份证图片通过修改字节加密，并且可将身份证信息也写入图片中</p></blockquote><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/*** *                    .::::. *                  .::::::::. *                 :::::::::::  FUCK YOU *             ..:::::::::::' *           '::::::::::::' *             .:::::::::: *        '::::::::::::::.. *             ..::::::::::::. *           ``:::::::::::::::: *            ::::``:::::::::'        .:::. *           ::::'   ':::::'       .::::::::. *         .::::'      ::::     .:::::::'::::. *        .:::'       :::::  .:::::::::' ':::::. *       .::'        :::::.:::::::::'      ':::::. *      .::'         ::::::::::::::'         ``::::. *  ...:::           ::::::::::::'              ``::. * ```` ':.          ':::::::::'                  ::::.. *                    '.:::::'                    ':'````.. */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Encrypt</span> <span class="token punctuation">{</span><span class="token comment">/** * 图片对称加密 * * @param [string] $filePath 图片路径 * @return void */</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">enc</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 文档中建议：为移植性考虑，强烈建议在用 fopen() 打开文件时总是使用 'b' 标记。</span><span class="token variable">$fileId</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rb+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 取出文件大小的字节数 （29124）</span><span class="token variable">$fileSize</span> <span class="token operator">=</span> <span class="token function">fileSize</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取文件，返回所读取的字符串 （读出来的为二进制序列）</span><span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">,</span> <span class="token variable">$fileSize</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使用“无符号字符”，从二进制字符串对数据进行解包</span><span class="token comment">// （pack、unpack用法）https://segmentfault.com/a/1190000008305573</span><span class="token variable">$imgUnpack</span> <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// $fileSize 长度的一维数组 [ 1=&gt;255, 2=&gt;216, 3=&gt;255, ……, 29124=&gt;217 ]</span><span class="token comment">// 关闭一个已打开的文件指针</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$tempArr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 自定义加密规则</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token variable">$fileSize</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">%</span> <span class="token number">7</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$byte</span> <span class="token operator">=</span> <span class="token variable">$imgUnpack</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 图片原始字节</span><span class="token variable">$byte</span> <span class="token operator">=</span> <span class="token variable">$byte</span> <span class="token operator">+</span> <span class="token variable">$value</span><span class="token punctuation">;</span> <span class="token comment">// 经过加密规则之后的字节</span><span class="token comment">// 打包成二进制字符串</span><span class="token variable">$tempArr</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$byte</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$tempArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将解包之后的一维数组装换成字符串</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重写图片</span><span class="token punctuation">}</span><span class="token comment">/** * 图片对称解密 * * @param [string] $filePath图片路径 * @return void */</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">dec</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token variable">$fileId</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rb+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$fileSize</span> <span class="token operator">=</span> <span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">,</span> <span class="token variable">$fileSize</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$imgUnpack</span> <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$tempArr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 开始解密</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token variable">$fileSize</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">%</span> <span class="token number">7</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$byte</span> <span class="token operator">=</span> <span class="token variable">$imgUnpack</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$byte</span> <span class="token operator">=</span> <span class="token variable">$byte</span> <span class="token operator">-</span> <span class="token variable">$value</span><span class="token punctuation">;</span><span class="token variable">$tempArr</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$byte</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$tempArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/** * 图片追加信息 * * @param [string] $filePath图片路径 * @param [array] $cardmsg需要添加的信息数组 * @param [array] $separate分隔数组（类似于做一个加密分隔 key） * @return void */</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">encmsg</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token variable">$cardmsg</span><span class="token punctuation">,</span> <span class="token variable">$separate</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 文档中建议：为移植性考虑，强烈建议在用 fopen() 打开文件时总是使用 'b' 标记。</span><span class="token variable">$fileId</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rb+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 取出文件大小的字节数 （29124）</span><span class="token variable">$fileSize</span> <span class="token operator">=</span> <span class="token function">fileSize</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取文件，返回所读取的字符串 （读出来的为二进制序列）</span><span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">,</span> <span class="token variable">$fileSize</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使用“无符号字符”，从二进制字符串对数据进行解包</span><span class="token comment">// （pack、unpack用法）https://segmentfault.com/a/1190000008305573</span><span class="token variable">$imgUnpack</span> <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// $fileSize 长度的一维数组 [ 1=&gt;255, 2=&gt;216, 3=&gt;255, ……, 29124=&gt;217 ]</span><span class="token comment">// 关闭一个已打开的文件指针</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 处理身份信息</span><span class="token variable">$cardmsgJson</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$cardmsg</span><span class="token punctuation">,</span> <span class="token constant">JSON_UNESCAPED_UNICODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$cardmsgUnpack</span> <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$cardmsgJson</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 合并图片字节、自定义分隔数组（类似手动加 key 值）、身份信息字节</span><span class="token variable">$mergeArr</span> <span class="token operator">=</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$imgUnpack</span><span class="token punctuation">,</span> <span class="token variable">$separate</span><span class="token punctuation">,</span> <span class="token variable">$cardmsgUnpack</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$pack</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$mergeArr</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$pack</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$packStr</span> <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$pack</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token variable">$packStr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重写图片</span><span class="token punctuation">}</span><span class="token comment">/** * 获取追加进图片的信息 * * @param [string] $filePath图片路径 * @param [array] $separate定义的分隔数组（分隔 key） * @return [string] 追加进的图片信息 */</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">decmsg</span> <span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token variable">$separate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 文档中建议：为移植性考虑，强烈建议在用 fopen() 打开文件时总是使用 'b' 标记。</span><span class="token variable">$fileId</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rb+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 取出文件大小的字节数 (29192)</span><span class="token variable">$fileSize</span> <span class="token operator">=</span> <span class="token function">fileSize</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取文件，返回所读取的字符串 （读出来的为二进制序列）</span><span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">,</span> <span class="token variable">$fileSize</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使用“无符号字符”，从二进制字符串对数据进行解包</span><span class="token variable">$imgUnpack</span> <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// $fileSize 长度的一维数组 [ 1=&gt;255, 2=&gt;216, 3=&gt;255, ……, 29192=&gt;217 ]</span><span class="token comment">// 关闭一个已打开的文件指针</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$imgUnpackStr</span> <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span><span class="token variable">$imgUnpack</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将一维数组转换为字符串</span><span class="token variable">$separateStr</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$separate</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将一维数组转换为字符串</span><span class="token variable">$imgAndCardmsgArr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token variable">$separateStr</span><span class="token punctuation">,</span> <span class="token variable">$imgUnpackStr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 以自定义分隔符分隔出图片字节和身份信息字节</span><span class="token variable">$cardmsgArr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$imgAndCardmsgArr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取出身份信息字节</span><span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$cardmsgArr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 去除身份信息字节首位空白 （字符串转数组时所留）</span><span class="token variable">$cardmsg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$cardmsgArr</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$cardmsg</span> <span class="token operator">.=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C*'</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 打包成二进制文件字符串</span><span class="token punctuation">}</span> <span class="token keyword">return</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$cardmsg</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$encrypt</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Encrypt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'./001.jpg'</span><span class="token punctuation">;</span><span class="token variable">$separate</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">206</span><span class="token punctuation">,</span> <span class="token number">210</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">,</span> <span class="token number">199</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">214</span><span class="token punctuation">,</span> <span class="token number">184</span><span class="token punctuation">,</span> <span class="token number">244</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 15字节</span><span class="token variable">$cardmsg</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'张三'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'gender'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'男'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'idcard'</span> <span class="token operator">=&gt;</span> <span class="token number">12345678910</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 53字节</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 图片加解密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP AES 加解密</title>
      <link href="posts/ebe0be72.html"/>
      <url>posts/ebe0be72.html</url>
      
        <content type="html"><![CDATA[<h1 id="PHP-AES-加解密"><a href="#PHP-AES-加解密" class="headerlink" title="PHP AES 加解密"></a>PHP AES 加解密</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">Aesmcrypt</span><span class="token punctuation">{</span>    <span class="token comment">/**     * MCRYPT_ciphername 常量中的一个，或者是字符串值的算法名称。     */</span>    <span class="token keyword">const</span> <span class="token constant">CIPHER</span> <span class="token operator">=</span> <span class="token constant">MCRYPT_RIJNDAEL_128</span><span class="token punctuation">;</span>    <span class="token comment">/**     * MCRYPT_MODE_modename 常量中的一个，或以下字符串中的一个：     * "ecb"，"cbc"，"cfb"，"ofb"，"nofb" 和 "stream"。     */</span>    <span class="token keyword">const</span> <span class="token constant">MODE</span> <span class="token operator">=</span> <span class="token constant">MCRYPT_MODE_CBC</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 加密密钥。如果密钥长度不是该算法所能够支持的有效长度，则函数将会发出警告并返回 FALSE     */</span>    <span class="token keyword">const</span> <span class="token constant">KEY</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'bcb04b7e103a0cd8b54763051'</span><span class="token punctuation">;</span>    <span class="token comment">/**     * aes 加密     *     * @param string $str 需要加密的字符串     * @param string $key 加密用到的 key     * @return string 加密后的字符串     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">encryptAes</span> <span class="token punctuation">(</span><span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">KEY</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$keyArr</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getLegalKey</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$encrypted</span> <span class="token operator">=</span> <span class="token function">mcrypt_encrypt</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">CIPHER</span><span class="token punctuation">,</span> <span class="token variable">$keyArr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">MODE</span><span class="token punctuation">,</span> <span class="token variable">$keyArr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'iv'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$encrypted</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * aes 解密     *     * @param string $str 加密后的字符串     * @param string $key 加密用到的 key     * @return string 解密后的字符串     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">decryptAes</span> <span class="token punctuation">(</span><span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">KEY</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$keyArr</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getLegalKey</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$decrypted</span> <span class="token operator">=</span> <span class="token function">rtrim</span><span class="token punctuation">(</span><span class="token function">mcrypt_decrypt</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">CIPHER</span><span class="token punctuation">,</span> <span class="token variable">$keyArr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">MODE</span><span class="token punctuation">,</span> <span class="token variable">$keyArr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'iv'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$decrypted</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 生成有效的 key     *     * @param $key 原始 key     * @return array     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">getLegalKey</span> <span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必须为16，24，32个字符</span>        <span class="token variable">$iv</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'key'</span> <span class="token operator">=&gt;</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'iv'</span> <span class="token operator">=&gt;</span> <span class="token variable">$iv</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> AES </tag>
            
            <tag> 加解密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP 使用 CASE WHEN 进行批量更新 （当前基于 laravel 编写）</title>
      <link href="posts/eaf6377d.html"/>
      <url>posts/eaf6377d.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用-CASE-WHEN-进行批量更新-（当前基于-laravel-编写）"><a href="#使用-CASE-WHEN-进行批量更新-（当前基于-laravel-编写）" class="headerlink" title="使用 CASE WHEN 进行批量更新 （当前基于 laravel 编写）"></a>使用 CASE WHEN 进行批量更新 （当前基于 laravel 编写）</h1><h2 id="最终执行的-sql-语句为"><a href="#最终执行的-sql-语句为" class="headerlink" title="最终执行的 sql 语句为"></a>最终执行的 sql 语句为</h2><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">UPDATE articles SET view_count = CASEWHEN id = 183 AND user_id = 1 THEN 6WHEN id = 182 AND user_id = 11 THEN 4WHEN id = 181 AND user_id = 15 THEN 4WHEN id = 180 AND user_id = 5 THEN 1ELSE view_count END,updated_at = CASE WHEN id = 183 AND user_id = 1 THEN '2020-11-06 06:44:58'WHEN id = 182 AND user_id = 11 THEN '2020-11-06 06:44:58'WHEN id = 181 AND user_id = 15 THEN '2020-11-06 06:44:58'WHEN id = 180 AND user_id = 5 THEN '2020-11-06 06:44:58'ELSE updated_at END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="封装成方法为"><a href="#封装成方法为" class="headerlink" title="封装成方法为"></a>封装成方法为</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'batch_update'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * $where = [ 'id' =&gt; [180, 181, 182, 183], 'user_id' =&gt; [5, 15, 11, 1]];     * $needUpdateFields = [ 'view_count' =&gt; [11, 22, 33, 44], 'updated_at' =&gt; ['2019-11-06 06:44:58', '2019-11-30 19:59:34', '2019-11-05 11:58:41', '2019-12-13 01:27:59']];     *     * 最终执行的 sql 语句如下所示     *     * UPDATE articles SET     * view_count = CASE     * WHEN id = 183 AND user_id = 1 THEN 44     * WHEN id = 182 AND user_id = 11 THEN 33     * WHEN id = 181 AND user_id = 15 THEN 22     * WHEN id = 180 AND user_id = 5 THEN 11     * ELSE view_count END,     * updated_at = CASE     * WHEN id = 183 AND user_id = 1 THEN '2019-12-13 01:27:59'     * WHEN id = 182 AND user_id = 11 THEN '2019-11-05 11:58:41'     * WHEN id = 181 AND user_id = 15 THEN '2019-11-30 19:59:34'     * WHEN id = 180 AND user_id = 5 THEN '2019-11-06 06:44:58'     * ELSE updated_at END     *     *     * 批量更新数据     *     * @param string $tableName  需要更新的表名称     * @param array $where  需要更新的条件     * @param array $needUpdateFields  需要更新的字段     * @return bool|int  更新数据的条数     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">batch_update</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$tableName</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$where</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$needUpdateFields</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$where</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$needUpdateFields</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>        <span class="token comment">// 第一个条件数组的值</span>        <span class="token variable">$firstWhere</span> <span class="token operator">=</span> <span class="token variable">$where</span><span class="token punctuation">[</span><span class="token function">array_key_first</span><span class="token punctuation">(</span><span class="token variable">$where</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 第一个条件数组的值的总数量</span>        <span class="token variable">$whereFirstValCount</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$firstWhere</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 需要更新的第一个字段的值的总数量</span>        <span class="token variable">$needUpdateFieldsValCount</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$needUpdateFields</span><span class="token punctuation">[</span><span class="token function">array_key_first</span><span class="token punctuation">(</span><span class="token variable">$needUpdateFields</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$whereFirstValCount</span> <span class="token operator">!==</span> <span class="token variable">$needUpdateFieldsValCount</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>        <span class="token comment">// 所有的条件字段数组</span>        <span class="token variable">$whereKeys</span> <span class="token operator">=</span> <span class="token function">array_keys</span><span class="token punctuation">(</span><span class="token variable">$where</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 绑定参数</span>        <span class="token variable">$building</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//        $whereArr = [</span><span class="token comment">//          0 =&gt; "id = 180 AND ",</span><span class="token comment">//          1 =&gt; "user_id = 5 AND ",</span><span class="token comment">//          2 =&gt; "id = 181 AND ",</span><span class="token comment">//          3 =&gt; "user_id = 15 AND ",</span><span class="token comment">//          4 =&gt; "id = 182 AND ",</span><span class="token comment">//          5 =&gt; "user_id = 11 AND ",</span><span class="token comment">//          6 =&gt; "id = 183 AND ",</span><span class="token comment">//          7 =&gt; "user_id = 1 AND ",</span><span class="token comment">//        ]</span>        <span class="token variable">$whereArr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$whereBuilding</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$firstWhere</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$whereKeys</span> <span class="token keyword">as</span> <span class="token variable">$whereKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//                $whereArr[] = "{$whereKey} = {$where[$whereKey][$k]} AND ";</span>                <span class="token variable">$whereArr</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$whereKey</span><span class="token punctuation">}</span></span> = ? AND "</span><span class="token punctuation">;</span>                <span class="token variable">$whereBuilding</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$where</span><span class="token punctuation">[</span><span class="token variable">$whereKey</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token comment">//        $whereArray = [</span><span class="token comment">//            0 =&gt; "id = 180 AND user_id = 5",</span><span class="token comment">//            1 =&gt; "id = 181 AND user_id = 15",</span><span class="token comment">//            2 =&gt; "id = 182 AND user_id = 11",</span><span class="token comment">//            3 =&gt; "id = 183 AND user_id = 1",</span><span class="token comment">//        ]</span>        <span class="token variable">$whereArrChunck</span> <span class="token operator">=</span> <span class="token function">array_chunk</span><span class="token punctuation">(</span><span class="token variable">$whereArr</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$whereKeys</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$whereBuildingChunck</span> <span class="token operator">=</span> <span class="token function">array_chunk</span><span class="token punctuation">(</span><span class="token variable">$whereBuilding</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$whereKeys</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$whereArray</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$whereArrChunck</span> <span class="token keyword">as</span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$valStr</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$val</span> <span class="token keyword">as</span> <span class="token variable">$vv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$valStr</span> <span class="token operator">.=</span> <span class="token variable">$vv</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">// 去除掉后面的 AND 字符及空格</span>            <span class="token variable">$whereArray</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">rtrim</span><span class="token punctuation">(</span><span class="token variable">$valStr</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"AND "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 需要更新的字段数组</span>        <span class="token variable">$needUpdateFieldsKeys</span> <span class="token operator">=</span> <span class="token function">array_keys</span><span class="token punctuation">(</span><span class="token variable">$needUpdateFields</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 拼接 sql 语句</span>        <span class="token variable">$sqlStr</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$needUpdateFieldsKeys</span> <span class="token keyword">as</span> <span class="token variable">$needUpdateFieldsKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$whereArray</span> <span class="token keyword">as</span> <span class="token variable">$kk</span> <span class="token operator">=&gt;</span> <span class="token variable">$vv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//                $str .= ' WHEN ' . $vv . ' THEN ' . $needUpdateFields[$needUpdateFieldsKey][$kk];</span>                <span class="token variable">$str</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">' WHEN '</span> <span class="token operator">.</span> <span class="token variable">$vv</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' THEN ? '</span><span class="token punctuation">;</span>                <span class="token comment">// 合并需要绑定的参数</span>                <span class="token variable">$building</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$whereBuildingChunck</span><span class="token punctuation">[</span><span class="token variable">$kk</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$needUpdateFields</span><span class="token punctuation">[</span><span class="token variable">$needUpdateFieldsKey</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$kk</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token variable">$sqlStr</span> <span class="token operator">.=</span> <span class="token variable">$needUpdateFieldsKey</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' = CASE '</span> <span class="token operator">.</span> <span class="token variable">$str</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' ELSE '</span> <span class="token operator">.</span> <span class="token variable">$needUpdateFieldsKey</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' END, '</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 去除掉后面的逗号及空格</span>        <span class="token variable">$sqlStr</span> <span class="token operator">=</span> <span class="token function">rtrim</span><span class="token punctuation">(</span><span class="token variable">$sqlStr</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$tblSql</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'UPDATE '</span> <span class="token operator">.</span> <span class="token variable">$tableName</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' SET '</span><span class="token punctuation">;</span>        <span class="token variable">$tblSql</span> <span class="token operator">=</span> <span class="token variable">$tblSql</span> <span class="token operator">.</span> <span class="token variable">$sqlStr</span><span class="token punctuation">;</span>        <span class="token variable">$building</span> <span class="token operator">=</span> <span class="token function">array_reduce</span><span class="token punctuation">(</span><span class="token variable">$building</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"array_merge"</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        return [$tblSql, $building];</span>        <span class="token keyword">return</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>DB</span><span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token variable">$tblSql</span><span class="token punctuation">,</span> <span class="token variable">$building</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Laravel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP 无限遍历数组</title>
      <link href="posts/65e7f3e8.html"/>
      <url>posts/65e7f3e8.html</url>
      
        <content type="html"><![CDATA[<h1 id="无限遍历数组"><a href="#无限遍历数组" class="headerlink" title="无限遍历数组"></a>无限遍历数组</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token keyword">function</span> <span class="token function-definition function">fun</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token function">fun</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token keyword">echo</span> <span class="token variable">$value</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>   <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'123'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'b'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'456'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'666'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'d'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'8888'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'e'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'4578'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'f'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'484878'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">fun</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="对无限数组格式化数组中的值"><a href="#对无限数组格式化数组中的值" class="headerlink" title="对无限数组格式化数组中的值"></a>对无限数组格式化数组中的值</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'1'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'2'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'3'</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'a'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'333'</span><span class="token punctuation">,</span>            <span class="token punctuation">[</span><span class="token string single-quoted-string">'b'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'111'</span><span class="token punctuation">]</span>        <span class="token punctuation">]</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">recursion</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">recursion</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">array</span><span class="token punctuation">{</span>    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">recursion</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$v</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 或者这种</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">recursion</span><span class="token punctuation">(</span><span class="token keyword type-declaration">array</span> <span class="token operator">&amp;</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">array</span><span class="token punctuation">{</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=&gt;</span> <span class="token operator">&amp;</span><span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$v</span> <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token function">recursion</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span><span class="token punctuation">}</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="无限遍历与分类-一"><a href="#无限遍历与分类-一" class="headerlink" title="无限遍历与分类(一)"></a>无限遍历与分类(一)</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'123456'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SET NAMES UTF8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'select * from menus'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$items</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$res</span><span class="token operator">-&gt;</span><span class="token function">fetch_array</span><span class="token punctuation">(</span><span class="token constant">MYSQLI_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$items</span><span class="token punctuation">[</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$tree</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$items</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$items</span><span class="token punctuation">[</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pid'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'son'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token variable">$items</span><span class="token punctuation">[</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 所有数据堆成的数据树</span><span class="token variable">$tree</span> <span class="token operator">=</span> <span class="token variable">$items</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'son'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">a</span> <span class="token punctuation">(</span><span class="token variable">$tree</span> <span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$level</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$tree</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$level</span><span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$tree</span> <span class="token keyword">as</span> <span class="token variable">$id</span> <span class="token operator">=&gt;</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'level'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$level</span><span class="token punctuation">;</span>            <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token variable">$id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'son'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">a</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'son'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token variable">$level</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token variable">$id</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'son'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token variable">$level</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$newtree</span> <span class="token operator">=</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token variable">$tree</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$newtree</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="无限遍历与分类-二"><a href="#无限遍历与分类-二" class="headerlink" title="无限遍历与分类(二)"></a>无限遍历与分类(二)</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'123456'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SET NAMES UTF8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'select * from menus'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$items</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$res</span><span class="token operator">-&gt;</span><span class="token function">fetch_array</span><span class="token punctuation">(</span><span class="token constant">MYSQLI_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$items</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">menulist</span><span class="token punctuation">(</span><span class="token variable">$menu</span><span class="token punctuation">,</span><span class="token variable">$id</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$level</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">static</span> <span class="token variable">$menus</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$menu</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pid'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'level'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$level</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$level</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'level'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token variable">$level</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;'</span><span class="token operator">.</span><span class="token string single-quoted-string">'└ '</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token variable">$level</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;'</span><span class="token operator">.</span><span class="token string single-quoted-string">'└ '</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&amp;emsp;&amp;emsp;'</span><span class="token operator">.</span><span class="token string single-quoted-string">'└ '</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$menus</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">menulist</span><span class="token punctuation">(</span><span class="token variable">$menu</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'level'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token variable">$menus</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$newRows</span> <span class="token operator">=</span> <span class="token function">menulist</span><span class="token punctuation">(</span><span class="token variable">$items</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="无限遍历与分类-（三）"><a href="#无限遍历与分类-（三）" class="headerlink" title="无限遍历与分类 （三）"></a>无限遍历与分类 （三）</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$arrs</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'parent_id'</span><span class="token operator">=&gt;</span><span class="token number">0</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'parent_id'</span><span class="token operator">=&gt;</span><span class="token number">1</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">3</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'parent_id'</span><span class="token operator">=&gt;</span><span class="token number">2</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">4</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'parent_id'</span><span class="token operator">=&gt;</span><span class="token number">2</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>        <span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">5</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'parent_id'</span><span class="token operator">=&gt;</span><span class="token number">0</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function-definition function">getTree</span><span class="token punctuation">(</span><span class="token variable">$arrs</span><span class="token punctuation">,</span><span class="token variable">$root</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$level</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$tree</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arrs</span> <span class="token keyword">as</span> <span class="token variable">$foo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$foo</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'parent_id'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token variable">$root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$level</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                           <span class="token variable">$foo</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'children'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getTree</span><span class="token punctuation">(</span><span class="token variable">$arrs</span><span class="token punctuation">,</span><span class="token variable">$foo</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$level</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token variable">$tree</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$foo</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token operator">--</span><span class="token variable">$level</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$tree</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">var_export</span> <span class="token punctuation">(</span><span class="token variable">$arrs</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">// 一级</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="无限遍历与分类-（四）"><a href="#无限遍历与分类-（四）" class="headerlink" title="无限遍历与分类 （四）"></a>无限遍历与分类 （四）</h2><p>对具有父子关系的数组进行重新排序，不改变数据结构</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$permissions</span> <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'1'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'a-1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'1'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'a-2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'3'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'c-1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'3'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'c-2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'4'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'a-1-2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pid'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'4'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'a-1-1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">permissionTree</span><span class="token punctuation">(</span><span class="token variable">$permissions</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/** * 根据父子关系重新排序 * * @param $data  具有父子关系的二维数组 * @param int $root  获取指定层级标识 * @param array $result  用于保存数据的数组 * @return array */</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">permissionTree</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$root</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token keyword">as</span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 排除掉非直接子集</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pid'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token variable">$root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$item</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">permissionTree</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP返回可读性更好的文件大小显示</title>
      <link href="posts/3676e41e.html"/>
      <url>posts/3676e41e.html</url>
      
        <content type="html"><![CDATA[<h1 id="返回可读性更好的文件大小显示"><a href="#返回可读性更好的文件大小显示" class="headerlink" title="返回可读性更好的文件大小显示"></a>返回可读性更好的文件大小显示</h1><ul><li>方法一</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token comment">/**     * 返回可读性更好的文件大小     *      * @param $bytes  int 文件大小（字节数）     * @param int $decimals 保留多少位数     * @return string 带单位的文件大小字符串     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">human_filesize</span> <span class="token punctuation">(</span><span class="token variable">$bytes</span><span class="token punctuation">,</span> <span class="token variable">$decimals</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$size</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'B'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'kB'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'MB'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'GB'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'TB'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PB'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 舍去法取整</span>        <span class="token variable">$factor</span> <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$bytes</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"%.<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$decimals</span><span class="token punctuation">}</span></span>f"</span><span class="token punctuation">,</span> <span class="token variable">$bytes</span> <span class="token operator">/</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token variable">$factor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> @<span class="token variable">$size</span><span class="token punctuation">[</span><span class="token variable">$factor</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="以上代码做详细解释如下"><a href="#以上代码做详细解释如下" class="headerlink" title="以上代码做详细解释如下"></a>以上代码做详细解释如下</h3><p>每相邻的两个存储单位之间以字节数长度的 <code>3</code> 倍做间隔，比如看以下表中所示</p><table><thead><tr><th>字节长度</th><th>字节数</th><th>换算</th><th>B级</th><th>KB级</th><th>MB级</th><th>GB级</th></tr></thead><tbody><tr><td>4</td><td>1000</td><td>1000 / 1024</td><td>0.98 B</td><td></td><td></td><td></td></tr><tr><td>5</td><td>10000</td><td>10000 / 1024</td><td>9.8 B</td><td></td><td></td><td></td></tr><tr><td>6</td><td>10000 0</td><td>10000 0 / 1024</td><td>98 B</td><td></td><td></td><td></td></tr><tr><td>7</td><td>10000 00</td><td>10000 00 / 1024</td><td>980 B</td><td>0.95 KB</td><td></td><td></td></tr><tr><td>8</td><td>10000 000</td><td>10000 000 / 1024</td><td>9800 B</td><td>9.5 KB</td><td></td><td></td></tr><tr><td>9</td><td>10000 0000</td><td>10000 0000 / 1024</td><td>98000 B</td><td>95 KB</td><td></td><td></td></tr><tr><td>10</td><td>10000 0000 0</td><td>10000 0000 0 / 1024</td><td>980000 B</td><td>950 KB</td><td>0.93 MB</td><td></td></tr><tr><td>11</td><td>10000 0000 00</td><td>10000 0000 00 / 1024</td><td>980000 0 B</td><td>950 KB</td><td>9.3 MB</td><td></td></tr><tr><td>12</td><td>10000 0000 000</td><td>10000 0000 000 / 1024</td><td>980000 00 B</td><td>9500 KB</td><td>93 MB</td><td></td></tr><tr><td>13</td><td>10000 0000 0000</td><td>10000 0000 0000 / 1024</td><td>980000B</td><td>95000 KB</td><td>930 MB</td><td>0.91 GB</td></tr></tbody></table><p>通过以上的规律，我们可以观察到每两个相邻的量级之间可以通过字节长度的 <code>3</code> 倍来划分，减 1 的话类比分页的页码计算，如果字节数长度刚好是 3 的倍数，应该归到前一个量级，比如字节数是 100 bytes，对应长度是 3，显然应该显示为 100B 更好，而不是用 KB 来显示。</p><ul><li>方法二</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token comment">/**    * 对文件大小做可读性更好的显示    *    * @param integer $bytes    字节数  需要格式转换的字节数    * @param integer $decimals 保留几位小数    * @return float  处理好的字节数    */</span>    <span class="token keyword">function</span> <span class="token function-definition function">format_bytes</span><span class="token punctuation">(</span><span class="token variable">$bytes</span><span class="token punctuation">,</span> <span class="token variable">$decimals</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$units</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'B'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'KB'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'MB'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'GB'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'TB'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$bytes</span> <span class="token operator">&gt;=</span> <span class="token number">1024</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$size</span> <span class="token operator">=</span> <span class="token variable">$bytes</span> <span class="token operator">/=</span> <span class="token number">1024</span><span class="token punctuation">;</span>            <span class="token comment">// 等同于以下代码</span>            <span class="token comment">// $size = $bytes = $bytes / 1024;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token variable">$size</span><span class="token punctuation">,</span> <span class="token variable">$decimals</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token variable">$units</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token operator">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="调用方式"><a href="#调用方式" class="headerlink" title="调用方式"></a>调用方式</h3><blockquote><p>相比而言，方式一会比方式二可读性更加好一些</p></blockquote><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token variable">$bytes1</span> <span class="token operator">=</span> <span class="token function">human_filesize</span><span class="token punctuation">(</span><span class="token number">94875468</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// output: =&gt;  90.48MB</span>    <span class="token variable">$bytes2</span> <span class="token operator">=</span> <span class="token function">format_bytes</span><span class="token punctuation">(</span><span class="token number">94875468</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// output:  =&gt;  90.48MB</span>    <span class="token variable">$bytes3</span> <span class="token operator">=</span> <span class="token function">human_filesize</span><span class="token punctuation">(</span><span class="token number">1024000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// output:  =&gt;  0.98MB</span>    <span class="token variable">$bytes4</span> <span class="token operator">=</span> <span class="token function">format_bytes</span><span class="token punctuation">(</span><span class="token number">1024000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// output:  =&gt;  1000KB</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$bytes1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$bytes2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$bytes3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$bytes4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP-FPM 性能配置优化</title>
      <link href="posts/6643f286.html"/>
      <url>posts/6643f286.html</url>
      
        <content type="html"><![CDATA[<h1 id="PHP-FPM-性能配置优化"><a href="#PHP-FPM-性能配置优化" class="headerlink" title="PHP-FPM 性能配置优化"></a>PHP-FPM 性能配置优化</h1><blockquote><p>4 核 8 G 服务器大约可以开启 500 个 PHP-FPM，极限吞吐量在 580 qps （Query Per Second 每秒查询数）左右。</p></blockquote><h2 id="Nginx-php-fpm-是怎么工作的？"><a href="#Nginx-php-fpm-是怎么工作的？" class="headerlink" title="Nginx + php-fpm 是怎么工作的？"></a>Nginx + php-fpm 是怎么工作的？</h2><p>php-fpm 全称是 <strong>PHP FastCGI Process Manager</strong> 的简称，从名字可得知，是一个 FastCGI 的管理器。</p><h3 id="什么是-FastCGI？"><a href="#什么是-FastCGI？" class="headerlink" title="什么是 FastCGI？"></a>什么是 FastCGI？</h3><p>FastCGI 是 <strong>Fast Common Gateway Interface</strong> 的简称，是一种交互程序（此处是 PHP）与 Web 服务器之间的 通信协议。FastCGI 是早期通用网关接口（CGI）的增强版本。</p><p>注意 FastCGI 和 CGI 都是一种 <strong>通信协议</strong>，独立于任何语言。Web 服务器无须对语言有任何了解。除 PHP 有 php-fpm 外，像 Python, Ruby, Perl, Tcl, C/C++, 和 Visual Basic 都有其各自的 CGI 和 FastCGI 实现。</p><h3 id="CGI-和-FastCGI-的区别？"><a href="#CGI-和-FastCGI-的区别？" class="headerlink" title="CGI 和 FastCGI 的区别？"></a>CGI 和 FastCGI 的区别？</h3><p>CGI 程序运行在独立的进程中，并对每个 Web 请求创建一个进程，这种方法非常容易实现，但效率很差，难以扩展。 <strong>面对大量请求，进程的大量创建和消亡使操作系统性能大大下降。</strong> 此外，由于地址空间无法共享，也限制了资源重用。</p><p>FastCGI 致力于减少网页服务器与 CGI 程序之间交互的开销，从而使服务器可以同时处理更多的网页请求。与为每个请求创建一个新的进程不同，FastCGI 使用持续的进程来处理一连串的请求。这些进程由 FastCGI 服务器管理（FPM），而不是 Web 服务器。当进来一个请求时，Web 服务器把环境变量和这个页面请求通过一个 Socket 或者 TCP Connection 传递给 FastCGI 进程：</p><p><img src="/medias/loading.gif" data-original="https://cdn.learnku.com/uploads/images/201909/23/1/3PvNql1Ri5.png!large" alt="nginx + php-fpm 工作模式"></p><h2 id="php-fpm-进程数调优"><a href="#php-fpm-进程数调优" class="headerlink" title="php-fpm 进程数调优"></a>php-fpm 进程数调优</h2><p>fpm 服务启动初始化时，会根据配置信息里设置的运行模式，来选择是否创建、以及创建多少 CGI 进程，这些进程随时待命，等待处理从 Web 服务器传送过来的请求：</p><p><img src="/medias/loading.gif" data-original="https://cdn.learnku.com/uploads/images/201909/23/1/6J4kGKBzVL.png!large" alt="nginx 配合 php-cgi 的运行"></p><p>PHP 7.2 FPM 进程池的配置信息位于：</p><pre class="line-numbers language-none"><code class="language-none">/etc/php/7.2/fpm/pool.d/www.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>搜寻下 pm 运行模式的配置，默认是 dynamic ：</p><pre class="line-numbers language-none"><code class="language-none">pm = dynamic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>fpm 的运行模式有三种：</p><ul><li>ondemand 按需创建</li><li>dynamic 动态创建</li><li>static 固定数量</li></ul><p><strong>ondemand</strong></p><p>ondemand 初始化时不会创建待命的进程。并且会在空闲时将进程销毁，请求进来时再开启。一般是在共享的 VPS 上使用。是一种比较 节省内存 的 FPM 运行方式，不过因为其频繁创建和销毁进程，性能表现不佳。</p><p>相关参数：</p><pre class="line-numbers language-none"><code class="language-none">; 默认是 10 秒，超过 10 秒即销毁pm.process_idle_timeout = 10s;; 最大并存进程数，超过此值将不再创建pm.max_children = 50; 每个进程最多处理多少个请求，超过此值将自动销毁pm.max_requests = 1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>dynamic</strong></p><p>动态创建，这个是默认选项，也是比较灵活的选项。兼顾稳定和快速响应。同时有四个参数会影响此配置：</p><pre class="line-numbers language-none"><code class="language-none">; FPM 启动时创建的进程数pm.start_servers = 10; 最大并存进程数，超过此值将不再创建pm.max_children = 50; 空闲进程数最小值，如果空闲进程小于此值，则创建新的子进程pm.min_spare_servers = 10; 空闲进程数最大值，如果空闲进程大于此值，则进行清理pm.max_spare_servers = 40; 每个进程最多处理多少个请求，超过此值将自动销毁pm.max_requests = 1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的注释已经很释义，空闲进程的概念需要讲下。按照上面的设置，fpm 启动时会有 10 个进程启动，此时这 10 个进程都属于「空闲进程」，随时待命。</p><p>进来了一个请求，一个进程前往处理，此时剩下 9 个「空闲进程」，fpm 发现少于 min_spare_servers 设置的值 10 ，就会新建一个进程作为「空闲进程」，此时系统存在 11 个进程，还是 10 个空闲进程。</p><p>在第一个请求还未处理完成时，突然一波流量进来，一口气进来了 50 个请求，因为 max_children 设置了 50 个封顶，所以 FPM 会新建 39 个进程，加上 10 个进行进程一起处理这波请求，此时系统中总共 50 个进程共存，50 个进程都属于繁忙中，未分配到进程的请求会等待着。</p><p>等所有的请求处理完成后，系统中共存的 50 个进程变成「空闲进程」，超过了 max_spare_servers 值 40 个的限制，超出的 10 个会被销毁，系统此时存在 40 个「空闲进程」，随时待命。</p><p>因为一直保证有「空闲进程」可供使用，所以 <strong>dynamic</strong> 的配置，相比 <strong>ondemand</strong> 进程要同时创建，响应速度还是比较快的。然而在还是避免不了频繁创建和销毁进程对系统造成的消耗。</p><p><strong>static</strong></p><p>固定进程数量是性能最好，资源利用率最高的运行方式，一般在要求单机性能最高的时候使用，例如你准备创建 PHP 服务器集群，希望每台机器都能物尽其用。</p><p>相关配置：</p><pre class="line-numbers language-none"><code class="language-none">; FPM 启动时创建的进程数，并且会一直保持这个数pm.max_children = 50; 每个进程最多处理多少个请求，超过此值将自动销毁pm.max_requests = 1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>pm.max_children</code> 的设置，需要我们每一个进程运行我们的程序，需要消耗多少内存，以及机器上有多少内存可供使用。</p><p>计算公式：</p><pre class="line-numbers language-none"><code class="language-none">pm.max_children = 可用内存 / 每个进程暂用内存大小<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>注意可用内存不是本机所有内存，要除去其他程序运行，例如说你应该除去 Elasticsearch 占用了 2G 内存。</p><p>调试期间，要在生产环境中实战观察，一般建议使用 80% 的内存使用率，留 20% 给内存泄露的空间和其他软件运行。</p><p>最后是 pm.max_requests 值，需要我们观察应用是否有 <strong>内存泄漏</strong>。现代的 PHP 程序，尤其是 Laravel ，会依赖于非常多的扩展包，这些扩展包代码质量参差不齐，多少会出现内存泄漏的问题。如果内存泄露不严重，那么把值设置高一点，让单个进程在存活期间 <strong>多处理一些请求</strong>，如果内存泄露比较严重，应当酌情设置低一点。否则会出现系统 <strong>内存不够用</strong>，然后去使用 Swap 物理内存 的窘境。</p><p>修改后请记得重启 FPM：</p><pre class="line-numbers language-none"><code class="language-none">sudo service php7.2-fpm restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Unix-Socket-和-TCP-Socket"><a href="#Unix-Socket-和-TCP-Socket" class="headerlink" title="Unix Socket 和 TCP Socket"></a>Unix Socket 和 TCP Socket</h2><p>Nginx 连接 FPM 有 Unix Socket 和 TCP Socket 两种方式：</p><p>Unix Socket：</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> ~ \.php$</span> <span class="token punctuation">{</span>    fastcgi_pass unix:/run/php/php7.2-fpm.sock<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>TCP Socket：</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">fastcgi_pass</span> 127.0.0.1:9000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>如何选择？</strong></p><p>Unix Socket 方式 <strong>比较快</strong> 而且 <strong>消耗资源少</strong>（差距不会太大 0.1% ~ 5% 的差别），但是缺点是只能本机使用，没有 TCP 灵活。</p><p>如果 Nginx 和 FPM 都在同一台服务器上，推荐使用 Unix Socket。如果是做 PHP 服务器集群，使用 Nginx 做负载均衡的话，只能采用 TCP 的链接方式。</p><p><strong>如何设置成 TCP Socket 的连接方式？</strong></p><p>以 PHP-FPM 7.2 为例：</p><p>/etc/php/7.2/fpm/pool.d/<a href="http://www.conf/">www.conf</a></p><pre class="line-numbers language-none"><code class="language-none">listen = 127.0.0.1:9000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>同时配置 Nginx 里的 <code>fastcgi_pass 127.0.0.1:9000;</code> ，并重启 FPM 和 Nginx：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> php7.2-fpm restart<span class="token function">sudo</span> <span class="token function">service</span> nginx restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>如何设置成 Unix Socket 的连接方式？</strong></p><p>修改 FPM 进程池配置：</p><p>/etc/php/7.2/fpm/pool.d/<a href="http://www.conf/">www.conf</a></p><pre class="line-numbers language-none"><code class="language-none">listen = /run/php/php7.2-fpm.sock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>同时配置 Nginx 里的 fastcgi_pass unix:/run/php/php7.2-fpm.sock; ，并重启 FPM 和 Nginx：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> php7.2-fpm restart<span class="token function">sudo</span> <span class="token function">service</span> nginx restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>文件 <code>/var/run/php/php7.2-fpm.sock</code> 会在 FPM 启动时创建。</p><h2 id="生产环境中一定要关闭掉-Xdebug-扩展"><a href="#生产环境中一定要关闭掉-Xdebug-扩展" class="headerlink" title="生产环境中一定要关闭掉 Xdebug 扩展"></a>生产环境中一定要关闭掉 Xdebug 扩展</h2><p>检查生产环境的 PHP 原生扩展文件夹里是否存在，以 PHP 7.2 为例存放路径为：</p><pre class="line-numbers language-none"><code class="language-none">/etc/php/7.2/mods-available/xdebug.ini<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>找到以后确保使用 <code>;</code> 符注释掉：</p><p>/etc/php/7.2/mods-available/xdebug.ini</p><pre class="line-numbers language-none"><code class="language-none">;zend_extension=xdebug.so<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>重启 fpm</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> php7.2-fpm restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>检查 php-fpm 的进程数量</p><pre class="line-numbers language-none"><code class="language-none"># 会多出两个进程数，是因为有一个不负责处理请求的 php-fpm master 进程和一个 grep 进程ps -aux | grep php-fpm | wc -l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="开启-Slow-log-定位慢脚本"><a href="#开启-Slow-log-定位慢脚本" class="headerlink" title="开启 Slow log 定位慢脚本"></a>开启 Slow log 定位慢脚本</h2><h3 id="如何开启？"><a href="#如何开启？" class="headerlink" title="如何开启？"></a>如何开启？</h3><p>PHP-FPM 提供一个叫 <strong>慢日志</strong> (slowlog) 的功能，来帮助我们定位执行慢的脚本。以 PHP 7.2 为例，FPM 的配置信息位于：</p><pre class="line-numbers language-none"><code class="language-none">/etc/php/7.2/fpm/pool.d/www.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>相关配置项：</p><pre class="line-numbers language-none"><code class="language-none">; 慢日志的存储路径，默认 `$pool` 设置为 `www`slowlog = /var/log/$pool.slow.log; 设置慢日志超时标准，设置为 0 代表关闭慢日志request_slowlog_timeout = 1s; 慢日志记录脚本堆栈的深度request_slowlog_trace_depth = 20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上的配置翻译过来：指定 FPM 当发现有请求执行超过 1 秒钟的时候，将整个调用堆栈记录到 <code>/var/log/www.slow.log</code> 文件里，堆栈的深度不超过 20。</p><p>你可以把 1s 改成其他值，如 10s。有了以上的设置，裁剪图像尺寸的方法、 网络 I/O 相关的一些请求都经常出现在 PHP 慢日志中。你可以根据自己的情况来选择调整或者忽略。</p><h3 id="如何分析？"><a href="#如何分析？" class="headerlink" title="如何分析？"></a>如何分析？</h3><p>可以使用 grep 命令来快速定位某个函数调用、或者脚本名称被记录的次数，记录的次数越多，优化的优先级就越高。以下是简单的 示例</p><pre class="line-numbers language-none"><code class="language-none">grep -o 'fetch_github_user' /var/log/www.slow.log | wc -lgrep -o 'sendEmail' /var/log/www.slow.log | wc -l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>需要注意的是，监控 Slowlog 和记录日志的过程会对 PHP 造成消耗， 切记 调试结束后，务必将其关闭。</strong></p><h2 id="开启-OPcache"><a href="#开启-OPcache" class="headerlink" title="开启 OPcache"></a>开启 OPcache</h2><p>OPcache 是由 PHP 官方公司 Zend 开发的一款免费使用的 PHP 优化加速拓展。他可以将 PHP 脚本编译后的 bytecode 缓存在共享内存中供以后反复使用，从而避免了从磁盘读取代码再次编译的消耗。同时，它还应用了一些代码优化模式，使得代码执行更快。从而加速 PHP 应用响应。</p><p>PHP 自 5.5 版开始，就已经内置了 OPcache 扩展。不过默认是关闭状态的。</p><h3 id="开启-OPcache-1"><a href="#开启-OPcache-1" class="headerlink" title="开启 OPcache"></a>开启 OPcache</h3><p>PHP 7.2 FPM 的配置信息位于：</p><pre class="line-numbers language-none"><code class="language-none">/etc/php/7.2/fpm/php.ini<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑以上文件，搜索 <code>opcache.enable</code> 将值设为 <code>1</code> 即为开启</p><pre class="line-numbers language-none"><code class="language-none">opcache.enable=1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>php.ini</code> 里相关的配置以下，注释里包括说明和推荐设置的值，请详细阅读：</p><pre class="line-numbers language-none"><code class="language-none">; 是否在命令行开启，这里默认设置为 0 ，暂且关闭;opcache.enable_cli=0; 这个内存是用来存储编译后的字节码的，视你的程序; 代码量而定，Laravel 应用一般建议设置为 256，单位 MB，; 默认是 128opcache.memory_consumption=256; 会对程序所有的字符串进行统一存储以加快存取速度，; 默认是 8m，建议 32 或者不超过 64。opcache.interned_strings_buffer=32; 最大加速多少个脚本文件，视项目脚本文件数而定，; 合理区间 200~1000000 ，默认是 10000 ，建议 500000opcache.max_accelerated_files=1000000; 最大作废比例百分比，到达这个比例会重启，默认是 5 ，建议 10opcache.max_wasted_percentage=10; 开启情况下会在脚本名称前加上当前目录信息做为缓存的 Key，关闭可以; 提高性能，但是会面临出错的风险（文件名一致时），建议开启，关闭使用 0opcache.use_cwd=1; 开启的话，会按照 opcache.revalidate_freq 设置的频率去检查文件; 是否修改以便重新缓存，默认开启，生产环境下请设置为关闭，然后; 写自动化脚本，在每次更新代码后自动重启 OPcacheopcache.validate_timestamps=0; 文件更新检测频率，单位秒，只有在 opcache.validate_timestamps ; 开启时才有效。默认为 2，意味着 2 秒钟检查一次，会对文件系统造; 成负担，如果是在开发环境中请酌情使用，生产环境随意设置，因为; 我们会设置 validate_timestamps 为关闭。opcache.revalidate_freq=2200; 文件加载的逻辑，默认关闭，无需修改;opcache.revalidate_path=0; 开启的话会把代码注释一起缓存，关闭可减低内存使用，但是; 如果有一些代码依赖于注释里的指令，例如 Doctrine, ; Zend Framework 2 和 PHPUnit，将会出现问题。建议开启opcache.save_comments=1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改完成后，需要重启 FPM 生效：</p><pre class="line-numbers language-none"><code class="language-none">sudo service php7.2-fpm restart <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>生产环境下，我们一般会将 <code>opcache.validate_timestamp</code> 设置为 0 以获取最大性能。然后在代码变更时候，再重置 OPcache。</p><p>有两种重置 OPcache 的方法，一种是重启 FPM。此方法虽然很有效，但是会中断正在处理的请求，用户体验较差，不建议使用。</p><p>另一个方法是调用 <code>opcache_reset()</code> 方法，此方法会重置 OPcache 缓存并且不需要重启 FPM。然而，OPcache 是运行在 FPM 环境中的，在命令行环境中调用此函数无效。必须是一个可以通过 HTTP 访问到的脚本上来调用 <code>opcache_reset()</code> 才行。无法在命令行中执行。</p><h3 id="在-laravel-中使用-OPcache-，可以直接使用-laravel-opcache"><a href="#在-laravel-中使用-OPcache-，可以直接使用-laravel-opcache" class="headerlink" title="在 laravel 中使用 OPcache ，可以直接使用 laravel-opcache"></a>在 laravel 中使用 OPcache ，可以直接使用 <a href="https://github.com/appstract/laravel-opcache">laravel-opcache</a></h3><blockquote><p>OPcache 是对 PHP 脚本的缓存，每次更改任何 PHP 代码时你都需要清除缓存</p></blockquote><pre class="line-numbers language-none"><code class="language-none"># 安装composer require appstract/laravel-opcache# 清空 fpm 里的 OPcachephp artisan opcache:clear# 查看 OPcache 的配置信息php artisan opcache:config# 查看 OPcache 运行状态（内存使用、缓存了多少文件等）php artisan opcache:status# 提前编译文件php artisan opcache:compile {--force}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> PHP-FPM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>composer 使用</title>
      <link href="posts/9b3c7295.html"/>
      <url>posts/9b3c7295.html</url>
      
        <content type="html"><![CDATA[<h1 id="composer-使用"><a href="#composer-使用" class="headerlink" title="composer 使用"></a>composer 使用</h1><h2 id="语义化版本"><a href="#语义化版本" class="headerlink" title="语义化版本"></a><a href="http://semver.org/">语义化版本</a></h2><h3 id="版本号的组成"><a href="#版本号的组成" class="headerlink" title="版本号的组成"></a>版本号的组成</h3><p>major.minor.patch =&gt; 主版本号.次版本号.修订号</p><ul><li>major：通常会发生 api 变更，不向后兼容</li><li>minor：新增功能，但是向后兼容</li><li>patch：补丁，向后兼容，修复 bug</li></ul><h3 id="版本符号"><a href="#版本符号" class="headerlink" title="版本符号"></a>版本符号</h3><ul><li><code>~</code>：指定向后兼容的最小版本<ul><li><code>~1.2</code> 等于 &gt;=1.2 &amp;&amp; &lt;2.0.0</li><li><code>~1.2.3</code> 等于 &gt;=1.2.3 &amp;&amp; &lt;1.3.0</li></ul></li><li><code>^</code>：允许大版本前的所有版本<ul><li><code>^1.2</code> 等于 &gt;=1.2 &amp;&amp; &lt;2.0.0</li><li><code>^1.2.3</code> 等于 &gt;=1.2.3 &amp;&amp; &lt;2.0 （区别在这里）</li></ul></li></ul><h3 id="使用版本号"><a href="#使用版本号" class="headerlink" title="使用版本号"></a>使用版本号</h3><ul><li>确切版本：1.0.2</li><li>范围：&gt;=1.0、&gt;=1.0 &lt;2.0、&gt;=1.0 &lt;1.1 || &gt;=1.2</li><li>连字符范围：1.0 - 2.0</li><li>通配符：1.0.*</li><li>波浪运算符：~1.2.3</li><li>^运算符：^1.2.3</li></ul><blockquote><p><a href="https://packagist.org/">packagist 包管理官方网站</a></p></blockquote><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="linux-下安装-composer"><a href="#linux-下安装-composer" class="headerlink" title="linux 下安装 composer"></a>linux 下安装 composer</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接从阿里云镜像中下载 composer.phar</span><span class="token function">wget</span> https://mirrors.aliyun.com/composer/composer.phar<span class="token comment"># 或者直接从官网下载 composer.phar 二进制执行文件</span><span class="token function">wget</span> https://getcomposer.org/download/2.0.11/composer.phar<span class="token comment"># 或者使用 composer 中国镜像安装器安装</span><span class="token function">curl</span> <span class="token parameter variable">-sS</span> http://install.phpcomposer.com/installer <span class="token operator">|</span> <span class="token function">sudo</span> php -- --install-dir<span class="token operator">=</span>/usr/local/bin <span class="token parameter variable">--filename</span><span class="token operator">=</span>composer<span class="token comment"># 添加执行权限</span><span class="token function">chmod</span> u+x composer.phar<span class="token comment"># 将 composer.phar 移动到系统环境变量中，以方便在任意位置都可以直接执行 composer 命令</span><span class="token function">mv</span> composer.phar /usr/local/bin/composer<span class="token comment"># 如果没有 /usr/local/bin 目录，则需要自己创建</span><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/bin<span class="token comment"># 如果你只想为你的用户安装 composer 并避免需要 root 权限，那么你可以直接执行以下命令，前提是你得有 ~/local/bin 目录</span><span class="token function">mv</span> composer.phar ~/local/bin<span class="token comment"># 添加阿里云镜像加速</span><span class="token function">composer</span> config <span class="token parameter variable">-g</span> repo.packagist <span class="token function">composer</span> https://mirrors.aliyun.com/composer<span class="token comment"># 或者添加中国镜像</span><span class="token function">composer</span> config <span class="token parameter variable">-g</span> repo.packagist <span class="token function">composer</span> https://packagist.phpcomposer.com<span class="token comment"># 解除镜像</span><span class="token function">composer</span> config <span class="token parameter variable">-g</span> <span class="token parameter variable">--unset</span> repos.packagist<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="windows-下安装-composer"><a href="#windows-下安装-composer" class="headerlink" title="windows 下安装 composer"></a>windows 下安装 composer</h3><pre class="line-numbers language-none"><code class="language-none"># 在 D 盘中新建一个 composer 目录# 直接从官网下载 composer.phar 二进制执行文件wget https://getcomposer.org/download/2.0.11/composer.phar# 使用 php.exe 执行 composer.phar 测试是否正常I:\xampp\php\php.exe composer.phar -V# 简化命令echo @I:\xampp\php\php.exe "d:\composer\composer.phar" %*&gt;composer.bat# 将 D:/composer 目录添加到环境变量中去# 查看 composer 版本号，确定是否已经安装成功composer -V （大写的 V）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="composer-json-和-composer-lock"><a href="#composer-json-和-composer-lock" class="headerlink" title="composer.json 和 composer.lock"></a>composer.json 和 composer.lock</h3><p>当项目中存在 composer.lock 文件时，使用 <code>composer install</code> 命令安装依赖时，<code>composer.lock</code> 都会解析并安装你在 <code>composer.json</code> 中所列出来的依赖，但是 <code>composer</code> 会严格使用 <code>composer.lock</code> 文件所列出来的版本以确保项目中得所有成员所安装的版本都是一致的。<strong>需要将 composer.lock</strong> 文件提交到代码管理中。</p><h3 id="自动加载"><a href="#自动加载" class="headerlink" title="自动加载"></a>自动加载</h3><p>执行 <code>composer install</code> 命令时，会生成 <code>vendor/autoload.php</code>  文件，只需 include 这个文件就可以使用这些包所提供的类</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">require</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vendor/autoload.php'</span><span class="token punctuation">;</span><span class="token variable">$log</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Monolog<span class="token punctuation">\</span>Logger</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$log</span><span class="token operator">-&gt;</span><span class="token function">pushHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Monolog<span class="token punctuation">\</span>Handler<span class="token punctuation">\</span>StreamHandler</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'app.log'</span><span class="token punctuation">,</span> <span class="token class-name class-name-fully-qualified static-context">Monolog<span class="token punctuation">\</span>Logger</span><span class="token operator">::</span><span class="token constant">WARNING</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$log</span><span class="token operator">-&gt;</span><span class="token function">addWarning</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你也可以直接在 <code>composer.json</code> 文件中添加一个 <code>autoload</code> 指令来添加自己的自动加载声明</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token punctuation">{</span>    <span class="token string double-quoted-string">"autoload"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token string double-quoted-string">"psr-4"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string double-quoted-string">"Acme\\"</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">"src/"</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>composer 会为 Acme 命名空间注册一个 <code>PSR-4</code> 的自动加载。<br>你定义一个命名空间指向目录的映射。 在 vendor 目录同级的 src 目录将成为你项目的根目录。一个案例，文件名 src/Foo.php 需包含 Acme\Foo 类。<br>添加 <code>autoload</code> 指令之后，你必需重新运行 <code>composer dump-autoload</code>来重新生成 vendor/autoload.php 文件。</p><h3 id="composer-命令的使用"><a href="#composer-命令的使用" class="headerlink" title="composer 命令的使用"></a><a href="https://learnku.com/docs/composer/2018/03-cli/2084">composer 命令的使用</a></h3><ul><li>查看 composer 全局配置</li></ul><pre class="line-numbers language-none"><code class="language-none">composer config -l -g<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>初始化 composer.json</li></ul><pre class="line-numbers language-none"><code class="language-none"># 创建扩展包时，初始化 composer.jsoncomposer init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>安装所有扩展包</li></ul><pre class="line-numbers language-none"><code class="language-none"># 会读取当前目录的 composer.json 文件，解决依赖关系，并将他们安装到 vendor 文件夹中composer install# 制定 composer 略过 require-dev 选项里的扩展包，只加载需要的扩展包composer install --no-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装指定的扩展包</li></ul><pre class="line-numbers language-none"><code class="language-none">composer require &lt;package-name&gt;# 比如安装 vendor/package:2.* 扩展包composer require vendor/package:2.*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>更新扩展包（更新命令执行完毕后，同时也会更新 composer.lock 文件，不要乱用 composer update ，如果需要更新包，建议直接使用 composer require 命令）</li></ul><pre class="line-numbers language-none"><code class="language-none"># 更新所有的依赖包composer update# 更新指定的包composer update &lt;package-name&gt;# 比如更新 vendor/package 包composer update vendor/package# 一次性更新多个包composer update example/example1 example/example2# 更新指定包到指定版本composer require example/example3:1.2.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>移除扩展包</li></ul><pre class="line-numbers language-none"><code class="language-none">composer remove &lt;package-name&gt;# 比如移除 vendor/package:2.*  扩展包composer remove vendor/package:2.* <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>搜索扩展包</li></ul><pre class="line-numbers language-none"><code class="language-none">composer search &lt;package-name&gt;# 比如搜索 monolog 扩展包composer search monolog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>列出所有的可用的包</li></ul><pre class="line-numbers language-none"><code class="language-none"># 查看所有的包信息composer show# 查看包详细信息composer show &lt;package-name&gt;# 比如查看 monolog/monolog 包详细信息composer show monolog/monolog 1.0.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>验证 composer.json 文件是否合法</li></ul><pre class="line-numbers language-none"><code class="language-none">composer validate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>更新 composer</li></ul><pre class="line-numbers language-none"><code class="language-none"># 更新 composer 到最新版本composer self-update# 更新 composer 到指定版本composer self-update 1.0.0# 回滚到上一个安装版本composer self-update -r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Composer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 常用命令</title>
      <link href="posts/5fddf106.html"/>
      <url>posts/5fddf106.html</url>
      
        <content type="html"><![CDATA[<h1 id="Git-命令"><a href="#Git-命令" class="headerlink" title="Git 命令"></a>Git 命令</h1><h2 id="生成-SSH-Key"><a href="#生成-SSH-Key" class="headerlink" title="生成 SSH Key"></a>生成 SSH Key</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">ssh-keygen -t rsa -C <span class="token string">"youremail@xxx.com"</span><span class="token comment"># 输入之后直接两次回车即可</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="查看-git-用户名和邮箱地址"><a href="#查看-git-用户名和邮箱地址" class="headerlink" title="查看 git 用户名和邮箱地址"></a>查看 git 用户名和邮箱地址</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 查看用户名</span>git config user.name<span class="token comment"># 查看邮箱地址</span>git config user.email<span class="token comment"># 查看配置信息</span>git config --list<span class="token comment"># 当前用户全局</span>git config --global<span class="token comment"># 当前系统全局</span>git config --system<span class="token comment"># 修改用户名</span>git config --global user.name <span class="token string">"username"</span><span class="token comment"># 修改邮箱地址</span>git config --global user.email <span class="token string">"email"</span><span class="token comment"># 重新输入账号密码</span>git config --system --unset credential.helper<span class="token comment"># 查看 git 配置信息</span>git config --list 或者 git config -l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="初始化一个-git-仓库"><a href="#初始化一个-git-仓库" class="headerlink" title="初始化一个 git 仓库"></a>初始化一个 git 仓库</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="添加文件到-git-仓库"><a href="#添加文件到-git-仓库" class="headerlink" title="添加文件到 git 仓库"></a>添加文件到 git 仓库</h2><h3 id="1-添加文件到缓存区"><a href="#1-添加文件到缓存区" class="headerlink" title="1. 添加文件到缓存区"></a>1. 添加文件到缓存区</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git">git add &lt;filename&gt;<span class="token comment"># 比如添加 file.txt 文件： git add file.txt</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="2-将缓存区文件提交到本地仓库"><a href="#2-将缓存区文件提交到本地仓库" class="headerlink" title="2. 将缓存区文件提交到本地仓库"></a>2. 将缓存区文件提交到本地仓库</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git">git commit -m <span class="token string">"add_file_message"</span><span class="token comment"># 比如提交 file.txt 文件：git commit -m "add file.txt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="查看修改内容对比，提交到缓存区或者已经提交到本地仓库，使用-git-diff-会没有内容显示，也就是说只要修改了，在提交到缓存区之前使用-git-diff-才有用-（查看工作区的改变）"><a href="#查看修改内容对比，提交到缓存区或者已经提交到本地仓库，使用-git-diff-会没有内容显示，也就是说只要修改了，在提交到缓存区之前使用-git-diff-才有用-（查看工作区的改变）" class="headerlink" title="查看修改内容对比，提交到缓存区或者已经提交到本地仓库，使用 git diff 会没有内容显示，也就是说只要修改了，在提交到缓存区之前使用 git diff 才有用 （查看工作区的改变）"></a>查看修改内容对比，提交到缓存区或者已经提交到本地仓库，使用 git diff 会没有内容显示，也就是说只要修改了，在提交到缓存区之前使用 git diff 才有用 （查看工作区的改变）</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git diff<span class="token comment"># 还可以查看具体哪个文件做了什么修改</span><span class="token comment"># 比如查看 readme.txt 做了什么修改</span>git diff HEAD -- readme.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看当前仓库状态，任何时候都可以使用"><a href="#查看当前仓库状态，任何时候都可以使用" class="headerlink" title="查看当前仓库状态，任何时候都可以使用"></a>查看当前仓库状态，任何时候都可以使用</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="查看提交日志"><a href="#查看提交日志" class="headerlink" title="查看提交日志"></a>查看提交日志</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 查看全部 </span>git log<span class="token comment"># 查看最后一次提交</span>git show<span class="token comment"># 查看倒数5条</span>git log -5<span class="token comment"># 简化日志显示方式，并含有提交版本号</span>git log --pretty=oneline<span class="token comment"># 比如：</span><span class="token comment"># $ git log --pretty=oneline</span><span class="token comment"># 44c9beb4c58543b89181829755be2c5e9781ba28 (HEAD -&gt; master) append GPL</span><span class="token comment"># 03112bdf101655c30df9b61e4bd325b2cbe3c090 add distributed</span><span class="token comment"># 8a1386bd0fe677bca99d5a4ef26e87772a3eca71 wrote a readme file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="设置别名-Alias"><a href="#设置别名-Alias" class="headerlink" title="设置别名 Alias"></a>设置别名 Alias</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 创建/查看本地分支</span>git config --global alias.br <span class="token string">"branch"</span><span class="token comment"># 切换分支</span>git config --global alias.co <span class="token string">"checkout"</span><span class="token comment"># 创建并切换到新分支</span>git config --global alias.cb <span class="token string">"checkout -b"</span><span class="token comment"># 提交</span>git config --global alias.cm <span class="token string">"commit -m"</span><span class="token comment"># 查看状态</span>git config --global alias.st <span class="token string">"status"</span><span class="token comment"># 拉取分支</span>git config --global alias.pullm <span class="token string">"pull origin master"</span><span class="token comment"># 提交分支</span>git config --global alias.pushm <span class="token string">"push origin master"</span><span class="token comment"># 单行、分颜色显示记录</span>git config --global alias.log <span class="token string">"log --oneline --graph --decorate --color=always"</span><span class="token comment"># 复杂显示</span>git config --global alias.logg <span class="token string">"log --graph --all --format=format:'%C(bold blue)%h%C(reset) - %C(bold green)(%ar)%C(reset) %C(white)%s%C(reset) %C(bold white)— %an%C(reset)%C(bold yellow)%d%C(reset)' --abbrev-commit --date=relative"</span>git config --global alias.lg <span class="token string">"log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="回退版本"><a href="#回退版本" class="headerlink" title="回退版本"></a>回退版本</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 回退当前版本的上一个版本</span>git reset --hard HEAD^<span class="token comment"># 回退当前版本的上三个版本</span>git reset --hard HEAD^^^<span class="token comment"># 回退当前版本的上 100 个版本</span>git reset --hard HEAD~100<span class="token comment"># 回退指定版本，并将 「回退」动作作为一个版本提交</span>git revert &lt;commit id&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="回退指定版本（多半是因为回退版本回退多了）"><a href="#回退指定版本（多半是因为回退版本回退多了）" class="headerlink" title="回退指定版本（多半是因为回退版本回退多了）"></a>回退指定版本（多半是因为回退版本回退多了）</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git reset --hard 版本号前几位<span class="token comment"># 比如回退到 以上查看日志中的 add distributed 这个提交版本</span>git reset --hard 44c9beb4c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看提交版本号-commit-id"><a href="#查看提交版本号-commit-id" class="headerlink" title="查看提交版本号 commit id"></a>查看提交版本号 commit id</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 要重返未来，用 `git reflog` 查看命令历史，以便确定要回到未来的哪个版本。</span>git reflog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="撤销修改"><a href="#撤销修改" class="headerlink" title="撤销修改"></a>撤销修改</h2><h3 id="1-修改只在工作区，还没有添加到缓存区-（还没有-git-add）"><a href="#1-修改只在工作区，还没有添加到缓存区-（还没有-git-add）" class="headerlink" title="1. 修改只在工作区，还没有添加到缓存区 （还没有 git add）"></a>1. 修改只在工作区，还没有添加到缓存区 （还没有 git add）</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git">git checkout -- filename<span class="token comment"># 比如 readme.txt 文件只是在工作区修改了，想回退到修改之前的提交的版本</span>git checkout -- readme.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-修改从工作区已经提交到了缓存区-（已经-git-add）"><a href="#2-修改从工作区已经提交到了缓存区-（已经-git-add）" class="headerlink" title="2. 修改从工作区已经提交到了缓存区 （已经 git add）"></a>2. 修改从工作区已经提交到了缓存区 （已经 git add）</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 将缓存区的修改回退到工作区</span>git reset HEAD filename<span class="token comment"># 比如 readme.txt 文件的修改已经提交到缓存区了，但是想撤销修改分为两步</span><span class="token comment"># 01.将缓存区的修改回退到工作区</span>git reset HEAD readme.txt<span class="token comment"># 02.将在工作区的修改回退到和上一个版本一样</span>git checkout -- readme.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-修改已经从缓存区提交到了本地仓库-（已经-git-commit）"><a href="#3-修改已经从缓存区提交到了本地仓库-（已经-git-commit）" class="headerlink" title="3. 修改已经从缓存区提交到了本地仓库 （已经 git commit）"></a>3. 修改已经从缓存区提交到了本地仓库 （已经 git commit）</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 回退当前版本的上一个版本</span>git reset --hard HEAD^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="4-将在暂存区的更改文件进行强制撤销。（想让之前已经提交到缓存区的文件覆盖工作区的文件）"><a href="#4-将在暂存区的更改文件进行强制撤销。（想让之前已经提交到缓存区的文件覆盖工作区的文件）" class="headerlink" title="4. 将在暂存区的更改文件进行强制撤销。（想让之前已经提交到缓存区的文件覆盖工作区的文件）"></a>4. 将在暂存区的更改文件进行强制撤销。（想让之前已经提交到缓存区的文件覆盖工作区的文件）</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git">git checkout -f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="5-命令-git-clean-作用是清理项目，-f-是强制清理文件的设置，-d-选项命令连文件夹一并清除"><a href="#5-命令-git-clean-作用是清理项目，-f-是强制清理文件的设置，-d-选项命令连文件夹一并清除" class="headerlink" title="5. 命令 git clean 作用是清理项目，-f 是强制清理文件的设置，-d 选项命令连文件夹一并清除"></a>5. 命令 git clean 作用是清理项目，-f 是强制清理文件的设置，-d 选项命令连文件夹一并清除</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git">git clean -f -d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="6-假如你想要丢弃你所有的本地改动与提交，可以到服务器上获取最新的版本并将你本地主分支指向到它："><a href="#6-假如你想要丢弃你所有的本地改动与提交，可以到服务器上获取最新的版本并将你本地主分支指向到它：" class="headerlink" title="6. 假如你想要丢弃你所有的本地改动与提交，可以到服务器上获取最新的版本并将你本地主分支指向到它："></a>6. 假如你想要丢弃你所有的本地改动与提交，可以到服务器上获取最新的版本并将你本地主分支指向到它：</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git">git fetch origin git reset --hard origin/master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h2><h3 id="1-确实要删除该文件"><a href="#1-确实要删除该文件" class="headerlink" title="1. 确实要删除该文件"></a>1. 确实要删除该文件</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 比如以 test.txt 为例子</span><span class="token comment"># 01 本地手动删除 test.txt 文件</span>rm test.txt 或者 rm -rf test.txt<span class="token comment"># 02 添加被删除的状态缓存区</span>git rm test.txt 或者 git add test.txt<span class="token comment"># 03 提交状态到本地仓库</span>git commit -m <span class="token string">"remove test.txt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-工作区误删了文件"><a href="#2-工作区误删了文件" class="headerlink" title="2. 工作区误删了文件"></a>2. 工作区误删了文件</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 01 工作区误删了 test.txt 文件</span>rm test.txt<span class="token comment"># 02 找回被误删的文件（撤销修改）</span>git checkout -- test.txt<span class="token comment"># 用版本库中的版本替换掉工作区的版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="创建分支并切换到该分支"><a href="#创建分支并切换到该分支" class="headerlink" title="创建分支并切换到该分支"></a>创建分支并切换到该分支</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git checkout -b alex  或者 git switch -c alex<span class="token comment"># 创建 alex 分支并切换到 alex 分支</span><span class="token comment"># 等同于以下两个命令</span><span class="token comment"># 创建 alex 分支</span>git branch alex<span class="token comment"># 切换到 alex 分支</span>git checkout alex  或者 git switch alex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="合并指定分支到当前分支"><a href="#合并指定分支到当前分支" class="headerlink" title="合并指定分支到当前分支"></a>合并指定分支到当前分支</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 比如当前位于 master 分支，欲将 alex 分支合并到 master 分支</span>git merge alex<span class="token comment"># 如果有冲突，解决步骤如下：</span><span class="token comment"># 01 先查看冲突文件</span>git status<span class="token comment"># 02 手动解决冲突文件</span><span class="token comment"># 03 再次合并分支</span>git merge alex<span class="token comment"># 04 添加修改到缓存区</span>git add .<span class="token comment"># 05 提交到本地仓库</span>git commit -m <span class="token string">"merge fixed"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看分支的合并情况"><a href="#查看分支的合并情况" class="headerlink" title="查看分支的合并情况"></a>查看分支的合并情况</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git log --graph --pretty=oneline --abbrev-commit或者直接使用 git log --graph 命令可以看到分支合并图。<span class="token comment"># 设置别名查看所有的提交记录</span>git config --global alias.lg <span class="token string">"log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 合并代码之后删除分支 </span>git branch -d 分支名<span class="token comment"># 没有合并代码删除分支 </span>git branch -D 分支名<span class="token comment"># 删除远程分支（本地分支需要再次手动删除）</span>git push origin -d 分支名<span class="token comment"># 比如删除 alex 分支</span>git branch -d alex<span class="token comment"># 删除远程 alex 分支</span>git push origin -d alex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看分支"><a href="#查看分支" class="headerlink" title="查看分支"></a>查看分支</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 只查看远程分支</span>git branch -r<span class="token comment"># 只查看本地分支</span>git branch<span class="token comment"># 查看所有远程分支和本地分支</span>git branch -a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="拉取远程分支并创建同名本地分支"><a href="#拉取远程分支并创建同名本地分支" class="headerlink" title="拉取远程分支并创建同名本地分支"></a>拉取远程分支并创建同名本地分支</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 方法一（此方法建立的本地分支和远程分支会有映射关系）</span>git checkout -b [本地分支名] origin/[远程分支名]举例：git checkout -b alex origin/alex<span class="token comment"># 方法二（此方法建立的本地分支和远程分支没有映射关系）</span>git fetch origin [远程分支名]:[本地分支名]举例：git fetch origin alex:alex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看本地分支和远程分支的映射关系（远程有的分支而本地没有的分支不会出现）"><a href="#查看本地分支和远程分支的映射关系（远程有的分支而本地没有的分支不会出现）" class="headerlink" title="查看本地分支和远程分支的映射关系（远程有的分支而本地没有的分支不会出现）"></a>查看本地分支和远程分支的映射关系（远程有的分支而本地没有的分支不会出现）</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git branch -vv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="手动建立本地分支和远程分支的映射关系"><a href="#手动建立本地分支和远程分支的映射关系" class="headerlink" title="手动建立本地分支和远程分支的映射关系"></a>手动建立本地分支和远程分支的映射关系</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git branch -u origin/[分支名]或者git branch --set-upstream-to origin/[分支名]或者git branch --set-upstream-to=origin/[远程分支名] [本地分支名]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="推送分支"><a href="#推送分支" class="headerlink" title="推送分支"></a>推送分支</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git push -u origin &lt;branch name&gt; <span class="token comment"># 第一次推送的时候添加 -u 参数，给本地分支和远程分支创建连接关系，当第二次再次推送时，则不需要添加 -u 参数</span><span class="token comment"># 比如：推送 dev 分支</span>git push origin dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="查看远程库的信息"><a href="#查看远程库的信息" class="headerlink" title="查看远程库的信息"></a>查看远程库的信息</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git remote<span class="token comment"># 查看远程库更加详细的信息</span><span class="token comment"># 这里可以看到抓取和推送的 origin 的地址</span>git remote -v （小写的v）<span class="token comment"># 删除远程库连接</span>git remote rm &lt;origin name&gt;<span class="token comment"># eg：删除远程 origin 连接</span>git remote rm origin<span class="token comment"># 添加远程库连接</span>git remote add &lt;origin name&gt; &lt;ssh or http&gt;<span class="token comment"># eg: 关联本人 GitHub 连接，并连接名为 myGitHub</span>git remote add myGitHub git@github.com:Alex66668888/demo.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="多处备份"><a href="#多处备份" class="headerlink" title="多处备份"></a>多处备份</h2><h3 id="一个-pull-多个-push"><a href="#一个-pull-多个-push" class="headerlink" title="一个 pull + 多个 push"></a>一个 pull + 多个 push</h3><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 添加远程连接</span><span class="token command">$ git remote add origin git@gitee.com:pudongping/tt.git</span><span class="token comment"># 查看远程连接地址，可以看到只有一个 fetch 地址和一个 push 地址</span><span class="token command">$ git remote<span class="token parameter"> -v</span></span>origin  git@gitee.com:pudongping/tt.git (fetch)origin  git@gitee.com:pudongping/tt.git (push)<span class="token comment"># 添加 github 推送地址</span><span class="token command">$ git remote set-url<span class="token parameter"> --add</span> origin git@github.com:pudongping/tt.git</span><span class="token comment"># 查看远程连接地址，可以看到只有一个 fetch 地址和两个 push 地址</span><span class="token command">$ git remote<span class="token parameter"> -v</span></span>origin  git@gitee.com:pudongping/tt.git (fetch)origin  git@gitee.com:pudongping/tt.git (push)origin  git@github.com:pudongping/tt.git (push)<span class="token comment"># 添加 gitlab 推送地址</span><span class="token command">$ git remote set-url<span class="token parameter"> --add</span> origin git@gitlab.com:pudongping/t1.git</span><span class="token comment"># 查看远程连接地址，可以看到只有一个 fetch 地址和三个 push 地址</span><span class="token command">$ git remote<span class="token parameter"> -v</span></span>origin  git@gitee.com:pudongping/tt.git (fetch)origin  git@gitee.com:pudongping/tt.git (push)origin  git@github.com:pudongping/t1.git (push)origin  git@gitlab.com:pudongping/tt.git (push)<span class="token comment"># 推送到远程分支，就可以看到已经同步到多个平台上去了，一次 push 到多个远程仓库</span>git push<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="git-add-三种状态命令比较"><a href="#git-add-三种状态命令比较" class="headerlink" title="git add 三种状态命令比较"></a>git add 三种状态命令比较</h2><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>git add .</td><td>提交所有修改的和新建的数据暂存区 (提交当前文件夹下所有修改)</td></tr><tr><td>git add -u</td><td>提交所有被删除和修改的文件到数据暂存区（等同于git add -update）</td></tr><tr><td>git add -A</td><td>提交所有被删除、被替换、被修改和新增的文件到数据暂存区（等同于git add –all）</td></tr></tbody></table><h2 id="已经推送（push）过的文件，想从-git-远程库中删除，并在以后的提交中忽略，但是却还想在本地保留这个文件"><a href="#已经推送（push）过的文件，想从-git-远程库中删除，并在以后的提交中忽略，但是却还想在本地保留这个文件" class="headerlink" title="已经推送（push）过的文件，想从 git 远程库中删除，并在以后的提交中忽略，但是却还想在本地保留这个文件"></a>已经推送（push）过的文件，想从 git 远程库中删除，并在以后的提交中忽略，但是却还想在本地保留这个文件</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git">git rm --cached [file-path]git rm --cached config/pay.php<span class="token comment"># 如果是目录的话，则需要</span>git rm -r --cached [dir_name]git push<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="已经推送（push）过的文件，想在以后的提交时忽略此文件，即使本地已经修改过，而且不删除-git-远程库中相应的文件"><a href="#已经推送（push）过的文件，想在以后的提交时忽略此文件，即使本地已经修改过，而且不删除-git-远程库中相应的文件" class="headerlink" title="已经推送（push）过的文件，想在以后的提交时忽略此文件，即使本地已经修改过，而且不删除 git 远程库中相应的文件"></a>已经推送（push）过的文件，想在以后的提交时忽略此文件，即使本地已经修改过，而且不删除 git 远程库中相应的文件</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 只对文件有效</span>git update-index --assume-unchanged [file-path]git update-index --assume-unchanged config/pay.php<span class="token comment"># 如果需要恢复提交</span>git update-index --no-assume-unchanged [file-path]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="合并一个分支上的修改到当前分支"><a href="#合并一个分支上的修改到当前分支" class="headerlink" title="合并一个分支上的修改到当前分支"></a>合并一个分支上的修改到当前分支</h2><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 比如说 test1 分支上有一个提交 512d725 现在想将这个提交合并到 test2 分支上</span><span class="token comment"># 先切换到 test2 分支上</span>git checkout test2<span class="token comment"># 择优挑选（此时还是在 test2 分支上）</span>git cherry-pick 512d725 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 半小时入门 &lt;第二章&gt;</title>
      <link href="posts/13c0012.html"/>
      <url>posts/13c0012.html</url>
      
        <content type="html"><![CDATA[<h1 id="Git-半小时入门"><a href="#Git-半小时入门" class="headerlink" title="Git 半小时入门 <第二章>"></a>Git 半小时入门 &lt;第二章&gt;</h1><h2 id="使用-Git"><a href="#使用-Git" class="headerlink" title="使用 Git"></a>使用 Git</h2><ol><li>新项目如何使用 git ？</li><li>已有项目如何使用 git 管理代码？</li><li>如何回退版本？</li><li>如何撤销修改？</li><li>分支管理</li><li>多人协作</li><li>忽略文件的写法</li></ol><h3 id="新项目如何使用Git"><a href="#新项目如何使用Git" class="headerlink" title="新项目如何使用Git"></a>新项目如何使用Git</h3><ol><li>创建 gitdemo 目录（创建版本库）</li></ol>  <pre class="line-numbers language-git" data-language="git"><code class="language-git">mkdir gitdemo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>切换到版本库中，并初始化 git （初始化的意思是将当前目录交给 git 管理）</li></ol>  <pre class="line-numbers language-git" data-language="git"><code class="language-git">cd gitdemo &amp;&amp; git init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f250d2a5e2802918.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="可以看到当前文件夹出现 .git 目录"></p><ol start="3"><li>写入测试文件  <pre class="line-numbers language-git" data-language="git"><code class="language-git">echo 123 &gt; demo.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>查看当前 git 仓库状态 （此时的状态为 「未提交」）</li></ol>  <pre class="line-numbers language-git" data-language="git"><code class="language-git">git status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-525075aa4e3a14fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="此时的状态为没有将文件添加到 git 中"></p><ol start="5"><li>提交当前 『当前修改』到暂存区</li></ol><ul><li>提交单个文件<pre class="line-numbers language-git" data-language="git"><code class="language-git">git add demo.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>提交多个文件 <pre class="line-numbers language-git" data-language="git"><code class="language-git">git add demo.txt other.txt text.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>提交所有修改   <pre class="line-numbers language-git" data-language="git"><code class="language-git">git add -A # 提交所有修改<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><ol start="6"><li>提交到仓库中（将暂存区中的内容同步到本地仓库中） <pre class="line-numbers language-git" data-language="git"><code class="language-git">git commit -m “&lt;description current commit&gt;”<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a2a7007346846470.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ol start="7"><li>创建远程库（这里使用全球最大的 git 仓库 GitHub 作为示范）</li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a3d1feac668ed82a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ad92163aeb466d05.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8103d08391732d57.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="至此，在 GitHub 上面创建远程仓库已经完毕。"></p><ol start="8"><li>本地仓库和远程仓库创建关联关系  <pre class="line-numbers language-git" data-language="git"><code class="language-git">git remote add origin git@github.com:&lt;Your name&gt;/demogit.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>将本地仓库中的代码推送到远程仓库中  <pre class="line-numbers language-git" data-language="git"><code class="language-git">git push -u origin master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>从远程仓库中拉取代码到本地仓库中  <pre class="line-numbers language-git" data-language="git"><code class="language-git">git fetch origin master &amp;&amp; git pull <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>也可以直接使用 git pull</li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a9df74b0b3da3cc7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ol start="11"><li>生成 SSH Key。</li></ol><p>我们知道 GitHub 远程库支持 HTTPS 和 SSH 两种方式通讯，如果你就想采用 HTTPS 的话，那么请忽略这一步，但是如果采用 HTTPS 通讯，每次提交的时候就需要输入一次账号和密码，也挺烦的。接下来讲解，如何采用 SSH 协议通讯。</p><p>生成 SSH Key 密钥对</p>  <pre class="line-numbers language-git" data-language="git"><code class="language-git">ssh-keygen -t rsa -C <span class="token string">"youremail@example.com"</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果一切顺利的话，可以在用户主目录里找到 .ssh 目录，里面有 id_rsa 和 id_rsa.pub 两个文件，这两个就是 SSH Key 的秘钥对，id_rsa 是私钥，不能泄露出去，id_rsa.pub 是公钥，可以放心地告诉任何人。<br>将生成的 id_rsa.pub 公钥内容添加到 GitHub 中</p><p>生成 SSH 密钥对</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-11d85bb5fe6494d1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>查看生成的密钥对，生成的路径在 「用户家目录/.ssh」</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7e60b43f07906de8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8d9715611944f0a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-17283add08b5bad4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a79d366fc59768a4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>将公钥添加到 GitHub 中，至此我们再次去推送一次本地代码到远程库，即可看见可以推送成功了！</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1d6bd88c7c40f6b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><h3 id="新项目如何使用-Git-（总结）"><a href="#新项目如何使用-Git-（总结）" class="headerlink" title="新项目如何使用 Git （总结）"></a>新项目如何使用 Git （总结）</h3><p>一个新项目如何使用 git 来管理，并创建远程仓库？</p><ol><li>使用 GitHub、gitee、coding 创建好远程仓库</li><li>如果采用 ssh 协议通讯的话，那么需要先在本地生成 ssh key 密钥对，并且将公钥添加到远程库账号 ssh 相关设置中，如果采用 https 协议通讯的话，则跳过此步骤。<br><code>ssh-keygen -t rsa -C "youremail@example.com" </code></li><li>将代码通过远程库来管理<br>可以直接将远程仓库克隆到本地，此种方法最为简单。<br><code>git clone git@github.com:&lt;Your GitHub account name&gt;/demogit.git</code><br>可以先在本地创建一个仓库之后，再将本地仓库和远程仓库创建关联关系，稍许复杂。</li></ol><ul><li><p>创建项目目录并 git 初始化项目</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">mkdir -p ~/demogit &amp;&amp; cd ~/demogit &amp;&amp; git init <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>创建远程连接</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git remote add origin git@github.com:&lt;Your GitHub account name&gt;/demogit.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>查看远程连接是否创建成功</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git remote -vv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><ol start="4"><li>创建测试文件并提交代码到本地仓库  <pre class="line-numbers language-git" data-language="git"><code class="language-git">cd ~/demogit &amp;&amp; echo 123 &gt; demo.txt &amp;&amp; git add -A &amp;&amp; git commit -m “commit for test” <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>将本地代码推送到远程库  <pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 第一次推送的时候需要加上 「-u」参数，后续推送的时候，可以不用加</span>git push -u origin master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><h3 id="已有项目如何使用git管理代码？"><a href="#已有项目如何使用git管理代码？" class="headerlink" title="已有项目如何使用git管理代码？"></a>已有项目如何使用git管理代码？</h3><ol><li>先创建远程仓库，然后将远程空仓库拉到本地，之后将已有的项目全部复制到空本地仓库中</li><li>本地直接在项目中 git 初始化项目，然后创建远程连接，之后将本地代码全部添加到 「暂存区」，再提交到本地仓库中，之后再推送。</li></ol><h3 id="如何回退版本？"><a href="#如何回退版本？" class="headerlink" title="如何回退版本？"></a>如何回退版本？</h3><ol><li>reset （直接回退版本）<pre class="line-numbers language-git" data-language="git"><code class="language-git">git reset --hard HEAD^  # 回退到上一个版本git reset --hard HEAD^^^  # 回退到上三个版本git reset --hard HEAD~100  # 回退到上 100 个版本git reset --hard &lt;commit id&gt; # 回退到指定版本<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>revert （将回退过程当成一个版本提交）<pre class="line-numbers language-git" data-language="git"><code class="language-git">git revert &lt;commit id&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p>如何查看提交版本号？<br>  </p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git log -2  # 查看倒数 2 条提交记录，提交记录中含有版本号git reflog  # 查看所有的提交版本号，如果要重返未来，用git reflog查看命令历史，以便确定要回到未来的哪个版本。git log --pretty=oneline<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p></p><h3 id="如何撤销修改？"><a href="#如何撤销修改？" class="headerlink" title="如何撤销修改？"></a>如何撤销修改？</h3><p>因为 git 主要有三种状态，因此就有三种可能性，工作区、暂存区、版本库</p><ol><li><p>当修改只在工作区，还没有 git add 时： （一定要注意有 「–」）</p>  <pre class="line-numbers language-git" data-language="git"><code class="language-git">git checkout -- &lt;filename&gt;  比如： git checkout -- example.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>当修改在暂存区时，已经 git add：</p>  <pre class="line-numbers language-git" data-language="git"><code class="language-git">2.1. git reset HEAD &lt;filename&gt;  比如：git reset HEAD example.txt2.2. git checkout -- &lt;filename&gt;  比如：git checkout -- example.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>当修改已经从暂存区提交到了本地仓库，已经 git commit：</p>  <pre class="line-numbers language-git" data-language="git"><code class="language-git">git reset --hard HEAD^<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h3 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h3><h4 id="什么是分支？"><a href="#什么是分支？" class="headerlink" title="什么是分支？"></a>什么是分支？</h4><p>分支是用来将特性开发绝缘开来的。在你创建仓库的时候，master 是“默认的”。在其他分支上进行开发，完成后再将它们合并到主分支上。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1ebabe114f060966.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="你正在学习git，同时异步空间的你又在学习svn，最后合并，二者你都会了"></p><ul><li><p>创建一个叫做 「feature_x」 分支，并切换到 「feature_x」 分支</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git checkout -b feature_x  或者 git switch -c feature_x <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>创建分支</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git branch feature_x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>从当前分支切换到新的分支</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git checkout feature_x  或者 git switch feature_x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>查看分支</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git branch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>删除分支</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 将新建的分支删除（已经合并后）</span>git branch -d feature_x<span class="token comment"># （未合并，强删）</span>git branch -D feature_x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>合并某分支到当前分支</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git merge &lt;branch name&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>除非将分支推送到远程仓库，不然该分支其他人不可见</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git push origin &lt;branch&gt;  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>查看分支合并图</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git log --graph <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7a1ec719f624521e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><h3 id="多人协作"><a href="#多人协作" class="headerlink" title="多人协作"></a>多人协作</h3><ol><li>首先，可以试图用 <strong>git push origin <branch-name></branch-name></strong> 推送自己的修改；</li><li>如果推送失败，则因为远程分支比你的本地更新，需要先用 <strong>git pull</strong> 试图合并；</li><li>如果合并有冲突，则解决冲突，并在本地提交；</li><li>没有冲突或者解决掉冲突后，再用 <strong>git push origin <branch-name></branch-name></strong> 推送就能成功！</li></ol><p>如果 git pull 提示 no tracking information，则说明本地分支和远程分支的链接关系没有创建，用命令 **git branch –set-upstream-to <branch-name> origin/<branch-name>**。<br>直接从远程仓库拉取指定分支，并在本地创建和远程同名分支</branch-name></branch-name></p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git branch --set-upstream branch-name origin/branch-name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="忽略文件的写法-（-gitignore）"><a href="#忽略文件的写法-（-gitignore）" class="headerlink" title="忽略文件的写法 （.gitignore）"></a>忽略文件的写法 （.gitignore）</h3><ol><li>忽略文件的作用<br>忽略不想提交的文件</li><li>忽略文件的写法<br>直接在 .gitignore 文件中写 test.txt  # 表示忽略和 .gitignore 平级的 test.txt 文件<br>直接写 upload/  # 表示忽略和 .gitignore 平级的 upload 下所有的文件等同于 upload/*<br>直接写 upload/*.txt  # 表示忽略和 .gitignore 平级的 upload 文件夹下所有的以 .txt 命名的文件<br>直接写 *.py[cod] hu’lue # 表示忽略和 .gitignore 平级的 所有文件名是 .pyc 或 .pyo 或 .pyd 的文件<br>忽略所有 .txt 的文件，但是除了 a.txt 的文件的写法 *.txt !a.txt</li><li>如果某个文件已经在忽略文件中忽略，但是又想要提交该文件<br>git  add -f <file name="">  # 强制提交 force.txt 文件 =&gt; git add -f force.txt</file></li><li>检查某个文件是否被忽略文件所忽略<br>git check-ignore -v <file name=""> # 查看 force.txt 是否被忽略 =&gt;  git check-ignore -v force.txt</file></li></ol>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 半小时入门 &lt;第一章&gt;</title>
      <link href="posts/89044c18.html"/>
      <url>posts/89044c18.html</url>
      
        <content type="html"><![CDATA[<h1 id="Git-半小时入门"><a href="#Git-半小时入门" class="headerlink" title="Git 半小时入门 <第一章>"></a>Git 半小时入门 &lt;第一章&gt;</h1><h2 id="邂逅-Git"><a href="#邂逅-Git" class="headerlink" title="邂逅 Git"></a>邂逅 Git</h2><ol><li>git 是什么？<br>Git 是目前世界上最先进的分布式版本控制系统（没有之一）。</li><li>git 可以干什么？<br>对文件进行版本控制。</li><li>git 的优点？<br>高端大气上档次！（速度最快，操作简单）</li><li>git 和 CVS、SVN 这些版本控制系统有什么区别？<br>最大的一个区别在于 CVS、SVN ……这些版本控制系统是 「集中式」的版本控制系统，而 Git 是 「分布式」的版本控制系统。</li><li>git 起源原因<br>很多人都知道，Linus 在 1991 年创建了开源的 Linux 系统，起初 Linus 通过手工合并代码，但随后随着代码量越来越大，Linus 无法再通过手工合并代码，因此采用了商业的版本控制系统 BitKeeper，起初 BitKeeper 的东家免费将该版本控制系统提供给 Linux 社区使用，但开发 Samba 的 Andrew 试图破解 BitKeeper 的协议，这下把 BitKeeper 的东家给惹怒了，要收回 Linux 社区的免费使用权，结果 Linus 花了两周时间自己用 C 写了一个分布式版本控制系统，这就是 Git！随后在 2008年，GitHub 网站上线了，它为开源项目免费提供 Git 存储，无数开源项目开始迁移至 GitHub，包括 jQuery，PHP，Ruby 等等。</li></ol><h3 id="集中式和分布式的区别"><a href="#集中式和分布式的区别" class="headerlink" title="集中式和分布式的区别"></a>集中式和分布式的区别</h3><p><strong>集中式版本控制系统</strong>，版本库是集中存放在中央服务器的，<br>而干活的时候，用的都是自己的电脑，所以要先从中央服务器<br>取得最新的版本，然后开始干活，干完活了，再把自己的活<br>推送给中央服务器。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-2aa9d28c6ff90e8f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="集中式版本控制系统"></p><blockquote><p>最大的毛病就是必须联网才能工作，并且如果中央服务器出现了问题，那么所有人都没法干活儿了</p></blockquote><p><strong>分布式版本控制系统</strong>根本没有“中央服务器”，每个人的电脑上都是一个完整的版本库，这样，你工作的时候，就不需要联网了，因为版本库就在你自己的电脑上。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8265e227f4d5f25b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="分布式版本控制系统"></p><h2 id="安装-Git"><a href="#安装-Git" class="headerlink" title="安装 Git"></a>安装 Git</h2><ol><li>在 Linux 上安装 Git<br>Debian 或 Ubuntu 系列： sudo apt-get install git 或者 sudo apt-get install git-core（因为以前有个软件也叫 GIT（GNU Interactive Tools），结果 Git 就只能叫 git-core 了。由于 Git 名气实在太大，后来就把 GNU Interactive Tools 改成 gnuit，git-core 正式改为 git。）</li></ol><ul><li>Redhat 或 CentOS 系列：yum install git</li><li>Mac OS X 上安装 git有两种方法<ul><li>一是安装homebrew，然后通过homebrew安装Git，具体方法请参考homebrew的文档：<a href="http://brew.sh/">http://brew.sh/</a></li><li>二是直接从AppStore安装Xcode，Xcode集成了Git，不过默认没有安装，你需要运行Xcode，选择菜单“Xcode”-&gt;“Preferences”，在弹出窗口中找到“Downloads”，选择“Command Line Tools”，点“Install”就可以完成安装了。</li></ul></li></ul><ol start="2"><li>在 Windows 上安装 git<br>直接在 git 官网 <a href="https://git-scm.com/downloads">https://git-scm.com/downloads</a> 上面下载 .exe 软件，然后一直点击下一步即可。</li></ol><h3 id="以下讲解在-Windows-系统下安装"><a href="#以下讲解在-Windows-系统下安装" class="headerlink" title="以下讲解在 Windows 系统下安装"></a>以下讲解在 Windows 系统下安装</h3><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-abc8c279ef435fc6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="官网下载 Git "></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-76eb47be74fdfd67.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="一直点击“Next”即可安装"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7e64397183b9823b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="鼠标右键或者任务栏中出现 “Git Bash”则表示安装成功"></p><h4 id="配置-GIT"><a href="#配置-GIT" class="headerlink" title="配置 GIT"></a>配置 GIT</h4><blockquote><p>因为 Git 是分布式版本控制系统，所以，每个机器都必须自报家门：你的名字和 Email 地址。</p></blockquote><ul><li><p>配置用户名</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">git config --global user.name <span class="token string">"&lt;Your Name&gt;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-2cab46c99eac9e15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配置用户名"></p><ul><li>配置 Email 地址</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git">git config --global user.email <span class="token string">"&lt;email@example.com&gt;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-912cdc2fb3e06ec5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配置 Email 地址"></p><h3 id="使用版本控制系统须知"><a href="#使用版本控制系统须知" class="headerlink" title="使用版本控制系统须知"></a>使用版本控制系统须知</h3><p><strong>所有的版本控制系统，其实只能跟踪文本文件的改动，</strong> 比如 TXT 文件，网页，所有的程序代码等等，Git 也不例外。<br>版本控制系统可以告诉你每次的改动，比如在第 5 行加了一个单词“Linux”，在第 8 行删了一个单词“Windows”。<br>而 <strong>图片、视频这些二进制文件，虽然也能由版本控制系统管理，但没法跟踪文件的变化，</strong> 只能把二进制文件每次改动串起来，<br>也就是只知道图片从 100KB 改成了 120KB，但到底改了啥，版本控制系统不知道，也没法知道。</p><p>不幸的是，Microsoft 的 Word 格式是二进制格式，因此， <strong>版本控制系统是没法跟踪 Word 文件的改动的，</strong> 如果要真正使用版本控制系统，<br>就要以纯文本方式编写文件。</p><p>因为文本是有编码的，比如中文有常用的 GBK 编码，日文有 Shift_JIS 编码，如果没有历史遗留问题，强烈建议使用标准的 UTF-8 编码，<br>所有语言使用同一种编码，既没有冲突，又被所有平台所支持。</p><p>使用 Windows 的童鞋要特别注意：</p><p><strong>千万不要使用 Windows 自带的记事本编辑任何文本文件。</strong> 原因是 Microsoft 开发记事本的团队使用了一个非常弱智的行为来保存 UTF-8 编码的文件，<br>他们自作聪明地在每个文件开头添加了 0xefbbbf（十六进制）的字符，你会遇到很多不可思议的问题，比如，网页第一行可能会显示一个“?”，<br>明明正确的程序一编译就报语法错误，等等，都是由记事本的弱智行为带来的。建议你下载 Notepad++ 代替记事本，不但功能强大，而且免费！<br>记得把 Notepad++ 的默认编码设置为 UTF-8 without BOM 即可：</p><h3 id="Git-工作流"><a href="#Git-工作流" class="headerlink" title="Git 工作流"></a>Git 工作流</h3><p>你的本地仓库由 git 维护的三棵“树”组成。<br>第一个是你的 工作目录，它持有实际文件；<br>第二个是 缓存区（Index），它像个缓存区域，临时保存你的改动；<br>最后是 HEAD，指向你最近一次提交后的结果。并且 git 为我们自动创建的<br>第一个分支 master，以及指向 master 的一个指针叫 HEAD。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8fb97ab7eaf4a408.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Git工作流"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-963c15ac783353df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Git工作流"></p>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何使用 php 写一个类似于 laravel 框架的服务容器？</title>
      <link href="posts/de7d71ca.html"/>
      <url>posts/de7d71ca.html</url>
      
        <content type="html"><![CDATA[<h1 id="如何使用-php-写一个类似于-laravel-框架的服务容器？"><a href="#如何使用-php-写一个类似于-laravel-框架的服务容器？" class="headerlink" title="如何使用 php 写一个类似于 laravel 框架的服务容器？"></a>如何使用 php 写一个类似于 laravel 框架的服务容器？</h1><blockquote><p>这篇文章可能文字不会太多，毕竟说再多都还不如直接看代码来的实在 😀，以下我会把核心的代码都先贴出来，里面都有比较完善的注释信息，可以对着看。另外如果自己测试的话，可以直接下载我的源码，关于如何测试，源码中都有示例代码。</p></blockquote><ul><li><a href="https://gitee.com/pudongping/php-base-container#/pudongping/php-base-container">Gitee 地址</a></li><li><a href="https://github.com/pudongping/php-base-container">GitHub 地址</a></li></ul><h2 id="以下是实现容器的核心代码"><a href="#以下是实现容器的核心代码" class="headerlink" title="以下是实现容器的核心代码"></a>以下是实现容器的核心代码</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 实现一个简单的 php 容器 * * Created by PhpStorm * User: Alex * Date: 2021-08-03 17:51 * E-mail: &lt;276558492@qq.com&gt; */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Container</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 当前全局可用的容器(如果有)     *     * @var static     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 容器的绑定     *     * @var array[]     */</span>    <span class="token keyword">private</span> <span class="token variable">$bindings</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 容器的共享实例     *     * @var object[]     */</span>    <span class="token keyword">private</span> <span class="token variable">$instances</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">instances</span><span class="token punctuation">[</span><span class="token class-name static-context">Container</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$instance</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$instance</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">self</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$instance</span><span class="token operator">-&gt;</span><span class="token property">instances</span><span class="token punctuation">[</span><span class="token class-name static-context">Container</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$instance</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$instance</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 在容器中注册共享绑定     *     * @param $abstract     * @param $concrete     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">singleton</span><span class="token punctuation">(</span><span class="token variable">$abstract</span><span class="token punctuation">,</span> <span class="token variable">$concrete</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token variable">$abstract</span><span class="token punctuation">,</span> <span class="token variable">$concrete</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 向容器注册绑定     *     * @param $abstract     * @param $concrete     * @param false $shared     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">bind</span><span class="token punctuation">(</span><span class="token variable">$abstract</span><span class="token punctuation">,</span> <span class="token variable">$concrete</span><span class="token punctuation">,</span> <span class="token variable">$shared</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$concrete</span> <span class="token keyword">instanceof</span> <span class="token class-name">Closure</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bindings</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'concrete'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'shared'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$concrete</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span> <span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token variable">$concrete</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidArgumentException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Argument 2 must be callback or class.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bindings</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'concrete'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'shared'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 将现有实例注册为容器中的共享实例     *     * @param string $abstract     * @param mixed $instance     * @return mixed     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">instance</span><span class="token punctuation">(</span><span class="token variable">$abstract</span><span class="token punctuation">,</span> <span class="token variable">$instance</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">instances</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 从容器解析给定类型     *     * @param string $abstract  目标类的名称     * @param array $parameters  实例化目标类时所需要的参数（非对象类型约束参数数组）     * @return mixed|object     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$abstract</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$parameters</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">instances</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bindings</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token variable">$abstract</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidArgumentException</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Target class [<span class="token interpolation"><span class="token variable">$abstract</span></span>] does not exist."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">instances</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">instances</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bindings</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$concrete</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bindings</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'concrete'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_callable</span><span class="token punctuation">(</span><span class="token variable">$concrete</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token variable">$instance</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resolveCallable</span><span class="token punctuation">(</span><span class="token variable">$concrete</span><span class="token punctuation">,</span> <span class="token variable">$parameters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token variable">$instance</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token variable">$concrete</span><span class="token punctuation">,</span> <span class="token variable">$parameters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token variable">$instance</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token variable">$abstract</span><span class="token punctuation">,</span> <span class="token variable">$parameters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bindings</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bindings</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'shared'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">instances</span><span class="token punctuation">[</span><span class="token variable">$abstract</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$exception</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$exception</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$exception</span><span class="token operator">-&gt;</span><span class="token function">getTraceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 解决回调函数时的依赖     *     * @param callable $callbackName  目标回调函数     * @param array $realArgs     * @return mixed     * @throws ReflectionException     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">resolveCallable</span><span class="token punctuation">(</span><span class="token keyword type-hint">callable</span> <span class="token variable">$callbackName</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$realArgs</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$reflector</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionFunction</span><span class="token punctuation">(</span><span class="token variable">$callbackName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 获取回调函数的参数列表</span>        <span class="token variable">$parameters</span> <span class="token operator">=</span> <span class="token variable">$reflector</span><span class="token operator">-&gt;</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$parameters</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$list</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resolveDependencies</span><span class="token punctuation">(</span><span class="token variable">$parameters</span><span class="token punctuation">,</span> <span class="token variable">$realArgs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 调用函数参数</span>        <span class="token keyword">return</span> <span class="token variable">$reflector</span><span class="token operator">-&gt;</span><span class="token function">invokeArgs</span><span class="token punctuation">(</span><span class="token variable">$list</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 解决对象时的依赖     *     * @param string|object $className  目标类的名称     * @param array $realArgs     * @return object  目标类对应的实例对象     * @throws ReflectionException     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">resolveClass</span><span class="token punctuation">(</span><span class="token variable">$className</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$realArgs</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment">// 对目标类进行反射（解析其方法、属性）</span>            <span class="token variable">$reflector</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionClass</span><span class="token punctuation">(</span><span class="token variable">$className</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReflectionException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Target class [<span class="token interpolation"><span class="token variable">$className</span></span>] does not exist."</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$reflector</span><span class="token operator">-&gt;</span><span class="token function">isInstantiable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 检查类是否可以实例化</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Target class [<span class="token interpolation"><span class="token variable">$className</span></span>] is not instantiable."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 获取目标类的构造函数，当类不存在构造函数时返回 null</span>        <span class="token variable">$constructor</span> <span class="token operator">=</span> <span class="token variable">$reflector</span><span class="token operator">-&gt;</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 没有构造函数，则直接实例化</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// return new $className;  // 或者也可以直接这样去实例化，因为目标类没有构造函数，不需要传参数</span>            <span class="token keyword">return</span> <span class="token variable">$reflector</span><span class="token operator">-&gt;</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 获取构造函数的参数列表</span>        <span class="token variable">$parameters</span> <span class="token operator">=</span> <span class="token variable">$constructor</span><span class="token operator">-&gt;</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 递归解析构造函数的参数</span>        <span class="token variable">$list</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resolveDependencies</span><span class="token punctuation">(</span><span class="token variable">$parameters</span><span class="token punctuation">,</span> <span class="token variable">$realArgs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从给出的参数创建一个新的类实例</span>        <span class="token keyword">return</span> <span class="token variable">$reflector</span><span class="token operator">-&gt;</span><span class="token function">newInstanceArgs</span><span class="token punctuation">(</span><span class="token variable">$list</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 递归解析依赖树     *     * @param array $dependencies  目标类的构造函数参数列表     * @param array $parameters  实例化目标类时的其他参数（非类型提示参数）     * @return array  实例化目标类时构造函数所需的所有参数     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">resolveDependencies</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$dependencies</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$parameters</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 用于存储所有的参数</span>        <span class="token variable">$results</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$dependencies</span> <span class="token keyword">as</span> <span class="token variable">$dependency</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 获取类型提示类</span>            <span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token variable">$dependency</span><span class="token operator">-&gt;</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 如果类为 null，则表示依赖项是字符串或其他类型</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$parameterName</span> <span class="token operator">=</span> <span class="token variable">$dependency</span><span class="token operator">-&gt;</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取参数的名称</span>                <span class="token comment">// 检查参数是否有默认值</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$dependency</span><span class="token operator">-&gt;</span><span class="token function">isDefaultValueAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$parameters</span><span class="token punctuation">[</span><span class="token variable">$parameterName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token variable">$parameterName</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' has no value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token variable">$results</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$parameters</span><span class="token punctuation">[</span><span class="token variable">$parameterName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// 参数有默认值的时候</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$parameters</span><span class="token punctuation">[</span><span class="token variable">$parameterName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token variable">$results</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$parameters</span><span class="token punctuation">[</span><span class="token variable">$parameterName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token variable">$results</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$dependency</span><span class="token operator">-&gt;</span><span class="token function">getDefaultValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取参数的默认值</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// 类型提示确定是一个类时，则需要递归处理依赖项</span>                <span class="token variable">$objName</span> <span class="token operator">=</span> <span class="token variable">$obj</span><span class="token operator">-&gt;</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取依赖项的类名</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token variable">$objName</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Unable to load class: '</span> <span class="token operator">.</span> <span class="token variable">$objName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token variable">$results</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token variable">$objName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$results</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Laravel </tag>
            
            <tag> 服务容器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git Tag 标签</title>
      <link href="posts/68649176.html"/>
      <url>posts/68649176.html</url>
      
        <content type="html"><![CDATA[<h1 id="Git-Tag-标签"><a href="#Git-Tag-标签" class="headerlink" title="Git Tag 标签"></a>Git Tag 标签</h1><p>标签总是和某个 commit 挂钩。如果这个 commit 既出现在 master 分支，又出现在 dev 分支，那么在这两个分支上都可以看到这个标签。</p><ul><li>创建标签</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 给当前提交版本打标签</span>git tag &lt;tag name&gt;<span class="token comment"># eg: 打一个名称为 v1.0 的标签，此时默认将标签打到最新提交的 commit 上</span>git tag v1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>给指定提交版本打标签</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 查看历史提交的 commit id</span>git log --pretty=oneline --abbrev-commit<span class="token comment"># 给指定提交版本打标签</span>git tag &lt;tag name&gt; &lt;commit id&gt;<span class="token comment"># eg: 给提交版本号为 c53b867 的版本，打一个名称为 v0.8 的标签</span>git tag v0.8 c53b867<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建带有说明的标签，用 <code>-a</code> 指定标签名，<code>-m</code> 指定说明文字：</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git">git tag -a &lt;tag name&gt; -m &lt;tag description&gt; &lt;commit id&gt;<span class="token comment"># eg：给版本号为 c53b867 的版本，打一个名称为 v0.8 的标签，并对 v0.8 这个标签添加说明文字为 "add v0.8 tag"</span>git tag -a v0.8 -m <span class="token string">"add v0.8 tag"</span> c53b867<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看所有的标签 （标签不是按时间顺序列出，而是按字母排序的。）</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git">git tag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>查看标签信息</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git">git show &lt;tag name&gt;<span class="token comment"># eg：查看标签名得 v0.9 的标签信息</span>git show v0.9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>删除标签</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git">git tag -d &lt;tag name&gt;<span class="token comment"># eg：删除标签名为 v0.1 的标签</span>git tag -d v0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>推送本地标签到远程库</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git">git push origin &lt;tag name&gt;<span class="token comment"># eg： 推送本地标签名为 v0.1 的标签到远程库中</span>git push origin v0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>一次性推送全部尚未推送到远程的本地标签</li></ul><pre class="line-numbers language-git" data-language="git"><code class="language-git">git push origin --tags<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>如果标签已经推送到远程，想要删除远程标签</li></ul><pre class="line-numbers language-none"><code class="language-none"># 第一步：删除本地标签git tag -d v0.1# 第二步：从远程删除git push origin :refs/tags/v0.1# 第三步：在远程库中查看是否被删除<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows 下搭建 git 服务器 gogs</title>
      <link href="posts/a90b1e44.html"/>
      <url>posts/a90b1e44.html</url>
      
        <content type="html"><![CDATA[<h1 id="本文基于-windows7-64位-搭建-gogs"><a href="#本文基于-windows7-64位-搭建-gogs" class="headerlink" title="本文基于 windows7 64位 搭建 gogs"></a>本文基于 windows7 64位 搭建 gogs</h1><blockquote><p>gogs 官方文档地址：<a href="https://gogs.io/docs">https://gogs.io/docs</a><br>软件下载地址：<a href="https://dl.gogs.io/">https://dl.gogs.io/</a></p></blockquote><h1 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h1><ul><li>数据库（选择以下一项）：<ul><li><a href="http://dev.mysql.com/">MySQL</a>：版本 &gt;= 5.7</li><li><a href="http://www.postgresql.org/">PostgreSQL</a></li><li><a href="https://en.wikipedia.org/wiki/Microsoft_SQL_Server">MSSQL</a></li><li><a href="https://github.com/pingcap/tidb">TiDB</a>（实验性支持，使用 MySQL 协议连接）</li><li>或者&nbsp;<strong>什么都不安装</strong>&nbsp;直接使用 SQLite3</li></ul></li><li><a href="http://git-scm.com/">git</a>（bash）：<ul><li>服务端和客户端均需版本 &gt;= 1.7.1</li><li>Windows 系统建议使用最新版</li></ul></li><li>SSH 服务器：<ul><li><strong>如果您只使用 HTTP/HTTPS 的话请忽略此项</strong></li><li>如果您选择在 Windows 系统使用内置 SSH 服务器，请确保添加&nbsp;<code>ssh-keygen</code>&nbsp;到您的&nbsp;<code>%PATH%</code>&nbsp;环境变量中</li><li>推荐 Windows 系统使用&nbsp;<a href="http://docs.oracle.com/cd/E24628_01/install.121/e22624/preinstall_req_cygwin_ssh.htm">Cygwin OpenSSH</a>&nbsp;或&nbsp;<a href="https://www.itefix.net/copssh">Copssh</a></li><li>Windows 系统 请确保 Bash 是默认的 Shell 程序，而不是 PowerShell</li></ul></li></ul><h1 id="所需软件"><a href="#所需软件" class="headerlink" title="所需软件"></a>所需软件</h1><ul><li>必须软件<ul><li><a href="http://nssm.cc/download">NSSM</a></li><li><a href="https://git-scm.com/downloads">git</a>  最好下载最新版</li><li><a href="https://dev.mysql.com/downloads/mysql/">MySQL</a> 官方说的是版本需要大于5.7，我的版本是 5.5.3 发现也并无影响。<strong>但是存储引擎一定要使用：INNODB！</strong><br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ef2d29505d1077d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="此时的版本为5.5.3"></li><li><a href="https://dl.gogs.io/0.10.1/windows_amd64.zip">gogs软件包</a> windows-64位版本</li></ul></li></ul><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ol><li>将下载的 gogs_0.11.86_windows_amd64.zip 压缩包文件解压。<blockquote><p>本文解压在 E:\soft-exe 目录下</p></blockquote></li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-90a40366e1de646b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="解压出来是 gogs 文件夹"></p><ol start="2"><li>创建数据库<blockquote><p>可以直接去执行 E:\soft-exe\gogs\scripts\mysql.sql 文件，创建 gogs 数据库。（当然也可以自己去创建数据库名为 gogs 的数据库，但是建议还是直接执行 mysql.sql 脚本，毕竟官方建议）</p></blockquote></li></ol><p>mysql.sql 中的内容为以下：</p><pre class="line-numbers language-none"><code class="language-none">SET GLOBAL innodb_file_per_table = ON,           innodb_file_format = Barracuda,           innodb_large_prefix = ON;DROP DATABASE IF EXISTS gogs;CREATE DATABASE IF NOT EXISTS gogs CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>安装 git<br>这个貌似没有什么太多需要讲的，直接根据上面提供的链接地址下载 git 最新版，之后一直下一步安装即可。</li><li>注册 gogs 服务</li></ol><ul><li>修改 E:\soft-exe\gogs\scripts\windows\install-as-service.bat ,将其中的<pre class="line-numbers language-none"><code class="language-none">SET gogspath=C:/gogs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>修改成你本地的 gogs 安装路径。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8b353dd27ef518c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="找到 install-as-service.bat 文件"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-9a7e1d01a357ff69.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="修改 gogspath 的值为 gogs.exe 所在文件路径"></p><ul><li>解压缩 nssm 压缩包。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-85a99004000632e8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=" 以上为解压缩 nssm 之后的状态"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-eefbd6e6aee7c319.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="将 nssm.exe 文件所在文件绝对路径加入到系统环境变量中"></p><ul><li>以管理员权限运行  install-as-service.bat</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0ba62def3fe97198.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="对着 install-as-service.bat 文件鼠标右击，以管理员权限执行"></p><blockquote><p>同样也可以使用手动执行命令去执行 install-as-service.bat 文件<br>手动执行命令的方法为：在 install-as-service.bat 文件所在文件夹下，随便点击一下空白处，然后按住 shift键，点击鼠标右键，点击 <strong>在此处打开命令窗口</strong> 输入 gogs web 命令，回车即可。</p></blockquote><ol start="5"><li>测试<br>浏览器访问：127.0.0.1:3000 即可进入配置页面（我只修改了代码仓库存放路径这一项）。（在此页面并不一定非要注册用户，我测试的时候，虽然注册了一个用户，但是最后发现还是需要再重新注册）完成配置后，E:\soft-exe\gogs\custom\conf 目录下会生成一个新的 app.ini 配置文件。</li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-585db4ac286d6008.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="E:\soft-exe\gogs\custom\conf 路径下生成了 app.ini 配置文件"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-02ed41e662d49c21.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="打开 app.ini 配置文件，发现里面的内容为在浏览器中输入的内容"></p><ol start="6"><li>注册用户（系统默认第一个用户为系统管理员）<br>再次访问 127.0.0.1:3000 ，点击注册。</li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d80ab87d33fc9f1b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="我本地测试的电脑未安装 .net 框架，因此样式乱掉了"></p><ol start="7"><li>创建测试仓库</li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-387e54229c30b0c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
            <tag> Gogs </tag>
            
            <tag> Git 服务器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS 7 搭建 gogs Git 服务器</title>
      <link href="posts/7aeb56a9.html"/>
      <url>posts/7aeb56a9.html</url>
      
        <content type="html"><![CDATA[<h1 id="CentOS-7-搭建-gogs-Git-服务器"><a href="#CentOS-7-搭建-gogs-Git-服务器" class="headerlink" title="CentOS 7 搭建 gogs Git 服务器"></a>CentOS 7 搭建 gogs Git 服务器</h1><h2 id="本地环境如下："><a href="#本地环境如下：" class="headerlink" title="本地环境如下："></a>本地环境如下：</h2><blockquote><p>Linux 系统环境为：CentOS Linux release 7.4.1708 (Core)<br>MySQL 版本为： mysql  Ver 14.14 Distrib 5.7.23, for Linux (x86_64) using  EditLine wrapper<br>Git 版本为： git version 1.8.3.1<br>Gogs 当前最新版本为：0.11.86</p></blockquote><h2 id="所需软件"><a href="#所需软件" class="headerlink" title="所需软件"></a>所需软件</h2><ul><li><a href="https://gogs.io/docs">Gogs</a></li><li>Git</li><li>MySQL</li></ul><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><ol><li><p>创建用户名为 git 的账户，用于管理 git</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> adduser <span class="token function">git</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>切换到 git 用户，并在其账户所在家目录，下载 Gogs</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换到 git 用户</span><span class="token function">su</span> <span class="token function">git</span>  <span class="token comment"># 切换到 git 用户所在家目录</span><span class="token builtin class-name">cd</span> ~  <span class="token comment"># 下载 gogs 压缩包</span><span class="token function">wget</span> https://dl.gogs.io/0.11.86/gogs_0.11.86_linux_amd64.tar.gz<span class="token comment"># 解压缩 （解压缩之后的文件夹名为 gogs ）</span><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> gogs_0.11.86_linux_amd64.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>执行 gogs 数据库文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换到 /home/git/gogs/scripts 目录</span><span class="token builtin class-name">cd</span> /home/git/gogs/scripts<span class="token comment"># 登录数据库 （这里采用 MySQL ）</span>mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span><span class="token comment"># 创建 gogs 用户</span>create user <span class="token string">'gogs'</span>@<span class="token string">'localhost'</span> identified by <span class="token string">'密码'</span><span class="token punctuation">;</span><span class="token comment"># 赋予 gogs 数据库用户能够访问 gogs 数据库所有权限</span>grant all privileges on gogs.* to <span class="token string">'gogs'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span><span class="token comment"># 刷新权限</span>flush privileges<span class="token punctuation">;</span><span class="token comment"># 执行 gogs 数据库脚本文件 </span><span class="token builtin class-name">source</span> mysql.sql<span class="token comment"># 测试（执行完了之后可以看到已经创建好了 gogs 数据库）</span>show databases<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>配置与运行</p></li></ol><ul><li>打开 gogs 文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /home/git/gogs/scripts/init/centos/gogs   <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>核对文件信息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">19</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/sbin:/usr/sbin:/bin:/usr/bin  <span class="token number">20</span> <span class="token assign-left variable">DESC</span><span class="token operator">=</span><span class="token string">"Gogs"</span>  <span class="token number">21</span> <span class="token assign-left variable">NAME</span><span class="token operator">=</span>gogs  <span class="token number">22</span> <span class="token assign-left variable">SERVICEVERBOSE</span><span class="token operator">=</span>yes  <span class="token number">23</span> <span class="token assign-left variable">PIDFILE</span><span class="token operator">=</span>/var/run/<span class="token variable">$NAME</span>.pid  <span class="token number">24</span> <span class="token assign-left variable">SCRIPTNAME</span><span class="token operator">=</span>/etc/init.d/<span class="token variable">$NAME</span>  <span class="token number">25</span> <span class="token assign-left variable">WORKINGDIR</span><span class="token operator">=</span>/home/git/gogs      <span class="token comment"># 仓库地址，可以自行修改</span><span class="token number">26</span> <span class="token assign-left variable">DAEMON</span><span class="token operator">=</span><span class="token variable">$WORKINGDIR</span>/<span class="token variable">$NAME</span>  <span class="token number">27</span> <span class="token assign-left variable">DAEMON_ARGS</span><span class="token operator">=</span><span class="token string">"web"</span>  <span class="token number">28</span> <span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span>git     <span class="token comment"># 如果运行 gogs 不是名为 git 的账户，则需要修改。 </span><span class="token comment"># 如是用 root 账户运行 gogs，则这里修改成 root</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>切换到 root 账户，然后复制到 /etc/init.d/ 目录下</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换到 root 账户</span><span class="token function">su</span> root<span class="token comment"># 将 gogs 文件复制到 /etc/init.d 目录下</span><span class="token function">sudo</span> <span class="token function">cp</span> /home/git/gogs/scripts/init/centos/gogs /etc/init.d/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>增加执行权限</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> +x /etc/init.d/gogs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>复制 service</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> /home/git/gogs/scripts/systemd/gogs.service /etc/systemd/system/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>开启 gogs 服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> gogs start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>运行 gogs web</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换到 gogs 目录</span><span class="token builtin class-name">cd</span> /home/git/gogs<span class="token comment"># 运行 gogs web （如果此时 Ctrl + C 关闭掉命令，此时刷新浏览器时，会无内容）</span><span class="token comment"># 执行命令后，看到有日志输出，则证明启动成功！</span>./gogs web<span class="token comment"># 后台运行 gogs</span>./gogs web <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>必须开启 3000 端口 （我使用的是阿里云的 ECS ，直接在阿里云后台添加 3000 的安全组规则即可）</p></li><li><p>测试。（ 浏览器访问 http://远程主机 IP 地址 :3000 ）</p></li></ul><ol start="5"><li>配置反向代理</li></ol><ul><li>在 nginx 配置文件夹中，新建 git.drling.xin.conf 文件</li></ul><pre class="line-numbers language-none"><code class="language-none">vim /etc/nginx/conf.d/git.drling.xin.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>填入以下内容</li></ul><pre class="line-numbers language-none"><code class="language-none">server {    listen 80;    server_name git.drling.xin;    location / {            proxy_pass http://127.0.0.1:3000/;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>关于自定义配置</li></ol><ul><li>第一次访问 <strong>http://远程主机 IP 地址 :3000</strong> 的时候，会提示你填入一些自定义项，这些自定义项会在你 <code>&lt;gogs path&gt;/custom/conf/app.ini</code> 文件中，只有你在网页中填入自定义项之后才会有此文件。你也可以先在你 <code>gogs</code> 目录下创建 <code>custom/conf/app.ini</code> 文件，然后填入自定义项，如下所示：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">APP_NAME <span class="token operator">=</span> Semir-git<span class="token comment"># 这里的用户名在 Linux 系统中必须存在，且这里的用户名为 ssh 仓库地址的用户名</span>RUN_USER <span class="token operator">=</span> <span class="token function">git</span>RUN_MODE <span class="token operator">=</span> prod<span class="token comment"># 代码仓库地址</span><span class="token punctuation">[</span>repository<span class="token punctuation">]</span>ROOT      <span class="token operator">=</span> /extend-disk/partition2/git-repositories<span class="token comment"># if you use nginx to proxy, suggest you set 127.0.0.1, otherwise you set 0.0.0.0 is ok</span>HTTP_ADDR <span class="token operator">=</span> <span class="token number">127.0</span>.0.1<span class="token punctuation">[</span>database<span class="token punctuation">]</span>DB_TYPE  <span class="token operator">=</span> mysqlHOST     <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:3306NAME     <span class="token operator">=</span> gogs<span class="token environment constant">USER</span>     <span class="token operator">=</span> gogsPASSWD   <span class="token operator">=</span> <span class="token number">123456</span>SSL_MODE <span class="token operator">=</span> disable<span class="token environment constant">PATH</span>     <span class="token operator">=</span> data/gogs.db<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token comment"># 仓库域名如：git.drling.xin</span>DOMAIN           <span class="token operator">=</span> <span class="token number">10.90</span>.60.6HTTP_PORT        <span class="token operator">=</span> <span class="token number">3000</span><span class="token comment"># 仓库 url 如：http://git.drling.xin/</span>ROOT_URL         <span class="token operator">=</span> http://10.90.60.6:3000/DISABLE_SSH      <span class="token operator">=</span> <span class="token boolean">false</span>SSH_PORT         <span class="token operator">=</span> <span class="token number">22</span>START_SSH_SERVER <span class="token operator">=</span> <span class="token boolean">false</span>OFFLINE_MODE     <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">[</span>mailer<span class="token punctuation">]</span>ENABLED <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">[</span>service<span class="token punctuation">]</span>REGISTER_EMAIL_CONFIRM <span class="token operator">=</span> <span class="token boolean">false</span>ENABLE_NOTIFY_MAIL     <span class="token operator">=</span> <span class="token boolean">false</span>DISABLE_REGISTRATION   <span class="token operator">=</span> <span class="token boolean">false</span>ENABLE_CAPTCHA         <span class="token operator">=</span> <span class="token boolean">true</span>REQUIRE_SIGNIN_VIEW    <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">[</span>picture<span class="token punctuation">]</span>DISABLE_GRAVATAR        <span class="token operator">=</span> <span class="token boolean">false</span>ENABLE_FEDERATED_AVATAR <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">[</span>session<span class="token punctuation">]</span>PROVIDER <span class="token operator">=</span> <span class="token function">file</span><span class="token punctuation">[</span>log<span class="token punctuation">]</span>MODE      <span class="token operator">=</span> console, <span class="token function">file</span>LEVEL     <span class="token operator">=</span> InfoROOT_PATH <span class="token operator">=</span> /extend-disk/partition2/software/gogs/log<span class="token punctuation">[</span>security<span class="token punctuation">]</span>INSTALL_LOCK <span class="token operator">=</span> <span class="token boolean">true</span>SECRET_KEY   <span class="token operator">=</span> 3WWzvF7wpDsBvvP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
            <tag> Gogs </tag>
            
            <tag> Git 服务器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 之索引、视图、触发器</title>
      <link href="posts/b1cb609d.html"/>
      <url>posts/b1cb609d.html</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-之索引、视图、触发器"><a href="#MySQL-之索引、视图、触发器" class="headerlink" title="MySQL 之索引、视图、触发器"></a>MySQL 之索引、视图、触发器</h1><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><ul><li>索引的引入</li></ul><p>索引是由数据库表中一列或者多列组合而成，其作用是提高对表中数据的查询速度；类似于图书的目录，方便快速定位，寻找指定的内容。</p><ul><li>索引的优缺点</li></ul><p>优点：提高查询数据的速度<br>缺点：创建和维护索引的时间增加了</p><ul><li>建立索引的建议</li></ul><ol><li>一张表建议最多建立 5 个索引</li><li>建立复合索引优于单值索引（复合索引占用空间小）</li></ol><ul><li>建立索引的技巧</li></ul><ol><li>如果是左连接则需要在右表关联字段上建立索引，因为左表是查的全部数据。如果是右连接则需要在左表关联字段上建立索引。</li><li>尽可能减少 join 语句中的 NestedLoop 的循环总次数。（永远用小结果集驱动大的结果集）</li><li>优先优化 NestedLoop 的内层循环。</li><li>保证 join 语句中被驱动表上 join 条件字段已经被索引。</li><li>当无法保证被驱动表的 join 条件字段被索引且内存资源充足的前提下，不要太吝啬 JoinBuffer 的设置。</li></ol><ul><li>索引失效的常见原因</li></ul><ol><li>查询全部列，不会使用到索引（select *）</li><li>不遵守最佳左前缀法则（如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且<strong>不跳过索引的列</strong>）</li><li>在索引列上做任何操作（计算、函数、（自动或手动）类型转换），会导致索引失效而转向全表扫描</li><li>存储引擎使用了索引中范围条件右边的列，会导致不会使用到索引</li><li>尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少 select *</li><li>mysql 在使用不等于 （!= 或 &lt;&gt;）的时候无法使用索引会导致全表扫描</li><li>is null,is not null 也无法使用索引</li><li>like 以通配符开头 （’%abc’ 或者 ‘%abc%’）mysql 索引失效会变成全表扫描的操作，当百分号写在右边的时候索引不会失效。解决 ‘%abc%’ 索引失效的方法是，在要模糊查询字段上建立索引，使用覆盖索引的方式查询，则索引则不会失效。</li><li>varchar 类型 （字符串）不加单引号索引失效（如果是 InnoDB 存储类型，会导致行锁变表锁）</li><li>少用 or，用它来连接时索引会失效，即使其中的条件带有索引也不会使用到索引，如果要想使用 or，又想让索引生效，只能将 or 条件中的每一列都加上索引。如果出现 or 的语句中没有一个列加了索引，那么建议使用 union 拼接多个查询语句。</li><li>not in 和 not exist 不会走索引</li></ol><ul><li><p>优化口诀<br>全值匹配我最爱，最左前缀要遵守；<br>带头大哥不能死，中间兄弟不能断；<br>索引列上少计算，范围之后全失效；<br>like百分写最右，覆盖索引不写*；<br>不等空值还有or，索引失效要少用。</p></li><li><p>创建索引的前提</p></li></ul><p>索引的效率取决于<strong>索引列的值是否为散列</strong>，即该列的值如果越互不相同，那么索引效率越高。反过来，如果记录的列存在大量相同的值，例如 gender 列，大约一半的记录值是 M，另一半是 F，因此，对该列创建索引就没有意义。区分度的公式是 <code>count(distinct col)/count(*)</code>，表示字段不重复的比例，比例越大我们扫描的记录数越少。</p><p>可以对一张表创建多个索引。索引的优点是提高了查询效率，缺点是在插入、更新和删除记录时，需要同时修改索引，因此，索引越多，插入、更新和删除记录的速度就越慢。</p><p><em><strong>对于主键，关系数据库会自动对其创建主键索引。使用主键索引的效率是最高的，因为主键会保证绝对唯一。</strong></em></p><ul><li>创建表的时候创建索引：</li></ul><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">-- 创建普通索引CREATE TABLE t_user1 (id INT,userName VARCHAR (20),PASSWORD VARCHAR (20),INDEX (userName));-- 创建唯一性索引并为索引取别名CREATE TABLE t_user2 (id INT,userName VARCHAR (20),PASSWORD VARCHAR (20),UNIQUE INDEX usrn (userName));-- 创建多列索引CREATE TABLE t_user3 (id INT,userName VARCHAR (20),PASSWORD VARCHAR (20),INDEX index_user_pwd (userName,PASSWORD));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在已有表中创建索引</li></ul><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">-- 在已有表中创建普通索引CREATE INDEX index_userName ON t_user4(userName);-- 在已有表中创建唯一性索引CREATE UNIQUE INDEX index_userName ON t_user4(userName);-- 在已有表中创建多列索引CREATE INDEX index_userName_pwd ON t_user4(userName,PASSWORD);// 或者采用下面的方式ALTER TABLE studentsADD INDEX idx_name_score (name, score);-- 使用 ALTER 删除索引ALTER TABLE t_user5 ADD INDEX index_user(userName)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看索引</li></ul><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">show index from table_name\G;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>删除索引</li></ul><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">-- 删除索引-- DROP INDEX 索引名 ON 表名;DROP INDEX index_user ON t_user5;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>索引检索原理</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8dbf9172d1163963.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="索引检索原理"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7b8ef85580ae6d04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="索引的分析"></p><ul><li>哪些情况下应该建立索引 ？</li></ul><ol><li>主键自动建立唯一索引</li><li>频繁作为查询条件的字段应该创建索引</li><li>查询中与其它表关联的字段，外键关系建立索引</li><li>频繁更新的字段不适合创建索引（因为每次更新不单单是更新了记录还会更新索引）</li><li>where 条件里用不到的字段不创建索引</li><li>单键索引还是组合索引的选择问题？（在高并发下倾向创建组合索引）</li><li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度</li><li>查询中统计或者分组字段</li></ol><ul><li>哪些情况下不要建立索引？</li></ul><ol><li>表记录太少</li><li>经常增删改的表</li><li>数据重复且分布平均的表字段，因此应该只为最经常查询和最经常排序的数据列建立索引。注意：如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果。</li></ol><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><ul><li>视图的引入</li></ul><ol><li>试图是一种虚拟的表，是从数据库中一个或者多个表中导出来的表。</li><li>数据库中只存放了视图的定义，而并没有存放视图中的数据，这些数据存放在原来的表中。</li><li>使用视图查询数据时，数据库系统会从原来的表中取出对应的数据。</li></ol><ul><li>视图的作用</li></ul><ol><li>使操作简便化；eg：如果一张表中有 100 个字段，需求只需要 20 个字段，那么可以定义一个视图只取出 20 个字段。</li><li>增加数据的安全性；eg：如果写代码的时候不想要别人知道某些字段，那么可以定义视图，只取出安全系数低的字段</li><li>提高表的逻辑独立性；</li></ol><ul><li>创建视图</li></ul><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE [ALGORITHM = {UNDEFIEND | MERGE | TEMPTABLE}]    VIEW 视图名 [(属性清单)]    AS SELECT 语句    [WITH [CASCADED | LOCAL] CHECK OPTION]    -- 创建单表视图CREATE VIEW v1 AS SELECT userName,password FROM t_user4-- 创建单表视图并给视图字段取别名CREATE VIEW v1(u,p) AS SELECT userName,password FROM t_user4-- 查询视图结果SELECT * FROM v1-- 在多表上创建视图CREATE VIEW v2 AS SELECT bookName.bookTypeName FROM t_book,t_booktype WHERE t_book.bookTypeId = t_booktype.id        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><ul><li>触发器的引入</li></ul><p>触发器（trigger）是由事件来触发某个操作，这些事件包括 insert 语句、 update 语句和 delete 语句。当数据库系统执行这些事件时，就会激活触发器执行相应的操作。</p><ul><li>创建与使用触发器</li></ul><ol><li>创建只有一个执行语句的触发器</li></ol><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TRIGGER 触发器名 BEFORE | AFTER 触发事件 ON 表名 FOR EACH ROW 执行语句-- 其中 new 和 old 为过渡变量， new 代表新的数据，old 代表旧的数据eg：CREATE TRIGGER trig_book AFTER INSERTON t_book FOR EACH ROWUPDATE t_booktype SET bookNum=bookNum+1 WHERE new.bookTypeId=t_booktype.id-- 执行以下语句之后将会触发触发器INSERT INTO t_book VALUES(NULL,'php学习',100,'ke',1)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>创建有多个执行语句的触发器</li></ol><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TRIGGER 触发器名 BEFORE | AFTER 触发事件    ON 表名 FOR EACH ROW    BEGIN        执行语句列表    END  -- 其中，因为 mysql 遇到分号（;）之后会认为语句终止（分号前面的语句为执行语句），因此需要使用 delimiter 来手动定义在 | 符号中间的语句才为执行语句   eg：delimiter |CREATE TRIGGER trig_book2 AFTER DELETEON t_book FOR EACH ROWBEGIN UPDATE t_booktype SET bookNum=bookNum-1 WHERE old.bookTypeId=t_booktype.id;INSERT INTO t_log VALUES (NULL,NULL,'在book表里删除了一条数据');DELETE FROM t_test WHERE old.bookTypeId=t_test.id;END|delimiter;-- 执行以下语句之后将会触发触发器DELETE FROM t_book WHERE id=3;    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看触发器</li></ul><ol><li>直接执行 sql 语句</li></ol><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SHOW TRIGGERS;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>在系统数据库中 information_schema 库中查看 TRIGGERS 表</li></ol><ul><li>删除触发器</li></ul><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">DROP TRIGGER [触发器名];eg:DROP TRIGGER trig_book2;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 索引 </tag>
            
            <tag> 视图 </tag>
            
            <tag> 触发器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 性能分析</title>
      <link href="posts/1e4459df.html"/>
      <url>posts/1e4459df.html</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-性能分析"><a href="#MySQL-性能分析" class="headerlink" title="MySQL 性能分析"></a>MySQL 性能分析</h1><h2 id="explain"><a href="#explain" class="headerlink" title="explain"></a>explain</h2><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">explain select * from users;-- 本意为显示警告信息。但是和 explain 一块儿使用，就会显示出优化后的 sql。需要注意使用顺序。（只能在 mysql cli 中才会有结果）show warnings;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>最重要的 5 个字段是：id、type、key、rows、Extra</p></blockquote><ul><li><strong>id</strong>： select 查询的序列号，包含一组数字，表示查询中执行 select 子句或操作表的顺序</li></ul><ol><li>id 相同，执行顺序由上至下</li><li>id 不同，如果是子查询，id 的序号会递增，id 值越大优先级越高，越先被执行</li><li>id 有相同也有不同的，id 值越大优先级越高越先被执行，id 值相同的按由上到下执行</li></ol><ul><li><strong>select_type</strong>：查询的类型，主要是用于区别普通查询，联合查询，子查询等的复杂查询</li></ul><ol><li>simple ： 简单的 select 查询，查询中不包含子查询或者 union</li><li>primary ：查询中若包含任何复杂的子部份，最 外层查询则被标记为 primary</li><li>subquery ： 在 select 或 where 列表中包含子查询</li><li>derived ： 在 from 列表中包含的子查询被标记为 derived（衍生）MySQL 会递归执行这些子查询，把结果放在临时表里。</li><li>union ： 若第二个 select 出现在 union 之后，则被标记为 union：若 union 包含在 from 子句的子查询中，外层 select 将被标记为： derived</li><li>union result ： 从 union 表获取结果的 select</li></ol><ul><li><strong>table</strong> ： 显示这一行的数据是关于哪张表的</li><li><strong>type</strong> ： 访问类型排序<ul><li>常用的从最好到最差依次是，system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</li><li>完整的从最好到最差依次是 system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; ALL</li><li>一般来说， 得保证查询至少达到 range 级别，最好能达到 ref 级别</li></ul></li></ul><ol><li>system ：表只有一行记录（等于系统表），这是 const 类型的特例，平时不会出现，这个也可以忽略不计</li><li>const ： 表示通过索引一次就找到了，const 用于比较 primary key 或者 unique 索引。因为只匹配一行数据，所以很快。如将主键置于 where 列表中，MySQL 就能将该查询转换为一个常量</li><li>eq_ref : 唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配。常见于主键或唯一索引扫描。</li><li>ref ： 非唯一性索引扫描，返回匹配某个单独值的所有行，本质上也是一种索引访问，它返回所有匹配某个单独值的行，然而，它可能会找到多个符合条件的行，所以他应该属于查找和扫描的混合体。</li><li>range ：只检索给定范围的行，使用一个索引来选择行，key 列显示使用了哪个索引，一般就是在你的 where 语句中出现了 between 、&lt; 、&gt; 、in 等的查询。这种范围扫描索引扫描比全表扫描要好，因为它只需要开始于索引的某一点，而结束于另一点，不用扫描全部索引</li><li>index ： Full Index Scan，Index 与 ALL 区别为 index 类型只遍历索引树。这通常比 ALL 快，因为索引文件通常比数据文件小。（也就是说虽然 all 和 index 都是读全表，但 index 是从索引中读取的，而 all 是从硬盘中读的）</li><li>all ： Full Table Scan，将遍历全表以找到匹配的行</li></ol><p><strong>一般来说，得保证查询至少达到 range 级别，最好能达到 ref</strong></p><ul><li><strong>possible_keys</strong> ：显示可能应用在这张表中的索引，一个或多个。查询涉及到的字段上若存在索引，则该索引将被列出，<strong>但不一定被查询实际使用</strong></li><li><strong>key</strong> ： 实际使用的索引。如果为 null，则没有使用索引。查询中若使用了覆盖索引，则该索引仅出现在 key 列表中。</li><li><strong>key_len</strong> : 表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。在不损失精确性的情况下，长度越短越好。key_len 显示的值为索引字段的最大可能长度，并非实际使用长度，即 key_len 是根据表定义计算而得，不是通过表内检索出的</li><li><strong>ref</strong> ： 显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值</li><li><strong>rows</strong> ：根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数（行数越小越好）</li><li><strong>Extra</strong> ：包含不适合在其它列中显示但十分重要的额外信息</li></ul><ol><li>Using filesort ： 说明 mysql 会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL 中无法利用索引完成的排序操作称为“文件排序”。<strong>九死一生了，效率比较差</strong></li><li>Using temporary ：使用了临时表保存中间结果，MySQL 在对查询结果排序时使用临时表。常用于排序 order by 和分组查询 group by。<strong>十死无生，效率最差！</strong></li><li>Using index ： 表示相应的 select 操作中使用了覆盖索引（Covering index），避免访问了表的数据行，效率不错！如果同时出现 using where ，表明索引被用来执行索引键值的查找；如果没有同时出现 using where ，表明索引用来读取数据而非执行查找动作。</li><li>Using where ：表明使用了 where 过滤</li><li>using join buffer ：使用了连接缓存</li><li>impossible where ： where 子句的值总是 false，不能用来获取任何元组</li><li>select tables optimized away ：在没有 group by 子句的情况下，基于索引优化 min/max 操作或者对于 MyISAM 存储引擎优化 count(*) 操作，不必等到执行阶段再进行计算，查询执行计划生成的阶段即完成优化。</li><li>distinct ：优化 distinct 操作，在找到第一匹配的元组后即停止找同样值的动作</li></ol><h2 id="查询截取分析"><a href="#查询截取分析" class="headerlink" title="查询截取分析"></a>查询截取分析</h2><ul><li>通俗来讲</li></ul><ol><li>观察，至少跑 1 天 ，看看生产的慢 sql 情况。</li><li>开启慢查询日志，设置阈值，比如超过 5 秒钟的就是慢 sql，并将它抓取出来。</li><li>explain + 慢 sql 分析</li><li>show profile</li><li>运维经理或者 DBA，进行 sql 数据库服务器的参数调优。</li></ol><ul><li>学术说法</li></ul><ol><li>慢查询的开启并捕获</li><li>explain + 慢 sql 分析</li><li>show profile 查询 sql 在 mysql 服务器里面的执行细节和生命周期情况</li><li>sql 数据库服务器的参数调优</li></ol><h3 id="提高-order-by-的速度"><a href="#提高-order-by-的速度" class="headerlink" title="提高 order by 的速度"></a>提高 order by 的速度</h3><ol><li>order by 时，select * 是一个大忌，只查询需要的字段，这点非常重要。在这里的影响是：</li></ol><ul><li>当查询的字段大小总和小于 max_length_for_sort_data 而且排序字段不是 text|blob 类型时，会用改进后的算法——单路排序，否则用老算法——多路排序。</li><li>两种算法的数据都有可能超出 sort_buffer 的容量，超出之后，会创建 tmp 文件进行合并排序，导致多次 I/O，但是用单路排序算法的风险会更大一些，所以要提高 sort_buffer_size</li></ul><ol start="2"><li>尝试提高 sort_buffer_size 不管用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的</li><li>尝试提高 max_length_for_sort_data 提高这个参数，会增加用改进算法的概率，但是如果设的太高，数据总容量超出 sort_buffer_size 的概率就增大，明显症状是高的磁盘 I/O 活动和低的处理器使用率。</li></ol><h3 id="为排序使用索引"><a href="#为排序使用索引" class="headerlink" title="为排序使用索引"></a>为排序使用索引</h3><ul><li>MySQL 两种排序方式：文件排序或扫描有序索引排序</li><li>MySQL 能为排序与查询使用相同的索引</li></ul><p>KEY a_b_c (a,b,c)</p><ol><li>order by 能使用索引最左前缀<br>ORDER BY a<br>ORDER BY a,b<br>ORDER BY a,b,c<br>ORDER BY a DESC, b DESC, c DESC</li><li>如果 where 使用索引的最左前缀定义为常量，则 order by 能使用索引<br>WHERE a = const ORDER BY b,c<br>WHERE a = const AND b = const ORDER BY c<br>WHERE a = const ORDER BY b,c<br>WHERE a = const AND b &gt; const ORDER BY b,c</li></ol><h2 id="开启慢查询日志"><a href="#开启慢查询日志" class="headerlink" title="开启慢查询日志"></a>开启慢查询日志</h2><ul><li>查看是否开启及如何开启慢查询日志</li></ul><pre class="line-numbers language-none"><code class="language-none"># 查看是否开启了慢查询日志show variables like '%slow_query_log%';# 开启慢查询日志（临时开启）set global slow_query_log = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果要永久生效，就必须修改配置文件 my.cnf （其他系统变量也是如此）<br>修改 my.cnf 文件，[mysqld] 下增加或修改参数 slow_query_log 和 slow_query_log_file 后，然后重启 MySQL 服务器。</p><pre class="line-numbers language-none"><code class="language-none">slow_query_log = 1 slow_query_log_file = /var/lib/mysql/slow-query.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>慢查询日志是由参数 long_query_time 控制，默认情况下 long_query_time 的值为 10 秒，可以使用以下命令查看</p><pre class="line-numbers language-none"><code class="language-none">show variables like 'long_query_time%';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以使用命令修改，也可以在 my.cnf 参数里面修改。<br>假如运行时间正好等于 long_query_time 的情况，并不会被记录下来。也就是说，在 mysql 源码里是 <strong>判断大于 long_query_time，而非大于等于</strong></p><p>设置阙值到 3 秒钟的就是慢 sql</p><pre class="line-numbers language-none"><code class="language-none">set global long_query_time = 3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>设置慢查询日志阙值后看不出变化？</p><ol><li>需要重新连接或新开一个会话才能看到修改值</li><li>或者直接使用以下命令也可以看到修改后的结果</li></ol><pre class="line-numbers language-none"><code class="language-none">show global variables like 'long_query_time';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如何测试？</p><pre class="line-numbers language-none"><code class="language-none"># 模拟查询超过 4 秒钟select sleep(4);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看慢查询日志中记录了有多少条慢 sql</p><pre class="line-numbers language-none"><code class="language-none">show global status like '%Slow_queries%';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="慢查询分析工具-mysqldumpslow"><a href="#慢查询分析工具-mysqldumpslow" class="headerlink" title="慢查询分析工具 mysqldumpslow"></a>慢查询分析工具 mysqldumpslow</h3><p>可用参数：</p><ul><li>s : 表示按照何种方式排序</li><li>c ：访问次数</li><li>l ：锁定时间</li><li>r ：返回记录</li><li>t ：查询时间</li><li>al ：平均锁定时间</li><li>ar ：平均返回记录数</li><li>at ：平均查询时间</li><li>t ：即返回前面多少条的数据</li><li>g ：后边搭配一个正则匹配模式，大小写不敏感的</li></ul><pre class="line-numbers language-none"><code class="language-none"># 得到返回记录集最多的 10 条 sqlmysqldumpslow -s r -t 10 /var/lib/mysql/slow-query.log# 得到访问次数最多的 10 条 sqlmysqldumpslow -s c -t 10 /var/lib/mysql/slow-query.log# 得到按照时间排序的前 10 条里面包含左连接的查询语句mysqldumpslow -s t -t 10 -g "left join" /var/lib/mysql/slow-query.log另外建议在使用这些命令时结合 | 和 more 使用，否则有可能出现爆屏情况mysqldumpslow -s r -t 10 /var/lib/mysql/slow-query.log | more<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Show-Profile-（可以看到每一条-sql-执行的生命周期）"><a href="#Show-Profile-（可以看到每一条-sql-执行的生命周期）" class="headerlink" title="Show Profile （可以看到每一条 sql 执行的生命周期）"></a>Show Profile （可以看到每一条 sql 执行的生命周期）</h2><p>是 mysql 提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于 sql 的调优的测量。<br>默认情况下，参数处于关闭状态，并保存最近 15 次的运行结果。</p><ol><li>查看是否已经开启</li></ol><pre class="line-numbers language-none"><code class="language-none"># 查看是否已经开启show VARIABLES like 'profiling';# 如果没有开启的话，则开启set profiling = on;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>运行各种查询语句</li><li>使用以下命令，即可看到以上的查询语句</li></ol><pre class="line-numbers language-none"><code class="language-none">show profiles;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>诊断 sql</li></ol><pre class="line-numbers language-none"><code class="language-none">show profile cpu,block io for query 1;（上一步问题 sql 前面的数字号码）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>show profile 的可用参数为：</p><ul><li>all ：显示所有的开销信息</li><li>block io ：显示块 io 相关开销</li><li>context switches ：上下文切换相关开销</li><li>cpu ：显示 cpu 相关开销信息</li><li>ipc ：显示发送和接收相关开销信息</li><li>memory ：显示内存相关开销信息</li><li>page faults ： 显示页面错误相关开销信息</li><li>source ：显示和 Source_function，Source_file，Source_line 相关的开销信息</li><li>swaps ：显示交换次数相关开销的信息</li></ul><h3 id="日常开发需要注意项"><a href="#日常开发需要注意项" class="headerlink" title="日常开发需要注意项"></a>日常开发需要注意项</h3><ol><li>converting HEAP to MyISAM 查询结果太大，内存都不够用了往磁盘上搬了。</li><li>Creating tmp table 创建临时表。（拷贝数据到临时表，用完再删除）</li><li>Copying to tmp table on disk 把内存中临时表复制到磁盘，危险！</li><li>locked 锁表了</li></ol><h2 id="全局查询日志"><a href="#全局查询日志" class="headerlink" title="全局查询日志"></a>全局查询日志</h2><blockquote><p>永远不要在生产环境中开启这个功能！</p></blockquote><ul><li>在配置文件中开启<br>在 mysql 的 my.cnf 中，设置如下：</li></ul><pre class="line-numbers language-none"><code class="language-none"># 开启general_log = 1# 记录日志文件的路径general_log_file = /path/logfile# 输出格式log_output = FILE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>直接执行 sql 语句开启</li></ul><pre class="line-numbers language-none"><code class="language-none"># 开启set global general_log=1;# 用表格的方式记录查询日志set global log_output = 'TABLE';# 此后，你所编写的 sql 语句，将会记录到 mysql 库里的 general_log 表select * from mysql.general_log;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> explain </tag>
            
            <tag> 性能优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 执行加载顺序</title>
      <link href="posts/3b8d5b86.html"/>
      <url>posts/3b8d5b86.html</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-执行加载顺序"><a href="#MySQL-执行加载顺序" class="headerlink" title="MySQL 执行加载顺序"></a>MySQL 执行加载顺序</h1><blockquote><p>这篇文章算是 “水” 一下吧，本想以文字的方式展示出来的，发现以文字的方式写出来太乱了，刚好找到了几张截图，索性就直接截图了。截图也更加清晰明了。</p></blockquote><ul><li>MySQL 手写 sql 时的语句</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-c265c44851c61cbe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MySQL 手写 sql 时的语句"></p><ul><li>MySQL 机读 sql 顺序</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f245cb1b54a6a9a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MySQL 机读 sql 顺序"></p><ul><li>MySQL 执行顺序</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-9c169ebd6af288dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MySQL 执行顺序"></p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 锁机制</title>
      <link href="posts/eee5658b.html"/>
      <url>posts/eee5658b.html</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-锁机制"><a href="#MySQL-锁机制" class="headerlink" title="MySQL 锁机制"></a>MySQL 锁机制</h1><h2 id="锁的概念"><a href="#锁的概念" class="headerlink" title="锁的概念"></a>锁的概念</h2><ul><li><p>从对数据操作的类型（读/写）来分</p><ul><li>读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响。</li><li>写锁（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。</li></ul></li><li><p>锁相关命令</p></li></ul><pre class="line-numbers language-none"><code class="language-none"># 查看是否有表已经被上锁show open tables;# 给 table1 上读锁，给 table2 上写锁lock table table1 read,table2 write;# 给所有表解锁unlock tables;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="表锁（偏向于-MyISAM）"><a href="#表锁（偏向于-MyISAM）" class="headerlink" title="表锁（偏向于 MyISAM）"></a>表锁（偏向于 MyISAM）</h3><p>给表加<strong>读</strong>锁的情况：</p><ol><li>session-1</li></ol><pre class="line-numbers language-none"><code class="language-none"># 对 table1 加读锁lock table table1 read; # 因为读锁是共享锁，因此可以查出数据select * from table1;# 但是无法修改和插入新数据update table1 set name = 'a1' where id = 1;# 但是不能读取其他的表select * from table2;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>session-2</li></ol><pre class="line-numbers language-none"><code class="language-none"># 因为读锁是共享锁，因此可以查出数据select * from table1;# 也可以读其他的表select * from table2;# 当 session-2 想要修改 session-1 已经锁的表 table1 时，已经被阻塞，需要等到 table1 被解锁之后才可以将数据更新update table1 set name = 'a1' where id = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>给表加<strong>写</strong>锁的情况：</p><ol><li>session-1</li></ol><pre class="line-numbers language-none"><code class="language-none"># 给 table1 加写锁lock table table1 write;# 能够查询 table1select * from table1;# 自己能够更新 table1 的数据update table1 set name = 'a1' where id = 1;# 但是不能读取其他的表select * from table2;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>session-2</li></ol><pre class="line-numbers language-none"><code class="language-none"># 可以查询其他没有上写锁的表select * from table2;# 查询 session-1 中已经上写锁的 table1 时，会发生阻塞，需要等到 session-1 将 table1 解锁才会查得出来结果select * from table1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>MyISAM 在执行查询语句 （select） 前，会自动给涉及的所有表加读锁，在执行增删改操作前，会自动给涉及的表加写锁。<br>MySQL的表级锁有两种模式：<br>表共享读锁（Table Read Lock）<br>表独占写锁（Table Write Lock）</p><table><thead><tr><th>锁类型</th><th>可否兼容</th><th>读锁</th><th>写锁</th></tr></thead><tbody><tr><td>读锁</td><td>是</td><td>是</td><td>否</td></tr><tr><td>写锁</td><td>是</td><td>否</td><td>否</td></tr></tbody></table><p><strong>结论</strong><br>结合上表，所有对 MyISAM 表进行操作，会有以下情况：</p><ol><li>对 MyISAM 表的读操作（加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其它进程的写操作。</li><li>对 MyISAM 表的写操作（加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其他进程的读写操作。</li></ol><p><strong>简而言之，就是读锁会阻塞写，但是不会阻塞读。而写锁则会把读和写都阻塞</strong></p><h4 id="如何分析表锁-？"><a href="#如何分析表锁-？" class="headerlink" title="如何分析表锁 ？"></a>如何分析表锁 ？</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">show status like 'table%';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这里有两个状态变量记录 MySQL 内部表级锁定的情况，两个变量说明如下：</p><ul><li>Table_locks_immediate ：  产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加 1；</li><li>Table_locks_waited ： 出现表级锁定争用而发生等待的次数（不能立即获取锁的次数，每等待一次锁值加 1），此值高则说明存在着较严重的表级锁争用情况。</li></ul><p><strong>此外，MyISAM 的读写锁调度是写优先，这也是 MyISAM 不适合做写为主表的引擎。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞</strong></p><h3 id="行锁-（偏向于-InnoDB）"><a href="#行锁-（偏向于-InnoDB）" class="headerlink" title="行锁 （偏向于 InnoDB）"></a>行锁 （偏向于 InnoDB）</h3><p>特点：</p><ol><li>开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</li><li>InnoDB 与 MyISAM 的最大不同有两点：一是支持事务（TRANSACTION），二是采用了行级锁</li></ol><p><strong>事务的 4 个特性： ACID</strong></p><ol><li>原子性（Atomicity）：事务是一个原子操作单元，其对数据的修改，要么全部执行，要么全部不执行。</li><li>一致性（Consistent）：在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性：事务结束时，所有的内部数据结构（如 B树索引或双向链表）也都必须是正确的。</li><li>隔离性（Isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。</li><li>持久性（Durable）：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</li></ol><ul><li><p>间隙锁<br>当我们用<strong>范围条件</strong>而不是相等条件检索数据，并请求共享或排他锁时，InnoDB 会给符合条件的已有数据记录的索引项加锁；（宁可错杀一千，也不可放过一个）对于键值在条件范围内但不存在的记录，叫做“间隙（GAP）”，InnoDB 也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（Next-Key锁）。</p></li><li><p>间隙锁的危害<br>因为 query 执行过程中通过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值并不存在。间隙锁有一个比较致命的弱点，就是当锁定一个范围值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害。</p></li><li><p>如何给增加一条行锁 ？</p></li></ul><pre class="line-numbers language-none"><code class="language-none"># 设置一个起点begin;# 给指定行上锁select * from table1 where a = 8 for update;# 上锁之后，做一些你想要做的操作，比如说需要更新当前数据update table1 set b = 123 where a = 8;# 做完你想要做的操作之后，一定要提交commit;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Innodb 存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定要更高一些，但是在整体并发处理能力方面要远远优于 MyISAM 的表级锁定的。当系统并发量较高的时候，InnoDB 的整体性能和 MyISAM 相比就会有比较明显的优势了。<br>但是，InnoDB 的行级锁同样也有其脆弱的一面，当我们使用不当的时候，可能会让 InnoDB 的整体性能表现不仅不能比 MyISAM 高，甚至可能会更差。</p><h4 id="如何分析行锁-？"><a href="#如何分析行锁-？" class="headerlink" title="如何分析行锁 ？"></a>如何分析行锁 ？</h4><p>通过检查 InnoDB_row_lock 状态变量来分析系统上的行锁的争夺情况</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">show status like 'innodb_row_lock%';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对各个状态量的说明如下：</p><ul><li>innodb_row_lock_current_waits ：当前正在等待锁定的数量</li><li>innodb_row_lock_time ： 从系统启动到现在锁定总时间长度</li><li>innodb_row_lock_time_avg ：每次等待所花平均时间</li><li>innodb_row_lock_time_max ：从系统启动到现在等待最常的一次所花的时间</li><li>innodb_row_lock_waits ：系统启动后到现在总共等待的次数</li></ul><p>对于这 5 个状态变量，比较重要的主要是 innodb_row_lock_time_avg （等待平均时长）、innodb_row_lock_waits （等待总次数）、innodb_row_lock_time （等待总时长）这三项。尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手指定优化计划。</p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 三范式</title>
      <link href="posts/b17a8184.html"/>
      <url>posts/b17a8184.html</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-三范式"><a href="#MySQL-三范式" class="headerlink" title="MySQL 三范式"></a>MySQL 三范式</h1><h2 id="第一范式（1NF）：表中的每列的属性不可再分"><a href="#第一范式（1NF）：表中的每列的属性不可再分" class="headerlink" title="第一范式（1NF）：表中的每列的属性不可再分"></a>第一范式（1NF）：表中的每列的属性不可再分</h2><p>比如：</p><table><thead><tr><th>学号（主键）</th><th>姓名</th><th>性别</th><th>就读信息</th></tr></thead><tbody><tr><td>20200101</td><td>张三</td><td>男</td><td>大一，土木工程</td></tr></tbody></table><blockquote><p>上表中可以看到，（就读信息）这一列，其实还可以分解成（年级）和（专业），因此（就读信息）这一属性还可以再分，故不满足第一范式</p></blockquote><p>修改成：</p><table><thead><tr><th>学号（主键）</th><th>姓名</th><th>性别</th><th>年级</th><th>专业</th></tr></thead><tbody><tr><td>20200101</td><td>张三</td><td>男</td><td>大一</td><td>土木工程</td></tr></tbody></table><h2 id="第二范式（2NF）：在第一范式的基础上，表里的非主键属性必须都依赖于主键（联合主键）"><a href="#第二范式（2NF）：在第一范式的基础上，表里的非主键属性必须都依赖于主键（联合主键）" class="headerlink" title="第二范式（2NF）：在第一范式的基础上，表里的非主键属性必须都依赖于主键（联合主键）"></a>第二范式（2NF）：在第一范式的基础上，表里的非主键属性必须都依赖于主键（联合主键）</h2><p>比如：</p><table><thead><tr><th>学号（主键）</th><th>课程（主键）</th><th>教师姓名</th><th>成绩</th><th>学生姓名</th><th>专业</th></tr></thead><tbody><tr><td>20200101</td><td>C语言程序设计</td><td>老张</td><td>80</td><td>张三</td><td>计算机科学与技术</td></tr><tr><td>20200102</td><td>JAVA程序设计</td><td>老李</td><td>87</td><td>李四</td><td>网络工程</td></tr><tr><td>20200103</td><td>数据结构</td><td>老王</td><td>90</td><td>王五</td><td>软件工程</td></tr></tbody></table><blockquote><p>上表中可以看到，（教师姓名、成绩）两个属性都依赖于（学号）和（课程），但是（学生姓名、专业）这两个属性却只依赖于（学号），不依赖于（课程），即 <strong>只需要知道（学号）便可以知道（学生姓名和专业两个属性）</strong>，所以，导致非主键属性（学生姓名、专业）不完全依赖于主键（学号、课程），故不符合第二范式</p></blockquote><p>修改成：</p><table><thead><tr><th>学号（主键）</th><th>课程（主键）</th><th>教师姓名</th><th>成绩</th></tr></thead><tbody><tr><td>20200101</td><td>C语言程序设计</td><td>老张</td><td>80</td></tr><tr><td>20200102</td><td>JAVA程序设计</td><td>老李</td><td>87</td></tr><tr><td>20200103</td><td>数据结构</td><td>老王</td><td>90</td></tr></tbody></table><hr><table><thead><tr><th>学号（主键）</th><th>学生姓名</th><th>专业</th></tr></thead><tbody><tr><td>20200101</td><td>张三</td><td>计算机科学与技术</td></tr><tr><td>20200102</td><td>李四</td><td>网络工程</td></tr><tr><td>20200103</td><td>王五</td><td>软件工程</td></tr></tbody></table><h2 id="第三范式（3NF）：在第二范式的基础上，表中的非主属性不可以存在依赖关系"><a href="#第三范式（3NF）：在第二范式的基础上，表中的非主属性不可以存在依赖关系" class="headerlink" title="第三范式（3NF）：在第二范式的基础上，表中的非主属性不可以存在依赖关系"></a>第三范式（3NF）：在第二范式的基础上，表中的非主属性不可以存在依赖关系</h2><table><thead><tr><th>学号（主键）</th><th>姓名</th><th>性别</th><th>年级</th><th>专业</th><th>班主任姓名</th><th>班主任性别</th><th>班主任年龄</th></tr></thead><tbody><tr><td>20200101</td><td>张三</td><td>男</td><td>大一</td><td>计算机科学与技术</td><td>老张</td><td>男</td><td>33</td></tr><tr><td>20200102</td><td>李四</td><td>男</td><td>大二</td><td>网络工程</td><td>老李</td><td>男</td><td>34</td></tr><tr><td>20200103</td><td>王五</td><td>女</td><td>大三</td><td>软件工程</td><td>老王</td><td>男</td><td>35</td></tr></tbody></table><blockquote><p>上表中可以看到，非主键属性都依赖于（学号），满足了第二范式。但是（班主任性别、班主任年龄）这两个属性都是直接依赖于（班主任姓名）这一属性的，与（学号）属于间接依赖，这就导致了表中的非主键属性存在着依赖关系，不符合第三范式</p></blockquote><table><thead><tr><th>学号（主键）</th><th>姓名</th><th>性别</th><th>年级</th><th>专业</th></tr></thead><tbody><tr><td>20200101</td><td>张三</td><td>男</td><td>大一</td><td>计算机科学与技术</td></tr><tr><td>20200102</td><td>李四</td><td>男</td><td>大二</td><td>网络工程</td></tr><tr><td>20200103</td><td>王五</td><td>女</td><td>大三</td><td>软件工程</td></tr></tbody></table><hr><table><thead><tr><th>班主任姓名（主键）</th><th>班主任性别</th><th>班主任年龄</th></tr></thead><tbody><tr><td>老张</td><td>男</td><td>33</td></tr><tr><td>老李</td><td>男</td><td>34</td></tr><tr><td>老王</td><td>男</td><td>35</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 主从复制</title>
      <link href="posts/6b30c31b.html"/>
      <url>posts/6b30c31b.html</url>
      
        <content type="html"><![CDATA[<h2 id="MySQL-主从复制"><a href="#MySQL-主从复制" class="headerlink" title="MySQL 主从复制"></a>MySQL 主从复制</h2><ul><li>主从复制原理</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e70a71423894062b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="主从复制原理"></p><ul><li>主从复制的基本原则</li></ul><ol><li>每个 slave 只有一个 master</li><li>每个 slave 只能有一个唯一的服务器 ID</li><li>每个 master 可以有多个 salve</li></ol><h3 id="一主一从常见配置"><a href="#一主一从常见配置" class="headerlink" title="一主一从常见配置"></a>一主一从常见配置</h3><ul><li>mysql 版本一致且后台以服务运行</li><li>主从都配置在 [mysqld] 节点下，都是小写</li></ul><h4 id="主数据库配置，修改-etc-my-cnf-配置文件"><a href="#主数据库配置，修改-etc-my-cnf-配置文件" class="headerlink" title="主数据库配置，修改 /etc/my.cnf 配置文件"></a>主数据库配置，修改 /etc/my.cnf 配置文件</h4><ol><li>主服务器唯一 ID <strong>必须</strong></li></ol><pre class="line-numbers language-none"><code class="language-none">server-id=1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>启用二进制日志 <strong>必须</strong></li></ol><pre class="line-numbers language-none"><code class="language-none"># mysqlbin 为官方推荐的文件名log-bin=自己的本地路径/mysqlbinlog-bin=/var/local/mysql-server5.7/data/mysqlbin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>启用错误日志 <strong>可选</strong></li></ol><pre class="line-numbers language-none"><code class="language-none"># mysqlerr 为官方推荐的文件名log-err=自己的本地路径/mysqlerrlog-err=/var/local/mysql-server5.7/data/mysqlerr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>根目录 <strong>可选</strong></li></ol><pre class="line-numbers language-none"><code class="language-none">basedir="自己的本地路径"basedir="/var/local/mysql-server5.7/"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="5"><li>临时目录 <strong>可选</strong></li></ol><pre class="line-numbers language-none"><code class="language-none">tmpdir="自己的本地路径"tmpdir="/var/local/mysql-server5.7/"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="6"><li>数据目录 <strong>可选</strong></li></ol><pre class="line-numbers language-none"><code class="language-none">datadir="自己的本地路径"datadir="/var/local/mysql-server5.7/"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="7"><li>主机，读写都可以 <strong>可选</strong></li></ol><pre class="line-numbers language-none"><code class="language-none">read-only=0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="8"><li>设置不要复制的数据库 <strong>可选</strong></li></ol><pre class="line-numbers language-none"><code class="language-none">binlog-ignore-db=mysql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="9"><li>设置需要复制的数据库 <strong>可选</strong></li></ol><pre class="line-numbers language-none"><code class="language-none">binlog-do-db=需要复制的主数据库名字<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>完整的配置为：</p><pre class="line-numbers language-none"><code class="language-none">[mysqld]port=3306server-id=1log-bin=/var/local/mysql-server5.7/data/mysqlbinlog-err=/var/local/mysql-server5.7/data/mysqlerrbasedir="/var/local/mysql-server5.7/"tmpdir="/var/local/mysql-server5.7/"datadir="/var/local/mysql-server5.7/"read-only=0binlog-ignore-db=mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="从数据库配置，修改-etc-my-cnf-配置文件"><a href="#从数据库配置，修改-etc-my-cnf-配置文件" class="headerlink" title="从数据库配置，修改 /etc/my.cnf 配置文件"></a>从数据库配置，修改 /etc/my.cnf 配置文件</h4><ol><li>从服务器唯一 ID <strong>必须</strong></li></ol><pre class="line-numbers language-none"><code class="language-none"># 默认配置文件中将此行注释掉了，可以直接取消注释即可，如果没有找到，也可以自己添加server-id=2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>启用二进制日志 <strong>必须</strong></li></ol><pre class="line-numbers language-none"><code class="language-none"># 默认配置文件中将此行注释掉了，可以直接取消注释即可，如果没有找到，也可以自己添加log-bin=mysql-bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>主从机器都关闭掉防火墙</li><li>在主数据库上建立账户并授权 slave</li></ul><pre class="line-numbers language-none"><code class="language-none"># 从数据库用于拷贝的账号为：alex# 从数据库用于拷贝的密码为：123456# 从数据库所在服务器的 ip 地址为：127.0.0.12grant replication slave on *.* to 'alex'@'127.0.0.12' identified by '123456';# 刷新权限flush privileges;# 查询 master 的状态，并记录下 File 和 Position 的值show master status;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在从数据库上配置</li></ul><pre class="line-numbers language-none"><code class="language-none"># 主数据库所在服务器的 ip 地址为：127.0.0.1# 在主数据库建立用于从数据库拷贝的账号为：alex# 在主数据库建立用于从数据库拷贝的密码为：123456# 主数据库中查询出的 File 值为：mysqlbin.000035# 主数据库中查询出的 Position 的值为：341change master to master_host='127.0.0.1', master_user='alex',master_password='123456',master_log_file='mysqlbin.000035',master_log_pos=341; # 启动从服务器复制功能start slave;# 执行以下命令，当 Slave_IO_Running: Yes 和 Slave_SQL_Running: Yes 同时为 yes 时，表示主从复制已经打通了show slave status\G<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>测试主从复制是否成功？</p><ul><li>主数据库新建一个库、新建表、插入一条记录，从数据库去查询是否含有以上数据即可</li></ul></li><li><p>如何停止从数据库复制功能？</p></li></ul><pre class="line-numbers language-none"><code class="language-none"># 从数据库上stop slave;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>当 Slave_IO_Running 和 Slave_SQL_Running 参数不同时为 yes 时？</li></ul><pre class="line-numbers language-none"><code class="language-none"># 先停止从数据库复制功能（从数据库上执行）stop slave;# 查询 master 的状态，并记录下 File 和 Position 的值 （主数据库上执行，这次会有新的 File 值和 Position 值）show master status;change master to master_host='主数据库所在服务器的 ip 地址', master_user='alex',master_password='123456',master_log_file='新的 File 值',master_log_pos=新的Position 值;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 主从复制 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开启 redis 远程连接</title>
      <link href="posts/a15ba792.html"/>
      <url>posts/a15ba792.html</url>
      
        <content type="html"><![CDATA[<h1 id="开启-redis-远程连接"><a href="#开启-redis-远程连接" class="headerlink" title="开启 redis 远程连接"></a>开启 redis 远程连接</h1><ol><li>编辑 redis 配置文件 redis.conf</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 如果需要开启连个访问连接时，一个是本地连接，一个是远程连接</span><span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1 <span class="token number">192.168</span>.174.174<span class="token comment"># 如果是希望任何一台主机都可以连接，那么可以直接注释以下这一行，比如</span><span class="token comment"># bind 127.0.0.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>开启公网连接 redis</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">protected-mode no<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>重启 redis</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> /etc/init.d/redis restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> Redis </tag>
            
            <tag> 缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis 的持久化</title>
      <link href="posts/6d929828.html"/>
      <url>posts/6d929828.html</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-的持久化"><a href="#Redis-的持久化" class="headerlink" title="Redis 的持久化"></a>Redis 的持久化</h1><h2 id="两种持久化方式"><a href="#两种持久化方式" class="headerlink" title="两种持久化方式"></a>两种持久化方式</h2><ul><li>RDB 指定的时间间隔内保存数据快照</li><li>AOF 先把命令追加到操作日志的尾部，保存所有历史操作命令</li></ul><h3 id="RDB-模式"><a href="#RDB-模式" class="headerlink" title="RDB 模式"></a>RDB 模式</h3><ul><li><strong>优点</strong></li></ul><ol><li>适合用于进行备份</li><li>fork 出子进程进行备份，主进程没有任何 IO 操作</li><li>恢复大数据集时的速度快</li></ol><ul><li><strong>缺点</strong></li></ul><ol><li>特定条件下进行一次持久化，易丢失数据</li><li>庞大数据时，保存时会出现性能问题</li></ol><p>设置方式</p><p>配置文件路径： sudo vim /etc/redis/redis.conf</p><pre class="line-numbers language-none"><code class="language-none"># 备份的频次save 900 1    # 900 秒内，有 1 次更新操作，就将数据同步到数据文件save 300 10save 60 10000# 备份的文件名 253 dbfilename dump.rdb# 备份的目录路径 263 dir /var/lib/redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>默认的备份文件为： vim /var/lib/redis/dump.rdb</p><h3 id="AOF-模式"><a href="#AOF-模式" class="headerlink" title="AOF 模式"></a>AOF 模式</h3><ul><li><strong>优点</strong></li></ul><ol><li>数据非常完整，故障恢复丢失数据少</li><li>可对历史操作进行处理</li></ol><ul><li><strong>缺点</strong></li></ul><ol><li>文件的体积大</li><li>速度低于 RDB 且故障恢复速度慢</li></ol><p>设置方式</p><p>配置文件路径： sudo vim /etc/redis/redis.conf</p><pre class="line-numbers language-none"><code class="language-none"># 当 appendonly 参数为 yes 时，则开启 AOF 模式 672 appendonly yes# 备份的文件名 676 appendfilename "appendonly.aof"# 同步的方式 701 # appendfsync always  // 同步持久化，每次数据变更都会立刻保存到磁盘上，需要实时记录，因此效率不高，但是数据十分完整 702 appendfsync everysec  // 异步持久化，每隔 1s 记录一次 703 # appendfsync no  // 不同步<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>默认的备份文件为： vim /var/lib/redis/appendonly.aof</p><blockquote><p>两种模式可以同时开启，同时开启的时候会优先执行 AOF 模式的备份文件，进行 AOF 模式恢复，同时开启的时候，需要注意在 redis 使用之初就要先开启 AOF 模式，以免 AOF 模式，只会记录部分命令，导致恢复数据不完整。</p></blockquote><h2 id="合理地使用-Redis"><a href="#合理地使用-Redis" class="headerlink" title="合理地使用 Redis"></a>合理地使用 Redis</h2><ul><li>防止内存占满：</li></ul><ol><li>设置超时时间</li><li>不存放过大文件（最好不要超过 500 字节）</li><li>不存放不常用数据</li></ol><ul><li>提高使用效率</li></ul><ol><li>合理使用不同的数据结构类型</li><li>慎用正则处理或者批量操作 Hash、Set 等。（因为 redis 是单线程，如果正则匹配 key 的话，可能会影响其他命令的使用）</li></ol>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> Redis </tag>
            
            <tag> 缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis Cluster 集群解决方案</title>
      <link href="posts/663a091e.html"/>
      <url>posts/663a091e.html</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-Cluster-集群解决方案"><a href="#Redis-Cluster-集群解决方案" class="headerlink" title="Redis Cluster 集群解决方案"></a>Redis Cluster 集群解决方案</h1><ul><li>多个 Redis 实例协同进行</li><li>采用 slot （槽）分割数据，是 CRC16 与 16384 取模后分散</li><li>主从结构和选举算法，保证每个节点的可靠性</li><li>客户端可以连接任意一个 node 进行操作</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a6ad3bca1885917a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="主从协同进行"></p><ul><li>所有的 redis 节点彼此互联（PING-PONG 机制），内部使用二进制协议优化传输速度和带宽。</li><li>节点的 fail 是通过集群中超过半数的节点检测失效时才生效。</li><li>客户端与 redis 节点直连，不需要中间 proxy 层，客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可。</li><li>redis-cluster 把所有的物理节点映射到 [0-16383] slot 上，cluster 负责维护 node &lt;-&gt; slot &lt;-&gt; value</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-51f56d899218929f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="当有一台服务器出现故障时"></p><h2 id="Redis-Cluster-注意事项"><a href="#Redis-Cluster-注意事项" class="headerlink" title="Redis Cluster 注意事项"></a>Redis Cluster 注意事项</h2><ul><li>不完全支持批量操作：mset、mget</li><li>事务不能跨节点支持</li><li>不支持多实例</li><li>key 是最小粒度</li><li>最少 6 个才能保证组成完整高可用的集群</li><li>连接的时候只需要连接 1 台服务器即可。</li><li>如果 1 个主从连接宕机的话，那么集群就宕机了。</li></ul><h2 id="Redis-Cluster-配置步骤"><a href="#Redis-Cluster-配置步骤" class="headerlink" title="Redis Cluster 配置步骤"></a>Redis Cluster 配置步骤</h2><p><em><strong>（建议使用官方安装包的方式安装 redis，不要使用 apt-get install 或者 yum 直接安装）</strong></em></p><ol><li>分别安装 <strong>6 台</strong> 服务器，三个主节点，三个从节点</li></ol><p>我这里采用的是虚拟机，相应的 ip 地址分别为：</p><ul><li>192.168.174.128  （28 号服务器）</li><li>192.168.174.129  （29 号服务器）</li><li>192.168.174.130  （30 号服务器）</li><li>192.168.174.131  （31 号服务器）</li><li>192.168.174.132  （32 号服务器）</li><li>192.168.174.133  （33 号服务器）</li></ul><ol start="2"><li>配置 <code>redis.conf</code> 配置文件 <em><strong>（在所有的服务器上操作）</strong></em></li></ol><p>vim /etc/redis/redis.conf</p><ul><li>第一步：</li></ul><pre class="line-numbers language-none"><code class="language-none"># 默认为本地 ip 地址，需要改成当前服务器的 ip 地址，以便其他服务器可以正常访问  69 bind 127.0.0.1 ::1  # 比如 28 号服务器更改为以下 ip 地址bind 192.168.174.128<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>第二步：</li></ul><pre class="line-numbers language-none"><code class="language-none"># 这个参数的含义是指：禁止公网连接 redis 缓存，这样可以加强 redis 安全性。如果是在线上环境的话，我们不需要更改此参数值，然后需要进行设置账号密码，进行 auth 认证。这里为了测试方便，我们直接改成 no  89 protected-mode yes  # 需要更改为以下protected-mode no<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>第三步：开启集群相关参数</li></ul><pre class="line-numbers language-none"><code class="language-none"># 默认集群是关闭的 815 # cluster-enabled yes# 需要更改为以下（去除掉 # 号注释即可） 815 cluster-enabled yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>第四步：开启集群配置文件</li></ul><pre class="line-numbers language-none"><code class="language-none"># 默认集群配置文件是关闭的 823 # cluster-config-file nodes-6379.conf # 需要更改为以下（去除掉 # 号注释即可）  823 cluster-config-file nodes-6379.conf  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>第五步：开启集群超时时间</li></ul><pre class="line-numbers language-none"><code class="language-none"># 当一个节点出现问题的时候，最大超时连接时间为 15s ，当超过 15s 还没有连接的时候，就会认为该节点出现故障了，就会通过选举算法，将从服务器提升为主服务器。该参数默认是关闭的。 829 # cluster-node-timeout 15000 # 需要更改为以下（去除掉 # 号注释即可） 829 cluster-node-timeout 15000 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>安装 <code>ruby</code> 组件。如果不安装这个软件，集群的时候，会报组件错误。你需要在那台服务器上面做集群，你就需要在哪台服务器上安装这个组件，并不是每台服务器上面都安装。这里采用第一台服务器做集群，因此在第一台服务器上安装 <code>ruby</code> 组件。<em><strong>（在 28 号服务器上操作）</strong></em></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ruby<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>安装其他组件  <em><strong>（在 28 号服务器上操作）</strong></em></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gem <span class="token function">install</span> redis<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>配置集群  <em><strong>（在 28 号服务器上操作）</strong></em></li></ol><p>因为我是直接采用的 <code>apt-get install</code> 的方式安装的 <code>redis</code> 因此，服务器上面的 <code>redis</code> 工具 <code>redis-trib.rb</code> 在 <code>/usr/share/doc/redis-tools/examples</code> 目录下。如果你是通过安装包安装的 <code>redis</code> 那么请直接到 <code>redis</code> 解压目录中执行命令，如： <code>~/redis-4.0.9/src/redis-trib.rb</code></p><pre class="line-numbers language-none"><code class="language-none">/usr/share/doc/redis-tools/examples/redis-trib.rb create --replicas 1 192.168.174.128:6379 192.168.174.129:6379 192.168.174.130:6379 192.168.174.131:6379 192.168.174.132:6379 192.168.174.133:6379<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d756993ee1a78b0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配置集群"></p><h3 id="如果出现如下报错时"><a href="#如果出现如下报错时" class="headerlink" title="如果出现如下报错时"></a>如果出现如下报错时</h3><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-398cfd78326a863f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="插槽节点被占用"></p><p><strong>问题原因：</strong><br>slot 插槽被占用了（这是搭建集群前时，以前 redis 的旧数据和配置信息没有清理干净。）<br><strong>解决方案如下：</strong><br>用 redis-cli 登录到每个节点执行  flushall  和 cluster reset  就可以了</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-460623a9e0c0186b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="解决方案如图所示"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f2ae4a85d4fd0304.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="再次设置集群，则可以连接成功"></p><ol start="6"><li>连接集群 <em><strong>（在任意一台服务器上操作）</strong></em></li></ol><p>这里我挑选的是 ip 地址为 ： 192.168.174.131 的服务器，特别说明下，当执行 <code>keys</code> 命令的时候，只针对于当前服务器</p><pre class="line-numbers language-none"><code class="language-none"># 带 -c 参数表示连接集群redis-cli -h 192.168.174.131 -c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="7"><li>测试</li></ol><pre class="line-numbers language-none"><code class="language-none">alex@alex-virtual-machine:~$ redis-cli -h 192.168.174.131 -c    # 连接的 31 号服务器192.168.174.131:6379&gt; keys *  # 这里的 keys 也只能查看所有在 31 号服务器上面的 keys(empty list or set)192.168.174.131:6379&gt; set aa 111  # 随便设置一个 key-&gt; Redirected to slot [1180] located at 192.168.174.128:6379  # 数据却在 28 号服务器上被保存OK192.168.174.128:6379&gt;   # 并且此时的状态直接跳到了 28 号服务器上面<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1f41460e9f146d8a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="连接 31 号服务器，数据存到了 28 号服务器上"></p><pre class="line-numbers language-none"><code class="language-none">alex@alex-virtual-machine:~$ redis-cli -h 192.168.174.129 -c  # 通过 29 号服务器连接集群192.168.174.129:6379&gt; get aa  # 从 29 号服务器中去取值-&gt; Redirected to slot [1180] located at 192.168.174.128:6379  # 会直接从 28 号服务器中返回值"111"192.168.174.128:6379&gt;   # 并且此时的状态直接跳到了 28 号服务器上面<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-56e8e278da0250a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="从 30 号服务器上面取刚刚设置的值，会直接跳到 28 号服务器返回值"></p><pre class="line-numbers language-none"><code class="language-none">alex@alex-virtual-machine:~$ redis-cli -h 192.168.174.130 -c  # 通过 30 号服务器连接集群192.168.174.130:6379&gt; keys *  # 30 号服务器中并没有设置过 key，如果 30 号服务器可以取出值，证明可以跨服务器取出 keys，但是并没有数据，证明 keys 只能取出当前服务器中的 keys(empty list or set)192.168.174.130:6379&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a8098e86eba5fc31.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="keys 只能取出当前服务器中的所有 key"></p>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> Redis </tag>
            
            <tag> 分布式集群 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Memcached 实现分布式算法</title>
      <link href="posts/aa516918.html"/>
      <url>posts/aa516918.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用-Memcached-实现分布式算法"><a href="#使用-Memcached-实现分布式算法" class="headerlink" title="使用 Memcached 实现分布式算法"></a>使用 Memcached 实现分布式算法</h1><h2 id="分布式算法"><a href="#分布式算法" class="headerlink" title="分布式算法"></a>分布式算法</h2><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e26290372bf4ec4b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="需要通过应用程序来实现分布式算法"></p><h3 id="余数计算分散法"><a href="#余数计算分散法" class="headerlink" title="余数计算分散法"></a>余数计算分散法</h3><blockquote><p>根据 key 来计算 CRC，然后结果对服务器数进行取模得到 memcached 服务器节点。  服务器无法连接的时候，将尝试的连接次数加到 key 后面重新计算。</p></blockquote><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6e626d05ecb0cb98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="余数计算分散法"></p><h4 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h4><p>添加或移除服务器时，几乎所有缓存要重建，还需要考虑雪崩式崩溃问题。</p><p>16 个 Key、5 个服务器</p><table><thead><tr><th>服务器</th><th>key 值</th><th>key 值</th><th>key 值</th><th>key 值</th></tr></thead><tbody><tr><td>S0</td><td></td><td>5</td><td>10</td><td>15</td></tr><tr><td>S1</td><td>1</td><td>6</td><td>11</td><td>16</td></tr><tr><td>S2</td><td>2</td><td>7</td><td>12</td><td></td></tr><tr><td>S3</td><td>3</td><td>8</td><td>13</td><td></td></tr><tr><td>S4</td><td>4</td><td>9</td><td>14</td><td></td></tr></tbody></table><p>举个例子来说：如果 S3 服务器直接挂掉的话，那么 S3 服务器的流量会全部并给 S4 服务器，也就是说 S4 服务器要承受之前一倍的压力，如果此时 S4 服务器已经无法承受，直接崩掉的话，那么也就是会将原本 S3、S4 的流量全部在并给 S0 服务器</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b39308b35ba20703.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="余数计算分散法"></p><table><thead><tr><th>服务器</th><th>key 值</th><th>key 值</th><th>key 值</th><th>key 值</th><th>key 值</th></tr></thead><tbody><tr><td>S0</td><td></td><td>4</td><td>8</td><td>12</td><td>16</td></tr><tr><td>S1</td><td>1</td><td>5</td><td>9</td><td>13</td><td></td></tr><tr><td>S2</td><td>2</td><td>6</td><td>10</td><td>14</td><td></td></tr><tr><td>S3（假设移除了 S3 服务器）</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>S4(3)</td><td>3</td><td>7</td><td>11</td><td>15</td><td></td></tr></tbody></table><p>以上例子说明：当移除一台服务器之后，基本上所有的缓存都需要重建，key 值，除了 S1 服务器的 1 和 S2 服务器的 2，剩下的全部都乱套了</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d57efed81911e414.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="余数计算分散法"></p><h3 id="一致性哈希算法"><a href="#一致性哈希算法" class="headerlink" title="一致性哈希算法"></a>一致性哈希算法</h3><ul><li>求出服务器节点的哈希值分配到 0~2^32 的圆上</li><li>求出存储数据键的哈希值映射到圆上</li><li>从数据映射到的位置开始顺时针查找，将数据保存到找到的第一个服务器上</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e59269f6a1f321ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="一致性哈希算法"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-27ffaa9971199a33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="一致性哈希算法"></p><h4 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h4><ul><li>冗余少</li><li>负载均衡</li><li>过渡平滑</li><li>存储均衡</li></ul><h4 id="缺点：-1"><a href="#缺点：-1" class="headerlink" title="缺点："></a>缺点：</h4><p>依然无法解决雪崩问题</p>]]></content>
      
      
      <categories>
          
          <category> Cache </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> 缓存 </tag>
            
            <tag> Memcached </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>memcached 简单使用</title>
      <link href="posts/afc71251.html"/>
      <url>posts/afc71251.html</url>
      
        <content type="html"><![CDATA[<h1 id="memcached-简单使用"><a href="#memcached-简单使用" class="headerlink" title="memcached 简单使用"></a>memcached 简单使用</h1><h2 id="Memcached-工作原理和内存管理"><a href="#Memcached-工作原理和内存管理" class="headerlink" title="Memcached 工作原理和内存管理"></a>Memcached 工作原理和内存管理</h2><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-9d44ed2ff2c9251a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Memcached 工作原理和内存管理"></p><blockquote><p>memcache 的回收机制会采用 <strong>最近最少算法</strong> 将很久没有使用的数据进行清除</p></blockquote><ul><li>Ubuntu 下安装</li></ul><blockquote><p>如果需要编译安装的话，需要先安装 libmemcached 组件才可以</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 memcached</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> memcached<span class="token comment"># 安装 php-memcached 扩展</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> php-memcached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>进入 memecached 环境，直接使用 telnet 访问 11211 端口</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">telnet <span class="token number">127.0</span>.0.1 <span class="token number">11211</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>测试</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置键名为 user1 对值不进行压缩 过期时间为 900s 长度为 8 字节</span><span class="token builtin class-name">set</span> user1 <span class="token number">0</span> <span class="token number">900</span> <span class="token number">8</span>   <span class="token operator">&lt;</span>直接回车<span class="token operator">&gt;</span>alex   <span class="token operator">&lt;</span>直接回车<span class="token operator">&gt;</span>get user1  <span class="token operator">&lt;</span>直接回车<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>另外还需要去 phpinfo() 中去查询一下 memcached 扩展是否安装完毕！</p></blockquote><ul><li>清空 memcached 中所有数据</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接重启 memcached 服务即可</span><span class="token function">service</span> memcached restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Cache </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> 缓存 </tag>
            
            <tag> Memcached </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Memcached 实现 Session 共享</title>
      <link href="posts/af14a477.html"/>
      <url>posts/af14a477.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用-Memcached-实现-Session-共享"><a href="#使用-Memcached-实现-Session-共享" class="headerlink" title="使用 Memcached 实现 Session 共享"></a>使用 Memcached 实现 Session 共享</h1><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7b30b73812fde12f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="实现 Session 共享"></p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><blockquote><p>当有很多用户的时候，这些用户的登录位置在各个不同的服务器上，因为 session 是生成在服务器上的，当用户互访的时候，有的时候发现自己有权限，有时候发现自己没有权限。因为缓存是集中式的，所有的缓存都在一起，那么就可以把 session 放到 memcached 缓存中。所有服务器都可以在公用的服务器上面来取 session，这样无论用户在哪一台服务器上面登录，都有正确的 session。这样的话，有两个优点，第一，解决了 session 共享的问题。第二，当用户量很大的时候，session 是存放在服务器上面的，因此就会增加了磁盘的 IO，但是如果放在缓存中，性质则完全不一样。</p></blockquote><h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><ul><li><h3 id="设置-php-ini-配置文件"><a href="#设置-php-ini-配置文件" class="headerlink" title="设置 php.ini 配置文件"></a>设置 php.ini 配置文件</h3></li></ul><p>vim /etc/php/7.2/fpm/php.ini</p><ol><li>将 seesion 存储方式改为 memcached</li></ol><p>默认 php 是以文件的形式存放 session 的</p><pre class="line-numbers language-none"><code class="language-none">1337 session.save_handler = files<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因此需要修改成 memcached</p><pre class="line-numbers language-none"><code class="language-none">session.save_handler = "memcached"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>修改 session 存放位置</li></ol><p>默认 php 注释掉了</p><pre class="line-numbers language-none"><code class="language-none">1366 ;session.save_path = "/var/lib/php/sessions"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改为</p><blockquote><p>注意：192.168.174.128 是我虚拟机的 ip 地址，这里需要修改成你 memcached 服务器的 ip 地址</p></blockquote><pre class="line-numbers language-none"><code class="language-none"># 对于 php 5.6 及以下，需要写成如下session.save_path = "tcp://192.168.174.128:11211"# 对于 php 7 以上可以直接写成session.save_path = "192.168.174.128:11211"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="如果只想单个-php-文件，取-session-的时候直接取缓存中取的话，可以如下设置"><a href="#如果只想单个-php-文件，取-session-的时候直接取缓存中取的话，可以如下设置" class="headerlink" title="如果只想单个 php 文件，取 session 的时候直接取缓存中取的话，可以如下设置"></a>如果只想单个 php 文件，取 session 的时候直接取缓存中取的话，可以如下设置</h3></li></ul><p>vim test.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"session.save_hander"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"memcached"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"session.save_path"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"192.168.174.128:11211"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><h3 id="另外还可以采用-apache-或者-nginx-的方式设置"><a href="#另外还可以采用-apache-或者-nginx-的方式设置" class="headerlink" title="另外还可以采用 apache 或者 nginx 的方式设置"></a>另外还可以采用 apache 或者 nginx 的方式设置</h3></li></ul><h2 id="将-session-放到-memcached-中的缺点："><a href="#将-session-放到-memcached-中的缺点：" class="headerlink" title="将 session 放到 memcached 中的缺点："></a>将 session 放到 memcached 中的缺点：</h2><p>集群错误会导致用户无法登陆、memcached 的回收机制可能会导致用户掉线</p>]]></content>
      
      
      <categories>
          
          <category> Cache </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> 缓存 </tag>
            
            <tag> Memcached </tag>
            
            <tag> Session </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件缓存（模板缓存）</title>
      <link href="posts/8a518969.html"/>
      <url>posts/8a518969.html</url>
      
        <content type="html"><![CDATA[<h1 id="文件缓存（模板缓存）"><a href="#文件缓存（模板缓存）" class="headerlink" title="文件缓存（模板缓存）"></a>文件缓存（模板缓存）</h1><h2 id="从页面片段缓存到-facebook-的-BigPipe-技术"><a href="#从页面片段缓存到-facebook-的-BigPipe-技术" class="headerlink" title="从页面片段缓存到 facebook 的 BigPipe 技术"></a>从页面片段缓存到 facebook 的 BigPipe 技术</h2><ul><li>将页面划分成一个个小块</li><li>利用 ob_flush() 与 flush() 将缓冲区的内容提前输出给浏览器</li><li>浏览器在一个请求中不断接收并渲染到页面，逐个小块显示。<ul><li>注：JS 部分，不需要立刻执行的部分，可以最后再 eval 进来</li></ul></li></ul><p>程序执行的流程为：<br>program data -&gt; php buffer -&gt; tcp buffer -&gt; client browers</p><table><thead><tr><th>方法</th><th>作用</th><th>解释</th></tr></thead><tbody><tr><td>ob_start()</td><td>打开输出缓冲区</td><td></td></tr><tr><td>ob_flush()</td><td>将 PHP buffer 中的内容，送出到 Tcp buffer 中</td><td>调用 ob_flush() 之后缓冲区内容将被丢弃。</td></tr><tr><td>flush()</td><td>将当前为止 Tcp buffer 中内容发送到用户的浏览器。</td><td>flush() 函数不会对服务器或客户端浏览器的缓存模式产生影响。因此，必须同时使用 ob_flush() 和 flush() 函数来刷新输出缓冲。</td></tr><tr><td>ob_get_contents()</td><td>返回内部缓冲区的内容</td><td>只是得到输出缓冲区的内容，但不清除它，没有激活，则返回 false</td></tr><tr><td>ob_end_clean()</td><td>删除内部缓冲区的内容，并且关闭内部缓冲区。</td><td></td></tr><tr><td>ob_end_flush()</td><td>发送内部缓冲区的内容到浏览器，并且关闭输出缓冲区</td><td></td></tr><tr><td>ob_get_length()</td><td>返回内部缓冲区的长度</td><td></td></tr></tbody></table><h2 id="如何使用这门技术？"><a href="#如何使用这门技术？" class="headerlink" title="如何使用这门技术？"></a>如何使用这门技术？</h2><ul><li>nginx 需要设置</li></ul><p>sudo vim /etc/nginx/nginx.conf</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">fastcgi_keep_conn</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>  // 默认是开启了压缩，需要关闭<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>php 需要设置</li></ul><p>sudo vim /etc/php/7.0/fpm/php.ini</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">;</span>output_buffering <span class="token operator">=</span> <span class="token number">4096</span>output_buffering <span class="token operator">=</span> off<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>重启 nginx 和 php</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> nginx restart<span class="token function">sudo</span> <span class="token function">service</span> php7.0-fpm restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>模板中使用</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">// 开启缓冲区</span><span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">// 模拟程序执行缓慢</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将 php 执行过的东西发送给 nginx 或者 apache</span><span class="token function">ob_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// nginx 或 apache 将内容发送给客户端</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">// 关闭之前也需要将最后的内容发送给客户端</span><span class="token function">ob_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 清理缓冲区</span><span class="token function">ob_end_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实现的效果及优势"><a href="#实现的效果及优势" class="headerlink" title="实现的效果及优势"></a>实现的效果及优势</h2><blockquote><p>页面中有很多分块内容的时候，可以将许多个分块内容分批次的刷给客户端，使得客户端不需要等待所有的内容加载完毕才能看到内容。并且这种技术只有一次请求，如果采用 ajax 的话，可能会想到的是，每个分块内容使用 ajax 请求一次，这样的话就会有多个请求。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Cache </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> 缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器应用程序程序缓存</title>
      <link href="posts/4230d41e.html"/>
      <url>posts/4230d41e.html</url>
      
        <content type="html"><![CDATA[<h1 id="服务器应用程序程序缓存"><a href="#服务器应用程序程序缓存" class="headerlink" title="服务器应用程序程序缓存"></a>服务器应用程序程序缓存</h1><h2 id="Web-Server-服务器之-Apache"><a href="#Web-Server-服务器之-Apache" class="headerlink" title="Web Server 服务器之 Apache"></a>Web Server 服务器之 Apache</h2><ol><li>Apache 的过期模块 mod_expires.so</li></ol><p>通过配置文件控制 HTTP 的 “Expires:” 和 “Cache-Control:” 头内容</p><pre class="line-numbers language-apache" data-language="apache"><code class="language-apache"># 启用 expires_module 模块LoadModule expires_module modules/mod_expires.so# 启用有效期控制ExpiresActive On# GIF 有效期为 1 个月，2592000 秒为 1 个月ExpiresByType image/gif A2592000# HTML 文档的有效期是最后修改时刻后的一星期ExpiresByType text/html M604800# 以下的含义类似ExpiresByType text/css "now plus 2 months"ExpiresByType image/jpeg "access plus 2 months"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>详细解释 <code>ExpiresByType image/jpeg "access plus 2 months"</code> 的含义为：<br><code>ExpiresByType</code> 表示为：由 mime 决定过期配置<br><code>image/jpeg</code> 表示为：具体文件的 mime 类型<br><code>access</code> 表示：过期时间从访问时开始计算，等同于 <code>now</code> 和 <code>A</code> 参数，还可以设置为 <code>modification</code> 或者 <code>M</code> 参数，表示为，被访问文件的最后修改时间开始计算。<br><code>months</code> 表示月份，可用的参数有：<code>years</code> 、<code>months</code> 、 <code>weeks</code> 、 <code>days</code> 、<code>hours</code> 、 <code>minutes</code> 、 <code>seconds</code></p><ol start="2"><li>Apache 的缓存模块 mod_cache</li></ol><ul><li>mod_cache: 基于 uri 键的内容动态缓冲模块，缓存响应头和正文，以便在下一个请求时快速相应它。<ul><li>mod_disk_cache (Apache2.2) / mod_cache_disk (Apache2.4) 基于磁盘的缓冲模块</li><li>mod_mem_cache.so (Apache2.2) 基于内存的缓冲模块，2.4 版本已经移除</li></ul></li><li>mod_file_cache 提供文件描述符缓存支持，加快与缓慢的文件系统服务器的文件访问，只能应用于静态文件。</li></ul><h2 id="php-的-APC-和-Opcache"><a href="#php-的-APC-和-Opcache" class="headerlink" title="php 的 APC 和 Opcache"></a>php 的 APC 和 Opcache</h2><ul><li>Opcache 是一种通过将解析的 php 脚本预编译的字节码存放在共享内存中来避免每次加载和解析 php 脚本的开销。</li><li>解析器可以直接从共享内存读取已经缓存的字节码，从而大大提高 php 的执行效率。</li><li>APC 是缓存、优化 php 中间代码的架构，可以缓存 Opcodes。</li><li>php5.5 以后，Zend Opcache 整合到 php 中，并可代替 APC 使用。此功能默认关闭。</li></ul><h3 id="如何使用-Opcache-？"><a href="#如何使用-Opcache-？" class="headerlink" title="如何使用 Opcache ？"></a>如何使用 Opcache ？</h3><ol><li>访问 phpinfo(); 页面，查看 Loaded Configuration File =&gt; /etc/php/7.0/fpm/php.ini （php 配置文件 php.ini 所在的文件路径） 和 Scan this dir for additional .ini files =&gt; /etc/php/7.0/fpm/conf.d （扩展配置文件的目录）</li><li>查看 zend_extension=opcache.so 是否开启：vim /etc/php/7.0/fpm/conf.d/10-opcache.ini （默认是开启的）</li></ol><h3 id="php-执行过程"><a href="#php-执行过程" class="headerlink" title="php 执行过程"></a>php 执行过程</h3><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3638cd88c106c12f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="php 代码执行流程"></p><ul><li>查看 lexing</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$source</span> <span class="token operator">=</span> <span class="token string heredoc-string"><span class="token delimiter symbol"><span class="token punctuation">&lt;&lt;&lt;</span>EOT</span>&lt;?phpecho '1111';<span class="token delimiter symbol">EOT<span class="token punctuation">;</span></span></span><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">token_get_all</span><span class="token punctuation">(</span><span class="token variable">$source</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="mysql-查询缓存"><a href="#mysql-查询缓存" class="headerlink" title="mysql 查询缓存"></a>mysql 查询缓存</h2><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-dd846d00e6ebf040.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="mysql 查询缓存"></p><p>查询缓存相关有两个参数设置：</p><ol><li>query_cache_size 查询缓存大小，默认为 16M</li><li>query_cache_type 有三个可用值，0 表示不使用查询缓存，1 表示缓存所有的结果，2 表示在 select 语句中使用了 sql cache 指定缓存查询的结果进行缓存，没有指定则不缓存。</li></ol><h3 id="设置查询缓存相关的配置"><a href="#设置查询缓存相关的配置" class="headerlink" title="设置查询缓存相关的配置"></a>设置查询缓存相关的配置</h3><ol><li>进入主配置文件中查看 sudo vim /etc/mysql/my.cnf</li><li>进入配置文件 sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf</li></ol><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">query_cache_size = 16M  // 默认查询缓存为 16Mquery_cache_type = 1  // 开启查询缓存，默认是没有开启的，需要手动添加这一行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>重启 mysql 服务器 sudo service mysql restart</li><li>进入数据库 mysql -u root -p</li><li>查看缓存是否开启 show variables like “%query_cache%”;</li><li>查询缓存是否正常运行了 show status like “%Qcache%”;</li></ol><h3 id="mysql-Memory-存储引擎"><a href="#mysql-Memory-存储引擎" class="headerlink" title="mysql Memory 存储引擎"></a>mysql Memory 存储引擎</h3><p>原理：</p><blockquote><p>创建表结构使用 ENGINE = MEMORY 生成内存表，表结构存在磁盘上的 <code>.frm</code> 文件中，服务器启动后，用此结构在内存中创建空白表，并默认使用哈希索引。</p></blockquote><p>优点：</p><ol><li>速度比 MyISAM 和 Innodb 存储引擎更快，适合做热点表的前置缓存。</li><li>sql 操作与存储引擎一致。</li></ol><p>使用要点：</p><ol><li>varchar 这样的可变长度类型将转换为固定长度</li><li>mysql 4.1.0 之前，不支持 auto_increment 自增列</li><li>不能包含 blob 或 text 列</li><li>重启数据丢失，如果有备份，会导致数据与备份不一致</li><li>内存表数据大于 max_heap_table_size 设定值，超出数据会存储到磁盘上</li><li>高负载时扩展性和混合写操作的并发处理性能不佳</li></ol>]]></content>
      
      
      <categories>
          
          <category> Cache </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> 缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浏览器缓存</title>
      <link href="posts/be7c79f7.html"/>
      <url>posts/be7c79f7.html</url>
      
        <content type="html"><![CDATA[<h1 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h1><ul><li>浏览器处理网页的方式</li></ul><ol><li>走到协商缓存会返回 304</li><li>走到强缓存会返回 200</li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f123261940f40366.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="浏览器缓存执行流程"></p><ul><li>合理使用浏览器缓存</li></ul><ol><li>页面连接的请求无须做长时间缓存</li><li>敏感数据像订单等不宜做缓存</li><li>静态资源部分，通常会设定一个较长的缓存时间</li><li>冷热数据分离，减少请求量</li><li>不要随意修改文件，建议使用 ?version=** 调用多版本</li><li>不建议使用 ETag,尤其是分布式</li></ol><ul><li>header 字段输出方式</li></ul><ol><li>html 输出方式</li></ol><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Cache-Control<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max-age=7200<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>php 输出方式</li></ol><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Cache-Control:max-age=7200'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><strong>强缓存阶段的 header 字段</strong></li></ul><p>启用强缓存的状态为 200 (from disk cache)</p><p>执行到强缓存的时机为：</p><pre class="line-numbers language-none"><code class="language-none">graph TDA[浏览器] --&gt; B[是否有缓存]B --&gt; C{Yes or No?}C --&gt; |yes| D[是否过期]D --&gt; |no| E[就使用缓存中的内容]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Pragma (HTTP 1.0)</li><li>Expires (HTTP 1.0)  （设定的是一个精确的时间）</li><li>Cache-control (HTTP 1.1)<ul><li>max-age （缓存最大的秒数）</li><li>Public \ private （当设置为 public 且采用 https 协议的时候，也会转换成 private）</li><li>no-cache \ no-store （不允许存放在用户的硬盘里） \ must-revalidate （必须请求认证）</li></ul></li></ul><blockquote><p>如果这三个参数同时出现的话：那么优先顺序为，1、Cache-control 2、Pragma 3、Expires</p></blockquote><ul><li><strong>协商缓存阶段的 header 字段</strong></li></ul><p>启用协商缓存的状态为 304 Not Modified</p><ol><li>Last-Modified：末次更新标记，文件最后一次更新的具体时间（下行 response）</li><li>If-Modified-Since ：资源上次的修改时间（上行 request）</li><li>E-Tag ： 实体与标记（下行）</li><li>If-None-Match ：资源内容标识（上行）</li></ol><p>协商缓存的执行流程如下：</p><pre class="line-numbers language-none"><code class="language-none">graph TDA[浏览器第一次请求服务器] --&gt; B[服务器 Response Headers 携带 last-modified: Mon, 21 Oct 2019 00:44:35 GMT 返回给浏览器]B --&gt; C[浏览器第二次请求服务器 Request Headers 携带 If-Modified-Since: Mon, 21 Oct 2019 00:44:35 GMT]C --&gt; D{If-Modified-Since 和文件的 Last-Modified 作比较}D --&gt; |yes| E[文件的最后修改时间没有变化]E --&gt; F[Status Code: 304 Not Modified]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为 Last-Modified 和  If-Modified-Since 字段的最小颗粒度为秒 （Mon, 21 Oct 2019 00:44:35 GMT） ，那么就会出现一个问题：当某个文件在 1s 中更改 n 次时，服务器就完全不知道是否需要执行强制缓存。这就引入了 E-Tag 的概念。当文件只要修改时，E-Tag 就会重新生成一个字符串，之后浏览器第二次请求的时候，重新生成的字符串被 If-None-Match 字段携带。「E-Tag」、「If-None-Match」 和 「Last-Modified」、「If-Modified-Since」执行流程完全一致。</p>]]></content>
      
      
      <categories>
          
          <category> Cache </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cache </tag>
            
            <tag> 缓存 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows10 专业版 64位系统安装docker并使用 laradock 搭建 laravel 环境</title>
      <link href="posts/f59f8f31.html"/>
      <url>posts/f59f8f31.html</url>
      
        <content type="html"><![CDATA[<h1 id="windows10-专业版-64-位系统安装-docker-并使用-laradock-搭建-laravel-环境"><a href="#windows10-专业版-64-位系统安装-docker-并使用-laradock-搭建-laravel-环境" class="headerlink" title="windows10 专业版 64 位系统安装 docker 并使用 laradock 搭建 laravel 环境"></a>windows10 专业版 64 位系统安装 docker 并使用 laradock 搭建 laravel 环境</h1><blockquote><p><a href="https://www.docker.com/">docker官网</a><br><a href="https://docs.docker.com/install/">docker官网安装文档</a></p></blockquote><h2 id="安装说明"><a href="#安装说明" class="headerlink" title="安装说明"></a>安装说明</h2><ul><li><h3 id="windows-10-系统需要开启-Hyper-V"><a href="#windows-10-系统需要开启-Hyper-V" class="headerlink" title="windows 10 系统需要开启 Hyper-V"></a>windows 10 系统需要开启 Hyper-V</h3></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1c2cfe770c1a9c08.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="官方文档中有写到，必须开启 Hyper-V"></p><p>开启方式如下图：</p><ol><li><p>打开控制面板-程序-程序和功能-启用或关闭 windows 功能<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8c02d2b070ab1bfd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="启用或关闭 windows 功能"></p></li><li><p>找到有关  Hyper-V  的项，全部选中<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-4a53340ebf3d7ebc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="有关 Hyper-V 的选项，全部勾选"></p></li><li><p>如果发现关于 Hyper-V 的选项无法开启，那么就需要进入 bios 开启虚拟化。开启方法见如下链接：</p></li></ol><blockquote><p><a href="https://www.windows10.pro/how-to-see-if-the-computer-can-run-hyper-v-virtual-machines/">如何查看自己的Win10电脑是否能运行Hyper-V虚拟机</a></p></blockquote><blockquote><p>查看 Hyper-V 固件中启用的虚拟化是否开启的步骤：Win + R 输入 “msinfo32 ” 即可看到“系统信息”窗口。<br>进入 bios 开启固件虚拟化的方法步骤：进入 bios 设置界面，切换到 Advanced 标签，选中 CPU Configuration 设置 Intel Virtualization Technology 为 Enabled。（不同的主板可能会有不同的设置方法，主要是将 Intel Virtualization Technology 设置为 Enabled 即可）</p></blockquote><ol start="4"><li>再次打开【启用或关闭 windows 功能界面】开启 Hyper-V 所有选项。<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0aded33529879bf5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="不管怎样，主要的步骤是开启 Hyper-V 所有选项"></li></ol><ul><li><h3 id="下载-Docker-Desktop-for-Windows-desktop-app"><a href="#下载-Docker-Desktop-for-Windows-desktop-app" class="headerlink" title="下载 Docker Desktop for Windows desktop app"></a>下载 Docker Desktop for Windows desktop app</h3></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f853b71da33b32c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="官方文档详细步骤"></p><ol><li><p>下载 Docker Desktop for Windows app</p><blockquote><p><a href="https://download.docker.com/win/stable/Docker%20for%20Windows%20Installer.exe">Docker Desktop Installer.exe 下载安装地址</a></p></blockquote></li><li><p>下载完成之后，直接双击安装<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-901ae0bb45645f92.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="安装过程图01"></p></li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-922d3317a0152afc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="安装过程图02"></p><ol start="3"><li><p>开启 docker<br>直接可以通过小娜助手搜 docker 关键词，然后启动 Docker Desktop，不管怎样，主要是找到 Docker Desktop 应用，打开就好。<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e6b8377c984ee245.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="本图通过小娜助手搜 docker 关键词打开"></p></li><li><p>查看 docker 开启状态。<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-54e121b6e4f24813.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="桌面右下角会出现 docker 的图标，鼠标移到图标上面会出现 Docker Desktop is running 字样，即为打开"></p></li></ol><blockquote><p>初次安装时，可能会提示你登录 docker 的账号，如果没有 docker 账号的话，可以去 docker 官网注册一下。</p></blockquote><ol start="5"><li>测试安装。<br>任意位置打开 Windows PowerShell<pre class="line-numbers language-none"><code class="language-none">// 查看 docker 版本docker --version docker-compose --versiondocker run hello-world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e644b75b3cb1da7b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="使用 PowerShell 和 cmd是一样的"></li></ol><ul><li><h3 id="使用-laradock-搭建项目"><a href="#使用-laradock-搭建项目" class="headerlink" title="使用 laradock 搭建项目"></a>使用 laradock 搭建项目</h3></li></ul><ol><li>将 laradock 项目代码克隆到本地：<pre class="line-numbers language-none"><code class="language-none">git clone https://github.com/Laradock/laradock.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-22cb4a41faae8ed0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="下载 laradock 项目到本地"></p><ol start="2"><li>进入 <code>laradock</code> 目录将 <code>env-example</code> 复制一份并命名为 <code>.env</code><pre class="line-numbers language-none"><code class="language-none">cp env-example .env<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-2ba18bf82bcb896a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="复制配置文件"></p><ol start="3"><li>运行容器 （此时在 laradock 目录下）<pre class="line-numbers language-none"><code class="language-none">docker-compose up -d nginx mysql redis workspace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>如果指定端口已经被占用，运行上述命令会报错，关闭相应的服务再重新运行上述命令即可。</li></ol><blockquote><p>注：安装过程中，由于某些资源需要翻墙才能下载，建议安装并启用 VPN 后再执行上述命令。如果出现需要认证的下载资源无权下载，可以通过 Docker ID/密码 登录到 Docker 应用（点击状态栏 Docker 应用小图标就能看到登录菜单），注意这里必须用 Docker ID，不能用注册邮箱。在 Windows 下如果出现目录挂载失败，可以尝试在 Docker 设置中重新设置 Shared Drives。</p></blockquote><ol start="4"><li><p>打开项目的 <code>.env</code> 文件并添加如下配置：</p><pre class="line-numbers language-none"><code class="language-none">DB_HOST=mysqlREDIS_HOST=redisQUEUE_HOST=beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>在和 laradock 同级目录下新建 wwwroot 目录，用于存放代码<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ec64df8bf3dd4e16.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建 wwwroot 目录"></p></li></ol><p>新建 demo 文件夹，并写入 phpinfo(); 到 index.php 作为测试。<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-95be36bbd3077799.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建测试文件"></p><ol start="6"><li>此时需要再次在 <code>.env</code> 文件中修改 <code>APPLICATION</code> 配置项（新版本的 laradock 对应的配置项是 <code>APP_CODE_PATH_HOST</code>）</li></ol><pre class="line-numbers language-none"><code class="language-none">APPLICATION=../wwwroot/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-826d4ee6853f37e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配置项目路径"></p><p>这样就相当于为 wwwroot 与 Docker 的 /var/www 目录建立了软连接，然后我们修改 nginx 的配置文件，建立映射关系。</p><pre class="line-numbers language-none"><code class="language-none">// 复制一份配置文件 demo.confcp ./laradock/nginx/sites/default.conf ./laradock/nginx/sites/demo.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>修改成以下内容</p><pre class="line-numbers language-none"><code class="language-none">server {    listen 80;    listen [::]:80;    server_name demo.test;    root /var/www/demo;    index index.php index.html index.htm;    location / {         try_files $uri $uri/ /index.php$is_args$args;    }    location ~ \.php$ {        try_files $uri /index.php =404;        fastcgi_pass php-upstream;        fastcgi_index index.php;        fastcgi_buffers 16 16k;        fastcgi_buffer_size 32k;        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;        #fixes timeouts        fastcgi_read_timeout 600;        include fastcgi_params;    }    location ~ /\.ht {        deny all;    }    location /.well-known/acme-challenge/ {        root /var/www/letsencrypt/;        log_not_found off;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重启 Docker 的 Nginx</p><pre class="line-numbers language-none"><code class="language-none">docker-compose up -d nginx <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="7"><li><p>在 hosts 文件中添加 （Windows 下对应文件路径是 <code>C:\Windows\System32\drivers\etc\hosts</code>）</p><pre class="line-numbers language-none"><code class="language-none">127.0.0.1 demo.test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>在浏览器中访问 demo.test<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-af86d3cc7ce05b58.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="如图所示，则表示 php 环境搭建成功！"></p></li><li><p>安装多项目。比如搭建 laravel 项目<br>在 wwwroot 目录下执行 composer 命令 （需要提前在 Windows 环境中安装 composer）<br>可以查看我写的这篇文章 <a href="https://www.jianshu.com/p/8eea56dbd246">Windows安装composer</a></p></li></ol><pre class="line-numbers language-none"><code class="language-none">composer create-project laravel/laravel blog --prefer-dist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0a826d3e36db460a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="搭建 laravel 项目 blog"></p><p>目录结构如下：<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5a4382fac6349a5b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="项目都在 wwwroot 目录下"></p><ol start="10"><li><p>添加 nginx 配置文件追加 hosts 配置<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-cea8ec0325dba714.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="重新复制一份 default.conf 配置文件，并作相应的配置修改"></p></li><li><p>重启 docker 中的 nginx</p><pre class="line-numbers language-none"><code class="language-none">docker-compose up -d nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>彩蛋</p></li></ol><ul><li>进入Workspace 容器, 执行比如(Artisan, Composer, PHPUnit, Gulp, …)等命令</li></ul><pre class="line-numbers language-none"><code class="language-none">docker-compose exec workspace bash 或者 docker exec -it laradock_workspace_1 bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>列出正在运行中的容器</li></ul><pre class="line-numbers language-none"><code class="language-none">docker ps<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>关闭所有正在运行的容器</li></ul><pre class="line-numbers language-none"><code class="language-none">docker-compose stop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>进入 mysql 容器</li></ul><pre class="line-numbers language-none"><code class="language-none">docker-compose exec mysql bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>退出容器</li></ul><pre class="line-numbers language-none"><code class="language-none">exit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Laradock </tag>
            
            <tag> Laravel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Laradock 笔记</title>
      <link href="posts/17c35873.html"/>
      <url>posts/17c35873.html</url>
      
        <content type="html"><![CDATA[<h1 id="laradock-笔记"><a href="#laradock-笔记" class="headerlink" title="laradock 笔记"></a>laradock 笔记</h1><ul><li><a href="http://laradock.io/documentation/">官方文档</a></li><li><a href="https://laradock.linganmin.cn/zh/getting-started/">中文文档</a></li></ul><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><ol><li>首先将 Laradock 项目代码克隆到本地：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/Laradock/laradock.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>进入 laradock 目录将 env-example 重命名为 .env：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> env-example .env<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后在 .env 中修改镜像构建过程中 Linux 软件源为国内镜像以免镜像构建过程中出现网络超时问题：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">CHANGE_SOURCE<span class="token comment"># If you need to change the sources (i.e. to China), set CHANGE_SOURCE to true</span><span class="token assign-left variable">CHANGE_SOURCE</span><span class="token operator">=</span>true<span class="token comment"># Set CHANGE_SOURCE and UBUNTU_SOURCE option if you want to change the Ubuntu system sources.list file.</span><span class="token assign-left variable">UBUNTU_SOURCE</span><span class="token operator">=</span>aliyun<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>构建镜像 &amp; 启动容器：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> nginx mysql redis beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>nginx 镜像构建在 php-fpm 之上，php-fpm 构建在 workspace 之上，所以启动 nginx 会先启动 workspace 和 php-fpm。</p><p>如果指定端口已经被占用，运行上述命令会报错，关闭相应的服务再重新运行上述命令即可。</p><p>如果在 Windows 系统中上述指令构建镜像过程中报错：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/tmp/sources.sh: not found<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可参考这个 issue 解决：<a href="https://github.com/laradock/laradock/issues/2450%E3%80%82">https://github.com/laradock/laradock/issues/2450。</a></p><ol start="4"><li>打开 Laravel 项目的 .env 文件并添加如下配置：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">DB_HOST</span><span class="token operator">=</span>mysql<span class="token comment"># 这里填写容器的名称（比如：laradock_redis_1）或者容器的 ip 地址（比如：172.28.0.5）也可以</span><span class="token assign-left variable">REDIS_HOST</span><span class="token operator">=</span>redis<span class="token assign-left variable">QUEUE_HOST</span><span class="token operator">=</span>beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><ul><li>构建镜像 &amp; 启动容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> nginx mysql redis beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><a href="https://laradock.linganmin.cn/zh/documentation/#%E6%9E%84%E5%BB%BA%E6%88%96%E9%87%8D%E6%9E%84%E5%AE%B9%E5%99%A8">重新构建容器</a></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 比如：重新构建 mysql 容器</span><span class="token function">docker-compose</span> build mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>增加一个项目之后,重启 Docker 的 nginx</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>列出容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出正在运行的容器</span><span class="token function">docker</span> <span class="token function">ps</span><span class="token comment"># 如果你只想看当前这个项目的容器，你也可以执行下面这个命令</span><span class="token function">docker-compose</span> <span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>重启当前这个项目中的所有容器（如果你不想一个一个的开启每一个容器，可以方便的执行这条命令）</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>关闭容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 关闭所有正在运行的容器</span><span class="token function">docker-compose</span> stop<span class="token comment"># 停止单个容器</span><span class="token function">docker-compose</span> stop <span class="token punctuation">{</span>container-name<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>进入容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用下面的命令进入任意容器</span><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> <span class="token punctuation">{</span>container-name<span class="token punctuation">}</span> <span class="token function">bash</span><span class="token comment"># 进入 mysql 容器</span><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> mysql <span class="token function">bash</span><span class="token comment"># 进入 mysql 并在 mysql 容器中使用命令提示符</span><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> mysql mysql <span class="token parameter variable">-u</span> homestead <span class="token parameter variable">-psecret</span><span class="token comment"># 进入 workspace 容器,执行比如(Artisan, Composer, PHPUnit, Gulp, ...)等命令</span><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> workspace <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>删除所有现有容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> down<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看日志文件<br>NGINX 日志文件存储在logs/nginx目录中<br>但是要查看其他容器（Mysql，PHP-FPM,…）的日志，可以运行以下命令</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> logs <span class="token punctuation">{</span>container-name<span class="token punctuation">}</span><span class="token function">docker-compose</span> logs <span class="token parameter variable">-f</span> <span class="token punctuation">{</span>container-name<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="在-laradock-中安装-swoole"><a href="#在-laradock-中安装-swoole" class="headerlink" title="在 laradock 中安装 swoole"></a>在 laradock 中安装 swoole</h2><p>在本地安装的话，以 Laradock 为例，需要在 laradock 目录下的 .env 中将下面两行配置值设置为 true：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">WORKSPACE_INSTALL_SWOOLE</span><span class="token operator">=</span>true<span class="token assign-left variable">PHP_FPM_INSTALL_SWOOLE</span><span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后运行 <code>docker-compose build php-fpm workspace</code> 重新构建 Docker 容器，构建完成后重启这两个容器，进入 workspace 容器，运行 <code>php -m</code> 查看 Swoole 是否安装成功，如果扩展列表包含 swoole 则表示安装成功。</p><h2 id="其他需要注意事项"><a href="#其他需要注意事项" class="headerlink" title="其他需要注意事项"></a>其他需要注意事项</h2><h3 id="在-laravel-框架中，如果配置不生效，请注意清理下-laravel-的缓存"><a href="#在-laravel-框架中，如果配置不生效，请注意清理下-laravel-的缓存" class="headerlink" title="在 laravel 框架中，如果配置不生效，请注意清理下 laravel 的缓存"></a>在 <code>laravel</code> 框架中，如果配置不生效，请注意清理下 <code>laravel</code> 的缓存</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan config:clear<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="检查下是否开启了-5200-端口"><a href="#检查下是否开启了-5200-端口" class="headerlink" title="检查下是否开启了 5200 端口"></a>检查下是否开启了 5200 端口</h3><blockquote><p>安装 netstat 命令，查看端口<br>apt-get update<br>apt-get install net-tools<br>netstat -ntlp</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">netstat</span> <span class="token parameter variable">-ant</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">5200</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="端口映射开启方式"><a href="#端口映射开启方式" class="headerlink" title="端口映射开启方式"></a>端口映射开启方式</h3><ol><li>进入 <code>laradock/docker-compose.yml</code></li></ol><p>在 <code>workspace</code> 下的 <code>ports</code> 中新增</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ports:  - <span class="token string">"<span class="token variable">${WORKSPACE_SSH_PORT}</span>:22"</span>  - <span class="token string">"<span class="token variable">${WORKSPACE_VUE_CLI_SERVE_HOST_PORT}</span>:8080"</span>  - <span class="token string">"<span class="token variable">${WORKSPACE_VUE_CLI_UI_HOST_PORT}</span>:8000"</span>  - <span class="token string">"<span class="token variable">${WORKSPACE_PORT}</span>:5200"</span>     /**这一行为新增的行，也可以直接在这里加 <span class="token number">5200</span>:5200 这样加了之后，就不再需要在 .env 中设置变量了**/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>进入 <code>.env</code> 在 <code>WORKSPACE</code> 下最后一行增加</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">WORKSPACE_AST_VERSION</span><span class="token operator">=</span><span class="token number">1.0</span>.3<span class="token assign-left variable">WORKSPACE_VUE_CLI_SERVE_HOST_PORT</span><span class="token operator">=</span><span class="token number">8080</span><span class="token assign-left variable">WORKSPACE_VUE_CLI_UI_HOST_PORT</span><span class="token operator">=</span><span class="token number">8001</span><span class="token assign-left variable">WORKSPACE_INSTALL_GIT_PROMPT</span><span class="token operator">=</span>false<span class="token assign-left variable">WORKSPACE_PORT</span><span class="token operator">=</span><span class="token number">5200</span>  /**这一行为新增的行，其实就是设置步骤 <span class="token number">1</span> 中的变量**/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>有些博客说还需要在 laradock/workspace/Dockerfile 文件的最后添加一行，申明开放端口： EXPOSE 5200，这里，我并没有做这一步，同样也成功了，如果你没有成功，你加上去之后再试试看吧</p></blockquote><ol start="3"><li>强制重新创建 workspace 容器</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> --force-recreate workspace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>重启 <code>docker-compose</code></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> restart <span class="token function">docker</span> <span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="5"><li>测试端口是否开通成功</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">telnet <span class="token number">127.0</span>.0.1 <span class="token number">5200</span><span class="token comment"># 或者直接查看容器的端口列表中是否含有你所需要开通的端口</span><span class="token function">docker</span> port <span class="token punctuation">{</span>container-name<span class="token punctuation">}</span><span class="token comment"># 比如，如下</span><span class="token function">docker</span> port laradock_workspace_1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Laradock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker 常见命令</title>
      <link href="posts/59b529b7.html"/>
      <url>posts/59b529b7.html</url>
      
        <content type="html"><![CDATA[<h1 id="docker-常见命令"><a href="#docker-常见命令" class="headerlink" title="docker 常见命令"></a>docker 常见命令</h1><ul><li>查看版本</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看详细版本</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看 docker 基本信息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> info<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h2 id="镜像相关的命令"><a href="#镜像相关的命令" class="headerlink" title="镜像相关的命令"></a>镜像相关的命令</h2><p>镜像仓库地址：<a href="https://hub.docker.com/">https://hub.docker.com</a></p><ul><li>查看本地已经安装的镜像</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> images<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>搜索指定镜像</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> search <span class="token operator">&lt;</span>image-name<span class="token operator">&gt;</span><span class="token comment"># 比如搜索 centos 镜像</span><span class="token function">docker</span> search centos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>拉取镜像</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull <span class="token operator">&lt;</span>image-name<span class="token operator">&gt;</span><span class="token comment"># 比如拉取 centos 镜像（将会拉取最新版本的镜像，即 latest 版本）</span><span class="token function">docker</span> pull centos<span class="token comment"># 拉取指定版本的镜像</span><span class="token function">docker</span> pull ubuntu:16.04<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>删除镜像</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> rmi <span class="token operator">&lt;</span>image-name<span class="token operator">&gt;</span><span class="token comment"># 比如删除 centos 镜像</span><span class="token function">docker</span> rmi centos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>删除所有的镜像</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> rmi <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> images <span class="token parameter variable">-q</span><span class="token variable">)</span></span><span class="token comment"># 查看所有镜像的镜像 id</span><span class="token function">docker</span> images <span class="token parameter variable">-q</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>更新镜像</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 更新镜像前，需要使用镜像创建一个容器</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> ubuntu:15.10 <span class="token function">bash</span><span class="token comment"># 在运行的容器内部使用 apt-get update 更新</span><span class="token comment"># 更新完毕之后，输入 exit 命令退出容器</span><span class="token comment"># 使用 docker commit 来提交容器副本</span><span class="token function">docker</span> commit <span class="token parameter variable">-m</span><span class="token operator">=</span><span class="token string">"has update"</span> <span class="token parameter variable">-a</span><span class="token operator">=</span><span class="token string">"alex"</span> e218edb10161 alex/ubuntu:v2<span class="token comment"># -m 表示提交的描述信息</span><span class="token comment"># -a 表示提交的镜像作者</span><span class="token comment"># e218edb10161 表示容器的 id</span><span class="token comment"># alex/ubuntu:v2 表示指定要创建的目标镜像名</span><span class="token comment"># 查看新的镜像</span><span class="token function">docker</span> images<span class="token comment"># 使用新镜像 alex/ubuntu:v2 来启动一个容器</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> alex/ubuntu:v2 <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>构建镜像</li></ul><ol><li>vim  ~/glory/codes/book/demo/Dockerfile 填充以下内容，构建一个 centos 8 系统</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 指定使用哪个镜像源</span>FROM centos:8<span class="token comment"># 如果写了 3 次 RUN 那么将会在 docker 上新建 3 层，会导致镜像膨胀过大，下面这种方式只会创建 1 层镜像</span>RUN /bin/echo <span class="token string">'root:123456'</span> <span class="token operator">|</span> chpasswd<span class="token punctuation">;</span> <span class="token punctuation">\</span><span class="token function">useradd</span> alex<span class="token punctuation">;</span> <span class="token punctuation">\</span>/bin/echo <span class="token string">'alex:123456'</span> <span class="token operator">|</span> chpasswd<span class="token punctuation">;</span> <span class="token punctuation">\</span>/bin/echo <span class="token parameter variable">-e</span> <span class="token string">"LANG=<span class="token entity" title="\&quot;">\"</span>en_US.UTF-8<span class="token entity" title="\&quot;">\"</span>"</span> <span class="token operator">&gt;</span> /etc/default/localEXPOSE <span class="token number">22</span>EXPOSE <span class="token number">80</span>CMD /usr/sbin/sshd <span class="token parameter variable">-D</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>开始构建镜像，注意不要在 <code>~/glory/codes/book/demo</code> 目录下放无用的文件，因为会打包所有该目录下的文件然后发送给 docker 引擎，如果文件过多会造成 build 过程缓慢</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -t 表示指定要创建的目标镜像名</span><span class="token comment"># ~/glory/codes/book/demo 表示 Dockerfile 文件所在的目录</span><span class="token function">docker</span> build <span class="token parameter variable">-t</span> alex/centos:8.0 ~/glory/codes/book/demo<span class="token comment"># 查看已经构建好的镜像信息</span><span class="token function">docker</span> images<span class="token comment"># 使用新的镜像来创建新容器</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> alex/centos:8.0 <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>设置镜像标签</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 先查看镜像</span>$ <span class="token function">docker</span> images                                                                   REPOSITORY            TAG                       IMAGE ID       CREATED          SIZEalex/centos           <span class="token number">8.0</span>                       594ab4747ed4   <span class="token number">14</span> minutes ago   210MB<span class="token comment"># 设置镜像标签</span>$ <span class="token function">docker</span> tag 594ab4747ed4 alex1/centos1:8.1.1<span class="token comment"># 再次查看镜像信息会多一个标签</span>$ <span class="token function">docker</span> imagesREPOSITORY            TAG                       IMAGE ID       CREATED          SIZEalex/centos           <span class="token number">8.0</span>                       594ab4747ed4   <span class="token number">14</span> minutes ago   210MBalex1/centos1         <span class="token number">8.1</span>.1                     594ab4747ed4   <span class="token number">14</span> minutes ago   210MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="容器相关的命令"><a href="#容器相关的命令" class="headerlink" title="容器相关的命令"></a>容器相关的命令</h2><ul><li>查看容器的系统版本信息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进入容器后执行</span><span class="token function">cat</span> /proc/version<span class="token comment"># 比如会输出以下内容</span>Linux version <span class="token number">4.19</span>.121-linuxkit <span class="token punctuation">(</span>root@18b3f92ade35<span class="token punctuation">)</span> <span class="token punctuation">(</span>gcc version <span class="token number">9.2</span>.0 <span class="token punctuation">(</span>Alpine <span class="token number">9.2</span>.0<span class="token punctuation">))</span> <span class="token comment">#1 SMP Thu Jan 21 15:36:34 UTC 2021</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看所有的容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span><span class="token comment"># 或者使用以下命令，是一样的效果</span><span class="token function">docker</span> container <span class="token function">ls</span> <span class="token parameter variable">-a</span><span class="token comment"># 查看最后一次创建的容器</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-l</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看所有已经运行的容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看容器端口映射</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> port <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看 docker 底层信息（比如：查看指定容器的 ip 地址）</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 docker 容器的配置和状态信息</span><span class="token function">docker</span> inspect <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span> <span class="token comment"># 查看容器的 ip 地址</span><span class="token function">docker</span> inspect <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token function">grep</span> IPAddress<span class="token comment"># 比如查看容器 id 为 66204be9fe65 的容器所对应的 ip 地址</span><span class="token function">docker</span> inspect 66204be9fe65 <span class="token operator">|</span> <span class="token function">grep</span> IPAddress<span class="token comment"># 比如查看容器名称为 alex 所对应的 ip 地址</span><span class="token function">docker</span> inspect alex <span class="token operator">|</span> <span class="token function">grep</span> IPAddress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建容器并把镜像恢复到容器当中，且启动容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token punctuation">[</span>-i<span class="token punctuation">]</span><span class="token punctuation">[</span>-t<span class="token punctuation">]</span><span class="token punctuation">[</span>-v<span class="token punctuation">]</span><span class="token punctuation">[</span>--name<span class="token punctuation">]</span><span class="token punctuation">[</span>-d<span class="token punctuation">]</span><span class="token punctuation">[</span>-p<span class="token punctuation">]</span><span class="token comment"># -i 表示 interactive 交互式</span><span class="token comment"># -t 表示得到一个 terminal</span><span class="token comment"># --name 表示修改容器名称</span><span class="token comment"># -d 表示以守护进程的方式运行（默认不会进入容器，想要进入容器则需要使用 docker exec 命令）</span><span class="token comment"># -p 表示 **指定** 映射端口</span><span class="token comment"># -P （大写的字母 p ） 表示 **随机** 映射端口</span><span class="token comment"># /bin/bash 和 bash 等效</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>image-name<span class="token operator">&gt;</span> /bin/bash<span class="token comment"># 比如创建一个新容器并且进入 ubuntu:16.04 镜像</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> ubuntu:16.04 <span class="token function">bash</span><span class="token comment"># 或者</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> ubuntu:16.04 /bin/bash<span class="token comment"># 或者</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> ubuntu:16.04<span class="token comment"># 以 centos 镜像创建一个新容器，并修改新容器名称为 alex-container</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span> alex-container centos <span class="token function">bash</span>  <span class="token comment"># 以守护进程的方式运行 （后台运行）</span><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> alex-container centos  <span class="token comment"># 或者</span><span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">--name</span> alex-container centos<span class="token comment"># 指定容器绑定的网络地址，这样我们就可以通过访问 127.0.0.1:5001 来访问容器的 5000 端口（默认绑定的都是 tcp 端口）</span><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">127.0</span>.0.1:5001:5000 centos:8.0 <span class="token function">bash</span><span class="token comment"># 如果需要绑定 udp 端口，则</span><span class="token comment"># （还可以进入容器就直接执行 python app.py 命令）</span><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">127.0</span>.0.1:5001:5000/udp centos:8.0 python app.py<span class="token comment"># 比如，安装 hyperf 镜像并启动容器</span><span class="token comment"># 如果 docker 启动时开启了 selinux-enabled 选项，容器内访问宿主机资源就会受限，所以启动容器时可以增加 --privileged -u root 选项</span><span class="token function">docker</span> run <span class="token parameter variable">--name</span> hyperf <span class="token punctuation">\</span><span class="token parameter variable">-v</span> /workspace/skeleton:/data/project <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9501</span>:9501 <span class="token parameter variable">-it</span> <span class="token punctuation">\</span><span class="token parameter variable">--privileged</span> <span class="token parameter variable">-u</span> root <span class="token punctuation">\</span><span class="token parameter variable">--entrypoint</span> /bin/sh <span class="token punctuation">\</span>hyperf/hyperf:7.4-alpine-v3.11-swoole<span class="token comment"># 如果需要开通多个端口时，可以参考</span><span class="token function">docker</span> run <span class="token parameter variable">--name</span> api_dfo_hyperf_ws <span class="token punctuation">\</span><span class="token parameter variable">-v</span> /Users/pudongping/glory/codes/dfo/api_dfo_hyperf:/api_dfo_hyperf <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9502</span>:9502 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9503</span>:9503 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9504</span>:9504 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9505</span>:9505 <span class="token parameter variable">-it</span> <span class="token punctuation">\</span><span class="token parameter variable">--entrypoint</span> /bin/sh <span class="token punctuation">\</span>alex/alex_api_dfo:v1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>启动容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> start <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span><span class="token comment"># 比如启动容器名称为 redis-alex 的容器</span><span class="token function">docker</span> start redis-alex<span class="token comment"># 比如启动容器 id 为 c8c0c770ac5b 的容器</span><span class="token function">docker</span> start c8c0c770ac5b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>直接进入已经创建的容器（不会启动容器）</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> start <span class="token parameter variable">-i</span> <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span><span class="token comment"># 比如进入容器 id 为 66204be9fe65 的容器</span><span class="token function">docker</span> start <span class="token parameter variable">-i</span> 66204be9fe65<span class="token comment"># 比如进入容器名称为 alex 的容器</span><span class="token function">docker</span> start <span class="token parameter variable">-i</span> alex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>重启容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> restart <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span><span class="token comment"># 比如重启容器名称为 redis-alex 的容器</span><span class="token function">docker</span> restart redis-alex<span class="token comment"># 比如重启容器 id 为 c8c0c770ac5b 的容器</span><span class="token function">docker</span> restart c8c0c770ac5b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>进入已经运行中的容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span> <span class="token function">bash</span><span class="token comment"># 比如进入容器名称为 redis-alex 的容器</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-alex <span class="token function">bash</span><span class="token comment"># 比如进入容器 id 为 c8c0c770ac5b 的容器</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> c8c0c770ac5b <span class="token function">bash</span><span class="token comment"># 进入容器之后执行 shell 命令或者执行 shell 脚本</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span>  <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span> /bin/sh <span class="token parameter variable">-c</span> <span class="token string">"while true; do echo hello world; sleep 1; done"</span><span class="token comment"># 比如进入容器 id 为 c8c0c770ac5b 的容器，并且进入容器后执行 `bash /portal_api_dfo_hyperf/server.sh restart` 脚本</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> c8c0c770ac5b /bin/sh <span class="token parameter variable">-c</span> <span class="token string">"bash /portal_api_dfo_hyperf/server.sh restart"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>停止容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> stop <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span><span class="token comment"># 比如停止容器名称为 redis-alex 的容器</span><span class="token function">docker</span> stop redis-alex<span class="token comment"># 比如停止容器 id 为 c8c0c770ac5b 的容器</span><span class="token function">docker</span> stop c8c0c770ac5b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>退出容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">exit</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>删除容器</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">rm</span> <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span><span class="token comment"># 也可以加入 -f 参数，强制移除正在运行中的容器</span><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> 1e560fca3906<span class="token comment"># 清理掉所有处于终止状态的容器</span><span class="token function">docker</span> container prune<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>修改容器名称</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">rename</span> <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>new-container-name<span class="token operator">&gt;</span><span class="token comment"># 比如将容器 redis-alex 改名为 redis-tt</span><span class="token function">docker</span> <span class="token function">rename</span> redis-alex redis-tt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看容器的标准输出</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> logs <span class="token operator">&lt;</span>container-name or container-id<span class="token operator">&gt;</span><span class="token comment"># 比如查看容器 id 为 c8c0c770ac5b 的容器标准输出内容</span><span class="token function">docker</span> logs c8c0c770ac5b<span class="token comment"># 也可以加入 -f 参数，像使用 tail -f 一样来输出容器内部的标准输出</span><span class="token function">docker</span> logs <span class="token parameter variable">-f</span> c8c0c770ac5b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="容器与宿主机之间的文件或者目录拷贝"><a href="#容器与宿主机之间的文件或者目录拷贝" class="headerlink" title="容器与宿主机之间的文件或者目录拷贝"></a>容器与宿主机之间的文件或者目录拷贝</h2><ul><li>从宿主机拷贝文件到容器中</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">cp</span> <span class="token operator">&lt;</span>local-directory-or-file<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>container-name<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>container-directory-or-file<span class="token operator">&gt;</span><span class="token comment"># 比如将宿主机中的 /home/alex/test.txt 文件拷贝到 centos1 容器中的 /test.txt</span><span class="token function">docker</span> <span class="token function">cp</span> /home/alex/test.txt centos1:/test.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>从容器拷贝到宿主机中</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">cp</span> <span class="token operator">&lt;</span>container-name<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>container-directory-or-file<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>local-directory<span class="token operator">&gt;</span><span class="token comment"># 比如将 centos1 容器中的 /test 目录拷贝到宿主机的 /home/alex 目录下</span><span class="token function">docker</span> <span class="token function">cp</span> centos1:/test /home/alex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="目录挂载（创建容器的时候就需要进行目录挂载）"><a href="#目录挂载（创建容器的时候就需要进行目录挂载）" class="headerlink" title="目录挂载（创建容器的时候就需要进行目录挂载）"></a>目录挂载（创建容器的时候就需要进行目录挂载）</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">-v</span> <span class="token operator">&lt;</span>local-directory<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>container-directory<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>image-name<span class="token operator">&gt;</span><span class="token comment"># 在 windows 下挂载（注意路径的书写方式）</span><span class="token comment"># 比如以 centos 镜像创建一个容器，并将本地 D 盘中的 alex 目录，挂载到容器中的 /usr/local/demo 目录</span><span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">-v</span> d:<span class="token punctuation">\</span>alex:/usr/local/demo centos<span class="token comment"># 在 linux 下挂载</span><span class="token comment"># 比如以 centos 镜像创建一个容器，并将本地的 /home/alex/alex 目录，挂载到容器中的 /usr/local/demo 目录</span><span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">-v</span> /home/alex/alex:/usr/local/demo centos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="导出和导入容器"><a href="#导出和导入容器" class="headerlink" title="导出和导入容器"></a>导出和导入容器</h2><ul><li>导出容器快照</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token builtin class-name">export</span> <span class="token operator">&lt;</span>container-id<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&lt;</span>your-backup-name.tar<span class="token operator">&gt;</span><span class="token comment"># 比如将容器 id 为 7691a814370e 的容器导出快照为 alex.tar</span><span class="token function">docker</span> <span class="token builtin class-name">export</span> 7691a814370e <span class="token operator">&gt;</span> alex.tar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>导入容器快照</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;</span>your-backup-name.tar<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token function">docker</span> <span class="token function">import</span> - <span class="token operator">&lt;</span>image-author-name<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>your-new-image-name<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>your-new-image-version<span class="token operator">&gt;</span><span class="token comment"># 比如将容器快照文件 alex.tar 导入到 alex-demo 镜像并定义 alex-demo 镜像的作者为 alex，版本号为 v1.0</span><span class="token function">cat</span> alex.tar <span class="token operator">|</span> <span class="token function">docker</span> <span class="token function">import</span> - alex/alex-demo:v1.0<span class="token comment"># 此外，也可以通过指定 url 或者某个目录来导入</span><span class="token function">docker</span> <span class="token function">import</span> http://example.com/example-image.tgz example/image-repo:v1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker 环境搭建</title>
      <link href="posts/a8b7793d.html"/>
      <url>posts/a8b7793d.html</url>
      
        <content type="html"><![CDATA[<h1 id="Docker-环境搭建"><a href="#Docker-环境搭建" class="headerlink" title="Docker 环境搭建"></a>Docker 环境搭建</h1><h2 id="适用于-Ubuntu，Debian，Centos-等大部分-Linux（使用官方安装脚本自动安装）"><a href="#适用于-Ubuntu，Debian，Centos-等大部分-Linux（使用官方安装脚本自动安装）" class="headerlink" title="适用于 Ubuntu，Debian，Centos 等大部分 Linux（使用官方安装脚本自动安装）"></a>适用于 Ubuntu，Debian，Centos 等大部分 Linux（使用官方安装脚本自动安装）</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-sSL</span> https://get.daocloud.io/docker <span class="token operator">|</span> <span class="token function">sh</span><span class="token comment"># 或者执行</span><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://get.docker.com <span class="token operator">|</span> <span class="token function">bash</span> <span class="token parameter variable">-s</span> <span class="token function">docker</span> <span class="token parameter variable">--mirror</span> Aliyun<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Windows-10-系统上如果不想用-docker-则需要关闭-hyper"><a href="#Windows-10-系统上如果不想用-docker-则需要关闭-hyper" class="headerlink" title="Windows 10 系统上如果不想用 docker 则需要关闭 hyper"></a>Windows 10 系统上如果不想用 docker 则需要关闭 hyper</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cmd 命令行执行： bcdedit /set hypervisorlaunchtype offpoweroff 命令行执行： Disable-WindowsOptionalFeature <span class="token parameter variable">-Online</span> <span class="token parameter variable">-FeatureName</span> Microsoft-Hyper-V<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="关于报错"><a href="#关于报错" class="headerlink" title="关于报错"></a>关于报错</h4><ul><li>container-selinux &gt;= 2.9 解决方案</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Error: Package: docker-ce-18.03.1.ce-1.el7.centos.x86_64 <span class="token punctuation">(</span>docker-ce-edge<span class="token punctuation">)</span>           Requires: container-selinux <span class="token operator">&gt;=</span> <span class="token number">2.9</span> You could try using --skip-broken to work around the problem You could try running: <span class="token function">rpm</span> <span class="token parameter variable">-Va</span> <span class="token parameter variable">--nofiles</span> <span class="token parameter variable">--nodigest</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>这个报错是 container-selinux 版本低或者是没安装的原因<br>yum 安装 container-selinux 一般的 yum 源又找不到这个包<br>需要安装 epel 源，才能 yum 安装 container-selinux<br>然后在安装 docker-ce 就可以了。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 先配置阿里云的 yum 源</span><span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<span class="token comment"># 安装阿里云上的 epel 源</span>yum <span class="token function">install</span> epel-release<span class="token comment"># 安装 container-selinux 即可</span>yum <span class="token function">install</span> container-selinux<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试安装是否成功"><a href="#测试安装是否成功" class="headerlink" title="测试安装是否成功"></a>测试安装是否成功</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看当前 docker 版本号，出现版本号即为安装成功</span><span class="token function">docker</span> <span class="token parameter variable">-v</span><span class="token comment"># 查看详细的 docker 信息</span><span class="token function">docker</span> version<span class="token comment"># 查看当前 docker 的信息</span><span class="token function">docker</span> info<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="开启-docker-守护进程"><a href="#开启-docker-守护进程" class="headerlink" title="开启 docker 守护进程"></a>开启 docker 守护进程</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start <span class="token function">docker</span>systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span><span class="token comment"># 重载配置</span>systemctl daemon-reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="添加国内镜像源"><a href="#添加国内镜像源" class="headerlink" title="添加国内镜像源"></a>添加国内镜像源</h3><p>centos 或者 ubuntu 系统时</p><p>sudo vim /etc/docker/daemon.json</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"https://registry.docker-cn.com"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="docker-国内镜像"><a href="#docker-国内镜像" class="headerlink" title="docker 国内镜像"></a>docker 国内镜像</h3><ul><li>网易加速器：<a href="http://hub-mirror.c.163.com/">http://hub-mirror.c.163.com</a></li><li>官方中国加速器：<a href="https://registry.docker-cn.com/">https://registry.docker-cn.com</a></li><li>ustc 的镜像：<a href="https://docker.mirrors.ustc.edu.cn/">https://docker.mirrors.ustc.edu.cn</a></li></ul><h3 id="安装-docker-compose"><a href="#安装-docker-compose" class="headerlink" title="安装 docker-compose"></a>安装 docker-compose</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用源码安装（推荐方式）</span><span class="token punctuation">[</span>最新发行的版本地址<span class="token punctuation">]</span><span class="token punctuation">(</span>https://github.com/docker/compose/releases<span class="token punctuation">)</span><span class="token comment"># 安装 1.27.4 版本的 docker-compose （下载了源码，并改名为 docker-compose）</span><span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/docker/compose/releases/download/1.27.4/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">`</span></span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose<span class="token comment"># 增加执行权限</span><span class="token function">sudo</span> <span class="token function">chmod</span> u+x /usr/local/bin/docker-compose<span class="token comment"># 建立软连接到 /usr/bin 目录</span><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/bin/docker-compose /usr/bin/docker-compose<span class="token comment"># 查看 docker-compose 版本</span><span class="token function">docker-compose</span> version---------------------------------<span class="token comment"># 如果是在 centos 系统中</span><span class="token comment"># 安装扩展源</span><span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> epel-release<span class="token comment"># 安装 python-pip 模块</span><span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> python-pip<span class="token comment"># 如果是在 ubuntu 系统中</span><span class="token comment"># 安装 python-pip 模块</span><span class="token function">apt</span> <span class="token function">install</span> python-pip<span class="token comment"># 使用 pip 安装 docker-compose</span>pip <span class="token function">install</span> <span class="token function">docker-compose</span><span class="token comment"># 删除掉旧的环境变量 docker-compose</span><span class="token function">sudo</span> <span class="token function">rm</span> /usr/bin/docker-compose<span class="token function">sudo</span> <span class="token function">rm</span> /usr/local/bin/docker-compose<span class="token comment"># 或者使用 pip 命令卸载 docker-compose</span>pip uninstall <span class="token function">docker-compose</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装-redis"><a href="#安装-redis" class="headerlink" title="安装 redis"></a>安装 redis</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull redis:latest<span class="token function">docker</span> images<span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--name</span> alex-redis <span class="token parameter variable">-p</span> <span class="token number">6379</span>:6379 redis<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> alex-redis /bin/bash<span class="token comment"># 外部可以直接通过宿主机ip:6379 访问到 redis 服务</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装-mysql"><a href="#安装-mysql" class="headerlink" title="安装 mysql"></a>安装 mysql</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull mysql:5.7.33<span class="token function">docker</span> images<span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--name</span> alex-mysql <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> mysql:5.7.32<span class="token comment"># docker 容器中可以使用 localhost 或者 127.0.0.1 均可</span><span class="token comment"># 外部可以直接通过宿主机ip:3306 访问到 mysql 服务，密码为 123456</span>------------<span class="token comment"># 安装 mysql 8 时</span><span class="token function">docker</span> pull mysql:8.0.23<span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--name</span> alex-mysql <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> mysql:8.0.23<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> alex-mysql <span class="token function">bash</span><span class="token comment"># 登录 mysql</span>mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span>alter user <span class="token string">'root'</span>@<span class="token string">'localhost'</span> identified by <span class="token string">'123456'</span><span class="token punctuation">;</span><span class="token comment"># 添加远程登录用户</span>create user <span class="token string">'root'</span>@<span class="token string">'%'</span> identified with mysql_native_password by <span class="token string">'123456'</span><span class="token punctuation">;</span><span class="token comment"># 刷新权限</span>grant all privileges on *.* to <span class="token string">'root'</span>@<span class="token string">'%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS 8 安装 docker</title>
      <link href="posts/de75e5f5.html"/>
      <url>posts/de75e5f5.html</url>
      
        <content type="html"><![CDATA[<h1 id="CentOS-8-安装-docker"><a href="#CentOS-8-安装-docker" class="headerlink" title="CentOS 8 安装 docker"></a>CentOS 8 安装 docker</h1><ol><li>查看系统内核</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/redhat-release<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>eg：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">➜  Downloads <span class="token function">cat</span> /etc/redhat-releaseCentOS Linux release <span class="token number">8.2</span>.2004 <span class="token punctuation">(</span>Core<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>安装 gcc 相关</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc<span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc-c++<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>安装需要的软件包</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>添加阿里镜像仓库</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>更新 yum 索引</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum makecache<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="6"><li>CentOS8 默认使用 podman 代替 docker</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> https://download.docker.com/linux/fedora/30/x86_64/stable/Packages/containerd.io-1.2.13-3.2.fc30.x86_64.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="7"><li>安装 docker ce （社区版）</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="8"><li>启动 docker</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start  <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="9"><li>将 docker 添加到开机启动</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="10"><li>查看 docker 版本</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token parameter variable">-v</span><span class="token comment"># 或者使用 docker version 查看更加详细的版本信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>eg：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">➜  Downloads <span class="token function">docker</span> <span class="token parameter variable">-v</span>Docker version <span class="token number">20.10</span>.0, build 7287ab3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mitmproxy 抓包工具的使用</title>
      <link href="posts/cd811a58.html"/>
      <url>posts/cd811a58.html</url>
      
        <content type="html"><![CDATA[<h1 id="mitmproxy-抓包工具的使用"><a href="#mitmproxy-抓包工具的使用" class="headerlink" title="mitmproxy 抓包工具的使用"></a>mitmproxy 抓包工具的使用</h1><blockquote><p><a href="https://mitmproxy.org/">mitmproxy 官网</a><br><a href="https://github.com/mitmproxy/mitmproxy">mitmproxy GitHub</a><br><a href="https://docs.mitmproxy.org/stable/overview-installation/">mitmproxy 文档</a> </p></blockquote><p>mitmproxy 就是用于 MITM 的 proxy，MITM 即中间人攻击（Man-in-the-middle attack）。用于中间人攻击的代理首先会向正常的代理一样转发请求，保障服务端与客户端的通信，其次，会适时的查、记录其截获的数据，或篡改数据，引发服务端或客户端特定的行为。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>使用 <code>pip</code> 安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># --user 表示安装到用户的目录中去</span>pip3 <span class="token function">install</span> mitmproxy <span class="token parameter variable">--user</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>也可以直接使用 <code>homebrew</code> 安装，但是还是建议使用 <code>pip</code> 安装，且使用 <code>pipenv</code> 虚拟环境安装，方便管理依赖包。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> mitmproxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看是否安装成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用以下三个命令中的任意一个即可，这三个命令返回的结果均一致</span>mitmproxy <span class="token parameter variable">--version</span>mitmdump <span class="token parameter variable">--version</span>mitmweb <span class="token parameter variable">--version</span><span class="token comment"># Mitmproxy: 6.0.2  # mitmproxy 的版本号</span><span class="token comment"># Python:    3.8.8  # python 的版本号</span><span class="token comment"># OpenSSL:   OpenSSL 1.1.1i  8 Dec 2020  # openssl 协议</span><span class="token comment"># Platform:  macOS-10.16-x86_64-i386-64bit  # 本地电脑型号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>mitmproxy 有三种启动命令：</p><ol><li>mitmweb：提供了一个 web 页面，交互界面可以通过 <code>localhost:8081</code> 去访问。</li><li>mitmproxy：提供命令行界面，可以通过命令过滤请求。</li><li>mitmdump：可以通过执行一个 <code>python</code> 脚本去运行</li></ol><p>运行在 8888 端口上运行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mitmproxy <span class="token parameter variable">-p</span> <span class="token number">8888</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>也可以自己写一个 python 脚本，然后通过 mitmdump 去执行这个 python 脚本</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mitmdump <span class="token parameter variable">-p</span> <span class="token number">8888</span> <span class="token parameter variable">-s</span> script.py<span class="token comment"># 还可以将截获的数据保存到文件中，比如如下，保存到 outfile.txt 文件中</span>mitmdump <span class="token parameter variable">-w</span> outfile.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以通过浏览器界面去运行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mitmweb <span class="token parameter variable">-p</span> <span class="token number">8888</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="手机端配置"><a href="#手机端配置" class="headerlink" title="手机端配置"></a>手机端配置</h2><ol><li>将手机和电脑连接到同一个 Wi-Fi 中。</li><li>然后找到电脑的 ip 地址，比如我这里是：192.168.0.101</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># macOS 下可通过以下命令查看</span><span class="token function">ifconfig</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"inet"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>给手机 Wi-Fi 配置代理。</li></ol><blockquote><p>这里以 iPhone 作为演示讲解。</p></blockquote><p>在手机上找到 Wi-Fi 设置，点进去，选择 <code>配置代理</code>，改为 <code>手动</code>，修改 <code>服务器</code> 这一项，改为电脑的 ip 地址，比如我这里是 192.168.0.101，端口改成 8888，然后点右上角的 <code>存储</code>，之后在浏览器中访问 <code>mitm.it</code> 链接地址（建议使用 iPhone 自带的 Safari 浏览器），选择你自己的机型对应的 <code>Get mitmproxy-ca-cert.pem</code> 进行下载（我这里选择的是 Apple），然后去 <strong>设置-通用-描述文件</strong> 中找到刚刚下载的描述文件进行安装。</p><ol start="4"><li>开启证书</li></ol><p>打开 <strong>设置-通用-关于本机-证书信任设置</strong>，开启 mitmproxy 证书。现在就可以打开任意一个 app 尝试一下抓包啦！</p><h2 id="关闭-mitmproxy"><a href="#关闭-mitmproxy" class="headerlink" title="关闭 mitmproxy"></a>关闭 mitmproxy</h2><p>电脑端可以直接按 <code>Ctrl+c</code> 退出 mitmproxy，手机端需要关闭掉刚刚对 Wi-Fi 设置的代理。</p><h2 id="使用-mitmproxy-命令行运行-mitmproxy-时的快捷键"><a href="#使用-mitmproxy-命令行运行-mitmproxy-时的快捷键" class="headerlink" title="使用 mitmproxy 命令行运行 mitmproxy 时的快捷键"></a>使用 mitmproxy 命令行运行 mitmproxy 时的快捷键</h2><table><thead><tr><th>快捷键</th><th>说明</th></tr></thead><tbody><tr><td>j/k</td><td>上下移动</td></tr><tr><td>tab 或者方向键</td><td>进行界面切换</td></tr><tr><td>z</td><td>清屏</td></tr><tr><td>f</td><td>用来过滤请求地址</td></tr><tr><td>q</td><td>退出当前界面</td></tr></tbody></table><p>script.py 示例</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json<span class="token keyword">import</span> re<span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>    flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'User-Agent'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'MitmProxy'</span>  <span class="token comment"># 更改请求头</span>    ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 白色日志</span>    ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 黄色日志</span>    ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 红色日志</span>    request <span class="token operator">=</span> flow<span class="token punctuation">.</span>request    info <span class="token operator">=</span> ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info    info<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>    info<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>    info<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">)</span>    info<span class="token punctuation">(</span>request<span class="token punctuation">.</span>host<span class="token punctuation">)</span>    info<span class="token punctuation">(</span>request<span class="token punctuation">.</span>method<span class="token punctuation">)</span>    info<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>    info<span class="token punctuation">(</span>request<span class="token punctuation">.</span>scheme<span class="token punctuation">)</span>        <span class="token comment"># 可以更改请求的 url</span>    url <span class="token operator">=</span> <span class="token string">'https://httpbin.org/get'</span>    flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 提取请求的 url 地址</span>    request_url <span class="token operator">=</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求到的地址为 =====&gt; %s'</span> <span class="token operator">%</span> request_url<span class="token punctuation">)</span>    response_body <span class="token operator">=</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>text    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'返回体为 ====&gt; %s'</span> <span class="token operator">%</span> response_body<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> mitmproxy </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> mitmproxy </tag>
            
            <tag> 抓包工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 下安装 php7.2</title>
      <link href="posts/98509b56.html"/>
      <url>posts/98509b56.html</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu-下安装-php7-2"><a href="#Ubuntu-下安装-php7-2" class="headerlink" title="Ubuntu 下安装 php7.2"></a>Ubuntu 下安装 php7.2</h1><ol><li>安装软件源拓展工具：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> software-properties-common python-software-properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>更新软件源缓存并且添加 <code>Ondřej Surý</code> 的 <code>PHP PPA</code> 源，需要按一次回车：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> add-apt-repository ppa:ondrej/php <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>安装 php7.2</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> php7.2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>如果之前有其他版本PHP，在这边禁用掉</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 禁用掉 php5.6 的版本</span><span class="token function">sudo</span> a2dismod php5.6<span class="token comment"># 开启 php7.2 的版本</span><span class="token function">sudo</span> a2enmod php7.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>安装 php7.2 常用扩展</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> php7.2-fpm php7.2-mysql php7.2-curl php7.2-gd php7.2-mbstring php7.2-xml php7.2-xmlrpc php7.2-zip php7.2-opcache <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看可以安装的扩展指令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-cache</span> search php7.2<span class="token comment"># 比如如下所示：</span>root@iZuf6aig35m8ho0xq75ijnZ:/<span class="token comment"># apt-cache search php7.2</span>php-amqp - AMQP extension <span class="token keyword">for</span> PHPphp-apcu - APC User Cache <span class="token keyword">for</span> PHPphp-geoip - GeoIP module <span class="token keyword">for</span> PHPphp-igbinary - igbinary PHP serializerphp-imagick - Provides a wrapper to the ImageMagick libraryphp7.2-fpm - server-side, HTML-embedded scripting language <span class="token punctuation">(</span>FPM-CGI binary<span class="token punctuation">)</span>php7.2-gd - GD module <span class="token keyword">for</span> PHPphp7.2-gmp - GMP module <span class="token keyword">for</span> PHPphp7.2-imap - IMAP module <span class="token keyword">for</span> PHP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>设置 php</li></ol><p>安装完成后，编辑 <code>/etc/php/7.2/fpm/php.ini</code> 替换成 <code>;cgi.fix_pathinfo=1</code> 为 <code>cgi.fix_pathinfo=0</code> 快捷命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接命令行输入</span><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/'</span> /etc/php/7.2/fpm/php.ini<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="7"><li>管理 php</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl restart php7.2-fpm <span class="token comment">#重启</span>systemctl start php7.2-fpm <span class="token comment">#启动</span>systemctl stop php7.2-fpm <span class="token comment">#关闭</span>systemctl status php7.2-fpm <span class="token comment">#检查状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="8"><li>重启 apache2</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> apache2 restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Ubuntu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 开放指定端口</title>
      <link href="posts/ce06863f.html"/>
      <url>posts/ce06863f.html</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu-开放指定端口"><a href="#Ubuntu-开放指定端口" class="headerlink" title="Ubuntu 开放指定端口"></a>Ubuntu 开放指定端口</h1><ul><li>一般情况下 <code>ubuntu</code> 系统自带 <code>iptables</code> 防火墙，如果没有的话，就装上</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> iptables<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>开放 tcp 协议 80 端口</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-j</span> ACCEPT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>临时保存规则</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iptables-save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>永久保存规则，需要借助 <code>iptables-persistent</code> 工具</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 iptables-persistent</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> iptables-persistent<span class="token comment"># 持久化</span><span class="token function">sudo</span> iptables-persistent save<span class="token function">sudo</span> iptables-persistent reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Ubuntu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 16.04.4 LTS 搭建 LNMP</title>
      <link href="posts/7c353a38.html"/>
      <url>posts/7c353a38.html</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu-16-04-4-LTS-搭建-LNMP"><a href="#Ubuntu-16-04-4-LTS-搭建-LNMP" class="headerlink" title="Ubuntu 16.04.4 LTS 搭建 LNMP"></a>Ubuntu 16.04.4 LTS 搭建 LNMP</h1><ul><li><h2 id="安装-mysql"><a href="#安装-mysql" class="headerlink" title="安装 mysql"></a>安装 mysql</h2></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> mysql-server mysql-client<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>测试：mysql -u root -p</p></blockquote><p>查看 Mysql 状态：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> mysql status/start/stop/retart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看监听端口的情况：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">netstat</span> <span class="token parameter variable">-tunpl</span> 或 <span class="token function">netstat</span> <span class="token parameter variable">-tap</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="如果之前有装-APACHE-要改下端口-或者直接移除-apache2"><a href="#如果之前有装-APACHE-要改下端口-或者直接移除-apache2" class="headerlink" title="如果之前有装 APACHE 要改下端口,或者直接移除 apache2"></a>如果之前有装 APACHE 要改下端口,或者直接移除 apache2</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> remove apache2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><h2 id="安装-Nginx"><a href="#安装-Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h2></li></ul><ol><li><p>为确保获取最新的 Nginx 先更新源列表（有些文档说的是更新系统）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>安装 nginx</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>检查 nginx 安装是否成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 方法01、 直接输入以下命令可以看到 nginx 的版本号</span>/usr/sbin/nginx <span class="token parameter variable">-v</span><span class="token comment"># 方法02、使用浏览器访问 IP 地址，出现 Nginx 的欢迎页面</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ol><blockquote><p>可以使用 dpkg -S nginx 命令来搜索 nginx 的相关文件<br>nginx 的配置目录位于：/etc/nginx<br>其他文档说的是 Nginx 的默认网站目录在 /usr/share/nginx/html/ 下，但是我安装的在 /var/www/html 下，和 apache2 默认的网站目录一样<br>默认Nginx网站配置文件为 /etc/nginx/sites-available/default</p></blockquote><h3 id="Nginx-其他命令"><a href="#Nginx-其他命令" class="headerlink" title="Nginx 其他命令"></a>Nginx 其他命令</h3><pre class="line-numbers language-none"><code class="language-none">/etc/init.d/nginx status|stop|start|restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Nginx-虚拟主机配置"><a href="#Nginx-虚拟主机配置" class="headerlink" title="Nginx 虚拟主机配置"></a>Nginx 虚拟主机配置</h3><ol><li><p>修改 user</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/nginx/nginx.conf<span class="token comment"># 将 user 改为 www-data 因为 php 默认是这个 user</span><span class="token comment"># 但是我看我自己的 nginx.conf 配置文件第一行直接是</span><span class="token comment"># user www-data; 因此我没有修改</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Nginx 与 php-fpm 的集成<br>这里采用UNIX domain socket方式：（这里一定要注意location的位置！！！）</p></li></ol><blockquote><p>在 /etc/nginx/sites-available/default 配置文件中（网站根目录也在是这里更改）， Nginx已经为与 PHP-FPM的整合准备好了，只需要将下面这部分改好就可以了。sock文件路径为 /run/php/php7.2-fpm.sock 。</p></blockquote><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">51</span>         location ~ \.php$</span> <span class="token punctuation">{</span><span class="token directive"><span class="token keyword">52</span>                 include snippets/fastcgi-php.conf</span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">53</span> <span class="token number">54</span>                 <span class="token comment"># With php7.0-cgi alone:</span><span class="token number">55</span>                 <span class="token comment">#fastcgi_pass 127.0.0.1:9000;</span><span class="token number">56</span>                 <span class="token comment"># With php7.0-fpm:</span><span class="token number">57</span>                 fastcgi_pass unix:/run/php/php7.2-fpm.sock</span><span class="token punctuation">;</span>58         <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>然后再修改 PHP-FPM 的配置文件 vim  /etc/php/7.2/fpm/pool.d/ <a href="http://www.conf/">www.conf</a><br>，如下：</p></blockquote><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 与 Nginx监听同一个 sock</span>36 listen = /run/php/php7.2-fpm.sock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>端口-代码映射，方法有三种：</li></ol><ul><li>方法01：在 /etc/nginx/sites-available/default 文件末尾处直接添加以下内容<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/nginx/sites-available/default<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p>提供了两种框架的配置方法</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 以下是针对 thinkphp5.0 框架配置</span><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>    <span class="token comment"># 如果希望二级域名指向同一个项目的话，直接在 server_name 后面添加即可</span>    <span class="token directive"><span class="token keyword">server_name</span>  www.drling.xin drling.xin</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">root</span>     /var/www/html/www.drling.xin/public</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">access_log</span>    /var/log/nginx/www.drling.xin_access.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">error_log</span>    /var/log/nginx/www.drling.xin_error.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">index</span> index.html index.php</span><span class="token punctuation">;</span><span class="token comment">## 在Nginx低版本中，是不支持PATHINFO的，但是可以通过在Nginx.conf中配置转发规则实现</span><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">if</span> (!-e <span class="token variable">$request_filename</span>)</span> <span class="token punctuation">{</span>                <span class="token directive"><span class="token keyword">rewrite</span> ^(.*)$ /index.php?s=<span class="token variable">$1</span> last</span><span class="token punctuation">;</span>                <span class="token directive"><span class="token keyword">break</span></span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token directive"><span class="token keyword">location</span> ~ \.php?.*$</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">fastcgi_pass</span>   unix:/run/php/php7.2-fpm.sock</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">fastcgi_param</span>  SCRIPT_FILENAME  <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">include</span>        fastcgi_params</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment"># 以下是针对 Laravel5.5 框架配置</span><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">server_name</span>  test.drling.xin</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">root</span>     /var/www/html/test.drling.xin/public</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">access_log</span>    /var/log/nginx/test.drling.xin_access.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">error_log</span>    /var/log/nginx/test.drling.xin_error.log</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">index</span> index.html index.php</span><span class="token punctuation">;</span><span class="token comment">## 如果你使用的是 Nginx，使用如下站点配置指令就可以支持 URL 美化：</span><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.php?<span class="token variable">$query_string</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span>    <span class="token directive"><span class="token keyword">location</span> ~ \.php?.*$</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">fastcgi_pass</span>   unix:/run/php/php7.2-fpm.sock</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">fastcgi_param</span>  SCRIPT_FILENAME  <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">include</span>        fastcgi_params</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>方法02、直接在 /etc/nginx/sites-available 目录下，单独写自己的项目配置文件，操作方法如下</li></ul><pre class="line-numbers language-none"><code class="language-none"># 01、比如我写的文件是 www.drling.xin 不需要写 .conf 后缀名sudo vim /etc/nginx/sites-available/www.drling.xin# 02、将以上 thinkphp5.0 的配置文件放进去# 以下是针对 thinkphp5.0 框架配置server {    listen       80;    server_name  www.drling.xin;    root     /var/www/html/www.drling.xin/public;        access_log    /var/log/nginx/www.drling.xin_access.log;    error_log    /var/log/nginx/www.drling.xin_error.log;         index index.html index.php;## 在Nginx低版本中，是不支持PATHINFO的，但是可以通过在Nginx.conf中配置转发规则实现location / {        if (!-e $request_filename) {                rewrite ^(.*)$ /index.php?s=$1 last;                break;        }}    location ~ \.php?.*$ {        fastcgi_pass   unix:/run/php/php7.2-fpm.sock;        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;        include        fastcgi_params;    }}# 03、建立软连接sudo ln -s /etc/apache2/sites-available/www.drling.xin /etc/apache2/sites-enabled/www.drling.xin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>方法03、直接在 /etc/nginx/conf.d/ 目录下写以 .conf 为后缀的配置文件</li></ul><pre class="line-numbers language-none"><code class="language-none"># 01、比如我写的文件是 test.drling.xin 需要写 .conf 后缀名sudo vim /etc/nginx/conf.d/test.drling.xin.conf# 02、将以上 Laravel5.5 的配置文件放进去server {    listen       80;    server_name  test.drling.xin;    root     /var/www/html/test.drling.xin/public;    access_log    /var/log/nginx/test.drling.xin_access.log;    error_log    /var/log/nginx/test.drling.xin_error.log;        index index.html index.php;## 如果你使用的是 Nginx，使用如下站点配置指令就可以支持 URL 美化：location / {    try_files $uri $uri/ /index.php?$query_string;}    location ~ \.php?.*$ {        fastcgi_pass   unix:/run/php/php7.2-fpm.sock;        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;        include        fastcgi_params;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>其实 nginx 的配置放置位置多半可以参考 /etc/nginx/nginx.conf 文件中61行和62行<br> 61         include /etc/nginx/conf.d/<em>.conf;<br> 62         include /etc/nginx/sites-enabled/</em>;</p></blockquote><ul><li><h3 id="添加完了之后一定要重启服务器"><a href="#添加完了之后一定要重启服务器" class="headerlink" title="添加完了之后一定要重启服务器"></a>添加完了之后一定要重启服务器</h3></li></ul><pre class="line-numbers language-none"><code class="language-none">sudo service nginx restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><h3 id="Nginx-配置文件需要注意位置讲解"><a href="#Nginx-配置文件需要注意位置讲解" class="headerlink" title="Nginx 配置文件需要注意位置讲解"></a>Nginx 配置文件需要注意位置讲解</h3></li></ul><ol><li><p>如果不确定 fastcgi_pass 这一段怎么填写</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#fastcgi_pass为fpm地址，可查看/etc/php/7.2/fpm/pool.d/www.conf中的listen确定（www.conf配置文件中第36行）</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>安装 php 的时候一定要安装 php-fpm 扩展（也称为：PHPFastCGI管理器），要连接数据库则必须安装 php-mysql 扩展</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 我在这里安装的 php7.2 因为 Laravel5.5核心代码中需要php7.1以上</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> php7.2-fpm php7.2-mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>可以使用如下命令查看端口监听情况</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">netstat</span> <span class="token parameter variable">-anp</span>// 直接查看80端口可以使用命令：<span class="token function">sudo</span> <span class="token function">lsof</span> <span class="token parameter variable">-i</span> :80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>一定要在 php.ini 配置文件中修改 cgi.fix_pathinfo=0</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/php7.2/fpm/php.ini<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查找到 cgi.fix_pathinfo 字段（第776行），将值设为0</p><blockquote><p>这个参数用来对设置cgi模式下为php是否提供绝对路径信息或PATH_INFO信息</p></blockquote></li><li><p>Nginx 与 PHP-FPM 集成详细讲解</p></li></ol><blockquote><p>PHP-FPM 与 Nginx 通信方式有两种，一种是基于TCP的 Internet domain socket 方式，一种是 UNIX domain socket 方式。</p><p>UNIX domain socket 可以使同一台操作系统上的两个或多个进程进行数据通信。UNIX domain socket 的接口和 Internet domain socket 很像，但它不使用网络底层协议来通信。</p><p>服务器压力不大的情况下，这两种方式性能差别不大，但在压力比较满的时候，用UNIX domain socket方式，效果确实比较好。<br>接下来分别讲解一下两种方式的配置方式：</p></blockquote><ul><li>使用默认的 UNIX Socket方式:</li></ul><ol><li>修改 fpm 的配置文件<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/php/7.2/fpm/pool.d/www.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>修改成如下：<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 第36行</span> listen <span class="token operator">=</span> /run/php/php7.2-fpm.sock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>可以使用如下方式检查下配置文件是否有错误</p></blockquote></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> php-fpm7.2 <span class="token parameter variable">-t</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>修改完了之后重启一下 php-fpm7.2</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> php-fpm7.2 restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>修改 nginx 的配置文件</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/nginx/sites-enabled/default<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改成如下：</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">51</span>         location ~ \.php$</span> <span class="token punctuation">{</span><span class="token directive"><span class="token keyword">52</span>                 include snippets/fastcgi-php.conf</span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">53</span> <span class="token number">54</span>                 <span class="token comment"># With php7.0-cgi alone:</span><span class="token number">55</span>                 <span class="token comment">#fastcgi_pass 127.0.0.1:9000;</span><span class="token number">56</span>                 <span class="token comment"># With php7.0-fpm:</span><span class="token number">57</span>                 fastcgi_pass unix:/run/php/php7.2-fpm.sock</span><span class="token punctuation">;</span>58         <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>修改完了之后重启下 nginx</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> nginx restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>再次检查 nginx 的配置文件是否正确</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> php-fpm7.2 <span class="token parameter variable">-t</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>使用 TCP 方式:</li></ul><ol><li><p>修改 fpm 的配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/php/7.2/fpm/pool.d/www.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改成如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置文件第36行</span>listen <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:9000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>修改 nginx 的配置文件</p></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/nginx/sites-enabled/default<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改成如下：</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">51</span>         location ~ \.php$</span> <span class="token punctuation">{</span><span class="token directive"><span class="token keyword">52</span>                 include snippets/fastcgi-php.conf</span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">53</span> <span class="token number">54</span>                 <span class="token comment"># With php7.0-cgi alone:</span><span class="token number">55</span>                 <span class="token comment">#fastcgi_pass 127.0.0.1:9000;</span><span class="token number">56</span>                 <span class="token comment"># With php7.0-fpm:</span><span class="token number">57</span>                 fastcgi_pass 127.0.0.1:9000</span><span class="token punctuation">;</span>58         <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Ubuntu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LNMP </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS 7.4 64位 搭建LAMP</title>
      <link href="posts/10ab7ab8.html"/>
      <url>posts/10ab7ab8.html</url>
      
        <content type="html"><![CDATA[<h1 id="CentOS-7-4-64位-搭建LAMP"><a href="#CentOS-7-4-64位-搭建LAMP" class="headerlink" title="CentOS 7.4 64位 搭建LAMP"></a>CentOS 7.4 64位 搭建LAMP</h1><ul><li><h2 id="安装php7-2"><a href="#安装php7-2" class="headerlink" title="安装php7.2"></a>安装php7.2</h2></li></ul><p>若直接采用centos中的yum安装：sudo yum -y install php，版本是5.4，远远不够，因此我们要手动更新rpm即可。</p><h3 id="1-首先获取-rpm-（添加-php-的-yum-仓库-）："><a href="#1-首先获取-rpm-（添加-php-的-yum-仓库-）：" class="headerlink" title="1. 首先获取 rpm （添加 php 的 yum 仓库 ）："></a>1. 首先获取 rpm （添加 php 的 yum 仓库 ）：</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rpm</span> <span class="token parameter variable">-Uvh</span> https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm   <span class="token function">rpm</span> <span class="token parameter variable">-Uvh</span> https://mirror.webtatic.com/yum/el7/webtatic-release.rpm    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后可以利用 sudo yum list php* 查看目前都有 php 的什么版本了，可以发现从 4-7.2 的版本都有，7.2 版本名为 72w，因此安装该版本即可：</p><h3 id="2-安装-php7-2"><a href="#2-安装-php7-2" class="headerlink" title="2. 安装 php7.2"></a>2. 安装 php7.2</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> php72w<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但安装完毕后，输入 <code>php -v</code> 发现并没有该命令，因为 php72w 只是安装了 php 最小的库，一些应用还未安装，因此安装一些拓展包即可：</p><h3 id="3-安装-php7-2-其它扩展（安装过程中全部选-yes-即可）"><a href="#3-安装-php7-2-其它扩展（安装过程中全部选-yes-即可）" class="headerlink" title="3. 安装 php7.2 其它扩展（安装过程中全部选 yes 即可）"></a>3. 安装 php7.2 其它扩展（安装过程中全部选 yes 即可）</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以下扩展中有部分和上面的扩展重复，安装的时候请注意区分</span><span class="token function">sudo</span> yum <span class="token function">install</span> php72w.x86_64 php72w-cli.x86_64 php72w-common.x86_64 php72w-gd.x86_64 php72w-ldap.x86_64 php72w-mbstring.x86_64 php72w-mcrypt.x86_64 php72w-mysql.x86_64 php72w-pdo.x86_64 php72w-devel.x86_64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="4-安装-PHP-7-2-的-fpm"><a href="#4-安装-PHP-7-2-的-fpm" class="headerlink" title="4. 安装 PHP 7.2 的 fpm"></a>4. 安装 PHP 7.2 的 fpm</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> php72w-fpm.x86_64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><h2 id="安装-MySQL5-7-或-MySQL5-6"><a href="#安装-MySQL5-7-或-MySQL5-6" class="headerlink" title="安装 MySQL5.7 或 MySQL5.6"></a>安装 MySQL5.7 或 MySQL5.6</h2></li></ul><h3 id="1-配置-YUM-源"><a href="#1-配置-YUM-源" class="headerlink" title="1. 配置 YUM 源"></a>1. 配置 YUM 源</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> http://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm<span class="token function">sudo</span> yum localinstall mysql57-community-release-el7-8.noarch.rpm<span class="token comment"># 检查 mysql 源是否安装成功</span>yum repolist enabled <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"mysql.*-community.*"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-修改安装-mysql-版本配置（现在默认安装是-mysql5-7）"><a href="#2-修改安装-mysql-版本配置（现在默认安装是-mysql5-7）" class="headerlink" title="2. 修改安装 mysql 版本配置（现在默认安装是 mysql5.7）"></a>2. 修改安装 mysql 版本配置（现在默认安装是 mysql5.7）</h3><p>可以修改 <code>vim /etc/yum.repos.d/mysql-community.repo</code>  源，改变默认安装的 mysql 版本。比如要安装 5.7 版本，将 5.6 源的 <code>enabled=1</code> 改成 <code>enabled=0</code> 。然后再将 5.7 源的 <code>enabled=0</code> 改成 <code>enabled=1</code> 即可。改完之后的效果如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">15</span> <span class="token comment"># Enable to use MySQL 5.5</span><span class="token number">16</span> <span class="token punctuation">[</span>mysql55-community<span class="token punctuation">]</span><span class="token number">17</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>MySQL <span class="token number">5.5</span> Community Server<span class="token number">18</span> <span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://repo.mysql.com/yum/mysql-5.5-community/el/7/<span class="token variable">$basearch</span>/<span class="token number">19</span> <span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">0</span><span class="token number">20</span> <span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token number">21</span> <span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql<span class="token number">22</span> <span class="token number">23</span> <span class="token comment"># Enable to use MySQL 5.6</span><span class="token number">24</span> <span class="token punctuation">[</span>mysql56-community<span class="token punctuation">]</span><span class="token number">25</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>MySQL <span class="token number">5.6</span> Community Server<span class="token number">26</span> <span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://repo.mysql.com/yum/mysql-5.6-community/el/7/<span class="token variable">$basearch</span>/<span class="token number">27</span> <span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">0</span><span class="token number">28</span> <span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token number">29</span> <span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql<span class="token number">30</span> <span class="token number">31</span> <span class="token punctuation">[</span>mysql57-community<span class="token punctuation">]</span><span class="token number">32</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>MySQL <span class="token number">5.7</span> Community Server<span class="token number">33</span> <span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://repo.mysql.com/yum/mysql-5.7-community/el/7/<span class="token variable">$basearch</span>/<span class="token number">34</span> <span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token number">35</span> <span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span class="token number">36</span> <span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-安装-MySQL"><a href="#3-安装-MySQL" class="headerlink" title="3. 安装 MySQL"></a>3. 安装 MySQL</h3> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> mysql-community-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="4-启动-MySQL"><a href="#4-启动-MySQL" class="headerlink" title="4. 启动 MySQL"></a>4. 启动 MySQL</h3> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="5-配置开机启动"><a href="#5-配置开机启动" class="headerlink" title="5. 配置开机启动"></a>5. 配置开机启动</h3> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl <span class="token builtin class-name">enable</span> mysqldsystemctl daemon-reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="6-修改-root-本地登录密码"><a href="#6-修改-root-本地登录密码" class="headerlink" title="6. 修改 root 本地登录密码"></a>6. 修改 root 本地登录密码</h3><p>mysql 安装完成之后，在 /var/log/mysqld.log 文件中给 root 生成了一个默认密码。通过下面的方式找到 root 默认密码，然后登录 mysql 进行修改：</p> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> <span class="token comment"># 查找默认生成的密码</span> <span class="token function">grep</span> <span class="token string">'temporary password'</span> /var/log/mysqld.log  <span class="token comment"># 用默认生成的密码登录 mysql</span> mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>  <span class="token comment"># 修改新密码为 MyNewPass4! </span> <span class="token comment"># 用这种方式修改密码的时候需要把密码修改的稍微复杂一点，不然老是提示你创建的密码不安全</span>ALTER <span class="token environment constant">USER</span> <span class="token string">'root'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'MyNewPass4!'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-配置默认编码为-utf8"><a href="#7-配置默认编码为-utf8" class="headerlink" title="7. 配置默认编码为 utf8"></a>7. 配置默认编码为 utf8</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接命令行下敲命令，不需要登录 mysql 之后</span><span class="token assign-left variable">character_set_server</span><span class="token operator">=</span>utf8<span class="token assign-left variable">init_connect</span><span class="token operator">=</span><span class="token string">'SET NAMES utf8'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><h2 id="安装-Apache"><a href="#安装-Apache" class="headerlink" title="安装 Apache"></a>安装 Apache</h2></li></ul><h3 id="1-安装-httpd"><a href="#1-安装-httpd" class="headerlink" title="1. 安装 httpd"></a>1. 安装 httpd</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> httpd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-修改-apache-配置文件"><a href="#2-修改-apache-配置文件" class="headerlink" title="2. 修改 apache 配置文件"></a>2. 修改 apache 配置文件</h3><p>主配置文件的路径为 /etc/httpd/conf/httpd.conf<br>扩展配置文件路径为 /etc/httpd/conf.d/*.conf</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/httpd/conf.d/sample.conf<span class="token comment"># 配置文件编写如下</span> <span class="token operator">&lt;</span>VirtualHost *:8<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>   <span class="token comment"># 项目文件目录，默认项目目录在 /var/www/html/ 下</span>   DocumentRoot /var/www/html/sample/public   <span class="token comment"># 虚拟域名</span>   ServerName test.drling.xin   <span class="token comment"># 多个虚拟域名</span>   ServerAlias sample.drling.xin   <span class="token comment"># 如果还需要配置第三个虚拟域名</span>   ServerAlias www.drling.xin   <span class="token comment"># 错误日志目录</span>   ErrorLog /var/log/httpd/sample-error_log   <span class="token comment"># 访问日志目录</span>   Customlog /var/log/httpd/sample-access_log common <span class="token operator">&lt;</span>/VirtualHost<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-启动-httpd"><a href="#3-启动-httpd" class="headerlink" title="3. 启动 httpd"></a>3. 启动 httpd</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启/重启/停止/状态</span>systemctl start/restart/stop/status httpd <span class="token comment"># 开机启动 httpd</span>systemctl <span class="token builtin class-name">enable</span> httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>以下步骤我搭建服务器的时候没有操作，发现项目也运行起来了</strong></p><h3 id="4-修改-httpd-conf-配置"><a href="#4-修改-httpd-conf-配置" class="headerlink" title="4. 修改 httpd.conf 配置"></a>4. 修改 httpd.conf 配置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># line 86: 改变管理员的邮箱地址</span>ServerAdmin root@linuxprobe.org<span class="token comment"># line 95: 改变域名信息</span>ServerName www.linuxprobe.org:80<span class="token comment"># line 151: none变成All</span>AllowOverride All<span class="token comment"># line 164: 添加只能使用目录名称访问的文件名</span>DirectoryIndex index.html index.cgi index.php<span class="token comment"># add follows to the end</span><span class="token comment"># server's response header（安全性）</span>ServerTokens Prod<span class="token comment"># keepalive is ON</span>KeepAlive On<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-修改防火墙配置"><a href="#5-修改防火墙配置" class="headerlink" title="5. 修改防火墙配置"></a>5. 修改防火墙配置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">如果 Firewalld 正在运行，请允许 HTTP 服务。HTTP 使用 <span class="token number">80</span>/TCPfirewall-cmd --add-service<span class="token operator">=</span>http <span class="token parameter variable">--permanent</span>firewall-cmd <span class="token parameter variable">--reload</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="6-运行-tp5-项目的时候提示没有写-session-的权限，默认-session-文件夹如下"><a href="#6-运行-tp5-项目的时候提示没有写-session-的权限，默认-session-文件夹如下" class="headerlink" title="6. 运行 tp5 项目的时候提示没有写 session 的权限，默认 session 文件夹如下"></a>6. 运行 tp5 项目的时候提示没有写 session 的权限，默认 session 文件夹如下</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># session 文件夹路径： /var/lib/php/session/</span><span class="token comment"># 给最大权限 </span><span class="token function">chmod</span> 0777 <span class="token parameter variable">-R</span> /var/lib/php/session<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CentOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> LAMP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何给已经运行中的 docker 容器添加或者修改端口映射？</title>
      <link href="posts/2a105f69.html"/>
      <url>posts/2a105f69.html</url>
      
        <content type="html"><![CDATA[<h1 id="如何给已经运行中的-docker-容器添加或者修改端口映射？"><a href="#如何给已经运行中的-docker-容器添加或者修改端口映射？" class="headerlink" title="如何给已经运行中的 docker 容器添加或者修改端口映射？"></a>如何给已经运行中的 docker 容器添加或者修改端口映射？</h1><h2 id="容器还没有构建"><a href="#容器还没有构建" class="headerlink" title="容器还没有构建"></a>容器还没有构建</h2><p>如果你的容器还没有构建时，想添加端口映射时，你只需要在创建容器的时候添加 <code>-p</code> 参数，想添加几个端口映射就追加几个 <code>-p</code> 参数。类似于如下示例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> api_dfo_hyperf_ws <span class="token punctuation">\</span><span class="token parameter variable">-v</span> /Users/pudongping/glory/codes/dfo/api_dfo_hyperf:/api_dfo_hyperf <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9502</span>:9502 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9503</span>:9503 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9504</span>:9504 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">9505</span>:9505 <span class="token parameter variable">-it</span> <span class="token punctuation">\</span><span class="token parameter variable">--entrypoint</span> /bin/sh <span class="token punctuation">\</span>alex/alex_api_dfo:v1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="容器已经构建，但是想修改或者添加端口时"><a href="#容器已经构建，但是想修改或者添加端口时" class="headerlink" title="容器已经构建，但是想修改或者添加端口时"></a>容器已经构建，但是想修改或者添加端口时</h2><h3 id="先停止掉正在运行的容器。"><a href="#先停止掉正在运行的容器。" class="headerlink" title="先停止掉正在运行的容器。"></a>先停止掉正在运行的容器。</h3><blockquote><p>以下内容都是以容器 id 为 <code>cbe26510c276</code> 进行操作的，请务必将容器 id 换成你自己需要修改的容器 id。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> stop <span class="token punctuation">{</span>容器的名称或者 <span class="token function">id</span> <span class="token punctuation">}</span><span class="token comment"># 比如：</span><span class="token function">docker</span> stop cbe26510c276<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看容器完整的-hash-of-the-container-数值"><a href="#查看容器完整的-hash-of-the-container-数值" class="headerlink" title="查看容器完整的 hash_of_the_container 数值"></a>查看容器完整的 <code>hash_of_the_container</code> 数值</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> inspect <span class="token punctuation">{</span>容器的名称或者 <span class="token function">id</span> <span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">grep</span> Id<span class="token comment"># 比如：</span><span class="token function">docker</span> inspect cbe26510c276 <span class="token operator">|</span> <span class="token function">grep</span> Id<span class="token comment"># 会得到如下结果：</span><span class="token comment"># "Id": "cbe26510c276fa9a4487a8c2af8cbb49410f2a5305149d2b26eb8ce37c777d00"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="打开-hostconfig-json-配置文件"><a href="#打开-hostconfig-json-配置文件" class="headerlink" title="打开 hostconfig.json 配置文件"></a>打开 <code>hostconfig.json</code> 配置文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /var/lib/docker/containers/<span class="token punctuation">{</span>hash_of_the_container<span class="token punctuation">}</span>/hostconfig.json<span class="token comment"># 比如：</span><span class="token function">vim</span> /var/lib/docker/containers/cbe26510c276fa9a4487a8c2af8cbb49410f2a5305149d2b26eb8ce37c777d00/hostconfig.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>如果你不想先查看完整的容器 <code>hash_of_the_container</code> 数值，你也可以直接先切换到当前容器相关目录中 <code>cd /var/lib/docker/containers/{hash_of_the_container}*</code> ， 然后再去编辑 <code>hostconfig.json</code> 配置文件。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /var/lib/docker/containers/<span class="token punctuation">{</span>hash_of_the_container<span class="token punctuation">}</span>*<span class="token comment"># 比如：</span><span class="token builtin class-name">cd</span> /var/lib/docker/containers/cbe26510c276*<span class="token comment"># 然后再去编辑 `hostconfig.json` 配置文件</span><span class="token function">vim</span> hostconfig.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改-hostconfig-json-配置文件"><a href="#修改-hostconfig-json-配置文件" class="headerlink" title="修改 hostconfig.json 配置文件"></a>修改 <code>hostconfig.json</code> 配置文件</h3><p>在 <code>hostconfig.json</code> 配置文件中，找到 <code>"PortBindings":{}</code> 这个配置项，然后进行修改。我这里添加了两个端口映射，分别将宿主机的 <code>8502</code> 端口以及 <code>8505</code> 端口映射到容器的 <code>8502</code> 端口和 <code>8505</code> 端口。</p><p><code>HostPort</code> 对应的端口代表 <strong>宿主机</strong> 的端口。</p><blockquote><p>建议容器使用什么端口，宿主机就映射什么端口，方便以后管理。当然，具体情况，具体分析。</p></blockquote><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"Binds"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"/data/portal_api_dfo_hyperf/:/portal_api_dfo_hyperf"</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"ContainerIDFile"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"LxcConf"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"Memory"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"MemorySwap"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"CpuShares"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"CpusetCpus"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"Privileged"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"PortBindings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"8502/tcp"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token property">"HostIp"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>                <span class="token property">"HostPort"</span><span class="token operator">:</span> <span class="token string">"8502"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"8505/tcp"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token property">"HostIp"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>                <span class="token property">"HostPort"</span><span class="token operator">:</span> <span class="token string">"8505"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"Links"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"PublishAllPorts"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"Dns"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"DnsSearch"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"ExtraHosts"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"VolumesFrom"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"Devices"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"NetworkMode"</span><span class="token operator">:</span> <span class="token string">"bridge"</span><span class="token punctuation">,</span>    <span class="token property">"IpcMode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"PidMode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"CapAdd"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"CapDrop"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"RestartPolicy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"no"</span><span class="token punctuation">,</span>        <span class="token property">"MaximumRetryCount"</span><span class="token operator">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"SecurityOpt"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"ReadonlyRootfs"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"Ulimits"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"LogConfig"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"Config"</span><span class="token operator">:</span> <span class="token null keyword">null</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"CgroupParent"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="如果-config-v2-json-配置文件或者-config-json-配置文件中也记录了端口，也需要进行修改，如果没有，就不需要改。"><a href="#如果-config-v2-json-配置文件或者-config-json-配置文件中也记录了端口，也需要进行修改，如果没有，就不需要改。" class="headerlink" title="如果 config.v2.json 配置文件或者 config.json 配置文件中也记录了端口，也需要进行修改，如果没有，就不需要改。"></a>如果 <code>config.v2.json</code> 配置文件或者 <code>config.json</code> 配置文件中也记录了端口，也需要进行修改，如果没有，就不需要改。</h3><blockquote><p>只需要修改 <code>"ExposedPorts": {}</code> 相关之处。</p></blockquote><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"State"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"Running"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token property">"Paused"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token property">"Restarting"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token property">"OOMKilled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token property">"Dead"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token property">"Pid"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token property">"ExitCode"</span><span class="token operator">:</span> <span class="token number">137</span><span class="token punctuation">,</span>        <span class="token property">"Error"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"StartedAt"</span><span class="token operator">:</span> <span class="token string">"2021-05-17T07:48:26.743090016Z"</span><span class="token punctuation">,</span>        <span class="token property">"FinishedAt"</span><span class="token operator">:</span> <span class="token string">"2021-07-02T06:05:33.025441199Z"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token string">"cbe26510c276fa9a4487a8c2af8cbb49410f2a5305149d2b26eb8ce37c777d00"</span><span class="token punctuation">,</span>    <span class="token property">"Created"</span><span class="token operator">:</span> <span class="token string">"2020-12-23T07:02:00.997803339Z"</span><span class="token punctuation">,</span>    <span class="token property">"Path"</span><span class="token operator">:</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">,</span>    <span class="token property">"Args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"Config"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"Hostname"</span><span class="token operator">:</span> <span class="token string">"cbe26510c276"</span><span class="token punctuation">,</span>        <span class="token property">"Domainname"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"User"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"Memory"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token property">"MemorySwap"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token property">"CpuShares"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token property">"Cpuset"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"AttachStdin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"AttachStdout"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"AttachStderr"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"PortSpecs"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>        <span class="token property">"ExposedPorts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"8502/tcp"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token property">"8505/tcp"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"Tty"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"OpenStdin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"StdinOnce"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"Env"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span><span class="token punctuation">,</span>            <span class="token string">"SW_VERSION=v4.5.10"</span><span class="token punctuation">,</span>            <span class="token string">"COMPOSER_VERSION=2.0.8"</span><span class="token punctuation">,</span>            <span class="token string">"PHPIZE_DEPS=autoconf dpkg-dev dpkg file g++ gcc libc-dev make php7-dev php7-pear pkgconf re2c pcre-dev pcre2-dev zlib-dev libtool automake"</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"Cmd"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>        <span class="token property">"Image"</span><span class="token operator">:</span> <span class="token string">"hyperf/hyperf:7.4-alpine-v3.11-swoole"</span><span class="token punctuation">,</span>        <span class="token property">"Volumes"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>        <span class="token property">"WorkingDir"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"Entrypoint"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"/bin/sh"</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"NetworkDisabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token property">"MacAddress"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"OnBuild"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>        <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span>            <span class="token property">"maintainer"</span><span class="token operator">:</span> <span class="token string">"Hyperf Developers &lt;group@hyperf.io&gt;"</span><span class="token punctuation">,</span>            <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"Image"</span><span class="token operator">:</span> <span class="token string">"f503e215646f50e5242a6bdf1c6a9a176910c99600b3472b390892f59c87c3a1"</span><span class="token punctuation">,</span>    <span class="token property">"NetworkSettings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"IPAddress"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"IPPrefixLen"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token property">"MacAddress"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"LinkLocalIPv6Address"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"LinkLocalIPv6PrefixLen"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token property">"GlobalIPv6Address"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"GlobalIPv6PrefixLen"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token property">"Gateway"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"IPv6Gateway"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"Bridge"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token property">"PortMapping"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>        <span class="token property">"Ports"</span><span class="token operator">:</span> <span class="token null keyword">null</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"ResolvConfPath"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/containers/cbe26510c276fa9a4487a8c2af8cbb49410f2a5305149d2b26eb8ce37c777d00/resolv.conf"</span><span class="token punctuation">,</span>    <span class="token property">"HostnamePath"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/containers/cbe26510c276fa9a4487a8c2af8cbb49410f2a5305149d2b26eb8ce37c777d00/hostname"</span><span class="token punctuation">,</span>    <span class="token property">"HostsPath"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/containers/cbe26510c276fa9a4487a8c2af8cbb49410f2a5305149d2b26eb8ce37c777d00/hosts"</span><span class="token punctuation">,</span>    <span class="token property">"LogPath"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/containers/cbe26510c276fa9a4487a8c2af8cbb49410f2a5305149d2b26eb8ce37c777d00/cbe26510c276fa9a4487a8c2af8cbb49410f2a5305149d2b26eb8ce37c777d00-json.log"</span><span class="token punctuation">,</span>    <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"/portal_api_dfo_hyperf"</span><span class="token punctuation">,</span>    <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"aufs"</span><span class="token punctuation">,</span>    <span class="token property">"ExecDriver"</span><span class="token operator">:</span> <span class="token string">"native-0.2"</span><span class="token punctuation">,</span>    <span class="token property">"MountLabel"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"ProcessLabel"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"AppArmorProfile"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token property">"RestartCount"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"UpdateDns"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"Volumes"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"/portal_api_dfo_hyperf"</span><span class="token operator">:</span> <span class="token string">"/data/portal_api_dfo_hyperf"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"VolumesRW"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"/portal_api_dfo_hyperf"</span><span class="token operator">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"AppliedVolumesFrom"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="最后重启-docker，然后查看容器相关配置信息是否已经修改完毕"><a href="#最后重启-docker，然后查看容器相关配置信息是否已经修改完毕" class="headerlink" title="最后重启 docker，然后查看容器相关配置信息是否已经修改完毕"></a>最后重启 docker，然后查看容器相关配置信息是否已经修改完毕</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 重启 docker</span><span class="token function">service</span> <span class="token function">docker</span> restart <span class="token comment"># 或者</span>systemctl restart <span class="token function">docker</span><span class="token comment"># 查看容器相关配置信息</span><span class="token function">docker</span> inspect <span class="token punctuation">{</span>容器的名称或者 <span class="token function">id</span> <span class="token punctuation">}</span><span class="token comment"># 比如：</span><span class="token function">docker</span> inspect cbe26510c276<span class="token comment"># 配置符合你的要求后，再次启动容器</span><span class="token function">docker</span> start <span class="token punctuation">{</span>容器的名称或者 <span class="token function">id</span> <span class="token punctuation">}</span><span class="token comment"># 比如：</span><span class="token function">docker</span> start cbe26510c276<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="如果是使用的-Docker-Desktop-for-Mac-时"><a href="#如果是使用的-Docker-Desktop-for-Mac-时" class="headerlink" title="如果是使用的 Docker Desktop for Mac 时"></a>如果是使用的 <code>Docker Desktop for Mac</code> 时</h2><h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><blockquote><p><a href="https://www.modb.pro/db/5458">How to login the VM of Docker Desktop for Mac</a></p></blockquote><p>因为在 Docker for MacOS 中，容器的宿主机并不是 MacOS 本身，而是在 MacOS 中运行的一个 VM 虚拟机<br>。虚拟机的路径可以通过查看 Docker Desktop 的配置界面 <code>Disk image location</code> 配置获得。</p><h3 id="那么我们如何进入这个虚拟机呢？"><a href="#那么我们如何进入这个虚拟机呢？" class="headerlink" title="那么我们如何进入这个虚拟机呢？"></a>那么我们如何进入这个虚拟机呢？</h3><p>最简单的方式是采用 <a href="https://github.com/justincormack/nsenter1">justincormack/nsenter1</a> 进入，这个镜像只有 101KB，已经非常小了。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># –rm 表示在退出的时候就自动删除该容器；</span><span class="token comment"># –privileged 表示允许该容器访问宿主机（也就是我们想要登录的 VM ）中的各种设备；</span><span class="token comment"># –pid=host 表示允许容器共享宿主机的进程命名空间（namespace），或者通俗点儿解释就是允许容器看到宿主机中的各种进程；</span><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--privileged</span> <span class="token parameter variable">--pid</span><span class="token operator">=</span>host justincormack/nsenter1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后再进入 <code>/var/lib/docker/containers</code> 目录修改 <code>config.v2.json</code> 配置文件和 <code>hostconfig.json</code> 配置文件即可。整体来说，在 MacOS 上除了进入  <code>/var/lib/docker/containers</code> 目录时，进入方式有所不同以外，修改配置文件方式和上文一样。需要注意的是，修改的时候请使用 <code>vi</code> 编辑器，因为这个镜像没有安装 <code>vim</code> 编辑器的。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 比如：</span><span class="token function">vi</span> /var/lib/docker/containers/a7377587b9f08cfe87af9a8ffa4da0f90bf07fb0a1cd6833a5ffcd9c37b842d0/config.v2.json<span class="token function">vi</span> /var/lib/docker/containers/a7377587b9f08cfe87af9a8ffa4da0f90bf07fb0a1cd6833a5ffcd9c37b842d0/hostconfig.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS 7.4 64位 编译安装 LNMP</title>
      <link href="posts/2ccaa736.html"/>
      <url>posts/2ccaa736.html</url>
      
        <content type="html"><![CDATA[<h1 id="CentOS-7-4-64位-编译安装-LNMP"><a href="#CentOS-7-4-64位-编译安装-LNMP" class="headerlink" title="CentOS 7.4 64位 编译安装 LNMP"></a>CentOS 7.4 64位 编译安装 LNMP</h1><h2 id="查看-Linux-版本"><a href="#查看-Linux-版本" class="headerlink" title="查看 Linux 版本"></a>查看 Linux 版本</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/redhat-release<span class="token comment"># CentOS Linux release 7.4.1708 (Core)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="1-安装-nginx"><a href="#1-安装-nginx" class="headerlink" title="1. 安装 nginx"></a>1. 安装 nginx</h2><p>1-1. 安装 nginx 源</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum localinstall http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>1-2. 安装 nginx</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>1-3. 启动 nginx</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-安装-MySQL"><a href="#2-安装-MySQL" class="headerlink" title="2. 安装 MySQL"></a>2. 安装 MySQL</h2><p>2-1. 安装 MySQL 源</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum localinstall  http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2-2. 安装 MySQL</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> mysql-community-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装 MySQL 开发包 （*）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> mysql-community-devel<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2-3. 启动 MySQL</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2-4. 查看 MySQL 是否启动</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl status mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2-5. 查看 MySQL 默认密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 首次启动,会把密码放在 /var/log/mysqld.log 里面</span><span class="token comment"># 2018-10-13T15:51:47.482124Z 1 [Note] A temporary password is generated for root@localhost: r)eS,gjku4ts</span><span class="token function">grep</span> <span class="token string">'temporary password'</span> /var/log/mysqld.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>2-6. 更改 MySQL 密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 01、登入数据库</span>mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span> <span class="token comment"># 输入密码</span>r<span class="token punctuation">)</span>eS,gjku4ts<span class="token comment"># 这里的密码 r)eS,gjku4ts 是从以上 mysqld.log 中查询出来的</span><span class="token comment"># 02、修改 root 账号密码 （密码安全级别要稍微高一点，不然更新不会成功）</span>ALTER <span class="token environment constant">USER</span> <span class="token string">'root'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'QAZwsx123!@#'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2-7. 将 root 用户更改为外网也可以访问</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 01、打开 mysql 数据表</span>use mysql<span class="token punctuation">;</span><span class="token comment"># 02、查看 mysql 数据表中数据</span><span class="token keyword">select</span> user,host from user<span class="token punctuation">;</span><span class="token comment"># 03、 % 代表任何 ip 都能访问</span>UPDATE user SET <span class="token function">host</span> <span class="token operator">=</span> <span class="token string">'%'</span> WHERE user <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">;</span><span class="token comment"># 04、再次查看 mysql 数据表中的数据</span><span class="token keyword">select</span> user,host from user<span class="token punctuation">;</span><span class="token comment"># 05、刷新权限</span>flush privileges<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2-8. 新建一个用户并且赋予权限（因为 root 用户开放外面使用毕竟不安全）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 01、新建 mysql 账户</span>grant all privileges on *.* to  alex@<span class="token string">"%"</span> identified by <span class="token string">"QAZwsx123!@#"</span> with grant option<span class="token punctuation">;</span><span class="token comment"># grant 是授权命令，其中 alex 是我们连接用的用户名、"AZwsx123!@#"是连接密码，用户名后面的 "%" 通用符表示允许各 host 操作。</span><span class="token comment"># 上面这条命令是指</span><span class="token comment"># 自动创建用户 alex ,密码 AZwsx123!@#</span><span class="token comment"># 格式：grant 权限 on 数据库名.表名 to 用户@登录主机 identified by "用户密码"; </span><span class="token comment"># @ 后面是访问mysql的客户端IP地址（或是 主机名） % 代表任意的客户端，如果填写 localhost 为本地访问（那此用户就不能远程访问该mysql数据库了）。</span><span class="token comment"># 02、刷新权限</span>flush privileges<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-编译安装-php7-2"><a href="#3-编译安装-php7-2" class="headerlink" title="3. 编译安装 php7.2"></a>3. 编译安装 php7.2</h2><p>3-1. 下载安装包，一般情况下,我们都会下载到 /usr/local/src 下面</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 01、进入 src 目录</span><span class="token builtin class-name">cd</span> /usr/local/src<span class="token comment"># 02、下载 php7.2 源码包</span><span class="token function">wget</span> <span class="token parameter variable">-O</span> php72.tar.gz http://cn2.php.net/get/php-7.2.0.tar.gz/from/this/mirror<span class="token comment"># 03、解压安装包</span><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> php72.tar.gz<span class="token comment"># 04、进入解压后的包</span><span class="token builtin class-name">cd</span> php-7.2.0<span class="token comment"># 05、安装 php 的依赖</span>yum <span class="token function">install</span> libxml2 libxml2-devel openssl openssl-devel <span class="token function">bzip2</span> bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel<span class="token comment"># 06、新建 php 这个文件夹（编译配置会用到）</span><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/php<span class="token comment"># 07、编译配置</span>./configure <span class="token punctuation">\</span><span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/php <span class="token punctuation">\</span>--with-config-file-path<span class="token operator">=</span>/etc <span class="token punctuation">\</span>--enable-fpm <span class="token punctuation">\</span>--with-fpm-user<span class="token operator">=</span>nginx  <span class="token punctuation">\</span>--with-fpm-group<span class="token operator">=</span>nginx <span class="token punctuation">\</span>--enable-inline-optimization <span class="token punctuation">\</span>--disable-debug <span class="token punctuation">\</span>--disable-rpath <span class="token punctuation">\</span>--enable-shared  <span class="token punctuation">\</span>--enable-soap <span class="token punctuation">\</span>--with-libxml-dir <span class="token punctuation">\</span>--with-xmlrpc <span class="token punctuation">\</span>--with-openssl <span class="token punctuation">\</span>--with-mcrypt <span class="token punctuation">\</span>--with-mhash <span class="token punctuation">\</span>--with-pcre-regex <span class="token punctuation">\</span>--with-sqlite3 <span class="token punctuation">\</span>--with-zlib <span class="token punctuation">\</span>--enable-bcmath <span class="token punctuation">\</span>--with-iconv <span class="token punctuation">\</span>--with-bz2 <span class="token punctuation">\</span>--enable-calendar <span class="token punctuation">\</span>--with-curl <span class="token punctuation">\</span>--with-cdb <span class="token punctuation">\</span>--enable-dom <span class="token punctuation">\</span>--enable-exif <span class="token punctuation">\</span>--enable-fileinfo <span class="token punctuation">\</span>--enable-filter <span class="token punctuation">\</span>--with-pcre-dir <span class="token punctuation">\</span>--enable-ftp <span class="token punctuation">\</span>--with-gd <span class="token punctuation">\</span>--with-openssl-dir <span class="token punctuation">\</span>--with-jpeg-dir <span class="token punctuation">\</span>--with-png-dir <span class="token punctuation">\</span>--with-zlib-dir  <span class="token punctuation">\</span>--with-freetype-dir <span class="token punctuation">\</span>--enable-gd-native-ttf <span class="token punctuation">\</span>--enable-gd-jis-conv <span class="token punctuation">\</span>--with-gettext <span class="token punctuation">\</span>--with-gmp <span class="token punctuation">\</span>--with-mhash <span class="token punctuation">\</span>--enable-json <span class="token punctuation">\</span>--enable-mbstring <span class="token punctuation">\</span>--enable-mbregex <span class="token punctuation">\</span>--enable-mbregex-backtrack <span class="token punctuation">\</span>--with-libmbfl <span class="token punctuation">\</span>--with-onig <span class="token punctuation">\</span>--enable-pdo <span class="token punctuation">\</span>--with-mysqli<span class="token operator">=</span>mysqlnd <span class="token punctuation">\</span>--with-pdo-mysql<span class="token operator">=</span>mysqlnd <span class="token punctuation">\</span>--with-zlib-dir <span class="token punctuation">\</span>--with-pdo-sqlite <span class="token punctuation">\</span>--with-readline <span class="token punctuation">\</span>--enable-session <span class="token punctuation">\</span>--enable-shmop <span class="token punctuation">\</span>--enable-simplexml <span class="token punctuation">\</span>--enable-sockets  <span class="token punctuation">\</span>--enable-sysvmsg <span class="token punctuation">\</span>--enable-sysvsem <span class="token punctuation">\</span>--enable-sysvshm <span class="token punctuation">\</span>--enable-wddx <span class="token punctuation">\</span>--with-libxml-dir <span class="token punctuation">\</span>--with-xsl <span class="token punctuation">\</span>--enable-zip <span class="token punctuation">\</span>--enable-mysqlnd-compression-support <span class="token punctuation">\</span>--with-pear <span class="token punctuation">\</span>--enable-opcache<span class="token comment"># 08、编译与安装 （此处需要时间，耐心等待）</span><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3-2. 到这里已经算是安装完成了，查看 php 版本，就会出现熟悉的php 7.2.0 xxxxxx</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 php 版本</span>/usr/local/php/bin/php <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>3-3. 但是这样,我们没有添加环境变量,太麻烦了,接下来把 php 放到环境变量里面</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 01、打开文件</span><span class="token function">vim</span> /etc/profile<span class="token comment"># 02、在 profile 文件最底部加入</span><span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/usr/local/php/bin<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span><span class="token comment"># 03、让修改立即生效</span><span class="token builtin class-name">source</span> /etc/profile  或者  ./etc/profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3-3. 此时我们查看 PHP 版本 php -v 就行了</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将php.ini复制到/etc/下面</span><span class="token function">cp</span> php.ini-production /etc/php.ini<span class="token function">cp</span> /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf<span class="token function">cp</span> /usr/local/php/etc/php-fpm.d/www.conf.default /usr/local/php/etc/php-fpm.d/www.conf<span class="token function">cp</span> sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm<span class="token function">chmod</span> +x /etc/init.d/php-fpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3-4. 启动 php-fpm</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/init.d/php-fpm start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="4-配置-nginx-，使得-nginx-能够解析-php"><a href="#4-配置-nginx-，使得-nginx-能够解析-php" class="headerlink" title="4. 配置 nginx ，使得 nginx 能够解析 php"></a>4. 配置 nginx ，使得 nginx 能够解析 php</h2><p>4-1. 打开 nginx 配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/nginx/conf.d/default.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>默认配置文件中的内容如下：</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"> <span class="token directive"><span class="token keyword">1</span> server</span> <span class="token punctuation">{</span> <span class="token directive"><span class="token keyword">2</span>     listen       <span class="token number">80</span></span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">3</span>     server_name  localhost</span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">4</span>  <span class="token number">5</span>     <span class="token comment">#charset koi8-r;</span> <span class="token number">6</span>     <span class="token comment">#access_log  /var/log/nginx/host.access.log  main;</span> <span class="token number">7</span>  <span class="token number">8</span>     location /</span> <span class="token punctuation">{</span> <span class="token directive"><span class="token keyword">9</span>         root   /usr/share/nginx/html</span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">10</span>         index  index.html index.htm</span><span class="token punctuation">;</span>11     <span class="token punctuation">}</span><span class="token directive"><span class="token keyword">12</span> <span class="token number">13</span>     <span class="token comment">#error_page  404              /404.html;</span><span class="token number">14</span> <span class="token number">15</span>     <span class="token comment"># redirect server error pages to the static page /50x.html</span><span class="token number">16</span>     <span class="token comment">#</span><span class="token number">17</span>     error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html</span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">18</span>     location = /50x.html</span> <span class="token punctuation">{</span><span class="token directive"><span class="token keyword">19</span>         root   /usr/share/nginx/html</span><span class="token punctuation">;</span>20     <span class="token punctuation">}</span>21 22     <span class="token comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>23     <span class="token comment">#</span>24     <span class="token comment">#location ~ \.php$ {</span>25     <span class="token comment">#    proxy_pass   http://127.0.0.1;</span>26     <span class="token comment">#}</span>27 28     <span class="token comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>29     <span class="token comment">#</span>30     <span class="token comment">#location ~ \.php$ {</span>31     <span class="token comment">#    root           html;</span>32     <span class="token comment">#    fastcgi_pass   127.0.0.1:9000;</span>33     <span class="token comment">#    fastcgi_index  index.php;</span>34     <span class="token comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>35     <span class="token comment">#    include        fastcgi_params;</span>36     <span class="token comment">#}</span>37 38     <span class="token comment"># deny access to .htaccess files, if Apache's document root</span>39     <span class="token comment"># concurs with nginx's one</span>40     <span class="token comment">#</span>41     <span class="token comment">#location ~ /\.ht {</span>42     <span class="token comment">#    deny  all;</span>43     <span class="token comment">#}</span>44 <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>4-2. 复制 nginx 默认配置文件 default.conf ，写自定义配置文件 <code>www.drling.xin.conf</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/www.drling.xin.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>4-3. 将以下内容写进 <code>www.drling.xin.conf</code> 配置文件中去</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">server_name</span>  www.drling.xin</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">root</span>   /usr/share/nginx/html</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">index</span> index.php index.html index.htm</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token directive"><span class="token keyword">location</span> ~ \.php$</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">root</span>           /usr/share/nginx/html</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">fastcgi_pass</span>   127.0.0.1:9000</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">fastcgi_index</span>  index.php</span><span class="token punctuation">;</span>        <span class="token comment">#fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>        <span class="token directive"><span class="token keyword">fastcgi_param</span>  SCRIPT_FILENAME  <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">include</span>        fastcgi_params</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>4-4. 查看 nginx 配置写入是否正确</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nginx <span class="token parameter variable">-t</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>4-5. 重启 nginx</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl restart nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>4-6. 在 <code>/usr/share/nginx/html</code> 下面新建一个 index.php 文件，写入以下内容</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>4-7. 在浏览器中访问配置文件中 server_name 后写的域名，就可以看到 phpinfo 信息了，我这里是直接在浏览器中访问 <code>www.drling.xin</code></p><p>4-8. 后续</p><p>这里提供 tp5 的 nginx 配置文件写法</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">server_name</span>  www.drling.xin</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">access_log</span>    /var/log/nginx/www.drling.xin_access.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">error_log</span>    /var/log/nginx/www.drling.xin_error.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">root</span>   /var/www/my_cake_test/public</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">index</span> index.php index.html index.htm</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">if</span> (!-e <span class="token variable">$request_filename</span>)</span> <span class="token punctuation">{</span>                <span class="token directive"><span class="token keyword">rewrite</span> ^(.*)$ /index.php?s=<span class="token variable">$1</span> last</span><span class="token punctuation">;</span>                <span class="token directive"><span class="token keyword">break</span></span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token directive"><span class="token keyword">location</span> ~ \.php$</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">root</span>           /var/www/my_cake_test/public</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">fastcgi_pass</span>   127.0.0.1:9000</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">fastcgi_index</span>  index.php</span><span class="token punctuation">;</span>        <span class="token comment">#fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>        <span class="token directive"><span class="token keyword">fastcgi_param</span>  SCRIPT_FILENAME  <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">include</span>        fastcgi_params</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下为 laravel5.5 的 nginx 配置文件写法</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">server_name</span>  sample.drling.xin</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">access_log</span>    /var/log/nginx/sample.drling.xin_access.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">error_log</span>    /var/log/nginx/sample.drling.xin_error.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">root</span>   /var/www/sample/public</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">index</span> index.php index.html index.htm</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.php?<span class="token variable">$query_string</span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>                       <span class="token directive"><span class="token keyword">location</span> ~ \.php$</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">root</span>           /var/www/sample/public</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">fastcgi_pass</span>   127.0.0.1:9000</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">fastcgi_index</span>  index.php</span><span class="token punctuation">;</span>        <span class="token comment">#fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>        <span class="token directive"><span class="token keyword">fastcgi_param</span>  SCRIPT_FILENAME  <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">include</span>        fastcgi_params</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CentOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> LNMP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS 7 搭建宝塔面板并搭建 LNMP 环境</title>
      <link href="posts/199b0f07.html"/>
      <url>posts/199b0f07.html</url>
      
        <content type="html"><![CDATA[<h1 id="CentOS-7-搭建宝塔面板并搭建-LNMP-环境"><a href="#CentOS-7-搭建宝塔面板并搭建-LNMP-环境" class="headerlink" title="CentOS 7 搭建宝塔面板并搭建 LNMP 环境"></a>CentOS 7 搭建宝塔面板并搭建 LNMP 环境</h1><h2 id="本地环境为："><a href="#本地环境为：" class="headerlink" title="本地环境为："></a>本地环境为：</h2><blockquote><p>Linux 系统环境为：CentOS Linux release 7.4.1708 (Core)</p></blockquote><h2 id="常见-Web-面板"><a href="#常见-Web-面板" class="headerlink" title="常见 Web 面板"></a>常见 Web 面板</h2><p>目前市面上流行的面板很多，例如：</p><ul><li><a href="http://amh.sh/">AMH</a></li><li><a href="https://www.appnode.com/">AppNode</a></li><li><a href="https://www.bt.cn/">宝塔</a></li><li><a href="https://www.wdlinux.cn/wdcp/">WDCP</a></li></ul><h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h2><ul><li>服务器放行 8888 端口</li><li>内存：512M 以上，推荐 768M 以上（纯面板约占系统 60M 内存）</li><li>硬盘：100M 以上可用硬盘空间（纯面板约占 20M 磁盘空间）</li><li>系统：CentOS 7.1+ (Ubuntu16.04+.、Debian9.0+)，确保是干净的操作系统，没有安装过其它环境带的 Apache/Nginx/php/MySQL（已有环境不可安装）</li></ul><h2 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h2><ul><li>Linux 面板 6.9.2 安装命令：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">wget</span> <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> <span class="token parameter variable">-O</span> install.sh http://download.bt.cn/install/install_6.0.sh <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>Linux 面板 6.9.2 升级命令：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://download.bt.cn/install/update6.sh<span class="token operator">|</span><span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6323d664eb6f8b3c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Do you want to <span class="token function">install</span> Bt-Panel to the /www directory now?<span class="token punctuation">(</span>y/n<span class="token punctuation">)</span>:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>意为询问你是否现在安装宝塔面板到 /www 目录？请输入 y 继续。</p><p>随后大概需要 2 分钟左右安装，会有一大堆输出，我们不必关注。</p><p>若安装成功，你将会看到如下输出：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Congratulations<span class="token operator">!</span> Installed successfully<span class="token operator">!</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Bt-Panel: <span class="token punctuation">[</span>管理面板 URL<span class="token punctuation">]</span>username: <span class="token punctuation">[</span>宝塔面板用户名<span class="token punctuation">]</span>password: <span class="token punctuation">[</span>宝塔面板密码<span class="token punctuation">]</span>Warning:If you cannot access the panel,release the following port <span class="token punctuation">(</span><span class="token number">8888</span><span class="token operator">|</span><span class="token number">888</span><span class="token operator">|</span><span class="token number">80</span><span class="token operator">|</span><span class="token number">443</span><span class="token operator">|</span><span class="token number">20</span><span class="token operator">|</span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token keyword">in</span> the security group<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>请务必记住宝塔面板的用户名和面板密码！包括管理面板 url 中 8888 端口后的安全校验码</strong></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-55813fdc1bae8e78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-975046119cade6ce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="如果没有校验码直接带 8888 端口访问后会出现如上提示"></p><p>访问完整面板 URL 之后，输入刚刚记录的账号和密码，会自动跳转到环境搭建面板。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8944b65ff6942fe3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>我选择的 LNMP<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1c0393ac5d90113d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="以上是我自己的配置情况"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3a9bb80ba533e012.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="安装软件时，可以看到 CPU 使用率会飙升，这个是属于正常情况"></p><p>等任务停止后，基本上 LNMP 环境就已经搭建好了，可能会花数分钟。</p><h2 id="感谢："><a href="#感谢：" class="headerlink" title="感谢："></a>感谢：</h2><blockquote><p><a href="https://learnku.com/articles/24917">来源于 laravel 社区《轻松部署宝塔面板》一文</a><br><a href="https://www.bt.cn/bbs/thread-19376-1-1.html">来源于宝塔社区《宝塔 Linux 面板安装教程 - 4月28日更新 - 6.9.2正式版》</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CentOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>打造个性化的 GitHub 主页，让别人看了眼前一亮！</title>
      <link href="posts/bd18a856.html"/>
      <url>posts/bd18a856.html</url>
      
        <content type="html"><![CDATA[<h1 id="打造个性化的-GitHub-主页，让别人看了眼前一亮！"><a href="#打造个性化的-GitHub-主页，让别人看了眼前一亮！" class="headerlink" title="打造个性化的 GitHub 主页，让别人看了眼前一亮！"></a>打造个性化的 GitHub 主页，让别人看了眼前一亮！</h1><blockquote><p>首先可以看一下我的 <a href="https://github.com/pudongping">GitHub 首页</a></p></blockquote><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e33225263f52d150.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="首页1"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e938fade8ae7a1c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="首页2"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3570ccfce03fb0cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="首页3"></p><h2 id="如何构建属于自己个性化的-GitHub-首页？"><a href="#如何构建属于自己个性化的-GitHub-首页？" class="headerlink" title="如何构建属于自己个性化的 GitHub 首页？"></a>如何构建属于自己个性化的 GitHub 首页？</h2><ul><li>先创建一个和自己 GitHub 同用户名的仓库，比如我的 GitHub 账号为 <code>pudongping</code> ，我的 GitHub 地址为：<code>https://github/pudongping</code> 那么我就需要创建一个名为 <code>pudongping</code> 的仓库，如果你填写的是正确的，会出现绿色的提示框，提示你正在创建一个 GitHub profile，如下图所示。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-9b4928a3dc53bbd0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="当仓库名称和自己的 GitHub 同名时，会提示这是一个特别的仓库"></p><blockquote><p>需要注意的是：仓库的访问权限一定要设置为 <code>public</code> ，创建仓库的时候，你可以勾选一下 <code>Add a README file</code> 也可以不勾选，然后自己重新创建一个 <code>README.md</code> 文件，如果是勾选了的话，则默认的 <code>README.md</code> 文件中会有如下代码：</p></blockquote><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">### Hi there 👋 <span class="token comment">&lt;!--**pudongping/pudongping** is a ✨ _special_ ✨ repository because its `README.md` (this file) appears on your GitHub profile.Here are some ideas to get you started:- 🔭 I’m currently working on ...- 🌱 I’m currently learning ...- 👯 I’m looking to collaborate on ...- 🤔 I’m looking for help with ...- 💬 Ask me about ...- 📫 How to reach me: ...- 😄 Pronouns: ...- ⚡ Fun fact: ...--&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-91e84d1a05fa4228.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="仓库名称需要设置成和自己 GitHub 账号同名"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-eb2d92510ffa6cb3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="访问和自己 GitHub 账号同名的仓库时内容"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e93baf911b63ba8a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="默认的 GitHub profile README.md 文件"></p><p>这时候你可以访问一下你自己的 GitHub 首页，就可以看到自己的个性化 <code>GitHub profile</code> 了，就是这么简单 ✌️</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8da90386857abfe2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="查看自己的 GitHub profile"></p><h2 id="接下来说一说个性化定制，打造更加-炫酷-的-GitHub-profile"><a href="#接下来说一说个性化定制，打造更加-炫酷-的-GitHub-profile" class="headerlink" title="接下来说一说个性化定制，打造更加 炫酷 的 GitHub profile"></a>接下来说一说个性化定制，打造更加 <code>炫酷</code> 的 GitHub profile</h2><h3 id="每周代码统计"><a href="#每周代码统计" class="headerlink" title="每周代码统计"></a>每周代码统计</h3><p>如果你需要统计你每周的代码的话，你可以先去 <a href="https://wakatime.com/">WakaTime</a> 网站，使用 GitHub 授权登录一下，获取 <code>wakatime</code> 的密钥，然后访问 <a href="https://github.com/athul/waka-readme">waka-readme</a>  插件页面，根据说明文档设置一下就可以了。</p><blockquote><p>代码统计需要运行 <code>GitHub Action</code> ，如果你不知道如何使用 <code>GitHub Action</code> ，那么你可以参考一下阮一峰的 <a href="http://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html">GitHub Actions 入门教程</a> ，这里就需要用到上面获取的 <code>wakatime</code> 的密钥。</p></blockquote><p>展示效果如下：</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">Week: 19 June, 2021 - 25 June, 2021Markdown   1 hr 38 mins    ███████████████████▓░░░░░   79.03 % CSS        17 mins         ███▓░░░░░░░░░░░░░░░░░░░░░   14.17 % YAML       7 mins          █▒░░░░░░░░░░░░░░░░░░░░░░░   05.74 % <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下以截图的形式展示如何使用：<a href="https://wakatime.com/">WakaTime</a></p><p>先去 wakatime 中使用 github 注册一个账号</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-992eeba288611344.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="注册账号"></p><p>直接使用 GitHub 授权登录</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-edc612cf27e4b612.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="直接使用 GitHub 授权登录"></p><p>访问 <a href="https://wakatime.com/settings/account">https://wakatime.com/settings/account</a> 获取 wakatime 的密钥</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-9b34e7147d31b4ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="获取 wakatime 的密钥"></p><p>在 GitHub 中设置刚刚获取到的 wakatime secret，注意密钥的名称设置为 WAKATIME_API_KEY</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1995498683c19ab5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="设置密钥"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0659cec75b88f8c2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="设置成功如下所示"></p><p>然后在自己的仓库下面创建 <code>.github/workflows/waka-time.yml</code> 文件，填入对应的配置信息，这些配置可以在 <a href="https://github.com/athul/waka-readme">waka-time</a> 仓库中找到示例。</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e1a749790225578a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="填入配置信息"></p><p>此时，修改好配置信息后，我们将代码推送到 GitHub，然后点击 <code>Action</code> 我们可以看到有工作流，我们可以找到 <code>Waka Readme </code> 这一个工作流程，我们可以点一下 <code>Run workflow</code> 按钮手动执行一下</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-84d0a1130196df10.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="查看一下 GitHub Action"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7b11660f35badf18.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="选中指定的工作流程"></p><p>执行完毕之后，我们可以看到执行日志记录</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-762a711dcb3abda1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="可以查看到执行日志记录"></p><p>此时我们再回到自己的 GitHub 首页，查看代码统计结果，我们可以看到红色框中的内容（此时还没有统计结果，我们可以为我们的代码编辑器下载对应的 <code>wakatime</code> 插件，不知道如何下载插件的话，可以<a href="https://wakatime.com/plugins">点击这里</a>）</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6a20665d519221fe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="查看结果"></p><p><a href="https://wakatime.com/">WakaTime</a> 是一款很有用的代码统计工具，它不仅仅可以统计代码编辑器上面的活动状态，还可以统计其他的软件上面的活动，比如 <code>WPS Office</code> 、<code>Chrome</code> 等等，我这里就统计了 <code>WebStorm</code> 和 <code>PhpStorm</code> 等几个编辑器</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-bd50fe828ce3c2bc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="活动统计"></p><h3 id="其他好玩且有用的个性化定制"><a href="#其他好玩且有用的个性化定制" class="headerlink" title="其他好玩且有用的个性化定制"></a>其他好玩且有用的个性化定制</h3><ul><li><a href="https://github.com/anuraghazra/github-readme-stats">展示 GitHub Stats</a></li><li><a href="https://github.com/ashutosh00710/github-readme-activity-graph">展示最近一个月的贡献统计数据</a></li><li><a href="https://shields.io/">徽章制作工具</a></li><li><a href="https://www.dute.org/weird-fonts">怪异英文生成器</a> - 生成比较好看的英文字体，支持复制粘贴</li></ul><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul><li>如果你喜欢我的 <a href="https://github.com/pudongping/pudongping">GitHub profile</a> 你可以克隆代码之后，自己自定义修改。</li><li>制作不易，很多内容都是我一步一步通过搜索引擎获取到的，比如说徽章的背景色，我都是打开各大官网吸取的背景色。如果你喜欢的话，麻烦给个 Star 哇！</li></ul>]]></content>
      
      
      <categories>
          
          <category> 开源 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>samba 实现 windows 和 centos7 文件共享</title>
      <link href="posts/7c9f7082.html"/>
      <url>posts/7c9f7082.html</url>
      
        <content type="html"><![CDATA[<h1 id="samba-实现-windows-和-centos7-文件共享"><a href="#samba-实现-windows-和-centos7-文件共享" class="headerlink" title="samba 实现 windows 和 centos7 文件共享"></a>samba 实现 windows 和 centos7 文件共享</h1><ul><li>安装 samba</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> samba<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-edbeb855b86ab130.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="安装 samba 服务"></p><ul><li>查看 samba 主配置文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/samba/smb.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看主配置文件感觉内容太多时，可以执行以下命令过滤掉注释信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 先将主配置文件做一个备份</span><span class="token function">mv</span> /etc/samba/smb.conf /etc/samba/smb.conf.bak<span class="token comment"># 过滤掉以井号 「#」、分号 「;」 、空行，并覆盖主配置文件</span><span class="token function">cat</span> /etc/samba/smb.conf.bak <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"#"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">";"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"^$"</span> <span class="token operator">&gt;</span> /etc/samba/smb.conf<span class="token comment"># 再次查看主配置文件</span><span class="token function">cat</span> /etc/samba/smb.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-eb2ca8538712d808.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="查看 samba 主配置文件"></p><ul><li>配置共享资源</li></ul><ol><li>创建用于访问共享资源的账户信息</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 先创建一个系统用户 （用户名可以随意写，只要自己记得就好，这里为 sambauser）</span><span class="token comment"># Samba服务程序的数据库要求账户必须在当前系统中已经存在，否则日后创建文件时将导致文件的权限属性混乱不堪，由此引发错误。</span><span class="token function">useradd</span> sambauser<span class="token comment"># 创建 samba 服务程序的用户 （执行以下命令后会提示输入密码，这里的密码用于创建共享时验证，因此需要牢记）</span>pdbedit <span class="token parameter variable">-a</span> <span class="token parameter variable">-u</span> sambauser<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-c69f38676209f8fe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建用于共享资源的账户信息"></p><ol start="2"><li>创建用于共享资源的文件目录</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建共享资源的文件目录，这里创建的文件名为 smb-share，文件名可以自由创建</span><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mnt/smb-share<span class="token comment"># 设置文件夹权限</span><span class="token function">chown</span> <span class="token parameter variable">-Rf</span> sambauser:sambauser /mnt/smb-share<span class="token comment"># 设置该目录的 SELinux 安全上下文</span>semanage fcontext <span class="token parameter variable">-a</span> <span class="token parameter variable">-t</span> samba_share_t /mnt/smb-share<span class="token comment"># 执行 restorecon 命令，让应用于目录的新 SELinux 安全上下文立即生效。</span>restorecon <span class="token parameter variable">-Rv</span> /mnt/smb-share<span class="token comment"># 设置 SELinux 服务与策略</span><span class="token comment"># 先筛选出所有与Samba服务程序相关的SELinux域策略</span>getsebool <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">grep</span> samba<span class="token comment"># 根据策略的名称（和经验）选择出正确的策略条目进行开启即可：</span><span class="token comment"># eg：如果你的共享目录在家目录 /home 下，那么就需要开启</span>setsebool <span class="token parameter variable">-P</span> samba_enable_home_dirs on<span class="token comment"># 这里我使用的共享目录在 /mnt 目录下，因此暂时不需要设置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-fa8568d3e863ecbc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建用于共享资源的文件目录"></p><ol start="3"><li>在 Samba 服务程序的主配置文件中，写共享配置信息</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/samba/smb.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>写入以下内容</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 共享名称为 smb-share</span><span class="token punctuation">[</span>smb-share<span class="token punctuation">]</span><span class="token comment"># 共享信息</span>comment <span class="token operator">=</span> smb-share<span class="token comment"># 共享目录为 /mnt/smb-share</span>path <span class="token operator">=</span> /mnt/smb-share<span class="token comment"># 关闭“所有人可见”</span>public <span class="token operator">=</span> no<span class="token comment"># 允许写入操作</span>writable <span class="token operator">=</span> <span class="token function">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a6be19d4ad79f97c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="写共享配置信息"></p><ol start="4"><li>重启 samba 服务</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 重启 samba 服务</span>systemctl restart smb<span class="token comment"># 将 samba 服务加入到开启启动项中</span>systemctl <span class="token builtin class-name">enable</span> smb<span class="token comment"># 清空 iptables 防火墙</span>iptables <span class="token parameter variable">-F</span><span class="token comment"># 保存 iptables 防火墙设置信息</span><span class="token function">service</span> iptables save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>至此，samba 服务器已经配置完毕</p><ul><li>Windows 挂载共享</li></ul><ol><li>打开 <code>运行</code>，并输入 samba 服务器的 ip 地址</li></ol><pre class="line-numbers language-none"><code class="language-none"># 这里我的虚拟机的 ip 地址为 192.168.127.3，请换成你自己的 samba 服务器的 ip 地址\\192.168.127.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-dd44e0b89a8bf325.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="打开运行，并访问 samba 服务器 ip"></p><ol start="2"><li><p>输入完毕之后，直接点击 <code>确定</code>，就会跳出需要你输入账号和密码，这里的账号需要填写你 samba 服务程序的账号和密码，我这里已经刚刚输入一次了，因此第二次打开的时候，就没有提示要我输入账号和密码。我这里应该输入的账号为：sambauser</p></li><li><p>测试</p></li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-42493846e7cac55b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="账号和密码通过之后即可看到 centos 上面的共享文件夹"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e38dea0acf233162.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="windows 中随便写入一个文件"></p><p>进入 <code>/mnt/smb-share</code> 目录查看文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">more</span> /mnt/smb-share/fad.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e5f789ab12d4f1a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="centos 查看文件"></p><p>还可以将共享文件夹映射为网络驱动器，这样下次就可以直接在 <code>我的电脑</code> 中打开了。<br>映射网络驱动器的方法为，直接对着共享文件夹，右键 =&gt; 映射网络驱动器 =&gt; 直接确定 即可</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b88434639aae9732.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="映射网络驱动"></p>]]></content>
      
      
      <categories>
          
          <category> CentOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> Samba </tag>
            
            <tag> 文件共享 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS 配置 yum 仓库</title>
      <link href="posts/139571b4.html"/>
      <url>posts/139571b4.html</url>
      
        <content type="html"><![CDATA[<h1 id="CentOS-配置-yum-仓库"><a href="#CentOS-配置-yum-仓库" class="headerlink" title="CentOS 配置 yum 仓库"></a>CentOS 配置 yum 仓库</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/yum.repos.d/redhat.repo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>填写以下内容</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>redhat<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>redhatyum<span class="token assign-left variable">baseurl</span><span class="token operator">=</span> yum仓库地址<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>或者直接执行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum-config-manager --add-repo<span class="token operator">=</span><span class="token string">"yum仓库地址"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>阿里源</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 也可以直接访问阿里源地址，下载 Centos-7.repo 文件，然后放到 /etc/yum.repos.d 目录中</span>http://mirrors.aliyun.com/repo/Centos-7.repo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>配置完之后需要执行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清除所有缓存</span>yum clean all<span class="token comment"># 建立缓存</span>yum makecache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CentOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Centos 7 开放及查看端口</title>
      <link href="posts/32500f0d.html"/>
      <url>posts/32500f0d.html</url>
      
        <content type="html"><![CDATA[<h1 id="Centos-7-开放及查看端口"><a href="#Centos-7-开放及查看端口" class="headerlink" title="Centos 7 开放及查看端口"></a>Centos 7 开放及查看端口</h1><ul><li>开放 5200 tcp 端口</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">5200</span>/tcp <span class="token parameter variable">--permanent</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>关闭 5200 tcp 端口</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --remove-port<span class="token operator">=</span><span class="token number">5200</span>/tcp <span class="token parameter variable">--permanent</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>配置立即生效</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">firewall-cmd <span class="token parameter variable">--reload</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>查看防火墙所有开放的端口</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --list-ports<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>关闭防火墙（慎重）</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl stop firewalld.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>查看防火墙状态</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">firewall-cmd <span class="token parameter variable">--state</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>查看所有的端口监听情况</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">netstat</span> <span class="token parameter variable">-lnpt</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CentOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MacOS 安装 homebrew</title>
      <link href="posts/6fa24dc0.html"/>
      <url>posts/6fa24dc0.html</url>
      
        <content type="html"><![CDATA[<h1 id="MacOS-安装-homebrew"><a href="#MacOS-安装-homebrew" class="headerlink" title="MacOS 安装 homebrew"></a>MacOS 安装 homebrew</h1><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>brew update</td><td>更新 Homebrew 自身</td></tr><tr><td>brew outdated</td><td>查看哪些安装包需要更新</td></tr><tr><td>brew upgrade</td><td>更新所有的包</td></tr><tr><td>brew upgrade $FORMULA</td><td>更新指定的包</td></tr><tr><td>brew cleanup</td><td>清理所有包的旧版本</td></tr><tr><td>brew cleanup $FORMULA</td><td>清理指定包的旧版本</td></tr><tr><td>brew cleanup -n</td><td>查看可清理的旧版本包，不执行实际操作</td></tr><tr><td>brew pin $FORMULA</td><td>锁定某个包</td></tr><tr><td>brew unpin $FORMULA</td><td>取消锁定</td></tr><tr><td>brew info $FORMULA</td><td>显示某个包的信息</td></tr><tr><td>brew info</td><td>显示安装了包数量，文件数量，和总占用空间</td></tr><tr><td>brew deps –installed –tree</td><td>查看已安装的包的依赖，树形显示</td></tr><tr><td>brew list</td><td>列出已安装的包</td></tr><tr><td>brew rm $FORMULA</td><td>删除某个包</td></tr><tr><td>brew uninstall –force $FORMULA</td><td>删除所有版本</td></tr></tbody></table><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><blockquote><p><a href="https://brew.sh/">Homebrew 官网地址</a><br><a href="https://github.com/homebrew/install#uninstall-homebrew">Homebrew GitHub 地址</a><br><a href="https://github.com/Homebrew/brew/releases/tag/2.7.3">官网源码下载</a><br><a href="https://github.com/homebrew/install#uninstall-homebrew">官网 GitHub 地址</a><br><a href="https://mirrors.tuna.tsinghua.edu.cn/help/homebrew/">清华大学开源软件镜像站 - 安装 homebrew</a><br><a href="https://www.jianshu.com/p/5822d24a651e">使用国内镜像安装 homebrew</a>  </p></blockquote><blockquote><p>如果使用官网推荐的方式下载时提示以下错误信息时，则表示网络超时，建议直接使用源码包的形式安装</p></blockquote><p>错误信息如下所示：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">curl: <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> Failed to connect to raw.githubusercontent.com port <span class="token number">443</span>: Connection refused<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="直接使用包安装"><a href="#直接使用包安装" class="headerlink" title="直接使用包安装"></a>直接使用包安装</h2><ol><li>进入 <a href="https://github.com/Homebrew/brew/tags">Homebrew 的 GitHub 仓库 tag 地址</a> 下载最新的 tag</li><li>根据系统选择下载：mac、windows 可以下载 zip 文件， linux 可以下载 tar.gz 的文件。</li><li>下载后解压。</li><li>进入本地 <code>Homebrew</code> 的存放路径，如果找不到的话，可以直接在 <code>terminal</code> 下输入以下命令</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进入  usr/local 目录</span><span class="token builtin class-name">cd</span> /usr/local<span class="token comment"># 使用访达(finder) 打开当前目录</span><span class="token function">open</span> <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>查看 <code>/usr/local</code> 目录下是否有 <code>Homebrew</code> 文件夹（注意大小写），如果你发现没有 <code>Homebrew</code> 文件夹，则执行以下命令创建 <code>Homebrew</code> 文件夹</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /user/local/Homebrew<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="6"><li><p>将第三步中解压后的内容全部复制到 <code>/usr/local/Homebrew</code> 目录</p></li><li><p>重启命令行窗口，输入 <code>brew</code> 命令，出现 brew 相关的 help 页面，即表示已经安装成功</p></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /user/local/Homebrew <span class="token operator">&amp;&amp;</span> brew<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>敲击 <code>brew</code> 命令时，出现以下内容时，表示已经安装 Homebrew 成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Example usage:  brew search <span class="token punctuation">[</span>TEXT<span class="token operator">|</span>/REGEX/<span class="token punctuation">]</span>  brew info <span class="token punctuation">[</span>FORMULA<span class="token punctuation">..</span>.<span class="token punctuation">]</span>  brew <span class="token function">install</span> FORMULA<span class="token punctuation">..</span>.  brew update  brew upgrade <span class="token punctuation">[</span>FORMULA<span class="token punctuation">..</span>.<span class="token punctuation">]</span>  brew uninstall FORMULA<span class="token punctuation">..</span>.  brew list <span class="token punctuation">[</span>FORMULA<span class="token punctuation">..</span>.<span class="token punctuation">]</span>Troubleshooting:  brew config  brew doctor  brew <span class="token function">install</span> <span class="token parameter variable">--verbose</span> <span class="token parameter variable">--debug</span> FORMULAContributing:  brew create <span class="token punctuation">[</span>URL <span class="token punctuation">[</span>--no-fetch<span class="token punctuation">]</span><span class="token punctuation">]</span>  brew edit <span class="token punctuation">[</span>FORMULA<span class="token punctuation">..</span>.<span class="token punctuation">]</span>Further help:  brew commands  brew <span class="token builtin class-name">help</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span>  <span class="token function">man</span> brew  https://docs.brew.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="8"><li>安装完成后，一定要下载一个软件测试下，比如下载 <code>wget</code></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> <span class="token function">wget</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="9"><li>更换 brew 的下载源</li></ol><ul><li><p><a href="http://mirrors.ustc.edu.cn/help/brew.git.html">Homebrew 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 替换 USTC 镜像</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span><span class="token function">git</span> remote set-url origin https://mirrors.ustc.edu.cn/brew.git<span class="token comment"># 重置为官方地址</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span><span class="token function">git</span> remote set-url origin https://github.com/Homebrew/brew.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="http://mirrors.ustc.edu.cn/help/homebrew-bottles.html">Homebrew Bottles 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 请在运行 brew 前设置环境变量 HOMEBREW_BOTTLE_DOMAIN ，值为 https://mirrors.ustc.edu.cn/homebrew-bottles</span><span class="token comment"># 对于 bash 用户</span><span class="token builtin class-name">echo</span> <span class="token string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles'</span> <span class="token operator">&gt;&gt;</span> ~/.bash_profile<span class="token builtin class-name">source</span> ~/.bash_profile<span class="token comment"># 对于 zsh 用户</span><span class="token builtin class-name">echo</span> <span class="token string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles'</span> <span class="token operator">&gt;&gt;</span> ~/.zshrc<span class="token builtin class-name">source</span> ~/.zshrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="http://mirrors.ustc.edu.cn/help/homebrew-core.git.html">Homebrew Core 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 替换 USTC 镜像</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>/Library/Taps/homebrew/homebrew-core"</span><span class="token function">git</span> remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git<span class="token comment"># 重置为官方地址</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>/Library/Taps/homebrew/homebrew-core"</span><span class="token function">git</span> remote set-url origin https://github.com/Homebrew/homebrew-core<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="http://mirrors.ustc.edu.cn/help/homebrew-cask.git.html">Homebrew Cask 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 替换为 USTC 镜像</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span>/Library/Taps/homebrew/homebrew-cask<span class="token function">git</span> remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask.git<span class="token comment"># 重置为官方地址</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span>/Library/Taps/homebrew/homebrew-cask<span class="token function">git</span> remote set-url origin https://github.com/Homebrew/homebrew-cask<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="http://mirrors.ustc.edu.cn/help/homebrew-cask-versions.git.html">Homebrew Cask Versions 源</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 替换为 USTC 镜像</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span>/Library/Taps/homebrew/homebrew-cask-versions<span class="token function">git</span> remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask-versions.git<span class="token comment"># 重置为官方地址</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>brew <span class="token parameter variable">--repo</span><span class="token variable">)</span></span>"</span>/Library/Taps/homebrew/homebrew-cask-versions<span class="token function">git</span> remote set-url origin https://github.com/Homebrew/homebrew-cask-versions.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> macOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> macOS </tag>
            
            <tag> homebrew </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 管理远程会话 screen</title>
      <link href="posts/4fadf1be.html"/>
      <url>posts/4fadf1be.html</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-管理远程会话-screen"><a href="#Linux-管理远程会话-screen" class="headerlink" title="Linux 管理远程会话 screen"></a>Linux 管理远程会话 screen</h1><ol><li>创建一个新的会话窗口 backup</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">screen</span> <span class="token parameter variable">-S</span> backup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>查看会话会出现 session_id</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">screen</span> <span class="token parameter variable">-ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>退出会话</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">exit</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>直接使用 screen 命令执行要运行的命令，这样在命令中的一切操作也都会被记录下来，当命令执行结束后 screen 会话也会自动结束。</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">screen</span> <span class="token function">vim</span> memo.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>会话共享功能</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 终端 A：创建会话</span><span class="token function">screen</span> <span class="token parameter variable">-S</span> backup<span class="token comment"># 终端 B：同步终端信息</span><span class="token function">screen</span> <span class="token parameter variable">-x</span><span class="token comment"># 或者通过 screen-session-id 进入</span><span class="token function">screen</span> <span class="token parameter variable">-x</span> <span class="token operator">&lt;</span>screen-session-id<span class="token operator">&gt;</span><span class="token comment"># 比如</span><span class="token function">screen</span> <span class="token parameter variable">-x</span> <span class="token number">364490</span>.backup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>进入会话</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">screen</span> <span class="token parameter variable">-r</span> backup<span class="token comment"># 有时候screen异常退出可能会提示状态为Attached，可以执行：screen -D -r backup 进行恢复。</span><span class="token function">screen</span> <span class="token parameter variable">-D</span> <span class="token parameter variable">-r</span> <span class="token operator">&lt;</span>screen-name or screen-session-id<span class="token operator">&gt;</span><span class="token comment"># 比如</span><span class="token function">screen</span> <span class="token parameter variable">-D</span> <span class="token parameter variable">-r</span> backup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Screen </tag>
            
            <tag> 会话管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Supervisor 进程管理工具使用</title>
      <link href="posts/21919295.html"/>
      <url>posts/21919295.html</url>
      
        <content type="html"><![CDATA[<h1 id="Supervisor-进程管理工具使用"><a href="#Supervisor-进程管理工具使用" class="headerlink" title="Supervisor 进程管理工具使用"></a>Supervisor 进程管理工具使用</h1><ul><li><a href="https://pypi.org/project/supervisor/">pypi 插件链接地址</a></li><li><a href="http://supervisord.org/">官方文档地址</a></li><li><a href="https://www.jianshu.com/p/3658c963d28b">supervisor 从安装到使用</a></li></ul><blockquote><p>php artisan horizon 和 php artisan queue:work 命令一样，都可以正常处理异步任务<br>php artisan horizon:terminate =&gt; Horizon 进程会等待当前正在执行的任务执行完毕，然后再退出进程。</p></blockquote><h2 id="在阿里云-CentOS-7-6-上"><a href="#在阿里云-CentOS-7-6-上" class="headerlink" title="在阿里云 CentOS 7.6 上"></a>在阿里云 CentOS 7.6 上</h2><ul><li>安装 supervisor</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> supervisor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看主配置信息 <code>supervisord.conf</code> 留意 <code>include</code> 选项</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/supervisord.conf<span class="token comment"># 这里决定了你所需要写的进程配置文件格式，这里是 ini ，因此我们也必须写成 ini 后缀的文件</span><span class="token punctuation">[</span>include<span class="token punctuation">]</span>files <span class="token operator">=</span> supervisord.d/*.ini<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>添加自定义进程配置信息</li></ul><p>vim /etc/supervisord.d/larablog.ini</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>program:larablog-horizon<span class="token punctuation">]</span><span class="token assign-left variable">process_name</span><span class="token operator">=</span>%<span class="token punctuation">(</span>program_name<span class="token punctuation">)</span>s<span class="token assign-left variable">command</span><span class="token operator">=</span>php /www/wwwroot/larablog/artisan horizon<span class="token assign-left variable">autostart</span><span class="token operator">=</span>true<span class="token assign-left variable">autorestart</span><span class="token operator">=</span>true<span class="token assign-left variable">user</span><span class="token operator">=</span>www<span class="token assign-left variable">redirect_stderr</span><span class="token operator">=</span>true<span class="token assign-left variable">stdout_logfile</span><span class="token operator">=</span>/www/wwwroot/larablog/storage/logs/worker.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>program:larablog-horizon 代表这个配置的名称是 larablog-horizon；</p></li><li><p>process_name= 代表这个进程在 Supervisor 内部的命名；</p></li><li><p>command= 代表要执行的命令；</p></li><li><p>autostart=true 代表这个进程跟随 Supervisor，只要 Supervisor 启动了，就启动这个进程；</p></li><li><p>autorestart=true 代表要求 Supervisor 监听进程状态，假如异常退出就再次启动，重启次数默认有 3 次限制；</p></li><li><p>user=www 代表以 www 身份启动进程；</p></li><li><p>redirect_stderr=true 代表输出错误信息；</p></li><li><p>stdout_logfile= 代表将进程的输出保存到日志文件中。</p></li><li><p>更新配置</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> supervisorctl update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果遇到报错 <code>error: &lt;class 'socket.error'&gt;, [Errno 2] No such file or directory: file: /usr/lib64/python2.7/socket.py line: 224</code> 则执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> supervisord <span class="token parameter variable">-c</span> /etc/supervisord.conf<span class="token comment"># 再次尝试执行重载配置命令</span><span class="token function">sudo</span> supervisorctl update<span class="token function">sudo</span> supervisorctl <span class="token parameter variable">-c</span> /etc/supervisord.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看进程状态</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> supervisorctl status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="在-ubuntu-上"><a href="#在-ubuntu-上" class="headerlink" title="在 ubuntu 上"></a>在 ubuntu 上</h2><ul><li>安装 supervisor</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> supervisor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>添加自定义进程配置信息</li></ul><p>vim /etc/supervisor/conf.d/larablog.conf</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>program:larablog-horizon<span class="token punctuation">]</span><span class="token assign-left variable">process_name</span><span class="token operator">=</span>%<span class="token punctuation">(</span>program_name<span class="token punctuation">)</span>s<span class="token assign-left variable">command</span><span class="token operator">=</span>php /www/wwwroot/larablog/artisan horizon<span class="token assign-left variable">autostart</span><span class="token operator">=</span>true<span class="token assign-left variable">autorestart</span><span class="token operator">=</span>true<span class="token assign-left variable">user</span><span class="token operator">=</span>www<span class="token assign-left variable">redirect_stderr</span><span class="token operator">=</span>true<span class="token assign-left variable">stdout_logfile</span><span class="token operator">=</span>/www/wwwroot/larablog/storage/logs/worker.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>更新配置</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> supervisorctl update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>检查是否正常运行</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> supervisorctl status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>单独启动一个指定名称的进程</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> supervisorctl start <span class="token operator">&lt;</span>process-name<span class="token operator">&gt;</span><span class="token comment"># 比如启动名称为 larablog-horizon 的进程</span><span class="token function">sudo</span> supervisorctl start larablog-horizon<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Supervisor </tag>
            
            <tag> 进程管理工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vmware 安装 macos 原版系统</title>
      <link href="posts/17b85fe6.html"/>
      <url>posts/17b85fe6.html</url>
      
        <content type="html"><![CDATA[<h1 id="VMware-WorkStation-安装-macOS-原版系统"><a href="#VMware-WorkStation-安装-macOS-原版系统" class="headerlink" title="VMware WorkStation 安装 macOS 原版系统"></a>VMware WorkStation 安装 macOS 原版系统</h1><h2 id="文献参考"><a href="#文献参考" class="headerlink" title="文献参考"></a>文献参考</h2><ul><li><a href="https://www.bilibili.com/video/BV1a7411e7Pq">手把手教你win 10 VMware 15 安装 MAC OS 10.15原版系统</a></li><li><a href="https://github.com/paolo-projects/unlocker/releases">VMware 解锁器</a></li><li><a href="https://updates.cdn-apple.com/2020/macos/001-48329-20200924-122a4260-eb65-4492-b08e-f69dfa22c2dc/SecUpd2020-005Mojave.dmg">官方系统下载</a></li><li><a href="https://www.mediafire.com/file/7wm2251an4c2n64/macOS_Catalina_ISO_By_Techbland.iso/file">镜像下载地址</a></li><li><a href="https://www.applex.net/pages/macos/">提供各版本的苹果电脑macOS系统镜像下载 ，支持百度网盘/独立服务器/迅雷地址下载</a></li></ul><h2 id="安装前必须要准备的软件"><a href="#安装前必须要准备的软件" class="headerlink" title="安装前必须要准备的软件"></a>安装前必须要准备的软件</h2><ul><li>VMware workstation 虚拟机</li><li>VMware 解锁器</li><li>macOS 懒人包系统 （ .cdr 文件）</li></ul><p>以上软件可以通过访问我的百度网盘获取，需要注意的是，下载下来的 <code>.cdr</code> 懒人包系统，最好要通过 <code>md5</code> 校验。</p><p>以下为网盘链接</p><pre class="line-numbers language-none"><code class="language-none">链接：https://pan.baidu.com/s/1NMHD6i8FIgYaqcPVljbl8w 提取码：jcr3 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>Windows 系统下可以执行以下命令来核对 md5</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">certutil <span class="token parameter variable">-hashfile</span> <span class="token string">"cdr文件的绝对路径"</span> md5<span class="token comment"># 比如</span>certutil <span class="token parameter variable">-hashfile</span> <span class="token string">"F:\Vmware Installer macOS Mojave(18G103).cdr"</span> md5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装步骤如下"><a href="#安装步骤如下" class="headerlink" title="安装步骤如下"></a>安装步骤如下</h2><ul><li>下载 VMware 解锁器 <code>unlocker.zip</code> 并解压，并切记一定要关闭掉 VMware 的所有进程，如果不知道如何关闭掉 VMware 的所有进程，可以考虑直接关机重启，然后再进行以下操作</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5d55ecd7da49b4f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="解压 VMware 解锁器"></p><ul><li>对着解压后的 <code>win-install.cmd</code> 文件，右键 - 以管理员身份运行。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-c1094950a7bcb3ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="右键 - 以管理员身份运行"></p><ul><li>此时解锁器会自动下载相应的文件，不用去理会</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b55be1c48fe20e9b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="解锁器正在下载相应的解锁文件"></p><ul><li>字条走完之后会自动关闭掉 <code>cmd</code> 命令窗口</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1469e628bb22865d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="解锁器软件安装完毕后，会自动关闭掉 cmd 窗口"></p><ul><li>接下来我们来验证解锁器是否安装好，打开 VMware 虚拟机，尝试新建一台虚拟机</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-dc120ff66ee2143f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>选择稍后安装系统</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3bdecc977abad802.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>选择 <code>Apple Mac OS</code> 相应的选项，此时我们可以看到能够选择相应的系统版本，此时需要注意的是 <strong>安装什么版本的系统，就要选择相应的版本，否则安装系统时，页面会直接卡死</strong></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-c0383da1fac1d780.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li><p>此时我们能够确定解锁器已经安装好了，如果此时无法看到 <code>macOS</code> 系统相关的选项，那么就需要自己反复多次的安装解锁器，直到能够看到 <code>macOS</code> 系统相关的选项才算成功！此时，正式开启安装 <code>macOS</code> 系统之旅！</p></li><li><p>以下步骤没有太多需要说的，按照截图一步一步的来操作就好了。</p></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0d5e6bb7fcbf5693.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-bdf66cfcb46d334f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-470f7e95996b8e95.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>这里需要注意的是，我们采用的系统是 <code>.cdr</code> 格式的懒人包，我们需要选择 <code>所有文件</code> 才可以看到 <code>.cdr</code> 文件。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-82cc62377031414c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-76561873201b4868.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a999d47eac24da6f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>我这里解锁之后最高只能达到 <code>10.14</code> 的版本，因此最后只能安装 <code>macOS 10.14</code> 的系统，但是操作步骤是一样的，虽然我也不知道为什么我这里最高只能是 <code>10.14</code> 的版本，如果你知道，欢迎给我留言分享一下。但是一定要切记，在这里你选择的是什么版本，你就必须得安装什么版本的系统，否则无法安装的。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5db13a5dddd5913e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>你也可以自己选择安装路径，这个没有多大影响的。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-32a39bb01028420a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-57a02042db810fe1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-63269f2bf437b483.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-bd5063e66c347b8b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-27ab34b1c5910913.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-4e4c3d84cd2d81d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-fcd64dfa495db579.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8dec6384e39c5f0a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f6c011453fa32db5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>这里的我们需要选择 <code>磁盘工具</code> 先将磁盘抹掉一下</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-18c19147c0287b0f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>一定要注意，只能选择刚刚我们分配给 VMware 的那块盘，其他的不要去动</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d6502e6942507cf8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a56f6d65c8af8e66.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>也可以直接修改硬盘的名称</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-29182a6ba51f3d14.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0bb2fe22c24127fb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-dc6da02e40630c46.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>接下来就可以正式安装系统了</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6b4f9b0dc8dd5f59.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-20a8500578e77a4f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-4a5e4d2f6f873237.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ebf3a3aa95ad9e23.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-10f3e63d7698153b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6a29ad902ca42f85.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-858e85800375aa9d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-4f7d8621579f1e35.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6d1be7fab284223e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d91052596f1f6a5a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>安装到这里之后，我们需要到物理机上面设置一下网络，这样才能够保证虚拟机能够访问网络</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-89c913b1a93e35d2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-c76b0e8d339fa9b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5a6b3cfa2e4b5ac4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-58f85f0769d2d806.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-bb7e63edd1ea925b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f0e5481918b08eae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b8cbaab5b48a8f5d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-638a71f2bb30082f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5dc33873f724a835.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0e2db0987876efb6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-537f2118a2179f0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0c519f187338c657.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-47342c1c550ac55e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-cc5277d7cdcd2443.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d28b63af01954e7d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>此时我们在 VMware 中就已经将 macOS 系统安装完毕了。此时我们弹出一下我们的系统镜像</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b9b6a3d9fc18f1d1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li>继续安装 VMware tools ，这样能够自动适配我们物理机的分辨率</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-cc8ae8f39937e312.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-22bf2dda46ea0caf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-33acc9ad3a16c8cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-faf3da4dd22cb119.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-20f5ee8ff0c04453.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0e0e12068dce26c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>按照以上的截图一步一步操作，我相信问题应该不会很大的。</p>]]></content>
      
      
      <categories>
          
          <category> macOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> macOS </tag>
            
            <tag> 虚拟机 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx/Tengine 服务器安装 SSL 证书</title>
      <link href="posts/2078b83a.html"/>
      <url>posts/2078b83a.html</url>
      
        <content type="html"><![CDATA[<h1 id="Nginx-Tengine-服务器安装-SSL-证书"><a href="#Nginx-Tengine-服务器安装-SSL-证书" class="headerlink" title="Nginx/Tengine 服务器安装 SSL 证书"></a>Nginx/Tengine 服务器安装 SSL 证书</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><blockquote><p>使用阿里云下载免费版 DigiCert Inc 证书，并基于 Nginx web 服务器安装 SSL 证书</p></blockquote><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><p>在证书控制台下载 Nginx 版本证书。下载到本地的压缩文件包解压后包含：</p><ul><li><code>.crt</code> 文件：是证书文件，crt 是 pem 文件的扩展名。</li><li><code>.key</code> 文件：证书的私钥文件（申请证书时如果没有选择<code>自动创建 CSR</code>，则没有该文件）。</li></ul><p><code>友情提示：</code>  <code>.pem</code> 扩展名的证书文件采用 Base64-encoded 的 PEM 格式<code>文本文件</code>，可根据需要修改扩展名。</p><p>以 Nginx 标准配置为例，假如证书文件名是 a.pem，私钥文件是 a.key。</p><p>在 Nginx 的安装目录下创建 cert 目录，并且将下载的全部文件拷贝到 cert 目录中。如果申请证书时是自己创建的 CSR 文件，请将对应的私钥文件放到 cert 目录下并且命名为 a.key；</p><p>打开 Nginx 安装目录下 conf 目录中的 nginx.conf 文件，找到：</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># HTTPS server</span><span class="token comment"># #server {</span><span class="token comment"># listen 443;</span><span class="token comment"># server_name localhost;</span><span class="token comment"># ssl on;</span><span class="token comment"># ssl_certificate cert.pem;</span><span class="token comment"># ssl_certificate_key cert.key;</span><span class="token comment"># ssl_session_timeout 5m;</span><span class="token comment"># ssl_protocols SSLv2 SSLv3 TLSv1;</span><span class="token comment"># ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;</span><span class="token comment"># ssl_prefer_server_ciphers on;</span><span class="token comment"># location / {</span><span class="token comment">#</span><span class="token comment">#</span><span class="token comment">#}</span><span class="token comment">#}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将其修改为 (以下属性中 ssl 开头的属性与证书配置有直接关系，其它属性请结合自己的实际情况复制或调整) :</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span> <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span></span><span class="token punctuation">;</span> <span class="token comment"># 在使用宝塔面板搭建的 LNMP 环境中，推荐 `listen 443 ssl http2;` 这么写</span> <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">ssl</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">root</span> html</span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">index</span> index.html index.htm</span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">ssl_certificate</span>   cert/a.pem</span><span class="token punctuation">;</span> <span class="token comment"># 这里推荐写绝对路径</span> <span class="token directive"><span class="token keyword">ssl_certificate_key</span>  cert/a.key</span><span class="token punctuation">;</span> <span class="token comment"># 这里推荐写绝对路径</span> <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">5m</span></span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4</span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1 TLSv1.1 TLSv1.2</span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>     <span class="token directive"><span class="token keyword">root</span> html</span><span class="token punctuation">;</span>     <span class="token directive"><span class="token keyword">index</span> index.html index.htm</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="自己使用宝塔面板-6-9-8-免费版，搭建-LNMP-环境时的-nginx-配置文件"><a href="#自己使用宝塔面板-6-9-8-免费版，搭建-LNMP-环境时的-nginx-配置文件" class="headerlink" title="自己使用宝塔面板 6.9.8 免费版，搭建 LNMP 环境时的 nginx 配置文件"></a>自己使用宝塔面板 6.9.8 免费版，搭建 LNMP 环境时的 nginx 配置文件</h2><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>         <span class="token comment"># 宝塔中建议这么写监听 443 端口</span><span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl http2</span><span class="token punctuation">;</span>      <span class="token directive"><span class="token keyword">server_name</span> www.drling.xin</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">index</span> index.php index.html index.htm default.php default.htm default.html</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">root</span> /www/wwwroot/larablog/public</span><span class="token punctuation">;</span>            <span class="token comment"># 强制开启 https ，当访问 http 时，直接强制跳转到 https</span>    <span class="token comment">#HTTP_TO_HTTPS_START</span>    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$server_port</span> !~ 443)</span><span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">rewrite</span> ^(/.*)$ https://<span class="token variable">$host</span><span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">#HTTP_TO_HTTPS_END</span>    <span class="token directive"><span class="token keyword">limit_conn</span> perserver <span class="token number">3000</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">limit_conn</span> perip <span class="token number">25</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">limit_rate</span> <span class="token number">512k</span></span><span class="token punctuation">;</span>            <span class="token comment"># 这里直接采用宝塔面板，将 ssl 信息通过 [其他证书] 栏，导入进去，因此 nginx 配置文件由宝塔面板自行写入。</span>    <span class="token comment"># 若需要自己写入配置文件，以下参数可以这样写，如下：</span>    <span class="token comment"># ssl_certificate    /www/server/panel/vhost/aliyun-ssl/1939426_drling.xin.pem;</span>    <span class="token comment"># ssl_certificate_key    /www/server/panel/vhost/aliyun-ssl/1939426_drling.xin.key;    </span>        <span class="token comment">#SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则</span>    <span class="token comment">#error_page 404/404.html;    </span>    <span class="token directive"><span class="token keyword">ssl_certificate</span>    /www/server/panel/vhost/cert/www.drling.xin/fullchain.pem</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">ssl_certificate_key</span>    /www/server/panel/vhost/cert/www.drling.xin/privkey.pem</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1 TLSv1.1 TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">ssl_session_cache</span> shared:SSL:10m</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">10m</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">error_page</span> <span class="token number">497</span>  https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>    <span class="token comment">#SSL-END</span>            <span class="token comment">#ERROR-PAGE-START  错误页配置，可以注释、删除或修改</span>    <span class="token comment">#error_page 404 /404.html;</span>    <span class="token comment">#error_page 502 /502.html;</span>    <span class="token comment">#ERROR-PAGE-END</span>        <span class="token comment">#PHP-INFO-START  PHP引用配置，可以注释或修改</span>    <span class="token directive"><span class="token keyword">include</span> enable-php-73.conf</span><span class="token punctuation">;</span>    <span class="token comment">#PHP-INFO-END</span>        <span class="token comment">#REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效</span>    <span class="token directive"><span class="token keyword">include</span> /www/server/panel/vhost/rewrite/www.drling.xin.conf</span><span class="token punctuation">;</span>    <span class="token comment">#REWRITE-END</span>        <span class="token comment">#禁止访问的文件或目录</span>    <span class="token directive"><span class="token keyword">location</span> ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)</span>    <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">#一键申请SSL证书验证目录相关设置</span>    <span class="token directive"><span class="token keyword">location</span> ~ \.well-known</span><span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">allow</span> all</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token directive"><span class="token keyword">location</span> ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span>    <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">expires</span>      <span class="token number">30d</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">error_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">access_log</span> /dev/null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token directive"><span class="token keyword">location</span> ~ .*\.(js|css)?$</span>    <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">expires</span>      <span class="token number">12h</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">error_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">access_log</span> /dev/null</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>    <span class="token directive"><span class="token keyword">access_log</span>  /www/wwwlogs/www.drling.xin.log</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">error_log</span>  /www/wwwlogs/www.drling.xin.error.log</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>安装完毕之后你可以使用<a href="https://www.ssllabs.com/ssltest/index.html">SSL Server Test – 安全测试工具</a> 去测试下你的 HTTPS 是否够安全</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><blockquote><p><a href="https://help.aliyun.com/knowledge_detail/95491.html">阿里云官方介绍 Nginx 服务器安装 SSL 证书</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 服务器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> Linux </tag>
            
            <tag> 免费 HTTPS 证书 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过 Certbot 安装 Let&#39;s Encrypt 证书，实现免费的全站 HTTPS 访问</title>
      <link href="posts/6c6ec7d4.html"/>
      <url>posts/6c6ec7d4.html</url>
      
        <content type="html"><![CDATA[<h1 id="通过-Certbot-安装-Let’s-Encrypt-证书，实现免费的全站-HTTPS-访问"><a href="#通过-Certbot-安装-Let’s-Encrypt-证书，实现免费的全站-HTTPS-访问" class="headerlink" title="通过 Certbot 安装 Let’s Encrypt 证书，实现免费的全站 HTTPS 访问"></a>通过 Certbot 安装 Let’s Encrypt 证书，实现免费的全站 HTTPS 访问</h1><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><blockquote><p><a href="https://xueyuanjun.com/post/9695">通过 Certbot 安装 Let’s Encrypt 证书，来实现全站的 HTTPS 访问</a></p><p><a href="https://xueyuanjun.com/post/9755">学院军 - 将博客应用从 HTTP 协议免费升级到 HTTPS</a></p><p><a href="https://certbot.eff.org/">certbot官网地址</a></p></blockquote><ul><li>打开首页先选择自己的系统版本 （我这里采用的 web 服务器是 nginx，系统是 centos7 ）<a href="https://certbot.eff.org/lets-encrypt/centosrhel7-nginx">传输门</a></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-fb5a52f6ae876089.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="certbot页面选择自己的系统版本"></p><ul><li>可以按照官网提供的操作文档执行命令</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 certbot 客户端工具</span><span class="token function">sudo</span> yum <span class="token function">install</span> certbot python2-certbot-nginx<span class="token comment"># 自动检测 nginx 配置以及确定哪些网站需要配置 ssl （会列出全部的 nginx 配置信息）</span><span class="token function">sudo</span> certbot <span class="token parameter variable">--nginx</span><span class="token comment"># 设置 crontab 计划任务，自动更新 ssl 证书</span><span class="token builtin class-name">echo</span> <span class="token string">"0 0,12 * * * root python -c 'import random; import time; time.sleep(random.random() * 3600)' &amp;&amp; certbot renew -q"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> /etc/crontab <span class="token operator">&gt;</span> /dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="以下记录本人安装-certbot-的整个过程"><a href="#以下记录本人安装-certbot-的整个过程" class="headerlink" title="以下记录本人安装 certbot 的整个过程"></a>以下记录本人安装 certbot 的整个过程</h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><blockquote><p>服务器：阿里云服务器<br>系统：  centos 7<br>web 服务器： nginx<br>安装过宝塔 （安装过宝塔后，nginx 的主配置文件位于 <code>/www/server/nginx/conf/</code>）</p></blockquote><p>整体流程是按照官网的流程来操作的，但是其中会遇到各种问题，出现的问题如下：</p><ol><li>安装 certbot 客户端工具 （此流程正常），安装过程中，该直接回车的就回车，该直接选 Yes 的输入 Y 然后回车</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> certbot python2-certbot-nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>配置 ssl 时，一路出错，如下：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> certbot <span class="token parameter variable">--nginx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>重要错误信息如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pkg_resources.ContextualVersionConflict: <span class="token punctuation">(</span>cryptography <span class="token number">2.1</span> <span class="token punctuation">(</span>/usr/lib64/python2.7/site-packages<span class="token punctuation">)</span>, Requirement.parse<span class="token punctuation">(</span><span class="token string">'cryptography&gt;=2.3'</span><span class="token punctuation">)</span>, set<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'PyOpenSSL'</span><span class="token punctuation">]</span><span class="token punctuation">))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ae7750063ab78d51.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PyOpenSSL相关报错信息"></p><p>查看 PyOpenSSL 版本信息，发现确实是版本过低的原因</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip show PyOpenSSL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>解决方案：更新相应的 python 包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> <span class="token parameter variable">-U</span> PyOpenSSLpip <span class="token function">install</span> <span class="token parameter variable">-U</span> cryptography<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>再次执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> certbot <span class="token parameter variable">--nginx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>再次发现报错，错误信息如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ImportError: cannot <span class="token function">import</span> name UnrewindableBodyError<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>解决方案：安装相应的 python 包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 更新 pip</span>pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip<span class="token comment"># 卸载 urllib3</span>pip uninstall urllib3<span class="token comment"># 重新再次下载</span>pip <span class="token function">install</span> urllib3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再次执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> certbot <span class="token parameter variable">--nginx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>再次发现报错，错误信息如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ImportError: No module named urllib3.exceptions  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>解决方案：直接暴力下载相应的 pyOpenSSL 包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> http://cbs.centos.org/kojifiles/packages/pyOpenSSL/16.2.0/3.el7/noarch/python2-pyOpenSSL-16.2.0-3.el7.noarch.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>再次执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> certbot <span class="token parameter variable">--nginx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>继续报错，如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Error <span class="token keyword">while</span> running nginx <span class="token parameter variable">-c</span> /etc/nginx/nginx.conf -t.nginx: <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> open<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token string">"/etc/nginx/nginx.conf"</span> failed <span class="token punctuation">(</span><span class="token number">2</span>: No such <span class="token function">file</span> or directory<span class="token punctuation">)</span>nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> failedThe nginx plugin is not working<span class="token punctuation">;</span> there may be problems with your existing configuration.The error was: MisconfigurationError<span class="token punctuation">(</span><span class="token string">'Error while running nginx -c /etc/nginx/nginx.conf -t.\n\nnginx: [emerg] open() "/etc/nginx/nginx.conf" failed (2: No such file or directory)\nnginx: configuration file /etc/nginx/nginx.conf test failed\n'</span>,<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-faa86a2b9f2c5d14.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="nginx 主配置文件 /etc/nginx/nginx.conf  没有检测到"></p><p>原因是：宝塔将 nginx 的主配置文件安装在 <code>/www/server/nginx/conf/</code> 目录下，然而 <code>certbot</code> 默认在扫描 <code>/etc/nginx/nginx.conf</code> 文件，故而找不到 nginx 的配置文件</p><p>解决方案：指定 nginx 的配置目录，执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> certbot <span class="token parameter variable">--nginx</span> --nginx-server-root<span class="token operator">=</span>/www/server/nginx/conf/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然而不幸的是，依然还是报错，报错信息如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">An unexpected error occurred:TypeError: from_buffer<span class="token punctuation">(</span><span class="token punctuation">)</span> cannot <span class="token builtin class-name">return</span> the address of the raw string within a str or unicode or bytearray object<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0b79353af7a03ea3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>解决方案：更新 cffi 包，执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> cffi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>安装完毕之后，再次执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> certbot <span class="token parameter variable">--nginx</span> --nginx-server-root<span class="token operator">=</span>/www/server/nginx/conf/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-41ff13f2b481d3c4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5a8be80376cba339.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>发现还是报错，报错信息如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">An unexpected error occurred:UnicodeEncodeError: <span class="token string">'ascii'</span> codec can't encode characters <span class="token keyword">in</span> position <span class="token number">310</span>-328: ordinal not <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>关于 ascii 报错，这篇文章有详细的介绍 <a href="https://xueyuanjun.com/post/9695">通过 Certbot 安装 Let’s Encrypt 证书，来实现全站的 HTTPS 访问</a></p><p>解决方案是：检查你选择的需要配置的 nginx 配置文件中是否含有中文，将所有的中文去掉就好了</p><p>去掉之后，再次执行以下命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> certbot <span class="token parameter variable">--nginx</span> --nginx-server-root<span class="token operator">=</span>/www/server/nginx/conf/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f400a34f94d751c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>大功告成！</p><h3 id="对比一下没有配置-ssl-之前的-nginx-配置"><a href="#对比一下没有配置-ssl-之前的-nginx-配置" class="headerlink" title="对比一下没有配置 ssl 之前的 nginx 配置"></a>对比一下没有配置 ssl 之前的 nginx 配置</h3><p>没有配置 ssl 之前的 nginx 信息</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">server_name</span> www.pudongping.com</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">index</span> index.php index.html index.htm default.php default.htm default.html</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">root</span> /www/wwwroot/www.pudongping.com</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">location</span> ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)</span>    <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置 ssl 之后的配置信息 （现在配置文件中，默认强制性重定向了 https）</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">server_name</span> www.pudongping.com</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">index</span> index.php index.html index.htm default.php default.htm default.html</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">root</span> /www/wwwroot/www.pudongping.com</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">location</span> ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)</span>    <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span> <span class="token comment"># managed by Certbot</span>    <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/letsencrypt/live/www.pudongping.com/fullchain.pem</span><span class="token punctuation">;</span> <span class="token comment"># managed by Certbot</span>    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/letsencrypt/live/www.pudongping.com/privkey.pem</span><span class="token punctuation">;</span> <span class="token comment"># managed by Certbot</span>    <span class="token directive"><span class="token keyword">include</span> /etc/letsencrypt/options-ssl-nginx.conf</span><span class="token punctuation">;</span> <span class="token comment"># managed by Certbot</span>    <span class="token directive"><span class="token keyword">ssl_dhparam</span> /etc/letsencrypt/ssl-dhparams.pem</span><span class="token punctuation">;</span> <span class="token comment"># managed by Certbot</span><span class="token punctuation">}</span><span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$host</span> = www.pudongping.com)</span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token comment"># managed by Certbot</span>    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">server_name</span> www.pudongping.com</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span></span><span class="token punctuation">;</span> <span class="token comment"># managed by Certbot</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="自动更新证书"><a href="#自动更新证书" class="headerlink" title="自动更新证书"></a>自动更新证书</h3><p>由于 Let’s Encrypt 默认的有效期是 90 天，所以如果你的应用需要在生产环境长期提供服务，还要在证书到期之后更新证书，我们可以通过 <code>certbot renew</code> 命令来更新证书，你可以通过如下命令来测试该命令是否生效：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> certbot renew --dry-run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果在输出中看到如下字样，则表示生效：</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-2da74afeee104f94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Congratulations"></p><p>当然，真实环境中通过手动维护是不现实的，我们可以借助 Crontab 来编写一个定时任务，每个月都强制更新一个这个证书，然后重启 Nginx：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> * * certbot renew<span class="token number">5</span> <span class="token number">0</span> <span class="token number">1</span> * * <span class="token function">service</span> nginx restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>或者直接执行官方提供的命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"0 0,12 * * * root python -c 'import random; import time; time.sleep(random.random() * 3600)' &amp;&amp; certbot renew -q"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> /etc/crontab <span class="token operator">&gt;</span> /dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="关于目录"><a href="#关于目录" class="headerlink" title="关于目录"></a>关于目录</h3><ul><li>Certbot 的配置文件目录在 <code>/etc/letsencrypt</code></li><li>Certbot 的 log 预设路径在 <code>/var/log/letsencrypt</code></li><li>网站对应的 <code>.pem </code> 文件路径在 <code>/etc/letsencrypt/live/网站名称/privkey.pem</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> 服务器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> Linux </tag>
            
            <tag> 免费 HTTPS 证书 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ngrok 内网穿透神器</title>
      <link href="posts/5bd7101b.html"/>
      <url>posts/5bd7101b.html</url>
      
        <content type="html"><![CDATA[<h1 id="Ngrok-的使用"><a href="#Ngrok-的使用" class="headerlink" title="Ngrok 的使用"></a>Ngrok 的使用</h1><ul><li><a href="https://dashboard.ngrok.com/user/signup">ngrok 注册地址</a></li><li><a href="https://dashboard.ngrok.com/get-started/setup">ngrok 安装方法</a> 这里我是直接使用的 GitHub 账号注册的。</li></ul><h2 id="ngrok-安装方法"><a href="#ngrok-安装方法" class="headerlink" title="ngrok 安装方法"></a>ngrok 安装方法</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载 zip 安装包（这里我是 mac 环境，因此下载的为 mac 版本的软件，其他环境需要下载对应环境版本的软件）</span><span class="token function">wget</span> https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-darwin-amd64.zip<span class="token comment"># 解压 zip 包</span><span class="token function">unzip</span> ngrok-stable-darwin-amd64.zip<span class="token comment"># 将解压后的执行文件添加到环境变量中</span><span class="token function">mv</span> ./ngrok /usr/local/bin<span class="token comment"># 测试环境变量是否添加成功</span>ngrok <span class="token builtin class-name">help</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ngrok-使用方法"><a href="#ngrok-使用方法" class="headerlink" title="ngrok 使用方法"></a>ngrok 使用方法</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置 authtoken</span><span class="token comment"># 查看你的 authtoken 地址为：https://dashboard.ngrok.com/get-started/your-authtoken</span>ngrok authtoken <span class="token operator">&lt;</span>your-authtoken<span class="token operator">&gt;</span><span class="token comment"># 查看是否已经设置好了</span><span class="token function">cat</span> ~/.ngrok2/ngrok.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="启动-ngrok-客户端"><a href="#启动-ngrok-客户端" class="headerlink" title="启动 ngrok 客户端"></a>启动 ngrok 客户端</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ngrok http -host-header<span class="token operator">=</span>larablog.test <span class="token parameter variable">-region</span> us <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><code>http</code> 代表我们要映射的是 http 协议</li><li><code>-host-header</code> 代表本地站点的域名</li><li><code>- region us</code> 代表我们要使用的是美国的公共节点，au =&gt; 澳大利亚，eu =&gt; 欧洲</li><li><code>80</code> 代表映射到我们本机的 80 端口</li></ul><p>执行以上命令后，会出现如下内容</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Session Status                onlineAccount                       pudongping <span class="token punctuation">(</span>Plan: Free<span class="token punctuation">)</span>Version                       <span class="token number">2.3</span>.37Region                        Europe <span class="token punctuation">(</span>eu<span class="token punctuation">)</span>Web Interface                 http://127.0.0.1:4040Forwarding                    http://fff1bccb7070.eu.ngrok.io -<span class="token operator">&gt;</span> http://localhost:80Forwarding                    https://fff1bccb7070.eu.ngrok.io -<span class="token operator">&gt;</span> http://localhost:80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>Forwarding</code> 代表 ngrok 分配给你的域名，对于免费账号来说，每次启动 ngrok 都会重新分配一个随机的域名，无法固定</li><li><code>Web Interface</code> 是 ngrok 内置的一个管理面板，它可以展示所有通过 ngrok 进来的请求信息以及返回的数据</li></ul><p>此时可以直接在浏览器中访问 <code>http://fff1bccb7070.eu.ngrok.io</code> 即可看到和访问 <code>larablog.test</code> 是一样的内容，此外还可以打开 <code>http://127.0.0.1:4040</code> ngrok 面板查看请求信息</p>]]></content>
      
      
      <categories>
          
          <category> Ngrok </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内网穿透 </tag>
            
            <tag> 本地调试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RHEL 7 重置 root 密码</title>
      <link href="posts/f41190ff.html"/>
      <url>posts/f41190ff.html</url>
      
        <content type="html"><![CDATA[<h1 id="RHEL-7-重置-root-密码"><a href="#RHEL-7-重置-root-密码" class="headerlink" title="RHEL 7 重置 root 密码"></a>RHEL 7 重置 root 密码</h1><ul><li>查看是否为 RHEL7 系统</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看内核版本</span><span class="token function">cat</span> /etc/redhat-release<span class="token comment"># 如果信息为以下内容，则可以采用此方法重置 root 密码</span>Red Hat Enterprise Linux Server release <span class="token number">7.0</span> <span class="token punctuation">(</span>Maipo<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>重启 Linux 系统主机，并出现引导界面时，按下键盘上的 <code>e</code> 键进入内核编辑界面</li></ul><p><img src="/medias/loading.gif" data-original="https://www.linuxprobe.com/wp-content/uploads/2015/02/%E7%AC%AC1%E6%AD%A5%EF%BC%9A%E5%BC%80%E6%9C%BA%E5%90%8E%E5%9C%A8%E5%86%85%E6%A0%B8%E4%B8%8A%E6%95%B2%E5%87%BB%E2%80%9Ce%E2%80%9D.png" alt="图片来源于 www.linuxprobe.com 网站"></p><ul><li>在 <code>linux16</code> 参数这行的最后面（即<code>LANG=en_US.UTF-8</code>尾部）先敲一个 <code>空格</code> 然后添加 <code>\rd.break</code> 参数，然后按下 <code>Ctrl + X</code> 组合键来运行修改过的内核程序</li></ul><blockquote><p>这里需要注意的是：</p><ol><li>页面内容一般情况下是显示不全的，需要按住上下箭头滚动。</li><li>添加 \rd.break 参数的时候，你也可以不用添加 ‘\反斜杠’ 但是必须要先在 linux16 末尾处敲击一个空格之后写入 rd.break 参数</li></ol></blockquote><p><img src="/medias/loading.gif" data-original="https://www.linuxprobe.com/wp-content/uploads/2015/02/%E7%AC%AC2%E6%AD%A5%EF%BC%9A%E5%9C%A8linux16%E8%BF%99%E8%A1%8C%E7%9A%84%E5%90%8E%E9%9D%A2%E8%BE%93%E5%85%A5%E2%80%9Crd.break%E2%80%9D%E5%B9%B6%E6%95%B2%E5%87%BB%E2%80%9Cctrl-x%E2%80%9C.png" alt="图片来源于 www.linuxprobe.com 网站"></p><ul><li>稍后即可进入系统的紧急救援模式</li></ul><p><img src="/medias/loading.gif" data-original="https://www.linuxprobe.com/wp-content/uploads/2015/02/%E7%AC%AC3%E6%AD%A5%EF%BC%9A%E8%BF%9B%E5%85%A5%E5%88%B0%E4%BA%86%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%B4%A7%E6%80%A5%E6%B1%82%E6%8F%B4%E6%A8%A1%E5%BC%8F.png" alt="图片来源于 www.linuxprobe.com 网站"></p><ul><li>依次输入以下命令，等待系统重启操作完毕，然后就可以使用新密码来登录 Linux 系统了。</li></ul><ol><li>以可读写的权限重新挂载硬盘上真实系统根目录（ /sysroot ）目录</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -o remount：将一个已经挂下的档案系统重新用不同的方式挂上。</span><span class="token comment"># 例如原先是唯读的系统，现在用可读写的模式重新挂上。</span><span class="token comment"># -o rw：用可读写模式挂上。</span><span class="token comment"># 可以合并参数写，即 mount -o remount,rw</span><span class="token function">mount</span> <span class="token parameter variable">-o</span> remount,rw / /sysroot<span class="token comment"># 同样也可以直接写成这样 （直接省略掉根目录 / ）</span><span class="token function">mount</span> <span class="token parameter variable">-o</span> remount,rw /sysroot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>把环境切换到真实系统根目录 /sysroot</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chroot</span> /sysroot<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>修改 root 账户密码</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 输入 passwd 命令时，是交互式界面。  </span><span class="token comment"># 同样也可以直接输入 echo "redhat" | passwd --stdin root 命令，直接将 root 密码，修改为 redhat</span><span class="token function">passwd</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>告诉系统下次启动将对文件进行 selinux 上下文重新打标。这也就造成了下次重启的时候时间会很长，autorelabel 是一个隐藏文件，需要注意的是前面有一个点</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">touch</span> /.autorelabel<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>退出真实系统根目录环境</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">exit</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="6"><li>重启系统</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://www.linuxprobe.com/wp-content/uploads/2015/02/%E7%AC%AC4%E6%AD%A5%EF%BC%9A%E4%BE%9D%E6%AC%A1%E8%BE%93%E5%85%A5%E4%BB%A5%E4%B8%8B%E5%91%BD%E4%BB%A4.png"></p><ul><li>修改密码后，首次重启的时间将会比较长，因为系统将对所有文件进行 SeLinux 打标，请耐心等待，整个过程并非死机，请勿在打标过程中手动强制再次重启，否则系统将会永久性损坏导致无法开机。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hyperf 使用模型写较为复杂 union 子查询并做分页</title>
      <link href="posts/7dec67c2.html"/>
      <url>posts/7dec67c2.html</url>
      
        <content type="html"><![CDATA[<h1 id="hyperf-使用模型写-union-子查询并做分页"><a href="#hyperf-使用模型写-union-子查询并做分页" class="headerlink" title="hyperf 使用模型写 union 子查询并做分页"></a>hyperf 使用模型写 union 子查询并做分页</h1><h2 id="最终需要实现的-sql-语句为如下所示："><a href="#最终需要实现的-sql-语句为如下所示：" class="headerlink" title="最终需要实现的 sql 语句为如下所示："></a>最终需要实现的 sql 语句为如下所示：</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span><span class="token identifier"><span class="token punctuation">`</span>dfo_al<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>log_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>change_time<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>pay_points<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>change_type<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>from_user_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>u_user_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>head_pic<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>vip_time<span class="token punctuation">`</span></span> <span class="token keyword">FROM</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token identifier"><span class="token punctuation">`</span>dfo_users<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span> <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">WHERE</span><span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">3649</span> <span class="token operator">AND</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>pay_points<span class="token punctuation">`</span></span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>from_user_id<span class="token punctuation">`</span></span> <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>from_user_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">UNION</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>log_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>change_time<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>pay_points<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>change_type<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>from_user_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>u_user_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>head_pic<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>vip_time<span class="token punctuation">`</span></span> <span class="token keyword">FROM</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token identifier"><span class="token punctuation">`</span>dfo_users<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span> <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>from_user_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token identifier"><span class="token punctuation">`</span>u<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">WHERE</span><span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">3649</span> <span class="token operator">AND</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>pay_points<span class="token punctuation">`</span></span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>from_user_id<span class="token punctuation">`</span></span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>from_user_id<span class="token punctuation">`</span></span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">AS</span> dfo_al <span class="token keyword">ORDER</span> <span class="token keyword">BY</span><span class="token identifier"><span class="token punctuation">`</span>log_id<span class="token punctuation">`</span></span> <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">2</span> <span class="token keyword">OFFSET</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="hyperf-代码为"><a href="#hyperf-代码为" class="headerlink" title="hyperf 代码为"></a>hyperf 代码为</h2><blockquote><p>以下代码仅为示例代码，仅提供参考使用，具体实现请根据你自己的业务逻辑实现。</p></blockquote><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$where</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span><span class="token string single-quoted-string">'a.user_id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">user_id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token string single-quoted-string">'a.pay_points'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$fields</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string single-quoted-string">'a.log_id'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'a.change_time'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'a.user_id'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'a.pay_points'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'a.change_type'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'a.from_user_id'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'u.user_id AS u_user_id'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'u.username'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'u.head_pic'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'u.vip_time'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$table1</span> <span class="token operator">=</span> <span class="token class-name static-context">AccountLog</span><span class="token operator">::</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'account_log as a'</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">leftJoin</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users as u'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'a.user_id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'u.user_id'</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token variable">$fields</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$where</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">whereNull</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a.from_user_id'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a.from_user_id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$table2</span> <span class="token operator">=</span> <span class="token class-name static-context">AccountLog</span><span class="token operator">::</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'account_log as a'</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">leftJoin</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users as u'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'a.from_user_id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'u.user_id'</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token variable">$fields</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$where</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a.from_user_id'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a.from_user_id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$table</span> <span class="token operator">=</span> <span class="token variable">$table1</span><span class="token operator">-&gt;</span><span class="token function">union</span><span class="token punctuation">(</span><span class="token variable">$table2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$tablePrefix</span> <span class="token operator">=</span> <span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getTablePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取数据表前缀 =&gt; 或者使用  $tablePrefix = Db::getConfig('prefix'); 都可以</span><span class="token variable">$model</span> <span class="token operator">=</span> <span class="token class-name static-context">AccountLog</span><span class="token operator">::</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">mergeBindings</span><span class="token punctuation">(</span><span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'al.*'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"(<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">toSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>) as <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$tablePrefix</span><span class="token punctuation">}</span></span>"</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'al'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'log_id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'desc'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">paginate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hyperf </tag>
            
            <tag> Swoole </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>针对 hyperf 框架实现简单限流器，类似 laravel 框架 throttle 中间件功能</title>
      <link href="posts/f2f7e2ee.html"/>
      <url>posts/f2f7e2ee.html</url>
      
        <content type="html"><![CDATA[<h1 id="针对-hyperf-框架实现简单限流器，类似-laravel-框架-throttle-中间件功能"><a href="#针对-hyperf-框架实现简单限流器，类似-laravel-框架-throttle-中间件功能" class="headerlink" title="针对 hyperf 框架实现简单限流器，类似 laravel 框架 throttle 中间件功能"></a>针对 hyperf 框架实现简单限流器，类似 laravel 框架 throttle 中间件功能</h1><p><strong>注意</strong>：以下功能已经单独迁移到 <a href="https://github.com/pudongping/hyperf-throttle-requests">pudongping/hyperf-throttle-requests</a> 插件包中，并支持了 hyperf 2.2 和 3.0 版本。</p><h2 id="限流器的概念"><a href="#限流器的概念" class="headerlink" title="限流器的概念"></a>限流器的概念</h2><p>所谓限流器，指的是限制访问指定服务/路由的流量，通俗点说，就是限制单位时间内访问指定服务/路由的次数（频率），<br>从系统架构角度看，通过限流器可以有效避免短时间内的异常高并发请求导致系统负载过高，从而达到保护系统的目的，<br>另外对于一些日常的业务功能，也可以通过限流器避免垃圾流量，比如发送短信服务、用户注册、文章发布、用户评论等，<br>通过限流可以有效阻止垃圾用户的批量注册和发布。</p><h2 id="简单实现方案"><a href="#简单实现方案" class="headerlink" title="简单实现方案"></a>简单实现方案</h2><blockquote><p>这里采用了 <code>redis</code> 作为存储器，以下内容全部基于 <code>redis</code> 而言。</p></blockquote><ul><li>通过 <code>setex</code> 指令初始化限流器的键（基于用户 ID、IP 地址等标识来源的变量进行拼接）、并设置有效期（作为一个计时器）；</li><li>首次访问某个服务/路由时，通过 <code>increment</code> 指令初始化一个新的统计键值对（作为一个计数器），后续在计时器有效期内访问同一个服务/路由，通过 <code>increment</code> 指令对键值做自增操作；</li><li>当该服务/路由的访问次数超过限流器设置的访问上限，则拒绝后续访问。</li></ul><h2 id="注意-⚠️"><a href="#注意-⚠️" class="headerlink" title="注意 ⚠️"></a>注意 ⚠️</h2><blockquote><p>以下功能实现代码中使用到了很多助手函数，建议首先参考我的 <a href="https://pudongping.github.io/posts/79e7b1a4.html">hyperf 框架常用的助手函数</a> 一文，查看具体的助手函数。<br>其中 <code>auth()</code> 方法为获取当前登录的用户信息。</p></blockquote><h2 id="Talk-is-cheap-show-me-the-code-😜"><a href="#Talk-is-cheap-show-me-the-code-😜" class="headerlink" title="Talk is cheap, show me the code. 😜"></a>Talk is cheap, show me the code. 😜</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 节流处理 * 用途：限制访问频率 * 做法：限制单位时间内访问指定服务/路由的次数（频率） */</span><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Helper</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Carbon<span class="token punctuation">\</span>Carbon</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Psr<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Message<span class="token punctuation">\</span>ResponseInterface</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Utils<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Exception<span class="token punctuation">\</span>ApiException</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Constants<span class="token punctuation">\</span>ErrorCode</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">ThrottleRequestsHelper</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 用于做计时器的缓存key后缀     *     * @var string     */</span>    <span class="token keyword">protected</span> <span class="token variable">$keySuffix</span> <span class="token operator">=</span> <span class="token string single-quoted-string">':timer'</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 处理节流     *     * @param int $maxAttempts  在指定时间内允许的最大请求次数     * @param int $decaySeconds  单位时间（s）     * @param string $prefix  计数器缓存key前缀     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token keyword type-hint">int</span> <span class="token variable">$maxAttempts</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$decaySeconds</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$prefix</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'dfo:throttle'</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$prefix</span> <span class="token operator">.</span> <span class="token string single-quoted-string">':'</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resolveRequestSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 计数器的缓存key</span>        <span class="token comment">// 单位时间内已经超过了访问次数时</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">tooManyAttempts</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildException</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">hit</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$decaySeconds</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setHeaders</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 生成缓存 key     *     * @return string     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">resolveRequestSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'|'</span> <span class="token operator">.</span> <span class="token function">getClientIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$str</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'|'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">user_id</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 在指定时间内增加指定键的计数器     *     * @param string $key  计数器的缓存key     * @param int $decaySeconds  指定时间（S）     * @return int  计数器具体增加到多少值     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">hit</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$decaySeconds</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">int</span>    <span class="token punctuation">{</span>        <span class="token variable">$timerKey</span> <span class="token operator">=</span> <span class="token variable">$key</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">keySuffix</span><span class="token punctuation">;</span>        <span class="token comment">// 计时器的有效期时间戳</span>        <span class="token variable">$expirationTime</span> <span class="token operator">=</span> <span class="token class-name static-context">Carbon</span><span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addRealSeconds</span><span class="token punctuation">(</span><span class="token variable">$decaySeconds</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 计时器</span>        <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token variable">$timerKey</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$expirationTime</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'EX'</span> <span class="token operator">=&gt;</span> <span class="token variable">$decaySeconds</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'NX'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 计数器</span>        <span class="token variable">$added</span> <span class="token operator">=</span> <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'EX'</span> <span class="token operator">=&gt;</span> <span class="token variable">$decaySeconds</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'NX'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 自增（返回增加到多少的具体数字）</span>        <span class="token variable">$hits</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$added</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$hits</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 证明是初始化</span>            <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'1'</span><span class="token punctuation">,</span> <span class="token variable">$decaySeconds</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$hits</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 判断访问次数是否已经达到了临界值     *     * @param string $key  计数器的缓存key     * @param int $maxAttempts  在指定时间内允许的最大请求次数     * @return bool     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">tooManyAttempts</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 获取计数器的值，如果计数器不存在，则初始化计数器的值为 0</span>        <span class="token comment">// 获取一个不存在的键时，会直接返回 false</span>        <span class="token variable">$counterNumber</span> <span class="token operator">=</span> <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 判断计时器是否存在，如果计时器不存在，则对应的计数器没有存在的意义（存在过多的计数器会占用 redis 空间）</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token variable">$key</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">keySuffix</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 存在缓存key时返回 int =&gt; 1，不存在时返回 int =&gt; 0</span>            <span class="token comment">// 有该键名且删除成功返回 int =&gt; 1，无该键名时返回 int =&gt; 0</span>            <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 删除计数器缓存，防止计时器失效后，下一次用户访问时不是从 1 开始计数</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$counterNumber</span> <span class="token operator">&gt;=</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 判断计数器在单位时间内是否达到了临界值</span>                <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 超过访问次数限制时，构建异常信息     *     * @param string $key  计数器的缓存key     * @param int $maxAttempts  在指定时间内允许的最大请求次数     * @return ApiException     */</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">buildException</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 距离允许下一次请求还有多少秒</span>        <span class="token variable">$retryAfter</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getTimeUntilNextRetry</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setHeaders</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">,</span> <span class="token variable">$retryAfter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 429 Too Many Requests</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApiException</span><span class="token punctuation">(</span><span class="token class-name static-context">ErrorCode</span><span class="token operator">::</span><span class="token constant">REQUEST_FREQUENTLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 设置返回头数据     *     * @param string $key  计数器的缓存key     * @param int $maxAttempts  在指定时间内允许的最大请求次数     * @param int|null $retryAfter  距离下次重试请求需要等待的时间（s）     */</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">setHeaders</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token keyword type-hint">int</span> <span class="token variable">$retryAfter</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 设置返回头数据</span>        <span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getHeaders</span><span class="token punctuation">(</span>            <span class="token variable">$maxAttempts</span><span class="token punctuation">,</span>            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">calculateRemainingAttempts</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">,</span> <span class="token variable">$retryAfter</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 计算剩余访问次数</span>            <span class="token variable">$retryAfter</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 添加返回头数据到请求头中</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">addHeaders</span><span class="token punctuation">(</span><span class="token variable">$headers</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取返回头数据     *     * @param int $maxAttempts  在指定时间内允许的最大请求次数     * @param int $remainingAttempts  在指定时间段内剩下的请求次数     * @param int|null $retryAfter  距离下次重试请求需要等待的时间（s）     * @return int[]     */</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getHeaders</span><span class="token punctuation">(</span><span class="token keyword type-hint">int</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$remainingAttempts</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token keyword type-hint">int</span> <span class="token variable">$retryAfter</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token string single-quoted-string">'X-RateLimit-Limit'</span> <span class="token operator">=&gt;</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">,</span>  <span class="token comment">// 在指定时间内允许的最大请求次数</span>            <span class="token string single-quoted-string">'X-RateLimit-Remaining'</span> <span class="token operator">=&gt;</span> <span class="token variable">$remainingAttempts</span><span class="token punctuation">,</span>  <span class="token comment">// 在指定时间段内剩下的请求次数</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$retryAfter</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 只有当用户访问频次超过了最大频次之后才会返回以下两个返回头字段</span>            <span class="token variable">$headers</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Retry-After'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$retryAfter</span><span class="token punctuation">;</span>  <span class="token comment">// 距离下次重试请求需要等待的时间（s）</span>            <span class="token variable">$headers</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'X-RateLimit-Reset'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name static-context">Carbon</span><span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addRealSeconds</span><span class="token punctuation">(</span><span class="token variable">$retryAfter</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 距离下次重试请求需要等待的时间戳（s）</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$headers</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 添加请求头数据     *     * @param array $headers     */</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">addHeaders</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token class-name static-context">Context</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">ResponseInterface</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$headers</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$header</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-&gt;</span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$header</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name static-context">Context</span><span class="token operator">::</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name static-context">ResponseInterface</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 计算距离允许下一次请求还有多少秒     *     * @param string $key     * @return false|int|mixed|string     */</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getTimeUntilNextRetry</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$key</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 在 $this-&gt;tooManyAttempts() 方法中已经判断了计时器的缓存 key 是否存在，因此在这里毋需再次累赘判断</span>        <span class="token comment">// 计时器的有效期减去当前时间戳</span>        <span class="token keyword">return</span> <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">keySuffix</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name static-context">Carbon</span><span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 计算剩余访问次数     *     * @param string $key 计数器的缓存key     * @param int $maxAttempts  在指定时间内允许的最大请求次数     * @param int|null $retryAfter  距离下次重试请求需要等待的时间（s）     * @return false|int|mixed|string     */</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">calculateRemainingAttempts</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$maxAttempts</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token keyword type-hint">int</span> <span class="token variable">$retryAfter</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$retryAfter</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 获取一个不存在的键时，会直接返回 false</span>            <span class="token variable">$counterNumber</span> <span class="token operator">=</span> <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token variable">$maxAttempts</span> <span class="token operator">-</span> <span class="token variable">$counterNumber</span><span class="token punctuation">;</span>  <span class="token comment">// 剩余访问次数</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hyperf </tag>
            
            <tag> Swoole </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hyperf 框架常用的助手函数</title>
      <link href="posts/79e7b1a4.html"/>
      <url>posts/79e7b1a4.html</url>
      
        <content type="html"><![CDATA[<p>以下列出部分 hyperf 常用的助手函数</p><blockquote><p>其中要是想获取当前请求的路由所对应的控制器和方法，请直接调用 <code>get_current_action()</code> 方法</p></blockquote><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/** * 自定义助手函数 */</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Utils<span class="token punctuation">\</span>ApplicationContext</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Redis<span class="token punctuation">\</span>Redis</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Contract<span class="token punctuation">\</span>StdoutLoggerInterface</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Logger<span class="token punctuation">\</span>LoggerFactory</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>HttpServer<span class="token punctuation">\</span>Contract<span class="token punctuation">\</span>RequestInterface</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>HttpServer<span class="token punctuation">\</span>Contract<span class="token punctuation">\</span>ResponseInterface</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>HttpServer<span class="token punctuation">\</span>Router<span class="token punctuation">\</span>Dispatched</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Hyperf<span class="token punctuation">\</span>Server<span class="token punctuation">\</span>ServerFactory</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Swoole<span class="token punctuation">\</span>Websocket<span class="token punctuation">\</span>Frame</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Swoole<span class="token punctuation">\</span>WebSocket<span class="token punctuation">\</span>Server</span> <span class="token keyword">as</span> WebSocketServer<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Psr<span class="token punctuation">\</span>SimpleCache<span class="token punctuation">\</span>CacheInterface</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 获取容器对象     *     * @return \Psr\Container\ContainerInterface     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name static-context">ApplicationContext</span><span class="token operator">::</span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'redis'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     *  获取 Redis 协程客户端     *     * @return Redis|mixed     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">Redis</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'std_out_log'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 控制台日志     *     * @return StdoutLoggerInterface|mixed     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">std_out_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">StdoutLoggerInterface</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'logger'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 文件日志     *     * @return \Psr\Log\LoggerInterface     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">LoggerFactory</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * request 实例     *     * @return RequestInterface|mixed     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">RequestInterface</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'response'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * response 实例     *     * @return ResponseInterface|mixed     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">ResponseInterface</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'server'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 基于 swoole server 的 server 实例     *     * @return \Swoole\Coroutine\Server|\Swoole\Server     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">ServerFactory</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'frame'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * websocket frame 实例     *     * @return mixed|Frame     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">Frame</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'websocket'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * websocket 实例     *     * @return mixed|WebSocketServer     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">websocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">WebSocketServer</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'cache'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 简单的缓存实例     *     * @return mixed|CacheInterface     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name static-context">CacheInterface</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'get_current_action'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 获取当前请求的控制器和方法     *     * @return array     */</span>    <span class="token keyword">function</span> <span class="token function-definition function">get_current_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword return-type">array</span>    <span class="token punctuation">{</span>        <span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name static-context">Dispatched</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">property_exists</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'handler'</span><span class="token punctuation">)</span>            <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token operator">-&gt;</span><span class="token property">handler</span><span class="token punctuation">)</span>            <span class="token operator">&amp;&amp;</span> <span class="token function">property_exists</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token operator">-&gt;</span><span class="token property">handler</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'callback'</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$action</span> <span class="token operator">=</span> <span class="token variable">$obj</span><span class="token operator">-&gt;</span><span class="token property">handler</span><span class="token operator">-&gt;</span><span class="token property">callback</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'The route is undifined! Please check!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$errMsg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'The controller and method are not found! Please check!'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">$action</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'::'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'::'</span><span class="token punctuation">,</span> <span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'@'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'@'</span><span class="token punctuation">,</span> <span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$errMsg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">std_out_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$errMsg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$controller</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$errMsg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">std_out_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$errMsg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'controller'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'method'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hyperf </tag>
            
            <tag> Swoole </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用亚马逊云 AWS 配置服务器并使用 xshell 远程连接</title>
      <link href="posts/34efcb18.html"/>
      <url>posts/34efcb18.html</url>
      
        <content type="html"><![CDATA[<h1 id="使用亚马逊云-AWS-配置服务器并使用-xshell-远程连接"><a href="#使用亚马逊云-AWS-配置服务器并使用-xshell-远程连接" class="headerlink" title="使用亚马逊云 AWS 配置服务器并使用 xshell 远程连接"></a>使用亚马逊云 AWS 配置服务器并使用 xshell 远程连接</h1><h2 id="如果之前使用亚马逊云配置服务器没有配置成功，那么请按照下面的方式删除掉实例"><a href="#如果之前使用亚马逊云配置服务器没有配置成功，那么请按照下面的方式删除掉实例" class="headerlink" title="如果之前使用亚马逊云配置服务器没有配置成功，那么请按照下面的方式删除掉实例"></a>如果之前使用亚马逊云配置服务器没有配置成功，那么请按照下面的方式删除掉实例</h2><ul><li><a href="https://us-east-2.console.aws.amazon.com/ec2/home?region=us-east-2#Instances:">打开当前实例列表</a></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-bd64bb68e37736b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="你自己的实例列表"></p><ul><li>终止你想要删除的实例（我看文档说的是，终止实例其实就表示删除了实例，终止实例会删除掉服务器中的文件，但是停止实例不会）</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-fa7c851c14f1977f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="终止实例"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-688dde3c0f03d746.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="终止实例会删除掉服务器中的所有文件"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6d0c8540ccaaf4e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="终止后的状态"></p><ul><li>如果想彻底删除掉实例，还需要删除掉 「卷」（不手动删除的话，亚马逊云也会过一段时间自动删除）</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-16fbeb3feda581a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="选择卷组"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8273f1d73ddf2641.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="实例列表也会过一段时间自动删除"></p><h2 id="接下来开始配置新的服务器"><a href="#接下来开始配置新的服务器" class="headerlink" title="接下来开始配置新的服务器"></a>接下来开始配置新的服务器</h2><ul><li><p>创建一个新的实例<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-94887efe4899baba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="直接在实例控制台上面启动一个新的实例"></p></li><li><p>配置服务器<br><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a0a7f77087175125.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="按照这些步骤一步一步的来，选择你自己的自定义配置就可以了"></p></li><li><p>选择硬盘空间大小（按需选择就好，如果超过了套餐外的硬盘空间会收费，建议还是先检查自己的套餐最大硬盘空间）</p></li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-15d94915c460e4bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="设置硬盘空间大小"></p><ul><li>最最最重要的步骤就是，一定要选择密钥对或者直接在这里生成密钥对，并且一定要下载密钥对，因为密钥对只允许下载一次，错过了，等于你这个实例就无法登录了。亚马逊云默认关闭了账号密码连接 ssh 服务，初次连接只允许密钥对。</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e95c5b055cfa982b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="选择已生成的密钥对或者直接在这里生成"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b0479e4003995376.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="我没有提前生成密钥对，因此我在这里直接生成一个密钥对"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7a22bfdf90b62c72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="下载密钥对"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b4845a5e820c5f57.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="打开实例"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-bc31ca359b59438a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="已经安装好了服务器"></p><h2 id="接下来讲解使用-xshell-连接亚马逊云服务器"><a href="#接下来讲解使用-xshell-连接亚马逊云服务器" class="headerlink" title="接下来讲解使用 xshell 连接亚马逊云服务器"></a>接下来讲解使用 xshell 连接亚马逊云服务器</h2><blockquote><p>建议还是先看一下文档：<a href="https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/managing-users.html">https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/managing-users.html</a></p></blockquote><ul><li>根据你选择的系统寻找到亚马逊云默认给你创建的账户名</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1bfd9833871ee335.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="我选择的是 redhat 系统，因此用户名是 ec2-user 或 root"></p><ul><li>打开 xshell ，配置用户身份验证</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a62480d370da6f50.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配置用户身份验证"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-7823047ee33c0a5b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="导入密钥对"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d8f8286d1d98330a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="选中密钥对"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-78459d37d9fa3827.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="效果如下"></p><ul><li>配置连接</li></ul><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-46b2bcf9a3277ade.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="复制共有 DNS"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3125ba8d0bec81fb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配置连接"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6eee19e6b21804b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="连接成功"></p><h2 id="亚马逊云默认关闭了-root-连接-ssh，接下来讲解如何使用-root-用户登录-ssh"><a href="#亚马逊云默认关闭了-root-连接-ssh，接下来讲解如何使用-root-用户登录-ssh" class="headerlink" title="亚马逊云默认关闭了 root 连接 ssh，接下来讲解如何使用 root 用户登录 ssh"></a>亚马逊云默认关闭了 root 连接 ssh，接下来讲解如何使用 root 用户登录 ssh</h2><ol><li>更改 root 用户密码</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">passwd</span> root<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>切换到 root 用户</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">su</span> - 或者<span class="token function">su</span> root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-31aaa46c330d2e75.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="修改 root 用户密码"></p><ol start="3"><li>修改 sshd_config 配置文件</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/ssh/sshd_config<span class="token comment"># 如果提示没有 vim 编辑器，则可以直接使用 vi 编辑器</span><span class="token function">vi</span> /etc/ssh/sshd_config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-2e587674dfadf7b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="编辑 sshd 服务主配置文件"></p><ol start="4"><li>开启密码验证</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PasswordAuthentication <span class="token function">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0cd7175dbad6da90.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="查看是否允许密码验证"></p><ol start="5"><li>设定是否允许root管理员直接登录</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PermitRootLogin <span class="token function">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-76801d3921d2d1b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="查看是否允许 root 管理员直接登录"></p><ol start="6"><li>重启 sshd 服务</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 重启 sshd 服务</span>systemctl restart sshd<span class="token comment"># 将 sshd 服务加入到开机启动项中</span>systemctl <span class="token builtin class-name">enable</span> sshd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="7"><li>测试连接</li></ol><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-096bb85b62b21053.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="使用公网 ip 和 root 用户连接 ssh"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-8bdb83fbbe69a83e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="使用 root 账号密码连接 ssh"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d29f7e82e877c3e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="至此，使用 root 用户连接成功"></p>]]></content>
      
      
      <categories>
          
          <category> 服务器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 服务器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 python3 写的文档格式转换小工具</title>
      <link href="posts/6cc526bb.html"/>
      <url>posts/6cc526bb.html</url>
      
        <content type="html"><![CDATA[<h1 id="document-converter-（文档格式互转工具）"><a href="#document-converter-（文档格式互转工具）" class="headerlink" title="document-converter （文档格式互转工具）"></a>document-converter （文档格式互转工具）</h1><h2 id="项目发起初衷"><a href="#项目发起初衷" class="headerlink" title="项目发起初衷"></a>项目发起初衷</h2><p>近期有朋友要我帮忙将 pdf 格式文档数据提取成 docx 格式，平时我自己要么就通过编辑器转换了，要么就通过命令行转换，但这种方式对于一些朋友来说不是很友好，故此有此项目。</p><p>目前只支持 docx 和 pdf 互转，后续有时间了，会考虑支持多种常用文档格式互转，如果你对这感兴趣，欢迎提 PR ！</p><h2 id="项目特性"><a href="#项目特性" class="headerlink" title="项目特性"></a>项目特性</h2><ul><li>使用 python3 编写的 docx、pdf 互转工具。</li><li>支持多线程。</li><li>支持跨平台（macOS、Windows、Linux）。</li><li>批量 docx 文档转 pdf 格式（效果良好）。</li><li>批量 pdf 文档转 docx 格式（尝试过多个扩展库，遗憾的是均不支持图片提取）。</li><li>后续有时间了，会考虑支持多种常用的文档格式互转。</li></ul><h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p>命令行提示</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-155e22f797a6ee6f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="文档简介"></p><p>批量 docx 转 pdf</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3df6914674c7e060.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="docx转pdf"></p><p>批量 pdf 转 docx</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-800ff9980abdb59a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="pdf转docx"></p><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ol><li>克隆源代码</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># GitHub</span><span class="token function">git</span> clone https://github.com/pudongping/document-converter.git<span class="token comment"># gitee</span><span class="token function">git</span> clone https://gitee.com/pudongping/document-converter.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>进入项目根目录，并安装相关依赖扩展</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> document-converter <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> pip <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>使用文档格式转换</li></ol><p>举个例子来说，如果此时我想将 <code>n</code> 个 <code>.docx</code> 格式的文档转换成 <code>.pdf</code> 格式的文档，那么我需要这么操作：</p><ul><li>将这 <code>n</code> 个 <code>.docx</code> 文档复制到此项目的 <code>data/input/docxs</code> 目录（如果想转 <code>.pdf</code> 格式的文档，则需要将文档复制到 <code>data/input/pdfs</code> 目录）</li><li>在项目根目录执行 <code>python3 main.py --docx-to-pdf</code> 命令，且等待命令执行结束（你可以去泡杯咖啡，之后静静等待，一般来说会很快，因为支持多线程）</li><li>之后在 <code>data/output/pdfs</code> 目录查看已经转换好的文档。至此，完毕！</li></ul><ol start="4"><li>命令介绍</li></ol><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>python3 main.py –version</td><td>显示当前应用的版本号</td></tr><tr><td>python3 main.py –help 或者 python3 main.py -h</td><td>显示帮助文档</td></tr><tr><td>python3 main.py –docx-to-pdf</td><td>执行 docx 文档转成 pdf 格式的文档</td></tr><tr><td>python3 main.py –pdf-to-docx</td><td>执行 pdf 文档转成 docx 格式的文档</td></tr></tbody></table><h2 id="项目目录介绍"><a href="#项目目录介绍" class="headerlink" title="项目目录介绍"></a>项目目录介绍</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">├── LICENSE├── Pipfile├── README.md  项目介绍文档├── app  代码目录│   ├── __init__.py│   ├── config  配置文件目录│   │   ├── __init__.py│   │   └── app.py  配置相关│   ├── converter  转换相关代码目录│   │   ├── __init__.py│   │   ├── converter_docx.py  *文档转 docx 格式相关代码│   │   └── converter_pdf.py   *文档转 pdf 格式相关代码│   └── helper.py  助手函数├── data  数据相关│   ├── input  需要转换的文档目录│   │   ├── docxs  如果需要将 docx 文档转换成其他格式，则默认需要将文档放入此目录下│   │   │   ├── 文档1.docx│   │   │   └── 文档2.docx│   │   └── pdfs  如果需要将 pdf 文档转换成其他格式，则默认需要将文档放入此目录下│   │       ├── alex1.pdf│   │       └── sample.pdf│   └── output  文档转换后存放的文档目录│       ├── docxs  所有经过转换后的 docx 文档默认会放到此目录下│       │   ├── alex1.pdf.docx│       │   └── sample.pdf.docx│       └── pdfs  所有经过转换后的 pdf 文档默认会放到此目录下│           ├── 文档1.docx.pdf│           └── 文档2.docx.pdf├── main.py  项目入口文件├── requirements.txt  项目依赖关系清单└── runtime  项目运行相关    └── logs  日志目录        └── <span class="token number">202104</span>            └── converter-2021-04-24.log  以天为单位记录的操作日志<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>源代码基于 <a href="https://opensource.org/licenses/MIT">MIT</a> 协议发布。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubiquitous-nodejs</title>
      <link href="posts/6b5490ac.html"/>
      <url>posts/6b5490ac.html</url>
      
        <content type="html"><![CDATA[<p align="center">    </p><h1 align="center"><a href="https://pudodngping.com">ubiquitous-nodejs</a></h1>    <p align="center">⚡ ubiquity-nodejs 是一个基于 node.js 的 web 脚手架。😘 支持模版渲染、Restful API、ORM 等特性，遵循 MVC 架构。</p><p></p><h2 id="如何部署项目？"><a href="#如何部署项目？" class="headerlink" title="如何部署项目？"></a>如何部署项目？</h2><p>仓库地址：</p><ul><li><a href="https://github.com/pudongping/ubiquitous-nodejs.git">GitHub</a></li><li><a href="https://gitee.com/pudongping/ubiquitous-nodejs.git">Gitee</a></li></ul><p>本地部署</p><ol><li>直接使用 git 拉取项目源码，并进入项目根目录</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://gitee.com/pudongping/ubiquitous-nodejs.git ubiquitous <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> ./ubiquitous<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>安装项目依赖包</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>填写配置信息</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 复制开发环境配置文件</span><span class="token function">cp</span> ./config/development.js.example ./config/development.js<span class="token comment"># 复制生产环境配置文件</span><span class="token function">cp</span> ./config/production.js.example ./config/production.js<span class="token comment"># 复制测试环境配置文件</span><span class="token function">cp</span> ./config/test.js.example ./config/test.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>导入初始数据表<blockquote><p>这里只是为了演示 restful api 的 CRUD 功能，故此创建了一个初始数据库。</p></blockquote></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 连接数据库</span>mysql <span class="token parameter variable">-h</span> <span class="token operator">&lt;</span>your-mysql-host<span class="token operator">&gt;</span> <span class="token parameter variable">-u</span> <span class="token operator">&lt;</span>your-mysql-account<span class="token operator">&gt;</span> <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>your-mysql-password<span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token comment"># 导入初始数据表</span><span class="token builtin class-name">source</span> ./database/ubiquitous.sql<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>启动项目<blockquote><p>以下方式执行任意一条命令即可</p></blockquote></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接使用 node 执行项目入口文件的方式</span><span class="token function">node</span> <span class="token parameter variable">--use_strict</span> app.js<span class="token comment"># 使用 npm 执行</span><span class="token comment"># 运行开发环境</span><span class="token function">npm</span> start<span class="token comment"># 或者</span><span class="token function">npm</span> run dev<span class="token comment"># 运行生产环境</span><span class="token function">npm</span> run prod<span class="token comment"># 运行测试环境</span><span class="token function">npm</span> run <span class="token builtin class-name">test</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>搭建完毕！enjoy it! ✌️<blockquote><p>可以打开浏览器访问 <code>localhost:9500</code> 或者 <code>127.0.0.1:9500</code> 进行访问，即可看到首页欢迎语。</p></blockquote></li></ol><h2 id="关于项目目录"><a href="#关于项目目录" class="headerlink" title="关于项目目录"></a>关于项目目录</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">├── LICENSE  License├── README.md  项目说明文档├── app.js  项目入口文件├── bootstrap  项目启动目录│   ├── boot.js  启动文件│   ├── db.js  数据库封装│   ├── rest.js  restful api 方法封装│   ├── static-files.js  静态文件处理方法封装│   └── templating.js  模版处理方法封装├── config  配置文件目录│   ├── development.js  开发环境配置文件│   ├── development.js.example  开发环境配置文件模版│   ├── production.js.example  生产环境配置文件模版│   └── test.js.example  测试环境配置文件模板├── constants  常量文件│   └── ErrorCode.js  api 错误码常量├── controllers  控制器目录│   ├── auth  auth 模块目录│   │   └── user_controller.js  用户控制器（这里作为演示 restful api 写的 demo）│   └── home_controller.js  首页控制器 （这里作为演示模版调用写的 demo）├── database  数据文件目录│   └── ubiquitous.sql  初始化数据库文件├── lib  工具目录│   ├── api_error.js  自定义错误异常类│   └── helper.js  助手函数├── loader.js  项目加载文件（这里定义项目全局变量）├── models  模型目录│   ├── WebSite.js  站点模型文件│   ├── auth  auth 模块模型目录│   │   └── User.js  用户模型文件│   └── model.js  自动化扫描加载所有的模型├── package-lock.json  插件包描述锁文件├── package.json  插件包描述文件├── routes  路由目录│   ├── api.js  restful api 路由目录│   └── web.js  web 路由目录├── services  服务层目录│   └── auth  auth 模块服务层目录│       └── user_service.js  用户服务层文件├── static  静态文件目录│   ├── css  样式文件目录│   │   ├── googleapis-fonts.css│   │   └── iview.css│   ├── fonts  字体文件目录│   └── js  js 文件目录│       ├── iview.min.js│       └── vue.min.js└── views  视图层文件目录    ├── base.html  视图基础文件    ├── home  home 模块视图文件目录    │   └── hello.html    └── home.html  首页视图文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="项目所使用依赖包"><a href="#项目所使用依赖包" class="headerlink" title="项目所使用依赖包"></a>项目所使用依赖包</h2><table><thead><tr><th>插件包</th><th>作用</th></tr></thead><tbody><tr><td><a href="https://koa.bootcss.com/">koa</a></td><td>使用 Koa2 作为 web 框架</td></tr><tr><td><a href="https://github.com/koajs/router">koa-router</a></td><td>处理 url</td></tr><tr><td><a href="https://github.com/koajs/bodyparser">koa-bodyparser</a></td><td>解析原始 request 的 body</td></tr><tr><td><a href="https://mozilla.github.io/nunjucks/cn/templating.html">nunjucks</a></td><td>模版引擎</td></tr><tr><td><a href="https://github.com/kentcdodds/cross-env#readme">cross-env</a></td><td>环境脚本的跨平台设置</td></tr><tr><td><a href="https://github.com/normalize/mz#readme">mz</a></td><td>支持 Promise 的 fs 模块</td></tr><tr><td><a href="https://github.com/broofa/mime#readme">mime</a></td><td>读取文件的 mime</td></tr><tr><td><a href="https://github.com/sidorares/node-mysql2#readme">mysql2</a></td><td>Node.js 的 mysql 驱动程序</td></tr><tr><td><a href="https://www.sequelize.com.cn/">sequelize</a></td><td>Node.js 的 ORM 框架</td></tr><tr><td><a href="http://momentjs.cn/">moment</a></td><td>日期处理</td></tr></tbody></table><h2 id="使用演示"><a href="#使用演示" class="headerlink" title="使用演示"></a>使用演示</h2><ul><li>如果需要使用模版引擎的方式，请查看 <code>controllers/home_controller.js</code> 文件。</li><li>如果需要使用 api 的方式，请查看 <code>controllers/auth/user_controller.js</code> 文件。</li></ul><h2 id="感谢支持"><a href="#感谢支持" class="headerlink" title="感谢支持"></a>感谢支持</h2><p>如果你觉得本项目对你有所帮助,请帮忙给个 <code>Star</code>。<br>如果你想贡献一份力量,欢迎提交 <code>Pull Request</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 开源 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub </tag>
            
            <tag> Node.js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>weather composer 插件</title>
      <link href="posts/d2a0cef0.html"/>
      <url>posts/d2a0cef0.html</url>
      
        <content type="html"><![CDATA[<h1 align="center">Weather</h1><p align="center"><span class="github-emoji"><span>🌈</span><img src="/medias/loading.gif" data-original="https://github.githubassets.com/images/icons/emoji/unicode/1f308.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 基于高德开放平台的 PHP 天气信息组件。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">composer</span> require pudongping/weather <span class="token parameter variable">-vvv</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>在使用本扩展之前，你需要去 <a href="https://lbs.amap.com/dev/id/newuser">高德开放平台</a> 注册账号，然后创建应用，获取应用的 API Key。</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">Pudongping<span class="token punctuation">\</span>Weather<span class="token punctuation">\</span>Weather</span><span class="token punctuation">;</span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'xxxxxxxxxxxxxxxxxxxxxxxxxxx'</span><span class="token punctuation">;</span><span class="token variable">$weather</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Weather</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取实时天气"><a href="#获取实时天气" class="headerlink" title="获取实时天气"></a>获取实时天气</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$weather</span><span class="token operator">-&gt;</span><span class="token function">getLiveWeather</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'上海'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>返回值示例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>    <span class="token property">"count"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>    <span class="token property">"info"</span><span class="token operator">:</span> <span class="token string">"OK"</span><span class="token punctuation">,</span>    <span class="token property">"infocode"</span><span class="token operator">:</span> <span class="token string">"10000"</span><span class="token punctuation">,</span>    <span class="token property">"lives"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"province"</span><span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span>            <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"上海市"</span><span class="token punctuation">,</span>            <span class="token property">"adcode"</span><span class="token operator">:</span> <span class="token string">"310000"</span><span class="token punctuation">,</span>            <span class="token property">"weather"</span><span class="token operator">:</span> <span class="token string">"阴"</span><span class="token punctuation">,</span>            <span class="token property">"temperature"</span><span class="token operator">:</span> <span class="token string">"10"</span><span class="token punctuation">,</span>            <span class="token property">"winddirection"</span><span class="token operator">:</span> <span class="token string">"东"</span><span class="token punctuation">,</span>            <span class="token property">"windpower"</span><span class="token operator">:</span> <span class="token string">"≤3"</span><span class="token punctuation">,</span>            <span class="token property">"humidity"</span><span class="token operator">:</span> <span class="token string">"73"</span><span class="token punctuation">,</span>            <span class="token property">"reporttime"</span><span class="token operator">:</span> <span class="token string">"2021-03-17 09:31:44"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取近期天气预报"><a href="#获取近期天气预报" class="headerlink" title="获取近期天气预报"></a>获取近期天气预报</h3><pre class="line-numbers language-none"><code class="language-none">$response = $weather-&gt;getForecastsWeather('上海');<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>返回值示例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>    <span class="token property">"count"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>    <span class="token property">"info"</span><span class="token operator">:</span> <span class="token string">"OK"</span><span class="token punctuation">,</span>    <span class="token property">"infocode"</span><span class="token operator">:</span> <span class="token string">"10000"</span><span class="token punctuation">,</span>    <span class="token property">"forecasts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"上海市"</span><span class="token punctuation">,</span>            <span class="token property">"adcode"</span><span class="token operator">:</span> <span class="token string">"310000"</span><span class="token punctuation">,</span>            <span class="token property">"province"</span><span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span>            <span class="token property">"reporttime"</span><span class="token operator">:</span> <span class="token string">"2021-03-17 10:03:15"</span><span class="token punctuation">,</span>            <span class="token property">"casts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                    <span class="token property">"date"</span><span class="token operator">:</span> <span class="token string">"2021-03-17"</span><span class="token punctuation">,</span>                    <span class="token property">"week"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>                    <span class="token property">"dayweather"</span><span class="token operator">:</span> <span class="token string">"小雨"</span><span class="token punctuation">,</span>                    <span class="token property">"nightweather"</span><span class="token operator">:</span> <span class="token string">"小雨"</span><span class="token punctuation">,</span>                    <span class="token property">"daytemp"</span><span class="token operator">:</span> <span class="token string">"12"</span><span class="token punctuation">,</span>                    <span class="token property">"nighttemp"</span><span class="token operator">:</span> <span class="token string">"9"</span><span class="token punctuation">,</span>                    <span class="token property">"daywind"</span><span class="token operator">:</span> <span class="token string">"东北"</span><span class="token punctuation">,</span>                    <span class="token property">"nightwind"</span><span class="token operator">:</span> <span class="token string">"东北"</span><span class="token punctuation">,</span>                    <span class="token property">"daypower"</span><span class="token operator">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>                    <span class="token property">"nightpower"</span><span class="token operator">:</span> <span class="token string">"4"</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span>                    <span class="token property">"date"</span><span class="token operator">:</span> <span class="token string">"2021-03-18"</span><span class="token punctuation">,</span>                    <span class="token property">"week"</span><span class="token operator">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>                    <span class="token property">"dayweather"</span><span class="token operator">:</span> <span class="token string">"小雨"</span><span class="token punctuation">,</span>                    <span class="token property">"nightweather"</span><span class="token operator">:</span> <span class="token string">"小雨"</span><span class="token punctuation">,</span>                    <span class="token property">"daytemp"</span><span class="token operator">:</span> <span class="token string">"13"</span><span class="token punctuation">,</span>                    <span class="token property">"nighttemp"</span><span class="token operator">:</span> <span class="token string">"10"</span><span class="token punctuation">,</span>                    <span class="token property">"daywind"</span><span class="token operator">:</span> <span class="token string">"东"</span><span class="token punctuation">,</span>                    <span class="token property">"nightwind"</span><span class="token operator">:</span> <span class="token string">"东"</span><span class="token punctuation">,</span>                    <span class="token property">"daypower"</span><span class="token operator">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>                    <span class="token property">"nightpower"</span><span class="token operator">:</span> <span class="token string">"4"</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span>                    <span class="token property">"date"</span><span class="token operator">:</span> <span class="token string">"2021-03-19"</span><span class="token punctuation">,</span>                    <span class="token property">"week"</span><span class="token operator">:</span> <span class="token string">"5"</span><span class="token punctuation">,</span>                    <span class="token property">"dayweather"</span><span class="token operator">:</span> <span class="token string">"小雨"</span><span class="token punctuation">,</span>                    <span class="token property">"nightweather"</span><span class="token operator">:</span> <span class="token string">"小雨"</span><span class="token punctuation">,</span>                    <span class="token property">"daytemp"</span><span class="token operator">:</span> <span class="token string">"14"</span><span class="token punctuation">,</span>                    <span class="token property">"nighttemp"</span><span class="token operator">:</span> <span class="token string">"9"</span><span class="token punctuation">,</span>                    <span class="token property">"daywind"</span><span class="token operator">:</span> <span class="token string">"北"</span><span class="token punctuation">,</span>                    <span class="token property">"nightwind"</span><span class="token operator">:</span> <span class="token string">"北"</span><span class="token punctuation">,</span>                    <span class="token property">"daypower"</span><span class="token operator">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>                    <span class="token property">"nightpower"</span><span class="token operator">:</span> <span class="token string">"4"</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span>                    <span class="token property">"date"</span><span class="token operator">:</span> <span class="token string">"2021-03-20"</span><span class="token punctuation">,</span>                    <span class="token property">"week"</span><span class="token operator">:</span> <span class="token string">"6"</span><span class="token punctuation">,</span>                    <span class="token property">"dayweather"</span><span class="token operator">:</span> <span class="token string">"阴"</span><span class="token punctuation">,</span>                    <span class="token property">"nightweather"</span><span class="token operator">:</span> <span class="token string">"阴"</span><span class="token punctuation">,</span>                    <span class="token property">"daytemp"</span><span class="token operator">:</span> <span class="token string">"15"</span><span class="token punctuation">,</span>                    <span class="token property">"nighttemp"</span><span class="token operator">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span>                    <span class="token property">"daywind"</span><span class="token operator">:</span> <span class="token string">"西北"</span><span class="token punctuation">,</span>                    <span class="token property">"nightwind"</span><span class="token operator">:</span> <span class="token string">"西北"</span><span class="token punctuation">,</span>                    <span class="token property">"daypower"</span><span class="token operator">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>                    <span class="token property">"nightpower"</span><span class="token operator">:</span> <span class="token string">"4"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取-XML-格式返回值"><a href="#获取-XML-格式返回值" class="headerlink" title="获取 XML 格式返回值"></a>获取 XML 格式返回值</h3><p>以上两个方法第二个参数为返回值类型，可选 <code>json</code> 与 <code>xml</code>，默认 <code>json</code>：</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$weather</span><span class="token operator">-&gt;</span><span class="token function">getLiveWeather</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'上海'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>返回值示例：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>response</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>status</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>status</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>count</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>count</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>info</span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>info</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>infocode</span><span class="token punctuation">&gt;</span></span>10000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>infocode</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lives</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>live</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>province</span><span class="token punctuation">&gt;</span></span>上海<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>province</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>city</span><span class="token punctuation">&gt;</span></span>上海市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>city</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>adcode</span><span class="token punctuation">&gt;</span></span>310000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>adcode</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>weather</span><span class="token punctuation">&gt;</span></span>小雨<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>weather</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>temperature</span><span class="token punctuation">&gt;</span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>temperature</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>winddirection</span><span class="token punctuation">&gt;</span></span>东北<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>winddirection</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>windpower</span><span class="token punctuation">&gt;</span></span>≤3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>windpower</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>humidity</span><span class="token punctuation">&gt;</span></span>73<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>humidity</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>reporttime</span><span class="token punctuation">&gt;</span></span>2021-03-17 10:03:15<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>reporttime</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>live</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lives</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>response</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><pre class="line-numbers language-none"><code class="language-none">array | string   getLiveWeather(string $city, string $format = 'json')array | string   getForecastsWeather(string $city, string $format = 'json')<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><ul><li><code>$city</code> - 城市名/<a href="https://lbs.amap.com/api/webservice/guide/api/district">高德地址位置 adcode</a>，比如：“上海” 或者（adcode：310000）；</li><li><code>$format</code>  - 输出的数据格式，默认为 json 格式，当 format 设置为 “<code>xml</code>” 时，输出的为 XML 格式的数据。</li></ul></blockquote><h3 id="在-Laravel-中使用"><a href="#在-Laravel-中使用" class="headerlink" title="在 Laravel 中使用"></a>在 Laravel 中使用</h3><blockquote><p>laravel version &gt;= 8.x 或者直接使用以上通用方法，以上方法适用于任意 php 框架</p></blockquote><p>执行 <code>artisan</code> 命令，发布配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan vendor:publish <span class="token parameter variable">--provider</span><span class="token operator">=</span><span class="token string">"Pudongping\Weather\ServiceProvider"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 Laravel 中使用也是同样的安装方式，配置写在 <code>config/weather.php</code> 中，或者自己在 <code>config</code> 目录下新建 <code>weather.php</code> 文件，填写以下内容亦可。</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">return</span> <span class="token punctuation">[</span>    <span class="token string single-quoted-string">'key'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'WEATHER_API_KEY'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在 <code>.env</code> 中配置 <code>WEATHER_API_KEY</code> ：</p><pre class="line-numbers language-env" data-language="env"><code class="language-env">WEATHER_API_KEY=xxxxxxxxxxxxxxxxxxxxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以用两种方式来获取 <code>Pudongping\Weather\Weather</code> 实例：</p><h4 id="方法参数注入"><a href="#方法参数注入" class="headerlink" title="方法参数注入"></a>方法参数注入</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">showWeather</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Weather</span> <span class="token variable">$weather</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$weather</span><span class="token operator">-&gt;</span><span class="token function">getLiveWeather</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'上海'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 或者直接使用城市的 adcode 传参</span>    <span class="token comment">// $response = $weather-&gt;getLiveWeather('310000');</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="服务名访问"><a href="#服务名访问" class="headerlink" title="服务名访问"></a>服务名访问</h4><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">showWeather</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'weather'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getLiveWeather</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'上海'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 或者直接使用城市的 adcode 传参</span>    <span class="token comment">// $response = app('weather')-&gt;getLiveWeather('310000');</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://lbs.amap.com/api/webservice/guide/api/weatherinfo/">高德开放平台天气接口</a></li></ul><h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>MIT</p>]]></content>
      
      
      <categories>
          
          <category> 开源 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Laravel </tag>
            
            <tag> Composer </tag>
            
            <tag> GitHub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>larablog 博客开源</title>
      <link href="posts/b6f184c0.html"/>
      <url>posts/b6f184c0.html</url>
      
        <content type="html"><![CDATA[<h1 id="基于-Laravel6-x-构建的博客应用，支持-Markdown，支持图片拖拽上传，基于-RBAC-权限管理系统"><a href="#基于-Laravel6-x-构建的博客应用，支持-Markdown，支持图片拖拽上传，基于-RBAC-权限管理系统" class="headerlink" title="基于 Laravel6.x 构建的博客应用，支持 Markdown，支持图片拖拽上传，基于 RBAC 权限管理系统"></a>基于 Laravel6.x 构建的博客应用，支持 Markdown，支持图片拖拽上传，基于 RBAC 权限管理系统</h1><p>首页</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f32ef21d42b702c2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="首页.png"></p><p>基于 RBAC 的权限管理后台，Dashboard 页面统计了用户总数、文章发布总数、评论率、评论总数、文章支持按天、按月、按年统计、支持按分类、按标签统计……</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-74c132c165d20aae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="后台首页.png"></p><p>登录页面</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-93885ee50879719e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="登录页面.png"></p><p>注册页面</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a883ff409344f8c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="注册页面.png"></p><p>支持 GitHub 授权登录</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f87b0926873bdfd0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="GitHub授权登录页面.png"></p><p>支持邮箱重置密码</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-11fbe50ac341bf7e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="重置密码页面.png"></p><p>同时兼容 HTML 编辑器和 Markdown 编辑器</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-537e03bdc254a951.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="富文本编辑器.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-c1c8018845d986ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="markdown 编辑器.png"></p><p>Markdown 编辑器：支持拖拽粘贴上传图片、预览、全屏、分屏预览</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-092682db5e3cec7a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="markdown 编辑器预览效果.png"></p><p>支持代码高亮</p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5263abf6268ddf98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="文章详情.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-9db84df41d52c0a3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="后台用户.png"></p><h2 id="项目概述"><a href="#项目概述" class="headerlink" title="项目概述"></a>项目概述</h2><ul><li>项目名称：larablog</li><li>项目简介：基于 laravel6.x 开发的博客项目</li><li>访问地址：<a href="https://blog.pudongping.com/">https://blog.pudongping.com/</a></li></ul><h2 id="功能如下"><a href="#功能如下" class="headerlink" title="功能如下"></a>功能如下</h2><ul><li>用户认证 —— 注册、登录、退出；</li><li>个人中心 —— 用户个人中心，编辑资料；</li><li>用户授权 —— 作者才能删除自己的内容；</li><li>上传图片 —— 修改头像和编辑文章时上传图片；</li><li>表单验证 —— 使用表单验证类；</li><li>重置密码 —— 通过邮箱找回密码</li><li>文章支持分类、多标签、访问量统计；</li><li>编辑文章支持 markdown 编辑器 、html 编辑器；</li><li>markdown 编辑器支持拖拽上传图片、截屏粘贴上传图片、语法高亮、预览、全屏、分屏实时预览；</li><li>文章发布时自动 Slug 翻译，支持使用队列方式以提高响应；</li><li>站点『活跃用户』计算，一小时计算一次；</li><li>多角色权限管理 —— 允许站长，管理员权限的存在；</li><li>后台管理 —— 基于 RBAC 后台数据模型管理；</li><li>邮件通知 —— 发送新回复邮件通知，队列发送邮件；</li><li>站内通知 —— 文章有新回复；</li><li>自定义 Artisan 命令行 —— 自定义活跃用户计算命令；</li><li>自定义 Trait —— 活跃用户的业务逻辑实现；</li><li>自定义中间件 —— 记录用户的最后登录时间；</li><li>XSS 安全防御；</li><li>第三方授权登录，目前支持 GitHub，兼容 Facebook，Twitter，LinkedIn，Google，GitHub，GitLab 和 Bitbucket 的身份验证；</li><li>支持自定义 meta title、description、keywords；</li><li>支持友链</li><li>站点地图</li><li>RSS 订阅</li></ul><h2 id="运行环境要求"><a href="#运行环境要求" class="headerlink" title="运行环境要求"></a>运行环境要求</h2><ul><li>Nginx 1.8+</li><li>PHP 7.0+</li><li>Mysql 5.7+</li><li>Redis 3.0+</li></ul><h2 id="开发环境部署和安装"><a href="#开发环境部署和安装" class="headerlink" title="开发环境部署和安装"></a>开发环境部署和安装</h2><p>本项目代码使用 PHP 框架 laravel6.x 开发，本地开发环境使用 <a href="https://xueyuanjun.com/post/19915.html">Laravel Homestead</a>。</p><h2 id="基础安装"><a href="#基础安装" class="headerlink" title="基础安装"></a>基础安装</h2><ol><li>克隆源代码</li></ol><p>克隆 <code>larablog</code> 源代码到本地：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// gitee<span class="token function">git</span> clone git@gitee.com:pudongping/larablog.git// GitHub<span class="token function">git</span> clone git@github.com:pudongping/larablog.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>安装扩展包依赖</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 先切换到 larablog 项目根目录<span class="token builtin class-name">cd</span> larablog// 执行安装命令，并忽略掉开发环境才需要的插件包<span class="token function">composer</span> <span class="token function">install</span> --no-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>生成配置文件</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> .env.example .env<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你可以根据情况修改 .env 文件里的内容，如数据库连接、缓存、邮件设置、第三方授权登录等：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">DB_HOST</span><span class="token operator">=</span>localhost<span class="token assign-left variable">DB_DATABASE</span><span class="token operator">=</span>larablog<span class="token assign-left variable">DB_USERNAME</span><span class="token operator">=</span>homestead<span class="token assign-left variable">DB_PASSWORD</span><span class="token operator">=</span>secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>生成数据表及生成测试数据</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 需要生成测试数据则执行：php artisan migrate <span class="token parameter variable">--seed</span>// 不需要生成测试数据则执行：php artisan migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>生成秘钥</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan key:generate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="6"><li>创建 storage 软连接</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan storage:link<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="7"><li>赋予 storage 相应权限</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 建议在 Linux 系统中新建一个 www 用户，并设置该用户不可登录系统<span class="token function">useradd</span> <span class="token parameter variable">-s</span> /sbin/nologin www// 将项目目录所有权赋予 www 用户<span class="token function">chown</span> <span class="token parameter variable">-Rf</span> www:www larablog// 给 storage 目录赋权限<span class="token function">chmod</span> <span class="token parameter variable">-Rf</span> 0755 larablog/storage/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="8"><li>配置 hosts 文件  （如果直接想部署在线上环境，则跳过此步骤）</li></ol><p>如果开发环境没有采用 Laravel Homestead 则 ip 映射以你实际为主，一般为 127.0.0.1。我这里使用的 Laravel Homestead 虚拟机的 ip 地址为：192.168.10.10</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// Linux 或 MacOS 环境<span class="token builtin class-name">echo</span> <span class="token string">"192.168.10.10   larablog.test"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> /etc/hosts// Windows 环境需要打开 C:/Windows/System32/Drivers/etc/hosts  文件，然后新增一行<span class="token number">192.168</span>.10.10 larablog.test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="前端安装"><a href="#前端安装" class="headerlink" title="前端安装"></a>前端安装</h2><ol><li>安装 npm 和 yarn</li></ol><p><strong>CentOS / Fedora / RHEL 环境下</strong></p><blockquote><p>文档地址：<a href="https://yarn.bootcss.com/docs/install/#centos-stable">https://yarn.bootcss.com/docs/install/#centos-stable</a></p></blockquote><ul><li>配置相应的 yum 源</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--silent</span> <span class="token parameter variable">--location</span> https://dl.yarnpkg.com/rpm/yarn.repo <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/yarn.repo<span class="token function">curl</span> <span class="token parameter variable">--silent</span> <span class="token parameter variable">--location</span> https://rpm.nodesource.com/setup_8.x <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">bash</span> -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>之后执行以下任意一条命令，就可以了</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token function">yarn</span><span class="token comment">## OR ##</span><span class="token function">sudo</span> dnf <span class="token function">install</span> <span class="token function">yarn</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>Windows 环境下</strong></p><ul><li>安装 node.js</li></ul><p>直接去官网 <a href="https://nodejs.org/en/">https://nodejs.org/en</a> 下载安装最新版本。</p><ul><li>安装 Yarn</li></ul><p>请安装最新版本的 Yarn —— <a href="https://nodejs.org/en/">http://yarnpkg.cn/zh-Hans/docs/install</a></p><ol start="2"><li>为 NPM 和 Yarn 配置淘宝镜像，加速安装包下载</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> config <span class="token builtin class-name">set</span> <span class="token assign-left variable">registry</span><span class="token operator">=</span>https://registry.npm.taobao.org<span class="token function">yarn</span> config <span class="token builtin class-name">set</span> registry https://registry.npm.taobao.org<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>使用 Yarn 安装前端依赖包</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">install</span>或者<span class="token function">npm</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>监控 resources 文件夹下的资源文件是否有发生改变。在 watch-poll 命令运行的情况下，一旦资源文件发生变化，Webpack 会自动重新编译。</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> run watch-poll// 如果遇到报错，尝试先执行以下命令更新 <span class="token function">npm</span> 到最新版本，之后再次执行监控命令<span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> <span class="token function">npm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编译前端内容</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 运行所有 Mix 任务<span class="token function">npm</span> run dev// 运行所有 Mix 任务并缩小输出<span class="token function">npm</span> run production// 或者执行<span class="token function">yarn</span> production<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="访问入口"><a href="#访问入口" class="headerlink" title="访问入口"></a>访问入口</h2><ul><li>首页地址： <a href="http://larablog.test/">http://larablog.test</a></li><li>后台管理：<a href="http://larablog.test/admin">http://larablog.test/admin</a></li></ul><p>管理员账号密码如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">username: <span class="token number">1414818093</span>@qq.compassword: <span class="token number">123456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>默认网站第一位用户为站长角色，第二位用户为管理员角色。如果填充了测试数据，则默认所有用户的密码为：123456</p><p>==至此，安装完成^_^。enjoy yourself……==</p><h2 id="后端扩展包使用情况"><a href="#后端扩展包使用情况" class="headerlink" title="后端扩展包使用情况"></a>后端扩展包使用情况</h2><table><thead><tr><th>扩展包</th><th>简介描述</th><th>本项目应用场景</th></tr></thead><tbody><tr><td><a href="https://packagist.org/packages/laravel/ui">laravel/ui</a></td><td>laravel 6.x UI 脚手架</td><td>前端页面框架</td></tr><tr><td><a href="https://github.com/barryvdh/laravel-ide-helper">barryvdh/laravel-ide-helper</a></td><td>能让你的 IDE (PHPStorm, Sublime) 实现自动补全、代码智能提示和代码跟踪等功能</td><td>代码补全和智能提示</td></tr><tr><td><a href="https://github.com/barryvdh/laravel-debugbar">barryvdh/laravel-debugbar</a></td><td>页面调试工具栏 (对 phpdebugbar 的封装)</td><td>开发环境中的 DEBUG</td></tr><tr><td><a href="https://github.com/overtrue/laravel-lang">overtrue/laravel-lang</a></td><td>支持 52 个国家的语言包</td><td>翻译 Laravel 自带模板</td></tr><tr><td><a href="https://github.com/mewebstudio/captcha">mews/captcha</a></td><td>图片验证码</td><td>注册页面图片验证码</td></tr><tr><td><a href="https://github.com/Intervention/image">intervention/image</a></td><td>图片处理功能库</td><td>用于图片裁剪</td></tr><tr><td><a href="https://github.com/summerblue-ext-forks/active">summerblue/laravel-active</a></td><td>方便设置 active 类</td><td>文章排序添加 active 类</td></tr><tr><td><a href="https://github.com/mewebstudio/Purifier">mews/purifier</a></td><td>用户提交的 Html 白名单过滤</td><td>文章内容的 Html 安全过滤，防止 XSS 攻击</td></tr><tr><td><a href="https://github.com/guzzle/guzzle">guzzlehttp/guzzle</a></td><td>HTTP 请求套件</td><td>请求百度翻译 API，翻译文章标题，做 SEO 优化</td></tr><tr><td><a href="https://github.com/overtrue/pinyin">overtrue/pinyin</a></td><td>基于 CC-CEDICT 词典的中文转拼音工具</td><td>翻译文章标题的备用方案</td></tr><tr><td><a href="https://github.com/nrk/predis">predis/predis</a></td><td>Redis 官方首推的 PHP 客户端开发包</td><td>缓存驱动 Redis 基础扩展包</td></tr><tr><td><a href="https://learnku.com/docs/laravel/6.x/horizon/5190">laravel/horizon</a></td><td>队列监控</td><td>队列监控命令与页面控制台 /horizon</td></tr><tr><td><a href="https://github.com/spatie/laravel-permission">spatie/laravel-permission</a></td><td>角色权限管理</td><td>角色和权限控制</td></tr><tr><td><a href="https://github.com/viacreative/sudo-su">viacreative/sudo-su</a></td><td>用户切换</td><td>调试环境中快速切换登录账号</td></tr><tr><td><a href="https://github.com/erusev/parsedown">erusev/parsedown</a></td><td>markdown 转换 html 工具</td><td>文章模块解析 markdown 语法</td></tr><tr><td><a href="https://github.com/thephpleague/html-to-markdown">thephpleague/html-to-markdown</a></td><td>html 转换成 markdown 工具</td><td>文章编辑采用 markdown 编辑器时</td></tr><tr><td><a href="https://socialiteproviders.netlify.com/providers/git-hub.html">laravel/socialite</a></td><td>laravel 官方推荐社会化登录</td><td>Github 登录</td></tr><tr><td><a href="https://packagist.org/packages/suin/php-rss-writer">suin/php-rss-writer</a></td><td>rss 订阅生成</td><td>生成 rss 订阅代码</td></tr><tr><td><a href="https://github.com/hhxsv5/laravel-s/blob/master/README-CN.md">hhxsv5/laravel-s</a></td><td>LaravelS 是 Swoole 和 Laravel/Lumen 之间开箱即用的适配器</td><td>优化访问速度</td></tr></tbody></table><h2 id="前端扩展包使用情况"><a href="#前端扩展包使用情况" class="headerlink" title="前端扩展包使用情况"></a>前端扩展包使用情况</h2><table><thead><tr><th>扩展包</th><th>简介描述</th><th>本项目应用场景</th></tr></thead><tbody><tr><td><a href="https://fontawesome.com/">yarn add @fortawesome/fontawesome-free</a></td><td>Font Awesome 提供了可缩放的矢量图标</td><td>字体图标库</td></tr><tr><td><a href="https://github.com/BlackrockDigital/startbootstrap-sb-admin-2">npm i startbootstrap-sb-admin-2</a></td><td>界面简洁美观的皮肤</td><td>cms 后台模板</td></tr><tr><td><a href="https://simplemde.com/">npm install simplemde</a></td><td>markdown 编辑器</td><td>文章编辑器</td></tr><tr><td><a href="https://highlightjs.org/">npm install highlight.js</a></td><td>语法高亮工具</td><td>markdown 编辑器代码语法高亮</td></tr><tr><td><a href="https://github.com/Rovak/InlineAttachment">npm install inline-attachment</a></td><td>文本框拖动上传图片工具</td><td>markdown 文本框图片拖动上传</td></tr><tr><td><a href="http://loudev.com/">multiselect.js</a></td><td>多选下拉框</td><td>文章多选标签</td></tr><tr><td><a href="https://www.chartjs.org/">chartjs</a></td><td>图表插件</td><td>后台管理界面图表</td></tr></tbody></table><h2 id="邮箱认证"><a href="#邮箱认证" class="headerlink" title="邮箱认证"></a>邮箱认证</h2><ul><li>开发环境时将 <code>.ENV</code> 文件设置为如下所示，将邮箱认证邮件发送至当前日志中，以便调试  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">MAIL_DRIVER</span><span class="token operator">=</span>log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>生产环境时，建议将 <code>.ENV</code> 文件中相关邮件设置为自己所需配置，以下为默认配置  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">MAIL_DRIVER</span><span class="token operator">=</span>smtp<span class="token assign-left variable">MAIL_HOST</span><span class="token operator">=</span>smtp.mailtrap.io<span class="token assign-left variable">MAIL_PORT</span><span class="token operator">=</span><span class="token number">2525</span><span class="token assign-left variable">MAIL_USERNAME</span><span class="token operator">=</span>null<span class="token assign-left variable">MAIL_PASSWORD</span><span class="token operator">=</span>null<span class="token assign-left variable">MAIL_ENCRYPTION</span><span class="token operator">=</span>null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="翻译队列"><a href="#翻译队列" class="headerlink" title="翻译队列"></a>翻译队列</h2><ul><li>修改 <code>.ENV</code> 文件设置为</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 如果是开发环境的话，就把队列驱动改回 sync 同步模式，也就是说不使用任何队列，实时执行：</span><span class="token assign-left variable">QUEUE_CONNECTION</span><span class="token operator">=</span>redis<span class="token assign-left variable">REDIS_CLIENT</span><span class="token operator">=</span>predis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>启动队列系统，队列在启动完成后会进入监听状态</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan queue:listen或者使用php artisan horizon<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="文章标题翻译"><a href="#文章标题翻译" class="headerlink" title="文章标题翻译"></a>文章标题翻译</h2><blockquote><p><a href="http://api.fanyi.baidu.com/api/trans/product/apidoc">使用了百度翻译 api</a>，请将 <code>.ENV</code>中的百度 api 相关信息换成你自己的<a href="http://api.fanyi.baidu.com/api/trans/product/desktop?req=developer">开发者信息</a></p></blockquote><p>如果不采用百度翻译翻译文章标题的话，那么不用配置 <code>.ENV</code> 文件中以下配置项</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 百度翻译 APP ID</span><span class="token assign-left variable">BAIDU_TRANSLATE_APPID</span><span class="token operator">=</span><span class="token comment"># 百度翻译密钥 KEY</span><span class="token assign-left variable">BAIDU_TRANSLATE_KEY</span><span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>并且也不需要更改</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">QUEUE_CONNECTION</span><span class="token operator">=</span>redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>默认保持为</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">QUEUE_CONNECTION</span><span class="token operator">=</span>sync<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这样将会每发一篇文章时，将文章标题直接翻译成拼音达到 slug 的效果。</p><h2 id="邮件通知"><a href="#邮件通知" class="headerlink" title="邮件通知"></a>邮件通知</h2><blockquote><p>如果不想要，发表文章评论时有邮件通知，可以不用配置，直接忽略，功能上没有任何影响</p></blockquote><ol><li>需要先开启 QQ 邮箱的 SMTP 支持</li></ol><p><a href="https://service.mail.qq.com/cgi-bin/help?subtype=1&amp;id=28&amp;no=166">如何打开 POP3/SMTP/IMAP 功能？</a></p><ol start="2"><li>邮箱发送配置 （请将以下配置换成你自己的邮箱配置）</li></ol><blockquote><p>如果你是使用的阿里云 ECS，那么一定要注意，阿里云的 ECS 默认禁用了 25 端口，需要单独申请解封25端口，<a href="https://yundun.console.aliyun.com/?spm=5176.2020520101.console-base-top.duser-0.33bf4df5FEFEdS&amp;p=sc#/sc/port">点我解封阿里云 ECS 25端口</a>，如果你不知道如何解封，请查看 <a href="https://help.aliyun.com/knowledge_detail/56130.html">解封步骤</a>。当然替代方案，你可以采用 465 端口，如果你打算采用 465 端口，那么需要将以下配置中的 <code>MAIL_PORT</code> 修改为 465,并且也需要将加密类型 <code>MAIL_ENCRYPTION</code> 修改为 ssl 即可，这里我使用的是 qq 邮箱，可能其他的邮箱服务有差异，视情况而定吧。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用支持 ESMTP 的 SMTP 服务器发送邮件</span><span class="token assign-left variable">MAIL_DRIVER</span><span class="token operator">=</span>smtp<span class="token comment"># QQ 邮箱的 SMTP 服务器地址，必须为此值</span><span class="token assign-left variable">MAIL_HOST</span><span class="token operator">=</span>smtp.qq.com<span class="token comment"># QQ 邮箱的 SMTP 服务器端口，必须为此值</span><span class="token assign-left variable">MAIL_PORT</span><span class="token operator">=</span><span class="token number">25</span><span class="token comment"># 请将此值换为你的 QQ + @qq.com</span><span class="token assign-left variable">MAIL_USERNAME</span><span class="token operator">=</span>xxxxxxxxxxxxxx@qq.com<span class="token comment"># 密码是我们第一步拿到的授权码</span><span class="token assign-left variable">MAIL_PASSWORD</span><span class="token operator">=</span>xxxxxxxxx<span class="token comment"># 加密类型，选项 null 表示不使用任何加密，其他选项还有 ssl，这里我们使用 tls 即可，如果出现报错的话，多半是因为这个 smtp 主机不支持 TLS，那么只需要将此项设置为 null 即可。</span><span class="token assign-left variable">MAIL_ENCRYPTION</span><span class="token operator">=</span>tls<span class="token comment"># 此值必须同 MAIL_USERNAME 一致</span><span class="token assign-left variable">MAIL_FROM_ADDRESS</span><span class="token operator">=</span>xxxxxxxxxxxxxx@qq.com<span class="token comment"># 用来作为邮件的发送者名称</span><span class="token assign-left variable">MAIL_FROM_NAME</span><span class="token operator">=</span>番茄炖土豆的个人博客<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>如果需要支持队列，请将 <code>.ENV</code> 配置文件中，设置成</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">QUEUE_CONNECTION</span><span class="token operator">=</span>redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="用户切换调试"><a href="#用户切换调试" class="headerlink" title="用户切换调试"></a>用户切换调试</h2><p>默认只在调试模式 <code>.ENV</code> 文件中</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">APP_DEBUG</span><span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>时启用，且 <code>config/sudosu.php</code> 文件中</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 允许使用的顶级域名</span><span class="token string single-quoted-string">'allowed_tlds'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'dev'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'local'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>顶级域名（Top Level Domain）加入你域名的顶级域名</p><h2 id="第三方授权登录"><a href="#第三方授权登录" class="headerlink" title="第三方授权登录"></a>第三方授权登录</h2><p>目前项目中只支持 github 授权登录，因为只申请了 GitHub 的 OAuth application，如果你也需要使用 GitHub 作为第三方授权登录，那么需要按照以下步骤进行：</p><ol><li>在 GitHub 上注册一个 <a href="https://github.com/settings/applications/new">OAuth application</a></li></ol><ul><li>Application name：你可以填写你自己的应用名称，比如：myWebBlog</li><li>Homepage URL：首页连接地址需要添加你自己的，比如：<a href="http://larablog.test/">http://larablog.test</a></li><li>Application description：应用描述可以随便填写，比如：自己的博客</li><li>Authorization callback URL：授权回调地址，一定要填写成： <your domain="">/login/github/callback  ，比如，我这里则需要填写成：<a href="http://larablog.test/login/github/callback">http://larablog.test/login/github/callback</a></your></li></ul><ol start="2"><li>注册成功之后，需要在 <code>.ENV</code> 配置文件中填写申请成功的 Client ID 和 Client Secret。填写好之后，直接访问  <a href="http://larablog.test/login/github">http://larablog.test/login/github</a>  即可支持 GitHub 第三方授权登录，如果不设置 <code>.ENV</code> 配置文件，则登录、注册页面不会显示 GitHub 第三方授权登录入口。</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Github Client ID</span><span class="token assign-left variable">GITHUB_CLIENT_ID</span><span class="token operator">=</span><span class="token comment"># Github Client Secret</span><span class="token assign-left variable">GITHUB_CLIENT_SECRET</span><span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>扩展其它第三方授权登录。<blockquote><p>Socialite 目前支持 Facebook，Twitter，LinkedIn，Google，GitHub，GitLab 和 Bitbucket 的身份验证。本项目已经对以上支持的第三方登录做了兼容性处理，如果我们需要支持以上除 GitHub 以外的应用（因为目前已经设置好了 GitHub 相关的配置），那么我们只需要按照以下的步骤配置即可。这里以 Google 为例子。</p></blockquote></li></ol><ul><li>第一步：申请 <code>google</code> 的 Client ID 和 Client Secret。</li><li>第二步：将申请的 Client ID 和 Client Secret 填写入 <code>.ENV</code> 配置文件中</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">GOOGLE_CLIENT_ID</span><span class="token operator">=</span><span class="token string">"your google client id"</span><span class="token assign-left variable">GOOGLE_CLIENT_SECRET</span><span class="token operator">=</span><span class="token string">"your google client secret"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>第三步：配置 app/services.php</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token string">'google'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>    <span class="token string">'client_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> env<span class="token punctuation">(</span><span class="token string">'GOOGLE_CLIENT_ID'</span><span class="token punctuation">)</span>,  // google 客户端授权 ID    <span class="token string">'client_secret'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> env<span class="token punctuation">(</span><span class="token string">'GOOGLE_CLIENT_SECRET'</span><span class="token punctuation">)</span>,  // google 客户端授权密钥    <span class="token string">'redirect'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'/login/google/callback'</span>,  // 授权回调链接 如果 redirect 配置项包含的是相对路径，系统会自动将其转化为完整 URL<span class="token punctuation">]</span>,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>第四步：将第三方服务添加到 <code>app/Models/Auth/User.php</code> =&gt; <code>$allowedProviders</code> 数组中</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">public static <span class="token variable">$allowedProviders</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'github'</span>, <span class="token string">'google'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>第五步：直接访问 <your domain="">/login/google 即可</your></li></ul><h2 id="自定义-Artisan-命令"><a href="#自定义-Artisan-命令" class="headerlink" title="自定义 Artisan 命令"></a>自定义 Artisan 命令</h2><table><thead><tr><th>命令</th><th>说明</th><th>Cron</th></tr></thead><tbody><tr><td>php artisan larablog:calculate-active-user</td><td>生成活跃用户</td><td>一个小时运行一次</td></tr><tr><td>php artisan larablog:sync-article-view-count</td><td>同步文章的访问量</td><td>每天早上 0 点准时</td></tr><tr><td>php artisan larablog:sync-user-actived-at</td><td>从 Redis 中同步最后登录时间到数据库中</td><td>每天早上 0 点准时</td></tr></tbody></table><h2 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h2><p>当前计划任务主要是计算主页右侧 「活跃用户」</p><p><code>artisan</code> 命令为：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan larablog:calculate-active-user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>同步文章的访问量</p><p><code>artisan</code> 命令为：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan larablog:sync-article-view-count<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>和同步 「用户最后活跃时间」 到数据库</p><p><code>artisan</code> 命令为：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan larablog:sync-user-actived-at<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>并且已经在 <code>调度器</code> 中设置好了相关代码。（调度器在 app/Console/Kernel.php 文件的 schedule 方法中定义）</p><p>使用 Linux 系统的 Cron 计划任务需执行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">EDITOR</span><span class="token operator">=</span>vi <span class="token operator">&amp;&amp;</span> <span class="token function">crontab</span> <span class="token parameter variable">-e</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后填入以下内容（注意将项目根目录换成你自己的）<br>这里我的项目根目录为：<code>/home/vagrant/Code/larablog</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">* * * * * php /home/vagrant/Code/larablog/artisan schedule:run <span class="token operator">&gt;&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>如果不设定计划任务的话，直接执行以上 Artisan 命令的话会是如下情况：<br>「活跃用户」将每 65 分钟重新生成一次，设定计划任务的话，默认一个小时重新生成一次。<br>「用户最后活跃时间」将不会同步到数据库中，将会直接从 Redis 中获取，如果 Redis 中不存在，则以用户注册时间替代。</p></blockquote><h2 id="队列清单"><a href="#队列清单" class="headerlink" title="队列清单"></a>队列清单</h2><table><thead><tr><th>文件路径</th><th>说明</th><th>调用时机</th></tr></thead><tbody><tr><td>app\Notifications\ArticleReplied.php</td><td>通知文章作者有新评论回复</td><td>文章被评论以后 App\Observers\Portal\Article\ReplyObserver@created</td></tr><tr><td>app\Jobs\TranslateSlug.php</td><td>将文章标题翻译为 Slug</td><td>文章保存时 App\Observers\Portal\Article\ArticleObserver@saved</td></tr></tbody></table><h2 id="线上部署"><a href="#线上部署" class="headerlink" title="线上部署"></a>线上部署</h2><p>如果需要优化网站打开速度，可依次进行如下步骤：</p><ul><li>压缩前端代码</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> run prod<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>缓存路由</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 缓存路由</span>php artisan route:cache<span class="token comment"># 清空路由缓存</span>php artisan route:clear<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>缓存配置文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 缓存配置文件</span>php artisan config:cache<span class="token comment"># 清空配置文件缓存</span>php artisan cache:clear<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>composer 优化</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">composer</span> dump-autoload <span class="token parameter variable">--optimize</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>类映射加载优化</li></ul><p>在 <code>laravel 6.x</code> 中，会生成 <code>bootstrap/cache/config.php</code> 和 <code>bootstrap/cache/packages.php</code> 和 <code>bootstrap/cache/routes.php</code> 和 <code>bootstrap/cache/services.php</code> 这四个文件。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php artisan optimize<span class="token comment"># 清空类映射</span>php artisan optimize:clear<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>使用 swoole 加速网站</li></ul><p>在项目根目录下执行以下命令，以守护进程的方式运行 <a href="https://github.com/hhxsv5/laravel-s/blob/master/README-CN.md">laravelS</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">php bin/laravels start <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参考以下内容配置 nginx 配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">upstream swoole <span class="token punctuation">{</span>    <span class="token comment"># 如果是使用 laradock ，请将 127.0.0.1 更改为 workspace</span>    server <span class="token number">127.0</span>.0.1:5200 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>30s<span class="token punctuation">;</span>    keepalive <span class="token number">16</span><span class="token punctuation">;</span><span class="token punctuation">}</span>server <span class="token punctuation">{</span>    listen <span class="token number">80</span><span class="token punctuation">;</span>    server_name pudongping.com blog.pudongping.com<span class="token punctuation">;</span>    root /www/wwwroot/larablog/public<span class="token punctuation">;</span>    index index.html index.htm index.php<span class="token punctuation">;</span>    charset utf-8<span class="token punctuation">;</span>    location / <span class="token punctuation">{</span>        try_files <span class="token variable">$uri</span> @laravels<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    location <span class="token operator">=</span> /favicon.ico <span class="token punctuation">{</span> access_log off<span class="token punctuation">;</span> log_not_found off<span class="token punctuation">;</span> <span class="token punctuation">}</span>    location <span class="token operator">=</span> /robots.txt  <span class="token punctuation">{</span> access_log off<span class="token punctuation">;</span> log_not_found off<span class="token punctuation">;</span> <span class="token punctuation">}</span>    access_log  /www/wwwlogs/pudongping.com.log<span class="token punctuation">;</span>    error_log  /www/wwwlogs/pudongping.com.error.log<span class="token punctuation">;</span>    sendfile off<span class="token punctuation">;</span>    client_max_body_size 100m<span class="token punctuation">;</span>    location @laravels <span class="token punctuation">{</span>        <span class="token comment"># proxy_connect_timeout 60s;</span>        <span class="token comment"># proxy_send_timeout 60s;</span>        <span class="token comment"># proxy_read_timeout 120s;</span>        proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>        proxy_set_header Connection <span class="token string">""</span><span class="token punctuation">;</span>        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        proxy_set_header X-Real-PORT <span class="token variable">$remote_port</span><span class="token punctuation">;</span>        proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>        proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>        proxy_set_header Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>        proxy_set_header Server-Protocol <span class="token variable">$server_protocol</span><span class="token punctuation">;</span>        proxy_set_header Server-Name <span class="token variable">$server_name</span><span class="token punctuation">;</span>        proxy_set_header Server-Addr <span class="token variable">$server_addr</span><span class="token punctuation">;</span>        proxy_set_header Server-Port <span class="token variable">$server_port</span><span class="token punctuation">;</span>        <span class="token comment"># “swoole”是指upstream</span>        proxy_pass http://swoole<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    location ~ /<span class="token punctuation">\</span>.ht <span class="token punctuation">{</span>        deny all<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果是使用 laradock 的话，还需要将 <code>.env</code> 添加监听地址为 <code>workspace</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">LARAVELS_LISTEN_IP</span><span class="token operator">=</span>workspace<span class="token comment"># 设置后台启动 laravelS 服务，如果需要查看则执行 ps -ef|grep laravels 命令</span><span class="token assign-left variable">LARAVELS_DAEMONIZE</span><span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="代码规范"><a href="#代码规范" class="headerlink" title="代码规范"></a>代码规范</h2><p>遵循 <a href="https://www.php-fig.org/psr/psr-2/">PSR-2</a> 编码风格规范<br>遵循 <a href="https://learnku.com/docs/psr/psr-12-extended-coding-style-guide/5789">PSR-12</a> 编码规范扩充</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>代码中涵盖了丰富的注释，如果仍有不清楚之处，可以给我留言。<br>如果你觉得还不错，请帮我点一下  Star，不胜感激 ！❤(❤´艸｀❤)</p><p><a href="https://github.com/pudongping/larablog">GitHub</a> 地址<br><a href="https://gitee.com/pudongping/larablog">码云</a> 地址</p><h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>源代码基于 <a href="https://opensource.org/licenses/MIT">MIT</a> 协议发布。</p>]]></content>
      
      
      <categories>
          
          <category> 开源 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Laravel </tag>
            
            <tag> GitHub </tag>
            
            <tag> 博客 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何使用 gitbook 快速编写个人书籍或笔记？</title>
      <link href="posts/b00f410f.html"/>
      <url>posts/b00f410f.html</url>
      
        <content type="html"><![CDATA[<h1 id="GitBook-使用"><a href="#GitBook-使用" class="headerlink" title="GitBook 使用"></a><a href="https://github.com/GitbookIO">GitBook</a> 使用</h1><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><blockquote><p><a href="https://www.gitbook.com/">GitBook 官网</a><br><a href="https://github.com/GitbookIO/gitbook">GitBook 文档</a><br><a href="https://blankj.com/gitbook/gitbook/">GitBook 使用教程</a><br><a href="https://juejin.im/post/6844903865146441741">推荐12个实用的gitbook插件</a><br><a href="http://jartto.wang/2020/02/02/about-gitbook/">GitBook 和它有趣的插件</a></p></blockquote><h2 id="示例图"><a href="#示例图" class="headerlink" title="示例图"></a>示例图</h2><p><img src="/medias/loading.gif" data-original="https://pudongping.github.io/notes/resources/images/sample/page.png" alt="页面截图"></p><h2 id="在线访问"><a href="#在线访问" class="headerlink" title="在线访问"></a>在线访问</h2><p><a href="https://notes.pudongping.com/">蒲东平的编程笔记</a> 或者 <a href="https://pudongping.github.io/notes">蒲东平的编程笔记-GitHub Pages</a></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ul><li>安装</li></ul><blockquote><p>安装 GitBook 之前需要安装 <code>Node.js</code> ， <code>GitBook</code> 是一个基于 <code>Node.js</code> 的命令行工具，因此需要先下载安装 <a href="https://nodejs.org/en">Node.js</a></p></blockquote><pre class="line-numbers language-none"><code class="language-none"># 查看 node.js 是否安装成功node -v# 安装 GitBook npm install gitbook-cli -g# 查看 GitBook 是否安装成功gitbook -V （大写的 V ）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多详情可以参考 <a href="https://github.com/GitbookIO/gitbook/blob/master/docs/setup.md">GitBook 官方安装文档</a> 来安装 GitBook</p><ul><li>创建项目</li></ul><pre class="line-numbers language-none"><code class="language-none"># 切换到项目文件夹并创建项目mkdir project-directory &amp;&amp; cd project-directory &amp;&amp; gitbook init# 或者直接使用以下命令gitbook init ./project-directory<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>启动项目</li></ul><pre class="line-numbers language-none"><code class="language-none">cd project-directory &amp;&amp; gitbook serve// 如果不想使用 4000 端口，想要使用 9520 端口时gitbook serve -p 9520<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在浏览器地址栏中输入 <code>http://localhost:4000</code> 便可预览书籍，至此，gitbook 安装完毕。</p><ul><li>编译项目 （生成网页而不开启服务器）</li></ul><pre class="line-numbers language-none"><code class="language-none">cd project-directory &amp;&amp; gitbook build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>查看所有可用的 gitbook 版本</li></ul><pre class="line-numbers language-none"><code class="language-none">gitbook ls-remote<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>安装指定的 gitbook 版本</li></ul><pre class="line-numbers language-none"><code class="language-none">gitbook fetch beta（版本号）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>编译时，输出目录详细的记录包括 debug</li></ul><pre class="line-numbers language-none"><code class="language-none">gitbook build ./ --log=debug --debug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="关于配置"><a href="#关于配置" class="headerlink" title="关于配置"></a>关于配置</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>需要在项目根目录下手动创建 <code>book.json</code> 或者 <code>book.js</code> 文件</p><h3 id="配置文件变量"><a href="#配置文件变量" class="headerlink" title="配置文件变量"></a>配置文件变量</h3><p>可以参考这篇文章中的介绍：<a href="https://chrisniael.gitbooks.io/gitbook-documentation/content/format/templating.html">GitBook文档（中文版）</a></p><h3 id="如果需要导出-pdf-等文件"><a href="#如果需要导出-pdf-等文件" class="headerlink" title="如果需要导出 pdf 等文件"></a>如果需要导出 pdf 等文件</h3><p>可以参考这篇文章中的介绍： <a href="https://snowdreams1006.github.io/myGitbook/advance/export.html">导出电子书</a></p><h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><p>安装插件有两种方式： <a href="https://www.npmjs.com/search?q=gitbook-plugin">点我搜索更多 gitbook 插件</a></p><ol><li>在 <code>/book.json</code> 配置文件中写入相应的插件和配置后，使用 <code>gitbook install</code> 命令安装插件</li><li>直接使用 <code>npm install gitbook-plugin-pluginname</code> 命令安装指定的插件，然后在 <code>/book.json</code> 配置文件中写入配置，比如安装 <code>highlight</code> 插件时，需要执行 <code>npm install gitbook-plugin-highlight</code></li></ol><pre class="line-numbers language-npm" data-language="npm"><code class="language-npm">npm install gitbook-plugin-search-pro --registry=https://registry.npm.taobao.org/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="GitBook-初始化时，会默认自动下载-7-个插件"><a href="#GitBook-初始化时，会默认自动下载-7-个插件" class="headerlink" title="GitBook 初始化时，会默认自动下载 7 个插件"></a>GitBook 初始化时，会默认自动下载 7 个插件</h3><ol><li><a href="https://github.com/GitbookIO/plugin-highlight">highlight</a>  ： 代码高亮</li><li><a href="https://github.com/GitbookIO/plugin-search">search</a>  ： 导航栏查询功能 （不支持中文）</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-lunr">lunr</a>  ：  为 <code>search</code> 插件提供后端支持</li><li><a href="https://github.com/GitbookIO/plugin-sharing">sharing</a>  ： 右上角分享功能</li><li><a href="https://github.com/GitbookIO/plugin-fontsettings">fontsettings</a>  ： 字体设置（最上方的 “A” 符号）</li><li><a href="https://github.com/GitbookIO/plugin-livereload">livereload</a>  ： 为 GitBook 实时重新加载</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-theme-default">theme-default</a>  ：  默认的 3.0.0 版本之后的主题插件</li></ol><h3 id="推荐插件"><a href="#推荐插件" class="headerlink" title="推荐插件"></a>推荐插件</h3><ul><li><a href="https://github.com/codeclou/gitbook-plugin-advanced-emoji">advanced-emoji</a>  ： 支持 emoji 表情包  <a href="https://www.webfx.com/tools/emoji-cheat-sheet/">emoji 表情包地址</a></li><li><a href="https://github.com/zq99299/gitbook-plugin-anchor-navigation-ex/blob/master/doc/config.md">anchor-navigation-ex</a>  ： 悬浮按钮目录  （在页面中增加 <extoc></extoc> 标签，会在此处生成 TOC 目录）、还会增加标题锚</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-auto-scroll-table">auto-scroll-table</a>  ：  表格滚动条</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-audio_image">audio_image</a>  ： 播放音频</li><li><a href="https://github.com/stuebersystems/gitbook-plugin-back-to-top-button">back-to-top-button</a> ： 返回顶部</li><li><a href="https://snowdreams1006.github.io/gitbook-plugin-baidu-tongji-with-multiple-channel/">baidu-tongji-with-multiple-channel</a>  ：  百度统计插件,支持多渠道独立统计,一份源码多处部署独立统计</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-chapter-fold">chapter-fold</a>  ： 左侧目录可折叠，建议和 <code>expandable-chapters</code> 插件一起使用可以互补相互的 bug</li><li><a href="https://github.com/TGhoul/gitbook-plugin-code">code</a> ： 代码添加行号和复制按钮</li><li><a href="https://github.com/zhenchao125/gitbook-plugin-change_girls">change_girls</a>  ： 可自动切换背景</li><li><a href="https://github.com/c4software/gitbook-plugin-click-reveal">click-reveal</a>  ： 点击显示内容，默认把内容已经隐藏</li><li><a href="https://github.com/Bandwidth/gitbook-plugin-custom-favicon">custom-favicon</a>  ：  修改标题栏图标</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-copyright">copyright</a>  ：  用于复制内容时追加版权信息以及文章末尾添加版权小尾巴</li><li><a href="https://github.com/willin/gitbook-plugin-donate">donate</a> ： 打赏功能</li><li><a href="https://github.com/snowdreams1006/gitbook-plugin-diff/blob/HEAD/README_zh.md">diff</a>  ： 在 markdown 文档中显示代码之间的差异</li><li><a href="https://github.com/chrisjake/gitbook-plugin-expandable-chapters-small">expandable-chapters</a>  ： 左侧目录可折叠，和 <code>expandable-chapters-small</code> 的区别是： <code>expandable-chapters-small</code> 的折叠图标要小一些 （建议和 <code>chapter-fold</code> 插件一起使用可以互补相互的 bug）</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-edit-link-plus">edit-link-plus</a>  ： 在线编辑文件</li><li><a href="https://github.com/fzankl/gitbook-plugin-flexible-alerts">flexible-alerts</a> ：警告提示框</li><li><a href="https://github.com/menduo/gitbook-plugin-favicon">favicon</a>  ： 修改网站的 favicon.ico  <a href="http://www.bitbug.net/">点我在线制作ico图标，建议尺寸32*32</a></li><li><a href="https://www.npmjs.com/package/gitbook-plugin-ga">ga</a> ： Google 分析</li><li><a href="https://github.com/GitbookIO/plugin-github">github</a> ： 右上角添加 Github 图标</li><li><a href="https://github.com/azu/gitbook-plugin-github-buttons">github-buttons</a>  ： 右上角添加 GitHub 的按钮</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-charts">gitbook-plugin-charts</a>  ：  在 gitbook 中使用图表插件，目前支持 echarts</li><li><a href="https://github.com/snowdreams1006/gitbook-plugin-google-tongji-with-multiple-channel">google-tongji-with-multiple-channel</a>  ：  Google 统计插件,支持多渠道独立统计,一份源码多处部署独立统计</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-hide-element">hide-element</a>  ：  隐藏元素</li><li><a href="https://github.com/todvora/gitbook-plugin-image-captions">image-captions</a> ： 将图片的 alt 或 title 属性转换为标题</li><li><a href="https://github.com/matusnovak/gitbook-plugin-insert-logo">insert-logo</a> ： 插入 Logo</li><li><a href="https://github.com/snowdreams1006/gitbook-plugin-icp/blob/HEAD/README_zh.md">icp</a>  ：  在首页页脚区域添加 icp 网站备案信息</li><li><a href="https://github.com/brian-dawn/gitbook-plugin-klipse">klipse</a>  ： 嵌入类似 IDE 的功能</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-lightbox">lightbox</a>  ：  页面弹窗查看图片 （支持在弹层切换上下图）</li><li><a href="https://github.com/PacktPublishing/gitbook-local-video">local-video</a>  ：  播放本地视频，<a href="http://gitbook.zhangjikai.com/plugins.html#local-video">点我查看使用教程</a></li><li><a href="https://www.npmjs.com/package/gitbook-plugin-multipart">multipart</a> ： 将左侧的目录分章节展示</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-mygitalk">mygitalk</a>  ：  通过 GitHub issues 添加评论框</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-mermaid-gb3">mermaid-gb3</a>  ： 支持 markdown 的流程图</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-meta">meta</a>  ： 添加 meta 头部信息</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-page-copyright">page-copyright</a> ： 页脚版权</li><li><a href="https://github.com/tinys/gitbook-plugin-pageview-count#readme">pageview-count</a> ： 阅读统计</li><li><a href="https://github.com/somax/gitbook-plugin-popup#readme">popup</a>  ：  打开新的页面查看图片</li><li><a href="https://github.com/gaearon/gitbook-plugin-prism">prism</a>  ：  代码块颜色插件 （使用的时候需要禁用掉 gitbook 自带的 <code>highlight</code> 插件并且和 <code>code</code> 插件一起使用时，需要放到 <code>code</code> 插件后，否则样式会被覆盖掉）</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-rss">rss</a>  ： 生成 rss <a href="https://www.ruanyifeng.com/blog/2006/01/rss.html">如何使用 RSS </a></li><li><a href="https://www.npmjs.com/package/gitbook-plugin-readmore">readmore</a>  ： 实现博客的每一篇文章自动增加阅读更多效果,关注公众号后方可解锁全站文章</li><li><a href="https://github.com/GitbookIO/plugin-sharing">sharing-plus</a> ： 分享当前页面</li><li><a href="https://github.com/yoshidax/gitbook-plugin-splitter">splitter</a> ： 侧边栏宽度可调节</li><li><a href="https://github.com/gitbook-plugins/gitbook-plugin-search-pro">search-pro</a> ： 高级搜索，支持中文 （使用的时候需要禁用掉 <code>lunr</code> 和 <code>search</code> 插件）</li><li><a href="https://github.com/manchiyiu/gitbook-plugin-sectionx">sectionx</a>  ： 折叠模块(页面内容可折叠)</li><li><a href="https://github.com/CyberZHG/gitbook-plugin-sitemap-general">sitemap-general</a>  ： 生成站点地图</li><li><a href="https://snowdreams1006.github.io/gitbook-plugin-simple-mind-map/zh/">simple-mind-map</a>  ：  在 markdown 中生成并导出思维导图</li><li><a href="https://github.com/ly-tools/gitbook-plugin-todo">todo</a> ： 待做项</li><li><a href="https://github.com/tonyyls/gitbook-plugin-theme-fexa">theme-fexa</a>  :  网站主题，使用这个主题之后不能够在页面上进行上下文翻页</li><li><a href="https://www.npmjs.com/package/gitbook-plugin-theme-comscore">theme-comscore</a>  ： 标题和正文颜色有所区分的主题，表格也有颜色</li><li><a href="https://github.com/zhj3618/gitbook-plugin-tbfed-pagefooter">tbfed-pagefooter</a>  ： 添加页脚版权信息，这个感觉没有 <code>page-copyright</code> 好用</li></ul><h2 id="我自己的-book-json-配置信息"><a href="#我自己的-book-json-配置信息" class="headerlink" title="我自己的 book.json 配置信息"></a>我自己的 book.json 配置信息</h2><blockquote><p>注意：需要删除掉所有的注释信息</p></blockquote><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Alex's Notes"</span><span class="token punctuation">,</span>  <span class="token comment">// 设置书本的标题</span>    <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"Alex"</span><span class="token punctuation">,</span>  <span class="token comment">// 作者的相关信息</span>    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"live and learn"</span><span class="token punctuation">,</span>  <span class="token comment">// 本书的简单描述</span>    <span class="token property">"language"</span><span class="token operator">:</span> <span class="token string">"zh-hans"</span><span class="token punctuation">,</span>  <span class="token comment">// 可使用的语言：en, ar, bn, cs, de, en, es, fa, fi, fr, he, it, ja, ko, no, pl, pt, ro, ru, sv, uk, vi, zh-hans, zh-tw 这里我选择的是简体中文 zh-hans</span>    <span class="token property">"gitbook"</span><span class="token operator">:</span> <span class="token string">"3.2.3"</span><span class="token punctuation">,</span>  <span class="token comment">// 指定使用的 gitbook 版本</span>    <span class="token property">"styles"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 自定义页面样式</span>        <span class="token property">"website"</span><span class="token operator">:</span> <span class="token string">"./resources/styles/website.css"</span><span class="token punctuation">,</span>  <span class="token comment">// 当此时的 gitbook 输出为站点模式时使用的 css 样式</span>        <span class="token comment">// "ebook": "styles/ebook.css",  // 当此时的 gitbook 输出为 ebook 时使用的 css 样式</span>        <span class="token comment">// "pdf": "styles/pdf.css",  // 当此时的 gitbook 输出为 pdf 时使用的 css 样式</span>        <span class="token comment">// "mobi": "styles/mobi.css",</span>        <span class="token comment">// "epub": "styles/epub.css"        </span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"structure"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 指定 Readme、Summary、Glossary 和 Languages 对应的文件名</span>        <span class="token property">"readme"</span><span class="token operator">:</span> <span class="token string">"README.md"</span><span class="token punctuation">,</span>  <span class="token comment">// 该书的介绍 （默认会创建）</span>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"SUMMARY.md"</span><span class="token punctuation">,</span>  <span class="token comment">// 该书的章节结构 （默认会创建）</span>        <span class="token comment">// "glossary": "GLOSSARY.md",  // 多语言书籍</span>        <span class="token comment">// "languages": "LANGS.md",  // 术语描述的清单</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"links"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 在左侧导航栏添加链接信息</span>        <span class="token property">"sidebar"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"我的博客"</span><span class="token operator">:</span> <span class="token string">"https://drling.xin/"</span><span class="token punctuation">,</span>            <span class="token property">"GitHub"</span><span class="token operator">:</span> <span class="token string">"https://github.com/pudongping"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">[</span>  <span class="token comment">// 需要使用的插件列表，注释插件的时候直接在插件名称前加 “横杠 -”，比如注释 “highlight” 插件为 “-highlight”</span>        <span class="token string">"-highlight"</span><span class="token punctuation">,</span>        <span class="token string">"-lunr"</span><span class="token punctuation">,</span>        <span class="token string">"-search"</span><span class="token punctuation">,</span>        <span class="token string">"search-pro"</span><span class="token punctuation">,</span>        <span class="token string">"-sharing"</span><span class="token punctuation">,</span>        <span class="token string">"sharing-plus"</span><span class="token punctuation">,</span>        <span class="token string">"fontsettings"</span><span class="token punctuation">,</span>        <span class="token string">"livereload"</span><span class="token punctuation">,</span>        <span class="token string">"expandable-chapters-small"</span><span class="token punctuation">,</span>        <span class="token string">"chapter-fold"</span><span class="token punctuation">,</span>        <span class="token string">"splitter"</span><span class="token punctuation">,</span>        <span class="token string">"hide-element"</span><span class="token punctuation">,</span>        <span class="token string">"back-to-top-button"</span><span class="token punctuation">,</span>        <span class="token string">"favicon"</span><span class="token punctuation">,</span>        <span class="token string">"insert-logo"</span><span class="token punctuation">,</span>        <span class="token string">"pageview-count"</span><span class="token punctuation">,</span>        <span class="token string">"code"</span><span class="token punctuation">,</span>        <span class="token string">"prism"</span><span class="token punctuation">,</span>        <span class="token string">"lightbox"</span><span class="token punctuation">,</span>        <span class="token string">"github"</span><span class="token punctuation">,</span>        <span class="token string">"github-buttons"</span><span class="token punctuation">,</span>        <span class="token string">"donate"</span><span class="token punctuation">,</span>        <span class="token string">"anchor-navigation-ex"</span><span class="token punctuation">,</span>        <span class="token string">"meta"</span><span class="token punctuation">,</span>        <span class="token string">"mygitalk"</span><span class="token punctuation">,</span>        <span class="token string">"change_girls"</span><span class="token punctuation">,</span>        <span class="token string">"simple-mind-map"</span><span class="token punctuation">,</span>        <span class="token string">"image-captions"</span><span class="token punctuation">,</span>        <span class="token string">"todo"</span><span class="token punctuation">,</span>        <span class="token string">"edit-link-plus"</span><span class="token punctuation">,</span>        <span class="token string">"sitemap-general"</span><span class="token punctuation">,</span>        <span class="token string">"rss"</span><span class="token punctuation">,</span>        <span class="token string">"icp"</span><span class="token punctuation">,</span>        <span class="token string">"theme-comscore"</span><span class="token punctuation">,</span>        <span class="token string">"page-copyright"</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"pluginsConfig"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"sharing"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"douban"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"facebook"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"google"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"hatenaBookmark"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"instapaper"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"line"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"linkedin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"messenger"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"pocket"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"qq"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"qzone"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"stumbleupon"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"twitter"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"viber"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"vk"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"weibo"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"whatsapp"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>            <span class="token property">"all"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"douban"</span><span class="token punctuation">,</span>                <span class="token string">"facebook"</span><span class="token punctuation">,</span>                <span class="token string">"google"</span><span class="token punctuation">,</span>                <span class="token string">"hatenaBookmark"</span><span class="token punctuation">,</span>                <span class="token string">"instapaper"</span><span class="token punctuation">,</span>                <span class="token string">"line"</span><span class="token punctuation">,</span>                <span class="token string">"linkedin"</span><span class="token punctuation">,</span>                <span class="token string">"messenger"</span><span class="token punctuation">,</span>                <span class="token string">"pocket"</span><span class="token punctuation">,</span>                <span class="token string">"qq"</span><span class="token punctuation">,</span>                <span class="token string">"qzone"</span><span class="token punctuation">,</span>                <span class="token string">"stumbleupon"</span><span class="token punctuation">,</span>                <span class="token string">"twitter"</span><span class="token punctuation">,</span>                <span class="token string">"viber"</span><span class="token punctuation">,</span>                <span class="token string">"vk"</span><span class="token punctuation">,</span>                <span class="token string">"weibo"</span><span class="token punctuation">,</span>                <span class="token string">"whatsapp"</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"hide-element"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"elements"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"a.gitbook-link[href='https://www.gitbook.com']"</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"favicon"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"shortcut"</span><span class="token operator">:</span> <span class="token string">"./resources/images/favicon.ico"</span><span class="token punctuation">,</span>            <span class="token property">"bookmark"</span><span class="token operator">:</span> <span class="token string">"./resources/images/favicon.ico"</span><span class="token punctuation">,</span>            <span class="token property">"appleTouch"</span><span class="token operator">:</span> <span class="token string">"./resources/images/favicon.png"</span><span class="token punctuation">,</span>            <span class="token property">"appleTouchMore"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"120x120"</span><span class="token operator">:</span> <span class="token string">"./resources/images/apple-touch-icon-120x120.png"</span><span class="token punctuation">,</span>                <span class="token property">"180x180"</span><span class="token operator">:</span> <span class="token string">"./resources/images/apple-touch-icon-180x180.png"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"insert-logo"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"/resources/images/favicon.png"</span><span class="token punctuation">,</span>            <span class="token property">"style"</span><span class="token operator">:</span> <span class="token string">"background: none; max-height: 30px; min-height: 30px"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"prism"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"css"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"prismjs/themes/prism-solarizedlight.css"</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"lang"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"shell"</span><span class="token operator">:</span> <span class="token string">"bash"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"lightbox"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"sameUuid"</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token comment">// 开启了这个属性之后支持在弹层，左右切换图片</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"github"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://github.com/pudongping"</span>  <span class="token comment">// 在右上角会显示很小的 github 的官方图标</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"github-buttons"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 在右上角会显示 github 图标的 button</span>            <span class="token property">"buttons"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                    <span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"pudongping"</span><span class="token punctuation">,</span>                    <span class="token property">"repo"</span><span class="token operator">:</span> <span class="token string">"glory"</span><span class="token punctuation">,</span>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"star"</span><span class="token punctuation">,</span>                    <span class="token property">"count"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                    <span class="token property">"size"</span><span class="token operator">:</span> <span class="token string">"small"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"donate"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"alipay"</span><span class="token operator">:</span> <span class="token string">"/resources/images/donate.png"</span><span class="token punctuation">,</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"\"若有共鸣，留言足矣，若有赞赏，何以复加？\""</span><span class="token punctuation">,</span>            <span class="token property">"button"</span><span class="token operator">:</span> <span class="token string">"赞赏"</span><span class="token punctuation">,</span>            <span class="token property">"alipayText"</span><span class="token operator">:</span> <span class="token string">"微信/支付宝/QQ"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"anchor-navigation-ex"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"showLevel"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 右上角浮层目录显示序号</span>            <span class="token property">"showGoTop"</span><span class="token operator">:</span> <span class="token boolean">false</span>  <span class="token comment">// 不显示回到顶部的图标，不建议开启这个属性，因为这个图标总是显示，不像 “back-to-top-button” 插件还可以自动显示和隐藏</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"meta"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"referrer"</span><span class="token punctuation">,</span>                    <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"never"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"mygitalk"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"clientID"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>  <span class="token comment">// GitHub 开发者设置，客户端连接标识</span>            <span class="token property">"clientSecret"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>  <span class="token comment">// GitHub 开发者设置，客户端秘钥</span>            <span class="token property">"repo"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>  <span class="token comment">// GitHub 仓库名</span>            <span class="token property">"owner"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>  <span class="token comment">// GitHub 仓库所有者</span>            <span class="token property">"admin"</span><span class="token operator">:</span> <span class="token punctuation">[</span>  <span class="token comment">// GitHub 仓库管理者，支持多个管理者</span>                <span class="token string">"admin-1"</span><span class="token punctuation">,</span>                <span class="token string">"admin-2"</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"distractionFreeMode"</span><span class="token operator">:</span> <span class="token boolean">false</span>  <span class="token comment">// 类似 Facebook 评论框的全屏遮罩效果,默认值: false</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"change_girls"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"time"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token comment">// 每 5 秒切换一次背景</span>            <span class="token property">"urls"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1605033246957&amp;di=d6170f1a9f0466f270ad1baee847eab9&amp;imgtype=0&amp;src=http%3A%2F%2Fpic1.win4000.com%2Fwallpaper%2Fe%2F55f26f55e9138.jpg"</span><span class="token punctuation">,</span>                <span class="token string">"https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1605033334002&amp;di=4ef73db6c98fb737f5a3068670160056&amp;imgtype=0&amp;src=http%3A%2F%2Fww3.sinaimg.cn%2Flarge%2Fd2e27164gw1fbmwbgf0mij21hc0u0487.jpg"</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"simple-mind-map"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>            <span class="token property">"preset"</span><span class="token operator">:</span> <span class="token string">"colorful"</span><span class="token punctuation">,</span>            <span class="token property">"linkShape"</span><span class="token operator">:</span> <span class="token string">"diagonal"</span><span class="token punctuation">,</span>            <span class="token property">"autoFit"</span><span class="token operator">:</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"image-captions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"caption"</span><span class="token operator">:</span> <span class="token string">"sugaryesp 的笔记 - _PAGE_LEVEL_._PAGE_IMAGE_NUMBER_ - _CAPTION_"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"edit-link-plus"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"base"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"edit-link-name-1"</span><span class="token operator">:</span> <span class="token string">"edit-link-1"</span><span class="token punctuation">,</span>                <span class="token property">"edit-link-name-2"</span><span class="token operator">:</span> <span class="token string">"edit-link-2"</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token property">"defaultBase"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>  <span class="token comment">// 这里填写链接地址</span>            <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"编辑本页"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"sitemap-general"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"prefix"</span><span class="token operator">:</span> <span class="token string">"http://notes.drling.xin/"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"rss"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"sugaryesp 的笔记"</span><span class="token punctuation">,</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"削个椰子皮_给个梨的笔记"</span><span class="token punctuation">,</span>            <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"Alex"</span><span class="token punctuation">,</span>            <span class="token property">"site_url"</span><span class="token operator">:</span> <span class="token string">"http://notes.drling.xin"</span><span class="token punctuation">,</span>            <span class="token property">"feed_url"</span><span class="token operator">:</span> <span class="token string">"http://notes.drling.xin/rss"</span><span class="token punctuation">,</span>            <span class="token property">"managingEditor"</span><span class="token operator">:</span> <span class="token string">"276558492@qq.com (Alex Pu)"</span><span class="token punctuation">,</span>            <span class="token property">"webMaster"</span><span class="token operator">:</span> <span class="token string">"276558492@qq.com (Alex Pu)"</span><span class="token punctuation">,</span>            <span class="token property">"categories"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"markdown"</span><span class="token punctuation">,</span>                <span class="token string">"git"</span><span class="token punctuation">,</span>                <span class="token string">"gitee"</span><span class="token punctuation">,</span>                <span class="token string">"github"</span><span class="token punctuation">,</span>                <span class="token string">"php"</span><span class="token punctuation">,</span>                <span class="token string">"python"</span><span class="token punctuation">,</span>                <span class="token string">"vue.js"</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"icp"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"number"</span><span class="token operator">:</span> <span class="token string">"鄂ICP备18004705号"</span><span class="token punctuation">,</span>            <span class="token property">"link"</span><span class="token operator">:</span> <span class="token string">"https://beian.miit.gov.cn/"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"page-copyright"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"modified at:"</span><span class="token punctuation">,</span>            <span class="token property">"signature"</span><span class="token operator">:</span> <span class="token string">"Alex"</span><span class="token punctuation">,</span>            <span class="token property">"wisdom"</span><span class="token operator">:</span> <span class="token string">"Artisan, Backend Developer &amp; overall web enthusiast"</span><span class="token punctuation">,</span>            <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"YYYY-MM-dd hh:mm:ss"</span><span class="token punctuation">,</span>            <span class="token property">"copyright"</span><span class="token operator">:</span> <span class="token string">"Copyright &amp;#169; Alex"</span><span class="token punctuation">,</span>            <span class="token property">"timeColor"</span><span class="token operator">:</span> <span class="token string">"#666"</span><span class="token punctuation">,</span>            <span class="token property">"copyrightColor"</span><span class="token operator">:</span> <span class="token string">"#666"</span><span class="token punctuation">,</span>            <span class="token property">"utcOffset"</span><span class="token operator">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span>            <span class="token property">"style"</span><span class="token operator">:</span> <span class="token string">"normal"</span><span class="token punctuation">,</span>            <span class="token property">"noPowered"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"baseUri"</span><span class="token operator">:</span> <span class="token string">"http://notes.drling.xin/"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="如果使用-gitbook-install-安装插件太慢，可以使用-npm-init-初始化项目，然后再使用-npm-install-安装插件"><a href="#如果使用-gitbook-install-安装插件太慢，可以使用-npm-init-初始化项目，然后再使用-npm-install-安装插件" class="headerlink" title="如果使用 gitbook install 安装插件太慢，可以使用 npm init 初始化项目，然后再使用 npm install 安装插件"></a>如果使用 gitbook install 安装插件太慢，可以使用 npm init 初始化项目，然后再使用 npm install 安装插件</h2><pre class="line-numbers language-none"><code class="language-none">cd project-directory &amp;&amp; npm init// 比如安装 livereload 插件npm install gitbook-plugin-livereload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="这是我的-package-json"><a href="#这是我的-package-json" class="headerlink" title="这是我的 package.json"></a>这是我的 package.json</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"glory"</span><span class="token punctuation">,</span>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Alex's notes"</span><span class="token punctuation">,</span>  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">" "</span><span class="token punctuation">,</span>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"gitbook-plugin-anchor-navigation-ex"</span><span class="token operator">:</span> <span class="token string">"^1.0.14"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-back-to-top-button"</span><span class="token operator">:</span> <span class="token string">"^0.1.4"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-change_girls"</span><span class="token operator">:</span> <span class="token string">"^2.2.1"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-chapter-fold"</span><span class="token operator">:</span> <span class="token string">"^0.0.4"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-code"</span><span class="token operator">:</span> <span class="token string">"^0.1.0"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-donate"</span><span class="token operator">:</span> <span class="token string">"^1.0.2"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-edit-link-plus"</span><span class="token operator">:</span> <span class="token string">"^0.1.1"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-expandable-chapters-small"</span><span class="token operator">:</span> <span class="token string">"^0.1.7"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-favicon"</span><span class="token operator">:</span> <span class="token string">"^0.0.2"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-fontsettings"</span><span class="token operator">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-github"</span><span class="token operator">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-github-buttons"</span><span class="token operator">:</span> <span class="token string">"^3.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-hide-element"</span><span class="token operator">:</span> <span class="token string">"^0.0.4"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-icp"</span><span class="token operator">:</span> <span class="token string">"^0.1.2"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-image-captions"</span><span class="token operator">:</span> <span class="token string">"^3.1.0"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-insert-logo"</span><span class="token operator">:</span> <span class="token string">"^0.1.5"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-lightbox"</span><span class="token operator">:</span> <span class="token string">"^1.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-livereload"</span><span class="token operator">:</span> <span class="token string">"0.0.1"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-meta"</span><span class="token operator">:</span> <span class="token string">"^0.1.12"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-mygitalk"</span><span class="token operator">:</span> <span class="token string">"^0.2.6"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-page-copyright"</span><span class="token operator">:</span> <span class="token string">"^1.0.8"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-pageview-count"</span><span class="token operator">:</span> <span class="token string">"^1.0.1"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-prism"</span><span class="token operator">:</span> <span class="token string">"^2.4.0"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-rss"</span><span class="token operator">:</span> <span class="token string">"^3.0.2"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-search-pro"</span><span class="token operator">:</span> <span class="token string">"^2.0.2"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-sharing-plus"</span><span class="token operator">:</span> <span class="token string">"^0.0.2"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-simple-mind-map"</span><span class="token operator">:</span> <span class="token string">"^0.2.4"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-sitemap-general"</span><span class="token operator">:</span> <span class="token string">"^0.1.1"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-splitter"</span><span class="token operator">:</span> <span class="token string">"^0.0.8"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-theme-comscore"</span><span class="token operator">:</span> <span class="token string">"0.0.3"</span><span class="token punctuation">,</span>    <span class="token property">"gitbook-plugin-todo"</span><span class="token operator">:</span> <span class="token string">"^0.1.3"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">" "</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"repository"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"git"</span><span class="token punctuation">,</span>    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"git+https://github.com/pudongping/glory.git"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"keywords"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"Artisan"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"Alex"</span><span class="token punctuation">,</span>  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span>  <span class="token property">"bugs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://github.com/pudongping/glory/issues"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"homepage"</span><span class="token operator">:</span> <span class="token string">"https://github.com/pudongping/glory#readme"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 开源 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub </tag>
            
            <tag> 博客 </tag>
            
            <tag> GitBook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 年 9 月 6 日魔都上海静安考红帽 rhcsa、rhce 记录</title>
      <link href="posts/8dcd0c17.html"/>
      <url>posts/8dcd0c17.html</url>
      
        <content type="html"><![CDATA[<h1 id="2019-09-06-魔都上海静安考红帽rhce记录"><a href="#2019-09-06-魔都上海静安考红帽rhce记录" class="headerlink" title="2019-09-06 魔都上海静安考红帽rhce记录"></a>2019-09-06 魔都上海静安考红帽rhce记录</h1><h3 id="发文申明"><a href="#发文申明" class="headerlink" title="发文申明"></a>发文申明</h3><blockquote><ol><li>本文仅对自己练习 rhce 题目做一个记录，同时纪念自己考试经历。不涉及任何推广或广告。</li><li>文中题库来源于“淘宝环境”（一般参考朋友都明白指的是哪一套环境，如果确实不知道，可以给我留言，我可以贡献一份。当天去考场的时候，我们在静安考场发现考场使用的练习环境也是“淘宝环境”，不得不说题库还是比较准确的）</li><li>“淘宝环境”前 1-6 题，因为大部分可以直接使用图形化界面答题，避免通篇都是图片，前 1-6 题，只会罗列出关键步骤，具体步骤请参考“淘宝环境”配套提供的教学视频解题。本文将从第 7 题开始详细提供参考解答方案。</li></ol></blockquote><h3 id="关于练题心态"><a href="#关于练题心态" class="headerlink" title="关于练题心态"></a>关于练题心态</h3><ul><li>刚开始练题的时候，肯定会有很多不熟悉的地方，建议可以针对性的练习，可以先针对自己觉得比较难的题目练习，但一定要切记注意题与题之间的依赖关系。</li><li>一定要注意，向他人请教解题的方法仅供自己参考，寻找适合自己的方式方法，最为重要！</li><li>少听一些考生抱怨考场环境之类的，你要相信，只要是你自己练的好，再垃圾的环境，你都能够保证你可以考过。当然你也可以发现，喜欢抱怨的考生自身本来就练的不怎么样。</li><li>CE 练题，一定要让自己达到扫一眼题目就知道该题目的解题步骤这样的境界，先在脑海中思考一下答题步骤，再答题。</li><li>考试时一条命令敲完之后，强烈建议不要马上就敲回车，再检查一下自己敲的命令，确认无误之后再回车。你要相信排错比你检查要花时间多得多，并且有时候你一旦命令敲错了，可能会导致剩下的题目无法继续下去。比如：分区时，你一不小心分了 4 个主分区，然而你又不会删除分区，这样就直接导致你后面关于分区的题目无法进行。得不偿失！</li><li>考试做完之后，强烈建议先敲击 <code>sync</code> 命令强制同步数据到硬盘中，然后先关闭 system2 （客户端）再关闭 system1（服务端），开机的时候先开启 system1 （服务端）再开启 system2 （客户端），原因：system1 提供服务，system2 挂载服务，开关机顺序不正确，极大可能性会导致挂载失败！</li><li>另外，挂载 iscsi 网络存储时，一定要注意添加 <code>_netdev</code> 参数，防止因为网络原因，导致挂载失败！</li><li>习武之人，不怕练千万招，就怕一招练千万遍！祝大家考试顺利！</li></ul><h3 id="考试背景"><a href="#考试背景" class="headerlink" title="考试背景"></a>考试背景</h3><blockquote><p>考试地点：上海静安考场（上海静安区也就那么一个考场，为避免广告之嫌，具体位置请自己查询，或直接给我留言）<br>考场环境：系统为 redhat 7.0 64 位，使用 kvm 虚拟机，因此需注意硬盘为 <code>/dev/vd*</code><br>考试时间：2019 年 9 月 6 日</p></blockquote><h3 id="题库分类"><a href="#题库分类" class="headerlink" title="题库分类"></a>题库分类</h3><p>如果把 RHCE 题库做一个分类，那么我做的分类如下：</p><ul><li>postfix 邮件服务类</li><li>samba 共享服务类</li><li>nfs 共享服务类</li><li>Apache web 服务类</li><li>脚本类</li><li>iscsi 网络存储类</li><li>MariaDB 数据库类</li></ul><h3 id="本人解题整体步骤为"><a href="#本人解题整体步骤为" class="headerlink" title="本人解题整体步骤为"></a>本人解题整体步骤为</h3><ol><li>需要安装服务，则优先安装服务</li><li>如果需要创建文件夹，则优先创建文件夹（并且设置 selinux 上下文）</li><li>如果需要创建服务账号，则优先创建服务账号</li><li>写配置文件</li><li>重启服务，并将服务加入开机启动项</li><li>设置相应的防火墙（优先使用防火墙中的富规则过滤，因为富规则的优先级最高）</li><li>简单测试一下</li></ol><p>RHCE 考试步骤较多，如果完全靠自己死记硬背，基本上很难通过考试，但是如果能够按照以上的解题步骤来，多半情况下不会忘记步骤，下文我将提供本人的解题步骤，以供各位参考。</p><h2 id="淘宝题库"><a href="#淘宝题库" class="headerlink" title="淘宝题库"></a>淘宝题库</h2><p>环境说明：</p><blockquote><p>system1.group8.example.com ： 172.24.8.11/24   作为服务器<br>system2.group8.example.com ： 172.24.8.12/24   作为客户端<br>server.group8.example.com 提供了YUM软件仓库，URL是 <a href="http://server.group8.example.com/yum">http://server.group8.example.com/yum</a></p></blockquote><ul><li><h5 id="system1-和-system2-需要先配置-yum-仓库"><a href="#system1-和-system2-需要先配置-yum-仓库" class="headerlink" title="system1 和 system2 需要先配置 yum 仓库"></a>system1 和 system2 需要先配置 yum 仓库</h5></li></ul><p><code>system1</code> 和 <code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# vim /etc/yum.repos.d/rhce.repo[root@system1 Desktop]# yum clean all[root@system1 Desktop]# yum makecache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-2b14dc0d49d4280f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>rhce.repo 文件中内容</p><pre class="line-numbers language-none"><code class="language-none">[rhce]name=rhcebaseurl=http://server.group8.example.com/yumenabled=1gpgcheck=0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-0b49bcdc721261dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第一题：设定-SELinux"><a href="#第一题：设定-SELinux" class="headerlink" title="第一题：设定 SELinux"></a>第一题：设定 SELinux</h5></li></ul><p>在 system1 和 system2 上要求 SELinux 的工作模式为 enforcing :<br>1.要求系统重启后依然生效。</p><p><code>参考解题步骤：</code></p><p><code>system1</code> 和 <code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# vim /etc/selinux/config <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><ul><li><h5 id="第二题：配置防火墙"><a href="#第二题：配置防火墙" class="headerlink" title="第二题：配置防火墙"></a>第二题：配置防火墙</h5></li></ul><p>请按下列要求在 system1 和 system2 上设定防火墙系统：</p><ol><li>允许 group8.example.com 域的客户对 system1 和 system2 进行 ssh 访问。</li><li>禁止 my133t.org 域的客户对 system1 和 system2 进行 ssh 访问。</li><li>备注： my133t.org 是在 172.13.8.0/24 网络</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code> 和 <code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# firewall-config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-685c1f39cb89e302.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第三题：自定义用户环境"><a href="#第三题：自定义用户环境" class="headerlink" title="第三题：自定义用户环境"></a>第三题：自定义用户环境</h5></li></ul><p>在系统system1和system2上创建自定义命令为qstat ，要求：</p><ol><li>此自定义命令将执行以下命令：/bin/ps -Ao pid,tt,user,fname,rsz</li><li>此命令对系统中的所有用户有效</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code> 和 <code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# vim /etc/profile[root@system1 Desktop]# source /etc/profile[root@system1 Desktop]# qstat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>/etc/profile 配置文件中内容</p><pre class="line-numbers language-none"><code class="language-none">alias qstat='/bin/ps -Ao pid,tt,user,fname,rsz'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-d5e1ff3426c65c08.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第四题：配置端口转发"><a href="#第四题：配置端口转发" class="headerlink" title="第四题：配置端口转发"></a>第四题：配置端口转发</h5></li></ul><p>在系统 system1 设定端口转发，要求：</p><ol><li>在 172.24.8.0/24 网络中的系统，访问 system1 的本地端口 5423 将被转发到 80</li><li>此设置必须永久有效</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-263777cf2f595092.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ffcd889ca6555d28.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e3b7e7f525b14f0a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第五题：配置链路聚合"><a href="#第五题：配置链路聚合" class="headerlink" title="第五题：配置链路聚合"></a>第五题：配置链路聚合</h5></li></ul><p>在 system2 和 system1 之间按以下要求设定一个链路：</p><ol><li>此链路使用接口 eth1 和 eth2</li><li>此链路在一个接口失效时仍然能工作</li><li>此链路在 system1 使用下面的地址 172.16.3.40/255.255.255.0</li><li>此链路在 system2 使用下面的地址 172.16.3.45/255.255.255.0</li><li>此链路在系统重启之后依然保持正常状态</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# nm-connection-editor[root@system1 Desktop]# systemctl restart network[root@system1 Desktop]# ping 172.16.3.40[root@system1 Desktop]# ping 172.16.3.45<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-2d8890e00f7e7a04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-938e1da1dc07f101.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><code>system2</code></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-e7b8bebe398a150b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><pre class="line-numbers language-none"><code class="language-none">[root@system2 Desktop]# nm-connection-editor[root@system2 Desktop]# systemctl restart network[root@system2 Desktop]# ping 172.16.3.45[root@system2 Desktop]# ping 172.16.3.40<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">{"runner":{"name":"activebackup"}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><ul><li><h5 id="第六题：配置-IPV6-地址"><a href="#第六题：配置-IPV6-地址" class="headerlink" title="第六题：配置 IPV6 地址"></a>第六题：配置 IPV6 地址</h5></li></ul><p>在考试系统上设定接口 eth0 使用下列 IPV6 地址：</p><ol><li>system1 上的地址应该是 2003:ac18::305/64</li><li>system2 上的地址应该是 2003:ac18::30a/64</li><li>两个系统必须能与网络 2003:ac18/64 内的系统通信</li><li>地址必须在重启后依然生效</li><li>两个系统必须保持当前的 IPV4 地址并能通信</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# nm-connection-editor[root@system1 Desktop]# systemctl restart network[root@system1 Desktop]# ping6 2003:ac18::305[root@system1 Desktop]# ping6 2003:ac18::30a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-77f2dedf4521b751.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ba079898f48dc40d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system2 Desktop]# nm-connection-editor[root@system2 Desktop]# systemctl restart network[root@system2 Desktop]# ping6 2003:ac18::30a[root@system2 Desktop]# ping6 2003:ac18::305<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-96fb85bc8b4f6eb9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第七题：配置本地邮件服务"><a href="#第七题：配置本地邮件服务" class="headerlink" title="第七题：配置本地邮件服务"></a>第七题：配置本地邮件服务</h5></li></ul><p>在系统 system2 和 system1 上配置邮件服务，要求：</p><ol><li>这些系统不接受外部发送来的邮件</li><li>在这些系统上本地发送的任何邮件都会自动路由到 mail.group8.example.com<br>从这些系统上发送的邮件显示来自于 server.group8.example.com</li><li>您可以通过发送邮件到本地用户 dave 来测试您的配置,系统 server.group8.example.com 已经配置把此用户的邮件转到URL <a href="http://server.group8.example.com/pub/received_mail/8">http://server.group8.example.com/pub/received_mail/8</a></li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code> 和 <code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# vim /etc/postfix/main.cf [root@system1 Desktop]# systemctl restart postfix[root@system1 Desktop]# systemctl enable postfix[root@system1 Desktop]# firewall-cmd --permanent --add-service=smtp[root@system1 Desktop]# firewall-cmd --reload[root@system1 Desktop]# echo "test content" | mail -s "testobject" dave[root@system1 Desktop]# curl http://server.group8.example.com/pub/received_mail/8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">98 local_transport = error:local    （需单独添加）99 myorigin = server.group8.example.com314 relayhost = mail.group8.example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-39805ba385d89d4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-63dc4393dec4e855.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-6b036d5df79504c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><ul><li><h5 id="第八题：通过-SMB-共享目录"><a href="#第八题：通过-SMB-共享目录" class="headerlink" title="第八题：通过 SMB 共享目录"></a>第八题：通过 SMB 共享目录</h5></li></ul><p>在 system1 上配置 SMB 服务 ，要求：</p><ol><li>您的 SMB 服务器必须是 STAFF 工作组的一个成员</li><li>共享 /common 目录，共享名必须为 common</li><li>只有 group8.example.com 域内的客户端可以访问 common 共享</li><li>common 必须是可以浏览的</li><li>用户 andy 必须能够读取共享中的内容，如果需要的话，验证密码是 redhat</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# yum -y install samba samba-client[root@system1 Desktop]# mkdir /common[root@system1 Desktop]# chcon -R -t samba_share_t /common[root@system1 Desktop]# id andy[root@system1 Desktop]# smbpasswd -a andy[root@system1 Desktop]# vim /etc/samba/smb.conf [root@system1 Desktop]# setsebool -P samba_enable_home_dirs on[root@system1 Desktop]# systemctl restart smb nmb[root@system1 Desktop]# systemctl enable smb nmb[root@system1 Desktop]# firewall-config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>设置防火墙</p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# firewall-cmd --permanent --add-service=samba[root@system1 Desktop]# firewall-cmd --permanent --add-service=mountd[root@system1 Desktop]# firewall-cmd --reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>配置文件填写内容</p><pre class="line-numbers language-none"><code class="language-none"> 89         workgroup = STAFF321 [common]322 path = /common323 hosts allow = 172.24.8.324 browseable = yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3e11066974a205bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f1e0a54d16e2d6e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-fb8ea5538214efd9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f24588e22d80a04a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>验证：</p><p><code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system2 Desktop]# yum -y install samba-client cifs-utils[root@system2 Desktop]# smbclient -L //172.24.8.11 -U andy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b16cc12affa9a5a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第九题：配置多用户-SMB-挂载"><a href="#第九题：配置多用户-SMB-挂载" class="headerlink" title="第九题：配置多用户 SMB 挂载"></a>第九题：配置多用户 SMB 挂载</h5></li></ul><p>在 system1 通过 SMB 共享目录 /devops ,并满足下列要求：</p><ol><li>共享名为 devops</li><li>共享目录 devops 只能 group8.example.com 域中的客户端使用</li><li>共享目录 devops 必须可以被浏览</li><li>用户 silene 必须能以读的方式访问此共享，访问密码是redhat</li><li>用户 akira 必须能以读写的方式访问此共享，访问密码是redhat</li><li>此共享永久挂载在 system2.group8.example.com 上的 /mnt/dev 目录，并使用用户 silene 作为认证任何用户，可以通过用户 akira 来临时获取写的权限</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# ls -ald /devops[root@system1 Desktop]# mkdir /devops[root@system1 Desktop]# chmod o+w /devops[root@system1 Desktop]# chcon -R -t samba_share_t /devops[root@system1 Desktop]# id silene[root@system1 Desktop]# smbpasswd -a silene[root@system1 Desktop]# id akira[root@system1 Desktop]# smbpasswd -a akira[root@system1 Desktop]# vim /etc/samba/smb.conf[root@system1 Desktop]# systemctl restart smb nmb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置文件填写内容</p><pre class="line-numbers language-none"><code class="language-none">325 [devops]326 path = devops327 hosts allow = 172.24.8.328 browseable = yes329 writable = no330 write list = akira<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-c70f323e9ffbf6fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system2 Desktop]# yum -y install cifs*[root@system2 Desktop]# smbclient -L //172.24.8.11 -U silene[root@system2 Desktop]# smbclient -L //172.24.8.12 -U akira[root@system2 Desktop]# ls -ald /mnt/dev[root@system2 Desktop]# mkdir -p /mnt/dev[root@system2 Desktop]# vim /etc/fstab [root@system2 Desktop]# mount -a[root@system2 Desktop]# df -hT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/etc/fstab 挂载配置文件中填写内容</p><pre class="line-numbers language-none"><code class="language-none">//172.24.8.11/devops /mnt/dev cifs defaults,multiuser,username=silene,password=redhat,sec=ntlmssp 0 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-fb7fd346bbe27159.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-2d02e76c2d839096.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第十题：配置-NFS-服务"><a href="#第十题：配置-NFS-服务" class="headerlink" title="第十题：配置 NFS 服务"></a>第十题：配置 NFS 服务</h5></li></ul><p>在 system1 配置 NFS 服务，要求如下：</p><ol><li>以只读的方式共享目录 /public ，同时只能被 group8.example.com 域中的系统访问</li><li>以读写的方式共享目录 /protected ，同时只能被 group8.example.com 域中的系统访问</li><li>访问 /protected 需要通过 Kerberos 安全加密，您可以使用下面 URL 提供的密钥<br><a href="http://server.group8.example.com/pub/keytabs/system1.keytab">http://server.group8.example.com/pub/keytabs/system1.keytab</a></li><li>目录 /protected 应该包含名为 project 拥有人为 andres 的子目录</li><li>用户 andres 能以读写方式访问 /protected/project</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# ls -ald /public[root@system1 Desktop]# mkdir /public[root@system1 Desktop]# ls -ald /protected[root@system1 Desktop]# mkdir -p /protected/project[root@system1 Desktop]# chown andres /protected/project[root@system1 Desktop]# ls -ald /protected/project[root@system1 Desktop]# chcon -R -t public_content_t /public[root@system1 Desktop]# chcon -R -t public_content_t /protected[root@system1 Desktop]# wget -O /etc/krb5.keytab http://server.group8.example.com/pub/keytabs/system1.keytab[root@system1 Desktop]# vim /etc/sysconfig/nfs [root@system1 Desktop]# vim /etc/exports[root@system1 Desktop]# systemctl restart nfs-server nfs-secure-server[root@system1 Desktop]# systemctl enable nfs-server nfs-secure-server[root@system1 Desktop]# firewall-config [root@system1 Desktop]# exportfs -r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/etc/sysconfig/nfs 配置文件中填写的内容</p><pre class="line-numbers language-none"><code class="language-none">13 RPCNFSDARGS="-V 4.2"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-4913def5d21efda0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>/etc/exports 配置文件中填写内容</p><pre class="line-numbers language-none"><code class="language-none">1 /public 172.24.8.0/24(ro)2 /protected 172.24.8.0/24(rw,sec=krb5p)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>设置防火墙</p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# firewall-cmd --permanent --add-service=nfs[root@system1 Desktop]# firewall-cmd --permanent --add-service=rpc-bind[root@system1 Desktop]# firewall-cmd --reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><ul><li><h5 id="第十一题：挂载一个-NFS-共享"><a href="#第十一题：挂载一个-NFS-共享" class="headerlink" title="第十一题：挂载一个 NFS 共享"></a>第十一题：挂载一个 NFS 共享</h5></li></ul><p>在 system2 上挂载一个来自 system1.group8.example.com 的 NFS 共享,并符合下列要求：</p><ol><li>/public 挂载在下面的目录上 /mnt/nfsmount</li><li>/protected 挂载在下面的目录上 /mnt/nfssecure 并使用安全的方式，密钥下载 URL 如下：<a href="http://server.group8.example.com/pub/keytabs/system2.keytab">http://server.group8.example.com/pub/keytabs/system2.keytab</a></li><li>用户 andres 能够在 /mnt/nfssecure/project 上创建文件</li><li>这些文件系统在系统启动时自动挂载</li></ol><p><code>参考解题步骤：</code></p><p><code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system2 Desktop]# showmount -e 172.24.8.11[root@system2 Desktop]# systemctl restart nfs-secure[root@system2 Desktop]# systemctl enable nfs-secure[root@system2 Desktop]# ls -ald /mnt/nfsmount[root@system2 Desktop]# mkdir -p /mnt/nfsmount[root@system2 Desktop]# ls -ald /mnt/nfssecure[root@system2 Desktop]# mkdir -p /mnt/nfssecure[root@system2 Desktop]# wget -O /etc/krb5.keytab http://server.group8.example.com/pub/keytabs/system2.keytab[root@system2 Desktop]# vim /etc/fstab [root@system2 Desktop]# mount -a[root@system2 Desktop]# df -hT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/etc/fstab 挂载配置文件填写的内容</p><pre class="line-numbers language-none"><code class="language-none">172.24.8.11:/public /mnt/nfsmount nfs defaults 0 0172.24.8.11:/protected /mnt/nfssecure nfs defaults,sec=krb5p,v4.2 0 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-24db5060b6f9e1e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第十二题：实现一个-web-服务器"><a href="#第十二题：实现一个-web-服务器" class="headerlink" title="第十二题：实现一个 web 服务器"></a>第十二题：实现一个 web 服务器</h5></li></ul><p>在 system1 上配置一个站点 <a href="http://system1.group8.example.com/%EF%BC%8C%E7%84%B6%E5%90%8E%E6%89%A7%E8%A1%8C%E4%B8%8B%E8%BF%B0%E6%AD%A5%E9%AA%A4%EF%BC%9A">http://system1.group8.example.com/，然后执行下述步骤：</a></p><ol><li>从 <a href="http://server.group8.example.com/pub/system1.html">http://server.group8.example.com/pub/system1.html</a> 下载文件，并且将文件重名为 index.html 不要修改此文件的内容</li><li>将文件 index.html 拷贝到您的 web 服务器的 DocumentRoot 目录下</li><li>来自于 group8.example.com 域的客户端可以访问此 web 服务</li><li>来自于 my133t.org 域的客户端拒绝访问此 web 服务</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# yum -y install httpd[root@system1 Desktop]# cp /usr/share/doc/httpd-2.4.6/httpd-vhosts.conf /etc/httpd/conf.d/[root@system1 Desktop]# cd /var/www/html[root@system1 html]# wget -O index.html http://server.group8.example.com/pub/system1.html[root@system1 html]# vim /etc/httpd/conf.d/httpd-vhosts.conf[root@system1 html]# systemctl restart httpd[root@system1 html]# systemctl enable httpd[root@system1 html]# firewall-config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1dfde17bdf2ad2be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>/etc/httpd/conf.d/httpd-vhosts.conf 网站配置文件中应该写的内容</p><pre class="line-numbers language-none"><code class="language-none">&lt;VirtualHost *:80&gt;    DocumentRoot "/var/www/html"    ServerName system1.group8.example.com&lt;/VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-ee2ee212b0c01df7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b369ae9ea1b88007.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第十三题：配置安全-web-服务"><a href="#第十三题：配置安全-web-服务" class="headerlink" title="第十三题：配置安全 web 服务"></a>第十三题：配置安全 web 服务</h5></li></ul><p>为站点 <a href="http://system1.group8.example.com/">http://system1.group8.example.com</a> 配置 TLS 加密：</p><ol><li>一个已签名证书从 <a href="http://server.group8.example.com/pub/tls/certs/system1.crt">http://server.group8.example.com/pub/tls/certs/system1.crt</a> 获取</li><li>此证书的密钥从 <a href="http://server.group8.example.com/pub/tls/private/system1.key">http://server.group8.example.com/pub/tls/private/system1.key</a> 获取</li><li>此证书的签名授权信息从 <a href="http://server.group8.example.com/pub/tls/certs/ssl-ca.crt">http://server.group8.example.com/pub/tls/certs/ssl-ca.crt</a> 获取</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# yum -y install mod_ssl[root@system1 Desktop]# cd /var/www/html[root@system1 html]# wget http://server.group8.example.com/pub/tls/certs/system1.crt[root@system1 html]# wget http://server.group8.example.com/pub/tls/private/system1.key[root@system1 html]# wget http://server.group8.example.com/pub/tls/certs/ssl-ca.crt[root@system1 html]# vim /etc/httpd/conf.d/ssl.conf    （用于参考的配置文件）[root@system1 html]# vim /etc/httpd/conf.d/httpd-vhosts.conf[root@system1 html]# setsebool -P httpd_read_user_content=on[root@system1 html]# systemctl restart httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/etc/httpd/conf.d/httpd-vhosts.conf 网站配置文件中应该写的内容</p><pre class="line-numbers language-none"><code class="language-none">&lt;VirtualHost *:443&gt;SSLEngine onSSLProtocol all -SSLv2SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5SSLHonorCipherOrder on    DocumentRoot "/var/www/html"    ServerName system1.group8.example.comSSLCertificateFile /var/www/html/system1.crtSSLCertificateKeyFile /var/www/html/system1.keySSLCACertificateFile /var/www/html/ssl-ca.crt&lt;/VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-99e658186dfb348a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="/etc/httpd/conf.d/ssl.conf 参考的配置文件"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-1368eb4ebabcab95.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第十四题：配置虚拟主机"><a href="#第十四题：配置虚拟主机" class="headerlink" title="第十四题：配置虚拟主机"></a>第十四题：配置虚拟主机</h5></li></ul><p>在 system1 上扩展您的 web 服务器，为站点 <a href="http://www8.group8.example.com/">http://www8.group8.example.com</a> 创建一个虚拟主机，然后执行下述步骤：</p><ol><li>设置 DocumentRoot 为 /var/www/virtual</li><li>从 <a href="http://server.group8.example.com/pub/www8.html">http://server.group8.example.com/pub/www8.html</a> 下载文件重名为 index.html ,不要对文件 index.html 的内容做任何修改</li><li>将文件 index.html 放到虚拟主机的 DocumentRoot 目录下</li><li>确保 andy 用户能够在 /var/www/virtual 目录下创建文件</li></ol><p>注意：原站点 <a href="http://system1.group8.example.com/">http://system1.group8.example.com</a> 必须仍然能够访问，名称服务器 server.group8.example.com 已经提供对主机名 www8.group8.example.com 的域名解析</p><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 Desktop]# mkdir /var/www/virtual[root@system1 Desktop]# cd /var/www/virtual[root@system1 virtual]# getfacl /var/www/virtual[root@system1 virtual]# setfacl -Rm u:andy:rwx /var/www/virtual[root@system1 virtual]# getfacl /var/www/virtual[root@system1 virtual]# wget -O index.html http://server.group8.example.com/pub/www8.html[root@system1 virtual]# vim /etc/httpd/conf.d/httpd-vhosts.conf[root@system1 virtual]# systemctl restart httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/etc/httpd/conf.d/httpd-vhosts.conf 配置文件中填写内容</p><pre class="line-numbers language-none"><code class="language-none">&lt;VirtualHost *:80&gt;    DocumentRoot "/var/www/virtual"    ServerName www8.group8.example.com&lt;/VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-a5cc2d08a9cba270.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第十五题：配置-web-内容的访问"><a href="#第十五题：配置-web-内容的访问" class="headerlink" title="第十五题：配置 web 内容的访问"></a>第十五题：配置 web 内容的访问</h5></li></ul><p>在您的 system1 上的 web 服务器的 DocumentRoot 目录下，创建一个名为 private 的目录，要求如下：</p><ol><li>从 <a href="http://server.group8.example.com/pub/private.html">http://server.group8.example.com/pub/private.html</a> 下载一个文件副本到这个目录，并且重命名为 index.html</li><li>不要对这个文件的内容做任何修改</li><li>从 system1 上，任何人都可以浏览 private 的内容，但是从其它系统不能访问这个目录的内容。</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 virtual]# cd /var/www/html[root@system1 html]# mkdir private[root@system1 html]# cd private/[root@system1 private]# wget -O index.html http://server.group8.example.com/pub/private.html[root@system1 private]# vim /etc/httpd/conf/httpd.conf  （用于参考的配置文件）[root@system1 private]# vim /etc/httpd/conf.d/httpd-vhosts.conf[root@system1 private]# systemctl restart httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/etc/httpd/conf.d/httpd-vhosts.conf 配置文件中填写内容</p><pre class="line-numbers language-none"><code class="language-none">&lt;Directory "/var/www/html/private"&gt;    AllowOverride none    Require all denied    Require local&lt;/Directory&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-45144d1a5ab0c065.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第十六题：实现动态-WEB-内容"><a href="#第十六题：实现动态-WEB-内容" class="headerlink" title="第十六题：实现动态 WEB 内容"></a>第十六题：实现动态 WEB 内容</h5></li></ul><p>在 system1 上配置提供动态 web 内容，要求：</p><ol><li>动态内容由名为 wsgi.group8.example.com 的虚拟主机提供</li><li>虚拟主机侦听在端口 8909</li><li>从 <a href="http://server.group8.example.com/pub/webinfo.wsgi">http://server.group8.example.com/pub/webinfo.wsgi</a> 下载一个脚本，然后放在适当的位置，无论如何不要求修改此文件的内容</li><li>客户端访问 <a href="http://wsgi.group8.example.com:8909/">http://wsgi.group8.example.com:8909/</a> 时，应该接收到动态生成的 web 页面</li><li>此 <a href="http://wsgi.group8.example.com:8909/">http://wsgi.group8.example.com:8909/</a> 必须能被 group8.example.com 域内的所有系统访问</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 private]# cd /var/www/html[root@system1 html]# yum -y install mod_wsgi[root@system1 html]# wget http://server.group8.example.com/pub/webinfo.wsgi[root@system1 html]#  vim /etc/httpd/conf.d/httpd-vhosts.conf[root@system1 html]# semanage port -a -t http_port_t -p tcp 8909[root@system1 html]# systemctl restart httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/etc/httpd/conf.d/httpd-vhosts.conf 配置文件中填写内容</p><pre class="line-numbers language-none"><code class="language-none">listen 8909&lt;VirtualHost *:8909&gt;    WSGIScriptAlias / /var/www/html/webinfo.wsgi    ServerName wsgi.group8.example.com&lt;/VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5c83ffa719496429.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-f9ba955a92c22aed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第十七题：创建一个脚本"><a href="#第十七题：创建一个脚本" class="headerlink" title="第十七题：创建一个脚本"></a>第十七题：创建一个脚本</h5></li></ul><p>在 system1 上创建一个名为 /root/foo.sh 的脚本，让其提供下列特性：</p><ol><li>当运行 /root/foo.sh redhat ,输出为 fedora</li><li>当运行 /root/foo.sh fedora ,输出为 redhat</li><li>当没有任何参数或者参数不是 redhat 或者 fedora 时，其错误输出产生以下的信息：<br>/root/foo.sh redhat | fedora</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 html]# cd ~[root@system1 ~]# vim /root/foo.sh[root@system1 ~]# chmod a+x /root/foo.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>/root/foo.sh 文件中需要填写的内容</p><pre class="line-numbers language-none"><code class="language-none">case $1 inredhat)echo 'fedora';;fedora)echo 'redhat';;*)echo '/root/foo.sh redhat | fedora';;esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b8c4cc35ec38c4da.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第十八题：创建一个添加用户的脚本"><a href="#第十八题：创建一个添加用户的脚本" class="headerlink" title="第十八题：创建一个添加用户的脚本"></a>第十八题：创建一个添加用户的脚本</h5></li></ul><p>在 system1 上创建一个脚本，名为 /root/batchusers ,此脚本能实现为系统 system1 创建本地用户，并且这些用户的用户名来自一个包含用户名列表的文件，同时满足下列要求：</p><ol><li>此脚本要求提供一个参数，此参数就是包含用户名列表的的文件</li><li>如果没有提供参数，此脚本应该给出下面的提示信息 Usage: /root/batchusers userfile 然后退出并返回相应的值</li><li>如果提供一个不存在的文件名，此脚本应该给出下面的提示信息 Input file not found 然后退出并返回相应的值</li><li>创建的用户登录 shell 为 /bin/false</li><li>此脚本不需要为用户设置密码</li><li>您可以从下面的 URL 获取用户名列表作为测试用 <a href="http://server.group8.example.com/pub/userlist">http://server.group8.example.com/pub/userlist</a></li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 ~]# cd ~[root@system1 ~]# wget http://server.group8.example.com/pub/userlist[root@system1 ~]# more userlist[root@system1 ~]# vim /root/batchusers[root@system1 ~]# chmod a+x /root/batchusers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/root/batchusers 文件中需要填写的内容</p><pre class="line-numbers language-none"><code class="language-none">if [ $# -eq 0 ];thenecho 'Usage: /root/batchusers userfile'exit 1fiif [ ! -f $1 ];thenecho 'Input file not found'exit 1fiwhile read linedouseradd -s /bin/false $linedone &lt; $1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><ul><li><h5 id="第十九题：配置-ISCSI-服务端"><a href="#第十九题：配置-ISCSI-服务端" class="headerlink" title="第十九题：配置 ISCSI 服务端"></a>第十九题：配置 ISCSI 服务端</h5></li></ul><p>配置 system1 提供一个 ISCSI 服务 磁盘名为 iqn.2014-08.com.example.group8:system1 ，并符合下列要求：</p><ol><li>服务端口为 3260</li><li>使用 iscsi_store 作其后端逻辑卷名称，其大小为 3G</li><li>此服务只能被 system2.group8.example.com 访问</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 ~]# yum -y install target*[root@system1 ~]# ls -ald /dev/sd*[root@system1 ~]# fdisk /dev/sda[root@system1 ~]# partprobe[root@system1 ~]# partprobe[root@system1 ~]# ls -ald /dev/sd*[root@system1 ~]# pvcreate /dev/sda3[root@system1 ~]# vgcreate rhce /dev/sda3[root@system1 ~]# lvcreate -l 100%VG -n iscsi_store rhce[root@system1 ~]# lvscan[root@system1 ~]# targetcli[root@system1 ~]# systemctl restart target[root@system1 ~]# systemctl enable target[root@system1 ~]# firewall-config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-57e18e04cca64462.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-763a51805201d72d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5814e618608d527d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>targetcli 配置命令如下</p><pre class="line-numbers language-none"><code class="language-none">/&gt; ls/&gt; cd /backstores/block/backstores/block&gt; create disk0 /dev/rhce/iscsi_store/backstores/block&gt; cd /iscsi /iscsi&gt; ls/iscsi&gt; create iqn.2014-08.com.example.group8:system1/iscsi&gt; ls/iscsi&gt; cd iqn.2014-08.com.example.group8:system1/tpg1/acls /iscsi/iqn.20...em1/tpg1/acls&gt; create iqn.2014-08.com.example.group8:system2/iscsi/iqn.20...em1/tpg1/acls&gt; cd ../luns /iscsi/iqn.20...em1/tpg1/luns&gt; create /backstores/block/disk0/iscsi/iqn.20...em1/tpg1/luns&gt; cd ../portals//iscsi/iqn.20.../tpg1/portals&gt; create 172.24.8.11 3260/iscsi/iqn.20.../tpg1/portals&gt; ls/iscsi/iqn.20.../tpg1/portals&gt; delete 0.0.0.0 3260/iscsi/iqn.20.../tpg1/portals&gt; create 172.24.8.11 3260/iscsi/iqn.20.../tpg1/portals&gt; ls/iscsi/iqn.20.../tpg1/portals&gt; exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-b42054fbaadaadd4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第二十题：配置-iSCISI-的客户端"><a href="#第二十题：配置-iSCISI-的客户端" class="headerlink" title="第二十题：配置 iSCISI 的客户端"></a>第二十题：配置 iSCISI 的客户端</h5></li></ul><p>配置 system2 使其能连接在 system1 上提供的 iqn.2014-08.com.example.group8:system1,并符合以下要求：</p><ol><li>iSCISI 设备在系统启动的期间自动加载</li><li>块设备 iSCISI 上包含一个大小为 2100 MiB 的分区，并格式化为 ext4</li><li>此分区挂载在 /mnt/data 上，同时在系统启动的期间自动挂载</li></ol><p><code>参考解题步骤：</code></p><p><code>system2</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system2 Desktop]# yum -y install iscsi-*[root@system2 Desktop]# vim /etc/iscsi/initiatorname.iscsi [root@system2 Desktop]# systemctl restart iscsi iscsid[root@system2 Desktop]# systemctl enable iscsi iscsid[root@system2 Desktop]# lsblk[root@system2 Desktop]# iscsiadm -m discovery -t st -p 172.24.8.11[root@system2 Desktop]# iscsiadm -m node -T iqn.2014-08.com.example.group8:system1 -l[root@system2 Desktop]# lsblk[root@system2 Desktop]# ls -ald /dev/sd*[root@system2 Desktop]# fdisk /dev/sdb[root@system2 Desktop]# ls -ald /dev/sd*[root@system2 Desktop]# mkfs   （连续按两次 type 键）[root@system2 Desktop]# mkfs.ext4 /dev/sdb1[root@system2 Desktop]# blkid /dev/sdb1[root@system2 Desktop]# ls -ald /mnt/data[root@system2 Desktop]# mkdir -p /mnt/data[root@system2 Desktop]# vim /etc/fstab [root@system2 Desktop]# mount -a[root@system2 Desktop]# df -hT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/etc/iscsi/initiatorname.iscsi 配置文件中的内容如下</p><pre class="line-numbers language-none"><code class="language-none">InitiatorName=iqn.2014-08.com.example.group8:system2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>/etc/fstab 挂载配置文件内容如下</p><pre class="line-numbers language-none"><code class="language-none">UUID="82e0d1be-f690-45e2-8dfc-7aa548df3fff" /mnt/data ext4 defaults,_netdev 0 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-720bb16f0fdc7c93.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-3cba38302ca24aeb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><hr><ul><li><h5 id="第二十一题：配置一个数据库"><a href="#第二十一题：配置一个数据库" class="headerlink" title="第二十一题：配置一个数据库"></a>第二十一题：配置一个数据库</h5></li></ul><p>在 system1上创建一个 Maria DB 数据库，名为 Contacts，要求：</p><ol><li>数据库应该包含来自数据库复制的内容，复制文件的URL为 <a href="http://server.group8.example.com/pub/users.mdb">http://server.group8.example.com/pub/users.mdb</a> ，数据库只能被 localhost 访问</li><li>除了 root 用户，此数据库只能被用户 Mary 查询，此用户密码为 redhat</li><li>root 用户的数据库密码为 redhat ，同时不允许空密码登录</li></ol><p><code>参考解题步骤：</code></p><p><code>system1</code></p><pre class="line-numbers language-none"><code class="language-none">[root@system1 ~]# yum -y install mariadb mariadb-client mariadb-server[root@system1 ~]# wget http://server.group8.example.com/pub/users.mdb[root@system1 ~]# vim /etc/my.cnf[root@system1 ~]# systemctl restart mariadb [root@system1 ~]# systemctl enable mariadb[root@system1 ~]# mysql_secure_installation      （交互界面全部选择 y ）[root@system1 ~]# mysql -u root -p<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">19 skip-networking=1    （请自行添加）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/medias/loading.gif" data-original="https://upload-images.jianshu.io/upload_images/14623749-5b4118b997756732.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>进入 MariaDB 数据库使用的命令如下</p><pre class="line-numbers language-none"><code class="language-none">MariaDB [(none)]&gt; show databases;MariaDB [(none)]&gt; create database Contacts;MariaDB [(none)]&gt; use Contacts;MariaDB [Contacts]&gt; source users.mdb;MariaDB [Contacts]&gt; show tables;MariaDB [Contacts]&gt; grant select on Contacts.* to Mary@'localhost' identified by 'redhat';MariaDB [Contacts]&gt; exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><ul><li><h5 id="第二十一题：数据库查询"><a href="#第二十一题：数据库查询" class="headerlink" title="第二十一题：数据库查询"></a>第二十一题：数据库查询</h5></li></ul><p>在 system1 上使用数据库 Contacts ，并使用相应的 SQL 查询以回答下列问题：</p><ol><li>密码是 fadora 的人的名字是什么？</li><li>有多少人的姓名是 John ，同时居住在 Santa Clara ？</li></ol><p>直接贴出 sql 语句如下，仅供参考，考试时在这里的变数还是很大的，建议不要死记硬背。</p><pre class="line-numbers language-none"><code class="language-none">select n.firstname,n.lastname from u_name  as n left join u_passwd as p where n.userid = p.uid and p.password = 'fedora';select count(*) from u_name as n left join u_loc as l where n.userid = l.uid and n.firstname = 'John' and l.location = 'Santa Clara';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 红帽认证 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo-blog 博客开源</title>
      <link href="posts/e3e08109.html"/>
      <url>posts/e3e08109.html</url>
      
        <content type="html"><![CDATA[<h1 id="博客开源"><a href="#博客开源" class="headerlink" title="博客开源"></a>博客开源</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>折腾了一个星期左右，总算是把我的个人博客给完善了，为了回馈开源，我会把我自己修改后的且完善的 <code>blog</code> 网站源码开源。<br>代码都是源码，您可以直接下载我的博客源码，然后将根目录下的 <code>/_config.yml</code> 和 <code>/themes/hexo-theme-matery/_config.yml</code><br>这两个配置文件中的信息修改成您的信息就可以部署成和我一摸一样的博客了。是不是很方便？这对于一些想写博客，但是又不想太折腾，<br>并且对美观有一定要求的朋友来说，简直是爽的不要不要的。😜 <a href="https://github.com/pudongping/pudongping.github.io">点我立即下载我的博客源码</a></p><h2 id="关于我的博客项目"><a href="#关于我的博客项目" class="headerlink" title="关于我的博客项目"></a>关于我的博客项目</h2><p>这个博客，我是基于 <strong><a href="https://hexo.io/zh-cn/docs/">Hexo</a></strong> 框架搭建，并且用到 <strong><a href="https://github.com/blinkfox/hexo-theme-matery">hexo-theme-matery</a></strong> 主题，<br>在此基础上做了不少的修改，增加了一些新的特性和功能。我的博客访问地址为：<a href="http://www.pudongping.com/">http://www.pudongping.com</a> 或者访问 <a href="https://pudongping.github.io/">https://pudongping.github.io</a></p><h2 id="创建项目时，各个软件版本介绍"><a href="#创建项目时，各个软件版本介绍" class="headerlink" title="创建项目时，各个软件版本介绍"></a>创建项目时，各个软件版本介绍</h2><ul><li>修改项目时间为 2021 年 6 月 5 日</li><li>使用的 node.js 版本为：v16.2.0</li><li>使用的 npm 版本为：7.13.0</li><li>使用的 hexo 版本为：5.4.0</li><li>使用的 hexo-theme-matery 皮肤版本为：v2.0.0</li><li>其他的依赖包见 package.json 文件，具体版本号见 package-lock.json 文件。</li></ul><h2 id="如何搭建和我一摸一样的博客？"><a href="#如何搭建和我一摸一样的博客？" class="headerlink" title="如何搭建和我一摸一样的博客？"></a>如何搭建和我一摸一样的博客？</h2><blockquote><p>前提你需要先安装 <code>git</code> 和 <code>node.js</code> （安装好 node.js 之后，会自动安装 npm，强烈建议使用 <a href="https://github.com/nvm-sh/nvm">nvm</a> 安装 node.js 以方便管理多个版本的 node.js）</p></blockquote><ul><li>安装 <code>hexo-cli</code></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 全局安装 hexo</span><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> hexo-cli<span class="token comment"># 局部安装 hexo</span><span class="token function">npm</span> <span class="token function">install</span> hexo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>直接使用 <code>git</code> 拉取项目并进入相应的文件目录</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用 GitHub 地址</span><span class="token function">git</span> clone https://github.com/pudongping/pudongping.github.io.git blog<span class="token comment"># 使用 gitee 地址 （要是代码拉取不下来的话，建议使用 gitee 地址）</span><span class="token function">git</span> clone https://gitee.com/pudongping/pudongping.git blog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>切换分支</li></ul><p>建议切换到 <code>hexo</code> 分支，方便你自定义你的博客。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 如果你想实现和我一摸一样的博客的话，你可以直接切换到 `main` 分支，这是我自己完整的博客源码分支，其中包含了我所有的博客文章</span><span class="token function">git</span> checkout main<span class="token comment"># 如果你只想获取我所有的修改，并基于此基础之上改成自己的博客的话，那么可以切换到 `hexo` 分支，这个分支上是我博客修改的基础分支，</span><span class="token comment"># 在此分支基础之上你可以添加你自己的任何修改。（不包含我所有的博客文章和我自定义的其他修改）</span><span class="token function">git</span> checkout hexo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装依赖插件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>修改根目录下的 <code>/_config.yml</code> 和 <code>/themes/hexo-theme-matery/_config.yml</code> 的这两个配置文件，改成自己的信息</p></li><li><p>编译源代码</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清除生成的静态文件</span>hexo cl<span class="token comment"># 生成静态页面至 public 页面 （如果只是本地预览，可不进行此步骤）</span>hexo g<span class="token comment"># 生成本地预览</span>hexo s<span class="token comment"># 如果需要生成 github-pages 的话，则执行以下命令 （需要安装 npm install hexo-deployer-git --save 插件包）</span>hexo d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>本地访问项目</li></ul><p>直接在浏览器中访问 <a href="http://localhost:4000/]">http://localhost:4000/</a> 即可。部署完毕！</p><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="hexo-theme-matery-主题特性"><a href="#hexo-theme-matery-主题特性" class="headerlink" title="hexo-theme-matery 主题特性"></a>hexo-theme-matery 主题特性</h3><ul><li>简单漂亮，文章内容美观易读</li><li><a href="https://material.io/">Material Design</a> 设计</li><li>响应式设计，博客在桌面端、平板、手机等设备上均能很好的展现</li><li>首页轮播文章及每天动态切换 <code>Banner</code> 图片</li><li>瀑布流式的博客文章列表（文章无特色图片时会有 <code>24</code> 张漂亮的图片代替）</li><li>时间轴式的归档页</li><li><strong>词云</strong>的标签页和<strong>雷达图</strong>的分类页</li><li>丰富的关于我页面（包括关于我、文章统计图、我的项目、我的技能、相册等）</li><li>可自定义的数据的友情链接页面</li><li>支持文章置顶和文章打赏</li><li>支持 <code>MathJax</code></li><li><code>TOC</code> 目录</li><li>可设置复制文章内容时追加版权信息</li><li>可设置阅读文章时做密码验证</li><li><a href="https://gitalk.github.io/">Gitalk</a>、<a href="https://imsun.github.io/gitment/">Gitment</a>、<a href="https://valine.js.org/">Valine</a> 和 <a href="https://disqus.com/">Disqus</a> 评论模块（推荐使用 <code>Gitalk</code>）</li><li>集成了<a href="http://busuanzi.ibruce.info/">不蒜子统计</a>、谷歌分析（<code>Google Analytics</code>）和文章字数统计等功能</li><li>支持在首页的音乐播放和视频播放功能</li><li>支持<code>emoji</code>表情，用<code>markdown emoji</code>语法书写直接生成对应的能<strong>跳跃</strong>的表情。</li><li>支持 <a href="http://www.daovoice.io/">DaoVoice</a>、<a href="https://www.tidio.com/">Tidio</a> 在线聊天功能。</li></ul><h3 id="修改或增加的特性功能"><a href="#修改或增加的特性功能" class="headerlink" title="修改或增加的特性功能"></a>修改或增加的特性功能</h3><ul><li>添加 emoji 表情支持</li><li>添加 RSS 订阅支持</li><li>添加站点地图支持</li><li>css、js资源增加 cdn 加速</li><li>底部增加备案号信息</li><li>修改了主题颜色</li><li>处理了图片因防盗链无法显示问题</li><li>添加了动态改变页面标签的功能</li><li>添加了鼠标点击烟花爆炸特效</li><li>添加了鼠标点击出现自定义文字浮层特效</li><li>添加了页面樱花飘落动态特效</li><li>添加了页面雪花飘落动态特效</li><li>优化文章的 url</li><li>图片懒加载</li><li>添加了在<strong>关于我</strong>页面写简历功能</li><li>修改了 banner 图随机轮播</li></ul><h2 id="博客截图"><a href="#博客截图" class="headerlink" title="博客截图"></a>博客截图</h2><p><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/page.png" alt="首页"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/articles-list.png" alt="文章列表"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/articles-list-1.png" alt="文章列表"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/article-detail.png" alt="文章详情"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/article-detail-1.png" alt="文章详情"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/tags.png" alt="标签页"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/categories.png" alt="分类页"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/archives.png" alt="归档页"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/about-me.png" alt="关于我页"><br><img src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/sample/contact.png" alt="留言板页"></p><h2 id="感谢支持"><a href="#感谢支持" class="headerlink" title="感谢支持"></a>感谢支持</h2><p>如果你觉得对你有所帮助,请帮忙给个 <code>Star</code>。<br>如果你想贡献一份力量,欢迎提交 <code>Pull Request</code>。</p><h2 id="赞赏捐助"><a href="#赞赏捐助" class="headerlink" title="赞赏捐助"></a>赞赏捐助</h2><p>有问题可以在文章最后评论区进行 <strong>留言和评论</strong> ，如果你喜欢我的博客，请博主喝一杯冰阔乐呀^_^ 😘</p><table>  <tbody><tr>    <td>        <img width="100" src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/reward/alipay.png" alt="alipay">    </td>    <td>        <img width="100" src="/medias/loading.gif" data-original="https://pudongping.github.io/medias/reward/wechat.png" alt="wechat">    </td>  </tr></tbody></table><blockquote><p>😘 若有共鸣，留言足矣，若有赞赏，何以复加？ 🤞</p></blockquote><h2 id="LICENSE"><a href="#LICENSE" class="headerlink" title="LICENSE"></a>LICENSE</h2><p>MIT</p>]]></content>
      
      
      <categories>
          
          <category> 开源 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitHub </tag>
            
            <tag> 博客 </tag>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
